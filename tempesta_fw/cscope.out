cscope 15 $HOME/Tempesta/tempesta/tempesta_fw -q 0000006365 0001081599
	@addr.c

23 
	~<löux/°rög.h
>

24 
	~<löux/˘y≥.h
>

25 
	~<löux/ö.h
>

26 
	~<löux/ö6.h
>

27 
	~<löux/öë.h
>

29 
	~"addr.h
"

30 
	~"log.h
"

33 
	$vÆid©e_addr
(c⁄° 
TfwAddr
 *
addr
)

38 
	`BUG_ON
(!
addr
);

39 
	`BUG_ON
(
addr
->
Ámûy
 !
AF_INET
 &&áddr->Ámûy !
AF_INET6
);

40 
	}
}

43 
	$tfw_addr_±⁄_v4
(c⁄° 
TfwSå
 *
s
, 
sockaddr_ö
 *
addr
)

45 
o˘ë
 = -1, 
i
 = 0, 
p‹t
 = 0, 
k
;

46 *
a
 = (*)&
addr
->
sö_addr
.
s_addr
;

47 c⁄° *
p
;

48 c⁄° 
TfwSå
 *
c
, *
íd
;

50 
addr
->
sö_Ámûy
 = 
AF_INET
;

51 
addr
->
sö_addr
.
s_addr
 = 0;

52 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
s
, 
íd
) {

53 
k
 = 0; k !
c
->
Àn
; ++k) {

54 
p
 = 
c
->
±r
 + 
k
;

55 i‡(
	`isdigô
(*
p
)) {

56 
o˘ë
 = (octet == -1)

57 ? *
p
 - '0'

58 : 
o˘ë
 * 10 + *
p
 - '0';

59 i‡((!
p‹t
 && 
o˘ë
 > 255) || octet > 0xFFFF)

60  -
EINVAL
;

62 i‡(
o˘ë
 >0 && ((*
p
 ='.' && 
i
 < 4)

63 || (*
p
 =':' && 
i
 == 3)))

65 
a
[
i
++] = 
o˘ë
;

66 
o˘ë
 = -1;

67 
p‹t
 = *
p
 == ':';

69  -
EINVAL
;

72 i‡(
o˘ë
 >= 0) {

73 i‡(
i
 == 3) {

75 
a
[
i
] = 
o˘ë
;

76 
addr
->
sö_p‹t
 = 
	`ht⁄s
(
TFW_ADDR_STR_DEF_PORT
);

79 i‡(
i
 == 4) {

80 
addr
->
sö_p‹t
 = 
	`ht⁄s
(
o˘ë
);

85  -
EINVAL
;

86 
	}
}

89 
	$tfw_addr_±⁄_v6
(c⁄° 
TfwSå
 *
s
, 
sockaddr_ö6
 *
addr
)

91 
	#XD
(
x
Ë((x >'a'Ë? 10 + x - 'a' : x - '0')

	)

93 
w‹ds
[9] = { -1, -1, -1, -1, -1, -1, -1, -1, -1 };

94 
a
, 
hﬁe
 = -1, 
i
 = 0, 
p‹t
 = -1, 
ùv4_m≠≥d
 = 0, 
k
;

95 c⁄° *
p
;

96 c⁄° 
TfwSå
 *
c
, *
íd
;

98 
	`mem£t
(
addr
, 0, (*addr));

100 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
s
, 
íd
) {

101 
k
 = 0; k !
c
->
Àn
; ++k) {

102 
p
 = 
c
->
±r
 + 
k
;

103 i‡(
i
 > 7 && !(ò=8 && 
p‹t
 == 1))

104  -
EINVAL
;

106 i‡(*
p
 == '[') {

107 
p‹t
 = 0;

109 i‡(*
p
 == ':') {

110 c⁄° 
√xt
 = (
k
 < 
c
->
Àn
 - 1) ?

111 *(
p
 + 1) :

112 (
c
 !
	`TFW_STR_LAST
(
s
)) ?

113 *(*)((
c
 + 1)->
±r
) :

115 i‡(
√xt
 == ':') {

120 i‡(
k
 < 
c
->
Àn
 - 1) {

121 ++
k
;

122 ++
p
;

124 ++
c
;

125 
k
 = 0;

126 
p
 = 
c
->
±r
;

128 
hﬁe
 = (
w‹ds
[
i
] != -1) ? ++i : i;

129 } i‡(
w‹ds
[
i
] == -1)

130  -
EINVAL
;

133 
i
 = (
p‹t
 == 1) ? 8 : i + 1;

135 i‡(*
p
 == '.') {

136 ++
i
;

137 i‡(
ùv4_m≠≥d
)

139 i‡(
w‹ds
[0] != -1 || words[1] != 0xFFFF

140 || 
w‹ds
[2] =-1 || 
i
 !3 || 
hﬁe
 != 0)

141  -
EINVAL
;

147 
addr
->
sö6_Ámûy
 = 
AF_INET
;

148 
w‹ds
[0] = ((words[2] & 0xF000) >> 12) * 1000

149 + ((
w‹ds
[2] & 0x0F00) >> 8) * 100

150 + ((
w‹ds
[2] & 0x00F0) >> 4) * 10

151 + (
w‹ds
[2] & 0x000F);

152 i‡(
w‹ds
[0] > 255)

153  -
EINVAL
;

154 
ùv4_m≠≥d
 = 1;

155 
i
 = 1;

156 
w‹ds
[1] = words[2] = -1;

158 i‡(
	`isxdigô
(*
p
)) {

159 
w‹ds
[
i
] = words[i] == -1 ? 0 : words[i];

160 i‡(
ùv4_m≠≥d
 || 
p‹t
 == 1) {

161 i‡(!
	`isdigô
(*
p
))

162  -
EINVAL
;

163 
w‹ds
[
i
] = w‹ds[i] * 10 + *
p
 - '0';

164 i‡(
p‹t
) {

165 i‡(
w‹ds
[
i
] > 0xFFFF)

166  -
EINVAL
;

168 i‡(
ùv4_m≠≥d
 && 
w‹ds
[
i
] > 255) {

169  -
EINVAL
;

172 
w‹ds
[
i
] = (w‹ds[i] << 4Ë| 
	`XD
(
	`tﬁowî
(*
p
));

173 i‡(
w‹ds
[
i
] > 0xFFFF)

174  -
EINVAL
;

177 i‡(*
p
 == ']') {

178 
p‹t
 = 1;

181  -
EINVAL
;

187 i‡(!
p‹t
 || (p‹à!-1 && 
w‹ds
[8] <= 0)

188 || (
ùv4_m≠≥d
 && 
hﬁe
 == -1)

189 || (
ùv4_m≠≥d
 && 
p‹t
 =-1 && 
i
 != 3)

190 || (
p‹t
 =1 && 
i
 != 8)

191 || (
p‹t
 =-1 && 
i
 < 7 && 
hﬁe
 == -1))

192  -
EINVAL
;

195 i‡(
ùv4_m≠≥d
) {

196 
sockaddr_ö
 *
addr4
 = (sockaddr_ö *)
addr
;

197 
i
 = 0; i < 4; ++i)

198 
addr4
->
sö_addr
.
s_addr
 |
w‹ds
[
i
] << (3 - i) * 8;

200 
i
 = 
a
 = 7; i >= 0 &&á >= 0; ) {

201 i‡(
w‹ds
[
i
] == -1) {

202 i‡(
i
 > 
hﬁe
)

203 --
i
;

205 i‡(
a
-- =
i
 && i)

206 --
i
;

208 
addr
->
sö6_addr
.
s6_addr16
[
a
--]

209 
	`ht⁄s
(
w‹ds
[
i
--]);

214 i‡(
p‹t
 == -1) {

215 
addr
->
sö6_p‹t
 = 
	`ht⁄s
(
TFW_ADDR_STR_DEF_PORT
);

217 
addr
->
sö6_p‹t
 = 
	`ht⁄s
(
w‹ds
[8]);

220 
addr
->
sö6_Ámûy
 = 
AF_INET6
;

223 #unde‡
XD


224 
	}
}

231 
	$tfw_addr_±⁄
(c⁄° 
TfwSå
 *
°r
, 
TfwAddr
 *
addr
)

233 
ªt
 = -
EINVAL
;

234 
mode
 = 0;

235 c⁄° 
fú°
 = 
	`TFW_STR_PLAIN
(
°r
) ?

236 *(*)
°r
->
±r
 :

237 *(*)((
TfwSå
*)
°r
->
±r
)->ptr;

240 i‡(
fú°
 ='[' || 
	`ißÕha
(first)) {

241 
mode
 = 6;

243 c⁄° *
pos
 = 
NULL
;

244 c⁄° 
TfwSå
 *
c
, *
íd
;

245 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
°r
, 
íd
) {

246 
i
;

247 
i
 = 0; i !
c
->
Àn
; ++i) {

248 
pos
 = 
c
->
±r
 + 
i
;

249 i‡(!
	`isdigô
(*
pos
))

250 
dñim
;

253 
dñim
:

254 i‡(*
pos
 == ':') {

255 
mode
 = 6;

257 i‡(*
pos
 == '.') {

258 
mode
 = 4;

262 i‡(
mode
 == 4)

263 
ªt
 = 
	`tfw_addr_±⁄_v4
(
°r
, &
addr
->
v4
);

264 i‡(
mode
 == 6)

265 
ªt
 = 
	`tfw_addr_±⁄_v6
(
°r
, &
addr
->
v6
);

267  
ªt
;

268 
	}
}

269 
EXPORT_SYMBOL
(
tfw_addr_±⁄
);

280 
	$tfw_addr_±⁄_addr
(c⁄° *
°r
, 
TfwAddr
 *
addr
)

282 
dñim
 = '/';

283 
TfwAddr
 
tm∑ddr
 = {};

284 c⁄° *
µå
;

285 
__be32
 *
v4_ßddr
 = &
tm∑ddr
.
v4
.
sö_addr
.
s_addr
;

286 
ö6_addr
 *
v6_öaddr
 = &
tm∑ddr
.
v6
.
sö6_addr
;

288 i‡(
	`ö4_±⁄
(
°r
, -1, (
u8
 *)
v4_ßddr
, 
dñim
, &
µå
)) {

289 
	`ùv6_addr_£t_v4m≠≥d
(*
v4_ßddr
, 
v6_öaddr
);

290 
tm∑ddr
.
Ámûy
 = 
AF_INET
;

291 
d⁄e
;

293 i‡(*
°r
 == '[') {

294 
°r
++;

295 
dñim
 = ']';

297 i‡(!
	`ö6_±⁄
(
°r
, -1, (
u8
 *)&
v6_öaddr
->
s6_addr
, 
dñim
, &
µå
))

298  
NULL
;

299 
tm∑ddr
.
Ámûy
 = 
AF_INET6
;

300 i‡(*
µå
 == ']')

301 ++
µå
;

302 
d⁄e
:

303 *
addr
 = 
tm∑ddr
;

304  
µå
;

305 
	}
}

317 
	$tfw_addr_±⁄_cidr
(c⁄° *
°r
, 
TfwAddr
 *
addr
)

319 
u8
 
¥efix
;

320 c⁄° *
µå
;

322 i‡((
µå
 = 
	`tfw_addr_±⁄_addr
(
°r
, 
addr
)Ë=
NULL
)

323  -
EINVAL
;

326 i‡(*
µå
 == '/')

327 ++
µå
;

328 i‡(*
µå
 == '\0') {

329 
addr
->
ö6_¥efix
 = 128;

332 i‡(
	`k°πou8
(
µå
, 10, &
¥efix
) || (prefix == 0))

333  -
EINVAL
;

334 i‡(
addr
->
Ámûy
 =
AF_INET
) {

335 i‡(
¥efix
 > 32)

336  -
EINVAL
;

337 
¥efix
 += 128 - 32;

338 
addr
->
Ámûy
 = 
AF_INET6
;

339 } i‡(
¥efix
 > 128) {

340  -
EINVAL
;

342 
addr
->
ö6_¥efix
 = 
¥efix
;

345 
	}
}

347 
boﬁ


348 
	$tfw_addr_eq_öë
(c⁄° 
sockaddr_ö
 *
a
, c⁄° sockaddr_ö *
b
)

352  *((
u64
 *)
a
Ë=*((u64 *)
b
);

353 
	}
}

355 
boﬁ


356 
	$tfw_addr_eq_öë6
(c⁄° 
sockaddr_ö6
 *
a
, c⁄° sockaddr_ö6 *
b
)

362  ((
a
->
sö6_p‹t
 =
b
->sin6_port) &&

363 !
	`memcmp
(&
a
->
sö6_addr
, &
b
->sin6_addr, (a->sin6_addr)));

364 
	}
}

376 
boﬁ


377 
	$tfw_addr_eq
(c⁄° 
TfwAddr
 *
addr1
, c⁄° TfwAdd∏*
addr2
)

379 
ß_Ámûy_t
 
Ámûy
;

381 
	`vÆid©e_addr
(
addr1
);

382 
	`vÆid©e_addr
(
addr2
);

384 
Ámûy
 = 
addr1
->family;

385 i‡(
Ámûy
 !
addr2
->family)

386  
Ál£
;

388 i‡(
Ámûy
 =
AF_INET6
)

389  
	`tfw_addr_eq_öë6
(&
addr1
->
v6
, &
addr2
->v6);

391  
	`tfw_addr_eq_öë
(&
addr1
->
v4
, &
addr2
->v4);

392 
	}
}

393 
EXPORT_SYMBOL
(
tfw_addr_eq
);

401 
	$tfw_addr_ifm©ch
(c⁄° 
TfwAddr
 *
£rvî
, c⁄° TfwAdd∏*
li°íî
)

403 
£rvî
->
Ámûy
) {

404 
AF_INET
:

406 
œddr
 = 
li°íî
->
v4
.
sö_addr
.
s_addr
;

407 
ßddr
 = 
£rvî
->
v4
.
sö_addr
.
s_addr
;

408 i‡(
li°íî
->
v4
.
sö_p‹t
 !
£rvî
->v4.sin_port)

410 i‡(
œddr
 == 0) {

411 i‡(
	`IN_LOOPBACK
(
	`¡ohl
(
ßddr
)))

417  
	`tfw_addr_eq_öë
(&
£rvî
->
v4
, &
li°íî
->v4);

419 
AF_INET6
:

420 i‡(
li°íî
->
v6
.
sö6_p‹t
 !
£rvî
->v6.sin6_port)

422 i‡(!(
li°íî
->
v6
.
sö6_addr
.
ö6_u
.
u6_addr32
[0] |

423 
li°íî
->
v6
.
sö6_addr
.
ö6_u
.
u6_addr32
[1] |

424 
li°íî
->
v6
.
sö6_addr
.
ö6_u
.
u6_addr32
[2] |

425 
li°íî
->
v6
.
sö6_addr
.
ö6_u
.
u6_addr32
[3]))

428 i‡(
	`IN6_LOOPBACK
(
£rvî
->
v6
.
sö6_addr
))

435  
	`tfw_addr_eq_öë6
(&
£rvî
->
v6
, &
li°íî
->v6);

437 
	`TFW_ERR
("UnknownÖrotocol family\n");

438 
	`BUG
();

441 
	}
}

442 
EXPORT_SYMBOL
(
tfw_addr_ifm©ch
);

464 
	$tfw_put_dec
(
u32
 
q
, *
out_buf
)

466 
u32
 
r
;

467 
u8
 
digôs_n
 = 1 + (
q
 > 9) + (q > 99) + (q > 999) + (q > 9999);

477 
digôs_n
) {

479 
r
 = (
q
 * 0x0ccd) >> 15;

480 
out_buf
[3] = (
q
 - 10 * 
r
) + '0';

481 
q
 = (
r
 * 0x00cd) >> 11;

482 
out_buf
[2] = (
r
 - 10 * 
q
) + '0';

484 
r
 = (
q
 * 0x000d) >> 7;

485 
out_buf
[1] = (
q
 - 10 * 
r
) + '0';

486 
out_buf
[0] = 
r
 + '0';

490 
r
 = (
q
 * 0xcccd) >> 19;

491 
out_buf
[4] = (
q
 - 10 * 
r
) + '0';

492 
q
 = (
r
 * 0x0ccd) >> 15;

493 
out_buf
[3] = (
r
 - 10 * 
q
) + '0';

495 
r
 = (
q
 * 0x00cd) >> 11;

496 
out_buf
[2] = (
q
 - 10 * 
r
) + '0';

497 
q
 = (
r
 * 0x000d) >> 7;

498 
out_buf
[1] = (
r
 - 10 * 
q
) + '0';

500 
out_buf
[0] = 
q
 + '0';

503  
out_buf
 + 
digôs_n
;

504 
	}
}

515 
	$tfw_put_ùv6_digô_group
(
u16
 
group
, *
out_buf
)

517 
u8
 
digôs_n
 = 1 + (
group
 > 0xF) + (group > 0xFF) + (group > 0xFFF);

519 
out_buf
 +
digôs_n
;

521 
digôs_n
) {

523 
out_buf
[-4] = 
hex_asc
[(
group
 >> 12) ];

525 
out_buf
[-3] = 
hex_asc
[(
group
 >> 8) & 0xF];

527 
out_buf
[-2] = 
hex_asc
[(
group
 >> 4) & 0xF];

529 
out_buf
[-1] = 
hex_asc
[ 
group
 & 0xF];

532  
out_buf
;

533 
	}
}

539 
	#SHOULD_PRINT_PORT
(
p‹t
) \

540 
	`u∆ikñy
(
p‹t
 &&Ö‹à!
	`__c⁄°™t_˝u_to_be16
(
TFW_ADDR_STR_DEF_PORT
))

	)

553 
	$tfw_addr_fmt_v4
(
__be32
 
ö_addr
, 
__be16
 
ö_p‹t
, *
buf
)

555 *
pos
 = 
buf
;

556 
u8
 *
o˘ës
 = (u8 *)&
ö_addr
;

558 
pos
 = 
	`tfw_put_dec
(
o˘ës
[0],Öos);

559 *
pos
++ = '.';

560 
pos
 = 
	`tfw_put_dec
(
o˘ës
[1],Öos);

561 *
pos
++ = '.';

562 
pos
 = 
	`tfw_put_dec
(
o˘ës
[2],Öos);

563 *
pos
++ = '.';

564 
pos
 = 
	`tfw_put_dec
(
o˘ës
[3],Öos);

566 i‡(
	`SHOULD_PRINT_PORT
(
ö_p‹t
)) {

567 *
pos
++ = ':';

568 
pos
 = 
	`tfw_put_dec
(
	`¡ohs
(
ö_p‹t
),Öos);

571  
pos
;

572 
	}
}

591 
	$tfw_addr_fmt_v6
(c⁄° 
ö6_addr
 *ö6_addr, 
__be16
 
ö_p‹t
, *
buf
)

593 *
pos
 = 
buf
;

594 c⁄° 
u16
 *
groups
 = 
ö6_addr
->
ö6_u
.
u6_addr16
;

595 
u8
 
zîos_Æªady_omôãd
 = 
Ál£
;

596 
u8
 
i
;

598 i‡(
	`SHOULD_PRINT_PORT
(
ö_p‹t
))

599 *
pos
++ = '[';

609 
i
 = 0; i < 7; ++i) {

610 i‡(
groups
[
i
] || 
zîos_Æªady_omôãd
) {

611 
pos
 = 
	`tfw_put_ùv6_digô_group
(
	`¡ohs
(
groups
[
i
]),Öos);

612 *
pos
++ = ':';

614 i‡(!
groups
[
i
] && (groups[i + 1] || i == 6)) {

615 i‡(
pos
 =
buf
 || *(pos - 1) != ':')

616 *
pos
++ = ':';

617 *
pos
++ = ':';

618 
zîos_Æªady_omôãd
 = 
åue
;

623 
pos
 = 
	`tfw_put_ùv6_digô_group
(
	`¡ohs
(
groups
[7]),Öos);

625 i‡(
	`SHOULD_PRINT_PORT
(
ö_p‹t
)) {

626 *
pos
++ = ']';

627 *
pos
++ = ':';

628 
pos
 = 
	`tfw_put_dec
(
	`¡ohs
(
ö_p‹t
),Öos);

631  
pos
;

632 
	}
}

633 
EXPORT_SYMBOL
(
tfw_addr_fmt_v6
);

647 
size_t


648 
	$tfw_addr_¡›
(c⁄° 
TfwAddr
 *
addr
, *
out_buf
, 
size_t
 
buf_size
)

650 *
pos
;

652 
	`vÆid©e_addr
(
addr
);

653 
	`BUG_ON
(!
out_buf
);

654 
	`BUG_ON
(
buf_size
 < 
TFW_ADDR_STR_BUF_SIZE
);

656 
pos
 = (
addr
->
ß
.
ß_Ámûy
 =
AF_INET6
)

657 ? 
	`tfw_addr_fmt_v6
(&
addr
->
v6
.
sö6_addr
,áddr->v6.
sö6_p‹t
, 
out_buf
)

658 : 
	`tfw_addr_fmt_v4
(
addr
->
v4
.
sö_addr
.
s_addr
,áddr->v4.
sö_p‹t
,

659 
out_buf
);

661 
	`BUG_ON
(
pos
 >(
out_buf
 + 
buf_size
));

662 *
pos
 = '\0';

664  (
pos
 - 
out_buf
);

665 
	}
}

	@addr.h

21 #i‚de‡
__TFW_ADDR_H__


22 
	#__TFW_ADDR_H__


	)

24 
	~<√t/öë_sock.h
>

25 
	~<√t/ùv6.h
>

26 
	~"°r.h
"

33 
	#TFW_ADDR_STR_DEF_PORT
 80

	)

36 
	#TFW_ADDR_STR_BUF_SIZE
 \

37 ("[FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:255.255.255.255]:65535")

	)

39 
	#IN6_LOOPBACK
(
ö6_addr
) \

40 ((
ö6_addr
.
ö6_u
.
u6_addr8
[15] == 1) && \

41 !(
ö6_addr
.
ö6_u
.
u6_addr32
[0] | \

42 
ö6_addr
.
ö6_u
.
u6_addr32
[1] | \

43 
ö6_addr
.
ö6_u
.
u6_addr32
[2] | \

44 
ö6_addr
.
ö6_u
.
u6_addr8
[12] | \

45 
ö6_addr
.
ö6_u
.
u6_addr8
[13] | \

46 
ö6_addr
.
ö6_u
.
u6_addr8
[14])) \

47 

	)

49 
ß_Ámûy_t
 
	mÁmûy
;

50 
sockaddr_ö
 
	mv4
;

51 
sockaddr_ö6
 
	mv6
;

52 
sockaddr
 
	mß
;

53 
	#ö6_¥efix
 
v6
.
sö6_sc›e_id


	)

54 } 
	tTfwAddr
;

56 
tfw_addr_ifm©ch
(c⁄° 
TfwAddr
 *
£rvî
, c⁄° TfwAdd∏*
li°íî
);

58 
boﬁ
 
tfw_addr_eq
(c⁄° 
TfwAddr
 *
addr1
, c⁄° TfwAdd∏*
addr2
);

59 
tfw_addr_±⁄
(c⁄° 
TfwSå
 *
°r
, 
TfwAddr
 *
addr
);

60 
tfw_addr_±⁄_cidr
(c⁄° *
°r
, 
TfwAddr
 *
addr
);

61 
size_t
 
tfw_addr_¡›
(c⁄° 
TfwAddr
 *
addr
, *
out_buf
, size_à
buf_size
);

65 *
tfw_addr_fmt_v4
(
__be32
 
ö_addr
, 
__be16
 
ö_p‹t
, *
out_buf
);

66 *
tfw_addr_fmt_v6
(c⁄° 
ö6_addr
 *ö6_addr, 
__be16
 
ö_p‹t
,

67 *
out_buf
);

69 
ölöe
 
ssize_t


70 
	$tfw_addr_ß_Àn
(c⁄° 
TfwAddr
 *
addr
)

72  (
addr
->
Ámûy
 =
AF_INET6
Ë? ◊ddr->
v6
Ë: ◊ddr->
v4
);

73 
	}
}

75 
ölöe
 

76 
	$tfw_addr_gë_sk_•‹t
(
sock
 *
sk
)

78  
	`öë_sk
(
sk
)->
öë_•‹t
;

79 
	}
}

	@apm.c

21 
	~<löux/©omic.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/¶ab.h
>

24 
	~<löux/•ölock.h
>

25 
	~<löux/°rögify.h
>

27 #i‚de‡
DBG_APM


28 #unde‡
DEBUG


30 
	~"lib/°r.h
"

31 
	~"≠m.h
"

32 
	~"cfg.h
"

33 
	~"log.h
"

34 
	~"poﬁ.h
"

35 
	~"¥ocfs.h
"

36 
	~"hâp.h
"

87 
	#TFW_STATS_RANGES
 4

	)

88 
	#TFW_STATS_RLAST
 (
TFW_STATS_RANGES
 - 1)

	)

89 
	#TFW_STATS_BCKTS_ORDER
 4

	)

90 
	#TFW_STATS_BCKTS
 (1 << 
TFW_STATS_BCKTS_ORDER
)

	)

92 
	#TFW_STATS_RSPAN
(
‹dî
Ë((
TFW_STATS_BCKTS
 - 1Ë<< (‹dî))

	)

93 
	#TFW_STATS_RSPAN_UL
(
‹dî
Ë((
TFW_STATS_BCKTS
 - 1ULË<< (‹dî))

	)

96 
	m‹dî
;

97 
	mbegö
;

98 
	míd
;

99 } 
	tTfwP˙tCé
;

102 
TfwP˙tCé
 
	m˘l
[
TFW_STATS_RANGES
];

103 
	m__ª£t_‰om
[0];

104 
	mtŸ_˙t
;

105 
	mtŸ_vÆ
;

106 
	mmö_vÆ
;

107 
	mmax_vÆ
;

108 
	m˙t
[
TFW_STATS_RANGES
][
TFW_STATS_BCKTS
];

109 
	m__ª£t_tûl
[0];

110 } 
	tTfwP˙tR™ges
 
	t__©åibuã__
((
	tÆig√d
(
	tL1_CACHE_BYTES
)));

112 
ölöe
 *

113 
	$__∫g
(
TfwP˙tCé
 *
pc
, *
˙t
, 
r_time
)

115 i‡(
r_time
 <
pc
->
begö
)

116  &
˙t
[0];

117  &
˙t
[(
r_time
 - 
pc
->
begö
 + ((1 <<Öc->
‹dî
) - 1)) >>Öc->order];

118 
	}
}

121 
	$__ønge_grow_right
(
TfwP˙tR™ges
 *
∫g
, 
TfwP˙tCé
 *
pc
, 
r
)

123 
i
;

125 ++
pc
->
‹dî
;

126 
pc
->
íd
 =Öc->
begö
 + 
	`TFW_STATS_RSPAN
’c->
‹dî
);

128 
	`TFW_DBG3
(" --ÉxtendÑight bound ofÑange %dÅo begin=%u order=%u"

129 "Énd=%u\n", 
r
, 
pc
->
begö
,Öc->
‹dî
,Öc->
íd
);

132 
i
 = 0; i < 
TFW_STATS_BCKTS
 / 2; ++i)

133 
∫g
->
˙t
[
r
][
i
] =Ñng->cnt[r][2 * i] +Ñng->cnt[r][2 * i + 1];

134 
	}
}

137 
	$__ønge_shrök_À·
(
TfwP˙tR™ges
 *
∫g
, 
TfwP˙tCé
 *
pc
, 
r
)

139 
i
;

140 
˙t_fuŒ
, 
˙t_hÆf
;

142 --
pc
->
‹dî
;

143 
pc
->
begö
 =Öc->
íd
 - 
	`TFW_STATS_RSPAN
’c->
‹dî
);

145 
	`TFW_DBG3
(" -- shrinkÜeft bound ofÑange %dÅo begin=%u order=%u"

146 "Énd=%u\n", 
r
, 
pc
->
begö
,Öc->
‹dî
,Öc->
íd
);

151 
i
 = 1; i < 
TFW_STATS_BCKTS
 / 2; ++i)

152 
∫g
->
˙t
[
r
][0] +∫g->˙t[r][
i
];

153 
˙t_fuŒ
 = 
∫g
->
˙t
[
r
][
TFW_STATS_BCKTS
 / 2];

154 
˙t_hÆf
 = 
˙t_fuŒ
 / 2;

155 
∫g
->
˙t
[
r
][0] +
˙t_hÆf
;

156 
∫g
->
˙t
[
r
][1] = 
˙t_fuŒ
 - 
˙t_hÆf
;

157 
i
 = 1; i < 
TFW_STATS_BCKTS
 / 2; ++i) {

158 
˙t_fuŒ
 = 
∫g
->
˙t
[
r
][
TFW_STATS_BCKTS
 / 2 + 
i
];

159 
˙t_hÆf
 = 
˙t_fuŒ
 / 2;

160 
∫g
->
˙t
[
r
][
i
 * 2] = 
˙t_hÆf
;

161 
∫g
->
˙t
[
r
][
i
 * 2 + 1] = 
˙t_fuŒ
 - 
˙t_hÆf
;

163 
	}
}

169 
	$tfw_°©s_exãnd
(
TfwP˙tR™ges
 *
∫g
, 
r_time
)

171 
i
, 
b
;

172 
íd
;

173 
TfwP˙tCé
 *
pc
 = &
∫g
->
˘l
[
TFW_STATS_RLAST
];

174 
sum
, 
∑πs
, 
unôs
, 
shi·
, 
‹dî
 = 
pc
->order;

176 
	`BUILD_BUG_ON_NOT_POWER_OF_2
(
TFW_STATS_BCKTS
);

179 ++
‹dî
;

180 
íd
 = 
pc
->
begö
 + 
	`TFW_STATS_RSPAN_UL
(
‹dî
);

181 } 
íd
 < 
r_time
);

191 
	`BUG_ON
(
íd
 >(1UL << (
	`FIELD_SIZEOF
(
TfwP˙tCé
,Énd) * 8)));

192 
pc
->
íd
 =Énd;

194 
shi·
 = 
	`mö_t
(, 
‹dî
 - 
pc
->‹dî, 
TFW_STATS_BCKTS_ORDER
);

195 
unôs
 = 1 << 
shi·
;

196 
∑πs
 = 
TFW_STATS_BCKTS
 >> 
shi·
;

198 
pc
->
‹dî
 = order;

200 
	`TFW_DBG3
(" --ÉxtendÜastÑangeÅo begin=%u order=%uÉnd=%u\n",

201 
pc
->
begö
,Öc->
‹dî
,Öc->
íd
);

207 
i
 = 0; i < 
∑πs
; ++i) {

208 
unôs
) {

210 
∫g
->
˙t
[
TFW_STATS_RLAST
][
i
] =

211 
∫g
->
˙t
[
TFW_STATS_RLAST
][2 * 
i
]

212 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][2 * 
i
 + 1];

215 
∫g
->
˙t
[
TFW_STATS_RLAST
][
i
] =

216 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
]

217 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
 + 1]

218 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
 + 2]

219 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
 + 3];

222 
sum
 = 0;

223 
b
 = 
i
 * 
unôs
; b < (i + 1) * units; ++b)

224 
sum
 +
∫g
->
˙t
[
TFW_STATS_RLAST
][
b
];

225 
∫g
->
˙t
[
TFW_STATS_RLAST
][
i
] = 
sum
;

229 
	`mem£t
(&
∫g
->
˙t
[
TFW_STATS_RLAST
][
∑πs
], 0,

230 (
∫g
->
˙t
[0][0]Ë* (
TFW_STATS_BCKTS
 - 
∑πs
));

231 
	}
}

244 
	$tfw_°©s_adju°
(
TfwP˙tR™ges
 *
∫g
, 
r
)

246 
i
;

247 
TfwP˙tCé
 *
pc
, *
¥ïc
;

248 
¥íd
, 
˙t
 = 0, 
sum
 = 0, 
max
 = 0, 
i_max
 = 0;

250 
	`BUG_ON
(
r
 == 0);

252 
i
 = 0; i < 
TFW_STATS_BCKTS
; ++i) {

253 i‡(
∫g
->
˙t
[
r
][
i
]) {

254 
sum
 +
∫g
->
˙t
[
r
][
i
];

255 ++
˙t
;

257 i‡(
max
 < 
∫g
->
˙t
[
r
][
i
]) {

258 
max
 = 
∫g
->
˙t
[
r
][
i
];

259 
i_max
 = 
i
;

262 
	`BUG_ON
(!
˙t
);

265 i‡(
	`likñy
(
max
 <
sum
 * 2 / 
˙t
))

268 
	`TFW_DBG3
(" --Ñange %d hasán outlier %lu (avg=%luÅotal=%lu)át"

269 " buckë %lu\n", 
r
, 
max
, 
sum
 / 
˙t
, sum, 
i_max
);

280 
pc
 = &
∫g
->
˘l
[
r
];

281 
¥ïc
 = &
∫g
->
˘l
[
r
 - 1];

282 
¥íd
 = 
¥ïc
->
begö
 + 
	`TFW_STATS_RSPAN_UL
’ªpc->
‹dî
 + 1);

284 i‡((
i_max
 =0Ë&& (
¥íd
 < 
pc
->
begö
)) {

285 
	`__ønge_grow_right
(
∫g
, 
¥ïc
, 
r
 - 1);

287 
˙t
 = 
max
 / (
TFW_STATS_BCKTS
 / 2 + 1);

288 
∫g
->
˙t
[
r
][0] -˙à* (
TFW_STATS_BCKTS
 / 2);

289 
i
 = 
TFW_STATS_BCKTS
 / 2; i < TFW_STATS_BCKTS; ++i)

290 
∫g
->
˙t
[
r
 - 1][
i
] = cnt;

298 i‡(
	`likñy
(
pc
->
‹dî
))

299 
	`__ønge_shrök_À·
(
∫g
, 
pc
, 
r
);

300 
	}
}

307 
ölöe
 
boﬁ


308 
	$tfw_°©s_adj_max
(
TfwP˙tR™ges
 *
∫g
, 
r_time
)

310 i‡(
r_time
 > 
∫g
->
max_vÆ
) {

311 
∫g
->
max_vÆ
 = 
r_time
;

312  
åue
;

314  
Ál£
;

315 
	}
}

322 
ölöe
 
boﬁ


323 
	$tfw_°©s_adj_mö
(
TfwP˙tR™ges
 *
∫g
, 
r_time
)

325 i‡(
r_time
 < 
∫g
->
mö_vÆ
) {

326 
∫g
->
mö_vÆ
 = 
r_time
;

327  
åue
;

329  
Ál£
;

330 
	}
}

337 
	$tfw_°©s_upd©e
(
TfwP˙tR™ges
 *
∫g
, 
r_time
)

339 
TfwP˙tCé
 *
pc3
, *
pc2
 = &
∫g
->
˘l
[2];

342 i‡(
r_time
 <
pc2
->
íd
) {

343 
TfwP˙tCé
 *
pc0
, *
pc1
 = &
∫g
->
˘l
[1];

345 i‡(
r_time
 > 
pc1
->
íd
) {

346 ++(*
	`__∫g
(
pc2
, 
∫g
->
˙t
[2], 
r_time
));

347 
	`tfw_°©s_adju°
(
∫g
, 2);

348 
tŸÆs
;

351 
pc0
 = &
∫g
->
˘l
[0];

352 
	`BUG_ON
(
pc0
->
begö
 != 1);

353 i‡(
r_time
 > 
pc0
->
íd
) {

354 ++(*
	`__∫g
(
pc1
, 
∫g
->
˙t
[1], 
r_time
));

355 
	`tfw_°©s_adju°
(
∫g
, 1);

356 
tŸÆs
;

359 ++(*
	`__∫g
(
pc0
, 
∫g
->
˙t
[0], 
r_time
));

360 
tŸÆs
;

363 
pc3
 = &
∫g
->
˘l
[3];

364 i‡(
	`u∆ikñy
(
r_time
 > 
pc3
->
íd
))

365 
	`tfw_°©s_exãnd
(
∫g
, 
r_time
);

366 ++(*
	`__∫g
(
pc3
, 
∫g
->
˙t
[3], 
r_time
));

367 
	`tfw_°©s_adju°
(
∫g
, 3);

369 
tŸÆs
:

371 i‡(!
	`tfw_°©s_adj_mö
(
∫g
, 
r_time
))

372 
	`tfw_°©s_adj_max
(
∫g
, 
r_time
);

374 
∫g
->
tŸ_vÆ
 +
r_time
;

375 ++
∫g
->
tŸ_˙t
;

378 
	}
}

381 
	#HM_FREQ
 10

	)

399 
li°_hód
 
	mli°
;

400 *
	m«me
;

401 *
	mªq
;

402 
	mªqsz
;

403 *
	muæ
;

404 
	muæsz
;

405 
u32
 
	m¸c32
;

406 *
	mcodes
;

407 
	mtmt
;

408 
boﬁ
 
	mauto_¸c
:1;

409 } 
	tTfwApmHM
;

422 
li°_hód
 
	mli°
;

423 
	mt‰ame
;

424 
	mlimô
;

425 
	mcode
;

426 } 
	tTfwApmHMCfg
;

435 
	mts
;

436 
	mª•
;

437 } 
	tTfwApmHMHi°‹y
;

448 
TfwApmHMHi°‹y
 
	mhi°‹y
[
HM_FREQ
];

449 
TfwApmHMCfg
 *
	mhmcfg
;

450 
	mrsum
;

451 
•ölock_t
 
	mlock
;

452 } 
	tTfwApmHMSèts
;

465 
TfwApmHM
 *
	mhm
;

466 
TfwApmHMSèts
 *
	mhm°©s
;

467 
©omic64_t
 
	mrcou¡
;

468 
	mjtm°amp
;

469 
timî_li°
 
	mtimî
;

470 
©omic_t
 
	mª¨m
;

471 } 
	tTfwApmHMCé
;

474 
TfwApmHM
 *
	gtfw_hm_íåy
;

476 
TfwApmHM
 *
	gtfw_hm_deÁu…
;

478 
boﬁ
 
	gtfw_hm_ex∂_def
;

480 
	gtfw_hm_codes_˙t
;

482 
LIST_HEAD
(
tfw_hm_li°
);

483 
LIST_HEAD
(
tfw_hm_codes_li°
);

501 
TfwP˙tR™ges
 
	mp˙ång
;

502 
	mjtmi°amp
;

503 
©omic_t
 
	mª£t
;

504 } 
	tTfwApmRBE¡
;

514 
TfwApmRBE¡
 *
	mrbít
;

515 
•ölock_t
 
	m¶ock
;

516 
	mrbufsz
;

517 } 
	tTfwApmRBuf
;

531 
	mjtmw°amp
;

532 
	míåy_˙t
;

533 
	mtŸÆ_˙t
;

534 } 
	tTfwApmRBCé
;

544 
TfwPr˙éSèts
 
	mp°©s
;

545 
rwlock_t
 
	mrwlock
;

546 } 
	tTfwApmSE¡
;

564 
TfwApmSE¡
 
	ma£¡
[2];

565 
©omic_t
 
	mrdidx
;

566 } 
	tTfwApmSèts
;

581 
	m˚¡ry
;

582 
	mπt
;

583 } 
__©åibuã__
((
∑cked
));

584 
uöt64_t
 
	md©a
;

585 } 
	tTfwApmUBE¡
;

603 
TfwApmUBE¡
 *
	mubít
[2];

604 
size_t
 
	mubufsz
;

605 
©omic64_t
 
	mcou¡î
;

606 } 
	tTfwApmUBuf
;

624 
	#TFW_APM_DATA_F_REARM
 (0x0001Ë

	)

626 
	#TFW_APM_TIMER_INTVL
 (
HZ
 / 20)

	)

627 
	#TFW_APM_UBUF_SZ
 
TFW_APM_TIMER_INTVL


	)

630 
TfwApmRBuf
 
	mrbuf
;

631 
TfwApmRBCé
 
	mrb˘l
;

632 
TfwApmSèts
 
	m°©s
;

633 
TfwApmUBuf
 
__≥r˝u
 *
	mubuf
;

634 
timî_li°
 
	mtimî
;

635 
	mÊags
;

636 
TfwApmHMCé
 
	mhm˘l
;

637 } 
	tTfwApmD©a
;

643 c⁄° 
TfwP˙tCé
 
	gtfw_∫g˘l_öô
[
TFW_STATS_RANGES
] = {

650 
	gtfw_≠m_jtmwödow
;

651 
	gtfw_≠m_jtmöåvl
;

652 
	gtfw_≠m_tmwsˇÀ
;

668 
u16
 
	mv
;

669 
u8
 
	mi
;

670 
u8
 
	mr
 : 4;

671 
u8
 
	mb
 : 4;

672 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tTfwApmRBESèã
;

674 
ölöe
 

675 
	$__tfw_≠m_°©e_£t
(
TfwApmRBESèã
 *
°
, 
u16
 
v
, 
u8
 
i
, u8 
r
, u8 
b
)

677 
°
->
v
 = v;

678 
°
->
i
 = i;

679 
°
->
r
 =Ñ;

680 
°
->
b
 = b;

681 
	}
}

683 
ölöe
 

684 
	$__tfw_≠m_°©e_√xt
(
TfwP˙tR™ges
 *
∫g
, 
TfwApmRBESèã
 *
°
)

686 
i
 = 
°
->i, 
r
, 
b
;

687 
πt
;

689 
r
 = 
i
 / 
TFW_STATS_BCKTS
;Ñ < 
TFW_STATS_RANGES
; ++r) {

690 
b
 = 
i
 % 
TFW_STATS_BCKTS
; b < TFW_STATS_BCKTS; ++b, ++i) {

691 i‡(!
∫g
->
˙t
[
r
][
b
])

693 
πt
 = 
∫g
->
˘l
[
r
].
begö
 + (
b
 <<Ñng->˘l[r].
‹dî
);

694 
	`__tfw_≠m_°©e_£t
(
°
, 
πt
, 
i
, 
r
, 
b
);

698 
	`__tfw_≠m_°©e_£t
(
°
, 
USHRT_MAX
, 
TFW_STATS_RANGES
 * 
TFW_STATS_BCKTS
,

699 
TFW_STATS_RANGES
, 
TFW_STATS_BCKTS
);

700 
	}
}

702 
ölöe
 

703 
	$tfw_≠m_°©e_√xt
(
TfwP˙tR™ges
 *
∫g
, 
TfwApmRBESèã
 *
°
)

705 
	`BUG_ON
(
°
->
i
 >
TFW_STATS_RANGES
 * 
TFW_STATS_BCKTS
);

707 ++
°
->
i
;

708 
	`__tfw_≠m_°©e_√xt
(
∫g
, 
°
);

709 
	}
}

715 
	$tfw_≠m_¥n˘l_ˇlc
(
TfwApmRBuf
 *
rbuf
, 
TfwApmRBCé
 *
rb˘l
, 
TfwPr˙éSèts
 *
p°©s
)

717 
	#IDX_MIN
 
TFW_PSTATS_IDX_MIN


	)

718 
	#IDX_MAX
 
TFW_PSTATS_IDX_MAX


	)

719 
	#IDX_AVG
 
TFW_PSTATS_IDX_AVG


	)

720 
	#IDX_ITH
 
TFW_PSTATS_IDX_ITH


	)

722 
i
, 
p
;

723 
˙t
 = 0, 
vÆ
, 
pvÆ
[
p°©s
->
psz
];

724 
TfwApmRBESèã
 
°
[
rbuf
->
rbufsz
];

725 
TfwP˙tR™ges
 *
p˙ång
;

726 
TfwApmRBE¡
 *
rbít
 = 
rbuf
->rbent;

728 
i
 = 0; i < 
rbuf
->
rbufsz
; i++) {

729 
p˙ång
 = &
rbít
[
i
].pcntrng;

730 
	`__tfw_≠m_°©e_£t
(&
°
[
i
], 
p˙ång
->
˘l
[0].
begö
, 0, 0, 0);

731 
	`__tfw_≠m_°©e_√xt
(
p˙ång
, &
°
[
i
]);

734 
i
 = 
p
 = 
IDX_ITH
; i < 
p°©s
->
psz
; ++i) {

735 
pvÆ
[
i
] = 
rb˘l
->
tŸÆ_˙t
 * 
p°©s
->
ôh
[i] / 100;

736 i‡(!
pvÆ
[
i
])

737 
p°©s
->
vÆ
[
p
++] = 0;

739 
p
 < 
p°©s
->
psz
) {

740 
v_mö
 = 
USHRT_MAX
;

741 
i
 = 0; i < 
rbuf
->
rbufsz
; i++) {

742 i‡(
°
[
i
].
v
 < 
v_mö
)

743 
v_mö
 = 
°
[
i
].
v
;

745 
	`BUG_ON
(
v_mö
 =
USHRT_MAX
);

746 
i
 = 0; i < 
rbuf
->
rbufsz
; i++) {

747 i‡(
°
[
i
].
v
 !
v_mö
)

749 
p˙ång
 = &
rbít
[
i
].pcntrng;

750 
˙t
 +
p˙ång
->˙t[
°
[
i
].
r
][°[i].
b
];

751 
	`tfw_≠m_°©e_√xt
(
p˙ång
, &
°
[
i
]);

753  ; 
p
 < 
p°©s
->
psz
 && 
pvÆ
[p] <
˙t
; ++p)

754 
p°©s
->
vÆ
[
p
] = 
v_mö
;

756 
˙t
 = 
vÆ
 = 0;

757 
p°©s
->
vÆ
[
IDX_MAX
] = 0;

758 
p°©s
->
vÆ
[
IDX_MIN
] = 
UINT_MAX
;

759 
i
 = 0; i < 
rbuf
->
rbufsz
; i++) {

760 
p˙ång
 = &
rbít
[
i
].pcntrng;

761 i‡(
p°©s
->
vÆ
[
IDX_MIN
] > 
p˙ång
->
mö_vÆ
)

762 
p°©s
->
vÆ
[
IDX_MIN
] = 
p˙ång
->
mö_vÆ
;

763 i‡(
p°©s
->
vÆ
[
IDX_MAX
] < 
p˙ång
->
max_vÆ
)

764 
p°©s
->
vÆ
[
IDX_MAX
] = 
p˙ång
->
max_vÆ
;

765 
˙t
 +
p˙ång
->
tŸ_˙t
;

766 
vÆ
 +
p˙ång
->
tŸ_vÆ
;

768 i‡(
	`likñy
(
˙t
))

769 
p°©s
->
vÆ
[
IDX_AVG
] = vÆ / 
˙t
;

771 #unde‡
IDX_ITH


772 #unde‡
IDX_AVG


773 #unde‡
IDX_MAX


774 #unde‡
IDX_MIN


775 
	}
}

782 
ölöe
 

783 
	$__tfw_≠m_rbít_ª£t
(
TfwApmRBE¡
 *
¸bít
, 
jtmi°amp
)

785 
	`mem£t
(
¸bít
->
p˙ång
.
__ª£t_‰om
, 0,

786 
	`off£tof
(
TfwP˙tR™ges
, 
__ª£t_tûl
)

787 - 
	`off£tof
(
TfwP˙tR™ges
, 
__ª£t_‰om
));

788 
¸bít
->
jtmi°amp
 = jtmistamp;

789 
	`smp_mb__bef‹e_©omic
();

790 
	`©omic_£t
(&
¸bít
->
ª£t
, 1);

791 
	}
}

798 
ölöe
 

799 
	$tfw_≠m_rbít_checkª£t
(
TfwApmRBE¡
 *
¸bít
, 
jtmi°amp
)

801 i‡(
¸bít
->
jtmi°amp
 != jtmistamp) {

802 i‡(!
	`©omic_dec_™d_ã°
(&
¸bít
->
ª£t
))

804 
	`__tfw_≠m_rbít_ª£t
(
¸bít
, 
jtmi°amp
);

806 
	}
}

817 
boﬁ


818 
	$tfw_≠m_rb˘l_upd©e
(
TfwApmD©a
 *
d©a
)

820 
i
, 
˚¡ry
;

821 
jtmnow
 = 
jiffõs
;

822 
jtmw°¨t
, 
jtmi°¨t
;

823 
íåy_˙t
, 
tŸÆ_˙t
 = 0;

824 
TfwApmRBuf
 *
rbuf
 = &
d©a
->rbuf;

825 
TfwApmRBCé
 *
rb˘l
 = &
d©a
->rbctl;

826 
TfwApmRBE¡
 *
rbít
 = 
rbuf
->rbent;

829 
jtmi°¨t
 = 
jtmnow
 - (jtmnow % 
tfw_≠m_jtmöåvl
);

831 
jtmw°¨t
 = 
jtmi°¨t
 - 
tfw_≠m_jtmwödow
;

833 
˚¡ry
 = (
jtmnow
 / 
tfw_≠m_jtmöåvl
Ë% 
rbuf
->
rbufsz
;

839 i‡(
	`u∆ikñy
(
rb˘l
->
jtmw°amp
 !
jtmw°¨t
)) {

840 
	`tfw_≠m_rbít_checkª£t
(&
rbít
[
˚¡ry
], 
jtmi°¨t
);

842 
i
 = 0; i < 
rbuf
->
rbufsz
; ++i)

843 
tŸÆ_˙t
 +
rbít
[
i
].
p˙ång
.
tŸ_˙t
;

844 
íåy_˙t
 = 
rbít
[
˚¡ry
].
p˙ång
.
tŸ_˙t
;

846 
rb˘l
->
íåy_˙t
 =Éntry_cnt;

847 
rb˘l
->
tŸÆ_˙t
 =Åotal_cnt;

848 
rb˘l
->
jtmw°amp
 = 
jtmw°¨t
;

850 
	`TFW_DBG3
("%s: NewÅime window: centry [%d]Åotal_cnt [%lu]\n",

851 
__func__
, 
˚¡ry
, 
rb˘l
->
tŸÆ_˙t
);

853  
åue
;

862 
íåy_˙t
 = 
rbít
[
˚¡ry
].
p˙ång
.
tŸ_˙t
;

863 i‡(
	`u∆ikñy
(
rb˘l
->
íåy_˙t
 ==Éntry_cnt))

864  
Ál£
;

865 
	`BUG_ON
(
rb˘l
->
íåy_˙t
 >Éntry_cnt);

868 
rb˘l
->
tŸÆ_˙t
 +
íåy_˙t
 -Ñbctl->entry_cnt;

869 
rb˘l
->
íåy_˙t
 =Éntry_cnt;

871 
	`TFW_DBG3
("%s: OldÅime window: centry [%d]Åotal_cnt [%lu]\n",

872 
__func__
, 
˚¡ry
, 
rb˘l
->
tŸÆ_˙t
);

874  
åue
;

875 
	}
}

881 
	$tfw_≠m_ˇlc
(
TfwApmD©a
 *
d©a
)

883 
rdidx
;

884 
vÆ
[
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)] = { 0 };

885 
TfwPr˙éSèts
 
p°©s
 = {

886 .
ôh
 = 
tfw_p°©s_ôh
,

887 .
vÆ
 = val,

888 .
psz
 = 
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)

890 
TfwApmSE¡
 *
a£¡
;

892 
rdidx
 = 
	`©omic_ªad
(&
d©a
->
°©s
.rdidx);

893 
a£¡
 = &
d©a
->
°©s
.a£¡[(
rdidx
 + 1) % 2];

895 i‡(!
	`tfw_≠m_rb˘l_upd©e
(
d©a
))

897 
	`tfw_≠m_¥n˘l_ˇlc
(&
d©a
->
rbuf
, &d©a->
rb˘l
, &
p°©s
);

899 
	`TFW_DBG3
("%s: Pî˚¡ûêvÆue†may havêch™ged.\n", 
__func__
);

900 
	`wrôe_lock
(&
a£¡
->
rwlock
);

901 
	`mem˝y_Á°
(
a£¡
->
p°©s
.
vÆ
,Östats.val,

902 
a£¡
->
p°©s
.
psz
 * ◊£¡->p°©s.
vÆ
[0]));

903 
	`©omic_öc
(&
d©a
->
°©s
.
rdidx
);

904 
	`wrôe_u∆ock
(&
a£¡
->
rwlock
);

907 
	}
}

919 
	#__tfw_≠m_°©s_body
(
≠md©a
, 
p°©s
, 
‚_lock
, 
‚_u∆ock
) \

920 
rdidx
, 
£q
 = 
p°©s
->seq; \

921 
TfwApmD©a
 *
d©a
 = 
≠md©a
; \

922 
TfwApmSE¡
 *
a£¡
; \

924 
	`BUG_ON
(!
≠md©a
); \

926 
	`smp_mb__bef‹e_©omic
(); \

927 
rdidx
 = 
	`©omic_ªad
(&
d©a
->
°©s
.rdidx); \

928 
a£¡
 = &
d©a
->
°©s
.a£¡[
rdidx
 % 2]; \

930 
	`‚_lock
(&
a£¡
->
rwlock
); \

931 
	`mem˝y
(
p°©s
->
vÆ
, 
a£¡
->pstats.val, \

932 
p°©s
->
psz
 * ’°©s->
vÆ
[0])); \

933 
	`‚_u∆ock
(&
a£¡
->
rwlock
); \

934 
p°©s
->
£q
 = 
rdidx
; \

936  (
£q
 !
rdidx
);

	)

939 
	$tfw_≠m_°©s_bh
(*
≠md©a
, 
TfwPr˙éSèts
 *
p°©s
)

941 
	`__tfw_≠m_°©s_body
(
≠md©a
, 
p°©s
, 
ªad_lock_bh
, 
ªad_u∆ock_bh
);

942 
	}
}

945 
	$tfw_≠m_°©s
(*
≠md©a
, 
TfwPr˙éSèts
 *
p°©s
)

947 
	`__tfw_≠m_°©s_body
(
≠md©a
, 
p°©s
, 
ªad_lock
, 
ªad_u∆ock
);

948 
	}
}

949 
EXPORT_SYMBOL
(
tfw_≠m_°©s
);

958 
	$tfw_≠m_p°©s_vîify
(
TfwPr˙éSèts
 *
p°©s
)

960 
i
;

962 i‡(
p°©s
->
psz
 !
	`ARRAY_SIZE
(
tfw_p°©s_ôh
))

964 
i
 = 0; i < 
p°©s
->
psz
; ++i)

965 i‡(
p°©s
->
ôh
[
i
] !
tfw_p°©s_ôh
[i])

968 
	}
}

975 
	$tfw_≠m_¥˙é_tm‚
(
‚d©a
)

977 
i
, 
i˝u
;

978 
TfwApmD©a
 *
d©a
 = (TfwApmD©®*)
‚d©a
;

979 
TfwApmRBuf
 *
rbuf
 = &
d©a
->rbuf;

980 
TfwApmRBE¡
 *
rbít
 = 
rbuf
->rbent;

982 
	`BUG_ON
(!
‚d©a
);

989 
	`f‹_óch_⁄löe_˝u
(
i˝u
) {

990 
TfwApmUBuf
 *
ubuf
 = 
	`≥r_˝u_±r
(
d©a
->ubuf, 
i˝u
);

991 
idxvÆ
 = 
	`©omic64_öc_ªtu∫
(&
ubuf
->
cou¡î
);

992 
TfwApmUBE¡
 *
ubít
 = 
ubuf
->ubít[(
idxvÆ
 - 1) % 2];

993 
TfwApmUBE¡
 
πt_d©a
;

995 
i
 = 0; i < 
ubuf
->
ubufsz
; ++i) {

996 
πt_d©a
.
d©a
 = 
	`READ_ONCE
(
ubít
[
i
].data);

997 i‡(
πt_d©a
.
d©a
 =
ULONG_MAX
)

999 
	`WRITE_ONCE
(
ubít
[
i
].
d©a
, 
ULONG_MAX
);

1000 
	`tfw_°©s_upd©e
(&
rbít
[
πt_d©a
.
˚¡ry
].
p˙ång
,

1001 
πt_d©a
.
πt
);

1004 
	`tfw_≠m_ˇlc
(
d©a
);

1006 
	`smp_mb
();

1007 i‡(
	`ã°_bô
(
TFW_APM_DATA_F_REARM
, &
d©a
->
Êags
))

1008 
	`mod_timî
(&
d©a
->
timî
, 
jiffõs
 + 
TFW_APM_TIMER_INTVL
);

1009 
	}
}

1016 
	$tfw_≠m_hm_timî_cb
(
d©a
)

1018 
TfwSîvî
 *
§v
 = (TfwSîvî *)
d©a
;

1019 
TfwApmD©a
 *
≠md©a
 = (TfwApmD©®*)
§v
->
≠mªf
;

1020 
TfwApmHM
 *
hm
 = 
	`READ_ONCE
(
≠md©a
->
hm˘l
.hm);

1021 
now
;

1023 
	`BUG_ON
(!
hm
);

1024 i‡(!
	`©omic64_ªad
(&
≠md©a
->
hm˘l
.
rcou¡
))

1025 
	`tfw_hâp_hm_§v_£nd
(
§v
, 
hm
->
ªq
, hm->
ªqsz
);

1027 
	`©omic64_£t
(&
≠md©a
->
hm˘l
.
rcou¡
, 0);

1029 
	`smp_mb
();

1030 i‡(
	`©omic_ªad
(&
≠md©a
->
hm˘l
.
ª¨m
)) {

1031 
now
 = 
jiffõs
;

1032 
	`mod_timî
(&
≠md©a
->
hm˘l
.
timî
, 
now
 + 
hm
->
tmt
 * 
HZ
);

1033 
	`WRITE_ONCE
(
≠md©a
->
hm˘l
.
jtm°amp
, 
now
);

1036 
	`WRITE_ONCE
(
≠md©a
->
hm˘l
.
jtm°amp
, 0);

1037 
	}
}

1040 
	$__tfw_≠m_upd©e
(
TfwApmD©a
 *
d©a
, 
jt°amp
, 
πt
)

1042 
TfwApmUBuf
 *
ubuf
 = 
	`this_˝u_±r
(
d©a
->ubuf);

1043 
idxvÆ
 = 
	`©omic64_add_ªtu∫
(0, &
ubuf
->
cou¡î
);

1044 
TfwApmUBE¡
 *
ubít
 = 
ubuf
->ubít[
idxvÆ
 % 2];

1045 
˚¡ry
 = (
jt°amp
 / 
tfw_≠m_jtmöåvl
Ë% 
d©a
->
rbuf
.
rbufsz
;

1046 
jtmi°¨t
 = 
jt°amp
 - (jt°am∞% 
tfw_≠m_jtmöåvl
);

1047 
TfwApmUBE¡
 
πt_d©a
 = { .
˚¡ry
 = cíåy, .
πt
 =Ñtt };

1049 
	`tfw_≠m_rbít_checkª£t
(&
d©a
->
rbuf
.
rbít
[
˚¡ry
], 
jtmi°¨t
);

1050 
	`WRITE_ONCE
(
ubít
[
jt°amp
 % 
ubuf
->
ubufsz
].
d©a
, 
πt_d©a
.data);

1051 
	}
}

1054 
	$tfw_≠m_upd©e
(*
≠mªf
, 
jt°amp
, 
jπt
)

1056 
	`BUG_ON
(!
≠mªf
);

1057 
	`__tfw_≠m_upd©e
(
≠mªf
, 
jt°amp
, 
	`jiffõs_to_m£cs
(
jπt
));

1058 
	}
}

1061 
	$tfw_≠m_de°roy
(
TfwApmD©a
 *
d©a
)

1063 
i˝u
;

1065 
	`f‹_óch_⁄löe_˝u
(
i˝u
) {

1066 
TfwApmUBuf
 *
ubuf
 = 
	`≥r_˝u_±r
(
d©a
->ubuf, 
i˝u
);

1067 
	`k‰ì
(
ubuf
->
ubít
[0]);

1069 
	`‰ì_≥r˝u
(
d©a
->
ubuf
);

1070 
	`k‰ì
(
d©a
);

1071 
	}
}

1076 
ölöe
 

1077 
	$tfw_≠m_rbít_öô
(
TfwApmRBE¡
 *
rbít
, 
jtmi°amp
)

1079 
	`mem˝y
(
rbít
->
p˙ång
.
˘l
, 
tfw_∫g˘l_öô
, (rbent->pcntrng.ctl));

1080 
	`__tfw_≠m_rbít_ª£t
(
rbít
, 
jtmi°amp
);

1081 
	}
}

1091 
	$tfw_≠m_¸óã
()

1093 
TfwApmD©a
 *
d©a
;

1094 
TfwApmRBE¡
 *
rbít
;

1095 
TfwApmHMSèts
 *
hm°©s
;

1096 
TfwApmHMCfg
 *
ít
;

1097 
i
, 
i˝u
, 
size
, 
hm_size
;

1098 *
vÆ
[2];

1099 
rbufsz
 = 
tfw_≠m_tmwsˇÀ
;

1100 
psz
 = 
	`ARRAY_SIZE
(
tfw_p°©s_ôh
);

1102 
	`might_¶ìp
();

1103 i‡(!
tfw_≠m_tmwsˇÀ
) {

1104 
	`TFW_ERR
("Late initialization of 'apm_stats' option\n");

1105  
NULL
;

1108 
hm_size
 = 
tfw_hm_codes_˙t
 * (
TfwApmHMSèts
);

1111 
size
 = (
TfwApmD©a
)

1112 + 
rbufsz
 * (
TfwApmRBE¡
)

1113 + 2 * 
psz
 * ()

1114 + 
hm_size
;

1115 i‡((
d©a
 = 
	`kzÆloc
(
size
, 
GFP_ATOMIC
)Ë=
NULL
)

1116  
NULL
;

1118 
size
 = (
TfwApmUBuf
);

1119 
d©a
->
ubuf
 = 
	`__Æloc_≥r˝u_gÂ
(
size
, (
öt64_t
), 
GFP_KERNEL
);

1120 i‡(!
d©a
->
ubuf
) {

1121 
	`k‰ì
(
d©a
);

1122  
NULL
;

1126 
rbít
 = (
TfwApmRBE¡
 *)(
d©a
 + 1);

1127 
vÆ
[0] = (*)(
rbít
 + 
rbufsz
);

1128 
vÆ
[1] = (*)(vÆ[0] + 
psz
);

1130 
d©a
->
rbuf
.
rbít
 =Ñbent;

1131 
d©a
->
rbuf
.
rbufsz
 =Ñbufsz;

1133 
d©a
->
°©s
.
a£¡
[0].
p°©s
.
ôh
 = 
tfw_p°©s_ôh
;

1134 
d©a
->
°©s
.
a£¡
[0].
p°©s
.
vÆ
 = val[0];

1135 
d©a
->
°©s
.
a£¡
[0].
p°©s
.
psz
 =Ösz;

1137 
d©a
->
°©s
.
a£¡
[1].
p°©s
.
ôh
 = 
tfw_p°©s_ôh
;

1138 
d©a
->
°©s
.
a£¡
[1].
p°©s
.
vÆ
 = val[1];

1139 
d©a
->
°©s
.
a£¡
[1].
p°©s
.
psz
 =Ösz;

1142 
i
 = 0; i < 
rbufsz
; ++i)

1143 
	`tfw_≠m_rbít_öô
(&
rbít
[
i
], 0);

1144 
	`•ö_lock_öô
(&
d©a
->
rbuf
.
¶ock
);

1146 
	`rwlock_öô
(&
d©a
->
°©s
.
a£¡
[0].
rwlock
);

1147 
	`rwlock_öô
(&
d©a
->
°©s
.
a£¡
[1].
rwlock
);

1148 
	`©omic_£t
(&
d©a
->
°©s
.
rdidx
, 0);

1150 
size
 = 2 * 
TFW_APM_UBUF_SZ
 * (
TfwApmUBE¡
);

1151 
	`f‹_óch_⁄löe_˝u
(
i˝u
) {

1152 
TfwApmUBE¡
 *
ubít
;

1153 
TfwApmUBuf
 *
ubuf
 = 
	`≥r_˝u_±r
(
d©a
->ubuf, 
i˝u
);

1154 
ubít
 = 
	`kmÆloc_node
(
size
, 
GFP_KERNEL
, 
	`˝u_to_node
(
i˝u
));

1155 i‡(!
ubít
)

1156 
˛ónup
;

1157 
i
 = 0; i < 2 * 
TFW_APM_UBUF_SZ
; ++i)

1158 
	`WRITE_ONCE
(
ubít
[
i
].
d©a
, 
ULONG_MAX
);

1159 
ubuf
->
ubít
[0] = ubent;

1160 
ubuf
->
ubít
[1] = ubíà+ 
TFW_APM_UBUF_SZ
;

1161 
ubuf
->
ubufsz
 = 
TFW_APM_UBUF_SZ
;

1164 i‡(
hm_size
) {

1165 
i
 = 0;

1166 
hm°©s
 = (
TfwApmHMSèts
 *)(
vÆ
[1] + 
psz
);

1167 
	`li°_f‹_óch_íåy
(
ít
, &
tfw_hm_codes_li°
, 
li°
)

1168 
hm°©s
[
i
++].
hmcfg
 = 
ít
;

1169 
	`BUG_ON
(
tfw_hm_codes_˙t
 !
i
);

1170 
d©a
->
hm˘l
.
hm°©s
 = hmstats;

1173  
d©a
;

1175 
˛ónup
:

1176 
	`tfw_≠m_de°roy
(
d©a
);

1177  
NULL
;

1178 
	}
}

1180 
ölöe
 

1181 
	$tfw_≠m_hm_°›_timî
(
TfwApmD©a
 *
d©a
) {

1182 
	`BUG_ON
(!
d©a
);

1183 
	`©omic_£t
(&
d©a
->
hm˘l
.
ª¨m
, 0);

1184 
	`smp_mb__a·î_©omic
();

1185 
	`dñ_timî_sync
(&
d©a
->
hm˘l
.
timî
);

1186 
	}
}

1189 
	$tfw_≠m_add_§v
(
TfwSîvî
 *
§v
)

1191 
TfwApmD©a
 *
d©a
;

1193 
	`BUG_ON
(
§v
->
≠mªf
);

1194 i‡(!(
d©a
 = 
	`tfw_≠m_¸óã
()))

1195  -
ENOMEM
;

1198 
	`£t_bô
(
TFW_APM_DATA_F_REARM
, &
d©a
->
Êags
);

1199 
	`£tup_timî
(&
d©a
->
timî
, 
tfw_≠m_¥˙é_tm‚
, ()data);

1200 
	`mod_timî
(&
d©a
->
timî
, 
jiffõs
 + 
TFW_APM_TIMER_INTVL
);

1202 
§v
->
≠mªf
 = 
d©a
;

1205 
	}
}

1208 
	$tfw_≠m_dñ_§v
(
TfwSîvî
 *
§v
)

1210 
TfwApmD©a
 *
d©a
 = 
§v
->
≠mªf
;

1212 i‡(!
d©a
)

1216 i‡(
	`ã°_bô
(
TFW_SRV_B_HMONITOR
, &
§v
->
Êags
))

1217 
	`tfw_≠m_hm_dißbÀ_§v
(
§v
);

1220 
	`˛ór_bô
(
TFW_APM_DATA_F_REARM
, &
d©a
->
Êags
);

1221 
	`smp_mb__a·î_©omic
();

1222 
	`dñ_timî_sync
(&
d©a
->
timî
);

1224 
	`tfw_≠m_de°roy
(
d©a
);

1225 
§v
->
≠mªf
 = 
NULL
;

1226 
	}
}

1229 
	$tfw_≠m_hm_§v_rcou¡_upd©e
(
TfwSå
 *
uri_∑th
, *
≠mªf
)

1231 
TfwApmHMCé
 *
hm˘l
 = &((
TfwApmD©a
 *)
≠mªf
)->hmctl;

1232 
TfwApmHM
 *
hm
 = 
	`READ_ONCE
(
hm˘l
->hm);

1234 
	`BUG_ON
(!
hm
);

1235 i‡(
	`tfw_°r_eq_c°r
(
uri_∑th
, 
hm
->
uæ
, hm->
uæsz
, 
TFW_STR_EQ_CASEI
))

1236 
	`©omic64_öc
(&
hm˘l
->
rcou¡
);

1237 
	}
}

1239 
boﬁ


1240 
	$tfw_≠m_hm_§v_Æive
(
°©us
, 
TfwSå
 *
body
, *
≠mªf
)

1242 
TfwApmHM
 *
hm
 = 
	`READ_ONCE
(((
TfwApmD©a
 *)
≠mªf
)->
hm˘l
.hm);

1243 
u32
 
¸c32
 = 0;

1245 
	`BUG_ON
(!
hm
);

1246 i‡(
hm
->
codes
 && !
	`ã°_bô
(
	`HTTP_CODE_BIT_NUM
(
°©us
), hm->codes)) {

1247 
	`TFW_WARN_NL
("Response for health monitor '%s': status"

1248 " '%d' mism©ched\n", 
hm
->
«me
, 
°©us
);

1249  
Ál£
;

1252 i‡(!
body
->
Àn
) {

1253 i‡(
hm
->
¸c32
 != 0)

1254 
¸c_îr
;

1255  
åue
;

1262 i‡(!
hm
->
¸c32
 && hm->
auto_¸c
) {

1263 
hm
->
¸c32
 = 
	`tfw_°r_¸c32_ˇlc
(
body
);

1264 } i‡(
hm
->
¸c32
) {

1265 
¸c32
 = 
	`tfw_°r_¸c32_ˇlc
(
body
);

1266 i‡(
hm
->
¸c32
 != crc32)

1267 
¸c_îr
;

1270  
åue
;

1271 
¸c_îr
:

1272 
	`TFW_WARN_NL
("Response for health monitor '%s': crc32"

1274 " '%u')\n", 
hm
->
«me
, 
¸c32
, hm->crc32);

1275  
Ál£
;

1276 
	}
}

1278 
boﬁ


1279 
	$tfw_≠m_hm_§v_limô
(
°©us
, *
≠mªf
)

1281 
i
, 
sum
 = 0;

1282 
TfwApmHMSèts
 *
hm°©s
 = ((
TfwApmD©a
 *)
≠mªf
)->
hm˘l
.hmstats;

1283 
TfwApmHMHi°‹y
 *
hi°‹y
 = 
NULL
;

1284 
TfwApmHMCfg
 *
cfg
 = 
NULL
;

1285 
ts
;

1287 
	`BUG_ON
(!
hm°©s
);

1288 
i
 = 0; i < 
tfw_hm_codes_˙t
; ++i) {

1294 i‡(
hm°©s
[
i
].
hmcfg
->
code
 =
°©us
 ||

1295 
hm°©s
[
i
].
hmcfg
->
code
 =
°©us
 / 100)

1297 
hi°‹y
 = 
hm°©s
[
i
].history;

1298 
cfg
 = 
hm°©s
[
i
].
hmcfg
;

1299 
hm°©s
 = &hm°©s[
i
];

1304 i‡(!
hi°‹y
)

1305  
Ál£
;

1307 
	`BUG_ON
(!
cfg
);

1308 
	`•ö_lock
(&
hm°©s
->
lock
);

1310 
ts
 = 
jiffõs
 * 
HM_FREQ
 / (
cfg
->
t‰ame
 * 
HZ
);

1311 
i
 = 
ts
 % 
HM_FREQ
;

1312 i‡(
hi°‹y
[
i
].
ts
 !=Ås) {

1313 
hi°‹y
[
i
].
ts
 =Ås;

1314 
hi°‹y
[
i
].
ª•
 = 0;

1316 ++
hi°‹y
[
i
].
ª•
;

1317 
i
 = 0; i < 
HM_FREQ
; ++i)

1318 i‡(
hi°‹y
[
i
].
ts
 + 
HM_FREQ
 >Ås)

1319 
sum
 +
hi°‹y
[
i
].
ª•
;

1321 
	`WRITE_ONCE
(
hm°©s
->
rsum
, 
sum
);

1322 
	`•ö_u∆ock
(&
hm°©s
->
lock
);

1324 i‡(
sum
 > 
cfg
->
limô
)

1325  
åue
;

1327  
Ál£
;

1328 
	}
}

1331 
	$tfw_≠m_hm_íabÀ_§v
(
TfwSîvî
 *
§v
, *
hmªf
)

1333 
TfwApmHMCé
 *
hm˘l
;

1334 
now
;

1335 
TfwApmHM
 *
hm
 = 
hmªf
;

1337 
	`BUG_ON
(!
§v
->
≠mªf
);

1338 
	`BUG_ON
(!
hm
);

1339 
	`WARN_ON_ONCE
(
	`ã°_bô
(
TFW_SRV_B_HMONITOR
, &
§v
->
Êags
));

1340 
	`WARN_ON_ONCE
(
	`ã°_bô
(
TFW_SRV_B_SUSPEND
, &
§v
->
Êags
));

1343 
hm˘l
 = &((
TfwApmD©a
 *)
§v
->
≠mªf
)->hmctl;

1344 
	`WRITE_ONCE
(
hm˘l
->
hm
, hm);

1345 
	`©omic64_£t
(&
hm˘l
->
rcou¡
, 0);

1348 
	`©omic_£t
(&
hm˘l
->
ª¨m
, 1);

1349 
	`smp_mb__a·î_©omic
();

1350 
	`£tup_timî
(&
hm˘l
->
timî
, 
tfw_≠m_hm_timî_cb
, ()
§v
);

1351 
now
 = 
jiffõs
;

1352 
	`mod_timî
(&
hm˘l
->
timî
, 
now
 + 
hm
->
tmt
 * 
HZ
);

1353 
	`WRITE_ONCE
(
hm˘l
->
jtm°amp
, 
now
);

1356 
	`£t_bô
(
TFW_SRV_B_HMONITOR
, &
§v
->
Êags
);

1357 
	}
}

1360 
	$tfw_≠m_hm_dißbÀ_§v
(
TfwSîvî
 *
§v
)

1362 
	`˛ór_bô
(
TFW_SRV_B_HMONITOR
, &
§v
->
Êags
);

1363 
	`tfw_§v_m¨k_Æive
(
§v
);

1364 
	`tfw_≠m_hm_°›_timî
((
TfwApmD©a
 *)
§v
->
≠mªf
);

1365 
	}
}

1367 
boﬁ


1368 
	$tfw_≠m_hm_§v_eq
(c⁄° *
«me
, 
TfwSîvî
 *
§v
)

1370 
TfwApmHM
 *
hm
;

1372 
	`BUG_ON
(!
§v
->
≠mªf
);

1373 
hm
 = ((
TfwApmD©a
 *)
§v
->
≠mªf
)->
hm˘l
.hm;

1374 
	`BUG_ON
(!
hm
);

1375 if(!
	`°rˇ£cmp
(
«me
, 
hm
->name))

1376  
åue
;

1378  
Ál£
;

1379 
	}
}

1386 
TfwHMSèts
 *

1387 
	$tfw_≠m_hm_°©s
(*
≠mªf
)

1389 
i
;

1390 
πime
;

1391 
size_t
 
size
;

1392 
TfwHMSèts
 *
°©s
;

1393 
TfwHMCodeSèts
 *
rsums
;

1394 
TfwApmHMCé
 *
hm˘l
 = &((
TfwApmD©a
 *)
≠mªf
)->hmctl;

1395 
TfwApmHM
 *
hm
 = 
	`READ_ONCE
(
hm˘l
->hm);

1397 
	`BUG_ON
(!
hm˘l
->
hm°©s
 || !
hm
);

1398 
size
 = (
TfwHMSèts
Ë+ (
TfwHMCodeSèts
Ë* 
tfw_hm_codes_˙t
;

1399 i‡(!(
°©s
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
)))

1400  
NULL
;

1402 
rsums
 = (
TfwHMCodeSèts
 *)(
°©s
 + 1);

1403 
i
 = 0; i < 
tfw_hm_codes_˙t
; ++i) {

1404 
	`BUG_ON
(!
hm˘l
->
hm°©s
[
i
].
hmcfg
);

1405 
rsums
[
i
].
code
 = 
hm˘l
->
hm°©s
[i].
hmcfg
->code;

1406 
rsums
[
i
].
sum
 = 
	`READ_ONCE
(
hm˘l
->
hm°©s
[i].
rsum
);

1408 
°©s
->
rsums
 =Ñsums;

1409 
°©s
->
c˙t
 = 
tfw_hm_codes_˙t
;

1411 
πime
 = ()
hm
->
tmt
 - (
jiffõs
 - 
	`READ_ONCE
(
hm˘l
->
jtm°amp
))

1412 / 
HZ
;

1413 
°©s
->
πime
 =Ñtime < 0 ? 0 :Ñtime;

1415  
°©s
;

1416 
	}
}

1419 
	$tfw_≠m_gë_hm
(c⁄° *
«me
)

1421 
TfwApmHM
 *
hm
;

1423 
	`li°_f‹_óch_íåy
(
hm
, &
tfw_hm_li°
, 
li°
) {

1424 i‡(!
	`°rˇ£cmp
(
«me
, 
hm
->name))

1425  
hm
;

1427  
NULL
;

1428 
	}
}

1431 
	#TFW_APM_MIN_TMWSCALE
 1

	)

1432 
	#TFW_APM_MAX_TMWSCALE
 50

	)

1434 
	#TFW_APM_MIN_TMWINDOW
 60

	)

1435 
	#TFW_APM_MAX_TMWINDOW
 3600

	)

1437 
	#TFW_APM_MIN_TMINTRVL
 5

	)

1439 
	#TFW_APM_HM_AUTO
 "auto"

	)

1440 
	#TFW_APM_DFLT_REQ
 "\"GET / HTTTP/1.0\r\n\r\n\""

	)

1441 
	#TFW_APM_DFLT_URL
 "\"/\""

	)

1443 
boﬁ


1444 
	$tfw_≠m_check_hm
(c⁄° *
«me
)

1446 i‡(!
tfw_hm_codes_˙t
) {

1447 
	`TFW_ERR_NL
("NoÑesponse codes specified for"

1449  
Ál£
;

1452 i‡(!
	`°rˇ£cmp
(
«me
, 
TFW_APM_HM_AUTO
Ë|| 
	`tfw_≠m_gë_hm
(name))

1453  
åue
;

1455 
	`TFW_ERR_NL
("health monitor withÇame"

1456 " '%s' d€†nŸÉxi°\n", 
«me
);

1458  
Ál£
;

1459 
	}
}

1462 
	$tfw_cfg›_≠m_add_hm
(c⁄° *
«me
)

1464 
size
 = 
	`°æí
(
«me
) + 1;

1465 
	`BUG_ON
(
tfw_hm_íåy
);

1466 
tfw_hm_íåy
 = 
	`kzÆloc
((
TfwApmHM
Ë+ 
size
, 
GFP_KERNEL
);

1467 i‡(!
tfw_hm_íåy
) {

1468 
	`TFW_ERR_NL
("C™'àÆloˇã hó…h checkÉ¡ry '%s'\n", 
«me
);

1469  -
ENOMEM
;

1471 
	`INIT_LIST_HEAD
(&
tfw_hm_íåy
->
li°
);

1472 
tfw_hm_íåy
->
«me
 = (*)(tfw_hm_entry + 1);

1473 
	`mem˝y
(
tfw_hm_íåy
->
«me
,Çame, 
size
);

1474 
	`li°_add
(&
tfw_hm_íåy
->
li°
, &
tfw_hm_li°
);

1477 
	}
}

1480 
	$tfw_cfg›_≠m_add_hm_ªq
(c⁄° *
ªq_c°r
, 
TfwApmHM
 *
hm_íåy
)

1482 
size
;

1484 
size
 = 
	`°æí
(
ªq_c°r
);

1485 
hm_íåy
->
ªq
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
,

1486 
	`gë_‹dî
(
size
));

1487 i‡(!
hm_íåy
->
ªq
) {

1488 
	`TFW_ERR_NL
("Can'tállocate memory for health"

1490  -
ENOMEM
;

1492 
	`mem˝y
(
hm_íåy
->
ªq
, 
ªq_c°r
, 
size
);

1493 
hm_íåy
->
ªqsz
 = 
size
;

1496 
	}
}

1499 
	$tfw_cfg›_≠m_add_hm_uæ
(c⁄° *
uæ
, 
TfwApmHM
 *
hm_íåy
)

1501 *
m±r
;

1502 
size
;

1504 
size
 = 
	`°æí
(
uæ
);

1505 
m±r
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
);

1506 i‡(!
m±r
) {

1507 
	`TFW_ERR_NL
("C™'àÆloˇã mem‹y f‹ '%s'\n", 
uæ
);

1508  -
ENOMEM
;

1510 
	`mem˝y
(
m±r
, 
uæ
, 
size
);

1511 
hm_íåy
->
uæ
 = 
m±r
;

1512 
hm_íåy
->
uæsz
 = 
size
;

1515 
	}
}

1517 
ölöe
 

1518 
	$tfw_cfg›_≠m_Æloc_hm_codes
(
TfwApmHM
 *
hm_íåy
)

1520 
tfw_hm_íåy
->
codes
 = 
	`kzÆloc
(
	`BITS_TO_LONGS
(512) * (),

1521 
GFP_KERNEL
);

1522 i‡(!
tfw_hm_íåy
->
codes
) {

1523 
	`TFW_ERR_NL
("Can'tállocate memory for HTTP codes"

1525 
tfw_hm_íåy
->
«me
);

1526  -
ENOMEM
;

1529 
	}
}

1532 
	$__tfw_cfg›_˛ónup_≠m_hm
()

1534 
TfwApmHM
 *
hm
, *
tmp
;

1536 
tfw_hm_íåy
 = 
NULL
;

1537 
tfw_hm_deÁu…
 = 
NULL
;

1538 
tfw_hm_ex∂_def
 = 
Ál£
;

1540 
	`li°_f‹_óch_íåy_ß„
(
hm
, 
tmp
, &
tfw_hm_li°
, 
li°
) {

1541 
	`‰ì_∑ges
(()
hm
->
ªq
, 
	`gë_‹dî
(hm->
ªqsz
));

1542 
	`k‰ì
(
hm
->
uæ
);

1543 
	`k‰ì
(
hm
->
codes
);

1544 
	`li°_dñ
(&
hm
->
li°
);

1545 
	`k‰ì
(
hm
);

1547 
	`INIT_LIST_HEAD
(&
tfw_hm_li°
);

1548 
	}
}

1551 
	$tfw_cfg›_˛ónup_≠m_hm
(
TfwCfgS≥c
 *
cs
)

1553 
	`__tfw_cfg›_˛ónup_≠m_hm
();

1554 
	}
}

1557 
	$tfw_≠m_cfgíd
()

1559 
jtmwödow
;

1560 
r
;

1562 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1565 i‡((
tfw_≠m_jtmwödow
 < 
TFW_APM_MIN_TMWINDOW
)

1566 || (
tfw_≠m_jtmwödow
 > 
TFW_APM_MAX_TMWINDOW
))

1568 
	`TFW_ERR_NL
("apm_stats: window: value '%d' is out ofÜimits.\n",

1569 
tfw_≠m_jtmwödow
);

1570  -
EINVAL
;

1572 i‡((
tfw_≠m_tmwsˇÀ
 < 
TFW_APM_MIN_TMWSCALE
)

1573 || (
tfw_≠m_tmwsˇÀ
 > 
TFW_APM_MAX_TMWSCALE
))

1575 
	`TFW_ERR_NL
("apm_stats: scale: value '%d' is out ofÜimits.\n",

1576 
tfw_≠m_tmwsˇÀ
);

1577  -
EINVAL
;

1581 i‡(
tfw_≠m_tmwsˇÀ
 == 1)

1582 
tfw_≠m_tmwsˇÀ
 = 2;

1584 
jtmwödow
 = 
	`m£cs_to_jiffõs
(
tfw_≠m_jtmwödow
 * 1000);

1585 
tfw_≠m_jtmöåvl
 = 
jtmwödow
 / 
tfw_≠m_tmwsˇÀ


1586 + !!(
jtmwödow
 % 
tfw_≠m_tmwsˇÀ
);

1588 i‡(
tfw_≠m_jtmöåvl
 < 
TFW_APM_MIN_TMINTRVL
) {

1589 
	`TFW_ERR_NL
("apm_stats window=%d scale=%d: scale isÅooÜong.\n",

1590 
tfw_≠m_jtmwödow
, 
tfw_≠m_tmwsˇÀ
);

1591  -
EINVAL
;

1593 
tfw_≠m_jtmwödow
 = 
tfw_≠m_jtmöåvl
 * 
tfw_≠m_tmwsˇÀ
;

1600 i‡(
tfw_hm_ex∂_def
)

1603 i‡((
r
 = 
	`tfw_cfg›_≠m_add_hm
(
TFW_APM_HM_AUTO
)))

1604  
r
;

1606 i‡((
r
 = 
	`tfw_cfg›_≠m_add_hm_ªq
(
TFW_APM_DFLT_REQ
, 
tfw_hm_íåy
)))

1607  
r
;

1609 i‡((
r
 = 
	`tfw_cfg›_≠m_add_hm_uæ
(
TFW_APM_DFLT_URL
, 
tfw_hm_íåy
)))

1610  
r
;

1612 i‡((
r
 = 
	`tfw_cfg›_≠m_Æloc_hm_codes
(
tfw_hm_íåy
)))

1613  
r
;

1619 
	`__£t_bô
(
	`HTTP_CODE_BIT_NUM
(200), 
tfw_hm_íåy
->
codes
);

1620 
tfw_hm_íåy
->
auto_¸c
 = 
åue
;

1621 
tfw_hm_íåy
->
tmt
 = 10;

1622 
tfw_hm_íåy
 = 
NULL
;

1625 
	}
}

1628 
	$tfw_≠m_cfg˛ón
()

1634 
	`__tfw_cfg›_˛ónup_≠m_hm
();

1635 
	}
}

1642 
	$tfw_cfg›_˛ónup_≠m
(
TfwCfgS≥c
 *
cs
)

1644 
tfw_≠m_jtmwödow
 = 
tfw_≠m_tmwsˇÀ
 = 0;

1645 
	}
}

1648 
	$tfw_cfg›_≠m_°©s
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1650 
i
, 
r
;

1651 c⁄° *
key
, *
vÆ
;

1653 i‡(
˚
->
vÆ_n
) {

1654 
	`TFW_ERR_NL
("%s: Arguments must beá key=valueÖair.\n",

1655 
cs
->
«me
);

1656  -
EINVAL
;

1658 i‡(!
˚
->
©å_n
) {

1659 
	`TFW_WARN_NL
("%s:árguments missing, using default values.\n",

1660 
cs
->
«me
);

1664 
	`TFW_CFG_ENTRY_FOR_EACH_ATTR
(
˚
, 
i
, 
key
, 
vÆ
) {

1665 i‡(!
	`°rˇ£cmp
(
key
, "window")) {

1666 i‡((
r
 = 
	`tfw_cfg_∑r£_öt
(
vÆ
, &
tfw_≠m_jtmwödow
)))

1667  
r
;

1668 } i‡(!
	`°rˇ£cmp
(
key
, "scale")) {

1669 i‡((
r
 = 
	`tfw_cfg_∑r£_öt
(
vÆ
, &
tfw_≠m_tmwsˇÀ
)))

1670  
r
;

1672 
	`TFW_ERR_NL
("%s: unsupportedárgument: '%s=%s'.\n",

1673 
cs
->
«me
, 
key
, 
vÆ
);

1674  -
EINVAL
;

1679 
	}
}

1682 
	$tfw_cfg›_≠m_£rvî_Áûovî
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1684 
TfwApmHMCfg
 *
hm_íåy
;

1685 
code
, 
limô
, 
t‰ame
;

1687 i‡(
	`tfw_cfg_check_vÆ_n
(
˚
, 3))

1688  -
EINVAL
;

1689 i‡(
˚
->
©å_n
) {

1690 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

1691  -
EINVAL
;

1694 i‡(
	`tfw_cfg›_∑r£_hâp_°©us
(
˚
->
vÆs
[0], &
code
)) {

1695 
	`TFW_ERR_NL
("UnableÅoÖarse http code value: '%s'\n",

1696 
˚
->
vÆs
[0]);

1697  -
EINVAL
;

1699 i‡(
	`tfw_cfg_∑r£_öt
(
˚
->
vÆs
[1], &
limô
)) {

1700 
	`TFW_ERR_NL
("UnableÅoÖarse httpÜimit value: '%s'\n",

1701 
˚
->
vÆs
[1]);

1702  -
EINVAL
;

1704 i‡(
	`tfw_cfg_check_ønge
(
limô
, 1, 
USHRT_MAX
))

1705  -
EINVAL
;

1707 i‡(
	`tfw_cfg_∑r£_öt
(
˚
->
vÆs
[2], &
t‰ame
)) {

1708 
	`TFW_ERR_NL
("UnableÅoÖarse httpÅframe value: '%s'\n",

1709 
˚
->
vÆs
[2]);

1710  -
EINVAL
;

1712 i‡(
	`tfw_cfg_check_ønge
(
t‰ame
, 1, 
USHRT_MAX
))

1713  -
EINVAL
;

1715 
hm_íåy
 = 
	`kzÆloc
((
TfwApmHMCfg
), 
GFP_KERNEL
);

1716 i‡(!
hm_íåy
)

1717  -
ENOMEM
;

1719 
	`INIT_LIST_HEAD
(&
hm_íåy
->
li°
);

1720 
hm_íåy
->
code
 = code;

1721 
hm_íåy
->
limô
 =Üimit;

1722 
hm_íåy
->
t‰ame
 =Åframe;

1723 
	`li°_add
(&
hm_íåy
->
li°
, &
tfw_hm_codes_li°
);

1724 ++
tfw_hm_codes_˙t
;

1727 
	}
}

1730 
	$tfw_cfg›_≠m_˛ónup_£rvî_Áûovî
(
TfwCfgS≥c
 *
cs
)

1732 
TfwApmHMCfg
 *
ít
, *
tmp
;

1734 
	`li°_f‹_óch_íåy_ß„
(
ít
, 
tmp
, &
tfw_hm_codes_li°
, 
li°
) {

1735 
	`li°_dñ_öô
(&
ít
->
li°
);

1736 
	`k‰ì
(
ít
);

1738 
	`INIT_LIST_HEAD
(&
tfw_hm_codes_li°
);

1739 
tfw_hm_codes_˙t
 = 0;

1740 
	}
}

1743 
	$tfw_cfg›_begö_≠m_hm
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1745 
TfwApmHM
 *
hm
;

1746 
r
;

1748 i‡(
	`tfw_cfg_check_vÆ_n
(
˚
, 1))

1749  -
EINVAL
;

1750 i‡(
˚
->
©å_n
) {

1751 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

1752  -
EINVAL
;

1755 
	`li°_f‹_óch_íåy
(
hm
, &
tfw_hm_li°
, 
li°
) {

1756 i‡(!
	`°rˇ£cmp
(
hm
->
«me
, 
˚
->
vÆs
[0])) {

1757 
	`TFW_ERR_NL
("Duplicate health checkÉntry: '%s'\n",

1758 
˚
->
vÆs
[0]);

1759  -
EINVAL
;

1763 i‡((
r
 = 
	`tfw_cfg›_≠m_add_hm
(
˚
->
vÆs
[0])))

1764  
r
;

1766 i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[0], 
TFW_APM_HM_AUTO
)) {

1767 
tfw_hm_deÁu…
 = 
tfw_hm_íåy
;

1768 
tfw_hm_ex∂_def
 = 
åue
;

1772 
	}
}

1775 
	$tfw_cfg›_föish_≠m_hm
(
TfwCfgS≥c
 *
cs
)

1777 
	`BUG_ON
(!
tfw_hm_íåy
);

1778 
	`BUG_ON
(
	`li°_em±y
(&
tfw_hm_li°
));

1779 i‡(!
tfw_hm_íåy
->
codes
 && !tfw_hm_íåy->
¸c32
) {

1780 
	`TFW_ERR_NL
("AtÜeast one of 'resp_code' or 'resp_crc32'"

1782 " c⁄figuªd f‹ '%s'\n", 
cs
->
«me
);

1783  -
EINVAL
;

1785 
tfw_hm_íåy
 = 
NULL
;

1786 
tfw_hm_deÁu…
 = 
NULL
;

1789 
	}
}

1792 
	$tfw_cfg›_≠m_hm_ªque°
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1794 i‡(
	`tfw_cfg_check_sögÀ_vÆ
(
˚
))

1795  -
EINVAL
;

1797 
	`BUG_ON
(!
tfw_hm_íåy
);

1798  
	`tfw_cfg›_≠m_add_hm_ªq
(
˚
->
vÆs
[0], 
tfw_hm_íåy
);

1799 
	}
}

1802 
	$tfw_cfg›_≠m_hm_ªq_uæ
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1804 i‡(
	`tfw_cfg_check_sögÀ_vÆ
(
˚
))

1805  -
EINVAL
;

1807 
	`BUG_ON
(!
tfw_hm_íåy
);

1808  
	`tfw_cfg›_≠m_add_hm_uæ
(
˚
->
vÆs
[0], 
tfw_hm_íåy
);

1809 
	}
}

1812 
	$tfw_cfg›_≠m_hm_ª•_code
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1814 
r
, 
i
, 
code
;

1815 c⁄° *
vÆ
;

1817 i‡(!
˚
->
vÆ_n
) {

1818 
	`TFW_ERR_NL
("Noárguments found.\n");

1819  -
EINVAL
;

1821 i‡(
˚
->
©å_n
) {

1822 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

1823  -
EINVAL
;

1826 i‡((
r
 = 
	`tfw_cfg›_≠m_Æloc_hm_codes
(
tfw_hm_íåy
)))

1827  
r
;

1829 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
vÆ
) {

1830 i‡(
	`tfw_cfg›_∑r£_hâp_°©us
(
vÆ
, &
code
)

1831 || 
	`tfw_cfg_check_ønge
(
code
, 
HTTP_CODE_MIN
, 
HTTP_CODE_MAX
))

1833 
	`TFW_ERR_NL
("UnableÅoÖarse http code value: '%s'\n",

1834 
vÆ
);

1835 
	`k‰ì
(
tfw_hm_íåy
->
codes
);

1836  -
EINVAL
;

1838 
	`__£t_bô
(
	`HTTP_CODE_BIT_NUM
(
code
), 
tfw_hm_íåy
->
codes
);

1841 
	}
}

1844 
	$tfw_cfg›_≠m_hm_ª•_¸c32
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1846 
u32
 
¸c32
;

1848 i‡(
	`tfw_cfg_check_sögÀ_vÆ
(
˚
))

1849  -
EINVAL
;

1851 i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[0], 
TFW_APM_HM_AUTO
)) {

1852 i‡(
tfw_hm_deÁu…
)

1853 
tfw_hm_deÁu…
->
auto_¸c
 = 
åue
;

1857 i‡(
	`tfw_cfg_∑r£_uöt
(
˚
->
vÆs
[0], &
¸c32
)) {

1858 
	`TFW_ERR_NL
("U«bÀÅÿ∑r£ crc32 vÆue: '%s'\n", 
˚
->
vÆs
[0]);

1859  -
EINVAL
;

1862 
tfw_hm_íåy
->
¸c32
 = crc32;

1865 
	}
}

1868 
	$tfw_cfg›_≠m_hm_timeout
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1870 
timeout
;

1872 i‡(
	`tfw_cfg_check_sögÀ_vÆ
(
˚
))

1873  -
EINVAL
;

1874 i‡(
	`tfw_cfg_∑r£_öt
(
˚
->
vÆs
[0], &
timeout
)) {

1875 
	`TFW_ERR_NL
("UnableÅoÖarse httpÅimeout value: '%s'\n",

1876 
˚
->
vÆs
[0]);

1877  -
EINVAL
;

1879 i‡(
	`tfw_cfg_check_ønge
(
timeout
, 1, 
USHRT_MAX
))

1880  -
EINVAL
;

1882 
tfw_hm_íåy
->
tmt
 = 
timeout
;

1885 
	}
}

1887 
TfwCfgS≥c
 
	gtfw_≠m_hm_•ecs
[] = {

1889 .
«me
 = "request",

1890 .
	gdeÊt
 = 
TFW_APM_DFLT_REQ
,

1891 .
	gh™dÀr
 = 
tfw_cfg›_≠m_hm_ªque°
,

1892 .
	gÆlow_n⁄e
 = 
Ál£
,

1893 .
	gÆlow_ª≥©
 = 
Ál£
,

1896 .
	g«me
 = "request_url",

1897 .
	gdeÊt
 = 
TFW_APM_DFLT_URL
,

1898 .
	gh™dÀr
 = 
tfw_cfg›_≠m_hm_ªq_uæ
,

1899 .
	gÆlow_n⁄e
 = 
Ál£
,

1900 .
	gÆlow_ª≥©
 = 
Ál£
,

1903 .
	g«me
 = "resp_code",

1904 .
	gdeÊt
 = 
NULL
,

1905 .
	gh™dÀr
 = 
tfw_cfg›_≠m_hm_ª•_code
,

1906 .
	gÆlow_n⁄e
 = 
åue
,

1907 .
	gÆlow_ª≥©
 = 
Ál£
,

1910 .
	g«me
 = "resp_crc32",

1911 .
	gdeÊt
 = 
NULL
,

1912 .
	gh™dÀr
 = 
tfw_cfg›_≠m_hm_ª•_¸c32
,

1913 .
	gÆlow_n⁄e
 = 
åue
,

1914 .
	gÆlow_ª≥©
 = 
Ál£
,

1917 .
	g«me
 = "timeout",

1918 .
	gdeÊt
 = 
NULL
,

1919 .
	gh™dÀr
 = 
tfw_cfg›_≠m_hm_timeout
,

1920 .
	gÆlow_n⁄e
 = 
Ál£
,

1921 .
	gÆlow_ª≥©
 = 
Ál£
,

1926 
TfwCfgS≥c
 
	gtfw_≠m_•ecs
[] = {

1928 .
«me
 = "apm_stats",

1929 .
	gdeÊt
 = "window=300 scale=5",

1930 .
	gh™dÀr
 = 
tfw_cfg›_≠m_°©s
,

1931 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_≠m
,

1932 .
	gÆlow_n⁄e
 = 
åue
,

1933 .
	gÆlow_ª≥©
 = 
Ál£
,

1936 .
	g«me
 = "server_failover_http",

1937 .
	gdeÊt
 = 
NULL
,

1938 .
	gh™dÀr
 = 
tfw_cfg›_≠m_£rvî_Áûovî
,

1939 .
	gÆlow_n⁄e
 = 
åue
,

1940 .
	gÆlow_ª≥©
 = 
åue
,

1941 .
	g˛ónup
 = 
tfw_cfg›_≠m_˛ónup_£rvî_Áûovî
,

1944 .
	g«me
 = "health_check",

1945 .
	gdeÊt
 = 
NULL
,

1946 .
	gh™dÀr
 = 
tfw_cfg_h™dÀ_chûdªn
,

1947 .
	gde°
 = 
tfw_≠m_hm_•ecs
,

1948 .
	g•ec_ext
 = &(
TfwCfgS≥cChûd
 ) {

1949 .
begö_hook
 = 
tfw_cfg›_begö_≠m_hm
,

1950 .
	gföish_hook
 = 
tfw_cfg›_föish_≠m_hm


1952 .
	gÆlow_n⁄e
 = 
åue
,

1953 .
	gÆlow_ª≥©
 = 
åue
,

1954 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_≠m_hm
,

1959 
TfwMod
 
	gtfw_≠m_mod
 = {

1960 .
«me
 = "apm",

1961 .
	gcfgíd
 = 
tfw_≠m_cfgíd
,

1962 .
	gcfg˛ón
 = 
tfw_≠m_cfg˛ón
,

1963 .
	g•ecs
 = 
tfw_≠m_•ecs
,

1967 
	$tfw_≠m_öô
()

1969 
	`tfw_mod_ªgi°î
(&
tfw_≠m_mod
);

1971 
	}
}

1974 
	$tfw_≠m_exô
()

1976 
	`tfw_mod_uƒegi°î
(&
tfw_≠m_mod
);

1977 
	}
}

	@apm.h

20 #i‚de‡
__TFW_APM_H__


21 
	#__TFW_APM_H__


	)

23 
	~"poﬁ.h
"

24 
	~"£rvî.h
"

25 
	~"°r.h
"

34 c⁄° *
	môh
;

35 *
	mvÆ
;

36 
	mpsz
;

37 
	m£q
;

38 } 
	tTfwPr˙éSèts
;

41 
	mTFW_PSTATS_IDX_MIN
 = 0,

42 
	mTFW_PSTATS_IDX_MAX
,

43 
	mTFW_PSTATS_IDX_AVG
,

44 
	mTFW_PSTATS_IDX_ITH
,

45 
	mTFW_PSTATS_IDX_P50
 = 
TFW_PSTATS_IDX_ITH
,

46 
	mTFW_PSTATS_IDX_P75
,

47 
	mTFW_PSTATS_IDX_P90
,

48 
	mTFW_PSTATS_IDX_P95
,

49 
	mTFW_PSTATS_IDX_P99
,

50 
	m_TFW_PSTATS_IDX_COUNT


53 c⁄° 
	gtfw_p°©s_ôh
[] = {

54 [
TFW_PSTATS_IDX_MIN
 ... 
TFW_PSTATS_IDX_AVG
] = 0,

55 [
TFW_PSTATS_IDX_P50
] = 50,

56 [
TFW_PSTATS_IDX_P75
] = 75,

57 [
TFW_PSTATS_IDX_P90
] = 90,

58 [
TFW_PSTATS_IDX_P95
] = 95,

59 [
TFW_PSTATS_IDX_P99
] = 99,

67 
	mcode
;

68 
	msum
;

69 } 
	tTfwHMCodeSèts
;

77 
	mπime
;

78 
	mc˙t
;

79 
TfwHMCodeSèts
 *
	mrsums
;

80 } 
	tTfwHMSèts
;

82 
tfw_≠m_add_§v
(
TfwSîvî
 *
§v
);

83 
tfw_≠m_dñ_§v
(
TfwSîvî
 *
§v
);

84 
tfw_≠m_upd©e
(*
≠mªf
, 
jt°amp
, 
jπime
);

85 
tfw_≠m_°©s
(*
≠mªf
, 
TfwPr˙éSèts
 *
p°©s
);

86 
tfw_≠m_°©s_bh
(*
≠mªf
, 
TfwPr˙éSèts
 *
p°©s
);

87 
tfw_≠m_p°©s_vîify
(
TfwPr˙éSèts
 *
p°©s
);

88 
tfw_≠m_hm_§v_rcou¡_upd©e
(
TfwSå
 *
uri_∑th
, *
≠mªf
);

89 
boﬁ
 
tfw_≠m_hm_§v_Æive
(
°©us
, 
TfwSå
 *
body
, *
≠mªf
);

90 
boﬁ
 
tfw_≠m_hm_§v_limô
(
°©us
, *
≠mªf
);

91 
tfw_≠m_hm_íabÀ_§v
(
TfwSîvî
 *
§v
, *
hmªf
);

92 
tfw_≠m_hm_dißbÀ_§v
(
TfwSîvî
 *
§v
);

93 
boﬁ
 
tfw_≠m_hm_§v_eq
(c⁄° *
«me
, 
TfwSîvî
 *
§v
);

94 
TfwHMSèts
 *
tfw_≠m_hm_°©s
(*
≠mªf
);

95 *
tfw_≠m_gë_hm
(c⁄° *
«me
);

96 
boﬁ
 
tfw_≠m_check_hm
(c⁄° *
«me
);

	@cache.c

23 
	~<löux/‰ìzî.h
>

24 
	~<löux/úq_w‹k.h
>

25 
	~<löux/ùv6.h
>

26 
	~<löux/kthªad.h
>

27 
	~<löux/t˝.h
>

28 
	~<löux/t›ﬁogy.h
>

30 
	~"tdb.h
"

32 
	~"lib/°r.h
"

33 
	~"ãm≥°a_fw.h
"

34 
	~"vho°.h
"

35 
	~"ˇche.h
"

36 
	~"hâp_msg.h
"

37 
	~"¥ocfs.h
"

38 
	~"sync_sockë.h
"

39 
	~"w‹k_queue.h
"

41 #i‡
MAX_NUMNODES
 > ((1 << 16) - 1)

45 c⁄° 
	gtfw_ˇche_•ec_hódîs_304
[] = {

46 [0 ... 
TFW_HTTP_HDR_RAW
] = 0,

47 [
TFW_HTTP_HDR_ETAG
] = 1,

49 c⁄° 
TfwSå
 
	gtfw_ˇche_øw_hódîs_304
[] = {

50 
	#TfwSå_°rög
(
v
Ë{ (v), 
NULL
, (vË- 1, 0 }

	)

51 
TfwSå_°rög
("cache-control:"),

52 
TfwSå_°rög
("content-location:"),

53 
TfwSå_°rög
("date:"),

54 
TfwSå_°rög
("expires:"),

55 
TfwSå_°rög
("last-modified:"),

56 
TfwSå_°rög
("vary:"),

58 #unde‡
TfwSå_°rög


60 
	#TFW_CACHE_304_SPEC_HDRS_NUM
 1

	)

61 
	#TFW_CACHE_304_HDRS_NUM
 \

62 
	`ARRAY_SIZE
(
tfw_ˇche_øw_hódîs_304
Ë+ 
TFW_CACHE_304_SPEC_HDRS_NUM


	)

66 
	#TFW_CE_MUST_REVAL
 0x0001

	)

94 
TdbVRec
 
	måec
;

95 
	#˚_body
 
key_Àn


	)

96 
	mkey_Àn
;

97 
	m°©us_Àn
;

98 
	mhdr_num
;

99 
	mhdr_Àn
;

100 
	mhdr_Àn_304
;

101 
	mmëhod
: 4;

102 
	mÊags
: 28;

103 
time_t
 
	mage
;

104 
time_t
 
	md©e
;

105 
time_t
 
	mªq_time
;

106 
time_t
 
	mª•_time
;

107 
time_t
 
	mli„time
;

108 
time_t
 
	mœ°_modifõd
;

109 
	mkey
;

110 
	m°©us
;

111 
	mhdrs
;

112 
	mbody
;

113 
	mhdrs_304
[
TFW_CACHE_304_HDRS_NUM
];

114 
	mvîsi⁄
;

115 
	mª•_°©us
;

116 
	mhmÊags
;

117 
TfwSå
 
	mëag
;

118 } 
	tTfwCacheE¡ry
;

120 
	#CE_BODY_SIZE
 \

121 ((
TfwCacheE¡ry
Ë- 
	`off£tof
(TfwCacheE¡ry, 
˚_body
))

	)

130 
	mÊags
 : 8,

131 
	mÀn
 : 56;

132 } 
	tTfwCSå
;

134 
	#TFW_CSTR_MAXLEN
 (1UL << 56)

	)

135 
	#TFW_CSTR_HDRLEN
 ((
TfwCSå
))

	)

139 
TfwHâpMsg
 *
	mmsg
;

140 
tfw_hâp_ˇche_cb_t
 
	ma˘i⁄
;

141 
	m__unu£d
[2];

142 } 
	tTfwCW‹k
;

145 
èskÀt_°ru˘
 
	mèskÀt
;

146 
úq_w‹k
 
	mùi_w‹k
;

147 
TfwRBQueue
 
	mwq
;

148 } 
	tTfwW‹kTaskÀt
;

151 
	mˇche
;

152 
	mmëhods
;

153 
	mdb_size
;

154 c⁄° *
	mdb_∑th
;

155 } 
ˇche_cfg
 
	g__ªad_mo°ly
;

159 
	mTFW_CACHE_NONE
 = 0,

160 
	mTFW_CACHE_SHARD
,

161 
	mTFW_CACHE_REPLICA
,

165 
	m˝u
[
NR_CPUS
];

166 
©omic_t
 
	m˝u_idx
;

167 
	mƒ_˝us
;

168 
TDB
 *
	mdb
;

169 } 
	tCaNode
;

171 
CaNode
 
	gc_nodes
[
MAX_NUMNODES
];

178 
èsk_°ru˘
 *
	gˇche_mgr_thr
;

180 
DEFINE_PER_CPU
(
TfwW‹kTaskÀt
, 
ˇche_wq
);

182 
TfwSå
 
	gg_¸lf
 = { .
±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) };

185 
	#TFW_CACHE_REQ_KEYITER
(
c
, 
ªq
, 
u_íd
, 
h_°¨t
, 
h_íd
) \

186 i‡(
	`TFW_STR_PLAIN
(&
ªq
->
uri_∑th
)) { \

187 
c
 = &
ªq
->
uri_∑th
; \

188 
u_íd
 = &
ªq
->
uri_∑th
 + 1; \

190 
c
 = 
ªq
->
uri_∑th
.
±r
; \

191 
u_íd
 = (
TfwSå
 *)
ªq
->
uri_∑th
.
±r
 \

192 + 
	`TFW_STR_CHUNKN
(&
ªq
->
uri_∑th
); \

194 i‡(
	`TFW_STR_PLAIN
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
])) { \

195 
h_°¨t
 = 
ªq
->
h_tbl
->
tbl
 + 
TFW_HTTP_HDR_HOST
; \

196 
h_íd
 = 
ªq
->
h_tbl
->
tbl
 + 
TFW_HTTP_HDR_HOST
 + 1; \

198 
h_°¨t
 = 
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
].
±r
; \

199 
h_íd
 = (
TfwSå
 *)
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
].
±r
 \

200 + 
	`TFW_STR_CHUNKN
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
]);\

202  ; 
c
 !
h_íd
; ++c, c = (¯=
u_íd
Ë? 
h_°¨t
 : c)

	)

212 
	gtfw_ˇche_nc_mëhods
 =

213 ~((1 << 
TFW_HTTP_METH_GET
Ë| (1 << 
TFW_HTTP_METH_HEAD
));

215 
ölöe
 
boﬁ


216 
	$__ˇche_mëhod_nc_ã°
(
tfw_hâp_mëh_t
 
mëhod
)

218 
	`BUILD_BUG_ON
((
tfw_ˇche_nc_mëhods
Ë* 
BITS_PER_BYTE


219 < 
_TFW_HTTP_METH_COUNT
);

221  
tfw_ˇche_nc_mëhods
 & (1 << 
mëhod
);

222 
	}
}

224 
ölöe
 

225 
	$__ˇche_mëhod_add
(
tfw_hâp_mëh_t
 
mëhod
)

227 
ˇche_cfg
.
mëhods
 |(1 << 
mëhod
);

228 
	}
}

230 
ölöe
 
boﬁ


231 
	$__ˇche_mëhod_ã°
(
tfw_hâp_mëh_t
 
mëhod
)

233  
ˇche_cfg
.
mëhods
 & (1 << 
mëhod
);

234 
	}
}

236 
boﬁ


237 
	$tfw_ˇche_msg_ˇchóbÀ
(
TfwHâpReq
 *
ªq
)

239  
ˇche_cfg
.
ˇche
 && 
	`__ˇche_mëhod_ã°
(
ªq
->
mëhod
);

240 
	}
}

250 
	$tfw_ˇche_key_node
(
key
)

252  
key
 % 
	`num_⁄löe_nodes
();

253 
	}
}

260 
	$tfw_öô_node_˝us
()

262 
˝u
, 
node
;

264 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

265 
node
 = 
	`˝u_to_node
(
˝u
);

266 
c_nodes
[
node
].
˝u
[c_nodes[node].
ƒ_˝us
++] = cpu;

268 
	}
}

270 
TDB
 *

271 
	$node_db
()

273  
c_nodes
[
	`numa_node_id
()].
db
;

274 
	}
}

286 
	$tfw_ˇche_sched_˝u
(
TfwHâpReq
 *
ªq
)

288 
CaNode
 *
node
 = &
c_nodes
[
ªq
->node];

289 
idx
 = 
	`©omic_öc_ªtu∫
(&
node
->
˝u_idx
);

291  
node
->
˝u
[
idx
 %Çode->
ƒ_˝us
];

292 
	}
}

298 
	$tfw_ˇche_pﬁicy
(
TfwVho°
 *
vho°
, 
TfwLoˇti⁄
 *
loc
, 
TfwSå
 *
¨g
)

300 
TfwCaPﬁicy
 *
ˇpo
;

303 i‡(
loc
 &&Üoc->
ˇpo_sz
) {

304 i‡((
ˇpo
 = 
	`tfw_ˇpﬁicy_m©ch
(
loc
, 
¨g
)))

305  
ˇpo
->
cmd
;

312 
loc
 = 
vho°
->
loc_dÊt
;

313 i‡(
loc
 &&Üoc->
ˇpo_sz
) {

314 i‡((
ˇpo
 = 
	`tfw_ˇpﬁicy_m©ch
(
loc
, 
¨g
)))

315  
ˇpo
->
cmd
;

317 
TfwVho°
 *
vho°_dÊt
 = 
vho°
->vhost_dflt;

318 i‡(!
vho°_dÊt
)

319  
TFW_D_CACHE_BYPASS
;

321 
loc
 = 
vho°_dÊt
->
loc_dÊt
;

322 i‡(
loc
 &&Üoc->
ˇpo_sz
) {

323 i‡((
ˇpo
 = 
	`tfw_ˇpﬁicy_m©ch
(
loc
, 
¨g
)))

324  
ˇpo
->
cmd
;

328  
TFW_D_CACHE_BYPASS
;

329 
	}
}

339 
boﬁ


340 
	$tfw_ˇche_em∂oy_ªq
(
TfwHâpReq
 *
ªq
)

342 
cmd
 = 
	`tfw_ˇche_pﬁicy
(
ªq
->
vho°
,Ñeq->
loˇti⁄
, &ªq->
uri_∑th
);

344 i‡(
cmd
 =
TFW_D_CACHE_BYPASS
) {

345 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_CFG_CACHE_BYPASS
;

346  
Ál£
;

349 
	`BUG_ON
(
cmd
 !
TFW_D_CACHE_FULFILL
);

351 i‡(
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_NO_CACHE
)

361  
Ál£
;

363  
åue
;

364 
	}
}

370 
ölöe
 
boﬁ


371 
	$tfw_ˇche_°©us_bydef
(
TfwHâpRe•
 *
ª•
)

378 
ª•
->
°©us
) {

383  
åue
;

385  
Ál£
;

386 
	}
}

388 
boﬁ


389 
	$tfw_ˇche_em∂oy_ª•
(
TfwHâpRe•
 *
ª•
)

391 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

393 
	#CC_REQ_DONTCACHE
 \

394 (
TFW_HTTP_CC_CFG_CACHE_BYPASS
 | 
TFW_HTTP_CC_NO_STORE
)

	)

395 
	#CC_RESP_DONTCACHE
 \

396 (
TFW_HTTP_CC_NO_STORE
 | 
TFW_HTTP_CC_PRIVATE
 \

397 | 
TFW_HTTP_CC_NO_CACHE
)

	)

398 
	#CC_RESP_CACHEIT
 \

399 (
TFW_HTTP_CC_HDR_EXPIRES
 | 
TFW_HTTP_CC_MAX_AGE
 \

400 | 
TFW_HTTP_CC_S_MAXAGE
 | 
TFW_HTTP_CC_PUBLIC
)

	)

401 
	#CC_RESP_AUTHCAN
 \

402 (
TFW_HTTP_CC_S_MAXAGE
 | 
TFW_HTTP_CC_PUBLIC
 \

403 | 
TFW_HTTP_CC_MUST_REVAL
 | 
TFW_HTTP_CC_PROXY_REVAL
)

	)

408 i‡(
ªq
->
ˇche_˘l
.
Êags
 & 
CC_REQ_DONTCACHE
)

409  
Ál£
;

410 i‡(
ª•
->
ˇche_˘l
.
Êags
 & 
CC_RESP_DONTCACHE
)

411  
Ál£
;

412 i‡(!(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_IS_PRESENT
)

413 && (
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_PRAGMA_NO_CACHE
))

414  
Ál£
;

415 i‡((
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_HDR_AUTHORIZATION
)

416 && !(
ªq
->
ˇche_˘l
.
Êags
 & 
CC_RESP_AUTHCAN
))

417  
Ál£
;

418 i‡(!(
ª•
->
ˇche_˘l
.
Êags
 & 
CC_RESP_CACHEIT
)

419 && !
	`tfw_ˇche_°©us_bydef
(
ª•
))

420  
Ál£
;

421 #unde‡
CC_RESP_AUTHCAN


422 #unde‡
CC_RESP_CACHEIT


423 #unde‡
CC_RESP_DONTCACHE


424 #unde‡
CC_REQ_DONTCACHE


426  
åue
;

427 
	}
}

432 
time_t


433 
	$tfw_ˇche_ˇlc_li„time
(
TfwHâpRe•
 *
ª•
)

435 
li„time
;

437 i‡(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_S_MAXAGE
)

438 
li„time
 = 
ª•
->
ˇche_˘l
.
s_maxage
;

439 i‡(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MAX_AGE
)

440 
li„time
 = 
ª•
->
ˇche_˘l
.
max_age
;

441 i‡(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_HDR_EXPIRES
)

442 
li„time
 = 
ª•
->
ˇche_˘l
.
expúes
 -Ñe•->
d©e
;

445 
li„time
 = 
UINT_MAX
;

447  
li„time
;

448 
	}
}

453 
time_t


454 
	$tfw_ˇche_íåy_age
(
TfwCacheE¡ry
 *
˚
)

456 
time_t
 
≠∑ª¡_age
 = 
	`max_t
—ime_t, 0, 
˚
->
ª•_time
 - ce->
d©e
);

457 
time_t
 
c‹ª˘ed_age
 = 
˚
->
age
 + ce->
ª•_time
 - ce->
ªq_time
;

458 
time_t
 
öôül_age
 = 
	`max
(
≠∑ª¡_age
, 
c‹ª˘ed_age
);

459  (
öôül_age
 + 
	`tfw_cuºít_time°amp
(Ë- 
˚
->
ª•_time
);

460 
	}
}

477 
time_t


478 
	$tfw_ˇche_íåy_is_live
(
TfwHâpReq
 *
ªq
, 
TfwCacheE¡ry
 *
˚
)

480 
time_t
 
˚_age
 = 
	`tfw_ˇche_íåy_age
(
˚
);

481 
time_t
 
˚_li„time
, 
…_‰esh
 = 
UINT_MAX
;

483 i‡(
˚
->
li„time
 <= 0)

486 
	#CC_LIFETIME_FRESH
 (
TFW_HTTP_CC_MAX_AGE
 | 
TFW_HTTP_CC_MIN_FRESH
)

	)

487 i‡(
ªq
->
ˇche_˘l
.
Êags
 & 
CC_LIFETIME_FRESH
) {

488 
time_t
 
…_max_age
 = 
UINT_MAX
, 
…_mö_‰esh
 = UINT_MAX;

489 i‡(
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MAX_AGE
)

490 
…_max_age
 = 
ªq
->
ˇche_˘l
.
max_age
;

491 i‡(
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MIN_FRESH
)

492 
…_mö_‰esh
 = 
˚
->
li„time
 - 
ªq
->
ˇche_˘l
.
mö_‰esh
;

493 
…_‰esh
 = 
	`mö
(
…_max_age
, 
…_mö_‰esh
);

495 i‡(!(
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MAX_STALE
)) {

496 
˚_li„time
 = 
	`mö
(
…_‰esh
, 
˚
->
li„time
);

498 
time_t
 
…_max_°Æe
 = 
˚
->
li„time
 + 
ªq
->
ˇche_˘l
.
max_°Æe
;

499 
˚_li„time
 = 
	`mö
(
…_‰esh
, 
…_max_°Æe
);

501 #unde‡
CC_LIFETIME_FRESH


503  
˚_li„time
 > 
˚_age
 ? ce_lifetime : 0;

504 
	}
}

506 
boﬁ


507 
	$tfw_ˇche_c⁄d_n⁄e_m©ch
(
TfwHâpReq
 *
ªq
, 
TfwCacheE¡ry
 *
˚
)

509 
TfwSå
 
m©ch_li°
, 
ôî
;

511 i‡(
	`TFW_STR_EMPTY
(&
˚
->
ëag
))

512  
åue
;

514 i‡(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_ETAG_ANY
)

515  
Ál£
;

517 
m©ch_li°
 = 
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_IF_NONE_MATCH
];

518 
ôî
 = 
	`tfw_°r_√xt_°r_vÆ
(&
m©ch_li°
);

520 !
	`TFW_STR_EMPTY
(&
ôî
)) {

522 i‡(!
	`tfw_°rcmp•n
(&
ôî
, &
˚
->
ëag
, '"'))

523  
Ál£
;

525 
ôî
 = 
	`tfw_°r_√xt_°r_vÆ
(&iter);

528  
åue
;

529 
	}
}

536 
	$tfw_ˇche_wrôe_fõld
(
TDB
 *
db
, 
TdbVRec
 **
åec
, 
TfwHâpRe•
 *
ª•
,

537 
TfwMsgIãr
 *
ô
, **
d©a
, 
size_t
 
Àn
, 
TfwSå
 *
hdr
)

539 
r
, 
c›õd
 = 0;

540 
TdbVRec
 *
å
 = *
åec
;

541 
TfwSå
 
c
 = { 0 };

544 
c
.
±r
 = *
d©a
;

545 
c
.
Àn
 = 
	`mö
(
å
->
d©a
 +År->len - *data,

546 ()(
Àn
 - 
c›õd
));

547 
r
 = 
hdr


548 ? 
	`tfw_hâp_msg_add_d©a
(
ô
, (
TfwHâpMsg
 *)
ª•
, 
hdr
, &
c
)

549 : 
	`tfw_msg_wrôe
(
ô
, &
c
);

550 i‡(
r
)

551  
r
;

553 
c›õd
 +
c
.
Àn
;

554 *
d©a
 +
c
.
Àn
;

555 i‡(
c›õd
 =
Àn
)

558 
å
 = *
åec
 = 
	`tdb_√xt_ªc_chunk
(
db
,År);

559 
	`BUG_ON
(!
å
);

560 *
d©a
 = 
å
->data;

565 i‡(
hdr
 && hdr->
Àn
)

566 
	`tfw_°r_fixup_eﬁ
(
hdr
, 
	`SLEN
(
S_CRLF
));

569 
	}
}

576 
	$tfw_ˇche_buûd_ª•_hdr
(
TDB
 *
db
, 
TfwHâpRe•
 *
ª•
, 
TfwSå
 *
hdr
,

577 
TdbVRec
 **
åec
, 
TfwMsgIãr
 *
ô
, **
p
)

579 
r
, 
d
, 
dn
;

580 
TfwSå
 *
dups
;

581 
TfwCSå
 *
s
 = (TfwCSå *)*
p
;

583 *
p
 +
TFW_CSTR_HDRLEN
;

584 
	`BUG_ON
(*
p
 > (*
åec
)->
d©a
 + (*åec)->
Àn
);

586 i‡(
	`likñy
(!(
s
->
Êags
 & 
TFW_STR_DUPLICATE
)))

587  
	`tfw_ˇche_wrôe_fõld
(
db
, 
åec
, 
ª•
, 
ô
, 
p
, 
s
->
Àn
,

588 
hdr
);

591 
dn
 = 
s
->
Àn
;

592 
dups
 = 
	`tfw_poﬁ_Æloc
(
ª•
->
poﬁ
, 
dn
 * (
TfwSå
));

593 i‡(!
dups
)

594  -
ENOMEM
;

596 
d
 = 0; d < 
dn
; ++d) {

597 
s
 = (
TfwCSå
 *)*
p
;

598 
	`BUG_ON
(
s
->
Êags
);

599 
	`TFW_STR_INIT
(&
dups
[
d
]);

600 *
p
 +
TFW_CSTR_HDRLEN
;

601 i‡((
r
 = 
	`tfw_ˇche_wrôe_fõld
(
db
, 
åec
, 
ª•
, 
ô
, 
p
, 
s
->
Àn
,

602 &
dups
[
d
])))

603  
r
;

606 i‡(
hdr
) {

607 
hdr
->
±r
 = 
dups
;

608 
	`__TFW_STR_CHUNKN_SET
(
hdr
, 
dn
);

609 
hdr
->
Êags
 |
TFW_STR_DUPLICATE
;

613 
	}
}

625 
	$tfw_ˇche_£nd_304
(
TfwHâpReq
 *
ªq
, 
TfwCacheE¡ry
 *
˚
)

627 
TfwHâpRe•
 *
ª•
;

628 
TfwMsgIãr
 
ô
;

629 
i
;

630 *
p
;

631 
TdbVRec
 *
åec
 = &
˚
->trec;

632 
TDB
 *
db
 = 
	`node_db
();

634 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
fwd_li°
));

635 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
nù_li°
));

637 i‡(!(
ª•
 = 
	`tfw_hâp_msg_Æloc_ª•_light
(
ªq
)))

638 
îr_¸óã
;

640 i‡(
	`tfw_hâp_¥ï_304
((
TfwHâpMsg
 *)
ª•
, 
ªq
, &
ô
,

641 
˚
->
hdr_Àn_304
))

642 
îr_£tup
;

645 
i
 = 0; i < 
	`ARRAY_SIZE
(
˚
->
hdrs_304
); ++i) {

646 i‡(!
˚
->
hdrs_304
[
i
])

649 
p
 = 
	`TDB_PTR
(
db
->
hdr
, 
˚
->
hdrs_304
[
i
]);

650 
åec
 && (
p
 >Åªc->
d©a
 +Åªc->
Àn
))

651 
åec
 = 
	`tdb_√xt_ªc_chunk
(
db
,Årec);

652 
	`BUG_ON
(!
åec
);

654 i‡(
	`tfw_ˇche_buûd_ª•_hdr
(
db
, 
ª•
, 
NULL
, &
åec
, &
ô
, &
p
))

655 
îr_£tup
;

658 i‡(
	`tfw_msg_wrôe
(&
ô
, &
g_¸lf
))

659 
îr_£tup
;

661 
	`tfw_hâp_ª•_fwd
(
ª•
);

664 
îr_£tup
:

665 
	`TFW_WARN
("C™'àbuûd 304Ñe•⁄£, key=%lx\n", 
˚
->
key
);

666 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

667 
îr_¸óã
:

668 
	`tfw_hâp_ª•_buûd_îr‹
(
ªq
);

669 
	}
}

679 
boﬁ


680 
	$tfw_h™dÀ_vÆid©i⁄_ªq
(
TfwHâpReq
 *
ªq
, 
TfwCacheE¡ry
 *
˚
)

682 i‡((
˚
->
ª•_°©us
 != 200) && (ce->resp_status != 206))

683  
åue
;

686 i‡((
ªq
->
mëhod
 =
TFW_HTTP_METH_OPTIONS
)

687 || (
ªq
->
mëhod
 =
TFW_HTTP_METH_TRACE
))

688  
åue
;

691 i‡(!
	`TFW_STR_EMPTY
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_IF_NONE_MATCH
])) {

692 i‡(!
	`tfw_ˇche_c⁄d_n⁄e_m©ch
(
ªq
, 
˚
)) {

693 i‡((
ªq
->
mëhod
 =
TFW_HTTP_METH_GET
)

694 || (
ªq
->
mëhod
 =
TFW_HTTP_METH_HEAD
))

695 
	`tfw_ˇche_£nd_304
(
ªq
, 
˚
);

697 
	`tfw_hâp_£nd_ª•
(
ªq
, 412,

701  
Ál£
;

705 i‡(
ªq
->
c⁄d
.
m_d©e


706 && ((
ªq
->
mëhod
 =
TFW_HTTP_METH_GET
)

707 || (
ªq
->
mëhod
 =
TFW_HTTP_METH_HEAD
)))

709 
boﬁ
 
£nd_304
 = 
Ál£
;

711 i‡(
˚
->
œ°_modifõd
) {

712 i‡(
˚
->
œ°_modifõd
 <
ªq
->
c⁄d
.
m_d©e
)

713 
£nd_304
 = 
åue
;

715 i‡(
˚
->
d©e
) {

716 i‡(
˚
->
d©e
 <
ªq
->
c⁄d
.
m_d©e
)

717 
£nd_304
 = 
åue
;

720 i‡(
˚
->
ª•_time
 <
ªq
->
c⁄d
.
m_d©e
)

721 
£nd_304
 = 
åue
;

724 i‡(
£nd_304
) {

725 
	`tfw_ˇche_£nd_304
(
ªq
, 
˚
);

726  
Ál£
;

731  
åue
;

732 
	}
}

734 
boﬁ


735 
	$tfw_ˇche_íåy_key_eq
(
TDB
 *
db
, 
TfwHâpReq
 *
ªq
, 
TfwCacheE¡ry
 *
˚
)

738 
n
, 
c_off
 = 0, 
t_off
;

739 
TdbVRec
 *
åec
 = &
˚
->trec;

740 
TfwSå
 *
c
, *
h_°¨t
, *
u_íd
, *
h_íd
;

742 i‡((
ªq
->
mëhod
 !
TFW_HTTP_METH_PURGE
Ë&& (
˚
->method !=Ñeq->method))

743  
Ál£
;

744 i‡(
ªq
->
uri_∑th
.
Àn


745 + 
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
].
Àn
 !
˚
->
key_Àn
)

746  
Ál£
;

748 
t_off
 = 
CE_BODY_SIZE
;

749 
	`TFW_CACHE_REQ_KEYITER
(
c
, 
ªq
, 
u_íd
, 
h_°¨t
, 
h_íd
) {

750 i‡(!
åec
)

751  
Ál£
;

752 
this_chunk
:

753 
n
 = 
	`mö
(
c
->
Àn
 - 
c_off
, ()
åec
->À¿- 
t_off
);

755 i‡(
	`tfw_c°ricmp_2lc
((*)
c
->
±r
 + 
c_off
,

756 
åec
->
d©a
 + 
t_off
, 
n
))

757  
Ál£
;

758 
c_off
 = (
n
 =
c
->
Àn
 - c_off) ? 0 : c_off +Ç;

759 i‡(
n
 =
åec
->
Àn
 - 
t_off
) {

760 
t_off
 = 0;

761 
åec
 = 
	`tdb_√xt_ªc_chunk
(
db
,Årec);

762 i‡(
åec
 && 
c_off
)

763 
this_chunk
;

765 
t_off
 +
n
;

769  
åue
;

770 
	}
}

772 
TfwCacheE¡ry
 *

773 
	$tfw_ˇche_db˚_gë
(
TDB
 *
db
, 
TdbIãr
 *
ôî
, 
TfwHâpReq
 *
ªq
)

775 
TfwCacheE¡ry
 *
˚
;

776 
key
 = 
	`tfw_hâp_ªq_key_ˇlc
(
ªq
);

778 *
ôî
 = 
	`tdb_ªc_gë
(
db
, 
key
);

779 i‡(
	`TDB_ITER_BAD
(*
ôî
)) {

780 
	`TFW_INC_STAT_BH
(
ˇche
.
mis£s
);

781  
NULL
;

802 
˚
 = (
TfwCacheE¡ry
 *)
ôî
->
ªc
;

810 i‡(
	`tfw_ˇche_íåy_key_eq
(
db
, 
ªq
, 
˚
))

812 
	`tdb_ªc_√xt
(
db
, 
ôî
);

813 i‡(!(
˚
 = (
TfwCacheE¡ry
 *)
ôî
->
ªc
)) {

814 
	`TFW_INC_STAT_BH
(
ˇche
.
mis£s
);

815  
NULL
;

817 } 
åue
);

819  
˚
;

820 
	}
}

822 
ölöe
 

823 
	$tfw_ˇche_db˚_put
(
TfwCacheE¡ry
 *
˚
)

825 i‡(
˚
)

826 
	`tdb_ªc_put
(
˚
);

827 
	}
}

830 
	$tfw_ˇche_°r_wrôe_hdr
(c⁄° 
TfwSå
 *
°r
, *
p
)

832 
TfwCSå
 *
s
 = (TfwCSå *)
p
;

834 i‡(
	`TFW_STR_DUP
(
°r
)) {

835 
s
->
Êags
 = 
TFW_STR_DUPLICATE
;

836 
s
->
Àn
 = 
	`TFW_STR_CHUNKN
(
°r
);

838 
s
->
Êags
 = 0;

839 
s
->
Àn
 = 
°r
->À¿? så->À¿+ 
	`SLEN
(
S_CRLF
) : 0;

841 
	}
}

852 
__tfw_ˇche_°r˝y
(**
p
, 
TdbVRec
 **
åec
, 
TfwSå
 *
§c
, 
size_t
 
tŸ_Àn
,

853 
	$˝y
(*
de°
, c⁄° *
§c
, 
size_t
 
n
))

855 
c›õd
 = 0;

857 
c›õd
 < 
§c
->
Àn
) {

858 
room
 = (*
åec
)->
d©a
 + (*åec)->
Àn
 - *
p
;

859 
	`BUG_ON
(
room
 < 0);

860 i‡(!
room
) {

861 
	`BUG_ON
(
tŸ_Àn
 < 
c›õd
);

862 *
åec
 = 
	`tdb_íåy_add
(
	`node_db
(), *trec,

863 
tŸ_Àn
 - 
c›õd
);

864 i‡(!*
åec
)

865  -
ENOMEM
;

866 *
p
 = (*
åec
)->
d©a
;

867 
room
 = (*
åec
)->
Àn
;

870 
	`TFW_DBG3
("Cache: copy [%.*s](%lu)ÅoÑec=%p(len=%u,Çext=%u),"

872 
	`PR_TFW_STR
(
§c
), src->
Àn
, *
åec
, (*trec)->len,

873 (*
åec
)->
chunk_√xt
, *
p
, 
tŸ_Àn
, 
room
, 
c›õd
);

875 
room
 = 
	`mö
((Ïoom, 
§c
->
Àn
 - 
c›õd
);

876 
	`˝y
(*
p
, (*)
§c
->
±r
 + 
c›õd
, 
room
);

877 *
p
 +
room
;

878 
c›õd
 +
room
;

881  
c›õd
;

882 
	}
}

888 
	$__tfw_mem˝y
(*
d°
 ,c⁄° *
§c
, 
size_t
 
n
)

890 
	`mem˝y_Á°
(
d°
, 
§c
, 
n
);

891 
	}
}

893 
ölöe
 

894 
	$tfw_ˇche_°r˝y
(**
p
, 
TdbVRec
 **
åec
, 
TfwSå
 *
§c
, 
size_t
 
tŸ_Àn
)

896  
	`__tfw_ˇche_°r˝y
(
p
, 
åec
, 
§c
, 
tŸ_Àn
, 
__tfw_mem˝y
);

897 
	}
}

902 
ölöe
 

903 
	$tfw_ˇche_°r˝y_lc
(**
p
, 
TdbVRec
 **
åec
, 
TfwSå
 *
§c
, 
size_t
 
tŸ_Àn
)

905  
	`__tfw_ˇche_°r˝y
(
p
, 
åec
, 
§c
, 
tŸ_Àn
, 
tfw_c°πﬁowî
);

906 
	}
}

916 
	$tfw_ˇche_°r˝y_eﬁ
(**
p
, 
TdbVRec
 **
åec
,

917 
TfwSå
 *
§c
, 
size_t
 *
tŸ_Àn
, 
boﬁ
 
eﬁ
)

919 
n
, 
c›õd
 = 0;

920 
TfwSå
 *
c
, *
íd
;

922 
	`BUG_ON
(
	`TFW_STR_DUP
(
§c
));

924 i‡(
	`u∆ikñy
(!
§c
->
Àn
))

927 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
§c
, 
íd
) {

928 i‡((
n
 = 
	`tfw_ˇche_°r˝y
(
p
, 
åec
, 
c
, *
tŸ_Àn
)) < 0) {

929 
	`TFW_ERR
("Cache: cannot copy chunk of string\n");

930  -
ENOMEM
;

932 *
tŸ_Àn
 -
n
;

933 
c›õd
 +
n
;

936 i‡(
eﬁ
) {

937 i‡((
n
 = 
	`tfw_ˇche_°r˝y
(
p
, 
åec
, &
g_¸lf
, *
tŸ_Àn
)) < 0)

938  -
ENOMEM
;

939 
	`BUG_ON
(
n
 !
	`SLEN
(
S_CRLF
));

940 *
tŸ_Àn
 -
n
;

941 
c›õd
 +
n
;

944  
c›õd
;

945 
	}
}

953 
	$tfw_ˇche_c›y_hdr
(**
p
, 
TdbVRec
 **
åec
, 
TfwSå
 *
§c
, 
size_t
 *
tŸ_Àn
)

955 
n
 = (
TfwCSå
), 
c›õd
;

956 
TfwSå
 *
dup
, *
dup_íd
;

958 i‡(
	`u∆ikñy
(
§c
->
Àn
 >
TFW_CSTR_MAXLEN
)) {

959 
	`TFW_WARN
("Cache:ÅryingÅo storeÅoo big string %lx\n",

960 
§c
->
Àn
);

961  -
E2BIG
;

964 i‡(
	`likñy
(!
	`TFW_STR_DUP
(
§c
))

965 && (
TfwCSå
Ë+ 
§c
->
Àn
 <
L1_CACHE_BYTES
)

966 
n
 +
§c
->
Àn
;

968 
	#CSTR_WRITE_HDR
(
°r
) \

969 
	`tfw_ˇche_°r_wrôe_hdr
(
°r
, *
p
); \

970 *
p
 +
TFW_CSTR_HDRLEN
; \

971 *
tŸ_Àn
 -
TFW_CSTR_HDRLEN
; \

972 
c›õd
 = 
TFW_CSTR_HDRLEN
;

	)

974 *
p
 = 
	`tdb_íåy_gë_room
(
	`node_db
(), 
åec
, *p, 
n
, *
tŸ_Àn
);

975 i‡(!*
p
) {

976 
	`TFW_WARN
("Cache: cannotállocate TDB space\n");

977  -
ENOMEM
;

980 
	`CSTR_WRITE_HDR
(
§c
);

982 i‡(!
	`TFW_STR_DUP
(
§c
)) {

983 i‡((
n
 = 
	`tfw_ˇche_°r˝y_eﬁ
(
p
, 
åec
, 
§c
, 
tŸ_Àn
, 1)) < 0)

984  
n
;

985  
c›õd
 + 
n
;

988 
	`TFW_STR_FOR_EACH_DUP
(
dup
, 
§c
, 
dup_íd
) {

989 
	`CSTR_WRITE_HDR
(
dup
);

990 i‡((
n
 = 
	`tfw_ˇche_°r˝y_eﬁ
(
p
, 
åec
, 
dup
, 
tŸ_Àn
, 1)) < 0)

991  
n
;

992 
c›õd
 +
n
;

995  
c›õd
;

996 
	}
}

1009 
	$__£t_ëag
(
TfwCacheE¡ry
 *
˚
, 
TfwHâpRe•
 *
ª•
, 
h_off
, 
TdbVRec
 *
h_åec
,

1010 *
cuº_p
, 
TdbVRec
 **
cuº_åec
)

1012 *
e_p
;

1013 
size_t
 
Àn
 = 0;

1014 
TfwSå
 
ëag_vÆ
, *
c
, *
íd
, *
h
 = &
ª•
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_ETAG
];

1015 
TDB
 *
db
 = 
	`node_db
();

1017 i‡(
	`TFW_STR_EMPTY
(
h
))

1019 
ëag_vÆ
 = 
	`tfw_°r_√xt_°r_vÆ
(
h
);

1023 
e_p
 = 
	`TDB_PTR
(
db
->
hdr
, 
h_off
);

1024 i‡(
e_p
 + 
TFW_CSTR_HDRLEN
 > 
h_åec
->
d©a
 + h_åec->
Àn
) {

1025 
h_åec
 = 
	`tdb_√xt_ªc_chunk
(
db
, h_trec);

1026 
e_p
 = 
h_åec
->
d©a
;

1029 
e_p
 +
TFW_CSTR_HDRLEN
;

1030 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
h
, 
íd
) {

1031 
size_t
 
c_size
 = 
c
->
Àn
;

1033 i‡(
c
->
Êags
 & 
TFW_STR_VALUE
)

1035 
c_size
) {

1036 
size_t
 
èû
 = 
h_åec
->
Àn
 - (
e_p
 - h_åec->
d©a
);

1037 i‡(
c_size
 > 
èû
) {

1038 
c_size
 -
èû
;

1039 
h_åec
 = 
	`tdb_√xt_ªc_chunk
(
db
, h_trec);

1040 
e_p
 = 
h_åec
->
d©a
;

1043 
e_p
 +
c_size
;

1044 
c_size
 = 0;

1048  ; (
c
 < 
íd
Ë&& (c->
Êags
 & 
TFW_STR_VALUE
); ++c)

1049 
Àn
 +
c
->len;

1052 
˚
->
ëag
.
±r
 = 
e_p
;

1053 
˚
->
ëag
.
Êags
 = 
	`TFW_STR_CHUNK
(&
ëag_vÆ
, 0)->flags;

1054 
˚
->
ëag
.
Àn
 = 
	`mö
÷í, (
size_t
)(
h_åec
->len -

1055 (
e_p
 - 
h_åec
->
d©a
)));

1056 
Àn
 -
˚
->
ëag
.len;

1058 
Àn
) {

1059 
h_åec
 = 
	`tdb_√xt_ªc_chunk
(
db
, h_trec);

1060 
e_p
 = 
h_åec
->
d©a
;

1061 
c
 = 
	`tfw_°r_add_compound
(
ª•
->
poﬁ
, &
˚
->
ëag
);

1062 i‡(!
c
)

1063  -
ENOMEM
;

1064 
c
->
±r
 = 
e_p
;

1065 
c
->
Àn
 = 
	`mö
÷í, (
size_t
)(
h_åec
->len -

1066 (
e_p
 - 
h_åec
->
d©a
)));

1067 
Àn
 -
c
->len;

1071 i‡(!
	`TFW_STR_PLAIN
(&
˚
->
ëag
)) {

1072 
Àn
 = (
TfwSå
 *Ë* 
	`TFW_STR_CHUNKN
(&
˚
->
ëag
);

1073 
cuº_p
 = 
	`tdb_íåy_gë_room
(
	`node_db
(), 
cuº_åec
, cuº_p, 
Àn
,

1074 
Àn
);

1075 i‡(!
cuº_p
)

1076  -
ENOMEM
;

1077 
	`mem˝y_Á°
(
cuº_p
, 
˚
->
ëag
.
±r
, 
Àn
);

1078 
˚
->
ëag
.
±r
 = 
cuº_p
;

1083 
	}
}

1090 
boﬁ


1091 
	$__ßve_hdr_304_off
(
TfwCacheE¡ry
 *
˚
, 
TfwHâpRe•
 *
ª•
, 
TfwSå
 *
hdr
, 
off
)

1093 
i
;

1094 
num
;

1095 c⁄° 
TfwSå
 *
m©ch
;

1097 i‡(
	`TFW_STR_EMPTY
(
hdr
))

1098  
Ál£
;

1100 
num
 = 
hdr
 - 
ª•
->
h_tbl
->
tbl
;

1101 i‡(
num
 < 
TFW_HTTP_HDR_RAW
) {

1102 i‡(!
tfw_ˇche_•ec_hódîs_304
[
num
])

1103  
Ál£
;

1105 
i
 = 0; 
˚
->
hdrs_304
[i]; ++i)

1107 
˚
->
hdrs_304
[
i
] = 
off
;

1108  
åue
;

1111 
m©ch
 = 
	`tfw_hâp_msg_föd_hdr
(
hdr
, 
tfw_ˇche_øw_hódîs_304
);

1112 i‡(
m©ch
) {

1113 
sc
 = *(*)
m©ch
->
±r
;

1116 i‡((
sc
 == 'l')

1117 && !
	`TFW_STR_EMPTY
(&
ª•
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_ETAG
]))

1118  
Ál£
;

1120 
i
 = 
m©ch
 - 
tfw_ˇche_øw_hódîs_304
;

1121 
˚
->
hdrs_304
[
i
 + 
TFW_CACHE_304_SPEC_HDRS_NUM
] = 
off
;

1122  
åue
;

1125  
Ál£
;

1126 
	}
}

1140 
	$tfw_ˇche_c›y_ª•
(
TfwCacheE¡ry
 *
˚
, 
TfwHâpRe•
 *
ª•
, 
size_t
 
tŸ_Àn
)

1142 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

1143 
n
, 
ëag_off
 = 0;

1144 *
p
;

1145 
TdbVRec
 *
åec
 = &
˚
->åec, *
ëag_åec
 = 
NULL
;

1146 
TDB
 *
db
 = 
	`node_db
();

1147 
TfwSå
 *
fõld
, *
h
, *
íd1
, *
íd2
, 
em±y
 = {};

1148 
r
, 
i
;

1150 
p
 = (*)(
˚
 + 1);

1151 
tŸ_Àn
 -
CE_BODY_SIZE
;

1154 
˚
->
key
 = 
	`TDB_OFF
(
db
->
hdr
, 
p
);

1155 
˚
->
key_Àn
 = 0;

1156 
	`TFW_CACHE_REQ_KEYITER
(
fõld
, 
ªq
, 
íd1
, 
h
, 
íd2
) {

1157 i‡((
n
 = 
	`tfw_ˇche_°r˝y_lc
(&
p
, &
åec
, 
fõld
, 
tŸ_Àn
)) < 0) {

1158 
	`TFW_ERR
("Cache: cannot copyÑequest key\n");

1159  -
ENOMEM
;

1161 
	`BUG_ON
(
n
 > 
tŸ_Àn
);

1162 
tŸ_Àn
 -
n
;

1163 
˚
->
key_Àn
 +
n
;

1166 
˚
->
mëhod
 = 
ªq
->method;

1168 
˚
->
°©us
 = 
	`TDB_OFF
(
db
->
hdr
, 
p
);

1169 i‡((
n
 = 
	`tfw_ˇche_°r˝y_eﬁ
(&
p
, &
åec
, &
ª•
->
s_löe
, &
tŸ_Àn
, 1)) < 0) {

1170 
	`TFW_ERR
("Cache: cannot copy HTTP statusÜine\n");

1171  -
ENOMEM
;

1173 
˚
->
°©us_Àn
 +
n
;

1175 
˚
->
hdrs
 = 
	`TDB_OFF
(
db
->
hdr
, 
p
);

1176 
˚
->
hdr_Àn
 = 0;

1177 
˚
->
hdr_num
 = 
ª•
->
h_tbl
->
off
;

1178 
	`FOR_EACH_HDR_FIELD
(
fõld
, 
íd1
, 
ª•
) {

1179 
boﬁ
 
hdr_304
 = 
Ál£
;

1182 i‡(!(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
)) {

1183 
h
 = 
fõld
;

1184 } i‡(
fõld
 - 
ª•
->
h_tbl
->
tbl
 < 
TFW_HTTP_HDR_RAW
) {

1185 
h
 = &
em±y
;

1187 --
˚
->
hdr_num
;

1190 i‡(
fõld
 - 
ª•
->
h_tbl
->
tbl
 =
TFW_HTTP_HDR_ETAG
) {

1192 
ëag_off
 = 
	`TDB_OFF
(
db
->
hdr
, 
p
);

1193 
ëag_åec
 = 
åec
;

1195 
hdr_304
 = 
	`__ßve_hdr_304_off
(
˚
, 
ª•
, 
fõld
,

1196 
	`TDB_OFF
(
db
->
hdr
, 
p
));

1198 
n
 = 
	`tfw_ˇche_c›y_hdr
(&
p
, &
åec
, 
h
, &
tŸ_Àn
);

1199 i‡(
n
 < 0) {

1200 
	`TFW_ERR
("Cache: cannot copy HTTP header\n");

1201  -
ENOMEM
;

1202 } i‡(
hdr_304
) {

1203 
˚
->
hdr_Àn_304
 +
n
;

1205 
˚
->
hdr_Àn
 +
n
;

1209 
˚
->
body
 = 
	`TDB_OFF
(
db
->
hdr
, 
p
);

1210 
n
 = 
	`tfw_ˇche_°r˝y_eﬁ
(&
p
, &
åec
, &
ª•
->
body
, &
tŸ_Àn
,

1211 
ª•
->
Êags
 & 
TFW_HTTP_F_CHUNKED
);

1212 i‡(
n
 < 0) {

1213 
	`TFW_ERR
("Cache: cannot copy HTTP body\n");

1214  -
ENOMEM
;

1216 
	`BUG_ON
(
tŸ_Àn
 != 0);

1218 
˚
->
vîsi⁄
 = 
ª•
->version;

1219 
˚
->
hmÊags
 = 
ª•
->
Êags
;

1221 i‡(
ª•
->
ˇche_˘l
.
Êags


1222 & (
TFW_HTTP_CC_MUST_REVAL
 | 
TFW_HTTP_CC_PROXY_REVAL
))

1223 
˚
->
Êags
 |
TFW_CE_MUST_REVAL
;

1224 
˚
->
d©e
 = 
ª•
->date;

1225 
˚
->
age
 = 
ª•
->
ˇche_˘l
.age;

1226 
˚
->
ªq_time
 = 
ªq
->
ˇche_˘l
.
time°amp
;

1227 
˚
->
ª•_time
 = 
ª•
->
ˇche_˘l
.
time°amp
;

1228 
˚
->
li„time
 = 
	`tfw_ˇche_ˇlc_li„time
(
ª•
);

1229 
˚
->
œ°_modifõd
 = 
ª•
->last_modified;

1230 
˚
->
ª•_°©us
 = 
ª•
->
°©us
;

1232 i‡((
r
 = 
	`__£t_ëag
(
˚
, 
ª•
, 
ëag_off
, 
ëag_åec
, 
p
, &
åec
))) {

1233 
	`TFW_ERR
("Cache: cannot copyÉntity-tag\n");

1234  
r
;

1239 
åec
 = &
˚
->trec;

1240 
i
 = 0; i < 
	`ARRAY_SIZE
(
˚
->
hdrs_304
); ++i) {

1241 i‡(!
˚
->
hdrs_304
[
i
])

1244 
p
 = 
	`TDB_PTR
(
db
->
hdr
, 
˚
->
hdrs_304
[
i
]);

1245 
åec
 && (
p
 + 
TFW_CSTR_HDRLEN
 >Åªc->
d©a
 +Åªc->
Àn
)) {

1246 
åec
 = 
	`tdb_√xt_ªc_chunk
(
db
,Årec);

1248 
	`BUG_ON
(!
åec
);

1250 
˚
->
hdrs_304
[
i
] = 
	`TDB_OFF
(
db
->
hdr
, 
p
);

1253 
	`TFW_DBG
("Cache copied msg: content-length=%lu msg_len=%lu, ce=%p"

1256 
ª•
->
c⁄ã¡_Àngth
,Ñe•->
msg
.
Àn
, 
˚
, ce->
åec
.len,

1257 
˚
->
key_Àn
, ce->
°©us_Àn
, ce->
hdr_num
, ce->
hdr_Àn
,

1258 
˚
->
key
, ce->
°©us
, ce->
hdrs
, ce->
body
);

1261 
	}
}

1263 
size_t


1264 
	$__ˇche_íåy_size
(
TfwHâpRe•
 *
ª•
)

1266 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

1267 
size_t
 
size
 = 
CE_BODY_SIZE
;

1268 
TfwSå
 *
h
, *
hdr
, *
hdr_íd
, *
dup
, *
dup_íd
, 
em±y
 = {};

1271 
size
 +
ªq
->
uri_∑th
.
Àn
;

1272 
size
 +
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
].
Àn
;

1275 
	`FOR_EACH_HDR_FIELD
(
hdr
, 
hdr_íd
, 
ª•
) {

1277 i‡(!(
hdr
->
Êags
 & 
TFW_STR_HBH_HDR
))

1278 
h
 = 
hdr
;

1279 i‡(
hdr
 - 
ª•
->
h_tbl
->
tbl
 < 
TFW_HTTP_HDR_RAW
)

1280 
h
 = &
em±y
;

1284 i‡(!
	`TFW_STR_DUP
(
h
)) {

1285 
size
 +(
TfwCSå
);

1286 
size
 +
h
->
Àn
 ? (h->À¿+ 
	`SLEN
(
S_CRLF
)) : 0;

1288 
size
 +(
TfwCSå
);

1289 
	`TFW_STR_FOR_EACH_DUP
(
dup
, 
h
, 
dup_íd
) {

1290 
size
 +(
TfwCSå
);

1291 
size
 +
dup
->
Àn
 + 
	`SLEN
(
S_CRLF
);

1297 
size
 +
ª•
->
s_löe
.
Àn
 + 
	`SLEN
(
S_CRLF
);

1300 
size
 +
ª•
->
body
.
Àn
;

1301 i‡(
ª•
->
Êags
 & 
TFW_HTTP_F_CHUNKED
)

1302 
size
 +
	`SLEN
(
S_CRLF
);

1304  
size
;

1305 
	}
}

1308 
	$__ˇche_add_node
(
TDB
 *
db
, 
TfwHâpRe•
 *
ª•
, 
key
)

1310 
TfwCacheE¡ry
 *
˚
;

1311 
size_t
 
d©a_Àn
 = 
	`__ˇche_íåy_size
(
ª•
);

1312 
size_t
 
Àn
 = 
d©a_Àn
;

1321 
˚
 = (
TfwCacheE¡ry
 *)
	`tdb_íåy_Æloc
(
db
, 
key
, &
Àn
);

1322 
	`BUG_ON
(
Àn
 <(
TfwCacheE¡ry
));

1323 i‡(!
˚
)

1326 
	`TFW_DBG3
("cache db=%pÑesp=%p/req=%p/ce=%p:álloc_len=%lu\n",

1327 
db
, 
ª•
,Ñe•->
ªq
, 
˚
, 
Àn
);

1329 i‡(
	`tfw_ˇche_c›y_ª•
(
˚
, 
ª•
, 
d©a_Àn
)) {

1333 
	}
}

1336 
	$tfw_ˇche_add
(
TfwHâpRe•
 *
ª•
, 
tfw_hâp_ˇche_cb_t
 
a˘i⁄
)

1338 
key
;

1339 
boﬁ
 
kìp_skb
 = 
Ál£
;

1340 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

1342 i‡(!
	`tfw_ˇche_em∂oy_ª•
(
ª•
))

1343 
out
;

1345 
key
 = 
	`tfw_hâp_ªq_key_ˇlc
(
ªq
);

1347 i‡(
ˇche_cfg
.
ˇche
 =
TFW_CACHE_SHARD
) {

1348 
	`BUG_ON
(
ªq
->
node
 !
	`numa_node_id
());

1349 
	`__ˇche_add_node
(
	`node_db
(), 
ª•
, 
key
);

1351 
nid
;

1356 
	`f‹_óch_node_wôh_˝us
(
nid
)

1357 
	`__ˇche_add_node
(
c_nodes
[
nid
].
db
, 
ª•
, 
key
);

1366 
out
:

1367 
ª•
->
msg
.
ss_Êags
 |
kìp_skb
 ? 
SS_F_KEEP_SKB
 : 0;

1368 
	`a˘i⁄
((
TfwHâpMsg
 *)
ª•
);

1369 
	}
}

1376 
	$tfw_ˇche_purge_övÆid©e
(
TfwHâpReq
 *
ªq
)

1378 
TdbIãr
 
ôî
;

1379 
TDB
 *
db
 = 
	`node_db
();

1380 
TfwCacheE¡ry
 *
˚
 = 
NULL
;

1382 i‡(!(
˚
 = 
	`tfw_ˇche_db˚_gë
(
db
, &
ôî
, 
ªq
)))

1383  -
ENOENT
;

1384 
˚
->
li„time
 = 0;

1387 
	`tdb_ªc_√xt
(
db
, &
ôî
);

1388 
˚
 = (
TfwCacheE¡ry
 *)
ôî
.
ªc
;

1389 i‡(
˚
 && 
	`tfw_ˇche_íåy_key_eq
(
db
, 
ªq
, ce))

1390 
˚
->
li„time
 = 0;

1391 } 
˚
);

1393 
	`tfw_ˇche_db˚_put
(
˚
);

1396 
	}
}

1402 
	$tfw_ˇche_purge_mëhod
(
TfwHâpReq
 *
ªq
)

1404 
ªt
;

1405 
TfwAddr
 
ßddr
;

1406 
TfwGlobÆ
 *
g_vho°
 = 
	`tfw_vho°_gë_globÆ
();

1409 i‡(!(
ˇche_cfg
.
ˇche
 && 
g_vho°
->
ˇche_purge
 && g_vho°->
ˇche_purge_a˛
)) {

1410 
	`tfw_hâp_£nd_ª•
(
ªq
, 403, "purge:Çot configured");

1415 
	`ss_gë≥î«me
(
ªq
->
c⁄n
->
sk
, &
ßddr
);

1416 i‡(!
	`tfw_ˇpua˛_m©ch
(&
ßddr
)) {

1417 
	`tfw_hâp_£nd_ª•
(
ªq
, 403, "purge: ACL violation");

1422 
g_vho°
->
ˇche_purge_mode
) {

1423 
TFW_D_CACHE_PURGE_INVALIDATE
:

1424 
ªt
 = 
	`tfw_ˇche_purge_övÆid©e
(
ªq
);

1427 
	`tfw_hâp_£nd_ª•
(
ªq
, 403, "purge: invalid option");

1431 i‡(
ªt
)

1432 
	`tfw_hâp_£nd_ª•
(
ªq
, 404, "purge:ÖrocessingÉrror");

1434 
	`tfw_hâp_£nd_ª•
(
ªq
, 200, "purge: success");

1435 
	}
}

1442 
	$tfw_ˇche_buûd_ª•_body
(
TDB
 *
db
, 
TfwHâpRe•
 *
ª•
, 
TdbVRec
 *
åec
,

1443 
TfwMsgIãr
 *
ô
, *
p
)

1445 
off
, 
f_size
, 
r
;

1446 
skb_‰ag_t
 *
‰ag
;

1448 
	`BUG_ON
(!
ô
->
skb
);

1449 
‰ag
 = &
	`skb_shöfo
(
ô
->
skb
)->
‰ags
[it->frag];

1450 i‡(
	`skb_‰ag_size
(
‰ag
))

1451 ++
ô
->
‰ag
;

1452 i‡(
ô
->
‰ag
 >
MAX_SKB_FRAGS
 - 1

1453 && (
r
 = 
	`tfw_hâp_msg_£tup
((
TfwHâpMsg
 *)
ª•
, 
ô
, 0)))

1454  
r
;

1457 i‡(
ô
->
‰ag
 =
MAX_SKB_FRAGS


1458 && (
r
 = 
	`tfw_hâp_msg_£tup
((
TfwHâpMsg
 *)
ª•
, 
ô
, 0)))

1459  
r
;

1462 
off
 = ()
p
 & ~
PAGE_MASK
;

1463 
f_size
 = 
åec
->
d©a
 +Åªc->
Àn
 - 
p
;

1464 i‡(
f_size
) {

1465 
	`skb_fûl_∑ge_desc
(
ô
->
skb
, it->
‰ag
, 
	`vút_to_∑ge
(
p
),

1466 
off
, 
f_size
);

1467 
	`skb_‰ag_ªf
(
ô
->
skb
, it->
‰ag
);

1468 
	`ss_skb_adju°_d©a_Àn
(
ô
->
skb
, 
f_size
);

1470 i‡(
	`__tfw_hâp_msg_add_°r_d©a
((
TfwHâpMsg
 *)
ª•
,

1471 &
ª•
->
body
, 
p
, 
f_size
,

1472 
ô
->
skb
))

1473  - 
ENOMEM
;

1474 ++
ô
->
‰ag
;

1476 i‡(!(
åec
 = 
	`tdb_√xt_ªc_chunk
(
db
,Årec)))

1478 
	`BUG_ON
(
åec
 && !
f_size
);

1479 
p
 = 
åec
->
d©a
;

1483 
	}
}

1506 
TfwHâpRe•
 *

1507 
	$tfw_ˇche_buûd_ª•
(
TfwHâpReq
 *
ªq
, 
TfwCacheE¡ry
 *
˚
)

1509 
h
;

1510 *
p
;

1511 
TfwHâpRe•
 *
ª•
;

1512 
TdbVRec
 *
åec
 = &
˚
->trec;

1513 
TDB
 *
db
 = 
	`node_db
();

1514 
TfwMsgIãr
 
ô
;

1521 i‡(!(
ª•
 = 
	`tfw_hâp_msg_Æloc_ª•
(
ªq
)))

1522  
NULL
;

1523 i‡(
	`tfw_hâp_msg_£tup
((
TfwHâpMsg
 *)
ª•
, &
ô
, 
˚
->
hdr_Àn
 + 2))

1524 
‰ì
;

1531 
h
 = (
˚
->
hdr_num
 + 2 * 
TFW_HTTP_HDR_NUM
 - 1) & ~(TFW_HTTP_HDR_NUM - 1);

1532 
p
 = 
	`tfw_poﬁ_ªÆloc
(
ª•
->
poﬁ
,Ñe•->
h_tbl
, 
	`TFW_HHTBL_SZ
(1),

1533 
	`TFW_HHTBL_EXACTSZ
(
h
));

1534 
	`BUG_ON
(
p
 !(*)
ª•
->
h_tbl
);

1537 
p
 = 
	`TDB_PTR
(
db
->
hdr
, 
˚
->
°©us
);

1538 
åec
 && ()(
p
 -Åªc->
d©a
Ë>Åªc->
Àn
;

1539 
åec
 = 
	`tdb_√xt_ªc_chunk
(
db
,Årec))

1541 i‡(
	`u∆ikñy
(!
åec
)) {

1542 
	`TFW_WARN
("Huh,Öartially stored cacheÉntry (key=%lx)?\n",

1543 
˚
->
key
);

1544 
îr
;

1547 i‡(
	`tfw_ˇche_wrôe_fõld
(
db
, &
åec
, 
ª•
, &
ô
, &
p
,

1548 
˚
->
°©us_Àn
, &
ª•
->
s_löe
))

1549 
îr
;

1551 
ª•
->
h_tbl
->
off
 = 
˚
->
hdr_num
;

1552 
h
 = 0; h < 
˚
->
hdr_num
; ++h) {

1553 
	`TFW_STR_INIT
(
ª•
->
h_tbl
->
tbl
 + 
h
);

1554 i‡(
	`tfw_ˇche_buûd_ª•_hdr
(
db
, 
ª•
,Ñe•->
h_tbl
->
tbl
 + 
h
,

1555 &
åec
, &
ô
, &
p
))

1556 
îr
;

1559 i‡(
	`tfw_hâp_msg_add_d©a
(&
ô
, (
TfwHâpMsg
 *)
ª•
, &ª•->
¸lf
,

1560 &
g_¸lf
))

1561 
îr
;

1563 
	`BUG_ON
(
p
 !
	`TDB_PTR
(
db
->
hdr
, 
˚
->
body
));

1564 i‡(
	`tfw_ˇche_buûd_ª•_body
(
db
, 
ª•
, 
åec
, &
ô
, 
p
))

1565 
îr
;

1567 
ª•
->
vîsi⁄
 = 
˚
->version;

1568 
ª•
->
Êags
 = 
˚
->
hmÊags
;

1570  
ª•
;

1571 
îr
:

1572 
	`TFW_WARN
("C™nŸ u£ cachedÑe•⁄£, key=%lx\n", 
˚
->
key
);

1573 
‰ì
:

1574 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

1575  
NULL
;

1576 
	}
}

1578 
ölöe
 

1579 
	$tfw_ˇche_£t_hdr_age
(
TfwHâpMsg
 *
hmª•
, 
TfwCacheE¡ry
 *
˚
)

1581 
size_t
 
digs
;

1582 
c°r_age
[
TFW_ULTOA_BUF_SIZ
] = {0};

1583 
time_t
 
age
 = 
	`tfw_ˇche_íåy_age
(
˚
);

1585 i‡(!(
digs
 = 
	`tfw_u…ﬂ
(
age
, 
c°r_age
, 
TFW_ULTOA_BUF_SIZ
)))

1586  -
E2BIG
;

1588  
	`tfw_hâp_msg_hdr_x‰m
(
hmª•
, "Age", ("Age") - 1,

1589 
c°r_age
, 
digs
, 
TFW_HTTP_HDR_RAW
, 0);

1590 
	}
}

1593 
	$ˇche_ªq_¥o˚ss_node
(
TfwHâpReq
 *
ªq
, 
tfw_hâp_ˇche_cb_t
 
a˘i⁄
)

1595 
TfwCacheE¡ry
 *
˚
 = 
NULL
;

1596 
TfwHâpRe•
 *
ª•
 = 
NULL
;

1597 
TDB
 *
db
 = 
	`node_db
();

1598 
TdbIãr
 
ôî
;

1599 
time_t
 
li„time
;

1601 i‡(!(
˚
 = 
	`tfw_ˇche_db˚_gë
(
db
, &
ôî
, 
ªq
)))

1602 
out
;

1604 i‡(!(
li„time
 = 
	`tfw_ˇche_íåy_is_live
(
ªq
, 
˚
)))

1605 
out
;

1607 
	`TFW_DBG
("Cache: serviceÑequest w/ key=%lx, ce=%p (len=%u key_len=%u"

1610 
˚
->
åec
.
key
, ce, ce->åec.
Àn
, ce->
key_Àn
, ce->
°©us_Àn
,

1611 
˚
->
hdr_num
, ce->
hdr_Àn
, ce->
key
, ce->
°©us
, ce->
hdrs
,

1612 
˚
->
body
);

1613 
	`TFW_INC_STAT_BH
(
ˇche
.
hôs
);

1615 i‡(!
	`tfw_h™dÀ_vÆid©i⁄_ªq
(
ªq
, 
˚
))

1616 
put
;

1618 i‡(!(
ª•
 = 
	`tfw_ˇche_buûd_ª•
(
ªq
, 
˚
)))

1619 
out
;

1625 i‡(
	`tfw_ˇche_£t_hdr_age
((
TfwHâpMsg
 *)
ª•
, 
˚
)) {

1626 
	`TFW_WARN
("UnableÅoádd Age: header, cached"

1627 "Ñe•⁄£ [%p] dr›≥d\n", 
ª•
);

1628 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

1629 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

1630 
ª•
 = 
NULL
;

1631 
out
;

1633 i‡(
li„time
 > 
˚
->lifetime)

1634 
ª•
->
Êags
 |
TFW_HTTP_F_RESP_STALE
;

1635 
out
:

1636 i‡(!
ª•
 && (
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_OIFCACHED
))

1637 
	`tfw_hâp_£nd_ª•
(
ªq
, 504, "resourceÇot cached");

1644 
	`a˘i⁄
((
TfwHâpMsg
 *)
ªq
);

1645 
put
:

1646 
	`tfw_ˇche_db˚_put
(
˚
);

1647 
	}
}

1650 
	$tfw_ˇche_do_a˘i⁄
(
TfwHâpMsg
 *
msg
, 
tfw_hâp_ˇche_cb_t
 
a˘i⁄
)

1652 
TfwHâpReq
 *
ªq
;

1654 i‡(
	`TFW_CONN_TYPE
(
msg
->
c⁄n
Ë& 
C⁄n_Srv
) {

1655 
	`tfw_ˇche_add
((
TfwHâpRe•
 *)
msg
, 
a˘i⁄
);

1659 
ªq
 = (
TfwHâpReq
 *)
msg
;

1660 i‡(
	`u∆ikñy
(
ªq
->
mëhod
 =
TFW_HTTP_METH_PURGE
))

1661 
	`tfw_ˇche_purge_mëhod
(
ªq
);

1663 
	`ˇche_ªq_¥o˚ss_node
(
ªq
, 
a˘i⁄
);

1664 
	}
}

1667 
	$tfw_ˇche_ùi
(
úq_w‹k
 *
w‹k
)

1669 
TfwW‹kTaskÀt
 *
˘
 = 
	`c⁄èöî_of
(
w‹k
, TfwW‹kTaskÀt, 
ùi_w‹k
);

1671 
	`èskÀt_scheduÀ
(&
˘
->
èskÀt
);

1672 
	}
}

1675 
	$tfw_ˇche_¥o˚ss
(
TfwHâpMsg
 *
msg
, 
tfw_hâp_ˇche_cb_t
 
a˘i⁄
)

1677 
˝u
;

1678 
key
;

1679 
TfwW‹kTaskÀt
 *
˘
;

1680 
TfwCW‹k
 
cw
;

1681 
TfwHâpRe•
 *
ª•
 = 
NULL
;

1682 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
msg
;

1684 i‡(
	`TFW_CONN_TYPE
(
msg
->
c⁄n
Ë& 
C⁄n_Srv
) {

1685 
ª•
 = (
TfwHâpRe•
 *)
msg
;

1686 
ªq
 = 
ª•
->req;

1689 i‡(
ªq
->
mëhod
 =
TFW_HTTP_METH_PURGE
)

1690 
do_ˇche
;

1691 i‡(!
	`tfw_ˇche_msg_ˇchóbÀ
(
ªq
))

1692 
d⁄t_ˇche
;

1693 i‡(!
ª•
 && !
	`tfw_ˇche_em∂oy_ªq
(
ªq
))

1694 
d⁄t_ˇche
;

1696 
do_ˇche
:

1697 
key
 = 
	`tfw_hâp_ªq_key_ˇlc
(
ªq
);

1698 
ªq
->
node
 = (
ˇche_cfg
.
ˇche
 =
TFW_CACHE_SHARD
)

1699 ? 
	`tfw_ˇche_key_node
(
key
)

1700 : 
	`numa_node_id
();

1710 i‡(
	`likñy
(
ªq
->
node
 =
	`numa_node_id
())) {

1711 
	`tfw_ˇche_do_a˘i⁄
(
msg
, 
a˘i⁄
);

1715 
cw
.
msg
 = msg;

1716 
cw
.
a˘i⁄
 =áction;

1717 
˝u
 = 
	`tfw_ˇche_sched_˝u
(
ªq
);

1718 
˘
 = 
	`≥r_˝u_±r
(&
ˇche_wq
, 
˝u
);

1720 
	`TFW_DBG2
("Cache: scheduleÅasklet w/ work:Åo_cpu=%d from_cpu=%d"

1721 " msg=%∞key=%lx\n", 
˝u
, 
	`smp_¥o˚ss‹_id
(),

1722 
cw
.
msg
, 
key
);

1724 i‡(
	`tfw_wq_push
(&
˘
->
wq
, &
cw
, 
˝u
, &˘->
ùi_w‹k
, 
tfw_ˇche_ùi
)) {

1725 
	`TFW_WARN
("Cache work queue overrun: [%s]\n",

1726 
ª•
 ? "response" : "request");

1727  -
EBUSY
;

1731 
d⁄t_ˇche
:

1732 
	`a˘i⁄
(
msg
);

1734 
	}
}

1737 
	$tfw_wq_èskÀt
(
d©a
)

1739 
TfwW‹kTaskÀt
 *
˘
 = (TfwW‹kTaskÀà*)
d©a
;

1740 
TfwCW‹k
 
cw
;

1742 !
	`tfw_wq_p›
(&
˘
->
wq
, &
cw
))

1743 
	`tfw_ˇche_do_a˘i⁄
(
cw
.
msg
, cw.
a˘i⁄
);

1744 
	}
}

1752 
	$tfw_ˇche_mgr
(*
¨g
)

1760 i‡(!
	`‰ìzög
(
cuºít
)) {

1761 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

1762 
	`scheduÀ
();

1763 
	`__£t_cuºít_°©e
(
TASK_RUNNING
);

1766 
	`åy_to_‰ìze
();

1767 } !
	`kthªad_should_°›
());

1770 
	}
}

1774 
	$tfw_ˇche_°¨t
()

1776 
i
, 
r
 = 1;

1777 
TfwGlobÆ
 *
g_vho°
 = 
	`tfw_vho°_gë_globÆ
();

1779 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1781 i‡(!(
ˇche_cfg
.
ˇche
 || 
g_vho°
->
ˇche_purge
))

1784 
	`f‹_óch_node_wôh_˝us
(
i
) {

1785 
c_nodes
[
i
].
db
 = 
	`tdb_›í
(
ˇche_cfg
.
db_∑th
,

1786 
ˇche_cfg
.
db_size
, 0, 
i
);

1787 i‡(!
c_nodes
[
i
].
db
)

1788 
˛o£_db
;

1791 
ˇche_mgr_thr
 = 
	`kthªad_run
(
tfw_ˇche_mgr
, 
NULL
, "tfw_cache_mgr");

1792 i‡(
	`IS_ERR
(
ˇche_mgr_thr
)) {

1793 
r
 = 
	`PTR_ERR
(
ˇche_mgr_thr
);

1794 
	`TFW_ERR_NL
("C™'à°¨àˇchêm™agî, %d\n", 
r
);

1795 
˛o£_db
;

1798 
	`tfw_öô_node_˝us
();

1800 
	`TFW_WQ_CHECKSZ
(
TfwCW‹k
);

1801 
	`f‹_óch_⁄löe_˝u
(
i
) {

1802 
TfwW‹kTaskÀt
 *
˘
 = &
	`≥r_˝u
(
ˇche_wq
, 
i
);

1803 
	`tfw_wq_öô
(&
˘
->
wq
, 
	`˝u_to_node
(
i
));

1804 
	`öô_úq_w‹k
(&
˘
->
ùi_w‹k
, 
tfw_ˇche_ùi
);

1805 
	`èskÀt_öô
(&
˘
->
èskÀt
, 
tfw_wq_èskÀt
, ()ct);

1809 
˛o£_db
:

1810 
	`f‹_óch_node_wôh_˝us
(
i
)

1811 
	`tdb_˛o£
(
c_nodes
[
i
].
db
);

1812  
r
;

1813 
	}
}

1816 
	$tfw_ˇche_°›
()

1818 
i
;

1820 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1822 i‡(!
ˇche_cfg
.
ˇche
)

1825 
	`f‹_óch_⁄löe_˝u
(
i
) {

1826 
TfwW‹kTaskÀt
 *
˘
 = &
	`≥r_˝u
(
ˇche_wq
, 
i
);

1827 
	`èskÀt_kûl
(&
˘
->
èskÀt
);

1828 
	`úq_w‹k_sync
(&
˘
->
ùi_w‹k
);

1829 
	`tfw_wq_de°roy
(&
˘
->
wq
);

1832 
	`kthªad_°›
(
ˇche_mgr_thr
);

1835 
	`f‹_óch_node_wôh_˝us
(
i
)

1836 
	`tdb_˛o£
(
c_nodes
[
i
].
db
);

1837 
	}
}

1839 c⁄° 
TfwCfgEnum
 
	gˇche_hâp_mëhods_íum
[] = {

1840 { "c›y", 
TFW_HTTP_METH_COPY
 },

1841 { "dñëe", 
TFW_HTTP_METH_DELETE
 },

1842 { "gë", 
TFW_HTTP_METH_GET
 },

1843 { "hód", 
TFW_HTTP_METH_HEAD
 },

1844 { "lock", 
TFW_HTTP_METH_LOCK
 },

1845 { "mkcﬁ", 
TFW_HTTP_METH_MKCOL
 },

1846 { "move", 
TFW_HTTP_METH_MOVE
 },

1847 { "›ti⁄s", 
TFW_HTTP_METH_OPTIONS
 },

1848 { "∑tch", 
TFW_HTTP_METH_PATCH
 },

1849 { "po°", 
TFW_HTTP_METH_POST
 },

1850 { "¥›föd", 
TFW_HTTP_METH_PROPFIND
 },

1851 { "¥›∑tch", 
TFW_HTTP_METH_PROPPATCH
 },

1852 { "put", 
TFW_HTTP_METH_PUT
 },

1853 { "åa˚", 
TFW_HTTP_METH_TRACE
 },

1854 { "u∆ock", 
TFW_HTTP_METH_UNLOCK
 },

1860 
	$tfw_cfg›_ˇche_mëhods
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1862 
i
, 
mëhod
;

1863 c⁄° *
vÆ
;

1865 
	`BUILD_BUG_ON
((
ˇche_cfg
.
mëhods
Ë* 
BITS_PER_BYTE


1866 < 
_TFW_HTTP_METH_COUNT
);

1867 
	`BUILD_BUG_ON
((
mëhod
Ë* 
BITS_PER_BYTE
 < 
_TFW_HTTP_METH_COUNT
);

1869 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
vÆ
) {

1870 i‡(
	`tfw_cfg_m≠_íum
(
ˇche_hâp_mëhods_íum
, 
vÆ
, &
mëhod
)) {

1871 
	`TFW_ERR_NL
("%s: unsupported method: '%s'\n",

1872 
cs
->
«me
, 
vÆ
);

1873  -
EINVAL
;

1875 i‡(
	`__ˇche_mëhod_nc_ã°
(
mëhod
)) {

1876 
	`TFW_WARN_NL
("%s:Çon-cacheable method '%s' is set "

1878 
cs
->
«me
, 
vÆ
);

1880 i‡(
	`__ˇche_mëhod_ã°
(
mëhod
)) {

1881 
	`TFW_WARN_NL
("%s: duplicate method: '%s'\n",

1882 
cs
->
«me
, 
vÆ
);

1885 
	`__ˇche_mëhod_add
(
mëhod
);

1889 
	}
}

1892 
	$tfw_cfg›_˛ónup_ˇche_mëhods
(
TfwCfgS≥c
 *
cs
)

1894 
ˇche_cfg
.
mëhods
 = 0;

1895 
	}
}

1897 
TfwCfgS≥c
 
	gtfw_ˇche_•ecs
[] = {

1899 .
«me
 = "cache",

1900 .
	gdeÊt
 = "2",

1901 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

1902 .
	gde°
 = &
ˇche_cfg
.
ˇche
,

1903 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

1904 .
ønge
 = { 0, 2 },

1908 .
	g«me
 = "cache_methods",

1909 .
	gdeÊt
 = "GET",

1910 .
	gh™dÀr
 = 
tfw_cfg›_ˇche_mëhods
,

1911 .
	gÆlow_n⁄e
 = 
åue
,

1912 .
	gÆlow_ª≥©
 = 
Ál£
,

1913 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_ˇche_mëhods
,

1916 .
	g«me
 = "cache_size",

1917 .
	gdeÊt
 = "268435456",

1918 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

1919 .
	gde°
 = &
ˇche_cfg
.
db_size
,

1920 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

1921 .
mu…ùÀ_of
 = 
PAGE_SIZE
,

1922 .
	gønge
 = { 
PAGE_SIZE
, (1 << 30) },

1926 .
	g«me
 = "cache_db",

1927 .
	gdeÊt
 = "/opt/tempesta/db/cache.tdb",

1928 .
	gh™dÀr
 = 
tfw_cfg_£t_°r
,

1929 .
	gde°
 = &
ˇche_cfg
.
db_∑th
,

1930 .
	g•ec_ext
 = &(
TfwCfgS≥cSå
) {

1931 .
Àn_ønge
 = { 1, 
PATH_MAX
 },

1937 
TfwMod
 
	gtfw_ˇche_mod
 = {

1938 .
«me
 = "cache",

1939 .
	g°¨t
 = 
tfw_ˇche_°¨t
,

1940 .
	g°›
 = 
tfw_ˇche_°›
,

1941 .
	g•ecs
 = 
tfw_ˇche_•ecs
,

1945 
	$tfw_ˇche_öô
()

1947 
	`tfw_mod_ªgi°î
(&
tfw_ˇche_mod
);

1949 
	}
}

1952 
	$tfw_ˇche_exô
()

1954 
	`tfw_mod_uƒegi°î
(&
tfw_ˇche_mod
);

1955 
	}
}

	@cache.h

21 #i‚de‡
__TFW_CACHE_H__


22 
	#__TFW_CACHE_H__


	)

24 
	~"hâp.h
"

26 
boﬁ
 
tfw_ˇche_msg_ˇchóbÀ
(
TfwHâpReq
 *
ªq
);

27 
tfw_ˇche_¥o˚ss
(
TfwHâpMsg
 *
msg
, 
tfw_hâp_ˇche_cb_t
 
a˘i⁄
);

	@cfg.c

84 
	~<löux/˘y≥.h
>

85 
	~<löux/kî√l.h
>

86 
	~<löux/moduÀ∑øm.h
>

88 #i‚de‡
DBG_CFG


89 #unde‡
DEBUG


91 
	~"addr.h
"

92 
	~"cfg.h
"

93 
	~"˛õ¡.h
"

94 
	~"log.h
"

113 
	$__Æloc_™d_c›y_lôîÆ
(c⁄° *
§c
, 
size_t
 
Àn
, 
boﬁ
 
kìp_bs
)

115 c⁄° *
§c_pos
, *
§c_íd
;

116 *
d°
, *
d°_pos
;

117 
boﬁ
 
is_esˇ≥d
;

119 
	`BUG_ON
(!
§c
);

121 
d°
 = 
	`kmÆloc
(
Àn
 + 1, 
GFP_KERNEL
);

122 i‡(!
d°
) {

123 
	`TFW_ERR_NL
("can'tállocate memory\n");

124  
NULL
;

130 
§c_íd
 = 
§c
 + 
Àn
;

131 
§c_pos
 = 
§c
;

132 
d°_pos
 = 
d°
;

133 
is_esˇ≥d
 = 
Ál£
;

134 
§c_pos
 < 
§c_íd
) {

135 i‡(*
§c_pos
 !'\\' || 
is_esˇ≥d
 || 
kìp_bs
) {

136 
is_esˇ≥d
 = 
Ál£
;

137 *
d°_pos
 = *
§c_pos
;

138 ++
d°_pos
;

140 i‡(*
§c_pos
 == '\\') {

141 
is_esˇ≥d
 = 
åue
;

143 ++
§c_pos
;

145 *
d°_pos
 = '\0';

147  
d°
;

148 
	}
}

150 
ölöe
 const *

151 
	$Æloc_™d_c›y_lôîÆ
(c⁄° *
§c
, 
size_t
 
Àn
)

153  
	`__Æloc_™d_c›y_lôîÆ
(
§c
, 
Àn
, 
Ál£
);

154 
	}
}

156 
ölöe
 const *

157 
	$Æloc_™d_c›y_lôîÆ_bs
(c⁄° *
§c
, 
size_t
 
Àn
)

159  
	`__Æloc_™d_c›y_lôîÆ
(
§c
, 
Àn
, 
åue
);

160 
	}
}

171 
boﬁ


172 
	$check_idítifõr
(c⁄° *
buf
, 
size_t
 
Àn
)

174 
size_t
 
i
;

176 i‡(!
Àn
) {

177 
	`TFW_ERR_NL
("the string isÉmpty\n");

178  
Ál£
;

181 i‡((
Àn
 =1Ë&& (
buf
[0] == '*'))

182  
åue
;

184 i‡(!
	`ißÕha
(
buf
[0])) {

185 
	`TFW_ERR_NL
("the first character isÇotáÜetter: '%c'\n",

186 
buf
[0]);

187  
Ál£
;

190 
i
 = 0; i < 
Àn
; ++i) {

191 i‡(!
	`iß um
(
buf
[
i
]) && buf[i] != '_') {

192 
	`TFW_ERR_NL
("invalid character: '%c' in '%.*s'\n",

193 
buf
[
i
], ()
Àn
, buf);

194  
Ál£
;

198  
åue
;

199 
	}
}

201 
ölöe
 

202 
	$ruÀ_ª£t
(
TfwCfgRuÀ
 *
ruÀ
)

204 
	`k‰ì
(
ruÀ
->
f°
);

205 
	`k‰ì
(
ruÀ
->
¢d
);

206 
	`k‰ì
(
ruÀ
->
a˘
);

207 
	`k‰ì
(
ruÀ
->
vÆ
);

208 
	}
}

211 
	$íåy_ª£t
(
TfwCfgE¡ry
 *
e
)

213 c⁄° *
key
, *
vÆ
;

214 
size_t
 
i
;

216 
	`BUG_ON
(!
e
);

218 
	`k‰ì
(
e
->
«me
);

219 
	`k‰ì
(
e
->
·okí
);

221 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
e
, 
i
, 
vÆ
)

222 
	`k‰ì
(
vÆ
);

224 
	`TFW_CFG_ENTRY_FOR_EACH_ATTR
(
e
, 
i
, 
key
, 
vÆ
) {

225 
	`k‰ì
(
key
);

226 
	`k‰ì
(
vÆ
);

229 
	`ruÀ_ª£t
(&
e
->
ruÀ
);

231 
	`mem£t
(
e
, 0, (*e));

232 
	}
}

235 
	$íåy_£t_«me
(
TfwCfgE¡ry
 *
e
)

237 
Àn
;

238 c⁄° *
«me
;

239 
boﬁ
 
ruÀ
 = !
e
->
·okí
;

241 
	`BUG_ON
(!
e
);

242 
	`BUG_ON
(
e
->
«me
);

244 i‡(!
ruÀ
) {

245 
«me
 = 
e
->
·okí
;

246 
Àn
 = 
	`°æí
(
e
->
·okí
);

248 
«me
 = 
TFW_CFG_RULE_NAME
;

249 
Àn
 = (
TFW_CFG_RULE_NAME
) - 1;

252 
	`TFW_DBG3
("£à«me: %.*s\n", 
Àn
, 
«me
);

254 i‡(!
	`check_idítifõr
(
«me
, 
Àn
))

255  -
EINVAL
;

257 i‡(!
ruÀ
) {

258 
e
->
«me
 =É->
·okí
;

259 
e
->
·okí
 = 
NULL
;

263 i‡(!(
e
->
«me
 = 
	`Æloc_™d_c›y_lôîÆ
“ame, 
Àn
)))

264  -
ENOMEM
;

267 
	}
}

270 
	$íåy_£t_fú°_tokí
(
TfwCfgE¡ry
 *
e
, c⁄° *
§c
, 
Àn
)

272 
	`BUG_ON
(!
e
);

273 
	`BUG_ON
(
e
->
·okí
);

275 
	`TFW_DBG3
("£àfú°Åokí: %.*s\n", 
Àn
, 
§c
);

277 i‡(!
§c
 || !
Àn
)

278  -
EINVAL
;

280 
e
->
·okí
 = 
	`Æloc_™d_c›y_lôîÆ
(
§c
, 
Àn
);

281 i‡(!
e
->
·okí
)

282  -
ENOMEM
;

285 
	}
}

288 
	$íåy_add_vÆ
(
TfwCfgE¡ry
 *
e
, c⁄° *
vÆ_§c
, 
size_t
 
vÆ_Àn
)

290 c⁄° *
vÆ
;

292 
	`BUG_ON
(!
e
);

293 
	`BUG_ON
(
e
->
vÆ_n
 > 
	`ARRAY_SIZE
”->
vÆs
));

295 i‡(!
vÆ_§c
)

296  -
EINVAL
;

298 i‡(
e
->
vÆ_n
 =
	`ARRAY_SIZE
”->
vÆs
)) {

299 
	`TFW_ERR_NL
("maximumÇumber of valuesÖerÉntryÑeached\n");

300  -
ENOBUFS
;

304 i‡(
vÆ_Àn
)

305 
vÆ
 = 
	`Æloc_™d_c›y_lôîÆ
(
vÆ_§c
, 
vÆ_Àn
);

307 
vÆ
 = 
	`Æloc_™d_c›y_lôîÆ
("", 0);

309 i‡(!
vÆ
)

310  -
ENOMEM
;

312 
e
->
vÆs
[e->
vÆ_n
++] = 
vÆ
;

314 
	}
}

317 
	$íåy_add_©å
(
TfwCfgE¡ry
 *
e
, c⁄° *
key_§c
, 
size_t
 
key_Àn
,

318 c⁄° *
vÆ_§c
, 
size_t
 
vÆ_Àn
)

320 c⁄° *
key
, *
vÆ
;

322 
	`BUG_ON
(!
e
);

323 
	`BUG_ON
(
e
->
©å_n
 > 
	`ARRAY_SIZE
”->
©ås
));

325 i‡(!
key_§c
 || !
key_Àn
 || !
vÆ_§c
 || !
vÆ_Àn
)

326  -
EINVAL
;

328 i‡(
e
->
©å_n
 =
	`ARRAY_SIZE
”->
©ås
)) {

329 
	`TFW_ERR_NL
("maximumÇumber ofáttributesÖerÉntryÑeached\n");

330  -
ENOBUFS
;

333 i‡(!
	`check_idítifõr
(
key_§c
, 
key_Àn
))

334  -
EINVAL
;

336 
key
 = 
	`Æloc_™d_c›y_lôîÆ
(
key_§c
, 
key_Àn
);

337 
vÆ
 = 
	`Æloc_™d_c›y_lôîÆ
(
vÆ_§c
, 
vÆ_Àn
);

339 i‡(!
key
 || !
vÆ
) {

340 
	`k‰ì
(
key
);

341 
	`k‰ì
(
vÆ
);

342  -
ENOMEM
;

345 
e
->
©ås
[e->
©å_n
].
key
 = key;

346 
e
->
©ås
[e->
©å_n
].
vÆ
 = val;

347 ++
e
->
©å_n
;

349 
	}
}

352 
	$íåy_add_ruÀ_∑øm
(c⁄° **
∑øm
, c⁄° *
§c
, 
size_t
 
Àn
)

354 c⁄° *
d°
;

356 
	`BUG_ON
(!
§c
);

357 i‡(!(
d°
 = 
	`Æloc_™d_c›y_lôîÆ
(
§c
, 
Àn
)))

358  -
ENOMEM
;

359 *
∑øm
 = 
d°
;

361 
	}
}

391 
	mTOKEN_NA
 = 0,

392 
	mTOKEN_LBRACE
,

393 
	mTOKEN_RBRACE
,

394 
	mTOKEN_EQSIGN
,

395 
	mTOKEN_DEQSIGN
,

396 
	mTOKEN_NEQSIGN
,

397 
	mTOKEN_SEMICOLON
,

398 
	mTOKEN_LITERAL
,

399 
	mTOKEN_ARROW
,

400 
	m_TOKEN_COUNT
,

401 } 
	ttokí_t
;

404 c⁄° *
	mö
;

405 c⁄° *
	mpos
;

408 c⁄° *
	mfsm_s
;

409 c⁄° *
	mfsm_ss
;

412 
	mc
;

413 
	m¥ev_c
;

418 
tokí_t
 
	mt
;

419 
tokí_t
 
	m¥ev_t
;

422 c⁄° *
	mlô
;

423 c⁄° *
	m¥ev_lô
;

426 
	mlô_Àn
;

427 
	m¥ev_lô_Àn
;

430 
size_t
 
	mlöe_no
;

431 c⁄° *
	mlöe
;

433 
	mîr
;

438 
TfwCfgE¡ry
 
	me
;

439 } 
	tTfwCfgP¨£rSèã
;

443 
	#FSM_STATE
(
«me
) \

444 
	`TFW_DBG3
("fsm: im∂icôÉxô from: %s\n", 
ps
->
fsm_ss
); \

445 
	`BUG
(); \

446 
«me
: \

447 i‡(
ps
->
fsm_s
 !&&
«me
) { \

448 
	`TFW_DBG3
("fsmÅu∫: %†-> %s\n", 
ps
->
fsm_ss
, #name); \

449 
ps
->
fsm_s
 = &&
«me
; \

450 
ps
->
fsm_ss
 = #name; \

451 }

	)

453 
	#FSM_JMP
(
to_°©e
Ë
	)
to_state

455 
	#FSM_COND_JMP
(
c⁄d
, 
to_°©e
) \

456 
	`FSM_COND_LAMBDA
(
c⁄d
, 
	`FSM_JMP
(
to_°©e
))

	)

458 
	#FSM_COND_LAMBDA
(
c⁄d
, ...) \

460 i‡(
c⁄d
) { \

461 
__VA_ARGS__
; \

464 

	)

467 
	#TFSM_MOVE
(
to_°©e
) \

469 
ps
->
¥ev_c
 =Ös->
c
; \

470 
ps
->
c
 = *(++ps->
pos
); \

471 
	`TFW_DBG3
("tfsm move: '%c' -> '%c'\n", 
ps
->
¥ev_c
,Ös->
c
); \

472 i‡(
ps
->
¥ev_c
 == '\n') { \

473 ++
ps
->
löe_no
; \

474 
ps
->
löe
 =Ös->
pos
; \

476 
	`FSM_JMP
(
to_°©e
); \

477 } 0)

	)

479 
	#TFSM_MOVE_EXIT
(
tokí_ty≥
) \

481 
ps
->
t
 = 
tokí_ty≥
; \

482 
	`TFSM_MOVE
(
TS_EXIT
); \

483 } 0)

	)

485 
	#TFSM_JMP_EXIT
(
tokí_ty≥
) \

487 
ps
->
t
 = 
tokí_ty≥
; \

488 
	`FSM_JMP
(
TS_EXIT
); \

489 } 0)

	)

491 
	#TFSM_SKIP
(Ë
	`TFSM_MOVE
(*
ps
->
fsm_s
);

	)

493 
	#TFSM_COND_SKIP
(
c⁄d
) \

494 
	`FSM_COND_LAMBDA
(
c⁄d
, 
	`TFSM_SKIP
())

	)

496 
	#TFSM_COND_MOVE_EXIT
(
c⁄d
, 
tokí_ty≥
) \

497 
	`FSM_COND_LAMBDA
(
c⁄d
, 
	`TFSM_MOVE_EXIT
(
tokí_ty≥
))

	)

499 
	#TFSM_COND_JMP_EXIT
(
c⁄d
, 
tokí_ty≥
) \

500 
	`FSM_COND_LAMBDA
(
c⁄d
, 
	`TFSM_JMP_EXIT
(
tokí_ty≥
))

	)

502 
	#TFSM_COND_MOVE
(
c⁄d
, 
to_°©e
) \

503 
	`FSM_COND_LAMBDA
(
c⁄d
, 
	`TFSM_MOVE
(
to_°©e
))

	)

507 
	#PFSM_MOVE
(
to_°©e
) \

509 
	`ªad_√xt_tokí
(
ps
); \

510 
	`TFW_DBG3
("pfsm move: %d (\"%.*s\") -> %d (\"%.*s\")", \

511 
ps
->
¥ev_t
,Ös->
¥ev_lô_Àn
,Ös->
¥ev_lô
, \

512 
ps
->
t
,Ös->
lô_Àn
,Ös->
lô
); \

513 if(!
ps
->
t
) { \

514 
ps
->
îr
 = -
EINVAL
; \

515 
	`FSM_JMP
(
PS_EXIT
); \

517 
	`FSM_JMP
(
to_°©e
); \

518 } 0)

	)

520 
	#PFSM_COND_MOVE
(
c⁄d
, 
to_°©e
) \

521 
	`FSM_COND_LAMBDA
(
c⁄d
, 
	`PFSM_MOVE
(
to_°©e
))

	)

523 
	#PFSM_COND_JMP_EXIT_ERROR
(
c⁄d
) \

525 i‡(
c⁄d
) { \

526 
	`TFW_DBG3
("pfsm:ÑuÀÉº‹, %d -> %d", 
ps
->
¥ev_t
,Ös->
t
); \

527 
ps
->
îr
 = -
EINVAL
; \

528 
	`FSM_JMP
(
PS_EXIT
); \

530 } 0)

	)

542 
	$ªad_√xt_tokí
(
TfwCfgP¨£rSèã
 *
ps
)

544 
ps
->
¥ev_t
 =Ös->
t
;

545 
ps
->
¥ev_lô
 =Ös->
lô
;

546 
ps
->
¥ev_lô_Àn
 =Ös->
lô_Àn
;

547 
ps
->
lô
 = 
NULL
;

548 
ps
->
lô_Àn
 = 0;

549 
ps
->
t
 = 
TOKEN_NA
;

550 
ps
->
c
 = *ps->
pos
;

552 
	`TFW_DBG3
("tfsm sèπ, ch¨: '%c',Öos: %.20s\n", 
ps
->
c
,Ös->
pos
);

554 
	`FSM_JMP
(
TS_START_NEW_TOKEN
);

559 
	`FSM_STATE
(
TS_START_NEW_TOKEN
) {

560 
	`TFSM_COND_JMP_EXIT
(!
ps
->
c
, 
TOKEN_NA
);

564 
	`FSM_COND_JMP
(
ps
->
c
 ='\\', 
TS_LITERAL_FIRST_CHAR
);

567 
	`TFSM_COND_SKIP
(
	`is•a˚
(
ps
->
c
));

572 
	`TFSM_COND_MOVE
(
ps
->
c
 ='"', 
TS_QUOTED_LITERAL_FIRST_CHAR
);

575 
	`TFSM_COND_MOVE
(
ps
->
c
 ='#', 
TS_COMMENT
);

578 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='{', 
TOKEN_LBRACE
);

579 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='}', 
TOKEN_RBRACE
);

580 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 =';', 
TOKEN_SEMICOLON
);

583 
	`TFSM_COND_MOVE
(
ps
->
c
 ='!' ||Ös->¯='-', 
TS_DCHAR
);

587 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='=' &&Ös->
¥ev_c
 == '!',

588 
TOKEN_NEQSIGN
);

589 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='>' &&Ös->
¥ev_c
 == '-',

590 
TOKEN_ARROW
);

593 
	`TFSM_COND_MOVE
(
ps
->
c
 ='=', 
TS_EQSIGN
);

597 
	`FSM_JMP
(
TS_LITERAL_FIRST_CHAR
);

600 
	`FSM_STATE
(
TS_DCHAR
) {

601 
	`TFSM_COND_JMP_EXIT
(!
ps
->
c
, 
TOKEN_NA
);

605 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='=' &&Ös->
¥ev_c
 == '!',

606 
TOKEN_NEQSIGN
);

607 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='>' &&Ös->
¥ev_c
 == '-',

608 
TOKEN_ARROW
);

609 
ps
->
lô
 =Ös->
pos
 - 1;

610 ++
ps
->
lô_Àn
;

611 
	`FSM_JMP
(
TS_LITERAL_ACCUMULATE
);

614 
	`FSM_STATE
(
TS_EQSIGN
) {

615 
	`TFSM_COND_JMP_EXIT
(!
ps
->
c
, 
TOKEN_NA
);

618 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='=', 
TOKEN_DEQSIGN
);

619 
	`TFSM_JMP_EXIT
(
TOKEN_EQSIGN
);

622 
	`FSM_STATE
(
TS_COMMENT
) {

623 
	`TFSM_COND_JMP_EXIT
(!
ps
->
c
, 
TOKEN_NA
);

627 
	`TFSM_COND_SKIP
(
ps
->
c
 != '\n');

628 
	`TFSM_MOVE
(
TS_START_NEW_TOKEN
);

631 
	`FSM_STATE
(
TS_LITERAL_FIRST_CHAR
) {

632 
ps
->
lô
 =Ös->
pos
;

633 
	`FSM_JMP
(
TS_LITERAL_ACCUMULATE
);

636 
	`FSM_STATE
(
TS_LITERAL_ACCUMULATE
) {

638 
	`TFSM_COND_JMP_EXIT
(!
ps
->
c
 && !ps->
lô_Àn
, 
TOKEN_NA
);

639 
	`TFSM_COND_JMP_EXIT
(!
ps
->
c
 &&Ös->
lô_Àn
, 
TOKEN_LITERAL
);

642 
	`TFSM_COND_MOVE
(
ps
->
c
 ='\\', 
TS_LITERAL_ACC_ESCAPE
);

645 
	`TFSM_COND_JMP_EXIT
(
	`is•a˚
(
ps
->
c
), 
TOKEN_LITERAL
);

646 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 ='"', 
TOKEN_LITERAL
);

647 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 ='#', 
TOKEN_LITERAL
);

648 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 ='{', 
TOKEN_LITERAL
);

649 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 ='}', 
TOKEN_LITERAL
);

650 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 =';', 
TOKEN_LITERAL
);

651 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 ='=', 
TOKEN_LITERAL
);

654 
	`TFSM_COND_MOVE
(
ps
->
c
 == '-' ||Ös->c == '!',

655 
TS_DOUBLE_CHARACTER_FIRST_CHAR
);

658 ++
ps
->
lô_Àn
;

659 
	`TFSM_SKIP
();

662 
	`FSM_STATE
(
TS_LITERAL_ACC_ESCAPE
) {

663 
ps
->
lô_Àn
 += 2;

664 
	`TFSM_MOVE
(
TS_LITERAL_ACCUMULATE
);

667 
	`FSM_STATE
(
TS_QUOTED_LITERAL_FIRST_CHAR
) {

668 
ps
->
lô
 =Ös->
pos
;

669 
	`FSM_JMP
(
TS_QUOTED_LITERAL_ACCUMULATE
);

672 
	`FSM_STATE
(
TS_QUOTED_LITERAL_ACCUMULATE
) {

674 
	`TFSM_COND_JMP_EXIT
(!
ps
->
c
, 
TOKEN_NA
);

678 
	`TFSM_COND_MOVE
(
ps
->
c
 ='\\', 
TS_QUOTED_LIT_ACC_ESCAPE
);

679 
	`TFSM_COND_MOVE_EXIT
(
ps
->
c
 ='"', 
TOKEN_LITERAL
);

682 ++
ps
->
lô_Àn
;

683 
	`TFSM_SKIP
();

686 
	`FSM_STATE
(
TS_QUOTED_LIT_ACC_ESCAPE
) {

687 
ps
->
lô_Àn
 += 2;

688 
	`TFSM_MOVE
(
TS_QUOTED_LITERAL_ACCUMULATE
);

691 
	`FSM_STATE
(
TS_DOUBLE_CHARACTER_FIRST_CHAR
) {

694 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 ='>' &&Ös->
¥ev_c
 == '-',

695 
TOKEN_LITERAL
);

696 
	`TFSM_COND_JMP_EXIT
(
ps
->
c
 ='=' &&Ös->
¥ev_c
 == '!',

697 
TOKEN_LITERAL
);

698 ++
ps
->
lô_Àn
;

699 
	`FSM_JMP
(
TS_LITERAL_ACCUMULATE
);

702 
	`FSM_STATE
(
TS_EXIT
) {

703 
	`TFW_DBG3
("tfsmÉxit:Å: %d,Üit: %.*s\n",

704 
ps
->
t
,Ös->
lô_Àn
,Ös->
lô
);

706 
	}
}

709 
	$íåy_£t_c⁄d
(
TfwCfgE¡ry
 *
e
, 
tokí_t
 
c⁄d_ty≥
, c⁄° *
§c
, 
Àn
)

711 c⁄° *
«me
 = 
TFW_CFG_RULE_NAME
;

712 
«me_Àn
 = (
TFW_CFG_RULE_NAME
) - 1;

713 
TfwCfgRuÀ
 *
ruÀ
 = &
e
->rule;

715 
	`BUG_ON
(!
e
->
·okí
);

716 
	`BUG_ON
(
e
->
«me
);

718 
	`TFW_DBG3
("setÉntryÑuleÇame '%.*s', 1st operand '%.*s', 2nd operand"

719 " '%.*s',ánd c⁄dôi⁄Åy≥ '%d'\n", 
«me_Àn
, 
«me
,

720 ()
	`°æí
(
e
->
·okí
),É->·okí, 
Àn
, 
§c
, 
c⁄d_ty≥
);

722 i‡(!
§c
 || !
Àn
)

723  -
EINVAL
;

725 
ruÀ
->
f°
 = 
e
->
·okí
;

726 
e
->
·okí
 = 
NULL
;

728 i‡(!(
ruÀ
->
¢d
 = 
	`Æloc_™d_c›y_lôîÆ_bs
(
§c
, 
Àn
)))

729  -
ENOMEM
;

731 i‡(!(
e
->
«me
 = 
	`Æloc_™d_c›y_lôîÆ
“ame, 
«me_Àn
)))

732  -
ENOMEM
;

734 
ruÀ
->
öv
 = 
c⁄d_ty≥
 =
TOKEN_DEQSIGN
 ? 
Ál£
 : 
åue
;

736 
	}
}

757 
	$∑r£_cfg_íåy
(
TfwCfgP¨£rSèã
 *
ps
)

759 
	`TFW_DBG3
("pfsm: start\n");

760 
	`BUG_ON
(
ps
->
îr
);

763 i‡(
ps
->
ö
 =ps->
pos
) {

764 
	`ªad_√xt_tokí
(
ps
);

765 i‡(!
ps
->
t
)

766 
	`FSM_JMP
(
PS_EXIT
);

770 
	`BUG_ON
(!
ps
->
t
);

771 
	`FSM_JMP
(
PS_START_NEW_ENTRY
);

790 
	`FSM_STATE
(
PS_START_NEW_ENTRY
) {

791 
	`íåy_ª£t
(&
ps
->
e
);

792 
ps
->
e
.
löe_no
 =Ös->line_no;

793 
ps
->
e
.
löe
 =Ös->line;

795 
	`PFSM_COND_MOVE
(
ps
->
t
 =
TOKEN_ARROW
, 
PS_RULE_PURE_ACTION
);

797 
ps
->
îr
 = 
	`íåy_£t_fú°_tokí
(&ps->
e
,Ös->
lô
,Ös->
lô_Àn
);

798 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

800 
	`PFSM_MOVE
(
PS_PLAIN_OR_RULE
);

803 
	`FSM_STATE
(
PS_PLAIN_OR_RULE
) {

804 
	`PFSM_COND_MOVE
(
ps
->
t
 =
TOKEN_DEQSIGN
 ||

805 
ps
->
t
 =
TOKEN_NEQSIGN
,

806 
PS_RULE_COND
);

807 
ps
->
îr
 = 
	`íåy_£t_«me
(&ps->
e
);

808 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

809 
	`FSM_JMP
(
PS_VAL_OR_ATTR
);

812 
	`FSM_STATE
(
PS_RULE_COND
) {

813 
	`PFSM_COND_JMP_EXIT_ERROR
(
ps
->
t
 !
TOKEN_LITERAL
);

814 
ps
->
îr
 = 
	`íåy_£t_c⁄d
(&ps->
e
,Ös->
¥ev_t
,Ös->
lô
,

815 
ps
->
lô_Àn
);

816 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

817 
	`PFSM_MOVE
(
PS_RULE_COND_END
);

820 
	`FSM_STATE
(
PS_RULE_COND_END
) {

821 
	`PFSM_COND_JMP_EXIT_ERROR
(
ps
->
t
 !
TOKEN_ARROW
);

822 
	`PFSM_MOVE
(
PS_RULE_ACTION
);

825 
	`FSM_STATE
(
PS_RULE_PURE_ACTION
) {

826 
ps
->
îr
 = 
	`íåy_£t_«me
(&ps->
e
);

827 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

828 
	`FSM_JMP
(
PS_RULE_ACTION
);

831 
	`FSM_STATE
(
PS_RULE_ACTION
) {

832 
	`PFSM_COND_JMP_EXIT_ERROR
(
ps
->
t
 !
TOKEN_LITERAL
);

833 
ps
->
îr
 = 
	`íåy_add_ruÀ_∑øm
(&ps->
e
.
ruÀ
.
a˘
,Ös->
lô
,

834 
ps
->
lô_Àn
);

835 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

836 
	`PFSM_MOVE
(
PS_RULE_ACTION_VAL
);

839 
	`FSM_STATE
(
PS_RULE_ACTION_VAL
) {

840 
	`FSM_COND_JMP
(
ps
->
t
 =
TOKEN_SEMICOLON
, 
PS_SEMICOLON
);

841 
	`PFSM_COND_JMP_EXIT_ERROR
(
ps
->
t
 !
TOKEN_EQSIGN
);

842 
	`ªad_√xt_tokí
(
ps
);

843 
	`PFSM_COND_JMP_EXIT_ERROR
(
ps
->
t
 !
TOKEN_LITERAL
);

845 
ps
->
îr
 = 
	`íåy_add_ruÀ_∑øm
(&ps->
e
.
ruÀ
.
vÆ
,Ös->
lô
,

846 
ps
->
lô_Àn
);

847 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

849 
	`ªad_√xt_tokí
(
ps
);

850 
	`PFSM_COND_JMP_EXIT_ERROR
(
ps
->
t
 !
TOKEN_SEMICOLON
);

851 
	`FSM_JMP
(
PS_SEMICOLON
);

868 
	`FSM_STATE
(
PS_VAL_OR_ATTR
) {

869 
	`PFSM_COND_MOVE
(
ps
->
t
 =
TOKEN_LITERAL
, 
PS_MAYBE_EQSIGN
);

870 
	`FSM_COND_JMP
(
ps
->
t
 =
TOKEN_SEMICOLON
, 
PS_SEMICOLON
);

871 
	`FSM_COND_JMP
(
ps
->
t
 =
TOKEN_LBRACE
, 
PS_LBRACE
);

873 
ps
->
îr
 = -
EINVAL
;

874 
	`FSM_JMP
(
PS_EXIT
);

877 
	`FSM_STATE
(
PS_MAYBE_EQSIGN
) {

878 
	`FSM_COND_JMP
(
ps
->
t
 =
TOKEN_EQSIGN
, 
PS_STORE_ATTR_PREV
);

879 
	`FSM_JMP
(
PS_STORE_VAL_PREV
);

882 
	`FSM_STATE
(
PS_STORE_VAL_PREV
) {

886 
	`TFW_DBG3
("add vÆue: %.*s\n", 
ps
->
¥ev_lô_Àn
,Ös->
¥ev_lô
);

888 
ps
->
îr
 = 
	`íåy_add_vÆ
(&ps->
e
,Ös->
¥ev_lô
,Ös->
¥ev_lô_Àn
);

889 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

891 
	`FSM_JMP
(
PS_VAL_OR_ATTR
);

894 
	`FSM_STATE
(
PS_STORE_ATTR_PREV
) {

898 c⁄° *
key
, *
vÆ
;

899 
key_Àn
, 
vÆ_Àn
;

901 
key
 = 
ps
->
¥ev_lô
;

902 
key_Àn
 = 
ps
->
¥ev_lô_Àn
;

903 
	`ªad_√xt_tokí
(
ps
);

904 
vÆ
 = 
ps
->
lô
;

905 
vÆ_Àn
 = 
ps
->
lô_Àn
;

907 
	`TFW_DBG3
("addáâr: %.*†%.*s\n", 
key_Àn
, 
key
, 
vÆ_Àn
, 
vÆ
);

909 
ps
->
îr
 = 
	`íåy_add_©å
(&ps->
e
, 
key
, 
key_Àn
, 
vÆ
, 
vÆ_Àn
);

910 
	`FSM_COND_JMP
(
ps
->
îr
, 
PS_EXIT
);

912 
	`PFSM_MOVE
(
PS_VAL_OR_ATTR
);

915 
	`FSM_STATE
(
PS_LBRACE
) {

919 
ps
->
e
.
have_chûdªn
 = 
åue
;

920 
	`FSM_JMP
(
PS_EXIT
);

923 
	`FSM_STATE
(
PS_SEMICOLON
) {

927 
	`ªad_√xt_tokí
(
ps
);

928 
	`FSM_JMP
(
PS_EXIT
);

931 
	`FSM_STATE
(
PS_EXIT
) {

933 
	`TFW_DBG3
("pfsm:Éxit\n");

935 
	}
}

948 
TfwCfgS≥c
 *

949 
	$•ec_föd
(
TfwCfgS≥c
 
•ecs
[], c⁄° *
«me
)

951 
TfwCfgS≥c
 *
•ec
;

953 
	`TFW_CFG_FOR_EACH_SPEC
(
•ec
, 
•ecs
) {

954 i‡(!
	`°rcmp
(
•ec
->
«me
,Çame))

955  
•ec
;

958  
NULL
;

959 
	}
}

962 
	$__•ec_°¨t_h™dlög
(
TfwCfgS≥c
 *
∑ª¡
, TfwCfgS≥¯
•ecs
[])

964 
TfwCfgS≥c
 *
•ec
;

966 
	`BUG_ON
(!
•ecs
);

968 
	`TFW_CFG_FOR_EACH_SPEC
(
•ec
, 
•ecs
) {

969 
	`BUG_ON
(!
•ec
->
«me
);

970 
	`BUG_ON
(!*
•ec
->
«me
);

971 
	`BUG_ON
(!
	`check_idítifõr
(
•ec
->
«me
, 
	`°æí
(spec->name)));

972 
	`BUG_ON
(!
•ec
->
h™dÀr
);

973 i‡(
•ec
->
h™dÀr
 =&
tfw_cfg_h™dÀ_chûdªn
)

974 
	`BUG_ON
(!
•ec
->
˛ónup
);

975 i‡(
∑ª¡
 && !∑ª¡->
Ælow_ªc⁄fig
 && 
•ec
->allow_reconfig) {

976 
	`TFW_WARN_NL
("Directive '%s' doesn'tállow "

979 
∑ª¡
->
«me
, 
•ec
->name);

980  -
EINVAL
;

982 
•ec
->
__ˇŒed_now
 = 
Ál£
;

986 
	}
}

989 
	$•ec_°¨t_h™dlög
(
TfwCfgS≥c
 
•ecs
[])

991 
	`__•ec_°¨t_h™dlög
(
NULL
, 
•ecs
);

992 
	}
}

995 
	$•ec_h™dÀ_íåy
(
TfwCfgS≥c
 *
•ec
, 
TfwCfgE¡ry
 *
∑r£d_íåy
)

997 
r
;

998 
boﬁ
 
d⁄t_ªc⁄fig
 = 
	`tfw_run°©e_is_ªc⁄fig
(Ë&& !
•ec
->
Ælow_ªc⁄fig
;

1000 i‡(!
•ec
->
Ælow_ª≥©
 && s≥c->
__ˇŒed_now
) {

1001 
	`TFW_ERR_NL
("duplicateÉntry: '%s', only one suchÉntry is"

1002 "áŒowed.\n", 
∑r£d_íåy
->
«me
);

1003  -
EINVAL
;

1005 
•ec
->
__ˇŒed_now
 = 
åue
;

1012 i‡(
d⁄t_ªc⁄fig
 && (
•ec
->
h™dÀr
 !&
tfw_cfg_h™dÀ_chûdªn
)) {

1013 
	`TFW_DBG2
("skù s≥¯'%s':Ñec⁄figÇŸáŒowed\n", 
•ec
->
«me
);

1016 
	`TFW_DBG2
("•e¯h™dÀ: '%s'\n", 
•ec
->
«me
);

1017 
r
 = 
•ec
->
	`h™dÀr
(•ec, 
∑r£d_íåy
);

1018 i‡(
d⁄t_ªc⁄fig
) {

1019 
	`TFW_DBG2
("•e¯'%s' skù≥d:Ñec⁄figÇŸáŒowed\n", 
•ec
->
«me
);

1020  
r
;

1023 
•ec
->
__ˇŒed_cfg
 = 
åue
;

1024 i‡(
r
)

1025 
	`TFW_DBG
("c⁄figuøti⁄ h™dÀ∏ªtu∫edÉº‹: %d\n", 
r
);

1027  
r
;

1028 
	}
}

1038 
	$•ec_h™dÀ_deÁu…
(
TfwCfgS≥c
 *
•ec
)

1040 
Àn
, 
r
;

1041 
Áke_íåy_buf
[
PAGE_SIZE
];

1042 
TfwCfgP¨£rSèã
 
ps
;

1044 
Àn
 = 
	`¢¥ötf
(
Áke_íåy_buf
, (fake_entry_buf), "%s %s;",

1045 
•ec
->
«me
, s≥c->
deÊt
);

1046 
	`BUG_ON
(
Àn
 >(
Áke_íåy_buf
));

1048 
	`TFW_DBG2
("u£ deÁu…É¡ry: '%s'\n", 
Áke_íåy_buf
);

1050 
	`mem£t
(&
ps
, 0, (ps));

1051 
ps
.
löe
 =Ös.
ö
 =Ös.
pos
 = 
Áke_íåy_buf
;

1052 
	`∑r£_cfg_íåy
(&
ps
);

1053 
	`BUG_ON
(!
ps
.
e
.
«me
);

1054 
	`BUG_ON
(
ps
.
îr
);

1055 
	`BUG_ON
(
ps
.
t
 !
TOKEN_NA
);

1057 
ps
.
e
.
dÊt_vÆue
 = 
åue
;

1058 
r
 = 
	`•ec_h™dÀ_íåy
(
•ec
, &
ps
.
e
);

1059 
	`íåy_ª£t
(&
ps
.
e
);

1060  
r
;

1061 
	}
}

1063 
•ec_föish_h™dlög
(
TfwCfgS≥c
 
•ecs
[]);

1066 
	$•ec_h™dÀ_deÁu…_£˘i⁄
(
TfwCfgS≥c
 *
•ec
)

1068 i‡(
•ec
->
h™dÀr
 !
tfw_cfg_h™dÀ_chûdªn
)

1070 
	`TFW_DBG2
("u£ deÁu… vÆue†f‹ se˘i⁄ '%s'\n", 
•ec
->
«me
);

1071 i‡(
•ec
->
de°
 =
NULL
)

1073  
	`•ec_föish_h™dlög
(
•ec
->
de°
);

1074 
	}
}

1077 
	$•ec_föish_h™dlög
(
TfwCfgS≥c
 
•ecs
[])

1079 
r
;

1080 
TfwCfgS≥c
 *
•ec
;

1093 
	`TFW_CFG_FOR_EACH_SPEC
(
•ec
, 
•ecs
) {

1094 i‡(
•ec
->
__ˇŒed_now
)

1096 i‡(
•ec
->
h™dÀr
 =
tfw_cfg_h™dÀ_chûdªn
) {

1097 i‡(!
•ec
->
Ælow_n⁄e
)

1099 i‡((
r
 = 
	`•ec_h™dÀ_deÁu…_£˘i⁄
(
•ec
)))

1100 
îr_dÊt_vÆ
;

1101 } i‡(
•ec
->
deÊt
) {

1102 i‡((
r
 = 
	`•ec_h™dÀ_deÁu…
(
•ec
)))

1103 
îr_dÊt_vÆ
;

1104 } i‡(!
•ec
->
Ælow_n⁄e
) {

1106 
îr_no_íåy
;

1112 
îr_no_íåy
:

1113 
	`TFW_ERR_NL
("thêªquúedÉ¡ry i†nŸ found: '%s'\n", 
•ec
->
«me
);

1114  -
EINVAL
;

1116 
îr_dÊt_vÆ
:

1117 
	`TFW_ERR_NL
("Eº‹ h™dlög deÁu… vÆuêf‹: '%s'\n", 
•ec
->
«me
);

1118  
r
;

1119 
	}
}

1122 
	$•ec_˛ónup
(
TfwCfgS≥c
 
•ecs
[])

1124 
TfwCfgS≥c
 *
•ec
;

1125 
boﬁ
 
ˇŒed
, 
ªc⁄fig
 = 
	`tfw_run°©e_is_ªc⁄fig
();

1127 
	`TFW_CFG_FOR_EACH_SPEC
(
•ec
, 
•ecs
) {

1128 
ˇŒed
 = 
•ec
->
__ˇŒed_cfg
;

1129 
•ec
->
__ˇŒed_cfg
 = 
Ál£
;

1130 i‡(!
ªc⁄fig
) {

1131 
ˇŒed
 |
•ec
->
__ˇŒed_evî
;

1132 
•ec
->
__ˇŒed_evî
 = 
Ál£
;

1134 i‡(
ˇŒed
 && 
•ec
->
˛ónup
) {

1135 
	`TFW_DBG2
("%s: '%s'\n", 
__func__
, 
•ec
->
«me
);

1136 
•ec
->
	`˛ónup
(spec);

1139 
	}
}

1149 
	$tfw_cfg_m≠_íum
(c⁄° 
TfwCfgEnum
 
m≠pögs
[],

1150 c⁄° *
ö_«me
, *
out_öt
)

1152 *
out
;

1153 c⁄° 
TfwCfgEnum
 *
pos
;

1160 íum { 
_DUMMY
 } 
	t_dummy
;

1161 
	`BUILD_BUG_ON
((
_dummy
) != ());

1163 
	`BUG_ON
(!
m≠pögs
);

1164 
	`BUG_ON
(!
ö_«me
);

1165 
	`BUG_ON
(!
out_öt
);

1167 
pos
 = 
m≠pögs
;Öos->
«me
; ++pos) {

1168 
	`BUG_ON
(!
	`check_idítifõr
(
pos
->
«me
, 
	`°æí
(pos->name)));

1169 i‡(!
	`°rˇ£cmp
(
ö_«me
, 
pos
->
«me
)) {

1170 
out
 = 
out_öt
;

1171 *
out
 = 
pos
->
vÆue
;

1176  -
EINVAL
;

1177 
	}
}

1178 
EXPORT_SYMBOL
(
tfw_cfg_m≠_íum
);

1185 
	$tfw_cfg_gë_©å
(c⁄° 
TfwCfgE¡ry
 *
e
, c⁄° *
©å_key
,

1186 c⁄° *
deÁu…_vÆ
)

1188 
size_t
 
i
;

1189 c⁄° *
key
, *
vÆ
;

1191 
	`TFW_CFG_ENTRY_FOR_EACH_ATTR
(
e
, 
i
, 
key
, 
vÆ
) {

1192 i‡(!
	`°rˇ£cmp
(
key
, 
©å_key
))

1193  
vÆ
;

1196  
deÁu…_vÆ
;

1197 
	}
}

1198 
EXPORT_SYMBOL
(
tfw_cfg_gë_©å
);

1205 
	$tfw_cfg_check_ønge
(
vÆue
, 
mö
, 
max
)

1207 i‡(
mö
 !
max
 && (
vÆue
 < min || value > max)) {

1208 
	`TFW_ERR_NL
("the value %ld is out ofÑange: [%ld, %ld]\n",

1209 
vÆue
, 
mö
, 
max
);

1210  -
EINVAL
;

1213 
	}
}

1214 
EXPORT_SYMBOL
(
tfw_cfg_check_ønge
);

1221 
	$tfw_cfg_check_mu…ùÀ_of
(
vÆue
, 
divis‹
)

1223 i‡(
divis‹
 && (
vÆue
 % divisor)) {

1224 
	`TFW_ERR_NL
("the value of %ld isÇotá multiple of %d\n",

1225 
vÆue
, 
divis‹
);

1226  -
EINVAL
;

1229 
	}
}

1230 
EXPORT_SYMBOL
(
tfw_cfg_check_mu…ùÀ_of
);

1236 
	$tfw_cfg_check_vÆ_n
(c⁄° 
TfwCfgE¡ry
 *
e
, 
vÆ_n
)

1238 i‡(
e
->
vÆ_n
 != val_n) {

1239 
	`TFW_ERR_NL
("invalidÇumber of values;Éxpected: %d, got: %zu\n",

1240 
vÆ_n
, 
e
->val_n);

1241  -
EINVAL
;

1244 
	}
}

1245 
EXPORT_SYMBOL
(
tfw_cfg_check_vÆ_n
);

1257 
	$tfw_cfg_check_sögÀ_vÆ
(c⁄° 
TfwCfgE¡ry
 *
e
)

1259 
r
 = -
EINVAL
;

1261 i‡(
e
->
vÆ_n
 == 0)

1262 
	`TFW_ERR_NL
("no value specified\n");

1263 i‡(
e
->
vÆ_n
 > 1)

1264 
	`TFW_ERR_NL
("moreÅhan one value specified\n");

1265 i‡(
e
->
©å_n
)

1266 
	`TFW_ERR_NL
("unexpectedáttributes\n");

1267 i‡(
e
->
have_chûdªn
)

1268 
	`TFW_ERR_NL
("unexpected childrenÉntries\n");

1270 
r
 = 0;

1272  
r
;

1273 
	}
}

1274 
EXPORT_SYMBOL
(
tfw_cfg_check_sögÀ_vÆ
);

1287 
	$dëe˘_ba£
(c⁄° **
pos
)

1289 c⁄° *
°r
 = *
pos
;

1290 
size_t
 
Àn
 = 
	`°æí
(
°r
);

1292 i‡(!
Àn
)

1295 i‡(
Àn
 > 2 && 
°r
[0] ='0' && 
	`ißÕha
(str[1])) {

1296 
c
 = 
	`tﬁowî
(
°r
[1]);

1298 (*
pos
) += 2;

1300 i‡(
c
 == 'x')

1302 i‡(
c
 == 'b')

1309 
	}
}

1312 
	$tfw_cfg_∑r£_öt
(c⁄° *
s
, *
out_öt
)

1314 
ba£
 = 
	`dëe˘_ba£
(&
s
);

1315 i‡(!
ba£
)

1316  -
EINVAL
;

1317  
	`k°πoöt
(
s
, 
ba£
, 
out_öt
);

1318 
	}
}

1319 
EXPORT_SYMBOL
(
tfw_cfg_∑r£_öt
);

1322 
	$tfw_cfg_∑r£_uöt
(c⁄° *
s
, *
out_uöt
)

1324 
ba£
 = 
	`dëe˘_ba£
(&
s
);

1326 i‡(!
ba£
)

1327  -
EINVAL
;

1328  
	`k°πouöt
(
s
, 
ba£
, 
out_uöt
);

1329 
	}
}

1330 
EXPORT_SYMBOL
(
tfw_cfg_∑r£_uöt
);

1336 
	#KSTRTOX_OVERFLOW
 (1U << 31)

	)

1339 
	$_∑r£_öãgî
(c⁄° *
s
, 
ba£
, *
p
)

1341 
ªs
;

1342 
rv
;

1344 
ªs
 = 0;

1345 
rv
 = 0;

1347 
c
 = *
s
;

1348 
lc
 = 
c
 | 0x20;

1349 
vÆ
;

1351 i‡('0' <
c
 && c <= '9')

1352 
vÆ
 = 
c
 - '0';

1353 i‡('a' <
lc
 &&Üc <= 'f')

1354 
vÆ
 = 
lc
 - 'a' + 10;

1358 i‡(
vÆ
 >
ba£
)

1364 i‡(
	`u∆ikñy
(
ªs
 & (~0ull << 60))) {

1365 i‡(
ªs
 > 
	`div_u64
(
ULLONG_MAX
 - 
vÆ
, 
ba£
))

1366 
rv
 |
KSTRTOX_OVERFLOW
;

1368 
ªs
 =Ñe†* 
ba£
 + 
vÆ
;

1369 
rv
++;

1370 
s
++;

1372 *
p
 = 
ªs
;

1374  
rv
;

1375 
	}
}

1378 
	$tfw_cfg_∑r£_ötvl
(c⁄° *
°r
, *
i0
, *
i1
)

1380 c⁄° *
s
 = 
°r
;

1381 *
v
 = 
i0
;

1382 
r
;

1383 
ba£
;

1385 *
s
) {

1386 i‡(*
s
 == '-') {

1387 i‡(
v
 =
i1
) {

1388 
	`TFW_ERR_NL
("Bad interval delimiter\n");

1389  -
EINVAL
;

1391 
v
 = 
i1
;

1392 ++
s
;

1396 
ba£
 = 
	`dëe˘_ba£
(&
s
);

1397 i‡(!
ba£
)

1398  -
EINVAL
;

1399 
r
 = 
	`_∑r£_öãgî
(
s
, 
ba£
, 
v
);

1400 i‡(!
r
 ||Ñ & 
KSTRTOX_OVERFLOW
) {

1401 
	`TFW_ERR_NL
("Bad integer\n");

1402  -
EINVAL
;

1404 i‡(
v
 =
i1
 && *
i0
 >= *i1) {

1405 
	`TFW_ERR
("Interval bound crossing\n");

1406  -
EINVAL
;

1409 
s
 +
r
;

1411 i‡(
v
 =
i1
 && !*v) {

1412 
	`TFW_ERR_NL
("ZîÿöãrvÆÜe· bound i¿'%s'\n", 
°r
);

1413  -
EINVAL
;

1417 
	}
}

1418 
EXPORT_SYMBOL
(
tfw_cfg_∑r£_ötvl
);

1421 
	$tfw_cfg_˛ónup_chûdªn
(
TfwCfgS≥c
 *
cs
)

1423 
TfwCfgS≥c
 *
√°ed_•ecs
 = 
cs
->
de°
;

1424 
	`•ec_˛ónup
(
√°ed_•ecs
);

1425 
	}
}

1426 
EXPORT_SYMBOL
(
tfw_cfg_˛ónup_chûdªn
);

1451 
	$tfw_cfg_h™dÀ_chûdªn
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

1453 
TfwCfgP¨£rSèã
 *
ps
 = 
	`c⁄èöî_of
(
e
, TfwCfgParserState,É);

1454 
TfwCfgS≥cChûd
 *
c£
 = 
cs
->
•ec_ext
;

1455 
TfwCfgS≥c
 *
√°ed_•ecs
 = 
cs
->
de°
;

1456 
TfwCfgS≥c
 *
m©chög_•ec
;

1457 
ªt
;

1458 
boﬁ
 
run_hooks
 = !
	`tfw_run°©e_is_ªc⁄fig
(Ë|| 
cs
->
Ælow_ªc⁄fig
;

1460 
	`BUG_ON
(!
√°ed_•ecs
);

1461 
	`BUG_ON
(!
cs
->
˛ónup
);

1463 i‡(!
e
->
have_chûdªn
) {

1464 
	`TFW_ERR_NL
("theÉntry hasÇoÇested childrenÉntries\n");

1465  -
EINVAL
;

1469 
ªt
 = (
run_hooks
 && 
c£
 && c£->
begö_hook
Ë? c£->
	`begö_hook
(
cs
, 
e
) : 0;

1470 i‡(
ªt
)

1471  
ªt
;

1474 i‡((
ªt
 = 
	`__•ec_°¨t_h™dlög
(
cs
, 
√°ed_•ecs
)))

1475  
ªt
;

1481 
	`BUG_ON
(
ps
->
t
 !
TOKEN_LBRACE
);

1483 
	`ªad_√xt_tokí
(
ps
);

1484 i‡(
ps
->
îr
)

1485  
ps
->
îr
;

1488 
ps
->
t
 && (ps->à!
TOKEN_RBRACE
)) {

1489 
	`∑r£_cfg_íåy
(
ps
);

1490 i‡(
ps
->
îr
) {

1491 
	`TFW_ERR_NL
("parserÉrror\n");

1492  
ps
->
îr
;

1495 
m©chög_•ec
 = 
	`•ec_föd
(
√°ed_•ecs
, 
ps
->
e
.
«me
);

1496 i‡(!
m©chög_•ec
) {

1497 
	`TFW_ERR_NL
("d⁄'àknow howÅÿh™dÀ: %s\n", 
ps
->
e
.
«me
);

1498  -
EINVAL
;

1501 
ªt
 = 
	`•ec_h™dÀ_íåy
(
m©chög_•ec
, &
ps
->
e
);

1502 i‡(
ªt
)

1503  
ªt
;

1504 
	`íåy_ª£t
(&
ps
->
e
);

1512 i‡(
ps
->
t
 !
TOKEN_RBRACE
) {

1513 
	`TFW_ERR_NL
("%s: Missög closög bø˚.\n", 
cs
->
«me
);

1514  -
EINVAL
;

1517 
	`ªad_√xt_tokí
(
ps
);

1518 i‡(
ps
->
îr
)

1519  
ps
->
îr
;

1520 
ªt
 = 
	`•ec_föish_h™dlög
(
√°ed_•ecs
);

1521 i‡(
ªt
)

1522  
ªt
;

1525 
ªt
 = (
run_hooks
 && 
c£
 && c£->
föish_hook
Ë? c£->
	`föish_hook
(
cs
) : 0;

1526  
ªt
;

1527 
	}
}

1528 
EXPORT_SYMBOL
(
tfw_cfg_h™dÀ_chûdªn
);

1531 
	$tfw_cfg_£t_boﬁ
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

1533 
boﬁ
 
is_åue
, 
is_Ál£
;

1534 
boﬁ
 *
de°_boﬁ
 = 
cs
->
de°
;

1535 c⁄° *
ö_°r
 = 
e
->
vÆs
[0];

1537 
	`BUG_ON
(!
de°_boﬁ
);

1546 i‡(!
e
->
vÆ_n
 && !e->
©å_n
 && !e->
have_chûdªn
) {

1547 *
de°_boﬁ
 = 
åue
;

1555 i‡(
	`tfw_cfg_check_sögÀ_vÆ
(
e
))

1556  -
EINVAL
;

1558 
is_åue
 = !
	`°rˇ£cmp
(
ö_°r
, "1")

1559 || !
	`°rˇ£cmp
(
ö_°r
, "y")

1560 || !
	`°rˇ£cmp
(
ö_°r
, "on")

1561 || !
	`°rˇ£cmp
(
ö_°r
, "yes")

1562 || !
	`°rˇ£cmp
(
ö_°r
, "true")

1563 || !
	`°rˇ£cmp
(
ö_°r
, "enable");

1565 
is_Ál£
 = !
	`°rˇ£cmp
(
ö_°r
, "0")

1566 || !
	`°rˇ£cmp
(
ö_°r
, "n")

1567 || !
	`°rˇ£cmp
(
ö_°r
, "off")

1568 || !
	`°rˇ£cmp
(
ö_°r
, "no")

1569 || !
	`°rˇ£cmp
(
ö_°r
, "false")

1570 || !
	`°rˇ£cmp
(
ö_°r
, "disable");

1572 
	`BUG_ON
(
is_åue
 && 
is_Ál£
);

1573 i‡(!
is_åue
 && !
is_Ál£
) {

1574 
	`TFW_ERR_NL
("övÆid boﬁó¿vÆue: '%s'\n", 
ö_°r
);

1575  -
EINVAL
;

1578 *
de°_boﬁ
 = 
is_åue
;

1580 
	}
}

1581 
EXPORT_SYMBOL
(
tfw_cfg_£t_boﬁ
);

1584 
	$tfw_cfg_£t_öt
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

1586 
r
, 
vÆ
;

1587 *
de°_öt
;

1588 c⁄° *
ö_°r
;

1589 
TfwCfgS≥cI¡
 *
c£
;

1591 
	`BUG_ON
(!
cs
->
de°
);

1593 i‡((
r
 = 
	`tfw_cfg_check_sögÀ_vÆ
(
e
)))

1594 
îr
;

1597 
ö_°r
 = 
e
->
vÆs
[0];

1598 
c£
 = 
cs
->
•ec_ext
;

1599 i‡(
c£
 && c£->
íums
) {

1600 
r
 = 
	`tfw_cfg_m≠_íum
(
c£
->
íums
, 
ö_°r
, &
vÆ
);

1601 i‡(!
r
)

1602 
vÆ_is_∑r£d
;

1605 
r
 = 
	`tfw_cfg_∑r£_öt
(
ö_°r
, &
vÆ
);

1606 i‡(
r
)

1607 
îr
;

1609 
vÆ_is_∑r£d
:

1611 i‡(
c£
) {

1612 
r
 = 
	`tfw_cfg_check_mu…ùÀ_of
(
vÆ
, 
c£
->
mu…ùÀ_of
);

1613 
r
 |
	`tfw_cfg_check_ønge
(
vÆ
, 
c£
->
ønge
.
mö
, c£->ønge.
max
);

1614 i‡(
r
)

1615 
îr
;

1618 
de°_öt
 = 
cs
->
de°
;

1619 *
de°_öt
 = 
vÆ
;

1622 
îr
:

1623 
	`TFW_ERR_NL
("can'tÖarse integer");

1624  -
EINVAL
;

1625 
	}
}

1626 
EXPORT_SYMBOL
(
tfw_cfg_£t_öt
);

1629 
	$tfw_cfg_˛ónup_°r
(
TfwCfgS≥c
 *
cs
)

1631 **
°Ω
 = 
cs
->
de°
;

1632 *
°r
 = *
°Ω
;

1635 
	`BUG_ON
(!
°r
);

1636 
	`k‰ì
(
°r
);

1637 *
°Ω
 = 
NULL
;

1638 
cs
->
˛ónup
 = 
NULL
;

1639 
	}
}

1641 
boﬁ


1642 
	$is_m©chög_to_c£t
(c⁄° *
p
, c⁄° *
c£t
)

1644 *
p
) {

1645 i‡(!
	`°rchr
(
c£t
, *
p
))

1646  
Ál£
;

1647 ++
p
;

1649  
åue
;

1650 
	}
}

1653 
	$tfw_cfg_£t_°r
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

1655 c⁄° **
de°_°Ω
;

1656 
r
;

1658 
	`BUG_ON
(!
cs
);

1659 
	`BUG_ON
(!
cs
->
de°
);

1660 
	`BUG_ON
(
cs
->
˛ónup
);

1662 
r
 = 
	`tfw_cfg_check_sögÀ_vÆ
(
e
);

1663 i‡(
r
)

1664  
r
;

1666 i‡(
cs
->
•ec_ext
) {

1667 
TfwCfgS≥cSå
 *
c£
 = 
cs
->
•ec_ext
;

1668 c⁄° *
°r
, *
c£t
;

1669 
mö
, 
max
, 
Àn
;

1671 
°r
 = 
e
->
vÆs
[0];

1672 
Àn
 = 
	`°æí
(
°r
);

1674 
mö
 = 
c£
->
Àn_ønge
.min;

1675 
max
 = 
c£
->
Àn_ønge
.max;

1676 i‡(
mö
 !
max
 && (
Àn
 < min ||Üen > max)) {

1677 
	`TFW_ERR_NL
("the stringÜength (%d) is out of valid "

1678 "øngê(%d, %d): '%s'\n", 
Àn
, 
mö
, 
max
,

1679 
°r
);

1680  -
EINVAL
;

1683 
c£t
 = 
c£
->cset;

1684 i‡(
c£t
 && !
	`is_m©chög_to_c£t
(
°r
, cset)) {

1685 
	`TFW_ERR_NL
("övÆid ch¨a˘î†found: '%s'\n", 
°r
);

1686  -
EINVAL
;

1692 
de°_°Ω
 = 
cs
->
de°
;

1693 *
de°_°Ω
 = 
e
->
vÆs
[0];

1694 
e
->
vÆs
[0] = 
NULL
;

1695 
cs
->
˛ónup
 = 
tfw_cfg_˛ónup_°r
;

1698 
	}
}

1699 
EXPORT_SYMBOL
(
tfw_cfg_£t_°r
);

1710 *
	gtfw_cfg_∑th
 = 
TFW_CFG_PATH
;

1711 
moduÀ_∑øm
(
tfw_cfg_∑th
, 
ch¨p
, 0444);

1712 
MODULE_PARM_DESC
(
tfw_cfg_∑th
, "PathÅo Tempesta FW configuration file."

1716 
	$¥öt_∑r£_îr‹
(c⁄° 
TfwCfgP¨£rSèã
 *
ps
)

1718 
Àn
 = 0;

1719 c⁄° *
ticks
 = "^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"

1721 c⁄° * 
eos
 = 
NULL
;

1727 i‡(!
ps
->
e
.
löe
) {

1728 
	`TFW_ERR_NL
("configurationÖarsingÉrror\n");

1732 
eos
 = 
	`°rch∫ul
(
ps
->
e
.
löe
, '\n');

1733 
Àn
 = 
	`mö
(80, ()(
eos
 - 
ps
->
e
.
löe
));

1734 
	`TFW_ERR_NL
("configurationÖarsingÉrror:\n"

1737 
ps
->
e
.
löe_no
 + 1, 
Àn
,Ös->e.
löe
,Üí, 
ticks
);

1738 
	}
}

1745 
TfwCfgS≥c
 *

1746 
	$tfw_cfg_•ec_föd
(
TfwCfgS≥c
 
•ecs
[], c⁄° *
«me
)

1748  
	`•ec_föd
(
•ecs
, 
«me
);

1749 
	}
}

1750 
EXPORT_SYMBOL
(
tfw_cfg_•ec_föd
);

1760 
	$tfw_cfg_∑r£_mods
(c⁄° *
cfg_ãxt
, 
li°_hód
 *
mod_li°
)

1762 
TfwCfgP¨£rSèã
 
ps
 = {

1763 .
ö
 = 
cfg_ãxt
,

1764 .
pos
 = 
cfg_ãxt
,

1765 .
löe
 = 
cfg_ãxt


1767 
TfwMod
 *
mod
;

1768 
TfwCfgS≥c
 *
m©chög_•ec
 = 
NULL
;

1769 
r
 = -
EINVAL
;

1771 
	`MOD_FOR_EACH
(
mod
, 
mod_li°
) {

1772 
	`•ec_°¨t_h™dlög
(
mod
->
•ecs
);

1776 
	`∑r£_cfg_íåy
(&
ps
);

1777 i‡(
ps
.
îr
) {

1778 
	`TFW_ERR_NL
("syntaxÉrror\n");

1779 
îr
;

1781 i‡(!
ps
.
e
.
«me
)

1784 
	`MOD_FOR_EACH
(
mod
, 
mod_li°
) {

1785 
m©chög_•ec
 = 
	`•ec_föd
(
mod
->
•ecs
, 
ps
.
e
.
«me
);

1786 i‡(
m©chög_•ec
)

1789 i‡(!
m©chög_•ec
) {

1790 
	`TFW_ERR_NL
("d⁄'àknow howÅÿh™dÀ: '%s'\n", 
ps
.
e
.
«me
);

1791 
îr
;

1794 
r
 = 
	`•ec_h™dÀ_íåy
(
m©chög_•ec
, &
ps
.
e
);

1795 i‡(
r
)

1796 
îr
;

1797 
	`íåy_ª£t
(&
ps
.
e
);

1799 
	`tfw_§v_lo›_sched_rcu
();

1800 } 
ps
.
t
);

1802 
	`MOD_FOR_EACH
(
mod
, 
mod_li°
) {

1803 
r
 = 
	`•ec_föish_h™dlög
(
mod
->
•ecs
);

1804 i‡(
r
)

1805 
îr
;

1809 
îr
:

1810 
	`¥öt_∑r£_îr‹
(&
ps
);

1811 
	`íåy_ª£t
(&
ps
.
e
);

1812  -
EINVAL
;

1813 
	}
}

1814 
EXPORT_SYMBOL
(
tfw_cfg_∑r£_mods
);

1820 
	$tfw_cfg_˛ónup
(
li°_hód
 *
mod_li°
)

1822 
TfwMod
 *
mod
;

1824 
	`TFW_DBG3
("Configuration cleanup...\n");

1825 
	`MOD_FOR_EACH_REVERSE
(
mod
, 
mod_li°
) {

1826 
	`•ec_˛ónup
(
mod
->
•ecs
);

1827 i‡(
mod
->
cfg˛ón
)

1828 
mod
->
	`cfg˛ón
();

1829 
	`tfw_§v_lo›_sched_rcu
();

1831 
	}
}

1834 
	$tfw_cfg_∑r£
(
li°_hód
 *
mod_li°
)

1836 
ªt
;

1837 
size_t
 
fûe_size
 = 0;

1838 *
cfg_ãxt_buf
;

1840 
	`TFW_DBG3
("reading configuration file...\n");

1841 i‡(!(
cfg_ãxt_buf
 = 
	`tfw_cfg_ªad_fûe
(
tfw_cfg_∑th
, &
fûe_size
)))

1842  -
ENOENT
;

1844 
	`TFW_DBG2
("parsing configurationándÖushing itÅo modules...\n");

1845 i‡((
ªt
 = 
	`tfw_cfg_∑r£_mods
(
cfg_ãxt_buf
, 
mod_li°
)))

1846 
	`TFW_DBG
("ErrorÖarsing configuration data\n");

1848 
	`‰ì_∑ges
(()
cfg_ãxt_buf
, 
	`gë_‹dî
(
fûe_size
));

1850  
ªt
;

1851 
	}
}

1854 
	$tfw_cfg_migøã_°©e
(
TfwCfgS≥c
 *
cs
)

1856 
TfwCfgS≥c
 *
•ec
;

1858 
	`TFW_CFG_FOR_EACH_SPEC
(
•ec
, 
cs
) {

1859 i‡(
•ec
->
__ˇŒed_cfg
)

1860 
•ec
->
__ˇŒed_evî
 = 
åue
;

1861 i‡(
•ec
->
h™dÀr
 =&
tfw_cfg_h™dÀ_chûdªn
)

1862 
	`tfw_cfg_migøã_°©e
(
•ec
->
de°
);

1863 
•ec
->
__ˇŒed_cfg
 = 
Ál£
;

1865 
	}
}

1868 
	$tfw_cfg_c⁄˛ude
(
li°_hód
 *
mod_li°
)

1870 
TfwMod
 *
mod
;

1872 
	`MOD_FOR_EACH
(
mod
, 
mod_li°
)

1873 
	`tfw_cfg_migøã_°©e
(
mod
->
•ecs
);

1874 
	}
}

1886 
	$tfw_cfg_ªad_fûe
(c⁄° *
∑th
, 
size_t
 *
fûe_size
)

1888 *
out_buf
;

1889 
fûe
 *
Â
;

1890 
ssize_t
 
byãs_ªad
;

1891 
size_t
 
ªad_size
, 
buf_size
;

1892 
loff_t
 
off
 = 0;

1893 
mm_£gmít_t
 
ﬁdfs
;

1895 i‡(!
∑th
 || !*path) {

1896 
	`TFW_ERR_NL
("can't open file withÉmptyÇame\n");

1897  
NULL
;

1900 
	`TFW_DBG2
("ªadög fûe: %s\n", 
∑th
);

1902 
ﬁdfs
 = 
	`gë_fs
();

1903 
	`£t_fs
(
	`gë_ds
());

1905 
Â
 = 
	`fûp_›í
(
∑th
, 
O_RDONLY
, 0);

1906 i‡(
	`IS_ERR_OR_NULL
(
Â
)) {

1907 
	`TFW_ERR_NL
("can't open file: %s (err: %ld)\n",

1908 
∑th
, 
	`PTR_ERR
(
Â
));

1909 
îr_›í
;

1912 
buf_size
 = 
Â
->
f_öode
->
i_size
;

1913 
	`TFW_DBG2
("fûêsize: %zu byãs\n", 
buf_size
);

1914 
buf_size
 += 1;

1915 *
fûe_size
 = 
buf_size
;

1917 
out_buf
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`gë_‹dî
(
buf_size
));

1918 i‡(!
out_buf
) {

1919 
	`TFW_ERR_NL
("can'tállocate memory\n");

1920 
îr_Æloc
;

1924 
	`TFW_DBG3
("ªad by off£t: %d\n", ()
off
);

1925 
ªad_size
 = 
	`mö
((
size_t
)(
buf_size
 - 
off
), 
PAGE_SIZE
);

1926 
byãs_ªad
 = 
	`kî√l_ªad
(
Â
, 
out_buf
 + 
off
, 
ªad_size
, &off);

1927 i‡(
byãs_ªad
 < 0) {

1928 
	`TFW_ERR_NL
("ˇn'àªad fûe: %†”º: %zu)\n", 
∑th
,

1929 
byãs_ªad
);

1930 
îr_ªad
;

1932 } 
byãs_ªad
);

1935 i‡(
buf_size
 - 
off
 - 1) {

1936 
	`TFW_ERR_NL
("fûêsizêch™ged durögÅhêªad: '%s'\n,", 
∑th
);

1937 
îr_ªad
;

1940 
	`fûp_˛o£
(
Â
, 
NULL
);

1942 
out_buf
[
off
] = '\0';

1943 
	`£t_fs
(
ﬁdfs
);

1944  
out_buf
;

1946 
îr_ªad
:

1947 
	`‰ì_∑ges
(()
out_buf
, 
	`gë_‹dî
(
buf_size
));

1948 
îr_Æloc
:

1949 
	`fûp_˛o£
(
Â
, 
NULL
);

1950 
îr_›í
:

1951 
	`£t_fs
(
ﬁdfs
);

1952  
NULL
;

1953 
	}
}

1956 
	$tfw_cfg_öô
()

1959 
	}
}

1966 
	$tfw_cfg_exô
()

1968 
	}
}

	@cfg.h

21 #i‚de‡
__TFW_CFG_H__


22 
	#__TFW_CFG_H__


	)

24 
	~<löux/li°.h
>

32 
	#TFW_CFG_PATH
 "/ëc/ãm≥°a/ãm≥°a_fw.c⁄f"

	)

48 
	#TFW_CFG_ENTRY_VAL_MAX
 16

	)

49 
	#TFW_CFG_ENTRY_ATTR_MAX
 16

	)

51 
	#TFW_CFG_RULE_NAME
 "ruÀ"

	)

127 c⁄° *
	mf°
;

128 c⁄° *
	m¢d
;

129 c⁄° *
	ma˘
;

130 c⁄° *
	mvÆ
;

131 
boﬁ
 
	möv
;

132 } 
	tTfwCfgRuÀ
;

136 
boﬁ
 
	mhave_chûdªn
 : 1;

137 
boﬁ
 
	mdÊt_vÆue
 : 1;

139 
size_t
 
	mvÆ_n
;

140 
size_t
 
	m©å_n
;

141 c⁄° *
	m«me
;

142 c⁄° *
	mvÆs
[
TFW_CFG_ENTRY_VAL_MAX
];

144 c⁄° *
	mkey
;

145 c⁄° *
	mvÆ
;

146 } 
	m©ås
[
TFW_CFG_ENTRY_ATTR_MAX
];

147 
TfwCfgRuÀ
 
	mruÀ
;

148 c⁄° *
	m·okí
;

149 
size_t
 
	mlöe_no
;

150 c⁄° *
	mlöe
;

151 } 
	tTfwCfgE¡ry
;

164 
	#TFW_CFG_ENTRY_FOR_EACH_ATTR
(
e
, 
idx
, 
k
, 
v
) \

165 (
idx
Ë0, (
k
Ë(
e
)->
©ås
[0].
key
, (
v
Ë”)->©ås[0].
vÆ
; \

166 (
idx
++Ë< (
e
)->
©å_n
; \

167 (
k
Ë(
e
)->
©ås
[(
idx
)].
key
, (
v
Ë”)->©ås[(idx)].
vÆ
)

	)

169 
	#TFW_CFG_ENTRY_FOR_EACH_VAL
(
e
, 
idx
, 
v
) \

170 (
idx
Ë0, (
v
Ë(
e
)->
vÆs
[0]; \

171 (
idx
Ë< (
e
)->
vÆ_n
; \

172 (
v
Ë(
e
)->
vÆs
[++(
idx
)])

	)

283 
TfwCfgS≥c
 
	tTfwCfgS≥c
;

284 
	sTfwCfgS≥c
 {

285 c⁄° *
	m«me
;

286 c⁄° *
	mdeÊt
;

287 (*
	mh™dÀr
)(
TfwCfgS≥c
 *
	m£lf
, 
TfwCfgE¡ry
 *
	m∑r£d_íåy
);

288 *
	mde°
;

289 *
	m•ec_ext
;

291 
boﬁ
 
	mÆlow_n⁄e
:1;

292 
boﬁ
 
	mÆlow_ª≥©
:1;

293 
boﬁ
 
	mÆlow_ªc⁄fig
:1;

294 
boﬁ
 
	m__ˇŒed_now
:1;

295 
boﬁ
 
	m__ˇŒed_cfg
:1;

296 
boﬁ
 
	m__ˇŒed_evî
:1;

298 (*
	m˛ónup
)(
TfwCfgS≥c
 *
	m£lf
);

304 
	#TFW_CFG_FOR_EACH_SPEC
(
•ec_pos
, 
•ec_¨r
) \

305 (
•ec_pos
Ë(
•ec_¨r
); (•ec_pos)->
«me
; ++(•ec_pos))

	)

314 c⁄° *
	m«me
;

315 
	mvÆue
;

316 } 
	tTfwCfgEnum
;

320 
	mmu…ùÀ_of
;

322 
	mmö
;

323 
	mmax
;

324 } 
	mønge
;

325 
TfwCfgEnum
 *
	míums
;

326 } 
	tTfwCfgS≥cI¡
;

336 
size_t
 
	mmö
;

337 
size_t
 
	mmax
;

338 } 
	mÀn_ønge
;

339 c⁄° *
	mc£t
;

340 } 
	tTfwCfgS≥cSå
;

349 (*
	mbegö_hook
)(
TfwCfgS≥c
 *
	m£lf
, 
TfwCfgE¡ry
 *
	m∑ª¡_íåy
);

350 (*
	mföish_hook
)(
TfwCfgS≥c
 *
	m£lf
);

351 } 
	tTfwCfgS≥cChûd
;

353 
ölöe
 
boﬁ


354 
	$tfw_cfg_is_dÊt_vÆue
(
TfwCfgE¡ry
 *
cfg_íåy
)

356  
cfg_íåy
->
dÊt_vÆue
;

357 
	}
}

371 
	mTFW_CFG_B_ADD
 = 0,

372 
	mTFW_CFG_B_DEL
,

373 
	mTFW_CFG_B_MOD
,

374 
	mTFW_CFG_B_KEEP
,

377 
	#TFW_CFG_F_ADD
 (1 << 
TFW_CFG_B_ADD
)

	)

378 
	#TFW_CFG_F_DEL
 (1 << 
TFW_CFG_B_DEL
)

	)

379 
	#TFW_CFG_F_MOD
 (1 << 
TFW_CFG_B_MOD
)

	)

380 
	#TFW_CFG_F_KEEP
 (1 << 
TFW_CFG_B_KEEP
)

	)

381 
	#TFW_CFG_M_ACTION
 \

382 (
TFW_CFG_F_ADD
 | 
TFW_CFG_F_DEL
 | 
TFW_CFG_F_MOD
 | 
TFW_CFG_F_KEEP
)

	)

385 
tfw_cfg_£t_boﬁ
(
TfwCfgS≥c
 *
£lf
, 
TfwCfgE¡ry
 *
∑r£d_íåy
);

386 
tfw_cfg_£t_öt
(
TfwCfgS≥c
 *
•ec
, 
TfwCfgE¡ry
 *
∑r£d_íåy
);

387 
tfw_cfg_£t_°r
(
TfwCfgS≥c
 *
•ec
, 
TfwCfgE¡ry
 *
∑r£d_íåy
);

388 
tfw_cfg_h™dÀ_chûdªn
(
TfwCfgS≥c
 *
£lf
, 
TfwCfgE¡ry
 *
∑r£d_íåy
);

389 
tfw_cfg_˛ónup_chûdªn
(
TfwCfgS≥c
 *
cs
);

392 
tfw_cfg_check_ønge
(
vÆue
, 
mö
, 
max
);

393 
tfw_cfg_check_mu…ùÀ_of
(
vÆue
, 
divis‹
);

394 
tfw_cfg_check_vÆ_n
(c⁄° 
TfwCfgE¡ry
 *
e
, 
vÆ_n
);

395 
tfw_cfg_check_sögÀ_vÆ
(c⁄° 
TfwCfgE¡ry
 *
e
);

396 
tfw_cfg_∑r£_öt
(c⁄° *
s
, *
out_öt
);

397 
tfw_cfg_∑r£_uöt
(c⁄° *
s
, *
out_uöt
);

398 
tfw_cfg_∑r£_ötvl
(c⁄° *
s
, *
i0
, *
i1
);

399 
tfw_cfg_m≠_íum
(c⁄° 
TfwCfgEnum
 
m≠pögs
[],

400 c⁄° *
ö_«me
, *
out_öt
);

401 c⁄° *
tfw_cfg_gë_©å
(c⁄° 
TfwCfgE¡ry
 *
e
, c⁄° *
©å_key
,

402 c⁄° *
deÁu…_vÆ
);

405 
TfwCfgS≥c
 *
tfw_cfg_•ec_föd
(TfwCfgS≥¯
•ecs
[], c⁄° *
«me
);

406 
tfw_cfg_∑r£_mods
(c⁄° *
cfg_ãxt
, 
li°_hód
 *
mod_li°
);

408 *
tfw_cfg_ªad_fûe
(c⁄° *
∑th
, 
size_t
 *
fûe_size
);

410 
tfw_cfg_∑r£
(
li°_hód
 *
mod_li°
);

411 
tfw_cfg_˛ónup
(
li°_hód
 *
mod_li°
);

412 
tfw_cfg_c⁄˛ude
(
li°_hód
 *
mod_li°
);

	@client.c

23 
	~<löux/hashèbÀ.h
>

24 
	~<löux/¶ab.h
>

26 
	~"lib/hash.h
"

27 
	~"˛õ¡.h
"

28 
	~"c⁄√˘i⁄.h
"

29 
	~"log.h
"

30 
	~"¥ocfs.h
"

32 
	#CLI_HASH_BITS
 17

	)

33 
	#CLI_HASH_SZ
 (1 << 
CLI_HASH_BITS
)

	)

36 
hli°_hód
 
	mli°
;

37 
•ölock_t
 
	mlock
;

38 } 
	tCliHashBuckë
;

44 
CliHashBuckë
 
	g˛i_hash
[
CLI_HASH_SZ
] = {

45 [0 ... (
CLI_HASH_SZ
 - 1)] = {

46 
HLIST_HEAD_INIT
,

50 
kmem_ˇche
 *
	g˛i_ˇche
;

56 
	$tfw_˛õ¡_put
(
TfwClõ¡
 *
˛i
)

58 
	`TFW_DBG2
("put client %p, conn_users=%d\n",

59 
˛i
, 
	`©omic_ªad
(&˛i->
c⁄n_u£rs
));

61 i‡(!
	`©omic_dec_™d_ã°
(&
˛i
->
c⁄n_u£rs
))

64 
	`•ö_lock
(
˛i
->
hb_lock
);

66 i‡(
	`©omic_ªad
(&
˛i
->
c⁄n_u£rs
)) {

67 
	`•ö_u∆ock
(
˛i
->
hb_lock
);

70 
	`BUG_ON
(!
	`li°_em±y
(&
˛i
->
c⁄n_li°
));

72 
	`hli°_dñ
(&
˛i
->
híåy
);

74 
	`•ö_u∆ock
(
˛i
->
hb_lock
);

76 
	`TFW_DBG
("‰ì clõ¡: cli=%p\n", 
˛i
);

77 
	`kmem_ˇche_‰ì
(
˛i_ˇche
, 
˛i
);

78 
	`TFW_DEC_STAT_BH
(
˛¡
.
⁄löe
);

79 
	}
}

80 
EXPORT_SYMBOL
(
tfw_˛õ¡_put
);

97 
TfwClõ¡
 *

98 
tfw_˛õ¡_obèö
(
sock
 *
sk
, (*
öô
)(
TfwClõ¡
 *))

100 
TfwClõ¡
 *
˛i
;

101 
CliHashBuckë
 *
hb
;

102 
hli°_node
 *
tmp
;

103 
key
;

104 
TfwAddr
 
addr
;

106 
	`ss_gë≥î«me
(
sk
, &
addr
);

107 
key
 = 
	`hash_ˇlc
((c⁄° *)&
addr
.
v6
.
sö6_addr
,

108 (
addr
.
v6
.
sö6_addr
));

110 
hb
 = &
˛i_hash
[
	`hash_mö
(
key
, 
CLI_HASH_BITS
)];

112 
	`•ö_lock
(&
hb
->
lock
);

114 
	`hli°_f‹_óch_íåy_ß„
(
˛i
, 
tmp
, &
hb
->
li°
, 
híåy
)

115 i‡(
	`ùv6_addr_equÆ
(&
addr
.
v6
.
sö6_addr
,

116 &
˛i
->
addr
.
v6
.
sö6_addr
))

117 
found
;

119 i‡(!(
˛i
 = 
	`kmem_ˇche_Æloc
(
˛i_ˇche
, 
GFP_ATOMIC
 | 
__GFP_ZERO
))) {

120 
	`•ö_u∆ock
(&
hb
->
lock
);

121  
NULL
;

124 
	`tfw_≥î_öô
((
TfwPìr
 *)
˛i
, &
addr
);

125 
	`hli°_add_hód
(&
˛i
->
híåy
, &
hb
->
li°
);

126 
˛i
->
hb_lock
 = &
hb
->
lock
;

127 i‡(
öô
)

128 
	`öô
(
˛i
);

130 
	`TFW_INC_STAT_BH
(
˛¡
.
⁄löe
);

131 
	`TFW_DBG
("√w clõ¡: cli=%p\n", 
˛i
);

132 
	`TFW_DBG_ADDR6
("˛õ¡áddªss", &
˛i
->
addr
.
v6
.
sö6_addr
);

134 
found
:

135 
	`©omic_öc
(&
˛i
->
c⁄n_u£rs
);

137 
	`TFW_DBG2
("client %p, conn_users=%d\n",

138 
˛i
, 
	`©omic_ªad
(&˛i->
c⁄n_u£rs
));

140 
	`•ö_u∆ock
(&
hb
->
lock
);

142  
˛i
;

143 
	}
}

144 
EXPORT_SYMBOL
(
tfw_˛õ¡_obèö
);

150 
tfw_˛õ¡_f‹_óch
((*
‚
)(
TfwClõ¡
 *))

152 
i
, 
r
 = 0;

154 
i
 = 0; i < 
CLI_HASH_SZ
 && !
r
; ++i) {

155 
TfwClõ¡
 *
c
;

156 
CliHashBuckë
 *
hb
 = &
˛i_hash
[
i
];

158 
	`•ö_lock
(&
hb
->
lock
);

160 
	`hli°_f‹_óch_íåy
(
c
, &
hb
->
li°
, 
híåy
) {

161 
r
 = 
	`‚
(
c
);

162 i‡(
	`u∆ikñy
(
r
))

166 
	`•ö_u∆ock
(&
hb
->
lock
);

169  
r
;

170 
	}
}

172 
__öô


173 
	$tfw_˛õ¡_öô
()

175 
i
;

177 
˛i_ˇche
 = 
	`kmem_ˇche_¸óã
("tfw_˛i_ˇche", (
TfwClõ¡
),

178 0, 0, 
NULL
);

179 i‡(!
˛i_ˇche
)

180  -
ENOMEM
;

186 
i
 = 0; i < 
CLI_HASH_SZ
; ++i)

187 
	`•ö_lock_öô
(&
˛i_hash
[
i
].
lock
);

190 
	}
}

193 
	$tfw_˛õ¡_exô
()

195 
i
;

201 
i
 = 0; i < (1 << 
CLI_HASH_BITS
); ++i) {

202 
TfwClõ¡
 *
c
;

203 
hli°_node
 *
tmp
;

204 
CliHashBuckë
 *
hb
 = &
˛i_hash
[
i
];

206 
	`hli°_f‹_óch_íåy_ß„
(
c
, 
tmp
, &
hb
->
li°
, 
híåy
) {

207 
	`BUG_ON
(!
	`li°_em±y
(&
c
->
c⁄n_li°
));

208 
	`hash_dñ
(&
c
->
híåy
);

209 
	`kmem_ˇche_‰ì
(
˛i_ˇche
, 
c
);

212 
	`kmem_ˇche_de°roy
(
˛i_ˇche
);

213 
	}
}

	@client.h

21 #i‚de‡
__TFW_CLIENT_H__


22 
	#__TFW_CLIENT_H__


	)

24 
	~"hâp_limôs.h
"

25 
	~"c⁄√˘i⁄.h
"

40 
	mTFW_PEER_COMMON
;

41 
hli°_node
 
	mhíåy
;

42 
•ölock_t
 *
	mhb_lock
;

43 
©omic_t
 
	mc⁄n_u£rs
;

44 
TfwCœssifõrPrvt
 
	m˛ass_¥vt
;

45 } 
	tTfwClõ¡
;

47 
TfwClõ¡
 *
tfw_˛õ¡_obèö
(
sock
 *
sk
, (*
öô
)(TfwClient *));

48 
	`tfw_˛õ¡_put
(
TfwClõ¡
 *
˛i
);

49 
	`tfw_˛õ¡_f‹_óch
((*
‚
)(
TfwClõ¡
 *));

50 
	`tfw_˛i_c⁄n_ªÀa£
(
TfwCliC⁄n
 *
˛i_c⁄n
);

51 
	`tfw_˛i_c⁄n_£nd
(
TfwCliC⁄n
 *
˛i_c⁄n
, 
TfwMsg
 *
msg
);

	@connection.c

23 
	~"c⁄√˘i⁄.h
"

24 
	~"gfsm.h
"

25 
	~"log.h
"

26 
	~"sync_sockë.h
"

28 
TfwC⁄nHooks
 *
	gc⁄n_hooks
[
TFW_CONN_MAX_PROTOS
];

35 
	$tfw_c⁄√˘i⁄_öô
(
TfwC⁄n
 *
c⁄n
)

37 
	`mem£t
(
c⁄n
, 0, (*conn));

38 
	`INIT_LIST_HEAD
(&
c⁄n
->
li°
);

39 
	}
}

42 
	$tfw_c⁄√˘i⁄_lök_≥î
(
TfwC⁄n
 *
c⁄n
, 
TfwPìr
 *
≥î
)

44 
	`BUG_ON
(
c⁄n
->
≥î
 || !
	`li°_em±y
(&c⁄n->
li°
));

45 
c⁄n
->
≥î
 =Öeer;

46 
	`tfw_≥î_add_c⁄n
(
≥î
, &
c⁄n
->
li°
);

47 
	}
}

53 
	$tfw_c⁄√˘i⁄_√w
(
TfwC⁄n
 *
c⁄n
)

55  
	`TFW_CONN_HOOK_CALL
(
c⁄n
, 
c⁄n_öô
);

56 
	}
}

62 
	$tfw_c⁄√˘i⁄_ª∑ú
(
TfwC⁄n
 *
c⁄n
)

64 
	`TFW_CONN_HOOK_CALL
(
c⁄n
, 
c⁄n_ª∑ú
);

65 
	}
}

68 
	$tfw_c⁄√˘i⁄_˛o£
(
TfwC⁄n
 *
c⁄n
, 
boﬁ
 
sync
)

70  
	`TFW_CONN_HOOK_CALL
(
c⁄n
, 
c⁄n_˛o£
, 
sync
);

71 
	}
}

77 
	$tfw_c⁄√˘i⁄_dr›
(
TfwC⁄n
 *
c⁄n
)

80 
	`TFW_CONN_HOOK_CALL
(
c⁄n
, 
c⁄n_dr›
);

81 
	`BUG_ON
(
c⁄n
->
msg
);

82 
	}
}

88 
	$tfw_c⁄√˘i⁄_ªÀa£
(
TfwC⁄n
 *
c⁄n
)

91 
	`TFW_CONN_HOOK_CALL
(
c⁄n
, 
c⁄n_ªÀa£
);

92 
	`BUG_ON
((
	`TFW_CONN_TYPE
(
c⁄n
Ë& 
C⁄n_C t
)

93 && !
	`li°_em±y
(&((
TfwCliC⁄n
 *)
c⁄n
)->
£q_queue
));

94 
	}
}

103 
	$tfw_c⁄√˘i⁄_£nd
(
TfwC⁄n
 *
c⁄n
, 
TfwMsg
 *
msg
)

105  
	`TFW_CONN_HOOK_CALL
(
c⁄n
, 
c⁄n_£nd
, 
msg
);

106 
	}
}

109 
	$tfw_c⁄√˘i⁄_ªcv
(*
cd©a
, 
sk_buff
 *
skb
, 
off
)

111 
TfwC⁄n
 *
c⁄n
 = 
cd©a
;

112 
TfwFsmD©a
 
fsm_d©a
 = {

113 .
skb
 = skb,

114 .
off
 = off,

117  
	`tfw_gfsm_di•©ch
(&
c⁄n
->
°©e
, c⁄n, &
fsm_d©a
);

118 
	}
}

121 
	$tfw_c⁄√˘i⁄_hooks_ªgi°î
(
TfwC⁄nHooks
 *
hooks
, 
ty≥
)

123 
hid
 = 
	`TFW_CONN_TYPE2IDX
(
ty≥
);

125 
	`BUG_ON
(
hid
 >
TFW_CONN_MAX_PROTOS
 || 
c⁄n_hooks
[hid]);

127 
c⁄n_hooks
[
hid
] = 
hooks
;

128 
	}
}

131 
	$tfw_c⁄√˘i⁄_hooks_uƒegi°î
(
ty≥
)

133 
c⁄n_hooks
[
	`TFW_CONN_TYPE2IDX
(
ty≥
)] = 
NULL
;

134 
	}
}

	@connection.h

23 #i‚de‡
__TFW_CONNECTION_H__


24 
	#__TFW_CONNECTION_H__


	)

26 
	~<√t/sock.h
>

28 
	~"gfsm.h
"

29 
	~"msg.h
"

30 
	~"≥î.h
"

32 
	~"sync_sockë.h
"

33 
	~"és.h
"

42 
	m__C⁄n_Bôs
 = 0x8,

45 
	mC⁄n_C t
 = 0x1 << 
__C⁄n_Bôs
,

46 
	mC⁄n_Srv
 = 0x2 << 
__C⁄n_Bôs
,

49 
	mC⁄n_HâpC t
 = 
C⁄n_C t
 | 
TFW_FSM_HTTP
,

50 
	mC⁄n_HâpSrv
 = 
C⁄n_Srv
 | 
TFW_FSM_HTTP
,

53 
	mC⁄n_HâpsC t
 = 
C⁄n_C t
 | 
TFW_FSM_HTTPS
,

54 
	mC⁄n_HâpsSrv
 = 
C⁄n_Srv
 | 
TFW_FSM_HTTPS
,

57 
	#TFW_CONN_TYPE2IDX
(
t
Ë
	`TFW_FSM_TYPE
—)

	)

93 
	#TFW_CONN_COMMON
 \

94 
SsPrŸo
 
¥Ÿo
; \

95 
TfwGSèã
 
°©e
; \

96 
li°_hód
 
li°
; \

97 
©omic_t
 
ªf˙t
; \

98 
timî_li°
 
timî
; \

99 
TfwMsg
 *
msg
; \

100 
TfwPìr
 *
≥î
; \

101 
sock
 *
sk
; \

102 (*
de°ru˘‹
)(*);

	)

105 
	mTFW_CONN_COMMON
;

106 } 
	tTfwC⁄n
;

108 
	#TFW_CONN_TYPE
(
c
Ë((c)->
¥Ÿo
.
ty≥
)

	)

151 
	mTFW_CONN_COMMON
;

152 
li°_hód
 
	m£q_queue
;

153 
•ölock_t
 
	m£q_qlock
;

154 
•ölock_t
 
	mªt_qlock
;

155 } 
	tTfwCliC⁄n
;

170 
	mTFW_CONN_COMMON
;

171 
li°_hód
 
	mfwd_queue
;

172 
li°_hód
 
	mnù_queue
;

173 
•ölock_t
 
	mfwd_qlock
;

174 
	mÊags
;

175 
	mqsize
;

176 
	mª˙s
;

177 
TfwMsg
 *
	mmsg_£¡
;

178 } 
	tTfwSrvC⁄n
;

180 
	#TFW_CONN_DEATHCNT
 (
INT_MIN
 / 2)

	)

185 
	mTFW_CONN_B_RESEND
 = 0,

187 
	mTFW_CONN_B_QFORWD
,

189 
	mTFW_CONN_B_HASNIP
,

192 
	mTFW_CONN_B_DEL
,

194 
	mTFW_CONN_B_ACTIVE


197 
	#TFW_CONN_F_RESEND
 (1 << 
TFW_CONN_B_RESEND
)

	)

198 
	#TFW_CONN_F_QFORWD
 (1 << 
TFW_CONN_B_QFORWD
)

	)

199 
	#TFW_CONN_F_HASNIP
 (1 << 
TFW_CONN_B_HASNIP
)

	)

206 
TfwCliC⁄n
 
	m˛i_c⁄n
;

207 
TlsCtx
 
	més
;

208 } 
	tTfwTlsC⁄n
;

210 
	#tfw_és_c⁄ãxt
(
c⁄n
Ë(
TlsCtx
 *)(&((
TfwTlsC⁄n
 *)c⁄n)->
és
)

	)

220 (*
	mc⁄n_öô
)(
TfwC⁄n
 *
	mc⁄n
);

228 (*
	mc⁄n_ª∑ú
)(
TfwC⁄n
 *
	mc⁄n
);

233 (*
	mc⁄n_˛o£
)(
TfwC⁄n
 *
	mc⁄n
, 
boﬁ
 
	msync
);

240 (*
	mc⁄n_dr›
)(
TfwC⁄n
 *
	mc⁄n
);

246 (*
	mc⁄n_ªÀa£
)(
TfwC⁄n
 *
	mc⁄n
);

252 (*
	mc⁄n_£nd
)(
TfwC⁄n
 *
	mc⁄n
, 
TfwMsg
 *
	mmsg
);

253 } 
	tTfwC⁄nHooks
;

255 
	#TFW_CONN_MAX_PROTOS
 
TFW_GFSM_FSM_N


	)

257 
TfwC⁄nHooks
 *
c⁄n_hooks
[
TFW_CONN_MAX_PROTOS
];

260 
	#tfw_c⁄n_hook_ˇŒ
(
¥Ÿo
, 
c
, 
f
, ...) \

261 
c⁄n_hooks
[
¥Ÿo
]->
f
 ? c⁄n_hooks[¥Ÿo]->
	`f
(
c
, ## 
__VA_ARGS__
Ë: 0

	)

262 
	#TFW_CONN_HOOK_CALL
(
c
, 
f
...) \

263 
	`tfw_c⁄n_hook_ˇŒ
(
	`TFW_CONN_TYPE2IDX
(
	`TFW_CONN_TYPE
(
c
)), c, 
f
)

	)

276 
ölöe
 
boﬁ


277 
	$tfw_§v_c⁄n_ª°ri˘ed
(
TfwSrvC⁄n
 *
§v_c⁄n
)

279  
	`ã°_bô
(
TFW_CONN_B_RESEND
, &
§v_c⁄n
->
Êags
);

280 
	}
}

285 
ölöe
 
boﬁ


286 
	$tfw_§v_c⁄n_ha¢ù
(
TfwSrvC⁄n
 *
§v_c⁄n
)

288  
	`ã°_bô
(
TFW_CONN_B_HASNIP
, &
§v_c⁄n
->
Êags
);

289 
	}
}

291 
ölöe
 
boﬁ


292 
	$tfw_c⁄√˘i⁄_live
(
TfwC⁄n
 *
c⁄n
)

294  
	`©omic_ªad
(&
c⁄n
->
ªf˙t
) > 0;

295 
	}
}

297 
	#tfw_§v_c⁄n_live
(
c
Ë
	`tfw_c⁄√˘i⁄_live
((
TfwC⁄n
 *)(c))

	)

299 
ölöe
 

300 
	$tfw_c⁄√˘i⁄_gë
(
TfwC⁄n
 *
c⁄n
)

302 
	`©omic_öc
(&
c⁄n
->
ªf˙t
);

303 
	}
}

305 
	#tfw_˛i_c⁄n_gë
(
c
Ë
	`tfw_c⁄√˘i⁄_gë
((
TfwC⁄n
 *)(c))

	)

306 
	#tfw_§v_c⁄n_gë
(
c
Ë
	`tfw_c⁄√˘i⁄_gë
((
TfwC⁄n
 *)(c))

	)

312 
ölöe
 
boﬁ


313 
	$__tfw_c⁄√˘i⁄_gë_if_live
(
TfwC⁄n
 *
c⁄n
)

315 
ﬁd
, 
rc
 = 
	`©omic_ªad
(&
c⁄n
->
ªf˙t
);

317 
	`likñy
(
rc
 > 0)) {

318 
ﬁd
 = 
	`©omic_cmpxchg
(&
c⁄n
->
ªf˙t
, 
rc
,Ñc + 1);

319 i‡(
	`likñy
(
ﬁd
 =
rc
))

320  
åue
;

321 
rc
 = 
ﬁd
;

324  
Ál£
;

325 
	}
}

327 
	#tfw_§v_c⁄n_gë_if_live
(
c
) \

328 
	`__tfw_c⁄√˘i⁄_gë_if_live
((
TfwC⁄n
 *)(
c
))

	)

330 
ölöe
 

331 
	$tfw_c⁄√˘i⁄_put
(
TfwC⁄n
 *
c⁄n
)

333 
rc
;

335 i‡(
	`u∆ikñy
(!
c⁄n
))

338 
rc
 = 
	`©omic_dec_ªtu∫
(&
c⁄n
->
ªf˙t
);

339 i‡(
	`likñy
(
rc
 &&Ñ¯!
TFW_CONN_DEATHCNT
))

341 i‡(
c⁄n
->
de°ru˘‹
)

342 
c⁄n
->
	`de°ru˘‹
(conn);

343 
	}
}

345 
	#tfw_˛i_c⁄n_put
(
c
Ë
	`tfw_c⁄√˘i⁄_put
((
TfwC⁄n
 *)(c))

	)

346 
	#tfw_§v_c⁄n_put
(
c
Ë
	`tfw_c⁄√˘i⁄_put
((
TfwC⁄n
 *)(c))

	)

348 
ölöe
 

349 
	$tfw_c⁄√˘i⁄_put_to_dóth
(
TfwC⁄n
 *
c⁄n
)

351 
	`©omic_add
(
TFW_CONN_DEATHCNT
, &
c⁄n
->
ªf˙t
);

352 
	}
}

354 
ölöe
 

355 
	$tfw_c⁄√˘i⁄_ªvive
(
TfwC⁄n
 *
c⁄n
)

357 
	`©omic_£t
(&
c⁄n
->
ªf˙t
, 1);

358 
	}
}

366 
ölöe
 

367 
	$tfw_§v_c⁄n_öô_as_dód
(
TfwSrvC⁄n
 *
§v_c⁄n
)

369 
	`©omic_£t
(&
§v_c⁄n
->
ªf˙t
, 
TFW_CONN_DEATHCNT
 + 1);

370 
	}
}

378 
ölöe
 

379 
	$tfw_c⁄√˘i⁄_lök_‰om_sk
(
TfwC⁄n
 *
c⁄n
, 
sock
 *
sk
)

381 
	`BUG_ON
(
sk
->
sk_u£r_d©a
);

382 
sk
->
sk_u£r_d©a
 = 
c⁄n
;

383 
	}
}

391 
ölöe
 

392 
	$tfw_c⁄√˘i⁄_lök_to_sk
(
TfwC⁄n
 *
c⁄n
, 
sock
 *
sk
)

394 
	`ss_sock_hﬁd
(
sk
);

395 
c⁄n
->
sk
 = sk;

396 
	}
}

403 
ölöe
 

404 
	$tfw_c⁄√˘i⁄_u∆ök_‰om_sk
(
sock
 *
sk
)

406 
	`BUG_ON
(!
sk
->
sk_u£r_d©a
);

407 
sk
->
sk_u£r_d©a
 = 
NULL
;

408 
	}
}

418 
ölöe
 

419 
	$tfw_c⁄√˘i⁄_u∆ök_to_sk
(
TfwC⁄n
 *
c⁄n
)

421 
sock
 *
sk
 = 
c⁄n
->sk;

423 
c⁄n
->
sk
 = 
NULL
;

424 
	`ss_sock_put
(
sk
);

425 
	}
}

427 
ölöe
 

428 
	$tfw_c⁄√˘i⁄_u∆ök_‰om_≥î
(
TfwC⁄n
 *
c⁄n
)

430 
	`BUG_ON
(!
c⁄n
->
≥î
 || 
	`li°_em±y
(&c⁄n->
li°
));

431 
	`tfw_≥î_dñ_c⁄n
(
c⁄n
->
≥î
, &c⁄n->
li°
);

432 
	}
}

434 
ölöe
 

435 
	$tfw_c⁄√˘i⁄_u∆ök_msg
(
TfwC⁄n
 *
c⁄n
)

437 
c⁄n
->
msg
 = 
NULL
;

438 
	}
}

443 
ölöe
 

444 
	$tfw_c⁄√˘i⁄_vÆid©e_˛ónup
(
TfwC⁄n
 *
c⁄n
)

446 
rc
;

448 
	`BUG_ON
(!
c⁄n
);

449 
	`BUG_ON
(!
	`li°_em±y
(&
c⁄n
->
li°
));

450 
	`BUG_ON
(
c⁄n
->
msg
);

452 
rc
 = 
	`©omic_ªad
(&
c⁄n
->
ªf˙t
);

453 
	`BUG_ON
(
rc
 &&Ñ¯!
TFW_CONN_DEATHCNT
);

454 
	}
}

456 
tfw_c⁄√˘i⁄_hooks_ªgi°î
(
TfwC⁄nHooks
 *
hooks
, 
ty≥
);

457 
tfw_c⁄√˘i⁄_hooks_uƒegi°î
(
ty≥
);

458 
tfw_c⁄√˘i⁄_£nd
(
TfwC⁄n
 *
c⁄n
, 
TfwMsg
 *
msg
);

461 
tfw_c⁄√˘i⁄_öô
(
TfwC⁄n
 *
c⁄n
);

462 
tfw_c⁄√˘i⁄_lök_≥î
(
TfwC⁄n
 *
c⁄n
, 
TfwPìr
 *
≥î
);

464 
tfw_c⁄√˘i⁄_√w
(
TfwC⁄n
 *
c⁄n
);

465 
tfw_c⁄√˘i⁄_ª∑ú
(
TfwC⁄n
 *
c⁄n
);

466 
tfw_c⁄√˘i⁄_˛o£
(
TfwC⁄n
 *
c⁄n
, 
boﬁ
 
sync
);

467 
tfw_c⁄√˘i⁄_dr›
(
TfwC⁄n
 *
c⁄n
);

468 
tfw_c⁄√˘i⁄_ªÀa£
(
TfwC⁄n
 *
c⁄n
);

470 
tfw_c⁄√˘i⁄_ªcv
(*
cd©a
, 
sk_buff
 *
skb
, 
off
);

	@filter.c

35 
	~<löux/moduÀ.h
>

36 
	~<löux/√tfûãr.h
>

37 
	~<löux/√tfûãr_ùv4.h
>

38 
	~<löux/√tfûãr_ùv6.h
>

39 
	~<√t/t˝.h
>

41 
	~"tdb.h
"

43 
	~"lib/°r.h
"

44 
	~"ãm≥°a_fw.h
"

45 
	~"hâp_limôs.h
"

46 
	~"fûãr.h
"

47 
	~"log.h
"

50 
	mTFW_F_DROP
,

54 
ö6_addr
 
	maddr
;

55 
	ma˘i⁄
;

56 } 
	tTfwFRuÀ
;

59 
	mdb_size
;

60 c⁄° *
	mdb_∑th
;

61 } 
fûãr_cfg
 
	g__ªad_mo°ly
;

63 
TDB
 *
	gù_fûãr_db
;

66 
	$tfw_ùv6_hash
(
ö6_addr
 *
addr
)

68  (()
addr
->
s6_addr32
[0] << 32)

69 ^ (()
addr
->
s6_addr32
[1] << 24)

70 ^ (()
addr
->
s6_addr32
[2] << 8)

71 ^ 
addr
->
s6_addr32
[3];

72 
	}
}

75 
	$tfw_fûãr_block_ù
(
ö6_addr
 *
addr
)

77 
TfwFRuÀ
 
ruÀ
 = {

78 .
addr
 = *addr,

79 .
a˘i⁄
 = 
TFW_F_DROP
,

81 
key
 = 
	`tfw_ùv6_hash
(
addr
);

82 
size_t
 
Àn
 = (
ruÀ
);

84 
	`TFW_DBG_ADDR6
("fûãr: block", 
addr
);

87 i‡(!
	`tdb_íåy_¸óã
(
ù_fûãr_db
, 
key
, &
ruÀ
, &
Àn
)) {

88 
	`TFW_WARN_ADDR6
("ˇ¬Ÿ cª©êblockögÑuÀ", 
addr
);

90 
	`TFW_DBG_ADDR6
("block clõ¡", 
addr
);

92 
	}
}

93 
EXPORT_SYMBOL
(
tfw_fûãr_block_ù
);

102 
	$tfw_fûãr_check_ù
(
ö6_addr
 *
addr
)

104 
TdbIãr
 
ôî
;

106 
ôî
 = 
	`tdb_ªc_gë
(
ù_fûãr_db
, 
	`tfw_ùv6_hash
(
addr
));

107 !
	`TDB_ITER_BAD
(
ôî
)) {

108 c⁄° 
TfwFRuÀ
 *
ruÀ
 = (TfwFRuÀ *)
ôî
.
ªc
->
d©a
;

109 i‡(!
	`memcmp_Á°
(&
ruÀ
->
addr
,áddr, (*addr))) {

110 
	`tdb_ªc_put
(
ôî
.
ªc
);

111  
ruÀ
->
a˘i⁄
 =
TFW_F_DROP
 ? 
TFW_BLOCK
 : 
TFW_PASS
;

113 
	`tdb_ªc_√xt
(
ù_fûãr_db
, &
ôî
);

116  
TFW_PASS
;

117 
	}
}

124 
ùhdr
 *

125 
	$__ùv4_hdr_check
(
sk_buff
 *
skb
)

127 
u32
 
pkt_Àn
;

128 
ùhdr
 *
ih
;

130 i‡(!
	`pskb_may_puŒ
(
skb
, (
ùhdr
)))

131  
NULL
;

133 
ih
 = 
	`ù_hdr
(
skb
);

134 i‡(
	`u∆ikñy
((
ih
->
ihl
 < 5Ë|| (ih->
vîsi⁄
 != 4)))

135  
NULL
;

137 i‡(!
	`pskb_may_puŒ
(
skb
, 
ih
->
ihl
 * 4))

138  
NULL
;

140 
ih
 = 
	`ù_hdr
(
skb
);

141 
pkt_Àn
 = 
	`¡ohs
(
ih
->
tŸ_Àn
);

142 i‡(
	`u∆ikñy
((
pkt_Àn
 > 
skb
->
Àn
Ë|| (pkt_À¿< 
ih
->
ihl
 * 4)))

143  
NULL
;

145  
ih
;

146 
	}
}

149 
	$tfw_ùv4_nf_hook
(*
¥iv
, 
sk_buff
 *
skb
,

150 c⁄° 
nf_hook_°©e
 *
°©e
)

152 
r
;

153 c⁄° 
ùhdr
 *
ih
;

154 
ö6_addr
 
addr6
;

156 
ih
 = 
	`__ùv4_hdr_check
(
skb
);

157 i‡(!
ih
)

158  
NF_DROP
;

160 
	`ùv6_addr_£t_v4m≠≥d
(
ih
->
ßddr
, &
addr6
);

162 i‡(
	`tfw_fûãr_check_ù
(&
addr6
Ë=
TFW_BLOCK
)

163  
NF_DROP
;

166 
r
 = 
	`tfw_˛assify_ùv4
(
skb
);

167 
r
) {

168 
TFW_PASS
:

169  
NF_ACCEPT
;

170 
TFW_POSTPONE
:

171  
NF_STOLEN
;

174  
NF_DROP
;

175 
	}
}

177 
u8
 *

178 
	$__ùv6_›t_±r
(
sk_buff
 *
skb
, 
size_t
 
off
)

180 i‡(!
	`pskb_may_puŒ
(
skb
, 
off
 + 8))

181  
NULL
;

183  (
u8
 *)(
	`ùv6_hdr
(
skb
) + 1);

184 
	}
}

186 
ùv6hdr
 *

187 
	$__ùv6_hdr_check
(
sk_buff
 *
skb
)

189 
u32
 
Àn
;

190 
size_t
 
off
 = 0;

191 
ùv6hdr
 *
ih
;

192 
u8
 
√xt
, *
buf
;

194 i‡(!
	`pskb_may_puŒ
(
skb
, (
ùv6hdr
)))

195  
NULL
;

197 
ih
 = 
	`ùv6_hdr
(
skb
);

198 i‡(
	`u∆ikñy
(
ih
->
vîsi⁄
 != 6))

199  
NULL
;

201 
Àn
 = 
	`¡ohs
(
ih
->
∑ylﬂd_Àn
);

202 i‡(
	`u∆ikñy
(
Àn
 + (
ùv6hdr
Ë> 
skb
->len))

203  
NULL
;

206 
√xt
 = 
ih
->
√xthdr
;

207 
buf
 = 
	`__ùv6_›t_±r
(
skb
, 0);

208 
√xt
 !
IPPROTO_TCP
) {

209 i‡(!
buf
)

210  
NULL
;

212 
√xt
) {

216 
√xt
 = 
buf
[0];

217 
Àn
 = (
buf
[1] + 1) * 8;

219 
off
 +
Àn
;

220 
buf
 = 
	`__ùv6_›t_±r
(
skb
, 
off
);

226  
NULL
;

230  
ih
;

231 
	}
}

234 
	$tfw_ùv6_nf_hook
(*
¥iv
, 
sk_buff
 *
skb
,

235 c⁄° 
nf_hook_°©e
 *
°©e
)

237 
r
;

238 
ùv6hdr
 *
ih
;

240 
ih
 = 
	`__ùv6_hdr_check
(
skb
);

241 i‡(!
ih
)

242  
NF_DROP
;

244 i‡(
	`tfw_fûãr_check_ù
(&
ih
->
ßddr
Ë=
TFW_BLOCK
)

245  
NF_DROP
;

248 
r
 = 
	`tfw_˛assify_ùv6
(
skb
);

249 
r
) {

250 
TFW_PASS
:

251  
NF_ACCEPT
;

252 
TFW_POSTPONE
:

253  
NF_STOLEN
;

256  
NF_DROP
;

257 
	}
}

259 
nf_hook_›s
 
	gtfw_nf_›s
[] 
	g__ªad_mo°ly
 = {

261 .
hook
 = 
tfw_ùv4_nf_hook
,

262 .
	gpf
 = 
PF_INET
,

263 .
	ghooknum
 = 
NF_INET_PRE_ROUTING
,

264 .
	g¥i‹ôy
 = 
NF_IP_PRI_CONNTRACK_DEFRAG
 + 1,

267 .
	ghook
 = 
tfw_ùv6_nf_hook
,

268 .
	gpf
 = 
NFPROTO_IPV6
,

269 .
	ghooknum
 = 
NF_INET_PRE_ROUTING
,

270 .
	g¥i‹ôy
 = 
NF_IP6_PRI_CONNTRACK_DEFRAG
 + 1,

275 
	$tfw_nf_ªgi°î
(
√t
 *net)

277  
	`nf_ªgi°î_√t_hooks
(
√t
, 
tfw_nf_›s
, 
	`ARRAY_SIZE
(tfw_nf_ops));

278 
	}
}

281 
	$tfw_nf_uƒegi°î
(
√t
 *net)

283 
	`nf_uƒegi°î_√t_hooks
(
√t
, 
tfw_nf_›s
, 
	`ARRAY_SIZE
(tfw_nf_ops));

284 
	}
}

286 
≥∫ë_›î©i⁄s
 
	gtfw_√t_›s
 = {

287 .
öô
 = 
tfw_nf_ªgi°î
,

288 .
	gexô
 = 
tfw_nf_uƒegi°î
,

292 
	$tfw_fûãr_°¨t
()

294 
r
;

296 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

299 
ù_fûãr_db
 = 
	`tdb_›í
(
fûãr_cfg
.
db_∑th
, fûãr_cfg.
db_size
,

300 (
TfwFRuÀ
), 
	`numa_node_id
());

301 i‡(!
ù_fûãr_db
)

302  -
EINVAL
;

304 i‡((
r
 = 
	`ªgi°î_≥∫ë_subsys
(&
tfw_√t_›s
))) {

305 
	`TFW_ERR_NL
("can'tÑegisterÇetfilter hooks\n");

306 
	`tdb_˛o£
(
ù_fûãr_db
);

307  
r
;

311 
	}
}

314 
	$tfw_fûãr_°›
()

316 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

318 i‡(
ù_fûãr_db
) {

319 
	`uƒegi°î_≥∫ë_subsys
(&
tfw_√t_›s
);

320 
	`tdb_˛o£
(
ù_fûãr_db
);

322 
	}
}

324 
TfwCfgS≥c
 
	gtfw_fûãr_•ecs
[] = {

326 .
«me
 = "filter_tbl_size",

327 .
	gdeÊt
 = "16777216",

328 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

329 .
	gde°
 = &
fûãr_cfg
.
db_size
,

330 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

331 .
mu…ùÀ_of
 = 
PAGE_SIZE
,

332 .
	gønge
 = { 
PAGE_SIZE
, (1 << 30) },

336 .
	g«me
 = "filter_db",

337 .
	gdeÊt
 = "/opt/tempesta/db/filter.tdb",

338 .
	gh™dÀr
 = 
tfw_cfg_£t_°r
,

339 .
	gde°
 = &
fûãr_cfg
.
db_∑th
,

340 .
	g•ec_ext
 = &(
TfwCfgS≥cSå
) {

341 .
Àn_ønge
 = { 1, 
PATH_MAX
 },

347 
TfwMod
 
	gtfw_fûãr_mod
 = {

348 .
«me
 = "filter",

349 .
	g°¨t
 = 
tfw_fûãr_°¨t
,

350 .
	g°›
 = 
tfw_fûãr_°›
,

351 .
	g•ecs
 = 
tfw_fûãr_•ecs
,

355 
	$tfw_fûãr_öô
()

357 
	`tfw_mod_ªgi°î
(&
tfw_fûãr_mod
);

359 
	}
}

362 
	$tfw_fûãr_exô
()

364 
	`tfw_mod_uƒegi°î
(&
tfw_fûãr_mod
);

365 
	}
}

	@filter.h

21 #i‚de‡
__TFW_FILTER_H__


22 
	#__TFW_FILTER_H__


	)

24 
	~<löux/ö6.h
>

26 
tfw_fûãr_block_ù
(
ö6_addr
 *
addr
);

	@gfsm.c

76 
	~"gfsm.h
"

77 
	~"log.h
"

79 
	#FSM_STATE
(
s
Ë(s)->
°©es
[()(s)->
cuº
]

	)

80 
	#__GFSM_FSM
(
_s
Ë(((_sË>> 
TFW_GFSM_FSM_SHIFT
) \

81 & 
TFW_GFSM_FSM_MASK
)

	)

82 
	#FSM
(
s
Ë
	`__GFSM_FSM
(
	`FSM_STATE
(s))

	)

83 
	#GFSM_HOOK_N
 (
TFW_GFSM_PRIO_N
 * 
TFW_GFSM_STATE_N
)

	)

84 
	#SET_STATE
(
s
, 
x
) \

86 
	`FSM_STATE
(
s
Ë(FSM_STATE(sË& ~
TFW_GFSM_STATE_MASK
Ë| (
x
); \

87 } 0)

	)

89 
	#__BAD_STATE_BYTE
 0xff

	)

90 
	#BAD_STATE
 ((
__BAD_STATE_BYTE
 << 8Ë| __BAD_STATE_BYTE)

	)

93 
	m°0
;

94 
	mfsm_id
;

95 } 
	tTfwFsmHook
;

98 
tfw_gfsm_h™dÀr_t
 
	gfsm_htbl
[
TFW_FSM_NUM
] 
	g__ªad_mo°ly
;

100 
TfwFsmHook
 
	gfsm_hooks
[
TFW_FSM_NUM
][
GFSM_HOOK_N
] 
	g__ªad_mo°ly
;

105 
	gfsm_hooks_bm
[
TFW_FSM_NUM
][
TFW_GFSM_WC_BMAP_SZ
];

112 
	$tfw_gfsm_°©e_öô
(
TfwGSèã
 *
°
, *
obj
, 
°0
)

114 
°
->
obj
 = obj;

115 
	`mem£t
(
°
->
°©es
, 
__BAD_STATE_BYTE
, (st->states));

116 
	`FSM_STATE
(
°
Ë
°0
;

117 
	}
}

123 
	$__gfsm_fsm_lookup
(
TfwGSèã
 *
°
, 
fsm_id
, *
‰ì_¶Ÿ
)

125 
i
;

126 
i
 = 0, *
‰ì_¶Ÿ
 = -1; i < 
TFW_GFSM_FSM_NUM
; ++i) {

127 i‡(
	`__GFSM_FSM
(
°
->
°©es
[
i
]Ë=
fsm_id
)

128  
i
;

129 i‡(*
‰ì_¶Ÿ
 =-1 && 
°
->
°©es
[
i
] =
BAD_STATE
)

130 *
‰ì_¶Ÿ
 = 
i
;

133 
	}
}

139 
	$tfw_gfsm_swôch
(
TfwGSèã
 *
°
, 
°©e
, 
¥io
)

141 
shi·
 = 
¥io
 * 
TFW_GFSM_PRIO_N
 + (
°©e
 & 
TFW_GFSM_STATE_MASK
);

142 
fsm_√xt
 = 
fsm_hooks
[
	`FSM
(
°
)][
shi·
].
fsm_id
;

143 
fsm_cuº
 = 
°©e
 >> 
TFW_GFSM_FSM_SHIFT
;

144 
‰ì_¶Ÿ
;

146 
	`TFW_DBG3
("GFSM switch from fsm %dát state %dÅo fsm %dát state %#x\n",

147 
fsm_cuº
, 
°©e
, 
fsm_√xt
, 
fsm_hooks
[fsm_cuº][
shi·
].
°0
);

149 
°
->
cuº
 = 
	`__gfsm_fsm_lookup
(°, 
fsm_√xt
, &
‰ì_¶Ÿ
);

150 i‡(
°
->
cuº
 < 0) {

152 
	`BUG_ON
(
‰ì_¶Ÿ
 < 0);

153 
°
->
cuº
 = 
‰ì_¶Ÿ
;

154 
	`FSM_STATE
(
°
Ë
fsm_hooks
[
fsm_cuº
][
shi·
].
°0
;

157  
fsm_√xt
;

158 
	}
}

173 
	$__gfsm_fsm_exec
(
TfwGSèã
 *
°
, 
fsm_id
, 
TfwFsmD©a
 *
d©a
)

175 
r
, 
¶Ÿ
, 
dummy
;

177 
°
->
cuº
 = 
¶Ÿ
 = 
	`__gfsm_fsm_lookup
(°, 
fsm_id
, &
dummy
);

178 
	`BUG_ON
(
°
->
cuº
 < 0);

180 
	`FSM_STATE
(
°
Ë|
TFW_GFSM_ONSTACK
;

182 
	`TFW_DBG3
("GFSMÉxe¯fsm %d, sèã %#x\n", 
fsm_id
, 
°
->
°©es
[
¶Ÿ
]);

184 
r
 = 
fsm_htbl
[
fsm_id
](
°
->
obj
, 
d©a
);

187 i‡((
°
->
°©es
[
¶Ÿ
] & 
TFW_GFSM_STATE_MASK
Ë=
TFW_GFSM_STATE_LAST
) {

188 
	`FSM_STATE
(
°
Ë
BAD_STATE
;

189 
°
->
cuº
 = -1;

191 
°
->
°©es
[
¶Ÿ
] &~
TFW_GFSM_ONSTACK
;

194  
r
;

195 
	}
}

201 
	$tfw_gfsm_di•©ch
(
TfwGSèã
 *
°
, *
obj
, 
TfwFsmD©a
 *
d©a
)

203 
fsm_id
 = 
	`TFW_FSM_TYPE
(((
SsPrŸo
 *)
obj
)->
ty≥
);

205  
	`__gfsm_fsm_exec
(
°
, 
fsm_id
, 
d©a
);

206 
	}
}

219 
	$tfw_gfsm_move
(
TfwGSèã
 *
°
, 
°©e
, 
TfwFsmD©a
 *
d©a
)

221 
r
 = 
TFW_PASS
, 
p
, 
fsm
;

222 *
hooks
 = 
fsm_hooks_bm
[
	`FSM
(
°
)];

223 
mask
 = 1 << 
°©e
;

225 
	`TFW_DBG3
("GFSM move %#x -> %#x: skb=%pK off=%uÅrail=%u"

226 "Ñeq=%pKÑe•=%pK\n", 
	`FSM_STATE
(
°
), 
°©e
,

227 
d©a
->
skb
, d©a->
off
, d©a->
åaû
, d©a->
ªq
, d©a->
ª•
);

230 
	`SET_STATE
(
°
, 
°©e
);

233 
p
 = 
TFW_GFSM_HOOK_PRIORITY_HIGH
;

234 
p
 < 
TFW_GFSM_HOOK_PRIORITY_NUM
; ++p)

240 i‡(!(
hooks
[
p
] & 
mask
))

241  
TFW_PASS
;

244 
fsm
 = 
	`tfw_gfsm_swôch
(
°
, 
°©e
, 
p
);

251 i‡(
	`FSM_STATE
(
°
Ë& 
TFW_GFSM_ONSTACK
)

254 
	`__gfsm_fsm_exec
(
°
, 
fsm
, 
d©a
)) {

255 
TFW_BLOCK
:

256  
TFW_BLOCK
;

257 
TFW_POSTPONE
:

262 
r
 = 
TFW_POSTPONE
;

266  
r
;

267 
	}
}

268 
EXPORT_SYMBOL
(
tfw_gfsm_move
);

281 
	$tfw_gfsm_ªgi°î_hook
(
fsm_id
, 
¥io
, 
°©e
,

282 
hndl_fsm_id
, 
°0
)

284 
shi·
, 
°
 = 
°©e
 & 
TFW_GFSM_STATE_MASK
;

285 
°_bô
 = 1 << 
°
;

288 
	`BUG_ON
(!
°
);

290 i‡(
¥io
 =
TFW_GFSM_HOOK_PRIORITY_ANY
) {

296 
¥io
 = 
TFW_GFSM_HOOK_PRIORITY_HIGH
;

297 
¥io
 < 
TFW_GFSM_HOOK_PRIORITY_NUM
; ++prio)

298 i‡(!(
fsm_hooks_bm
[
fsm_id
][
¥io
] & 
°_bô
))

300 i‡(
¥io
 =
TFW_GFSM_HOOK_PRIORITY_NUM
) {

301 
	`TFW_ERR_NL
("All hook slots for FSM %dáreácquired\n",

302 
fsm_id
);

303  -
EBUSY
;

306 
shi·
 = 
¥io
 * 
TFW_GFSM_PRIO_N
 + 
°
;

308 i‡(
fsm_hooks
[
fsm_id
][
shi·
].fsm_id)

309  -
EBUSY
;

310 i‡(!
fsm_htbl
[
fsm_id
]) {

311 
	`TFW_ERR_NL
("gfsm: fsm %d i†nŸÑegi°îed\n", 
fsm_id
);

312  -
ENOENT
;

315 
fsm_hooks
[
fsm_id
][
shi·
].
°0
 = st0;

316 
fsm_hooks
[
fsm_id
][
shi·
].fsm_id = 
hndl_fsm_id
;

317 
fsm_hooks_bm
[
fsm_id
][
¥io
] |
°_bô
;

319  
¥io
;

320 
	}
}

321 
EXPORT_SYMBOL
(
tfw_gfsm_ªgi°î_hook
);

330 
	$tfw_gfsm_uƒegi°î_hook
(
fsm_id
, 
¥io
, 
°©e
)

332 
°
 = 
°©e
 & 
TFW_GFSM_STATE_MASK
;

333 
shi·
 = 
¥io
 * 
TFW_GFSM_PRIO_N
 + 
°
;

335 
	`mem£t
(&
fsm_hooks
[
fsm_id
][
shi·
], 0, (
TfwFsmHook
));

336 
fsm_hooks_bm
[
fsm_id
][
¥io
] &~(1 << 
°
);

337 
	}
}

338 
EXPORT_SYMBOL
(
tfw_gfsm_uƒegi°î_hook
);

341 
	$tfw_gfsm_ªgi°î_fsm
(
fsm_id
, 
tfw_gfsm_h™dÀr_t
 
h™dÀr
)

343 i‡(
fsm_htbl
[
fsm_id
])

344  -
EBUSY
;

346 
fsm_htbl
[
fsm_id
] = 
h™dÀr
;

349 
	}
}

350 
EXPORT_SYMBOL
(
tfw_gfsm_ªgi°î_fsm
);

353 
	$tfw_gfsm_uƒegi°î_fsm
(
fsm_id
)

355 
	`BUG_ON
(!
fsm_htbl
[
fsm_id
]);

357 
fsm_htbl
[
fsm_id
] = 
NULL
;

358 
	}
}

359 
EXPORT_SYMBOL
(
tfw_gfsm_uƒegi°î_fsm
);

	@gfsm.h

21 #i‚de‡
__TFW_GFSM_H__


22 
	#__TFW_GFSM_H__


	)

24 
	~"msg.h
"

25 
	~"sync_sockë.h
"

40 
	#TFW_GFSM_STATE_BITS
 5

	)

41 
	#TFW_GFSM_STATE_N
 (1 << 
TFW_GFSM_STATE_BITS
)

	)

42 
	#TFW_GFSM_STATE_MASK
 (
TFW_GFSM_STATE_N
 - 1)

	)

43 
	#TFW_GFSM_STATE_LAST
 
TFW_GFSM_STATE_MASK


	)

44 
	#TFW_FSM_STATE
(
s
Ë(†& 
TFW_GFSM_STATE_MASK
)

	)

46 
	#TFW_GFSM_PRIO_BITS
 4

	)

47 
	#TFW_GFSM_PRIO_N
 (1 << 
TFW_GFSM_PRIO_BITS
)

	)

48 
	#TFW_GFSM_PRIO_SHIFT
 
TFW_GFSM_STATE_BITS


	)

50 
	#TFW_GFSM_FSM_BITS
 4

	)

51 
	#TFW_GFSM_FSM_N
 (1 << 
TFW_GFSM_FSM_BITS
)

	)

52 
	#TFW_GFSM_FSM_MASK
 (
TFW_GFSM_FSM_N
 - 1)

	)

53 
	#TFW_GFSM_FSM_SHIFT
 (
TFW_GFSM_PRIO_SHIFT
 + 
TFW_GFSM_PRIO_BITS
)

	)

55 
	#TFW_GFSM_ONSTACK
 (1 << (
TFW_GFSM_FSM_SHIFT
 + 
TFW_GFSM_FSM_BITS
))

	)

65 
	#TFW_GFSM_FSM_NUM
 8

	)

70 
	#TFW_GFSM_WC_BMAP_SZ
 (
TFW_GFSM_PRIO_N
 * 
TFW_GFSM_STATE_N
 \

71 / ((Ë* 8))

	)

84 
	mTFW_FSM_HTTP
,

85 
	mTFW_FSM_HTTPS
,

88 
	mTFW_FSM_FRANG_REQ
,

89 
	mTFW_FSM_FRANG_RESP
,

91 
	mTFW_FSM_NUM


94 
	#TFW_FSM_TYPE
(
t
Ë(—Ë& 
TFW_GFSM_FSM_MASK
)

	)

103 
	mTFW_GFSM_HOOK_PRIORITY_HIGH
 = 0,

104 
	mTFW_GFSM_HOOK_PRIORITY_NUM
 = 
TFW_GFSM_PRIO_N
,

105 
	mTFW_GFSM_HOOK_PRIORITY_LOW
 = 
TFW_GFSM_HOOK_PRIORITY_NUM
 - 1,

106 
	mTFW_GFSM_HOOK_PRIORITY_ANY
 = 
TFW_GFSM_HOOK_PRIORITY_NUM


116 
	mTFW_PASS
 = 
SS_OK
,

123 
	mTFW_BLOCK
 = 
SS_DROP
,

130 
	mTFW_POSTPONE
 = 
SS_POSTPONE
,

157 
sk_buff
 *
	mskb
;

158 
	moff
;

159 
	måaû
;

162 
TfwMsg
 *
	mªq
;

163 
TfwMsg
 *
	mª•
;

164 } 
	tTfwFsmD©a
;

180 
	mcuº
;

181 *
	mobj
;

182 
	m°©es
[
TFW_GFSM_FSM_NUM
];

183 } 
	tTfwGSèã
;

185 
	#TFW_GFSM_STATE
(
s
Ë((s)->
°©es
[()(s)->
cuº
] \

186 & ((
TFW_GFSM_FSM_MASK
 << 
TFW_GFSM_FSM_SHIFT
) \

187 | 
TFW_GFSM_STATE_MASK
))

	)

189 (*
	ttfw_gfsm_h™dÀr_t
)(*
	tobj
, 
	tTfwFsmD©a
 *
	td©a
);

191 
	`tfw_gfsm_°©e_öô
(
TfwGSèã
 *
°
, *
obj
, 
°0
);

192 
	`tfw_gfsm_di•©ch
(
TfwGSèã
 *
°
, *
obj
, 
TfwFsmD©a
 *
d©a
);

193 
	`tfw_gfsm_move
(
TfwGSèã
 *
°
, 
°©e
, 
TfwFsmD©a
 *
d©a
);

195 
	`tfw_gfsm_ªgi°î_hook
(
fsm_id
, 
¥io
, 
°©e
,

196 
hndl_fsm_id
, 
°0
);

197 
	`tfw_gfsm_uƒegi°î_hook
(
fsm_id
, 
¥io
, 
°©e
);

198 
	`tfw_gfsm_ªgi°î_fsm
(
fsm_id
, 
tfw_gfsm_h™dÀr_t
 
h™dÀr
);

199 
	`tfw_gfsm_uƒegi°î_fsm
(
fsm_id
);

	@hash.c

21 
	~"°r.h
"

23 
	~"lib/hash.h
"

33 
	$tfw_hash_°r
(c⁄° 
TfwSå
 *
°r
)

35 
¸c0
 = 0, 
¸c1
 = 0;

37 i‡(
	`likñy
(
	`TFW_STR_PLAIN
(
°r
))) {

38 
	`__hash_ˇlc
(&
¸c0
, &
¸c1
, 
°r
->
±r
, så->
Àn
);

41 c⁄° 
TfwSå
 *
c
 = (TfwSå *)
°r
->
±r
;

42 c⁄° 
TfwSå
 *
íd
 = 
c
 + 
	`TFW_STR_CHUNKN
(
°r
);

43 *
p
, *
e
;

44 
èû
 = 0;

46 
c
 < 
íd
) {

47 
p
 = 
c
->
±r
;

48 
e
 = 
p
 + 
c
->
Àn
;

50 i‡(
èû
) {

51  ; 
èû
 < 8; ++
p
, ++tail) {

52 i‡(
	`u∆ikñy
(
p
 =
e
))

53 
√xt_chunk
;

54 
	`CRCB
(
¸c0
, *
p
);

56  ; 
èû
 < 16; ++
p
, ++tail) {

57 i‡(
	`u∆ikñy
(
p
 =
e
))

58 
√xt_chunk
;

59 
	`CRCB
(
¸c1
, *
p
);

63 
	`__hash_ˇlc
(&
¸c0
, &
¸c1
, 
p
, 
e
 -Ö);

64 
èû
 = 
c
->
Àn
 & 0xf;

65 
√xt_chunk
:

66 ++
c
;

70  (
¸c1
 << 32Ë| 
¸c0
;

71 
	}
}

	@http.c

21 
	~<löux/°rög.h
>

22 
	~<löux/vmÆloc.h
>

23 
	~<löux/s‹t.h
>

24 
	~<löux/b£¨ch.h
>

26 
	~"lib/hash.h
"

27 
	~"lib/°r.h
"

28 
	~"ˇche.h
"

29 
	~"hâp_limôs.h
"

30 
	~"hâp_tbl.h
"

31 
	~"˛õ¡.h
"

32 
	~"hâp_msg.h
"

33 
	~"hâp_£ss.h
"

34 
	~"log.h
"

35 
	~"¥ocfs.h
"

36 
	~"£rvî.h
"

37 
	~"és.h
"

38 
	~"≠m.h
"

40 
	~"sync_sockë.h
"

42 
	#TFW_WARN_ADDR_STATUS
(
msg
, 
addr_±r
, 
°©us
) \

43 
	`TFW_WITH_ADDR_FMT
(
addr_±r
, 
addr_°r
, \

44 
	`TFW_WARN
("%s, status %d: %s\n", \

45 
msg
, 
°©us
, 
addr_°r
))

	)

47 
	#RESP_BUF_LEN
 128

	)

48 
DEFINE_PER_CPU
([
RESP_BUF_LEN
], 
g_buf
);

49 
	ggh¥io
;

51 
	#TFW_CFG_BLK_DEF
 (
TFW_BLK_ERR_REPLY
)

	)

52 
	gtfw_blk_Êags
 = 
TFW_CFG_BLK_DEF
;

56 *
	mmrks
;

57 
	msz
;

58 } 
	gtfw_wl_m¨ks
;

60 
	#S_CRLFCRLF
 "\r\n\r\n"

	)

61 
	#S_HTTP
 "hâp://"

	)

63 
	#S_0
 "HTTP/1.1 "

	)

64 
	#S_200
 "HTTP/1.1 200 OK"

	)

65 
	#S_302
 "HTTP/1.1 302 Found"

	)

66 
	#S_304
 "HTTP/1.1 304 NŸ Modifõd"

	)

67 
	#S_400
 "HTTP/1.1 400 Bad Reque°"

	)

68 
	#S_403
 "HTTP/1.1 403 F‹biddí"

	)

69 
	#S_404
 "HTTP/1.1 404 NŸ Found"

	)

70 
	#S_412
 "HTTP/1.1 412 Pªc⁄dôi⁄ Faûed"

	)

71 
	#S_500
 "HTTP/1.1 500 I¡î«»Sîvî Eº‹"

	)

72 
	#S_502
 "HTTP/1.1 502 Bad G©eway"

	)

73 
	#S_503
 "HTTP/1.1 503 Sîvi˚ U«vaûabÀ"

	)

74 
	#S_504
 "HTTP/1.1 504 G©eway Timeout"

	)

76 
	#S_F_HOST
 "Ho°: "

	)

77 
	#S_F_DATE
 "D©e: "

	)

78 
	#S_F_CONTENT_LENGTH
 "C⁄ã¡-Lígth: "

	)

79 
	#S_F_LOCATION
 "Loˇti⁄: "

	)

80 
	#S_F_CONNECTION
 "C⁄√˘i⁄: "

	)

81 
	#S_F_ETAG
 "ETag: "

	)

82 
	#S_F_RETRY_AFTER
 "Rëry-A·î: "

	)

83 
	#S_F_SERVER
 "Sîvî: "

	)

85 
	#S_V_DATE
 "Sun, 06 Nov 1994 08:49:37 GMT"

	)

86 
	#S_V_CONTENT_LENGTH
 "9999"

	)

87 
	#S_V_CONN_CLOSE
 "˛o£"

	)

88 
	#S_V_CONN_KA
 "kìp-Æive"

	)

89 
	#S_V_RETRY_AFTER
 "10"

	)

91 
	#S_H_CONN_KA
 
S_F_CONNECTION
 
S_V_CONN_KA
 
S_CRLFCRLF


	)

92 
	#S_H_CONN_CLOSE
 
S_F_CONNECTION
 
S_V_CONN_CLOSE
 
S_CRLFCRLF


	)

94 
	#S_200_PART_01
 
S_200
 
S_CRLF
 
S_F_DATE


	)

95 
	#S_200_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

96 
	#S_400_PART_01
 
S_400
 
S_CRLF
 
S_F_DATE


	)

97 
	#S_400_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

98 
	#S_403_PART_01
 
S_403
 
S_CRLF
 
S_F_DATE


	)

99 
	#S_403_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

100 
	#S_404_PART_01
 
S_404
 
S_CRLF
 
S_F_DATE


	)

101 
	#S_404_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

102 
	#S_412_PART_01
 
S_412
 
S_CRLF
 
S_F_DATE


	)

103 
	#S_412_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

104 
	#S_500_PART_01
 
S_500
 
S_CRLF
 
S_F_DATE


	)

105 
	#S_500_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

106 
	#S_502_PART_01
 
S_502
 
S_CRLF
 
S_F_DATE


	)

107 
	#S_502_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

108 
	#S_503_PART_01
 
S_503
 
S_CRLF
 
S_F_DATE


	)

109 
	#S_503_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" S_CRLF \

110 
S_F_RETRY_AFTER
 
S_V_RETRY_AFTER
 
S_CRLF


	)

111 
	#S_504_PART_01
 
S_504
 
S_CRLF
 
S_F_DATE


	)

112 
	#S_504_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

113 
	#S_DEF_PART_02
 
S_CRLF
 
S_F_CONTENT_LENGTH
 "0" 
	)
S_CRLF

114 
	#S_DEF_PART_03
 
S_F_SERVER
 
TFW_NAME
 "/" 
TFW_VERSION
 
S_CRLF


	)

119 
TfwSå
 
	ghâp_¥edef_ª•s
[
RESP_NUM
] = {

120 [
RESP_200
] = {

121 .
±r
 = (
TfwSå
 []){

122 { .
±r
 = 
S_200_PART_01
, .
	gÀn
 = 
SLEN
(S_200_PART_01) },

123 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

124 { .
	g±r
 = 
S_200_PART_02
, .
	gÀn
 = 
SLEN
(S_200_PART_02) },

125 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

126 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

127 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

129 .
	gÀn
 = 
SLEN
(
S_200_PART_01
 
S_V_DATE
 
S_200_PART_02
 
S_DEF_PART_03


130 
S_CRLF
),

131 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


134 [
RESP_400
] = {

135 .
±r
 = (
TfwSå
 []){

136 { .
±r
 = 
S_400_PART_01
, .
	gÀn
 = 
SLEN
(S_400_PART_01) },

137 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

138 { .
	g±r
 = 
S_400_PART_02
, .
	gÀn
 = 
SLEN
(S_400_PART_02) },

139 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

140 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

141 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

143 .
	gÀn
 = 
SLEN
(
S_400_PART_01
 
S_V_DATE
 
S_400_PART_02
 
S_DEF_PART_03


144 
S_CRLF
),

145 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


148 [
RESP_403
] = {

149 .
±r
 = (
TfwSå
 []){

150 { .
±r
 = 
S_403_PART_01
, .
	gÀn
 = 
SLEN
(S_403_PART_01) },

151 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

152 { .
	g±r
 = 
S_403_PART_02
, .
	gÀn
 = 
SLEN
(S_403_PART_02) },

153 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

154 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

155 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

157 .
	gÀn
 = 
SLEN
(
S_403_PART_01
 
S_V_DATE
 
S_403_PART_02
 
S_DEF_PART_03


158 
S_CRLF
),

159 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


162 [
RESP_404
] = {

163 .
±r
 = (
TfwSå
 []){

164 { .
±r
 = 
S_404_PART_01
, .
	gÀn
 = 
SLEN
(S_404_PART_01) },

165 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

166 { .
	g±r
 = 
S_404_PART_02
, .
	gÀn
 = 
SLEN
(S_404_PART_02) },

167 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

168 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

169 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

171 .
	gÀn
 = 
SLEN
(
S_404_PART_01
 
S_V_DATE
 
S_404_PART_02
 
S_DEF_PART_03


172 
S_CRLF
),

173 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


175 [
RESP_412
] = {

176 .
±r
 = (
TfwSå
 []){

177 { .
±r
 = 
S_412_PART_01
, .
	gÀn
 = 
SLEN
(S_412_PART_01) },

178 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

179 { .
	g±r
 = 
S_412_PART_02
, .
	gÀn
 = 
SLEN
(S_412_PART_02) },

180 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

181 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

182 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

184 .
	gÀn
 = 
SLEN
(
S_412_PART_01
 
S_V_DATE
 
S_412_PART_02
 
S_DEF_PART_03


185 
S_CRLF
),

186 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


189 [
RESP_500
] = {

190 .
±r
 = (
TfwSå
 []){

191 { .
±r
 = 
S_500_PART_01
, .
	gÀn
 = 
SLEN
(S_500_PART_01) },

192 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

193 { .
	g±r
 = 
S_500_PART_02
, .
	gÀn
 = 
SLEN
(S_500_PART_02) },

194 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

195 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

196 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

198 .
	gÀn
 = 
SLEN
(
S_500_PART_01
 
S_V_DATE
 
S_500_PART_02
 
S_DEF_PART_03


199 
S_CRLF
),

200 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


203 [
RESP_502
] = {

204 .
±r
 = (
TfwSå
 []){

205 { .
±r
 = 
S_502_PART_01
, .
	gÀn
 = 
SLEN
(S_502_PART_01) },

206 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

207 { .
	g±r
 = 
S_502_PART_02
, .
	gÀn
 = 
SLEN
(S_502_PART_02) },

208 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

209 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

210 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

212 .
	gÀn
 = 
SLEN
(
S_502_PART_01
 
S_V_DATE
 
S_502_PART_02
 
S_DEF_PART_03


213 
S_CRLF
),

214 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


221 [
RESP_503
] = {

222 .
±r
 = (
TfwSå
 []){

223 { .
±r
 = 
S_503_PART_01
, .
	gÀn
 = 
SLEN
(S_503_PART_01) },

224 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

225 { .
	g±r
 = 
S_503_PART_02
, .
	gÀn
 = 
SLEN
(S_503_PART_02) },

226 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

227 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

228 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

230 .
	gÀn
 = 
SLEN
(
S_503_PART_01
 
S_V_DATE
 
S_503_PART_02
 
S_DEF_PART_03


231 
S_CRLF
),

232 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


235 [
RESP_504
] = {

236 .
±r
 = (
TfwSå
 []){

237 { .
±r
 = 
S_504_PART_01
, .
	gÀn
 = 
SLEN
(S_504_PART_01) },

238 { .
	g±r
 = 
NULL
, .
	gÀn
 = 
SLEN
(
S_V_DATE
) },

239 { .
	g±r
 = 
S_504_PART_02
, .
	gÀn
 = 
SLEN
(S_504_PART_02) },

240 { .
	g±r
 = 
S_DEF_PART_03
, .
	gÀn
 = 
SLEN
(S_DEF_PART_03) },

241 { .
	g±r
 = 
S_CRLF
, .
	gÀn
 = 
SLEN
(S_CRLF) },

242 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

244 .
	gÀn
 = 
SLEN
(
S_504_PART_01
 
S_V_DATE
 
S_504_PART_02
 
S_DEF_PART_03


245 
S_CRLF
),

246 .
	gÊags
 = 6 << 
TFW_STR_CN_SHIFT


262 
	#TFW_STR_START_CH
(
msg
Ë
	`__TFW_STR_CH
(msg, 0)

	)

263 
	#TFW_STR_DATE_CH
(
msg
Ë
	`__TFW_STR_CH
(msg, 1)

	)

264 
	#TFW_STR_CLEN_CH
(
msg
Ë
	`__TFW_STR_CH
(msg, 2)

	)

265 
	#TFW_STR_SRV_CH
(
msg
Ë
	`__TFW_STR_CH
(msg, 3)

	)

266 
	#TFW_STR_CRLF_CH
(
msg
Ë
	`__TFW_STR_CH
(msg, 4)

	)

267 
	#TFW_STR_BODY_CH
(
msg
Ë
	`__TFW_STR_CH
(msg, 5)

	)

274 
TfwSå
 
	ghâp_4xx_ª•_body
 = {

275 .
±r
 = (
TfwSå
 []){

276 { .
±r
 = 
NULL
, .
	gÀn
 = 0 },

277 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

279 .
	gÀn
 = 0,

281 
TfwSå
 
	ghâp_5xx_ª•_body
 = {

282 .
±r
 = (
TfwSå
 []){

283 { .
±r
 = 
NULL
, .
	gÀn
 = 0 },

284 { .
	g±r
 = 
NULL
, .
	gÀn
 = 0 },

286 .
	gÀn
 = 0,

294 
	$tfw_hâp_¥ï_d©e_‰om
(*
buf
, 
time_t
 
d©e
)

296 
tm
Åm;

297 *
±r
 = 
buf
;

299 c⁄° * c⁄° 
wday
[] =

302 c⁄° * c⁄° 
m⁄th
[] =

306 
	#PRINT_2DIGIT
(
p
, 
n
) \

307 *
p
++ = (
n
 <= 9) ? '0' : '0' +Ç / 10; \

308 *
p
++ = '0' + 
n
 % 10;

	)

310 
	`time_to_tm
(
d©e
, 0, &
tm
);

312 
	`mem˝y
(
±r
, 
wday
[
tm
.
tm_wday
], 5);

313 
±r
 += 5;

314 
	`PRINT_2DIGIT
(
±r
, 
tm
.
tm_mday
);

315 
	`mem˝y
(
±r
, 
m⁄th
[
tm
.
tm_m⁄
], 5);

316 
±r
 += 5;

317 
	`PRINT_2DIGIT
(
±r
, (
tm
.
tm_yór
 + 1900) / 100);

318 
	`PRINT_2DIGIT
(
±r
, (
tm
.
tm_yór
 + 1900) % 100);

319 *
±r
++ = ' ';

320 
	`PRINT_2DIGIT
(
±r
, 
tm
.
tm_hour
);

321 *
±r
++ = ':';

322 
	`PRINT_2DIGIT
(
±r
, 
tm
.
tm_mö
);

323 *
±r
++ = ':';

324 
	`PRINT_2DIGIT
(
±r
, 
tm
.
tm_£c
);

325 
	`mem˝y
(
±r
, " GMT", 4);

326 #unde‡
PRINT_2DIGIT


327 
	}
}

329 
ölöe
 

330 
	$tfw_hâp_¥ï_d©e
(*
buf
)

332 
	`tfw_hâp_¥ï_d©e_‰om
(
buf
, 
	`tfw_cuºít_time°amp
());

333 
	}
}

335 
tfw_hash_°r
(c⁄° 
TfwSå
 *
°r
);

337 
	#S_REDIR_302
 
S_302
 
S_CRLF


	)

338 
	#S_REDIR_503
 
S_503
 
S_CRLF


	)

339 
	#S_REDIR_GEN
 " Redúe˘i⁄" 
S_CRLF


	)

340 
	#S_REDIR_P_01
 
S_F_DATE


	)

341 
	#S_REDIR_P_02
 
S_CRLF
 
S_F_LOCATION


	)

342 
	#S_REDIR_P_03
 
S_CRLF
 
S_F_SET_COOKIE


	)

343 
	#S_REDIR_KEEP
 
S_CRLF
 
S_F_CONNECTION
 
S_V_CONN_KA
 
	)
S_CRLF

344 
	#S_REDIR_CLOSE
 
S_CRLF
 
S_F_CONNECTION
 
S_V_CONN_CLOSE
 
	)
S_CRLF

345 
	#S_REDIR_C_LEN
 
S_F_CONTENT_LENGTH
 "0" 
S_CRLFCRLF


	)

353 
	$tfw_hâp_¥ï_ªdúe˘
(
TfwHâpMsg
 *
ª•
, 
°©us
, 
TfwSå
 *
cookõ
,

354 
TfwSå
 *
body
)

356 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

357 
size_t
 
d©a_Àn
;

358 
c⁄n_Êag
 = 
ªq
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
, 
ªt
 = 0;

359 
TfwMsgIãr
 
ô
;

360 
TfwSå
 
rh_302
 = {

361 .
±r
 = 
S_REDIR_302
, .
Àn
 = 
	`SLEN
(S_REDIR_302) };

362 
TfwSå
 
rh_503
 = {

363 .
±r
 = 
S_REDIR_503
, .
Àn
 = 
	`SLEN
(S_REDIR_503) };

364 
TfwSå
 
rh_gí
 = {

365 .
±r
 = (
TfwSå
 []){

366 { .
±r
 = 
S_0
, .
Àn
 = 
	`SLEN
(S_0) },

367 { .
±r
 = (*
	`this_˝u_±r
(&
g_buf
Ë+ 
RESP_BUF_LEN
 / 2),

368 .
Àn
 = 3 },

369 { .
±r
 = 
S_REDIR_GEN
, .
Àn
 = 
	`SLEN
(S_REDIR_GEN) }

371 .
Àn
 = 
	`SLEN
(
S_0
 
S_REDIR_GEN
) + 3,

372 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


374 
TfwSå
 
h_comm⁄_1
 = {

375 .
±r
 = (
TfwSå
 []){

376 { .
±r
 = 
S_REDIR_P_01
, .
Àn
 = 
	`SLEN
(S_REDIR_P_01) },

377 { .
±r
 = *
	`this_˝u_±r
(&
g_buf
), .
Àn
 = 
	`SLEN
(
S_V_DATE
) },

378 { .
±r
 = 
S_REDIR_P_02
, .
Àn
 = 
	`SLEN
(S_REDIR_P_02) }

380 .
Àn
 = 
	`SLEN
(
S_REDIR_P_01
 
S_V_DATE
 
S_REDIR_P_02
),

381 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


383 
TfwSå
 
h_comm⁄_2
 = {

384 .
±r
 = 
S_REDIR_P_03
, .
Àn
 = 
	`SLEN
(S_REDIR_P_03) };

385 
TfwSå
 
¸lf
 = {

386 .
±r
 = 
S_CRLF
, .
Àn
 = 
	`SLEN
(S_CRLF) };

387 
TfwSå
 
¸lf_kìp
 = {

388 .
±r
 = 
S_REDIR_KEEP
, .
Àn
 = 
	`SLEN
(S_REDIR_KEEP) };

389 
TfwSå
 
¸lf_˛o£
 = {

390 .
±r
 = 
S_REDIR_CLOSE
, .
Àn
 = 
	`SLEN
(S_REDIR_CLOSE) };

391 
TfwSå
 
c_Àn_¸lf
 = {

392 .
±r
 = 
S_REDIR_C_LEN
, .
Àn
 = 
	`SLEN
(S_REDIR_C_LEN) };

393 
TfwSå
 
ho°
, *
rh
, *
cookõ_¸lf
 = &
¸lf
, *
r_íd
;

395 i‡(
°©us
 == 302) {

396 
rh
 = &
rh_302
;

397 } i‡(
°©us
 == 503) {

398 
rh
 = &
rh_503
;

400 
	`tfw_u…ﬂ
(
°©us
, 
	`__TFW_STR_CH
(&
rh_gí
, 1)->
±r
, 3);

401 
rh
 = &
rh_gí
;

403 i‡(
body
)

404 
r_íd
 = 
body
;

406 
r_íd
 = &
c_Àn_¸lf
;

408 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
],

409 
TFW_HTTP_HDR_HOST
, &
ho°
);

410 i‡(
	`TFW_STR_EMPTY
(&
ho°
))

411 
ho°
 = 
ªq
->host;

414 i‡(
c⁄n_Êag
 =
TFW_HTTP_F_CONN_CLOSE
)

415 
cookõ_¸lf
 = &
¸lf_˛o£
;

416 i‡(
c⁄n_Êag
 =
TFW_HTTP_F_CONN_KA
)

417 
cookõ_¸lf
 = &
¸lf_kìp
;

420 
d©a_Àn
 = 
rh
->
Àn
 + 
h_comm⁄_1
.len;

421 
d©a_Àn
 +
ho°
.
Àn
 ? ho°.À¿+ 
	`SLEN
(
S_HTTP
) : 0;

422 
d©a_Àn
 +
ªq
->
uri_∑th
.
Àn
 + 
h_comm⁄_2
.À¿+ 
cookõ
->len;

423 
d©a_Àn
 +
cookõ_¸lf
->
Àn
 + 
r_íd
->len;

425 i‡(
	`tfw_hâp_msg_£tup
(
ª•
, &
ô
, 
d©a_Àn
))

426  
TFW_BLOCK
;

428 
	`tfw_hâp_¥ï_d©e
(
	`__TFW_STR_CH
(&
h_comm⁄_1
, 1)->
±r
);

430 
ªt
 = 
	`tfw_msg_wrôe
(&
ô
, 
rh
);

431 
ªt
 = 
	`tfw_msg_wrôe
(&
ô
, &
h_comm⁄_1
);

436 i‡(
ho°
.
Àn
) {

437 
TfwSå
 
¥Ÿo
 = { .
±r
 = 
S_HTTP
, .
Àn
 = 
	`SLEN
(S_HTTP) };

438 
ªt
 |
	`tfw_msg_wrôe
(&
ô
, &
¥Ÿo
);

439 
ªt
 |
	`tfw_msg_wrôe
(&
ô
, &
ho°
);

441 
ªt
 |
	`tfw_msg_wrôe
(&
ô
, &
ªq
->
uri_∑th
);

442 
ªt
 |
	`tfw_msg_wrôe
(&
ô
, &
h_comm⁄_2
);

443 
ªt
 |
	`tfw_msg_wrôe
(&
ô
, 
cookõ
);

444 
ªt
 |
	`tfw_msg_wrôe
(&
ô
, 
cookõ_¸lf
);

445 
ªt
 |
	`tfw_msg_wrôe
(&
ô
, 
r_íd
);

447  
ªt
;

448 
	}
}

450 
	#S_304_PART_01
 
S_304
 
S_CRLF


	)

451 
	#S_304_KEEP
 
S_F_CONNECTION
 
S_V_CONN_KA
 
S_CRLF


	)

452 
	#S_304_CLOSE
 
S_F_CONNECTION
 
S_V_CONN_CLOSE
 
S_CRLF


	)

457 
	$tfw_hâp_¥ï_304
(
TfwHâpMsg
 *
ª•
, 
TfwHâpReq
 *
ªq
, 
TfwMsgIãr
 *
ô
,

458 
size_t
 
hdrs_size
)

460 
size_t
 
d©a_Àn
 = 
	`SLEN
(
S_304_PART_01
);

461 
c⁄n_Êag
 = 
ªq
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
, 
ªt
 = 0;

462 
TfwSå
 
rh
 = {

463 .
±r
 = 
S_304_PART_01
, .
Àn
 = 
	`SLEN
(S_304_PART_01) };

464 
TfwSå
 
¸lf_kìp
 = {

465 .
±r
 = 
S_304_KEEP
, .
Àn
 = 
	`SLEN
(S_304_KEEP) };

466 
TfwSå
 
¸lf_˛o£
 = {

467 .
±r
 = 
S_304_CLOSE
, .
Àn
 = 
	`SLEN
(S_304_CLOSE) };

468 
TfwSå
 *
íd
 = 
NULL
;

471 i‡(
c⁄n_Êag
 =
TFW_HTTP_F_CONN_CLOSE
)

472 
íd
 = &
¸lf_˛o£
;

473 i‡(
c⁄n_Êag
 =
TFW_HTTP_F_CONN_KA
)

474 
íd
 = &
¸lf_kìp
;

477 
d©a_Àn
 +
hdrs_size
;

478 i‡(
íd
)

479 
d©a_Àn
 +
íd
->
Àn
;

481 i‡(
	`tfw_hâp_msg_£tup
(
ª•
, 
ô
, 
d©a_Àn
))

482  
TFW_BLOCK
;

484 
ªt
 = 
	`tfw_msg_wrôe
(
ô
, &
rh
);

485 i‡(
íd
)

486 
ªt
 |
	`tfw_msg_wrôe
(
ô
, 
íd
);

488 
	`TFW_DBG
("Send HTTP 304Ñesponse\n");

490  
ªt
 ? 
TFW_BLOCK
 : 
TFW_PASS
;

491 
	}
}

511 
	$tfw_hâp_c⁄n_msg_‰ì
(
TfwHâpMsg
 *
hm
)

513 i‡(
	`u∆ikñy
(!
hm
))

516 i‡(
hm
->
c⁄n
) {

521 
	`WARN_ON_ONCE
((
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_C t
Ë&& hm->
∑ú
);

528 
	`__cmpxchg
((*)&
hm
->
c⁄n
->
msg
, ()hm,

530 
	`tfw_c⁄√˘i⁄_put
(
hm
->
c⁄n
);

533 
	`tfw_hâp_msg_‰ì
(
hm
);

534 
	}
}

540 
ölöe
 

541 
	$tfw_hâp_c⁄n_ªq_˛ón
(
TfwHâpReq
 *
ªq
)

543 
	`•ö_lock_bh
(&((
TfwCliC⁄n
 *)
ªq
->
c⁄n
)->
£q_qlock
);

544 i‡(
	`likñy
(!
	`li°_em±y
(&
ªq
->
msg
.
£q_li°
)))

545 
	`li°_dñ_öô
(&
ªq
->
msg
.
£q_li°
);

546 
	`•ö_u∆ock_bh
(&((
TfwCliC⁄n
 *)
ªq
->
c⁄n
)->
£q_qlock
);

547 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

548 
	}
}

569 
	$tfw_hâp_ª•_buûd_îr‹
(
TfwHâpReq
 *
ªq
)

571 
	`tfw_c⁄√˘i⁄_˛o£
(
ªq
->
c⁄n
, 
åue
);

572 
	`tfw_hâp_c⁄n_ªq_˛ón
(
ªq
);

573 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

574 
	}
}

588 
	$__tfw_hâp_£nd_ª•
(
TfwHâpReq
 *
ªq
, 
ª•_code_t
 
code
)

590 
TfwMsgIãr
 
ô
;

591 
TfwHâpRe•
 *
ª•
;

592 
TfwSå
 *
d©e
, *
¸lf
, *
body
;

593 
c⁄n_Êag
 = 
ªq
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
;

594 
TfwSå
 
msg
 = {

595 .
±r
 = (
TfwSå
 []){ {}, {}, {}, {}, {}, {} },

596 .
Àn
 = 0,

597 .
Êags
 = 6 << 
TFW_STR_CN_SHIFT


600 i‡(
	`tfw_°r˝y_desc
(&
msg
, &
hâp_¥edef_ª•s
[
code
]))

601 
îr
;

603 
¸lf
 = 
	`TFW_STR_CRLF_CH
(&
msg
);

604 i‡(
c⁄n_Êag
) {

605 
¸lf_Àn
 = 
¸lf
->
Àn
;

606 i‡(
c⁄n_Êag
 =
TFW_HTTP_F_CONN_KA
) {

607 
¸lf
->
±r
 = 
S_H_CONN_KA
;

608 
¸lf
->
Àn
 = 
	`SLEN
(
S_H_CONN_KA
);

610 
¸lf
->
±r
 = 
S_H_CONN_CLOSE
;

611 
¸lf
->
Àn
 = 
	`SLEN
(
S_H_CONN_CLOSE
);

613 
msg
.
Àn
 +
¸lf
->À¿- 
¸lf_Àn
;

616 i‡(!(
ª•
 = 
	`tfw_hâp_msg_Æloc_ª•_light
(
ªq
)))

617 
îr
;

618 i‡(
	`tfw_hâp_msg_£tup
((
TfwHâpMsg
 *)
ª•
, &
ô
, 
msg
.
Àn
))

619 
îr_£tup
;

621 
body
 = 
	`TFW_STR_BODY_CH
(&
msg
);

622 
d©e
 = 
	`TFW_STR_DATE_CH
(&
msg
);

623 
d©e
->
±r
 = *
	`this_˝u_±r
(&
g_buf
);

624 
	`tfw_hâp_¥ï_d©e
(
d©e
->
±r
);

625 i‡(!
body
->
±r
)

626 
	`__TFW_STR_CHUNKN_SET
(&
msg
, 5);

628 i‡(
	`tfw_msg_wrôe
(&
ô
, &
msg
))

629 
îr_£tup
;

631 
	`tfw_hâp_ª•_fwd
(
ª•
);

634 
îr_£tup
:

635 
	`TFW_DBG2
("%s: Response messageállocationÉrror: conn=[%p]\n",

636 
__func__
, 
ªq
->
c⁄n
);

637 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

638 
îr
:

639 
	`tfw_hâp_ª•_buûd_îr‹
(
ªq
);

640 
	}
}

655 
ölöe
 

656 
	$tfw_hâp_ªq_öô_ss_Êags
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
)

658 ((
TfwMsg
 *)
ªq
)->
ss_Êags
 |
SS_F_KEEP_SKB
;

659 
	}
}

661 
ölöe
 

662 
	$tfw_hâp_ª•_öô_ss_Êags
(
TfwHâpRe•
 *
ª•
, c⁄° 
TfwHâpReq
 *
ªq
)

664 i‡(
ªq
->
Êags
 & (
TFW_HTTP_F_CONN_CLOSE
 | 
TFW_HTTP_F_SUSPECTED
))

665 ((
TfwMsg
 *)
ª•
)->
ss_Êags
 |
SS_F_CONN_CLOSE
;

666 
	}
}

671 
ölöe
 
boﬁ


672 
	$tfw_hâp_ªq_is_nù
(
TfwHâpReq
 *
ªq
)

674  (
ªq
->
Êags
 & 
TFW_HTTP_F_NON_IDEMP
);

675 
	}
}

680 
ölöe
 

681 
	$tfw_hâp_c⁄n_nù_ª£t
(
TfwSrvC⁄n
 *
§v_c⁄n
)

683 i‡(
	`li°_em±y
(&
§v_c⁄n
->
nù_queue
))

684 
	`˛ór_bô
(
TFW_CONN_B_HASNIP
, &
§v_c⁄n
->
Êags
);

685 
	}
}

691 
ölöe
 

692 
	$tfw_hâp_ªq_nù_íli°
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
)

694 
	`BUG_ON
(!
	`li°_em±y
(&
ªq
->
nù_li°
));

695 
	`li°_add_èû
(&
ªq
->
nù_li°
, &
§v_c⁄n
->
nù_queue
);

696 
	`£t_bô
(
TFW_CONN_B_HASNIP
, &
§v_c⁄n
->
Êags
);

697 
	}
}

706 
ölöe
 

707 
	$tfw_hâp_ªq_nù_dñi°
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
)

709 i‡(!
	`li°_em±y
(&
ªq
->
nù_li°
)) {

710 
	`li°_dñ_öô
(&
ªq
->
nù_li°
);

711 
	`tfw_hâp_c⁄n_nù_ª£t
(
§v_c⁄n
);

713 
	}
}

722 
ölöe
 

723 
	$tfw_hâp_c⁄n_nù_adju°
(
TfwSrvC⁄n
 *
§v_c⁄n
)

725 
TfwHâpReq
 *
ªq
, *
tmp
;

727 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, &
§v_c⁄n
->
nù_queue
, 
nù_li°
)

728 i‡(!
	`tfw_hâp_ªq_is_nù
(
ªq
)) {

729 
	`BUG_ON
(
	`li°_em±y
(&
ªq
->
nù_li°
));

730 
	`li°_dñ_öô
(&
ªq
->
nù_li°
);

732 
	`tfw_hâp_c⁄n_nù_ª£t
(
§v_c⁄n
);

733 
	}
}

739 
ölöe
 
boﬁ


740 
	$tfw_hâp_c⁄n_⁄_hﬁd
(
TfwSrvC⁄n
 *
§v_c⁄n
)

742 
TfwHâpReq
 *
ªq_£¡
 = (TfwHâpReq *)
§v_c⁄n
->
msg_£¡
;

744 
	`BUG_ON
(!(
	`TFW_CONN_TYPE
(
§v_c⁄n
Ë& 
C⁄n_Srv
));

745  (
ªq_£¡
 && 
	`tfw_hâp_ªq_is_nù
(req_sent));

746 
	}
}

753 
ölöe
 
boﬁ


754 
	$tfw_hâp_c⁄n_døöed
(
TfwSrvC⁄n
 *
§v_c⁄n
)

756 
li°_hód
 *
fwd_queue
 = &
§v_c⁄n
->fwd_queue;

757 
TfwHâpReq
 *
ªq_£¡
 = (TfwHâpReq *)
§v_c⁄n
->
msg_£¡
;

759 
	`BUG_ON
(!(
	`TFW_CONN_TYPE
(
§v_c⁄n
Ë& 
C⁄n_Srv
));

761 i‡(
	`li°_em±y
(
fwd_queue
))

762  
åue
;

763 i‡(!
ªq_£¡
)

764  
Ál£
;

765 i‡(
	`li°_is_œ°
(&
ªq_£¡
->
fwd_li°
, 
fwd_queue
))

766  
åue
;

767  
Ál£
;

768 
	}
}

774 
ölöe
 
boﬁ


775 
	$tfw_hâp_c⁄n_√ed_fwd
(
TfwSrvC⁄n
 *
§v_c⁄n
)

777  (!
	`tfw_hâp_c⁄n_⁄_hﬁd
(
§v_c⁄n
)

778 && !
	`tfw_hâp_c⁄n_døöed
(
§v_c⁄n
));

779 
	}
}

784 
ölöe
 
TfwMsg
 *

785 
	$__tfw_hâp_c⁄n_msg_£¡_¥ev
(
TfwSrvC⁄n
 *
§v_c⁄n
)

787 
TfwHâpReq
 *
ªq_£¡
 = (TfwHâpReq *)
§v_c⁄n
->
msg_£¡
;

794  (
§v_c⁄n
->
fwd_queue
.
√xt
 =&
ªq_£¡
->
fwd_li°
) ?

795 
NULL
 : (
TfwMsg
 *)
	`li°_¥ev_íåy
(
ªq_£¡
, 
fwd_li°
);

796 
	}
}

801 
ölöe
 

802 
	$__hâp_ªq_dñi°
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
)

804 
	`tfw_hâp_ªq_nù_dñi°
(
§v_c⁄n
, 
ªq
);

805 
	`li°_dñ_öô
(&
ªq
->
fwd_li°
);

806 
§v_c⁄n
->
qsize
--;

807 
	}
}

809 
ölöe
 

810 
	$tfw_hâp_ªq_dñi°
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
)

812 
	`•ö_lock
(&
§v_c⁄n
->
fwd_qlock
);

813 
	`__hâp_ªq_dñi°
(
§v_c⁄n
, 
ªq
);

814 
	`•ö_u∆ock
(&
§v_c⁄n
->
fwd_qlock
);

815 
	}
}

823 
ölöe
 

824 
	$__tfw_hâp_ªq_îr
(
TfwHâpReq
 *
ªq
, 
li°_hód
 *
eq
,

825 
°©us
, c⁄° *
ªas⁄
)

827 
	`li°_add_èû
(&
ªq
->
fwd_li°
, 
eq
);

828 
ªq
->
hâ≥º
.
°©us
 = status;

829 
ªq
->
hâ≥º
.
ªas⁄
 =Ñeason;

830 
	}
}

832 
ölöe
 

833 
	$tfw_hâp_ªq_îr
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
,

834 
li°_hód
 *
eq
, 
°©us
,

835 c⁄° *
ªas⁄
)

837 i‡(
§v_c⁄n
)

838 
	`__hâp_ªq_dñi°
(
§v_c⁄n
, 
ªq
);

839 
	`__tfw_hâp_ªq_îr
(
ªq
, 
eq
, 
°©us
, 
ªas⁄
);

840 
	}
}

842 
ölöe
 

843 
	$tfw_hâp_nù_ªq_ªsched_îr
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
,

844 
li°_hód
 *
eq
)

846 
	`tfw_hâp_ªq_îr
(
§v_c⁄n
, 
ªq
, 
eq
, 504,

849 
	}
}

851 
ölöe
 
ª•_code_t


852 
	$tfw_hâp_íum_ª•_code
(
°©us
)

854 
°©us
) {

856  
RESP_200
;

858  
RESP_400
;

860  
RESP_403
;

862  
RESP_404
;

864  
RESP_412
;

866  
RESP_500
;

868  
RESP_502
;

870  
RESP_503
;

872  
RESP_504
;

874  
RESP_NUM
;

876 
	}
}

878 
ölöe
 

879 
	$tfw_hâp_îr‹_ª•_swôch
(
TfwHâpReq
 *
ªq
, 
°©us
)

881 
ª•_code_t
 
code
 = 
	`tfw_hâp_íum_ª•_code
(
°©us
);

882 i‡(
code
 =
RESP_NUM
) {

883 
	`TFW_WARN
("U√x≥˘edÑe•⁄£Éº‹ code: [%d]\n", 
°©us
);

884 
code
 = 
RESP_500
;

886 
	`__tfw_hâp_£nd_ª•
(
ªq
, 
code
);

887 
	}
}

891 
	$tfw_hâp_£nd_ª•
(
TfwHâpReq
 *
ªq
, 
°©us
, c⁄° *
ªas⁄
)

893 i‡(!(
tfw_blk_Êags
 & 
TFW_BLK_ERR_NOLOG
))

894 
	`TFW_WARN_ADDR_STATUS
(
ªas⁄
, &
ªq
->
c⁄n
->
≥î
->
addr
, 
°©us
);

895 
	`tfw_hâp_îr‹_ª•_swôch
(
ªq
, 
°©us
);

896 
	}
}

898 
boﬁ


899 
	$tfw_hâp_hm_su•íd
(
TfwHâpRe•
 *
ª•
, 
TfwSîvî
 *
§v
)

901 
ﬁd_Êags
, 
Êags
 = 
	`READ_ONCE
(
§v
->flags);

903 i‡(!(
Êags
 & 
TFW_SRV_F_HMONITOR
))

904  
åue
;

906 i‡(!
	`tfw_≠m_hm_§v_limô
(
ª•
->
°©us
, 
§v
->
≠mªf
))

907  
Ál£
;

910 
ﬁd_Êags
 = 
	`cmpxchg
(&
§v
->
Êags
, flags,

911 
Êags
 | 
TFW_SRV_F_SUSPEND
);

912 i‡(
	`likñy
(
ﬁd_Êags
 =
Êags
)) {

913 
	`TFW_WARN_ADDR_STATUS
("server has been suspended:Üimit "

915 &
§v
->
addr
, 
ª•
->
°©us
);

918 
Êags
 = 
ﬁd_Êags
;

919 } 
Êags
 & 
TFW_SRV_F_HMONITOR
);

921  
åue
;

922 
	}
}

925 
	$tfw_hâp_hm_c⁄åﬁ
(
TfwHâpRe•
 *
ª•
)

927 
TfwSîvî
 *
§v
 = (TfwSîvî *)
ª•
->
c⁄n
->
≥î
;

929 i‡(
	`tfw_hâp_hm_su•íd
(
ª•
, 
§v
))

932 i‡(!
	`tfw_§v_su•íded
(
§v
) ||

933 !
	`tfw_≠m_hm_§v_Æive
(
ª•
->
°©us
, &ª•->
body
, 
§v
->
≠mªf
))

936 
	`tfw_§v_m¨k_Æive
(
§v
);

937 
	}
}

939 
ölöe
 

940 
	$tfw_hâp_hm_§v_upd©e
(
TfwSîvî
 *
§v
, 
TfwHâpReq
 *
ªq
)

942 i‡(
	`ã°_bô
(
TFW_SRV_B_HMONITOR
, &
§v
->
Êags
))

943 
	`tfw_≠m_hm_§v_rcou¡_upd©e
(&
ªq
->
uri_∑th
, 
§v
->
≠mªf
);

944 
	}
}

947 
	$tfw_hâp_m¨ks_cmp
(c⁄° *
l
, c⁄° *
r
)

949 
m1
 = *(*)
l
;

950 
m2
 = *(*)
r
;

952  (
m1
 < 
m2
) ? -1 : (m1 > m2);

953 
	}
}

955 
ölöe
 

956 
	$tfw_hâp_m¨k_wl_√w_msg
(
TfwC⁄n
 *
c⁄n
, 
TfwHâpMsg
 *
msg
,

957 c⁄° 
sk_buff
 *
skb
)

959 i‡(!
tfw_wl_m¨ks
.
mrks
 || !(
	`TFW_CONN_TYPE
(
c⁄n
Ë& 
C⁄n_C t
))

962 i‡(
	`b£¨ch
(&
skb
->
m¨k
, 
tfw_wl_m¨ks
.
mrks
,Åfw_wl_m¨ks.
sz
,

963 (
tfw_wl_m¨ks
.
mrks
[0]), 
tfw_hâp_m¨ks_cmp
))

964 
msg
->
Êags
 |
TFW_HTTP_F_WHITELIST
;

965 
	}
}

979 
	$tfw_hâp_ªq_z≠_îr‹
(
li°_hód
 *
eq
)

981 
TfwHâpReq
 *
ªq
, *
tmp
;

983 
	`TFW_DBG2
("%s: queue is %sempty\n",

984 
__func__
, 
	`li°_em±y
(
eq
) ? "" : "NOT ");

985 i‡(
	`li°_em±y
(
eq
))

988 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, 
eq
, 
fwd_li°
) {

989 
	`li°_dñ_öô
(&
ªq
->
fwd_li°
);

990 i‡(!(
ªq
->
Êags
 & 
TFW_HTTP_F_REQ_DROP
))

991 
	`tfw_hâp_£nd_ª•
(
ªq
,Ñeq->
hâ≥º
.
°©us
,

992 
ªq
->
hâ≥º
.
ªas⁄
);

994 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

995 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

997 
	}
}

1003 
ölöe
 
boﬁ


1004 
	$tfw_hâp_ªq_evi˘_dr›≥d
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
)

1006 i‡(
	`u∆ikñy
(
ªq
->
Êags
 & 
TFW_HTTP_F_REQ_DROP
)) {

1007 
	`TFW_DBG2
("%s: Eviction:Ñeq=[%p] client disconnected\n",

1008 
__func__
, 
ªq
);

1009 i‡(
§v_c⁄n
)

1010 
	`__hâp_ªq_dñi°
(
§v_c⁄n
, 
ªq
);

1011 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

1012 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

1013  
åue
;

1015  
Ál£
;

1016 
	}
}

1022 
ölöe
 
boﬁ


1023 
	$tfw_hâp_ªq_evi˘_timeout
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwSîvî
 *
§v
,

1024 
TfwHâpReq
 *
ªq
, 
li°_hód
 *
eq
)

1026 
jqage
 = 
jiffõs
 - 
ªq
->
jrxt°amp
;

1028 i‡(
	`u∆ikñy
(
	`time_a·î
(
jqage
, 
§v
->
sg
->
max_jqage
))) {

1029 
	`TFW_DBG2
("%s: Eviction:Ñeq=[%p] overdue=[%dms]\n",

1030 
__func__
, 
ªq
,

1031 
	`jiffõs_to_m£cs
(
jqage
 - 
§v
->
sg
->
max_jqage
));

1032 
	`tfw_hâp_ªq_îr
(
§v_c⁄n
, 
ªq
, 
eq
, 504,

1034  
åue
;

1036  
Ál£
;

1037 
	}
}

1043 
ölöe
 
boﬁ


1044 
	$tfw_hâp_ªq_evi˘_ªåõs
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwSîvî
 *
§v
,

1045 
TfwHâpReq
 *
ªq
, 
li°_hód
 *
eq
)

1047 i‡(
	`u∆ikñy
(
ªq
->
ªåõs
++ >
§v
->
sg
->
max_ªfwd
)) {

1048 
	`TFW_DBG2
("%s: Eviction:Ñeq=[%p]Ñetries=[%d]\n",

1049 
__func__
, 
ªq
,Ñeq->
ªåõs
);

1050 
	`tfw_hâp_ªq_îr
(
§v_c⁄n
, 
ªq
, 
eq
, 504,

1053  
åue
;

1055  
Ál£
;

1056 
	}
}

1058 
ölöe
 
boﬁ


1059 
	$tfw_hâp_ªq_evi˘_°Æe_ªq
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwSîvî
 *
§v
,

1060 
TfwHâpReq
 *
ªq
, 
li°_hód
 *
eq
)

1062  
	`tfw_hâp_ªq_evi˘_dr›≥d
(
§v_c⁄n
, 
ªq
)

1063 || 
	`tfw_hâp_ªq_evi˘_timeout
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
);

1064 
	}
}

1066 
ölöe
 
boﬁ


1067 
	$tfw_hâp_ªq_evi˘
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwSîvî
 *
§v
, 
TfwHâpReq
 *
ªq
,

1068 
li°_hód
 *
eq
)

1070  
	`tfw_hâp_ªq_evi˘_dr›≥d
(
§v_c⁄n
, 
ªq
)

1071 || 
	`tfw_hâp_ªq_evi˘_timeout
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
)

1072 || 
	`tfw_hâp_ªq_evi˘_ªåõs
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
);

1073 
	}
}

1086 
ölöe
 
boﬁ


1087 
	$tfw_hâp_ªq_fwd_£nd
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwSîvî
 *
§v
,

1088 
TfwHâpReq
 *
ªq
, 
li°_hód
 *
eq
)

1090 
ªq
->
jtxt°amp
 = 
jiffõs
;

1091 
	`tfw_hâp_ªq_öô_ss_Êags
(
§v_c⁄n
, 
ªq
);

1093 i‡(
	`tfw_c⁄√˘i⁄_£nd
((
TfwC⁄n
 *)
§v_c⁄n
, (
TfwMsg
 *)
ªq
)) {

1094 
	`TFW_DBG2
("%s: ForwardingÉrror: conn=[%p]Ñeq=[%p]\n",

1095 
__func__
, 
§v_c⁄n
, 
ªq
);

1096 i‡(
ªq
->
Êags
 & 
TFW_HTTP_F_HMONITOR
) {

1097 
	`__hâp_ªq_dñi°
(
§v_c⁄n
, 
ªq
);

1098 
	`WARN_ON_ONCE
(
ªq
->
∑ú
);

1099 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

1100 
	`TFW_WARN_ADDR
("UnableÅo send health"

1102 &
§v_c⁄n
->
≥î
->
addr
);

1104 
	`tfw_hâp_ªq_îr
(
§v_c⁄n
, 
ªq
, 
eq
, 500,

1107  
Ál£
;

1109  
åue
;

1110 
	}
}

1116 
ölöe
 
boﬁ


1117 
	$tfw_hâp_ªq_fwd_sögÀ
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwSîvî
 *
§v
,

1118 
TfwHâpReq
 *
ªq
, 
li°_hód
 *
eq
)

1120 i‡(
	`tfw_hâp_ªq_evi˘_°Æe_ªq
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
))

1121  
Ál£
;

1122 i‡(!
	`tfw_hâp_ªq_fwd_£nd
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
))

1123  
Ál£
;

1124 
§v_c⁄n
->
msg_£¡
 = (
TfwMsg
 *)
ªq
;

1125 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_f‹w¨ded
);

1126  
åue
;

1127 
	}
}

1136 
	$tfw_hâp_c⁄n_fwd_un£¡
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
li°_hód
 *
eq
)

1138 
TfwHâpReq
 *
ªq
, *
tmp
;

1139 
TfwSîvî
 *
§v
 = (TfwSîvî *)
§v_c⁄n
->
≥î
;

1140 
li°_hód
 *
fwd_queue
 = &
§v_c⁄n
->fwd_queue;

1142 
	`TFW_DBG2
("%s: c⁄n=%pK\n", 
__func__
, 
§v_c⁄n
);

1143 
	`WARN_ON
(!
	`•ö_is_locked
(&
§v_c⁄n
->
fwd_qlock
));

1144 
	`BUG_ON
(
	`tfw_hâp_c⁄n_døöed
(
§v_c⁄n
));

1146 
ªq
 = 
§v_c⁄n
->
msg_£¡


1147 ? 
	`li°_√xt_íåy
((
TfwHâpReq
 *)
§v_c⁄n
->
msg_£¡
, 
fwd_li°
)

1148 : 
	`li°_fú°_íåy
(
fwd_queue
, 
TfwHâpReq
, 
fwd_li°
);

1150 
	`li°_f‹_óch_íåy_ß„_‰om
(
ªq
, 
tmp
, 
fwd_queue
, 
fwd_li°
) {

1151 i‡(!
	`tfw_hâp_ªq_fwd_sögÀ
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
))

1154 i‡(
	`tfw_hâp_ªq_is_nù
(
ªq
))

1157 
	`tfw_hâp_ªq_nù_dñi°
(
§v_c⁄n
, 
ªq
);

1159 
	}
}

1194 
	$tfw_hâp_ªq_fwd
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
TfwHâpReq
 *
ªq
, 
li°_hód
 *
eq
)

1196 
	`TFW_DBG2
("%s: srv_c⁄n=%pKÑeq=%pK\n", 
__func__
, 
§v_c⁄n
, 
ªq
);

1197 
	`BUG_ON
(!(
	`TFW_CONN_TYPE
(
§v_c⁄n
Ë& 
C⁄n_Srv
));

1199 
	`•ö_lock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1200 
	`li°_add_èû
(&
ªq
->
fwd_li°
, &
§v_c⁄n
->
fwd_queue
);

1201 
§v_c⁄n
->
qsize
++;

1202 i‡(
	`tfw_hâp_ªq_is_nù
(
ªq
))

1203 
	`tfw_hâp_ªq_nù_íli°
(
§v_c⁄n
, 
ªq
);

1204 i‡(
	`tfw_hâp_c⁄n_⁄_hﬁd
(
§v_c⁄n
)) {

1205 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1208 
	`tfw_hâp_c⁄n_fwd_un£¡
(
§v_c⁄n
, 
eq
);

1209 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1210 
	}
}

1226 
ölöe
 

1227 
	$tfw_hâp_c⁄n_åóäù
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
li°_hód
 *
eq
)

1229 
TfwSîvî
 *
§v
 = (TfwSîvî *)
§v_c⁄n
->
≥î
;

1230 
TfwHâpReq
 *
ªq_£¡
 = (TfwHâpReq *)
§v_c⁄n
->
msg_£¡
;

1232 i‡(
	`tfw_hâp_c⁄n_⁄_hﬁd
(
§v_c⁄n
)

1233 && !(
§v
->
sg
->
Êags
 & 
TFW_SRV_RETRY_NIP
))

1235 
	`BUG_ON
(
	`li°_em±y
(&
ªq_£¡
->
nù_li°
));

1236 
§v_c⁄n
->
msg_£¡
 = 
	`__tfw_hâp_c⁄n_msg_£¡_¥ev
(srv_conn);

1237 
	`tfw_hâp_nù_ªq_ªsched_îr
(
§v_c⁄n
, 
ªq_£¡
, 
eq
);

1239 
	}
}

1245 
TfwMsg
 *

1246 
	$tfw_hâp_c⁄n_ª£nd
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
boﬁ
 
fú°
, 
li°_hód
 *
eq
)

1248 
TfwHâpReq
 *
ªq
, *
tmp
, *
ªq_ª£¡
 = 
NULL
;

1249 
TfwSîvî
 *
§v
 = (TfwSîvî *)
§v_c⁄n
->
≥î
;

1250 
li°_hód
 *
íd
, *
fwd_queue
 = &
§v_c⁄n
->fwd_queue;

1252 
	`TFW_DBG2
("%s: conn=[%p] first=[%s]\n",

1253 
__func__
, 
§v_c⁄n
, 
fú°
 ? "true" : "false");

1254 
	`BUG_ON
(!
§v_c⁄n
->
msg_£¡
);

1255 
	`BUG_ON
(
	`li°_em±y
(&((
TfwHâpReq
 *)
§v_c⁄n
->
msg_£¡
)->
fwd_li°
));

1257 
ªq
 = 
	`li°_fú°_íåy
(
fwd_queue
, 
TfwHâpReq
, 
fwd_li°
);

1258 
íd
 = ((
TfwHâpReq
 *)
§v_c⁄n
->
msg_£¡
)->
fwd_li°
.
√xt
;

1261 
tmp
 = 
	`li°_√xt_íåy
(
ªq
, 
fwd_li°
);

1262 &
ªq
->
fwd_li°
 !
íd
;

1263 
ªq
 = 
tmp
,Åm∞
	`li°_√xt_íåy
—mp, 
fwd_li°
))

1265 i‡(
	`tfw_hâp_ªq_evi˘
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
))

1267 i‡(!
	`tfw_hâp_ªq_fwd_£nd
(
§v_c⁄n
, 
§v
, 
ªq
, 
eq
))

1269 
ªq_ª£¡
 = 
ªq
;

1270 i‡(
	`u∆ikñy
(
fú°
))

1274  (
TfwMsg
 *)
ªq_ª£¡
;

1275 
	}
}

1280 
ölöe
 

1281 
	$__tfw_§v_c⁄n_˛ór_ª°ri˘ed
(
TfwSrvC⁄n
 *
§v_c⁄n
)

1283 
	`˛ór_bô
(
TFW_CONN_B_QFORWD
, &
§v_c⁄n
->
Êags
);

1284 i‡(
	`ã°_™d_˛ór_bô
(
TFW_CONN_B_RESEND
, &
§v_c⁄n
->
Êags
))

1285 
	`TFW_DEC_STAT_BH
(
£rv
.
c⁄n_ª°ri˘ed
);

1286 
	}
}

1291 
ölöe
 
boﬁ


1292 
	$tfw_§v_c⁄n_ªíabÀ_if_d⁄e
(
TfwSrvC⁄n
 *
§v_c⁄n
)

1294 i‡(!
	`li°_em±y
(&
§v_c⁄n
->
fwd_queue
))

1295  
Ál£
;

1296 
	`BUG_ON
(
§v_c⁄n
->
qsize
);

1297 
	`BUG_ON
(
§v_c⁄n
->
msg_£¡
);

1298 
	`__tfw_§v_c⁄n_˛ór_ª°ri˘ed
(
§v_c⁄n
);

1299  
åue
;

1300 
	}
}

1308 
	$tfw_hâp_c⁄n_fwd_ª∑ú
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
li°_hód
 *
eq
)

1310 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
§v_c⁄n
);

1311 
	`WARN_ON
(!
	`•ö_is_locked
(&
§v_c⁄n
->
fwd_qlock
));

1312 
	`BUG_ON
(!
	`tfw_§v_c⁄n_ª°ri˘ed
(
§v_c⁄n
));

1314 i‡(
	`tfw_§v_c⁄n_ªíabÀ_if_d⁄e
(
§v_c⁄n
))

1316 i‡(
	`ã°_bô
(
TFW_CONN_B_QFORWD
, &
§v_c⁄n
->
Êags
)) {

1317 i‡(
	`tfw_hâp_c⁄n_√ed_fwd
(
§v_c⁄n
))

1318 
	`tfw_hâp_c⁄n_fwd_un£¡
(
§v_c⁄n
, 
eq
);

1329 i‡(
§v_c⁄n
->
msg_£¡
)

1330 
§v_c⁄n
->
msg_£¡
 =

1331 
	`tfw_hâp_c⁄n_ª£nd
(
§v_c⁄n
, 
Ál£
, 
eq
);

1332 
	`£t_bô
(
TFW_CONN_B_QFORWD
, &
§v_c⁄n
->
Êags
);

1333 i‡(
	`tfw_hâp_c⁄n_√ed_fwd
(
§v_c⁄n
))

1334 
	`tfw_hâp_c⁄n_fwd_un£¡
(
§v_c⁄n
, 
eq
);

1336 
	`tfw_§v_c⁄n_ªíabÀ_if_d⁄e
(
§v_c⁄n
);

1337 
	}
}

1348 
	$tfw_hâp_c⁄n_¢ù_fwd_queue
(
TfwSrvC⁄n
 *
§v_c⁄n
, 
li°_hód
 *
out_queue
)

1350 
TfwHâpReq
 *
ªq
, *
tmp
;

1352 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, &
§v_c⁄n
->
nù_queue
, 
nù_li°
)

1353 
	`li°_dñ_öô
(&
ªq
->
nù_li°
);

1354 
	`tfw_hâp_c⁄n_nù_ª£t
(
§v_c⁄n
);

1355 
	`li°_•li˚_èû_öô
(&
§v_c⁄n
->
fwd_queue
, 
out_queue
);

1356 
§v_c⁄n
->
qsize
 = 0;

1357 
§v_c⁄n
->
msg_£¡
 = 
NULL
;

1358 
	}
}

1365 
TfwSrvC⁄n
 *

1366 
	$tfw_hâp_gë_§v_c⁄n
(
TfwMsg
 *
msg
)

1368 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
msg
;

1369 
TfwHâpSess
 *
£ss
 = 
ªq
->sess;

1372 i‡(!
£ss
)

1373  
	`tfw_vho°_gë_§v_c⁄n
(
msg
);

1375  
	`tfw_hâp_£ss_gë_§v_c⁄n
(
msg
);

1376 
	}
}

1392 
	$tfw_hâp_ªq_ªsched
(
TfwHâpReq
 *
ªq
, 
TfwSîvî
 *
§v
, 
li°_hód
 *
eq
)

1394 
TfwSrvC⁄n
 *
sch_c⁄n
;

1401 i‡(
ªq
->
Êags
 & 
TFW_HTTP_F_HMONITOR
) {

1402 
sch_c⁄n
 = 
§v
->
sg
->
sched
->
	`sched_§v_c⁄n
((
TfwMsg
 *)
ªq
,

1403 
§v
);

1404 i‡(!
sch_c⁄n
) {

1405 
	`li°_dñ_öô
(&
ªq
->
fwd_li°
);

1406 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

1407 
	`TFW_WARN_ADDR
("UnableÅo find connectionÅo"

1409 "Ñeque° o¿£rvî", &
§v
->
addr
);

1412 } i‡(!(
sch_c⁄n
 = 
	`tfw_hâp_gë_§v_c⁄n
((
TfwMsg
 *)
ªq
))) {

1413 
	`TFW_DBG
("UnableÅo findá backend server\n");

1414 
	`tfw_hâp_£nd_ª•
(
ªq
, 502, "request dropped: unableÅo"

1416 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

1419 
	`tfw_hâp_hm_§v_upd©e
((
TfwSîvî
 *)
sch_c⁄n
->
≥î
,

1420 
ªq
);

1422 
	`tfw_hâp_ªq_fwd
(
sch_c⁄n
, 
ªq
, 
eq
);

1423 
	`tfw_§v_c⁄n_put
(
sch_c⁄n
);

1424 
	}
}

1438 
	$tfw_hâp_c⁄n_shrök_fwdq
(
TfwSrvC⁄n
 *
§v_c⁄n
)

1440 
	`LIST_HEAD
(
eq
);

1441 
TfwHâpReq
 *
ªq
, *
tmp
;

1442 
TfwSîvî
 *
§v
 = (TfwSîvî *)
§v_c⁄n
->
≥î
;

1443 
li°_hód
 *
íd
, *
fwdq
 = &
§v_c⁄n
->
fwd_queue
;

1445 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
§v_c⁄n
);

1447 
	`•ö_lock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1448 i‡(
	`li°_em±y
(
fwdq
)) {

1449 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1458 i‡(
§v_c⁄n
->
msg_£¡
) {

1459 
TfwMsg
 *
msg_£¡_¥ev
;

1462 
ªq
 = 
	`li°_fú°_íåy
(
fwdq
, 
TfwHâpReq
, 
fwd_li°
);

1463 
íd
 = &((
TfwHâpReq
 *)
§v_c⁄n
->
msg_£¡
)->
fwd_li°
;

1464 
tmp
 = 
	`li°_√xt_íåy
(
ªq
, 
fwd_li°
);

1465 &
ªq
->
fwd_li°
 !
íd
;

1466 
ªq
 = 
tmp
,Åm∞
	`li°_√xt_íåy
—mp, 
fwd_li°
))

1468 
	`tfw_hâp_ªq_evi˘_°Æe_ªq
(
§v_c⁄n
, 
§v
, 
ªq
, &
eq
);

1475 
msg_£¡_¥ev
 = 
	`__tfw_hâp_c⁄n_msg_£¡_¥ev
(
§v_c⁄n
);

1476 i‡(
	`tfw_hâp_ªq_evi˘_°Æe_ªq
(
§v_c⁄n
, 
§v
, 
ªq
, &
eq
))

1477 
§v_c⁄n
->
msg_£¡
 = 
msg_£¡_¥ev
;

1484 
ªq
 = 
§v_c⁄n
->
msg_£¡


1485 ? 
	`li°_√xt_íåy
((
TfwHâpReq
 *)
§v_c⁄n
->
msg_£¡
, 
fwd_li°
)

1486 : 
	`li°_fú°_íåy
(
fwdq
, 
TfwHâpReq
, 
fwd_li°
);

1488 
	`li°_f‹_óch_íåy_ß„_‰om
(
ªq
, 
tmp
, 
fwdq
, 
fwd_li°
)

1489 
	`tfw_hâp_ªq_evi˘_°Æe_ªq
(
§v_c⁄n
, 
§v
, 
ªq
, &
eq
);

1491 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1493 
	`tfw_hâp_ªq_z≠_îr‹
(&
eq
);

1494 
	}
}

1502 
	$tfw_hâp_c⁄n_shrök_fwdq_ªsched
(
TfwSrvC⁄n
 *
§v_c⁄n
)

1504 
	`LIST_HEAD
(
eq
);

1505 
	`LIST_HEAD
(
schq
);

1506 
TfwHâpReq
 *
ªq
, *
tmp
;

1507 
TfwSîvî
 *
§v
 = (TfwSîvî *)
§v_c⁄n
->
≥î
;

1509 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
§v_c⁄n
);

1511 
	`•ö_lock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1513 i‡(
	`li°_em±y
(&
§v_c⁄n
->
fwd_queue
)) {

1514 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1517 
	`li°_•li˚_èû_öô
(&
§v_c⁄n
->
fwd_queue
, &
schq
);

1518 
§v_c⁄n
->
qsize
 = 0;

1519 
§v_c⁄n
->
msg_£¡
 = 
NULL
;

1520 
	`INIT_LIST_HEAD
(&
§v_c⁄n
->
nù_queue
);

1521 
	`˛ór_bô
(
TFW_CONN_B_HASNIP
, &
§v_c⁄n
->
Êags
);

1523 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1532 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, &
schq
, 
fwd_li°
) {

1533 
	`INIT_LIST_HEAD
(&
ªq
->
nù_li°
);

1534 
	`INIT_LIST_HEAD
(&
ªq
->
fwd_li°
);

1535 i‡(
	`tfw_hâp_ªq_evi˘
(
NULL
, 
§v
, 
ªq
, &
eq
))

1537 i‡(
	`u∆ikñy
(
	`tfw_hâp_ªq_is_nù
(
ªq
)

1538 && !(
§v
->
sg
->
Êags
 & 
TFW_SRV_RETRY_NIP
)))

1540 
	`tfw_hâp_nù_ªq_ªsched_îr
(
NULL
, 
ªq
, &
eq
);

1543 
	`tfw_hâp_ªq_ªsched
(
ªq
, 
§v
, &
eq
);

1546 
	`tfw_hâp_ªq_z≠_îr‹
(&
eq
);

1547 
	}
}

1569 
	$tfw_hâp_c⁄n_ª∑ú
(
TfwC⁄n
 *
c⁄n
)

1571 
TfwSrvC⁄n
 *
§v_c⁄n
 = (TfwSrvC⁄¿*)
c⁄n
;

1572 
	`LIST_HEAD
(
eq
);

1574 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
§v_c⁄n
);

1575 
	`BUG_ON
(!(
	`TFW_CONN_TYPE
(
§v_c⁄n
Ë& 
C⁄n_Srv
));

1578 i‡(
	`u∆ikñy
(!
	`tfw_§v_c⁄n_live
(
§v_c⁄n
))) {

1579 i‡(
	`tfw_§v_c⁄n_√ed_ªsched
(
§v_c⁄n
))

1580 
	`tfw_hâp_c⁄n_shrök_fwdq_ªsched
(
§v_c⁄n
);

1582 
	`tfw_hâp_c⁄n_shrök_fwdq
(
§v_c⁄n
);

1586 
	`•ö_lock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1587 i‡(
	`li°_em±y
(&
§v_c⁄n
->
fwd_queue
)) {

1588 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1593 
	`tfw_hâp_c⁄n_åóäù
(
§v_c⁄n
, &
eq
);

1595 i‡(
§v_c⁄n
->
msg_£¡
)

1596 i‡(
	`u∆ikñy
(!
	`tfw_hâp_c⁄n_ª£nd
(
§v_c⁄n
, 
åue
, &
eq
)))

1597 
§v_c⁄n
->
msg_£¡
 = 
NULL
;

1599 i‡(!
§v_c⁄n
->
msg_£¡
) {

1600 i‡(!
	`li°_em±y
(&
§v_c⁄n
->
fwd_queue
)) {

1601 
	`£t_bô
(
TFW_CONN_B_QFORWD
, &
§v_c⁄n
->
Êags
);

1602 
	`tfw_hâp_c⁄n_fwd_un£¡
(
§v_c⁄n
, &
eq
);

1604 
	`tfw_§v_c⁄n_ªíabÀ_if_d⁄e
(
§v_c⁄n
);

1607 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1609 
	`tfw_hâp_ªq_z≠_îr‹
(&
eq
);

1610 
	}
}

1616 
	$tfw_hâp_ªq_de°ru˘
(*
msg
)

1618 
TfwHâpReq
 *
ªq
 = 
msg
;

1620 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
msg
.
£q_li°
));

1621 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
fwd_li°
));

1622 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
nù_li°
));

1624 
	`tfw_vho°_put
(
ªq
->
vho°
);

1625 i‡(
ªq
->
£ss
)

1626 
	`tfw_hâp_£ss_put
(
ªq
->
£ss
);

1627 
	}
}

1644 
	$tfw_hâp_ª•_∑ú
(
TfwHâpMsg
 *
hmª•
)

1646 
TfwHâpReq
 *
ªq
;

1647 
TfwSrvC⁄n
 *
§v_c⁄n
 = (TfwSrvC⁄¿*)
hmª•
->
c⁄n
;

1649 
	`•ö_lock
(&
§v_c⁄n
->
fwd_qlock
);

1650 
	`li°_f‹_óch_íåy
(
ªq
, &
§v_c⁄n
->
fwd_queue
, 
fwd_li°
) {

1651 i‡(!
ªq
->
∑ú
) {

1652 
	`tfw_hâp_msg_∑ú
((
TfwHâpRe•
 *)
hmª•
, 
ªq
);

1653 
	`•ö_u∆ock
(&
§v_c⁄n
->
fwd_qlock
);

1657 i‡(
ªq
 =(
TfwHâpReq
 *)
§v_c⁄n
->
msg_£¡
)

1660 
	`•ö_u∆ock
(&
§v_c⁄n
->
fwd_qlock
);

1662 
	`TFW_WARN
("PairedÑequest missing, HTTP Response Splittingáttack?\n");

1663 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_Ÿhîr
);

1665  -
EINVAL
;

1666 
	}
}

1673 
TfwMsg
 *

1674 
	$tfw_hâp_c⁄n_msg_Æloc
(
TfwC⁄n
 *
c⁄n
)

1676 
TfwHâpMsg
 *
hm
 = 
	`__tfw_hâp_msg_Æloc
(
	`TFW_CONN_TYPE
(
c⁄n
), 
åue
);

1677 i‡(
	`u∆ikñy
(!
hm
))

1678  
NULL
;

1680 
hm
->
c⁄n
 = conn;

1681 
	`tfw_c⁄√˘i⁄_gë
(
c⁄n
);

1683 i‡(
	`TFW_CONN_TYPE
(
c⁄n
Ë& 
C⁄n_C t
) {

1684 
	`TFW_INC_STAT_BH
(
˛¡
.
rx_mesßges
);

1686 i‡(
	`u∆ikñy
(
	`tfw_hâp_ª•_∑ú
(
hm
))) {

1687 
	`tfw_hâp_c⁄n_msg_‰ì
(
hm
);

1688  
NULL
;

1690 
	`TFW_INC_STAT_BH
(
£rv
.
rx_mesßges
);

1693  (
TfwMsg
 *)
hm
;

1694 
	}
}

1703 
	$tfw_hâp_c⁄n_öô
(
TfwC⁄n
 *
c⁄n
)

1705 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
c⁄n
);

1707 i‡(
	`TFW_CONN_TYPE
(
c⁄n
Ë& 
C⁄n_Srv
) {

1708 
TfwSrvC⁄n
 *
§v_c⁄n
 = (TfwSrvC⁄¿*)
c⁄n
;

1709 i‡(!
	`li°_em±y
(&
§v_c⁄n
->
fwd_queue
)) {

1710 
	`£t_bô
(
TFW_CONN_B_RESEND
, &
§v_c⁄n
->
Êags
);

1711 
	`TFW_INC_STAT_BH
(
£rv
.
c⁄n_ª°ri˘ed
);

1714 
	`tfw_gfsm_°©e_öô
(&
c⁄n
->
°©e
, c⁄n, 
TFW_HTTP_FSM_INIT
);

1716 
	}
}

1719 
	$tfw_hâp_c⁄n_˛o£
(
TfwC⁄n
 *
c⁄n
, 
boﬁ
 
sync
)

1721  
	`ss_˛o£
(
c⁄n
->
sk
, 
sync
 ? 
SS_F_SYNC
 : 0);

1722 
	}
}

1743 
	$tfw_hâp_c⁄n_ªÀa£
(
TfwC⁄n
 *
c⁄n
)

1745 
TfwSrvC⁄n
 *
§v_c⁄n
 = (TfwSrvC⁄¿*)
c⁄n
;

1746 
TfwHâpReq
 *
ªq
, *
tmp
;

1747 
	`LIST_HEAD
(
z≠_queue
);

1749 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
§v_c⁄n
);

1750 
	`BUG_ON
(!(
	`TFW_CONN_TYPE
(
§v_c⁄n
Ë& 
C⁄n_Srv
));

1752 i‡(
	`likñy
(
	`ss_a˘ive
())) {

1757 i‡(
	`u∆ikñy
(
	`ã°_bô
(
TFW_CONN_B_DEL
, &
§v_c⁄n
->
Êags
)))

1758 
	`tfw_hâp_c⁄n_shrök_fwdq_ªsched
(
§v_c⁄n
);

1759 
	`__tfw_§v_c⁄n_˛ór_ª°ri˘ed
(
§v_c⁄n
);

1768 
	`•ö_lock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1769 
	`tfw_hâp_c⁄n_¢ù_fwd_queue
(
§v_c⁄n
, &
z≠_queue
);

1770 
	`•ö_u∆ock_bh
(&
§v_c⁄n
->
fwd_qlock
);

1776 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, &
z≠_queue
, 
fwd_li°
) {

1777 
	`li°_dñ_öô
(&
ªq
->
fwd_li°
);

1778 i‡(
	`u∆ikñy
(!
	`li°_em±y_ˇªful
(&
ªq
->
msg
.
£q_li°
))) {

1779 
	`•ö_lock_bh
(&((
TfwCliC⁄n
 *)
ªq
->
c⁄n
)->
£q_qlock
);

1780 i‡(
	`u∆ikñy
(!
	`li°_em±y
(&
ªq
->
msg
.
£q_li°
)))

1781 
	`li°_dñ_öô
(&
ªq
->
msg
.
£q_li°
);

1782 
	`•ö_u∆ock_bh
(&((
TfwCliC⁄n
 *)
ªq
->
c⁄n
)->
£q_qlock
);

1784 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

1786 
	}
}

1791 
ölöe
 

1792 
	$tfw_hâp_ª•_∑ú_‰ì
(
TfwHâpReq
 *
ªq
)

1794 
	`tfw_hâp_c⁄n_msg_‰ì
(
ªq
->
∑ú
);

1795 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

1796 
	}
}

1814 
	$tfw_hâp_c⁄n_˛i_dr›
(
TfwCliC⁄n
 *
˛i_c⁄n
)

1816 
TfwHâpReq
 *
ªq
, *
tmp
;

1817 
li°_hód
 *
£q_queue
 = &
˛i_c⁄n
->seq_queue;

1819 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
˛i_c⁄n
);

1820 
	`BUG_ON
(!(
	`TFW_CONN_TYPE
(
˛i_c⁄n
Ë& 
C⁄n_C t
));

1822 i‡(
	`li°_em±y_ˇªful
(
£q_queue
))

1831 
	`•ö_lock
(&
˛i_c⁄n
->
£q_qlock
);

1832 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, 
£q_queue
, 
msg
.
£q_li°
) {

1833 
ªq
->
Êags
 |
TFW_HTTP_F_REQ_DROP
;

1834 
	`li°_dñ_öô
(&
ªq
->
msg
.
£q_li°
);

1839 i‡(
ªq
->
ª•
 && (ªq->ª•->
Êags
 & 
TFW_HTTP_F_RESP_READY
)) {

1840 
	`tfw_hâp_ª•_∑ú_‰ì
(
ªq
);

1841 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_Ÿhîr
);

1844 
	`•ö_u∆ock
(&
˛i_c⁄n
->
£q_qlock
);

1845 
	}
}

1853 
tfw_hâp_ª•_ãrmö©e
(
TfwHâpMsg
 *
hm
);

1856 
	$tfw_hâp_c⁄n_dr›
(
TfwC⁄n
 *
c⁄n
)

1858 
	`TFW_DBG2
("%s: c⁄n=[%p]\n", 
__func__
, 
c⁄n
);

1860 i‡(
	`TFW_CONN_TYPE
(
c⁄n
Ë& 
C⁄n_C t
) {

1861 
	`tfw_hâp_c⁄n_˛i_dr›
((
TfwCliC⁄n
 *)
c⁄n
);

1863 i‡(
c⁄n
->
msg
) {

1864 i‡(
	`tfw_hâp_∑r£_ãrmö©e
((
TfwHâpMsg
 *)
c⁄n
->
msg
))

1865 
	`tfw_hâp_ª•_ãrmö©e
((
TfwHâpMsg
 *)
c⁄n
->
msg
);

1867 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
c⁄n
->
msg
);

1868 
	}
}

1876 
	$tfw_hâp_c⁄n_£nd
(
TfwC⁄n
 *
c⁄n
, 
TfwMsg
 *
msg
)

1878  
	`ss_£nd
(
c⁄n
->
sk
, &
msg
->
skb_hód
, msg->
ss_Êags
);

1879 
	}
}

1885 
TfwHâpMsg
 *

1886 
	$tfw_hâp_msg_¸óã_siblög
(
TfwHâpMsg
 *
hm
, 
sk_buff
 **
skb
,

1887 
•lô_off£t
)

1889 
TfwHâpMsg
 *
shm
;

1890 
sk_buff
 *
nskb
;

1892 
	`TFW_DBG2
("Cª©êsiblög mesßge: c⁄¿%p, skb %p\n", 
hm
->
c⁄n
, 
skb
);

1895 
shm
 = (
TfwHâpMsg
 *)
	`tfw_hâp_c⁄n_msg_Æloc
(
hm
->
c⁄n
);

1896 i‡(
	`u∆ikñy
(!
shm
)) {

1904 i‡(
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_Srv
)

1905 *
skb
 = 
	`ss_skb_•lô
(*skb, 
•lô_off£t
);

1906  
NULL
;

1915 
nskb
 = 
	`ss_skb_•lô
(*
skb
, 
•lô_off£t
);

1916 i‡(!
nskb
) {

1917 
	`tfw_hâp_c⁄n_msg_‰ì
(
shm
);

1918  
NULL
;

1926 i‡(
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_C t
) {

1927 
shm
->
Êags
 |
hm
->Êag†& 
TFW_HTTP_F_WHITELIST
;

1928 
nskb
->
m¨k
 = (*
skb
)->mark;

1931 
	`ss_skb_queue_èû
(&
shm
->
msg
.
skb_hód
, 
nskb
);

1932 *
skb
 = 
nskb
;

1934  
shm
;

1935 
	}
}

1941 
	$tfw_hâp_£t_hdr_d©e
(
TfwHâpMsg
 *
hm
)

1943 
r
;

1944 *
s_d©e
 = *
	`this_˝u_±r
(&
g_buf
);

1946 
	`tfw_hâp_¥ï_d©e_‰om
(
s_d©e
, ((
TfwHâpRe•
 *)
hm
)->
d©e
);

1947 
r
 = 
	`tfw_hâp_msg_hdr_x‰m
(
hm
, "Date", ("Date") - 1,

1948 
s_d©e
, 
	`SLEN
(
S_V_DATE
),

1949 
TFW_HTTP_HDR_RAW
, 0);

1950 i‡(
r
)

1951 
	`TFW_ERR
("U«bÀÅÿadd D©e: hódîÅÿmsg [%p]\n", 
hm
);

1953 
	`TFW_DBG2
("Added D©e: hódîÅÿmsg [%p]\n", 
hm
);

1954  
r
;

1955 
	}
}

1965 
	$tfw_hâp_£t_hdr_c⁄√˘i⁄
(
TfwHâpMsg
 *
hm
, 
c⁄n_Êg
)

1967 i‡(((
hm
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
Ë=
c⁄n_Êg
)

1968 && (!
	`TFW_STR_EMPTY
(&
hm
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_CONNECTION
]))

1969 && !(
hm
->
Êags
 & 
TFW_HTTP_F_CONN_EXTRA
))

1972 
c⁄n_Êg
) {

1973 
TFW_HTTP_F_CONN_CLOSE
:

1974  
	`TFW_HTTP_MSG_HDR_XFRM
(
hm
, "Connection", "close",

1975 
TFW_HTTP_HDR_CONNECTION
, 0);

1976 
TFW_HTTP_F_CONN_KA
:

1977  
	`TFW_HTTP_MSG_HDR_XFRM
(
hm
, "Connection", "keep-alive",

1978 
TFW_HTTP_HDR_CONNECTION
, 0);

1980  
	`TFW_HTTP_MSG_HDR_DEL
(
hm
, "Connection",

1981 
TFW_HTTP_HDR_CONNECTION
);

1983 
	}
}

1989 
	$tfw_hâp_£t_hdr_kìp_Æive
(
TfwHâpMsg
 *
hm
, 
c⁄n_Êg
)

1991 
r
;

1993 i‡((
hm
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
Ë=
c⁄n_Êg
)

1996 
c⁄n_Êg
) {

1997 
TFW_HTTP_F_CONN_CLOSE
:

1998 
r
 = 
	`TFW_HTTP_MSG_HDR_DEL
(
hm
, "Kìp-Alive", 
TFW_HTTP_HDR_KEEP_ALIVE
);

1999 i‡(
	`u∆ikñy
(
r
 &&Ñ !-
ENOENT
)) {

2000 
	`TFW_WARN
("C™nŸ dñëêKìp-Alivêhódî (%d)\n", 
r
);

2001  
r
;

2004 
TFW_HTTP_F_CONN_KA
:

2026 
	}
}

2029 
	$tfw_hâp_add_hdr_vü
(
TfwHâpMsg
 *
hm
)

2031 
r
;

2032 c⁄° * c⁄° 
s_hâp_vîsi⁄
[] = {

2033 [0 ... 
_TFW_HTTP_VER_COUNT
] = 
NULL
,

2034 [
TFW_HTTP_VER_09
] = "0.9 ",

2035 [
TFW_HTTP_VER_10
] = "1.0 ",

2036 [
TFW_HTTP_VER_11
] = "1.1 ",

2037 [
TFW_HTTP_VER_20
] = "2.0 ",

2039 
TfwGlobÆ
 *
g_vho°
 = 
	`tfw_vho°_gë_globÆ
();

2040 c⁄° 
TfwSå
 
rh
 = {

2041 
	#S_VIA
 "Vü: "

	)

2042 .
±r
 = (
TfwSå
 []) {

2043 { .
±r
 = 
S_VIA
, .
Àn
 = 
	`SLEN
(S_VIA) },

2044 { .
±r
 = (*)
s_hâp_vîsi⁄
[
hm
->
vîsi⁄
],

2045 .
Àn
 = 4 },

2046 { .
±r
 = *
	`this_˝u_±r
(&
g_buf
),

2047 .
Àn
 = 
g_vho°
->
hdr_vü_Àn
 },

2049 .
Àn
 = 
	`SLEN
(
S_VIA
Ë+ 4 + 
g_vho°
->
hdr_vü_Àn
,

2050 .
eﬁí
 = 2,

2051 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


2052 #unde‡
S_VIA


2055 
	`mem˝y_Á°
(
	`__TFW_STR_CH
(&
rh
, 2)->
±r
, 
g_vho°
->
hdr_vü
,

2056 
g_vho°
->
hdr_vü_Àn
);

2058 
r
 = 
	`tfw_hâp_msg_hdr_add
(
hm
, &
rh
);

2059 i‡(
r
)

2060 
	`TFW_ERR
("U«bÀÅÿadd Vü: hódîÅÿmsg [%p]\n", 
hm
);

2062 
	`TFW_DBG2
("Added Vü: hódîÅÿmsg [%p]\n", 
hm
);

2063  
r
;

2064 
	}
}

2067 
	$tfw_hâp_add_x_f‹w¨ded_f‹
(
TfwHâpMsg
 *
hm
)

2069 
r
;

2070 *
p
, *
buf
 = *
	`this_˝u_±r
(&
g_buf
);

2072 
p
 = 
	`ss_skb_fmt_§c_addr
(
hm
->
msg
.
skb_hód
, 
buf
);

2074 
r
 = 
	`tfw_hâp_msg_hdr_x‰m
(
hm
, "X-Forwarded-For",

2075 ("X-F‹w¨ded-F‹"Ë- 1, 
buf
, 
p
 - buf,

2076 
TFW_HTTP_HDR_X_FORWARDED_FOR
, 
åue
);

2077 i‡(
r
)

2078 
	`TFW_ERR
("can'tádd X-Forwarded-For header for %.*sÅo msg %p",

2079 ()(
p
 - 
buf
), buf, 
hm
);

2081 
	`TFW_DBG2
("added X-Forwarded-For header for %*s\n",

2082 ()(
p
 - 
buf
), buf);

2083  
r
;

2084 
	}
}

2087 
	$tfw_hâp_£t_loc_hdrs
(
TfwHâpMsg
 *
hm
, 
TfwHâpReq
 *
ªq
)

2089 
r
;

2090 
size_t
 
i
;

2091 
mod_ty≥
 = (
hm
 =(
TfwHâpMsg
 *)
ªq
Ë? 
TFW_VHOST_HDRMOD_REQ


2092 : 
TFW_VHOST_HDRMOD_RESP
;

2093 
TfwHdrMods
 *
h_mods
 = 
	`tfw_vho°_gë_hdr_mods
(
ªq
->
loˇti⁄
,Ñeq->
vho°
,

2094 
mod_ty≥
);

2095 i‡(!
h_mods
)

2098 
i
 = 0; i < 
h_mods
->
sz
; ++i) {

2099 
TfwHdrModsDesc
 *
d
 = &
h_mods
->
hdrs
[
i
];

2100 
r
 = 
	`tfw_hâp_msg_hdr_x‰m_°r
(
hm
, 
d
->
hdr
, d->
hid
, d->
≠≥nd
);

2101 i‡(
r
) {

2102 
	`TFW_ERR
("can't updateÜocation-specific header in msg %p\n",

2103 
hm
);

2104  
r
;

2106 
	`TFW_DBG2
("upd©edÜoˇti⁄-•ecifi¯hódî i¿msg %p\n", 
hm
);

2110 
	}
}

2116 
	$tfw_hâp_adju°_ªq
(
TfwHâpReq
 *
ªq
)

2118 
r
;

2119 
TfwHâpMsg
 *
hm
 = (TfwHâpMsg *)
ªq
;

2121 
r
 = 
	`tfw_hâp_add_x_f‹w¨ded_f‹
(
hm
);

2122 i‡(
r
)

2123  
r
;

2125 
r
 = 
	`tfw_hâp_add_hdr_vü
(
hm
);

2126 i‡(
r
)

2127  
r
;

2129 
r
 = 
	`tfw_hâp_msg_dñ_hbh_hdrs
(
hm
);

2130 i‡(
r
 < 0)

2131  
r
;

2133 
r
 = 
	`tfw_hâp_£t_loc_hdrs
(
hm
, 
ªq
);

2134 i‡(
r
 < 0)

2135  
r
;

2137  
	`tfw_hâp_£t_hdr_c⁄√˘i⁄
(
hm
, 
TFW_HTTP_F_CONN_KA
);

2138 
	}
}

2144 
	$tfw_hâp_adju°_ª•
(
TfwHâpRe•
 *
ª•
)

2146 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

2147 
TfwHâpMsg
 *
hm
 = (TfwHâpMsg *)
ª•
;

2148 
r
, 
c⁄n_Êg
;

2156 i‡((
ª•
->
Êags
 & 
TFW_HTTP_F_CONN_CLOSE
Ë&& (ª•->
°©us
 / 100 == 4)) {

2157 
ªq
->
Êags
 = (ªq->Êag†& ~
TFW_HTTP_F_CONN_KA
)

2158 | 
TFW_HTTP_F_CONN_CLOSE
;

2159 
c⁄n_Êg
 = 
TFW_HTTP_F_CONN_CLOSE
;

2162 
c⁄n_Êg
 = 
ªq
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
;

2165 
r
 = 
	`tfw_hâp_£ss_ª•_¥o˚ss
(
ª•
);

2166 i‡(
r
 < 0)

2167  
r
;

2169 
r
 = 
	`tfw_hâp_msg_dñ_hbh_hdrs
(
hm
);

2170 i‡(
r
 < 0)

2171  
r
;

2173 
r
 = 
	`tfw_hâp_£t_hdr_kìp_Æive
(
hm
, 
c⁄n_Êg
);

2174 i‡(
r
 < 0)

2175  
r
;

2177 
r
 = 
	`tfw_hâp_£t_hdr_c⁄√˘i⁄
(
hm
, 
c⁄n_Êg
);

2178 i‡(
r
 < 0)

2179  
r
;

2181 
r
 = 
	`tfw_hâp_add_hdr_vü
(
hm
);

2182 i‡(
r
 < 0)

2183  
r
;

2185 
r
 = 
	`tfw_hâp_£t_loc_hdrs
(
hm
, 
ªq
);

2186 i‡(
r
 < 0)

2187  
r
;

2189 i‡(
ª•
->
Êags
 & 
TFW_HTTP_F_RESP_STALE
) {

2190 
	#S_WARN_110
 "W¨nög: 110 - Re•⁄£ i†°Æe"

	)

2192 
TfwSå
 
wh
 = {

2193 .
±r
 = 
S_WARN_110
,

2194 .
Àn
 = 
	`SLEN
(
S_WARN_110
),

2195 .
eﬁí
 = 2

2197 
r
 = 
	`tfw_hâp_msg_hdr_add
(
hm
, &
wh
);

2198 i‡(
r
)

2199  
r
;

2200 #unde‡
S_WARN_110


2203 i‡(!(
ª•
->
Êags
 & 
TFW_HTTP_F_HDR_DATE
)) {

2204 
r
 = 
	`tfw_hâp_£t_hdr_d©e
(
hm
);

2205 i‡(
r
 < 0)

2206  
r
;

2209  
	`TFW_HTTP_MSG_HDR_XFRM
(
hm
, "Sîvî", 
TFW_NAME
 "/" 
TFW_VERSION
,

2210 
TFW_HTTP_HDR_SERVER
, 0);

2211 
	}
}

2221 
	$__tfw_hâp_ª•_fwd
(
TfwCliC⁄n
 *
˛i_c⁄n
, 
li°_hód
 *
ªt_queue
)

2223 
TfwHâpReq
 *
ªq
, *
tmp
;

2225 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, 
ªt_queue
, 
msg
.
£q_li°
) {

2226 
	`BUG_ON
(!
ªq
->
ª•
);

2227 
	`tfw_hâp_ª•_öô_ss_Êags
(
ªq
->
ª•
,Ñeq);

2228 i‡(
	`tfw_˛i_c⁄n_£nd
(
˛i_c⁄n
, (
TfwMsg
 *)
ªq
->
ª•
)) {

2229 
	`tfw_c⁄√˘i⁄_˛o£
((
TfwC⁄n
 *)
˛i_c⁄n
, 
åue
);

2232 
	`li°_dñ_öô
(&
ªq
->
msg
.
£q_li°
);

2233 
	`tfw_hâp_ª•_∑ú_‰ì
(
ªq
);

2234 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_f‹w¨ded
);

2236 
	}
}

2245 
	$tfw_hâp_ª•_fwd
(
TfwHâpRe•
 *
ª•
)

2247 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

2248 
TfwCliC⁄n
 *
˛i_c⁄n
 = (TfwCliC⁄¿*)
ªq
->
c⁄n
;

2249 
li°_hód
 *
£q_queue
 = &
˛i_c⁄n
->seq_queue;

2250 
li°_hód
 *
ªq_ªã¡
 = 
NULL
;

2251 
	`LIST_HEAD
(
ªt_queue
);

2253 
	`TFW_DBG2
("%s:Ñeq=[%p],Ñe•=[%p]\n", 
__func__
, 
ªq
, 
ª•
);

2254 
	`WARN_ON_ONCE
(
ªq
->
ª•
 !=Ñesp);

2266 
	`•ö_lock_bh
(&
˛i_c⁄n
->
£q_qlock
);

2267 i‡(
	`u∆ikñy
(
	`li°_em±y
(
£q_queue
))) {

2268 
	`BUG_ON
(!
	`li°_em±y
(&
ªq
->
msg
.
£q_li°
));

2269 
	`•ö_u∆ock_bh
(&
˛i_c⁄n
->
£q_qlock
);

2270 
	`TFW_DBG2
("%s: The client was disconnected, dropÑespándÑeq: "

2272 
__func__
, 
˛i_c⁄n
);

2273 
	`tfw_c⁄√˘i⁄_˛o£
(
ªq
->
c⁄n
, 
åue
);

2274 
	`tfw_hâp_ª•_∑ú_‰ì
(
ªq
);

2275 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_Ÿhîr
);

2278 
	`BUG_ON
(
	`li°_em±y
(&
ªq
->
msg
.
£q_li°
));

2279 
ª•
->
Êags
 |
TFW_HTTP_F_RESP_READY
;

2281 
	`li°_f‹_óch_íåy
(
ªq
, 
£q_queue
, 
msg
.
£q_li°
) {

2282 i‡(!
ªq
->
ª•
 || !‘eq->ª•->
Êags
 & 
TFW_HTTP_F_RESP_READY
))

2284 
ªq_ªã¡
 = &
ªq
->
msg
.
£q_li°
;

2286 i‡(!
ªq_ªã¡
) {

2287 
	`•ö_u∆ock_bh
(&
˛i_c⁄n
->
£q_qlock
);

2290 
	`__li°_cut_posôi⁄
(&
ªt_queue
, 
£q_queue
, 
ªq_ªã¡
);

2319 
	`tfw_˛i_c⁄n_gë
(
˛i_c⁄n
);

2320 
	`•ö_lock_bh
(&
˛i_c⁄n
->
ªt_qlock
);

2321 
	`•ö_u∆ock_bh
(&
˛i_c⁄n
->
£q_qlock
);

2323 
	`__tfw_hâp_ª•_fwd
(
˛i_c⁄n
, &
ªt_queue
);

2325 
	`•ö_u∆ock_bh
(&
˛i_c⁄n
->
ªt_qlock
);

2326 
	`tfw_˛i_c⁄n_put
(
˛i_c⁄n
);

2329 i‡(!
	`li°_em±y
(&
ªt_queue
)) {

2330 
TfwHâpReq
 *
tmp
;

2331 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
tmp
, &
ªt_queue
, 
msg
.
£q_li°
) {

2332 
	`TFW_DBG2
("%s: ForwardingÉrror: conn=[%p]Ñesp=[%p]\n",

2333 
__func__
, 
˛i_c⁄n
, 
ªq
->
ª•
);

2334 
	`BUG_ON
(!
ªq
->
ª•
);

2335 
	`tfw_hâp_ª•_∑ú_‰ì
(
ªq
);

2336 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_Ÿhîr
);

2339 
	}
}

2341 
ölöe
 

2342 
	$tfw_hâp_ªq_m¨k_îr‹
(
TfwHâpReq
 *
ªq
, 
°©us
)

2344 
	`TFW_CONN_TYPE
(
ªq
->
c⁄n
Ë|
C⁄n_St›
;

2345 
ªq
->
Êags
 |
TFW_HTTP_F_SUSPECTED
;

2346 
	`tfw_hâp_îr‹_ª•_swôch
(
ªq
, 
°©us
);

2347 
	}
}

2356 
	$tfw_hâp_˛i_îr‹_ª•_™d_log
(
boﬁ
 
ª∂y
, boﬁ 
nﬁog
, 
TfwHâpReq
 *
ªq
,

2357 
°©us
, c⁄° *
msg
)

2359 i‡(!
nﬁog
)

2360 
	`TFW_WARN_ADDR
(
msg
, &
ªq
->
c⁄n
->
≥î
->
addr
);

2362 i‡(
ª∂y
) {

2363 
TfwCliC⁄n
 *
˛i_c⁄n
 = (TfwCliC⁄¿*)
ªq
->
c⁄n
;

2364 
	`tfw_c⁄√˘i⁄_u∆ök_msg
(
ªq
->
c⁄n
);

2365 
	`•ö_lock
(&
˛i_c⁄n
->
£q_qlock
);

2366 
	`li°_add_èû
(&
ªq
->
msg
.
£q_li°
, &
˛i_c⁄n
->
£q_queue
);

2367 
	`•ö_u∆ock
(&
˛i_c⁄n
->
£q_qlock
);

2368 
	`tfw_hâp_ªq_m¨k_îr‹
(
ªq
, 
°©us
);

2371 
	`tfw_hâp_c⁄n_ªq_˛ón
(
ªq
);

2373 
	}
}

2376 
	$tfw_hâp_§v_îr‹_ª•_™d_log
(
boﬁ
 
ª∂y
, boﬁ 
nﬁog
, 
TfwHâpReq
 *
ªq
,

2377 
°©us
, c⁄° *
msg
)

2379 i‡(!
nﬁog
)

2380 
	`TFW_WARN_ADDR
(
msg
, &
ªq
->
c⁄n
->
≥î
->
addr
);

2382 i‡(
ª∂y
)

2383 
	`tfw_hâp_ªq_m¨k_îr‹
(
ªq
, 
°©us
);

2385 
	`tfw_hâp_c⁄n_ªq_˛ón
(
ªq
);

2386 
	}
}

2399 
ölöe
 

2400 
	$tfw_˛õ¡_dr›
(
TfwHâpReq
 *
ªq
, 
°©us
, c⁄° *
msg
)

2402 
	`tfw_hâp_˛i_îr‹_ª•_™d_log
(
tfw_blk_Êags
 & 
TFW_BLK_ERR_REPLY
,

2403 
tfw_blk_Êags
 & 
TFW_BLK_ERR_NOLOG
,

2404 
ªq
, 
°©us
, 
msg
);

2405 
	}
}

2407 
ölöe
 

2408 
	$tfw_˛õ¡_block
(
TfwHâpReq
 *
ªq
, 
°©us
, c⁄° *
msg
)

2410 
	`tfw_hâp_˛i_îr‹_ª•_™d_log
(
tfw_blk_Êags
 & 
TFW_BLK_ATT_REPLY
,

2411 
tfw_blk_Êags
 & 
TFW_BLK_ATT_NOLOG
,

2412 
ªq
, 
°©us
, 
msg
);

2413 
	}
}

2415 
ölöe
 

2416 
	$tfw_§v_˛õ¡_dr›
(
TfwHâpReq
 *
ªq
, 
°©us
, c⁄° *
msg
)

2418 
	`tfw_hâp_§v_îr‹_ª•_™d_log
(
tfw_blk_Êags
 & 
TFW_BLK_ERR_REPLY
,

2419 
tfw_blk_Êags
 & 
TFW_BLK_ERR_NOLOG
,

2420 
ªq
, 
°©us
, 
msg
);

2421 
	}
}

2423 
ölöe
 

2424 
	$tfw_§v_˛õ¡_block
(
TfwHâpReq
 *
ªq
, 
°©us
, c⁄° *
msg
)

2426 
	`tfw_hâp_§v_îr‹_ª•_™d_log
(
tfw_blk_Êags
 & 
TFW_BLK_ATT_REPLY
,

2427 
tfw_blk_Êags
 & 
TFW_BLK_ATT_NOLOG
,

2428 
ªq
, 
°©us
, 
msg
);

2429 
	}
}

2436 
	$tfw_hâp_ªq_ˇche_£rvi˚
(
TfwHâpRe•
 *
ª•
)

2438 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

2440 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
fwd_li°
));

2441 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
nù_li°
));

2443 i‡(
	`tfw_hâp_adju°_ª•
(
ª•
)) {

2444 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

2445 
	`tfw_hâp_£nd_ª•
(
ªq
, 500, "response dropped:"

2447 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

2450 
	`tfw_hâp_ª•_fwd
(
ª•
);

2451 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_‰omˇche
);

2452 
	}
}

2460 
	$tfw_hâp_ªq_ˇche_cb
(
TfwHâpMsg
 *
msg
)

2462 
r
;

2463 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
msg
;

2464 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
NULL
;

2465 
	`LIST_HEAD
(
eq
);

2467 
	`TFW_DBG2
("%s:Ñeq = %p,Ñe• = %p\n", 
__func__
, 
ªq
,Ñeq->
ª•
);

2478 
r
 = 
	`tfw_hâp_£ss_obèö
(
ªq
);

2479 
r
) {

2480 
TFW_HTTP_SESS_SUCCESS
:

2482 
TFW_HTTP_SESS_REDIRECT_SENT
:

2485 
TFW_HTTP_SESS_VIOLATE
:

2486 
dr›_503
;

2487 
TFW_HTTP_SESS_JS_NOT_SUPPORTED
:

2488 
£nd_503
;

2490 
£nd_500
;

2493 i‡(
ªq
->
ª•
) {

2494 
	`tfw_hâp_ªq_ˇche_£rvi˚
(
ªq
->
ª•
);

2509 i‡(!(
§v_c⁄n
 = 
	`tfw_hâp_gë_§v_c⁄n
((
TfwMsg
 *)
ªq
))) {

2510 
	`TFW_DBG
("UnableÅo findá backend server\n");

2511 
£nd_502
;

2514 i‡(
	`tfw_hâp_adju°_ªq
(
ªq
))

2515 
£nd_500
;

2518 
	`tfw_hâp_hm_§v_upd©e
((
TfwSîvî
 *)
§v_c⁄n
->
≥î
, 
ªq
);

2521 
	`tfw_hâp_ªq_fwd
(
§v_c⁄n
, 
ªq
, &
eq
);

2522 
	`tfw_hâp_ªq_z≠_îr‹
(&
eq
);

2523 
c⁄n_put
;

2525 
£nd_503
:

2530 
	`tfw_hâp_£nd_ª•
(
ªq
, 503, "request dropped:"

2532 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_fûtout
);

2534 
dr›_503
:

2535 
	`tfw_§v_˛õ¡_dr›
(
ªq
, 503, "request dropped: invalid sticky cookie "

2537 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_fûtout
);

2539 
£nd_502
:

2540 
	`tfw_hâp_£nd_ª•
(
ªq
, 502, "request dropped:ÖrocessingÉrror");

2541 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

2543 
£nd_500
:

2544 
	`tfw_hâp_£nd_ª•
(
ªq
, 500, "request dropped:ÖrocessingÉrror");

2545 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

2546 
c⁄n_put
:

2547 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

2548 
	}
}

2551 
	$tfw_hâp_ªq_m¨k_nù
(
TfwHâpReq
 *
ªq
)

2553 
TfwVho°
 *
vh_dÊt
;

2554 
TfwLoˇti⁄
 *
loc
, *
loc_dÊt
;

2556 c⁄° 
ß„_mëhods
 =

2557 (1 << 
TFW_HTTP_METH_GET
Ë| (1 << 
TFW_HTTP_METH_HEAD
)

2558 | (1 << 
TFW_HTTP_METH_OPTIONS
Ë| (1 << 
TFW_HTTP_METH_PROPFIND
)

2559 | (1 << 
TFW_HTTP_METH_TRACE
);

2561 
	`BUILD_BUG_ON
((
ß„_mëhods
Ë* 
BITS_PER_BYTE


2562 < 
_TFW_HTTP_METH_COUNT
);

2564 i‡(!
ªq
->
vho°
)

2575 
loc
 = 
ªq
->
loˇti⁄
;

2576 
loc_dÊt
 = 
ªq
->
vho°
->loc_dflt;

2577 
vh_dÊt
 = 
ªq
->
vho°
->
vho°_dÊt
;

2578 i‡(
loc
 &&Üoc->
nùdef_sz
) {

2579 i‡(
	`tfw_nùdef_m©ch
(
loc
, 
ªq
->
mëhod
, &ªq->
uri_∑th
))

2580 
nù_m©ch
;

2581 } i‡(
loc_dÊt
 &&Üoc_dÊt->
nùdef_sz
) {

2582 i‡(
	`tfw_nùdef_m©ch
(
loc_dÊt
, 
ªq
->
mëhod
, &ªq->
uri_∑th
))

2583 
nù_m©ch
;

2584 } i‡(
vh_dÊt
 && vh_dÊt->
loc_dÊt
->
nùdef_sz
) {

2585 i‡(
	`tfw_nùdef_m©ch
(
vh_dÊt
->
loc_dÊt
, 
ªq
->
mëhod
,

2586 &
ªq
->
uri_∑th
))

2587 
nù_m©ch
;

2590 i‡(
ß„_mëhods
 & (1 << 
ªq
->
mëhod
))

2593 
nù_m©ch
:

2594 
	`TFW_DBG2
("non-idempotent: method=[%d] uri=[%.*s]\n",

2595 
ªq
->
mëhod
, ()
	`TFW_STR_CHUNK
(&ªq->
uri_∑th
, 0)->
Àn
,

2596 (*)
	`TFW_STR_CHUNK
(&
ªq
->
uri_∑th
, 0)->
±r
);

2597 
ªq
->
Êags
 |
TFW_HTTP_F_NON_IDEMP
;

2599 
	}
}

2608 
	$tfw_hâp_ªq_add_£q_queue
(
TfwHâpReq
 *
ªq
)

2610 
TfwHâpReq
 *
ªq_¥ev
;

2611 
TfwCliC⁄n
 *
˛i_c⁄n
 = (TfwCliC⁄¿*)
ªq
->
c⁄n
;

2612 
li°_hód
 *
£q_queue
 = &
˛i_c⁄n
->seq_queue;

2614 
	`tfw_hâp_ªq_m¨k_nù
(
ªq
);

2616 
	`•ö_lock
(&
˛i_c⁄n
->
£q_qlock
);

2617 
ªq_¥ev
 = 
	`li°_em±y
(
£q_queue
) ?

2618 
NULL
 : 
	`li°_œ°_íåy
(
£q_queue
, 
TfwHâpReq
, 
msg
.
£q_li°
);

2619 i‡(
ªq_¥ev
 && 
	`tfw_hâp_ªq_is_nù
(req_prev))

2620 
ªq_¥ev
->
Êags
 &~
TFW_HTTP_F_NON_IDEMP
;

2621 
	`li°_add_èû
(&
ªq
->
msg
.
£q_li°
, 
£q_queue
);

2622 
	`•ö_u∆ock
(&
˛i_c⁄n
->
£q_qlock
);

2623 
	}
}

2625 
ölöe
 
boﬁ


2626 
	$tfw_hâp_check_wûdˇrd_°©us
(c⁄° 
c
, *
out
)

2628 
c
) {

2630 *
out
 = 
HTTP_STATUS_1XX
;

2633 *
out
 = 
HTTP_STATUS_2XX
;

2636 *
out
 = 
HTTP_STATUS_3XX
;

2639 *
out
 = 
HTTP_STATUS_4XX
;

2642 *
out
 = 
HTTP_STATUS_5XX
;

2645  
Ál£
;

2647  
åue
;

2648 
	}
}

2650 
ölöe
 

2651 
	$tfw_hâp_hm_dr›_ª•
(
TfwHâpRe•
 *
ª•
)

2653 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

2655 
	`tfw_c⁄√˘i⁄_u∆ök_msg
(
ª•
->
c⁄n
);

2656 
	`tfw_≠m_upd©e
(((
TfwSîvî
 *)
ª•
->
c⁄n
->
≥î
)->
≠mªf
,

2657 
ª•
->
jrxt°amp
,Ñe•->jrxt°am∞- 
ªq
->
jtxt°amp
);

2658 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

2659 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

2660 
	}
}

2674 
	$tfw_hâp_ch›_skb
(
TfwHâpMsg
 *
hm
, 
sk_buff
 *
skb
,

2675 
off
, 
åaû
)

2677  
	`ss_skb_ch›_hód_èû
(
hm
->
msg
.
skb_hód
, 
skb
, 
off
, 
åaû
);

2678 
	}
}

2685 
	$tfw_hâp_ªq_¥o˚ss
(
TfwC⁄n
 *
c⁄n
, c⁄° 
TfwFsmD©a
 *
d©a
)

2687 
ªq_c⁄n_˛o£
, 
r
 = 
TFW_BLOCK
;

2688 
boﬁ
 
block
;

2689 
∑r£d
, 
cuº_skb_åaû
;

2690 
off
 = 
d©a
->off, 
åaû
 = data->trail;

2691 
sk_buff
 *
skb
 = 
d©a
->skb;

2692 
TfwHâpReq
 *
ªq
;

2693 
TfwHâpMsg
 *
hmsib
;

2694 
TfwHâpP¨£r
 *
∑r£r
;

2695 
TfwFsmD©a
 
d©a_up
;

2697 
	`BUG_ON
(!
c⁄n
->
msg
);

2698 
	`BUG_ON
(
off
 >
skb
->
Àn
);

2700 
	`TFW_DBG2
("Received %u client data bytes on conn=%p msg=%p\n",

2701 
skb
->
Àn
, 
c⁄n
, c⁄n->
msg
);

2707 
√xt_msg
:

2708 
block
 = 
Ál£
;

2709 
∑r£d
 = 0;

2710 
hmsib
 = 
NULL
;

2711 
ªq
 = (
TfwHâpReq
 *)
c⁄n
->
msg
;

2712 
∑r£r
 = &
ªq
->parser;

2715 i‡(
	`TFW_CONN_TYPE
(
c⁄n
Ë& 
TFW_FSM_HTTPS
)

2716 
ªq
->
Êags
 |
TFW_HTTP_F_REQ_TLS
;

2718 
r
 = 
	`ss_skb_¥o˚ss
(
skb
, 
off
, 
åaû
, 
tfw_hâp_∑r£_ªq
, 
ªq
,

2719 &
ªq
->
chunk_˙t
, &
∑r£d
);

2720 
ªq
->
msg
.
Àn
 +
∑r£d
;

2721 
cuº_skb_åaû
 = 
off
 + 
∑r£d
 + 
åaû
 < 
skb
->
Àn
 ? 0 :Årail;

2722 
	`TFW_ADD_STAT_BH
(
∑r£d
, 
˛¡
.
rx_byãs
);

2724 
	`TFW_DBG2
("RequestÖarsed:Üen=%uÇext=%pKÖarsed=%d msg_len=%lu"

2726 
skb
->
Àn
, skb->
√xt
, 
∑r£d
, 
ªq
->
msg
.Àn,Ñeq->
vîsi⁄
, 
r
);

2733 
d©a_up
.
skb
 = skb;

2734 
d©a_up
.
off
 = off;

2735 
d©a_up
.
åaû
 = 
cuº_skb_åaû
;

2736 
d©a_up
.
ªq
 = (
TfwMsg
 *)req;

2737 
d©a_up
.
ª•
 = 
NULL
;

2739 
r
) {

2741 
	`TFW_ERR
("Unrecognized HTTPÑequest "

2742 "∑r£∏ªtu∫ code, %d\n", 
r
);

2743 
	`BUG
();

2744 
TFW_BLOCK
:

2745 
	`TFW_DBG2
("Block invalid HTTPÑequest\n");

2746 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_∑r£º
);

2747 
	`tfw_˛õ¡_dr›
(
ªq
, 400, "failedÅoÖarseÑequest");

2748  
TFW_BLOCK
;

2749 
TFW_POSTPONE
:

2750 
r
 = 
	`tfw_gfsm_move
(&
c⁄n
->
°©e
, 
TFW_HTTP_FSM_REQ_CHUNK
,

2751 &
d©a_up
);

2752 
	`TFW_DBG3
("TFW_HTTP_FSM_REQ_CHUNKÑëu∫ codê%d\n", 
r
);

2753 i‡(
r
 =
TFW_BLOCK
) {

2754 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_fûtout
);

2755 
	`tfw_˛õ¡_block
(
ªq
, 403, "postponedÑequest has been"

2757  
TFW_BLOCK
;

2765  
TFW_PASS
;

2766 
TFW_PASS
:

2771 
	`BUG_ON
(!(
ªq
->
Êags
 & 
TFW_HTTP_F_CHUNKED
)

2772 && (
ªq
->
c⁄ã¡_Àngth
 !ªq->
body
.
Àn
));

2776 i‡((
ªq
->
vho°
 = 
	`tfw_hâp_tbl_vho°
((
TfwMsg
 *Ïeq, &
block
)))

2777 
ªq
->
loˇti⁄
 = 
	`tfw_loˇti⁄_m©ch
‘eq->
vho°
, &ªq->
uri_∑th
);

2779 
r
 = 
	`tfw_gfsm_move
(&
c⁄n
->
°©e
, 
TFW_HTTP_FSM_REQ_MSG
, &
d©a_up
);

2780 
	`TFW_DBG3
("TFW_HTTP_FSM_REQ_MSGÑëu∫ codê%d\n", 
r
);

2782 i‡(
r
 =
TFW_BLOCK
) {

2783 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_fûtout
);

2784 
	`tfw_˛õ¡_block
(
ªq
, 403, "parsedÑequest has been filtered"

2786  
TFW_BLOCK
;

2789 i‡(
block
) {

2790 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_fûtout
);

2791 
	`tfw_˛õ¡_block
(
ªq
, 403, "request has been filtered out via"

2793  
TFW_BLOCK
;

2800 
ªq
->
ˇche_˘l
.
time°amp
 = 
	`tfw_cuºít_time°amp
();

2801 
ªq
->
jrxt°amp
 = 
jiffõs
;

2821 i‡((
ªq
->
vîsi⁄
 =
TFW_HTTP_VER_09
)

2822 || ((
ªq
->
vîsi⁄
 =
TFW_HTTP_VER_10
)

2823 && !(
ªq
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
)))

2825 
ªq
->
Êags
 |
TFW_HTTP_F_CONN_CLOSE
;

2841 if((
ªq_c⁄n_˛o£
 = 
ªq
->
Êags
 & 
TFW_HTTP_F_CONN_CLOSE
))

2842 
	`TFW_CONN_TYPE
(
ªq
->
c⁄n
Ë|
C⁄n_St›
;

2844 i‡(!
ªq_c⁄n_˛o£
 && !
cuº_skb_åaû
) {

2849 
hmsib
 = 
	`tfw_hâp_msg_¸óã_siblög
((
TfwHâpMsg
 *)
ªq
, &
skb
,

2850 
∑r£d
);

2851 i‡(
	`u∆ikñy
(!
hmsib
)) {

2858 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

2859 
	`tfw_˛õ¡_dr›
(
ªq
, 500, "cannot create"

2861  
TFW_BLOCK
;

2865 i‡(
	`tfw_hâp_ch›_skb
((
TfwHâpMsg
 *)
ªq
, 
skb
, 
off
, 
cuº_skb_åaû
))

2866  
TFW_BLOCK
;

2877 
	`tfw_c⁄√˘i⁄_u∆ök_msg
(
c⁄n
);

2883 
	`tfw_hâp_ªq_add_£q_queue
(
ªq
);

2890 i‡(!
ªq
->
vho°
) {

2891 
	`tfw_hâp_£nd_ª•
(
ªq
, 404, "request dropped: cannot find"

2893 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

2895 i‡(
	`tfw_ˇche_¥o˚ss
((
TfwHâpMsg
 *)
ªq
, 
tfw_hâp_ªq_ˇche_cb
)) {

2900 
	`tfw_hâp_£nd_ª•
(
ªq
, 500, "request dropped:"

2902 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

2915 i‡(!
ªq_c⁄n_˛o£
 && 
hmsib
) {

2920 
c⁄n
->
msg
 = (
TfwMsg
 *)
hmsib
;

2921 
off
 +
∑r£d
;

2922 
√xt_msg
;

2925  
r
;

2926 
	}
}

2938 
	$tfw_hâp_ª•_ˇche_cb
(
TfwHâpMsg
 *
msg
)

2940 
TfwHâpRe•
 *
ª•
 = (TfwHâpRe• *)
msg
;

2941 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

2943 
	`TFW_DBG2
("%s:Ñeq = %p,Ñe• = %p\n", 
__func__
, 
ªq
, 
ª•
);

2951 i‡(
	`tfw_hâp_adju°_ª•
(
ª•
)) {

2952 
	`tfw_hâp_c⁄n_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

2953 
	`tfw_hâp_£nd_ª•
(
ªq
, 500, "response dropped:"

2955 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_Ÿhîr
);

2969 i‡(
ª•
->
c⁄n
)

2970 
	`tfw_≠m_upd©e
(((
TfwSîvî
 *)
ª•
->
c⁄n
->
≥î
)->
≠mªf
,

2971 
ª•
->
jrxt°amp
,

2972 
ª•
->
jrxt°amp
 - 
ªq
->
jtxt°amp
);

2973 
	`tfw_hâp_ª•_fwd
(
ª•
);

2974 
	}
}

2985 
	$tfw_hâp_p›ªq
(
TfwHâpMsg
 *
hmª•
)

2987 
TfwHâpReq
 *
ªq
 = 
hmª•
->req;

2988 
TfwSrvC⁄n
 *
§v_c⁄n
 = (TfwSrvC⁄¿*)
hmª•
->
c⁄n
;

2989 
	`LIST_HEAD
(
eq
);

2991 
	`•ö_lock
(&
§v_c⁄n
->
fwd_qlock
);

2992 i‡((
TfwMsg
 *)
ªq
 =
§v_c⁄n
->
msg_£¡
)

2993 
§v_c⁄n
->
msg_£¡
 = 
NULL
;

2994 
	`__hâp_ªq_dñi°
(
§v_c⁄n
, 
ªq
);

2995 
	`tfw_hâp_c⁄n_nù_adju°
(
§v_c⁄n
);

3004 i‡(
	`u∆ikñy
(
	`tfw_§v_c⁄n_ª°ri˘ed
(
§v_c⁄n
)))

3005 
	`tfw_hâp_c⁄n_fwd_ª∑ú
(
§v_c⁄n
, &
eq
);

3006 i‡(
	`tfw_hâp_c⁄n_√ed_fwd
(
§v_c⁄n
))

3007 
	`tfw_hâp_c⁄n_fwd_un£¡
(
§v_c⁄n
, &
eq
);

3008 
	`•ö_u∆ock
(&
§v_c⁄n
->
fwd_qlock
);

3010 
	`tfw_hâp_ªq_z≠_îr‹
(&
eq
);

3011 
	}
}

3019 
	$tfw_hâp_ª•_gfsm
(
TfwHâpMsg
 *
hmª•
, 
TfwFsmD©a
 *
d©a
)

3021 
r
;

3022 
TfwHâpReq
 *
ªq
 = 
hmª•
->req;

3024 
	`BUG_ON
(!
hmª•
->
c⁄n
);

3026 
r
 = 
	`tfw_gfsm_move
(&
hmª•
->
c⁄n
->
°©e
, 
TFW_HTTP_FSM_RESP_MSG
, 
d©a
);

3027 
	`TFW_DBG3
("TFW_HTTP_FSM_RESP_MSGÑëu∫ codê%d\n", 
r
);

3028 i‡(
r
 =
TFW_BLOCK
)

3029 
îr‹
;

3031 
r
 = 
	`tfw_gfsm_move
(&
hmª•
->
c⁄n
->
°©e
, 
TFW_HTTP_FSM_LOCAL_RESP_FILTER
,

3032 
d©a
);

3033 
	`TFW_DBG3
("TFW_HTTP_FSM_LOCAL_RESP_FILTERÑëu∫ codê%d\n", 
r
);

3034 i‡(
r
 =
TFW_PASS
)

3035  
TFW_PASS
;

3037 
îr‹
:

3038 
	`tfw_hâp_p›ªq
(
hmª•
);

3039 
	`tfw_hâp_c⁄n_msg_‰ì
(
hmª•
);

3040 
	`tfw_§v_˛õ¡_block
(
ªq
, 502, "response blocked: filtered out");

3041 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_fûtout
);

3042  
r
;

3043 
	}
}

3051 
	$tfw_hâp_ª•_ˇche
(
TfwHâpMsg
 *
hmª•
)

3053 
TfwHâpReq
 *
ªq
 = 
hmª•
->req;

3054 
TfwFsmD©a
 
d©a
;

3055 
time_t
 
time°amp
 = 
	`tfw_cuºít_time°amp
();

3061 
hmª•
->
ˇche_˘l
.
time°amp
 =Åimestamp;

3062 ((
TfwHâpRe•
 *)
hmª•
)->
jrxt°amp
 = 
jiffõs
;

3067 i‡(!(
hmª•
->
Êags
 & 
TFW_HTTP_F_HDR_DATE
))

3068 ((
TfwHâpRe•
 *)
hmª•
)->
d©e
 = 
time°amp
;

3073 
	`tfw_hâp_p›ªq
(
hmª•
);

3078 i‡(
ªq
->
Êags
 & 
TFW_HTTP_F_HMONITOR
) {

3079 
	`tfw_hâp_hm_dr›_ª•
((
TfwHâpRe•
 *)
hmª•
);

3086 
d©a
.
skb
 = 
NULL
;

3087 
d©a
.
off
 = d©a.
åaû
 = 0;

3088 
d©a
.
ªq
 = (
TfwMsg
 *)req;

3089 
d©a
.
ª•
 = (
TfwMsg
 *)
hmª•
;

3090 
	`tfw_gfsm_move
(&
hmª•
->
c⁄n
->
°©e
, 
TFW_HTTP_FSM_RESP_MSG_FWD
, &
d©a
);

3098 
	`tfw_c⁄√˘i⁄_u∆ök_msg
(
hmª•
->
c⁄n
);

3099 i‡(
	`tfw_ˇche_¥o˚ss
(
hmª•
, 
tfw_hâp_ª•_ˇche_cb
))

3101 
	`tfw_hâp_c⁄n_msg_‰ì
(
hmª•
);

3102 
	`tfw_hâp_£nd_ª•
(
ªq
, 500, "response dropped:"

3104 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_Ÿhîr
);

3109 
	}
}

3115 
	$tfw_hâp_ª•_ãrmö©e
(
TfwHâpMsg
 *
hm
)

3117 
TfwFsmD©a
 
d©a
;

3126 
d©a
.
skb
 = 
	`ss_skb_≥ek_èû
(&
hm
->
msg
.
skb_hód
);

3127 
	`BUG_ON
(!
d©a
.
skb
);

3128 
d©a
.
off
 = d©a.
skb
->
Àn
;

3129 
d©a
.
åaû
 = 0;

3130 
d©a
.
ªq
 = 
NULL
;

3131 
d©a
.
ª•
 = (
TfwMsg
 *)
hm
;

3133 i‡(
	`tfw_hâp_ª•_gfsm
(
hm
, &
d©a
Ë!
TFW_PASS
)

3135 
	`tfw_hâp_ª•_ˇche
(
hm
);

3136 
	}
}

3143 
	$tfw_hâp_ª•_¥o˚ss
(
TfwC⁄n
 *
c⁄n
, c⁄° 
TfwFsmD©a
 *
d©a
)

3145 
r
 = 
TFW_BLOCK
;

3146 
chunks_unu£d
, 
∑r£d
, 
off
 = 
d©a
->off;

3147 
sk_buff
 *
skb
 = 
d©a
->skb;

3148 
TfwHâpReq
 *
bad_ªq
;

3149 
TfwHâpMsg
 *
hmª•
, *
hmsib
;

3150 
TfwHâpP¨£r
 *
∑r£r
;

3151 
TfwFsmD©a
 
d©a_up
;

3152 
boﬁ
 
fûtout
 = 
Ál£
;

3154 
	`BUG_ON
(!
c⁄n
->
msg
);

3155 
	`BUG_ON
(
off
 >
skb
->
Àn
);

3160 
	`WARN_ON_ONCE
(
d©a
->
åaû
);

3161 
	`WARN_ON_ONCE
(
d©a
->
off
);

3163 
	`TFW_DBG2
("Received %u server data bytes on conn=%p msg=%p\n",

3164 
skb
->
Àn
, 
c⁄n
, c⁄n->
msg
);

3169 
√xt_msg
:

3170 
∑r£d
 = 0;

3171 
hmsib
 = 
NULL
;

3172 
hmª•
 = (
TfwHâpMsg
 *)
c⁄n
->
msg
;

3173 
∑r£r
 = &
hmª•
->parser;

3175 
r
 = 
	`ss_skb_¥o˚ss
(
skb
, 
off
, 0, 
tfw_hâp_∑r£_ª•
, 
hmª•
,

3176 &
chunks_unu£d
, &
∑r£d
);

3177 
hmª•
->
msg
.
Àn
 +
∑r£d
;

3178 
	`TFW_ADD_STAT_BH
(
∑r£d
, 
£rv
.
rx_byãs
);

3180 
	`TFW_DBG2
("ResponseÖarsed:Üen=%uÖarsed=%d msg_len=%lu"

3182 
skb
->
Àn
, 
∑r£d
, 
hmª•
->
msg
.Àn, hmª•->
vîsi⁄
, 
r
);

3189 
d©a_up
.
skb
 = skb;

3190 
d©a_up
.
off
 = off;

3191 
d©a_up
.
åaû
 = 0;

3192 
d©a_up
.
ªq
 = 
NULL
;

3193 
d©a_up
.
ª•
 = (
TfwMsg
 *)
hmª•
;

3195 
r
) {

3197 
	`TFW_ERR
("Unrecognized HTTPÑesponse "

3198 "∑r£∏ªtu∫ code, %d\n", 
r
);

3199 
	`BUG
();

3200 
TFW_BLOCK
:

3209 
	`TFW_DBG2
("Block invalid HTTPÑesponse\n");

3210 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_∑r£º
);

3211 
bad_msg
;

3212 
TFW_POSTPONE
:

3213 
r
 = 
	`tfw_gfsm_move
(&
c⁄n
->
°©e
, 
TFW_HTTP_FSM_RESP_CHUNK
,

3214 &
d©a_up
);

3215 
	`TFW_DBG3
("TFW_HTTP_FSM_RESP_CHUNKÑëu∫ codê%d\n", 
r
);

3216 i‡(
r
 =
TFW_BLOCK
) {

3217 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_fûtout
);

3218 
fûtout
 = 
åue
;

3219 
bad_msg
;

3227  
TFW_PASS
;

3228 
TFW_PASS
:

3234 i‡(!(
hmª•
->
Êags
 & (
TFW_HTTP_F_CHUNKED


3235 | 
TFW_HTTP_F_VOID_BODY
))

3236 && (
hmª•
->
c⁄ã¡_Àngth
 !hmª•->
body
.
Àn
))

3237 
bad_msg
;

3251 
	`tfw_hâp_hm_c⁄åﬁ
((
TfwHâpRe•
 *)
hmª•
);

3258 
r
 = 
	`tfw_hâp_ª•_gfsm
(
hmª•
, &
d©a_up
);

3259 i‡(
	`u∆ikñy
(
r
 < 
TFW_PASS
))

3260  
TFW_BLOCK
;

3267 i‡(
off
 + 
∑r£d
 < 
skb
->
Àn
) {

3268 
hmsib
 = 
	`tfw_hâp_msg_¸óã_siblög
(
hmª•
, &
skb
, 
∑r£d
);

3274 i‡(
	`u∆ikñy
(!
hmsib
)) {

3275 
	`TFW_INC_STAT_BH
(
£rv
.
msgs_Ÿhîr
);

3281 
	`tfw_hâp_ª•_ˇche
(
hmª•
);

3282  
TFW_BLOCK
;

3291 i‡(
	`u∆ikñy
(
r
 !
TFW_PASS
)) {

3292 
r
 = 
TFW_PASS
;

3293 
√xt_ª•
;

3299 i‡(
	`tfw_hâp_ª•_ˇche
(
hmª•
))

3300  
TFW_BLOCK
;

3301 
√xt_ª•
:

3302 i‡(
hmsib
) {

3307 
c⁄n
->
msg
 = (
TfwMsg
 *)
hmsib
;

3308 
off
 +
∑r£d
;

3309 
√xt_msg
;

3312  
r
;

3313 
bad_msg
:

3319 
bad_ªq
 = 
hmª•
->
ªq
;

3320 
	`tfw_hâp_ªq_dñi°
((
TfwSrvC⁄n
 *)
c⁄n
, 
bad_ªq
);

3321 
	`tfw_hâp_c⁄n_msg_‰ì
(
hmª•
);

3322 i‡(
fûtout
)

3323 
	`tfw_§v_˛õ¡_block
(
bad_ªq
, 502,

3327 
	`tfw_§v_˛õ¡_dr›
(
bad_ªq
, 502,

3330  
TFW_BLOCK
;

3331 
	}
}

3337 
	$__tfw_hâp_msg_¥o˚ss
(*
c⁄n
, 
TfwFsmD©a
 *
d©a
)

3339 
TfwC⁄n
 *
c
 = (TfwC⁄¿*)
c⁄n
;

3341 i‡(
	`u∆ikñy
(!
c
->
msg
)) {

3342 
c
->
msg
 = 
	`tfw_hâp_c⁄n_msg_Æloc
(c);

3343 i‡(!
c
->
msg
) {

3344 
	`__k‰ì_skb
(
d©a
->
skb
);

3345  
TFW_BLOCK
;

3347 
	`tfw_hâp_m¨k_wl_√w_msg
(
c
, (
TfwHâpMsg
 *)c->
msg
, 
d©a
->
skb
);

3348 
	`TFW_DBG2
("LökÇew msg %∞wôh c⁄√˘i⁄ %p\n", 
c
->
msg
, c);

3351 
	`TFW_DBG2
("Add skb %∞tÿmesßgê%p\n", 
d©a
->
skb
, 
c
->
msg
);

3352 
	`ss_skb_queue_èû
(&
c
->
msg
->
skb_hód
, 
d©a
->
skb
);

3354  (
	`TFW_CONN_TYPE
(
c
Ë& 
C⁄n_C t
)

3355 ? 
	`tfw_hâp_ªq_¥o˚ss
(
c
, 
d©a
)

3356 : 
	`tfw_hâp_ª•_¥o˚ss
(
c
, 
d©a
);

3357 
	}
}

3368 
	$tfw_hâp_msg_¥o˚ss
(*
c⁄n
, 
TfwFsmD©a
 *
d©a
)

3370 
r
 = 
T_OK
;

3371 
åaû
 = 
d©a
->trail;

3372 
sk_buff
 *
√xt
;

3374 i‡(
d©a
->
skb
->
¥ev
)

3375 
d©a
->
skb
->
¥ev
->
√xt
 = 
NULL
;

3376 
√xt
 = 
d©a
->
skb
->next; data->skb;

3377 
d©a
->
skb
 = 
√xt
,Çexà√xà?Çext->√xà: 
NULL
, d©a->
off
 = 0)

3379 i‡(
	`likñy
(
r
 =
T_OK
 ||Ñ =
T_POSTPONE
)) {

3380 
d©a
->
skb
->
√xt
 = d©a->skb->
¥ev
 = 
NULL
;

3381 
d©a
->
åaû
 = !
√xt
 ?Årail : 0;

3382 
r
 = 
	`__tfw_hâp_msg_¥o˚ss
(
c⁄n
, 
d©a
);

3384 
	`k‰ì
(
d©a
->
skb
);

3388  
r
;

3389 
	}
}

3396 
	$tfw_hâp_hm_§v_£nd
(
TfwSîvî
 *
§v
, *
d©a
, 
Àn
)

3398 
TfwMsgIãr
 
ô
;

3399 
TfwHâpReq
 *
ªq
;

3400 
TfwHâpMsg
 *
hmªq
;

3401 
TfwSrvC⁄n
 *
§v_c⁄n
;

3402 
TfwSå
 
msg
 = {

3403 .
±r
 = 
d©a
,

3404 .
Àn
 =Üen,

3406 
	`LIST_HEAD
(
equeue
);

3408 i‡(!(
ªq
 = 
	`tfw_hâp_msg_Æloc_ªq_light
()))

3410 
hmªq
 = (
TfwHâpMsg
 *)
ªq
;

3411 i‡(
	`tfw_hâp_msg_£tup
(
hmªq
, &
ô
, 
msg
.
Àn
))

3412 
˛ónup
;

3413 i‡(
	`tfw_msg_wrôe
(&
ô
, &
msg
))

3414 
˛ónup
;

3416 
ªq
->
Êags
 |
TFW_HTTP_F_HMONITOR
;

3417 
ªq
->
jrxt°amp
 = 
jiffõs
;

3419 
§v_c⁄n
 = 
§v
->
sg
->
sched
->
	`sched_§v_c⁄n
((
TfwMsg
 *)
ªq
, srv);

3420 i‡(!
§v_c⁄n
) {

3421 
	`TFW_WARN_ADDR
("UnableÅo find connection for health"

3422 " m⁄ô‹ög o‡backíd sîvî", &
§v
->
addr
);

3423 
˛ónup
;

3426 
	`tfw_hâp_ªq_fwd
(
§v_c⁄n
, 
ªq
, &
equeue
);

3427 
	`tfw_hâp_ªq_z≠_îr‹
(&
equeue
);

3429 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

3433 
˛ónup
:

3434 
	`tfw_hâp_msg_‰ì
(
hmªq
);

3435 
	}
}

3441 
	$tfw_hâp_ªq_key_ˇlc
(
TfwHâpReq
 *
ªq
)

3443 
TfwSå
 
ho°
;

3445 i‡(
ªq
->
hash
)

3446  
ªq
->
hash
;

3448 
ªq
->
hash
 = 
	`tfw_hash_°r
(&ªq->
uri_∑th
);

3450 i‡(
ªq
->
Êags
 & 
TFW_HTTP_F_HMONITOR
)

3451  
ªq
->
hash
;

3453 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
],

3454 
TFW_HTTP_HDR_HOST
, &
ho°
);

3455 i‡(!
	`TFW_STR_EMPTY
(&
ho°
))

3456 
ªq
->
hash
 ^
	`tfw_hash_°r
(&
ho°
);

3458  
ªq
->
hash
;

3459 
	}
}

3460 
EXPORT_SYMBOL
(
tfw_hâp_ªq_key_ˇlc
);

3462 
TfwC⁄nHooks
 
	ghâp_c⁄n_hooks
 = {

3463 .
c⁄n_öô
 = 
tfw_hâp_c⁄n_öô
,

3464 .
	gc⁄n_ª∑ú
 = 
tfw_hâp_c⁄n_ª∑ú
,

3465 .
	gc⁄n_˛o£
 = 
tfw_hâp_c⁄n_˛o£
,

3466 .
	gc⁄n_dr›
 = 
tfw_hâp_c⁄n_dr›
,

3467 .
	gc⁄n_ªÀa£
 = 
tfw_hâp_c⁄n_ªÀa£
,

3468 .
	gc⁄n_£nd
 = 
tfw_hâp_c⁄n_£nd
,

3478 
	$tfw_cfg›_deföe_block_a˘i⁄
(c⁄° *
a˘i⁄
, 
mask
,

3479 *
Êags
)

3481 i‡(!
	`°rˇ£cmp
(
a˘i⁄
, "reply")) {

3482 *
Êags
 |
mask
;

3483 } i‡(!
	`°rˇ£cmp
(
a˘i⁄
, "drop")) {

3484 *
Êags
 &~
mask
;

3486 
	`TFW_ERR_NL
("Unsuµ‹ãdárgumít: '%s'\n", 
a˘i⁄
);

3487  -
EINVAL
;

3490 
	}
}

3493 
	$tfw_cfg›_deföe_block_nﬁog
(
TfwCfgE¡ry
 *
˚
, 
mask
,

3494 *
Êags
)

3496 i‡(
˚
->
vÆ_n
 == 3) {

3497 i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[2], "nolog"))

3498 *
Êags
 |
mask
;

3500 
	`TFW_ERR_NL
("Unsuµ‹ãdárgumít: '%s'\n", 
˚
->
vÆs
[2]);

3501  -
EINVAL
;

3504 *
Êags
 &~
mask
;

3507 
	}
}

3510 
	$tfw_cfg›_block_a˘i⁄
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

3512 i‡(
˚
->
vÆ_n
 < 2 || ce->val_n > 3) {

3513 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

3514  -
EINVAL
;

3516 i‡(
˚
->
©å_n
) {

3517 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

3518  -
EINVAL
;

3521 i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[0], "error")) {

3522 i‡(
	`tfw_cfg›_deföe_block_a˘i⁄
(
˚
->
vÆs
[1],

3523 
TFW_BLK_ERR_REPLY
,

3524 &
tfw_blk_Êags
) ||

3525 
	`tfw_cfg›_deföe_block_nﬁog
(
˚
,

3526 
TFW_BLK_ERR_NOLOG
,

3527 &
tfw_blk_Êags
))

3528  -
EINVAL
;

3529 } i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[0], "attack")) {

3530 i‡(
	`tfw_cfg›_deföe_block_a˘i⁄
(
˚
->
vÆs
[1],

3531 
TFW_BLK_ATT_REPLY
,

3532 &
tfw_blk_Êags
) ||

3533 
	`tfw_cfg›_deföe_block_nﬁog
(
˚
,

3534 
TFW_BLK_ATT_NOLOG
,

3535 &
tfw_blk_Êags
))

3536  -
EINVAL
;

3538 
	`TFW_ERR_NL
("Unsuµ‹ãdárgumít: '%s'\n", 
˚
->
vÆs
[0]);

3539  -
EINVAL
;

3543 
	}
}

3546 
	$tfw_cfg›_˛ónup_block_a˘i⁄
(
TfwCfgS≥c
 *
cs
)

3548 
tfw_blk_Êags
 = 
TFW_CFG_BLK_DEF
;

3549 
	}
}

3552 
	#__TFW_STR_SET_BODY
() \

3553 
msg
->
Àn
 +
l_size
 - 
˛í_°r
->À¿+ 
b_size
 - 
body_°r
->len; \

3554 
body_°r
->
±r
 = 
√w_body
; \

3555 
body_°r
->
Àn
 = 
b_size
; \

3556 
˛í_°r
->
±r
 = 
√w_Àngth
; \

3557 
˛í_°r
->
Àn
 = 
l_size
;

	)

3560 
	$tfw_hâp_£t_body
(
ª•_code_t
 
code
, *
√w_Àngth
, 
size_t
 
l_size
,

3561 *
√w_body
, 
size_t
 
b_size
)

3563 
¥ev_Àn
;

3564 
TfwSå
 *
msg
 = &
hâp_¥edef_ª•s
[
code
];

3565 
TfwSå
 *
˛í_°r
 = 
	`TFW_STR_CLEN_CH
(
msg
);

3566 
TfwSå
 *
body_°r
 = 
	`TFW_STR_BODY_CH
(
msg
);

3567 *
¥ev_body_±r
 = 
body_°r
->
±r
;

3568 *
¥ev_˛í_±r
 = 
NULL
;

3570 i‡(
¥ev_body_±r
) {

3571 
¥ev_˛í_±r
 = 
˛í_°r
->
±r
;

3572 
¥ev_Àn
 = 
˛í_°r
->
Àn
 + 
body_°r
->len;

3575 
	`__TFW_STR_SET_BODY
();

3577 i‡(!
¥ev_body_±r
)

3580 
	`BUG_ON
(!
¥ev_˛í_±r
);

3581 i‡(
¥ev_body_±r
 !
	`__TFW_STR_CH
(&
hâp_4xx_ª•_body
, 1)->
±r
 &&

3582 
¥ev_body_±r
 !
	`__TFW_STR_CH
(&
hâp_5xx_ª•_body
, 1)->
±r
)

3584 
	`‰ì_∑ges
(()
¥ev_˛í_±r
, 
	`gë_‹dî
(
¥ev_Àn
));

3586 
	}
}

3589 
	$tfw_hâp_£t_comm⁄_body
(
°©us_code
, *
√w_Àngth
, 
size_t
 
l_size
,

3590 *
√w_body
, 
size_t
 
b_size
)

3592 
TfwSå
 *
msg
;

3593 
ª•_code_t
 
i
, 
begö
, 
íd
;

3594 
TfwSå
 *
˛í_°r
;

3595 
TfwSå
 *
body_°r
;

3596 
¥ev_Àn
;

3597 *
¥ev_˛í_±r
 = 
NULL
;

3598 *
¥ev_body_±r
 = 
NULL
;

3600 
°©us_code
) {

3601 
HTTP_STATUS_4XX
:

3602 
begö
 = 
RESP_4XX_BEGIN
;

3603 
íd
 = 
RESP_4XX_END
;

3604 
msg
 = &
hâp_4xx_ª•_body
;

3606 
HTTP_STATUS_5XX
:

3607 
begö
 = 
RESP_5XX_BEGIN
;

3608 
íd
 = 
RESP_5XX_END
;

3609 
msg
 = &
hâp_5xx_ª•_body
;

3612 
	`TFW_ERR_NL
("undeföed HTTP sètu†group: [%d]\n", 
°©us_code
);

3613  -
EINVAL
;

3616 
˛í_°r
 = 
	`__TFW_STR_CH
(
msg
, 0);

3617 
body_°r
 = 
	`__TFW_STR_CH
(
msg
, 1);

3618 
¥ev_body_±r
 = 
body_°r
->
±r
;

3620 i‡(
¥ev_body_±r
) {

3621 
¥ev_˛í_±r
 = 
˛í_°r
->
±r
;

3622 
¥ev_Àn
 = 
˛í_°r
->
Àn
 + 
body_°r
->len;

3625 
	`__TFW_STR_SET_BODY
();

3627 
i
 = 
begö
; i < 
íd
; ++i) {

3628 
TfwSå
 *
msg
 = &
hâp_¥edef_ª•s
[
i
];

3629 
TfwSå
 *
body_°r
 = 
	`TFW_STR_BODY_CH
(
msg
);

3630 i‡(!
body_°r
->
±r
 ||

3631 
body_°r
->
±r
 =
¥ev_body_±r
)

3633 
TfwSå
 *
˛í_°r
 = 
	`TFW_STR_CLEN_CH
(
msg
);

3634 
	`__TFW_STR_SET_BODY
();

3638 i‡(!
¥ev_body_±r
) {

3639 
	`BUG_ON
(
¥ev_˛í_±r
);

3643 
	`BUG_ON
(!
¥ev_˛í_±r
);

3644 
	`‰ì_∑ges
(()
¥ev_˛í_±r
, 
	`gë_‹dî
(
¥ev_Àn
));

3647 
	}
}

3660 
	$__tfw_hâp_msg_body_dup
(c⁄° *
fûíame
, 
TfwSå
 *
c_Àn_hdr
, 
size_t
 *
Àn
,

3661 
size_t
 *
body_off£t
)

3663 *
body
, *
b_°¨t
, *
ªs
 = 
NULL
;

3664 
size_t
 
b_sz
, 
t_sz
;

3665 
buff
[
TFW_ULTOA_BUF_SIZ
] = {0};

3666 
TfwSå
 *
˛_buf
 = 
	`__TFW_STR_CH
(
c_Àn_hdr
, 1);

3668 
body
 = 
	`tfw_cfg_ªad_fûe
(
fûíame
, &
b_sz
);

3669 i‡(!
body
) {

3670 *
Àn
 = *
body_off£t
 = 0;

3671  
NULL
;

3673 
˛_buf
->
±r
 = 
buff
;

3674 
˛_buf
->
Àn
 = 
	`tfw_u…ﬂ
(
b_sz
, cl_buf->
±r
, 
TFW_ULTOA_BUF_SIZ
);

3675 i‡(
	`u∆ikñy
(!
˛_buf
->
Àn
)) {

3676 
	`TFW_ERR_NL
("C™'àc›y fûê%s:Åoÿbig\n", 
fûíame
);

3677 
îr
;

3680 
c_Àn_hdr
->
Àn
 +
˛_buf
->len;

3681 
t_sz
 = 
c_Àn_hdr
->
Àn
 + 
b_sz
;

3682 
ªs
 = (*)
	`__gë_‰ì_∑ges
(
GFP_KERNEL
, 
	`gë_‹dî
(
t_sz
));

3683 i‡(!
ªs
) {

3684 
	`TFW_ERR_NL
("Can'tállocate memory storing file %s "

3685 "a†ª•⁄£ body\n", 
fûíame
);

3686 
îr_2
;

3689 
	`tfw_°r_to_c°r
(
c_Àn_hdr
, 
ªs
, 
t_sz
);

3690 
b_°¨t
 = 
ªs
 + 
c_Àn_hdr
->
Àn
;

3691 
	`mem˝y_Á°
(
b_°¨t
, 
body
, 
b_sz
);

3693 *
Àn
 = 
t_sz
;

3694 *
body_off£t
 = 
b_°¨t
 - 
ªs
;

3695 
îr_2
:

3696 
c_Àn_hdr
->
Àn
 -
˛_buf
->len;

3697 
îr
:

3698 
˛_buf
->
±r
 = 
NULL
;

3699 
˛_buf
->
Àn
 = 0;

3700 
	`‰ì_∑ges
(()
body
, 
	`gë_‹dî
(
b_sz
));

3702  
ªs
;

3703 
	}
}

3712 
	$tfw_hâp_msg_body_dup
(c⁄° *
fûíame
, 
size_t
 *
Àn
)

3714 
TfwSå
 
c_Àn_hdr
 = {

3715 .
±r
 = (
TfwSå
 []){

3716 { .
±r
 = 
S_F_CONTENT_LENGTH
,

3717 .
Àn
 = 
	`SLEN
(
S_F_CONTENT_LENGTH
) },

3718 { .
±r
 = 
NULL
, .
Àn
 = 0 },

3719 { .
±r
 = 
S_CRLFCRLF
, .
Àn
 = 
	`SLEN
(S_CRLFCRLF) },

3721 .
Àn
 = 
	`SLEN
(
S_F_CONTENT_LENGTH
 
S_CRLFCRLF
),

3722 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


3724 
size_t
 
b_off
;

3726  
	`__tfw_hâp_msg_body_dup
(
fûíame
, &
c_Àn_hdr
, 
Àn
, &
b_off
);

3727 
	}
}

3734 
	$tfw_hâp_c⁄fig_ª•_body
(
°©us_code
, c⁄° *
fûíame
)

3736 
ª•_code_t
 
code
;

3737 
size_t
 
˛_sz
, 
b_sz
, 
sz
, 
b_off
;

3738 *
˛
, *
body
;

3739 
TfwSå
 
c_Àn_hdr
 = {

3740 .
±r
 = (
TfwSå
 []){

3741 { .
±r
 = 
S_CRLF
 
S_F_CONTENT_LENGTH
,

3742 .
Àn
 = 
	`SLEN
(
S_CRLF
 
S_F_CONTENT_LENGTH
) },

3743 { .
±r
 = 
NULL
, .
Àn
 = 0 },

3744 { .
±r
 = 
S_CRLF
, .
Àn
 = 
	`SLEN
(S_CRLF) },

3746 .
Àn
 = 
	`SLEN
(
S_CRLF
 
S_F_CONTENT_LENGTH
 S_CRLF),

3747 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


3750 i‡(!(
˛
 = 
	`__tfw_hâp_msg_body_dup
(
fûíame
, &
c_Àn_hdr
, &
sz
, &
b_off
)))

3751  -
EINVAL
;

3753 
˛_sz
 = 
b_off
;

3754 
body
 = 
˛
 + 
b_off
;

3755 
b_sz
 = 
sz
 - 
b_off
;

3757 i‡(
°©us_code
 =
HTTP_STATUS_4XX
 || sètus_codê=
HTTP_STATUS_5XX
) {

3758 
	`tfw_hâp_£t_comm⁄_body
(
°©us_code
, 
˛
, 
˛_sz
, 
body
, 
b_sz
);

3762 
code
 = 
	`tfw_hâp_íum_ª•_code
(
°©us_code
);

3763 i‡(
code
 =
RESP_NUM
) {

3764 
	`TFW_ERR_NL
("Unexpected status code: [%d]\n",

3765 
°©us_code
);

3766  -
EINVAL
;

3769 
	`tfw_hâp_£t_body
(
code
, 
˛
, 
˛_sz
, 
body
, 
b_sz
);

3772 
	}
}

3781 
	$tfw_cfg›_ª•_body_ª°‹e_˛í
(
TfwSå
 *
hdr
, 
ª•_num
)

3783 
	#CLEN_STR_INIT
(
s
Ë{ 
hdr
->
±r
 = s; hdr->
Àn
 = 
	`SLEN
(s); }

	)

3784 
ª•_num
)

3786 
RESP_200
:

3787 
	`CLEN_STR_INIT
(
S_200_PART_02
);

3789 
RESP_400
:

3790 
	`CLEN_STR_INIT
(
S_400_PART_02
);

3792 
RESP_403
:

3793 
	`CLEN_STR_INIT
(
S_403_PART_02
);

3795 
RESP_404
:

3796 
	`CLEN_STR_INIT
(
S_404_PART_02
);

3798 
RESP_412
:

3799 
	`CLEN_STR_INIT
(
S_412_PART_02
);

3801 
RESP_500
:

3802 
	`CLEN_STR_INIT
(
S_500_PART_02
);

3804 
RESP_502
:

3805 
	`CLEN_STR_INIT
(
S_502_PART_02
);

3807 
RESP_503
:

3808 
	`CLEN_STR_INIT
(
S_503_PART_02
);

3810 
RESP_504
:

3811 
	`CLEN_STR_INIT
(
S_504_PART_02
);

3814 
	`TFW_WARN
("Bug in 'response_body' directive cleanup.\n");

3815 
	`CLEN_STR_INIT
(
S_DEF_PART_02
);

3818 #unde‡
CLEN_STR_INIT


3819 
	}
}

3826 
	$tfw_cfg›_˛ónup_ª•_body
(
TfwCfgS≥c
 *
cs
)

3828 
TfwSå
 *
˛í_°r_4xx
 = 
	`__TFW_STR_CH
(&
hâp_4xx_ª•_body
, 0);

3829 
TfwSå
 *
body_°r_4xx
 = 
	`__TFW_STR_CH
(&
hâp_4xx_ª•_body
, 1);

3830 
TfwSå
 *
˛í_°r_5xx
 = 
	`__TFW_STR_CH
(&
hâp_5xx_ª•_body
, 0);

3831 
TfwSå
 *
body_°r_5xx
 = 
	`__TFW_STR_CH
(&
hâp_5xx_ª•_body
, 1);

3832 
ª•_code_t
 
i
;

3834 
i
 = 0; i < 
RESP_NUM
; ++i) {

3835 
TfwSå
 *
˛í_°r
;

3836 
TfwSå
 *
body_°r
 = 
	`TFW_STR_BODY_CH
(&
hâp_¥edef_ª•s
[
i
]);

3837 i‡(!
body_°r
->
±r
)

3840 i‡(
body_°r
->
±r
 =
body_°r_4xx
->ptr ||

3841 
body_°r
->
±r
 =
body_°r_5xx
->ptr)

3844 
˛í_°r
 = 
	`TFW_STR_CLEN_CH
(&
hâp_¥edef_ª•s
[
i
]);

3845 
	`‰ì_∑ges
(()
˛í_°r
->
±r
,

3846 
	`gë_‹dî
(
˛í_°r
->
Àn
 + 
body_°r
->len));

3847 
	`TFW_STR_INIT
(
body_°r
);

3848 
	`tfw_cfg›_ª•_body_ª°‹e_˛í
(
˛í_°r
, 
i
);

3851 i‡(
body_°r_4xx
->
±r
) {

3852 
	`BUG_ON
(!
˛í_°r_4xx
->
±r
);

3853 
	`‰ì_∑ges
(()
˛í_°r_4xx
->
±r
,

3854 
	`gë_‹dî
(
˛í_°r_4xx
->
Àn
 + 
body_°r_4xx
->len));

3855 
	`TFW_STR_INIT
(
body_°r_4xx
);

3856 
	`TFW_STR_INIT
(
˛í_°r_4xx
);

3858 i‡(
body_°r_5xx
->
±r
) {

3859 
	`BUG_ON
(!
˛í_°r_5xx
->
±r
);

3860 
	`‰ì_∑ges
(()
˛í_°r_5xx
->
±r
,

3861 
	`gë_‹dî
(
˛í_°r_5xx
->
Àn
 + 
body_°r_5xx
->len));

3862 
	`TFW_STR_INIT
(
body_°r_5xx
);

3863 
	`TFW_STR_INIT
(
˛í_°r_5xx
);

3865 
	}
}

3868 
	$tfw_cfg›_∑r£_hâp_°©us
(c⁄° *
°©us
, *
out
)

3870 
i
;

3871 
i
 = 0; 
°©us
[i]; ++i) {

3872 i‡(
	`isdigô
(
°©us
[
i
]))

3875 i‡(
i
 =1 && 
°©us
[i] == '*' && !status[i+1]) {

3881 i‡(
	`tfw_hâp_check_wûdˇrd_°©us
(
°©us
[0], 
out
))

3884  -
EINVAL
;

3891 i‡(
i
 !3 || 
	`k°πoöt
(
°©us
, 10, 
out
))

3892  -
EINVAL
;

3894  
	`tfw_cfg_check_ønge
(*
out
, 
HTTP_CODE_MIN
, 
HTTP_CODE_MAX
);

3895 
	}
}

3898 
	$tfw_cfg›_ª•_body
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

3900 
code
;

3902 i‡(
	`tfw_cfg_check_vÆ_n
(
˚
, 2))

3903  -
EINVAL
;

3905 i‡(
˚
->
©å_n
) {

3906 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

3907  -
EINVAL
;

3910 i‡(
	`tfw_cfg›_∑r£_hâp_°©us
(
˚
->
vÆs
[0], &
code
)) {

3911 
	`TFW_ERR_NL
("UnableÅoÖarse HTTP code value in"

3913 
˚
->
vÆs
[0]);

3914  -
EINVAL
;

3917  
	`tfw_hâp_c⁄fig_ª•_body
(
code
, 
˚
->
vÆs
[1]);

3918 
	}
}

3921 
	$tfw_cfg›_whôñi°_m¨k
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

3923 
i
;

3924 c⁄° *
vÆ
;

3926 i‡(!
˚
->
vÆ_n
) {

3927 
	`TFW_ERR_NL
("%s: AàÀa° o√árgumíài†ªquúed", 
cs
->
«me
);

3928  -
EINVAL
;

3930 i‡(
˚
->
©å_n
) {

3931 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

3932  -
EINVAL
;

3935 
tfw_wl_m¨ks
.
sz
 = 
˚
->
vÆ_n
;

3936 i‡(!(
tfw_wl_m¨ks
.
mrks
 = 
	`kmÆloc
(
˚
->
vÆ_n
 * (),

3937 
GFP_KERNEL
)))

3938  -
ENOMEM
;

3940 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
vÆ
) {

3941 i‡(
	`tfw_cfg_∑r£_öt
(
vÆ
, &
tfw_wl_m¨ks
.
mrks
[
i
])) {

3942 
	`TFW_ERR_NL
("UnableÅoÖarse whitelist"

3943 " m¨k vÆue: '%s'\n", 
vÆ
);

3944 
	`k‰ì
(
tfw_wl_m¨ks
.
mrks
);

3945  -
EINVAL
;

3949 
	`s‹t
(
tfw_wl_m¨ks
.
mrks
,Åfw_wl_m¨ks.
sz
, (tfw_wl_marks.mrks[0]),

3950 
tfw_hâp_m¨ks_cmp
, 
NULL
);

3953 
	}
}

3956 
	$tfw_cfg›_˛ónup_whôñi°_m¨k
(
TfwCfgS≥c
 *
cs
)

3958 
	`k‰ì
(
tfw_wl_m¨ks
.
mrks
);

3959 
	`mem£t
(&
tfw_wl_m¨ks
, 0, (tfw_wl_marks));

3960 
	}
}

3963 
	$__cfg›_bønge_hndl
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, *
a
)

3965 
i
;

3966 c⁄° *
vÆ
;

3968 i‡(!
˚
->
vÆ_n
) {

3969 
	`TFW_ERR_NL
("%s: AàÀa° o√árgumíài†ªquúed", 
cs
->
«me
);

3970  -
EINVAL
;

3972 i‡(
˚
->
©å_n
) {

3973 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

3974  -
EINVAL
;

3977 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
vÆ
) {

3978 
i0
 = 0, 
i1
 = 0;

3980 i‡(
	`tfw_cfg_∑r£_ötvl
(
vÆ
, &
i0
, &
i1
)) {

3981 
	`TFW_ERR_NL
("CannotÖarse %s interval: '%s'\n",

3982 
cs
->
«me
, 
vÆ
);

3983  -
EINVAL
;

3985 i‡(
i0
 > 255 || 
i1
 > 255) {

3986 
	`TFW_ERR_NL
("TooÜarge interval bounds in %s: '%s'\n",

3987 
cs
->
«me
, 
vÆ
);

3988  -
EINVAL
;

3991 
a
[
i0
++] = 1;

3992 
i0
 <
i1
)

3993 
a
[
i0
++] = 1;

3997 
	}
}

4000 
	$tfw_cfg›_bønge_uri
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

4002 
r
;

4003 
a
[256] = {};

4005 
r
 = 
	`__cfg›_bønge_hndl
(
cs
, 
˚
, 
a
);

4006 i‡(
r
)

4007  
r
;

4008 
	`tfw_öô_cu°om_uri
(
a
);

4011 
	}
}

4014 
	$tfw_cfg›_˛ónup_bønge_uri
(
TfwCfgS≥c
 *
cs
)

4016 
	`tfw_öô_cu°om_uri
(
NULL
);

4017 
	}
}

4020 
	$tfw_cfg›_bønge_tokí
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

4022 
r
;

4023 
a
[256] = {};

4025 
r
 = 
	`__cfg›_bønge_hndl
(
cs
, 
˚
, 
a
);

4026 i‡(
r
)

4027  
r
;

4028 
	`tfw_öô_cu°om_tokí
(
a
);

4031 
	}
}

4034 
	$tfw_cfg›_˛ónup_bønge_tokí
(
TfwCfgS≥c
 *
cs
)

4036 
	`tfw_öô_cu°om_tokí
(
NULL
);

4037 
	}
}

4040 
	$tfw_cfg›_bønge_qëokí
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

4042 
r
;

4043 
a
[256] = {};

4045 
r
 = 
	`__cfg›_bønge_hndl
(
cs
, 
˚
, 
a
);

4046 i‡(
r
)

4047  
r
;

4048 
	`tfw_öô_cu°om_qëokí
(
a
);

4051 
	}
}

4054 
	$tfw_cfg›_˛ónup_bønge_qëokí
(
TfwCfgS≥c
 *
cs
)

4056 
	`tfw_öô_cu°om_qëokí
(
NULL
);

4057 
	}
}

4060 
	$tfw_cfg›_bønge_n˘l
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

4062 
r
;

4063 
a
[256] = {};

4065 
r
 = 
	`__cfg›_bønge_hndl
(
cs
, 
˚
, 
a
);

4066 i‡(
r
)

4067  
r
;

4068 
	`tfw_öô_cu°om_n˘l
(
a
);

4071 
	}
}

4074 
	$tfw_cfg›_˛ónup_bønge_n˘l
(
TfwCfgS≥c
 *
cs
)

4076 
	`tfw_öô_cu°om_n˘l
(
NULL
);

4077 
	}
}

4080 
	$tfw_cfg›_bønge_xff
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

4082 
r
;

4083 
a
[256] = {};

4085 
r
 = 
	`__cfg›_bønge_hndl
(
cs
, 
˚
, 
a
);

4086 i‡(
r
)

4087  
r
;

4088 
	`tfw_öô_cu°om_xff
(
a
);

4091 
	}
}

4094 
	$tfw_cfg›_˛ónup_bønge_xff
(
TfwCfgS≥c
 *
cs
)

4096 
	`tfw_öô_cu°om_xff
(
NULL
);

4097 
	}
}

4100 
	$tfw_cfg›_bønge_cookõ
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

4102 
r
;

4103 
a
[256] = {};

4105 
r
 = 
	`__cfg›_bønge_hndl
(
cs
, 
˚
, 
a
);

4106 i‡(
r
)

4107  
r
;

4108 
	`tfw_öô_cu°om_cookõ
(
a
);

4111 
	}
}

4114 
	$tfw_cfg›_˛ónup_bønge_cookõ
(
TfwCfgS≥c
 *
cs
)

4116 
	`tfw_öô_cu°om_cookõ
(
NULL
);

4117 
	}
}

4119 
TfwCfgS≥c
 
	gtfw_hâp_•ecs
[] = {

4121 .
«me
 = "block_action",

4122 .
	gdeÊt
 = 
NULL
,

4123 .
	gh™dÀr
 = 
tfw_cfg›_block_a˘i⁄
,

4124 .
	gÆlow_ª≥©
 = 
åue
,

4125 .
	gÆlow_n⁄e
 = 
åue
,

4126 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_block_a˘i⁄
,

4129 .
	g«me
 = "response_body",

4130 .
	gdeÊt
 = 
NULL
,

4131 .
	gh™dÀr
 = 
tfw_cfg›_ª•_body
,

4132 .
	gÆlow_ª≥©
 = 
åue
,

4133 .
	gÆlow_n⁄e
 = 
åue
,

4134 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_ª•_body
,

4137 .
	g«me
 = "whitelist_mark",

4138 .
	gdeÊt
 = 
NULL
,

4139 .
	gh™dÀr
 = 
tfw_cfg›_whôñi°_m¨k
,

4140 .
	gÆlow_n⁄e
 = 
åue
,

4141 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_whôñi°_m¨k
,

4144 .
	g«me
 = "http_uri_brange",

4145 .
	gdeÊt
 = 
NULL
,

4146 .
	gh™dÀr
 = 
tfw_cfg›_bønge_uri
,

4147 .
	gÆlow_n⁄e
 = 
åue
,

4148 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_bønge_uri
,

4151 .
	g«me
 = "http_token_brange",

4152 .
	gdeÊt
 = 
NULL
,

4153 .
	gh™dÀr
 = 
tfw_cfg›_bønge_tokí
,

4154 .
	gÆlow_n⁄e
 = 
åue
,

4155 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_bønge_tokí
,

4158 .
	g«me
 = "http_qetoken_brange",

4159 .
	gdeÊt
 = 
NULL
,

4160 .
	gh™dÀr
 = 
tfw_cfg›_bønge_qëokí
,

4161 .
	gÆlow_n⁄e
 = 
åue
,

4162 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_bønge_qëokí
,

4165 .
	g«me
 = "http_nctl_brange",

4166 .
	gdeÊt
 = 
NULL
,

4167 .
	gh™dÀr
 = 
tfw_cfg›_bønge_n˘l
,

4168 .
	gÆlow_n⁄e
 = 
åue
,

4169 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_bønge_n˘l
,

4172 .
	g«me
 = "http_xff_brange",

4173 .
	gdeÊt
 = 
NULL
,

4174 .
	gh™dÀr
 = 
tfw_cfg›_bønge_xff
,

4175 .
	gÆlow_n⁄e
 = 
åue
,

4176 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_bønge_xff
,

4179 .
	g«me
 = "http_cookie_brange",

4180 .
	gdeÊt
 = 
NULL
,

4181 .
	gh™dÀr
 = 
tfw_cfg›_bønge_cookõ
,

4182 .
	gÆlow_n⁄e
 = 
åue
,

4183 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_bønge_cookõ
,

4188 
TfwMod
 
	gtfw_hâp_mod
 = {

4189 .
«me
 = "http",

4190 .
	g•ecs
 = 
tfw_hâp_•ecs
,

4199 
__öô


4200 
	$tfw_hâp_öô
()

4202 
r
;

4205 
	`BUILD_BUG_ON
(
	`FIELD_SIZEOF
(
TfwHâpMsg
, 
hâ≥º
)

4206 > 
	`FIELD_SIZEOF
(
TfwHâpMsg
, 
∑r£r
));

4208 
r
 = 
	`tfw_gfsm_ªgi°î_fsm
(
TFW_FSM_HTTP
, 
tfw_hâp_msg_¥o˚ss
);

4209 i‡(
r
)

4210  
r
;

4212 
	`tfw_c⁄√˘i⁄_hooks_ªgi°î
(&
hâp_c⁄n_hooks
, 
TFW_FSM_HTTP
);

4214 
gh¥io
 = 
	`tfw_gfsm_ªgi°î_hook
(
TFW_FSM_TLS
,

4215 
TFW_GFSM_HOOK_PRIORITY_ANY
,

4216 
TFW_TLS_FSM_DATA_READY
,

4217 
TFW_FSM_HTTP
, 
TFW_HTTP_FSM_INIT
);

4218 i‡(
gh¥io
 < 0) {

4219 
	`tfw_c⁄√˘i⁄_hooks_uƒegi°î
(
TFW_FSM_HTTP
);

4220 
	`tfw_gfsm_uƒegi°î_fsm
(
TFW_FSM_HTTP
);

4221  
gh¥io
;

4224 
	`tfw_mod_ªgi°î
(&
tfw_hâp_mod
);

4227 
	}
}

4230 
	$tfw_hâp_exô
()

4232 
	`tfw_mod_uƒegi°î
(&
tfw_hâp_mod
);

4233 
	`tfw_gfsm_uƒegi°î_hook
(
TFW_FSM_TLS
, 
gh¥io
, 
TFW_TLS_FSM_DATA_READY
);

4234 
	`tfw_c⁄√˘i⁄_hooks_uƒegi°î
(
TFW_FSM_HTTP
);

4235 
	`tfw_gfsm_uƒegi°î_fsm
(
TFW_FSM_HTTP
);

4236 
	}
}

	@http.h

21 #i‚de‡
__TFW_HTTP_H__


22 
	#__TFW_HTTP_H__


	)

24 
	~<¸y±o/sha.h
>

26 
	~"c⁄√˘i⁄.h
"

27 
	~"gfsm.h
"

28 
	~"msg.h
"

29 
	~"£rvî.h
"

30 
	~"°r.h
"

31 
	~"vho°.h
"

33 
tfw_hâp_£ss_t
 
	tTfwHâpSess
;

63 
	#TFW_GFSM_HTTP_STATE
(
s
Ë((
TFW_FSM_HTTP
 << 
TFW_GFSM_FSM_SHIFT
Ë| (s))

	)

66 
	mTFW_HTTP_FSM_INIT
 = 
TFW_GFSM_HTTP_STATE
(0),

69 
	mTFW_HTTP_FSM_REQ_CHUNK
 = 
TFW_GFSM_HTTP_STATE
(1),

72 
	mTFW_HTTP_FSM_REQ_MSG
 = 
TFW_GFSM_HTTP_STATE
(2),

75 
	mTFW_HTTP_FSM_RESP_CHUNK
 = 
TFW_GFSM_HTTP_STATE
(3),

78 
	mTFW_HTTP_FSM_RESP_MSG
 = 
TFW_GFSM_HTTP_STATE
(4),

81 
	mTFW_HTTP_FSM_LOCAL_RESP_FILTER
 = 
TFW_GFSM_HTTP_STATE
(5),

83 
	mTFW_HTTP_FSM_RESP_MSG_FWD
 = 
TFW_GFSM_HTTP_STATE
(6),

85 
	mTFW_HTTP_FSM_DONE
 = 
TFW_GFSM_HTTP_STATE
(
TFW_GFSM_STATE_LAST
)

90 
	m_TFW_HTTP_METH_NONE
,

95 
	mTFW_HTTP_METH_COPY
,

96 
	mTFW_HTTP_METH_DELETE
,

97 
	mTFW_HTTP_METH_GET
,

98 
	mTFW_HTTP_METH_HEAD
,

99 
	mTFW_HTTP_METH_LOCK
,

100 
	mTFW_HTTP_METH_MKCOL
,

101 
	mTFW_HTTP_METH_MOVE
,

102 
	mTFW_HTTP_METH_OPTIONS
,

103 
	mTFW_HTTP_METH_PATCH
,

104 
	mTFW_HTTP_METH_POST
,

105 
	mTFW_HTTP_METH_PROPFIND
,

106 
	mTFW_HTTP_METH_PROPPATCH
,

107 
	mTFW_HTTP_METH_PUT
,

108 
	mTFW_HTTP_METH_TRACE
,

109 
	mTFW_HTTP_METH_UNLOCK
,

111 
	mTFW_HTTP_METH_PURGE
,

113 
	m_TFW_HTTP_METH_UNKNOWN
,

114 
	m_TFW_HTTP_METH_COUNT


115 } 
	ttfw_hâp_mëh_t
;

119 
	m__TFW_HTTP_VER_INVALID
,

120 
	mTFW_HTTP_VER_09
,

121 
	mTFW_HTTP_VER_10
,

122 
	mTFW_HTTP_VER_11
,

123 
	mTFW_HTTP_VER_20
,

124 
	m_TFW_HTTP_VER_COUNT


128 
	#TFW_HTTP_CC_NO_CACHE
 0x00000001

	)

129 
	#TFW_HTTP_CC_NO_STORE
 0x00000002

	)

130 
	#TFW_HTTP_CC_NO_TRANSFORM
 0x00000004

	)

131 
	#TFW_HTTP_CC_MAX_AGE
 0x00000008

	)

133 
	#TFW_HTTP_CC_MAX_STALE
 0x00000010

	)

134 
	#TFW_HTTP_CC_MIN_FRESH
 0x00000020

	)

135 
	#TFW_HTTP_CC_OIFCACHED
 0x00000040

	)

137 
	#TFW_HTTP_CC_MUST_REVAL
 0x00000100

	)

138 
	#TFW_HTTP_CC_PROXY_REVAL
 0x00000200

	)

139 
	#TFW_HTTP_CC_PUBLIC
 0x00000400

	)

140 
	#TFW_HTTP_CC_PRIVATE
 0x00000800

	)

141 
	#TFW_HTTP_CC_S_MAXAGE
 0x00001000

	)

143 
	#TFW_HTTP_CC_IS_PRESENT
 0x0000ffff

	)

145 
	#TFW_HTTP_CC_PRAGMA_NO_CACHE
 0x00010000

	)

146 
	#TFW_HTTP_CC_HDR_AGE
 0x00020000

	)

147 
	#TFW_HTTP_CC_HDR_EXPIRES
 0x00040000

	)

148 
	#TFW_HTTP_CC_HDR_AUTHORIZATION
 0x00080000

	)

150 
	#TFW_HTTP_CC_CFG_CACHE_BYPASS
 0x01000000

	)

153 
	mÊags
;

154 
	mmax_age
;

155 
	ms_maxage
;

156 
	mmax_°Æe
;

157 
	mmö_‰esh
;

158 
time_t
 
	mtime°amp
;

159 
time_t
 
	mage
;

160 
time_t
 
	mexpúes
;

161 } 
	tTfwCacheC⁄åﬁ
;

183 
	mTFW_HTTP_HDR_HOST
,

184 
	mTFW_HTTP_HDR_CONTENT_LENGTH
,

185 
	mTFW_HTTP_HDR_CONTENT_TYPE
,

186 
	mTFW_HTTP_HDR_USER_AGENT
,

187 
	mTFW_HTTP_HDR_SERVER
 = 
TFW_HTTP_HDR_USER_AGENT
,

188 
	mTFW_HTTP_HDR_COOKIE
,

189 
	mTFW_HTTP_HDR_REFERER
,

190 
	mTFW_HTTP_HDR_IF_NONE_MATCH
,

191 
	mTFW_HTTP_HDR_ETAG
 = 
TFW_HTTP_HDR_IF_NONE_MATCH
,

194 
	mTFW_HTTP_HDR_NONSINGULAR
,

196 
	mTFW_HTTP_HDR_CONNECTION
 = 
TFW_HTTP_HDR_NONSINGULAR
,

197 
	mTFW_HTTP_HDR_X_FORWARDED_FOR
,

198 
	mTFW_HTTP_HDR_KEEP_ALIVE
,

199 
	mTFW_HTTP_HDR_TRANSFER_ENCODING
,

202 
	mTFW_HTTP_HDR_RAW
,

204 
	mTFW_HTTP_HDR_NUM
 = 16,

205 } 
	ttfw_hâp_hdr_t
;

208 
	msize
;

209 
	moff
;

210 
TfwSå
 
	mtbl
[0];

211 } 
	tTfwHâpHdrTbl
;

213 
	#__HHTBL_SZ
(
o
Ë(
TFW_HTTP_HDR_NUM
 * (o))

	)

214 
	#TFW_HHTBL_EXACTSZ
(
s
Ë((
TfwHâpHdrTbl
) \

215 + (
TfwSå
Ë* (
s
))

	)

216 
	#TFW_HHTBL_SZ
(
o
Ë
	`TFW_HHTBL_EXACTSZ
(
	`__HHTBL_SZ
(o))

	)

219 
	#TFW_HBH_TOKENS_MAX
 16

	)

239 
	m•ec
;

240 
	moff
;

241 
TfwSå
 
	møw
[
TFW_HBH_TOKENS_MAX
];

242 } 
	tTfwHâpHbhHdrs
;

269 
	m_˙t
;

270 
	m_hdr_èg
;

271 
	m°©e
;

272 
	m_i_°
;

273 
	mto_ªad
;

274 
	m_acc
;

275 
time_t
 
	m_d©e
;

276 
TfwSå
 
	m_tmp_chunk
;

277 
TfwSå
 
	mhdr
;

278 
TfwHâpHbhHdrs
 
	mhbh_∑r£r
;

279 } 
	tTfwHâpP¨£r
;

283 
	mTFW_HTTP_FLAGS_COMMON
 = 0,

285 
	mTFW_HTTP_B_CONN_CLOSE
 = 
TFW_HTTP_FLAGS_COMMON
,

287 
	mTFW_HTTP_B_CONN_KA
,

289 
	mTFW_HTTP_B_CONN_EXTRA
,

291 
	mTFW_HTTP_B_CHUNKED
,

293 
	mTFW_HTTP_B_FIELD_DUPENTRY
,

296 
	mTFW_HTTP_FLAGS_REQ
,

298 
	mTFW_HTTP_B_HAS_STICKY
 = 
TFW_HTTP_FLAGS_REQ
,

300 
	mTFW_HTTP_B_URI_FULL
,

302 
	mTFW_HTTP_B_NON_IDEMP
,

304 
	mTFW_HTTP_B_SUSPECTED
,

306 
	mTFW_HTTP_B_ACCEPT_HTML
,

308 
	mTFW_HTTP_B_HMONITOR
,

310 
	mTFW_HTTP_B_WHITELIST
,

312 
	mTFW_HTTP_B_REQ_DROP
,

314 
	mTFW_HTTP_B_REQ_TLS
,

317 
	mTFW_HTTP_FLAGS_RESP
,

319 
	mTFW_HTTP_B_VOID_BODY
 = 
TFW_HTTP_FLAGS_RESP
,

321 
	mTFW_HTTP_B_HDR_DATE
,

323 
	mTFW_HTTP_B_HDR_LMODIFIED
,

325 
	mTFW_HTTP_B_RESP_STALE
,

327 
	mTFW_HTTP_B_RESP_READY
,

329 
	m_TFW_HTTP_FLAGS_NUM


332 
	#TFW_HTTP_F_CONN_CLOSE
 (1U << 
TFW_HTTP_B_CONN_CLOSE
)

	)

333 
	#TFW_HTTP_F_CONN_KA
 (1U << 
TFW_HTTP_B_CONN_KA
)

	)

334 
	#__TFW_HTTP_MSG_M_CONN_MASK
 \

335 (
TFW_HTTP_F_CONN_KA
 | 
TFW_HTTP_F_CONN_CLOSE
)

	)

336 
	#TFW_HTTP_F_CONN_EXTRA
 (1U << 
TFW_HTTP_B_CONN_EXTRA
)

	)

337 
	#TFW_HTTP_F_CHUNKED
 (1U << 
TFW_HTTP_B_CHUNKED
)

	)

338 
	#TFW_HTTP_F_FIELD_DUPENTRY
 (1U << 
TFW_HTTP_B_FIELD_DUPENTRY
)

	)

340 
	#TFW_HTTP_F_HAS_STICKY
 (1U << 
TFW_HTTP_B_HAS_STICKY
)

	)

341 
	#TFW_HTTP_F_URI_FULL
 (1U << 
TFW_HTTP_B_URI_FULL
)

	)

342 
	#TFW_HTTP_F_NON_IDEMP
 (1U << 
TFW_HTTP_B_NON_IDEMP
)

	)

343 
	#TFW_HTTP_F_SUSPECTED
 (1U << 
TFW_HTTP_B_SUSPECTED
)

	)

344 
	#TFW_HTTP_F_ACCEPT_HTML
 (1U << 
TFW_HTTP_B_ACCEPT_HTML
)

	)

345 
	#TFW_HTTP_F_HMONITOR
 (1U << 
TFW_HTTP_B_HMONITOR
)

	)

346 
	#TFW_HTTP_F_WHITELIST
 (1U << 
TFW_HTTP_B_WHITELIST
)

	)

347 
	#TFW_HTTP_F_REQ_DROP
 (1U << 
TFW_HTTP_B_REQ_DROP
)

	)

348 
	#TFW_HTTP_F_REQ_TLS
 (1U << 
TFW_HTTP_B_REQ_TLS
)

	)

350 
	#TFW_HTTP_F_VOID_BODY
 (1U << 
TFW_HTTP_B_VOID_BODY
)

	)

351 
	#TFW_HTTP_F_HDR_DATE
 (1U << 
TFW_HTTP_B_HDR_DATE
)

	)

352 
	#TFW_HTTP_F_HDR_LMODIFIED
 (1U << 
TFW_HTTP_B_HDR_LMODIFIED
)

	)

353 
	#TFW_HTTP_F_RESP_STALE
 (1U << 
TFW_HTTP_B_RESP_STALE
)

	)

354 
	#TFW_HTTP_F_RESP_READY
 (1U << 
TFW_HTTP_B_RESP_READY
)

	)

364 c⁄° *
	mªas⁄
;

365 
	m°©us
;

366 } 
	tTfwHâpEº‹
;

368 
tfw_hâp_msg_t
 
	tTfwHâpMsg
;

369 
tfw_hâp_ªq_t
 
	tTfwHâpReq
;

370 
tfw_hâp_ª•_t
 
	tTfwHâpRe•
;

407 
	#TFW_HTTP_MSG_COMMON
 \

408 
TfwMsg
 
msg
; \

409 
TfwPoﬁ
 *
poﬁ
; \

410 
TfwHâpHdrTbl
 *
h_tbl
; \

412 
TfwHâpMsg
 *
∑ú
; \

413 
TfwHâpReq
 *
ªq
; \

414 
TfwHâpRe•
 *
ª•
; \

417 
TfwHâpP¨£r
 
∑r£r
; \

418 
TfwHâpEº‹
 
hâ≥º
; \

420 
TfwCacheC⁄åﬁ
 
ˇche_˘l
; \

421 
vîsi⁄
; \

422 
Êags
; \

423 
c⁄ã¡_Àngth
; \

424 
kìp_Æive
; \

425 
TfwC⁄n
 *
c⁄n
; \

426 (*
de°ru˘‹
)(*
msg
); \

427 
TfwSå
 
¸lf
; \

428 
TfwSå
 
body
;

	)

434 
	stfw_hâp_msg_t
 {

435 
	mTFW_HTTP_MSG_COMMON
;

438 
	#__MSG_STR_START
(
m
Ë(&(m)->
¸lf
)

	)

440 
	#TFW_HTTP_COND_IF_MSINCE
 0x0001

	)

441 
	#TFW_HTTP_COND_ETAG_ANY
 0x0002

	)

442 
	#TFW_HTTP_COND_ETAG_LIST
 0x0004

	)

451 
	mÊags
;

452 
time_t
 
	mm_d©e
;

453 } 
	tTfwHâpC⁄d
;

479 
	stfw_hâp_ªq_t
 {

480 
	mTFW_HTTP_MSG_COMMON
;

481 
TfwVho°
 *
	mvho°
;

482 
TfwLoˇti⁄
 *
	mloˇti⁄
;

483 
TfwHâpSess
 *
	m£ss
;

484 
TfwHâpC⁄d
 
	mc⁄d
;

485 
TfwSå
 
	mu£röfo
;

486 
TfwSå
 
	mho°
;

487 
TfwSå
 
	muri_∑th
;

488 
li°_hód
 
	mfwd_li°
;

489 
li°_hód
 
	mnù_li°
;

490 
	mmëhod
;

491 
	mnode
;

492 
	m‰™g_°
;

493 
	mchunk_˙t
;

494 
	mjtxt°amp
;

495 
	mjrxt°amp
;

496 
	mtm_hódî
;

497 
	mtm_bchunk
;

498 
	mhash
;

499 
	mªåõs
;

502 
	#TFW_HTTP_REQ_STR_START
(
r
Ë
	`__MSG_STR_START
‘)

	)

503 
	#TFW_HTTP_REQ_STR_END
(
r
Ë((&‘)->
uri_∑th
Ë+ 1)

	)

511 
	stfw_hâp_ª•_t
 {

512 
	mTFW_HTTP_MSG_COMMON
;

513 
TfwSå
 
	ms_löe
;

514 
	m°©us
;

515 
time_t
 
	md©e
;

516 
time_t
 
	mœ°_modifõd
;

517 
	mjrxt°amp
;

520 
	#TFW_HTTP_RESP_STR_START
(
r
Ë
	`__MSG_STR_START
‘)

	)

521 
	#TFW_HTTP_RESP_STR_END
(
r
Ë((&‘)->
body
Ë+ 1)

	)

523 
	#__FOR_EACH_HDR_FIELD
(
pos
, 
íd
, 
msg
, 
soff
, 
eoff
) \

524 (
pos
Ë&(
msg
)->
h_tbl
->
tbl
[
soff
], \

525 (
íd
Ë&(
msg
)->
h_tbl
->
tbl
[
eoff
]; \

526 (
pos
Ë< (
íd
); \

527 ++(
pos
))

	)

529 
	#FOR_EACH_HDR_FIELD
(
pos
, 
íd
, 
msg
) \

530 
	`__FOR_EACH_HDR_FIELD
(
pos
, 
íd
, 
msg
, 0, (msg)->
h_tbl
->
off
)

	)

532 
	#FOR_EACH_HDR_FIELD_SPECIAL
(
pos
, 
íd
, 
msg
) \

533 
	`__FOR_EACH_HDR_FIELD
(
pos
, 
íd
, 
msg
, 0, 
TFW_HTTP_HDR_RAW
)

	)

535 
	#FOR_EACH_HDR_FIELD_RAW
(
pos
, 
íd
, 
msg
) \

536 
	`__FOR_EACH_HDR_FIELD
(
pos
, 
íd
, 
msg
, 
TFW_HTTP_HDR_RAW
, \

537 (
msg
)->
h_tbl
->
off
)

	)

539 
	#FOR_EACH_HDR_FIELD_FROM
(
pos
, 
íd
, 
msg
, 
soff
) \

540 
	`__FOR_EACH_HDR_FIELD
(
pos
, 
íd
, 
msg
, 
soff
, (msg)->
h_tbl
->
off
)

	)

543 
	#TFW_BLK_ERR_REPLY
 0x0001

	)

544 
	#TFW_BLK_ATT_REPLY
 0x0002

	)

545 
	#TFW_BLK_ERR_NOLOG
 0x0004

	)

546 
	#TFW_BLK_ATT_NOLOG
 0x0008

	)

550 
	mRESP_200
,

551 
	mRESP_4XX_BEGIN
,

552 
	mRESP_400
 = 
RESP_4XX_BEGIN
,

553 
	mRESP_403
,

554 
	mRESP_404
,

555 
	mRESP_412
,

556 
	mRESP_4XX_END
,

557 
	mRESP_5XX_BEGIN
 = 
RESP_4XX_END
,

558 
	mRESP_500
 = 
RESP_5XX_BEGIN
,

559 
	mRESP_502
,

560 
	mRESP_503
,

561 
	mRESP_504
,

562 
	mRESP_5XX_END
,

563 
	mRESP_NUM
 = 
RESP_5XX_END


564 } 
	tª•_code_t
;

567 
	mHTTP_STATUS_1XX
 = 1,

568 
	mHTTP_STATUS_2XX
,

569 
	mHTTP_STATUS_3XX
,

570 
	mHTTP_STATUS_4XX
,

571 
	mHTTP_STATUS_5XX


574 
	#HTTP_CODE_MIN
 100

	)

575 
	#HTTP_CODE_MAX
 599

	)

576 
	#HTTP_CODE_BIT_NUM
(
code
Ë((codeË- 
HTTP_CODE_MIN
)

	)

579 
ölöe
 
time_t


580 
	$tfw_cuºít_time°amp
()

582 
time•ec
 
ts
;

583 
	`gën°imeofday
(&
ts
);

584  
ts
.
tv_£c
;

585 
	}
}

587 
ölöe
 

588 
	$tfw_hâp_ª•_code_ønge
(c⁄° 
n
)

590  
n
 <
HTTP_CODE_MAX
 &&Ç >
HTTP_CODE_MIN
;

591 
	}
}

593 (*
	ttfw_hâp_ˇche_cb_t
)(
	tTfwHâpMsg
 *);

596 
	`tfw_hâp_öô_∑r£r_ªq
(
TfwHâpReq
 *
ªq
);

597 
	`tfw_hâp_öô_∑r£r_ª•
(
TfwHâpRe•
 *
ª•
);

598 
	`tfw_hâp_∑r£_ªq
(*
ªq_d©a
, *
d©a
, 
size_t
 
Àn
,

599 *
∑r£d
);

600 
	`tfw_hâp_∑r£_ª•
(*
ª•_d©a
, *
d©a
, 
size_t
 
Àn
,

601 *
∑r£d
);

602 
boﬁ
 
	`tfw_hâp_∑r£_ãrmö©e
(
TfwHâpMsg
 *
hm
);

605 
	`tfw_hâp_msg_¥o˚ss
(*
c⁄n
, 
TfwFsmD©a
 *
d©a
);

606 
	`tfw_hâp_ªq_key_ˇlc
(
TfwHâpReq
 *
ªq
);

607 
	`tfw_hâp_ªq_de°ru˘
(*
msg
);

608 
	`tfw_hâp_ª•_fwd
(
TfwHâpRe•
 *
ª•
);

609 
	`tfw_hâp_ª•_buûd_îr‹
(
TfwHâpReq
 *
ªq
);

610 
	`tfw_cfg›_∑r£_hâp_°©us
(c⁄° *
°©us
, *
out
);

611 
	`tfw_hâp_hm_§v_£nd
(
TfwSîvî
 *
§v
, *
d©a
, 
Àn
);

616 
	`tfw_hâp_¥ï_ªdúe˘
(
TfwHâpMsg
 *
ª•
, 
°©us
,

617 
TfwSå
 *
cookõ
, TfwSå *
body
);

618 
	`tfw_hâp_¥ï_304
(
TfwHâpMsg
 *
ª•
, 
TfwHâpReq
 *
ªq
, 
TfwMsgIãr
 *
msg_ô
,

619 
size_t
 
hdrs_size
);

620 
	`tfw_hâp_£nd_ª•
(
TfwHâpReq
 *
ªq
, 
°©us
, c⁄° *
ªas⁄
);

623 *
	`tfw_hâp_msg_body_dup
(c⁄° *
fûíame
, 
size_t
 *
Àn
);

	@http_limits.c

26 
	~<löux/˘y≥.h
>

27 
	~<löux/•ölock.h
>

29 
	~"lib/fsm.h
"

30 
	~"tdb.h
"

32 
	~"ãm≥°a_fw.h
"

33 
	~"addr.h
"

34 
	~"hâp_limôs.h
"

35 
	~"˛õ¡.h
"

36 
	~"c⁄√˘i⁄.h
"

37 
	~"fûãr.h
"

38 
	~"gfsm.h
"

39 
	~"hâp_msg.h
"

40 
	~"vho°.h
"

41 
	~"log.h
"

50 
__be16
 
	mp‹ts
[
DEF_MAX_PORTS
];

51 
	mcou¡
;

52 } 
tfw_öp‹ts
 
	g__ªad_mo°ly
;

54 
TfwCœssifõr
 
__rcu
 *
	g˛assifõr
 = 
NULL
;

61 
	$tfw_˛assify_shrök
()

64 
	}
}

67 
	$tfw_˛assify_ùv4
(
sk_buff
 *
skb
)

69 
r
;

70 
TfwCœssifõr
 *
˛‰
;

72 
	`rcu_ªad_lock
();

74 
˛‰
 = 
	`rcu_dîe„ªn˚
(
˛assifõr
);

75 
r
 = (
˛‰
 && cl‰->
˛assify_ùv4
)

76 ? 
˛‰
->
	`˛assify_ùv4
(
skb
)

77 : 
TFW_PASS
;

79 
	`rcu_ªad_u∆ock
();

81  
r
;

82 
	}
}

85 
	$tfw_˛assify_ùv6
(
sk_buff
 *
skb
)

87 
r
;

88 
TfwCœssifõr
 *
˛‰
;

90 
	`rcu_ªad_lock
();

92 
˛‰
 = 
	`rcu_dîe„ªn˚
(
˛assifõr
);

93 
r
 = (
˛‰
 && cl‰->
˛assify_ùv6
)

94 ? 
˛‰
->
	`˛assify_ùv6
(
skb
)

95 : 
TFW_PASS
;

97 
	`rcu_ªad_u∆ock
();

99  
r
;

100 
	}
}

103 
	$tfw_˛assifõr_add_öp‹t
(
__be16
 
p‹t
)

105 
	`BUG_ON
(
tfw_öp‹ts
.
cou¡
 =
DEF_MAX_PORTS
 - 1);

107 
tfw_öp‹ts
.
p‹ts
[tfw_öp‹ts.
cou¡
++] = 
p‹t
;

108 
	}
}

111 
	$tfw_˛assifõr_˛ónup_öp‹t
()

113 
	`mem£t
(&
tfw_öp‹ts
, 0, (tfw_inports));

114 
	}
}

117 
	$tfw_˛assify_c⁄n_e°ab
(
sock
 *
sk
)

119 
i
;

120 
•‹t
 = 
	`tfw_addr_gë_sk_•‹t
(
sk
);

121 
TfwCœssifõr
 *
˛‰
;

124 
i
 = 0; i < 
tfw_öp‹ts
.
cou¡
; ++i)

125 i‡(
•‹t
 =
tfw_öp‹ts
.
p‹ts
[
i
])

126 
ours
;

127  
TFW_PASS
;

129 
ours
:

130 
	`rcu_ªad_lock
();

132 
˛‰
 = 
	`rcu_dîe„ªn˚
(
˛assifõr
);

133 
i
 = (
˛‰
 && cl‰->
˛assify_c⁄n_e°ab
)

134 ? 
˛‰
->
	`˛assify_c⁄n_e°ab
(
sk
)

135 : 
TFW_PASS
;

137 
	`rcu_ªad_u∆ock
();

139  
i
;

140 
	}
}

143 
	$tfw_˛assify_c⁄n_˛o£
(
sock
 *
sk
)

145 
TfwCœssifõr
 *
˛‰
 = 
	`rcu_dîe„ªn˚
(
˛assifõr
);

147 i‡(
˛‰
 && cl‰->
˛assify_c⁄n_˛o£
)

148 
˛‰
->
	`˛assify_c⁄n_˛o£
(
sk
);

149 
	}
}

156 
	$tfw_˛assify_t˝
(
sock
 *
sk
, 
sk_buff
 *
skb
)

158 
t˝hdr
 *
th
 = 
	`t˝_hdr
(
skb
);

159 
TfwCœssifõr
 *
˛‰
 = 
	`rcu_dîe„ªn˚
(
˛assifõr
);

161  
˛‰
 && cl‰->
˛assify_t˝
 ? cl‰->
	`˛assify_t˝
(
th
Ë: 
TFW_PASS
;

162 
	}
}

171 
	$tfw_˛assifõr_ªgi°î
(
TfwCœssifõr
 *
mod
)

173 
	`TFW_LOG
("Regi°îögÇew cœssifõr: %s\n", 
mod
->
«me
);

175 
	`BUG_ON
(
˛assifõr
);

176 
	`rcu_assign_poöãr
(
˛assifõr
, 
mod
);

177 
	}
}

180 
	$tfw_˛assifõr_uƒegi°î
()

182 
	`TFW_LOG
("Uƒegi°îög cœssifõr: %s\n", 
˛assifõr
->
«me
);

184 
	`rcu_assign_poöãr
(
˛assifõr
, 
NULL
);

185 
	`synchr⁄ize_rcu
();

186 
	}
}

188 
Tem≥°aOps
 
	gãm≥°a_›s
 = {

189 .
sk_Æloc
 = 
tfw_˛assify_c⁄n_e°ab
,

190 .
	gsk_‰ì
 = 
tfw_˛assify_c⁄n_˛o£
,

191 .
	gsock_t˝_rcv
 = 
tfw_˛assify_t˝
,

201 
	#FRANG_FREQ
 8

	)

204 
	mts
;

205 
	mc⁄n_√w
;

206 
	mªq
;

207 } 
	tFøngR©es
;

218 
	m˙t
;

219 
	mts
;

220 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tFøngRe•CodeSèt
;

233 
	mc⁄n_cuº
;

234 
•ölock_t
 
	mlock
;

235 
FøngR©es
 
	mhi°‹y
[
FRANG_FREQ
];

236 
FøngRe•CodeSèt
 
	mª•_code_°©
[
FRANG_FREQ
];

237 } 
	tFøngAcc
;

240 
	g¥io0
, 
	g¥io1
, 
	g¥io3
;

242 
	#FRANG_CLI2ACC
(
c
Ë((
FøngAcc
 *)(&(c)->
˛ass_¥vt
))

	)

243 
	#FRANG_ACC2CLI
(
a
Ë
	`c⁄èöî_of
((
TfwCœssifõrPrvt
 *)a, \

244 
TfwClõ¡
, 
˛ass_¥vt
)

	)

250 
	#__FRANG_CFG_VAR
(
«me
, 
membî
) \

251 c⁄° 
	`ty≥of
(((
FøngCfg
 *)0)->
membî
Ë
«me
 = \

252 (
ªq
->
loˇti⁄
 \

253 ? (
ªq
->
loˇti⁄
->
‰™g_cfg
->
membî
 \

254 ? : 
	`tfw_vho°_globÆ_‰™g_cfg
()->
membî
) \

255 : 
	`tfw_vho°_globÆ_‰™g_cfg
()->
membî
)

	)

257 
	#‰™g_msg
(
check
, 
addr
, 
fmt
, ...) \

259 
abuf
[
TFW_ADDR_STR_BUF_SIZE
] = {0}; \

260 
	`tfw_addr_fmt_v6
(&(
addr
)->
v6
.
sö6_addr
, 0, 
abuf
); \

261 
	`TFW_WARN
("‰™g: %†f‹ %s" 
fmt
, 
check
, 
abuf
, ##
__VA_ARGS__
); \

262 } 0)

	)

264 
	#‰™g_limmsg
(
lim_«me
, 
cuº_vÆ
, 
lim
, 
addr
) \

265 
	`‰™g_msg
(
lim_«me
 "Éx˚eded", (
addr
), ": %ld (lim=%ld)\n", \

266 ()
cuº_vÆ
, ()
lim
)

	)

268 #ifde‡
DEBUG


269 
	#‰™g_dbg
(
fmt_msg
, 
addr
, ...) \

271 
abuf
[
TFW_ADDR_STR_BUF_SIZE
] = {0}; \

272 
	`tfw_addr_fmt_v6
(&(
addr
)->
v6
.
sö6_addr
, 0, 
abuf
); \

273 
	`TFW_DBG
("‰™g: " 
fmt_msg
, 
abuf
, ##
__VA_ARGS__
); \

274 } 0)

	)

276 
	#‰™g_dbg
(...)

	)

280 
	$‰™g_c⁄n_limô
(
FøngAcc
 *
ø
, 
sock
 *
unu£d
, 
FøngCfg
 *
c⁄f
)

282 
ts
 = (
jiffõs
 * 
FRANG_FREQ
Ë/ 
HZ
;

283 
csum
 = 0;

284 
i
 = 
ts
 % 
FRANG_FREQ
;

286 i‡(
ø
->
hi°‹y
[
i
].
ts
 !=Ås) {

287 
ø
->
hi°‹y
[
i
].
ts
 =Ås;

288 
ø
->
hi°‹y
[
i
].
c⁄n_√w
 = 0;

289 
ø
->
hi°‹y
[
i
].
ªq
 = 0;

300 
ø
->
hi°‹y
[
i
].
c⁄n_√w
++;

301 
ø
->
c⁄n_cuº
++;

303 i‡(
c⁄f
->
c⁄n_max
 && 
ø
->
c⁄n_cuº
 > conf->conn_max) {

304 
	`‰™g_limmsg
("c⁄√˘i⁄†maxÇum.", 
ø
->
c⁄n_cuº
,

305 
c⁄f
->
c⁄n_max
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

306  
TFW_BLOCK
;

309 i‡(
c⁄f
->
c⁄n_bur°
 && 
ø
->
hi°‹y
[
i
].
c⁄n_√w
 > conf->conn_burst) {

310 
	`‰™g_limmsg
("√w c⁄√˘i⁄†bur°", 
ø
->
hi°‹y
[
i
].
c⁄n_√w
,

311 
c⁄f
->
c⁄n_bur°
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

312  
TFW_BLOCK
;

316 
i
 = 0; i < 
FRANG_FREQ
; i++)

317 i‡(
ø
->
hi°‹y
[
i
].
ts
 + 
FRANG_FREQ
 >=Ås)

318 
csum
 +
ø
->
hi°‹y
[
i
].
c⁄n_√w
;

319 i‡(
c⁄f
->
c⁄n_øã
 && 
csum
 > conf->conn_rate) {

320 
	`‰™g_limmsg
("√w c⁄√˘i⁄†øã", 
csum
, 
c⁄f
->
c⁄n_øã
,

321 &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

322  
TFW_BLOCK
;

325  
TFW_PASS
;

326 
	}
}

329 
	$__‰™g_öô_acc
(
TfwClõ¡
 *
˛i
)

331 
FøngAcc
 *
ø
 = 
	`FRANG_CLI2ACC
(
˛i
);

333 
	`•ö_lock_öô
(&
ø
->
lock
);

334 
	}
}

337 
	$‰™g_c⁄n_√w
(
sock
 *
sk
)

339 
r
;

340 
FøngAcc
 *
ø
;

341 
TfwClõ¡
 *
˛i
;

342 
FøngCfg
 *
c⁄f
 = 
	`tfw_vho°_globÆ_‰™g_cfg
();

344 
˛i
 = 
	`tfw_˛õ¡_obèö
(
sk
, 
__‰™g_öô_acc
);

345 i‡(
	`u∆ikñy
(!
˛i
)) {

346 
	`TFW_ERR
("can't obtainá client for frangáccounting\n");

347  
TFW_BLOCK
;

350 
ø
 = 
	`FRANG_CLI2ACC
(
˛i
);

352 
	`•ö_lock
(&
ø
->
lock
);

364 
sk
->
sk_£curôy
 = 
ø
;

366 
r
 = 
	`‰™g_c⁄n_limô
(
ø
, 
sk
, 
c⁄f
);

367 i‡(
r
 =
TFW_BLOCK
 && 
c⁄f
->
ù_block
) {

368 
	`tfw_fûãr_block_ù
(&
˛i
->
addr
.
v6
.
sö6_addr
);

369 
	`tfw_˛õ¡_put
(
˛i
);

372 
	`•ö_u∆ock
(&
ø
->
lock
);

374  
r
;

375 
	}
}

381 
	$‰™g_c⁄n_˛o£
(
sock
 *
sk
)

383 
FøngAcc
 *
ø
 = 
sk
->
sk_£curôy
;

385 
	`BUG_ON
(!
ø
);

387 
	`•ö_lock
(&
ø
->
lock
);

389 
	`BUG_ON
(!
ø
->
c⁄n_cuº
);

390 
ø
->
c⁄n_cuº
--;

392 
	`•ö_u∆ock
(&
ø
->
lock
);

394 
	`tfw_˛õ¡_put
(
	`FRANG_ACC2CLI
(
ø
));

395 
	}
}

398 
	$‰™g_time_ö_‰ame
(c⁄° 
tcur
, c⁄° 
çªv
)

400  
çªv
 + 
FRANG_FREQ
 > 
tcur
;

401 
	}
}

404 
	$‰™g_ªq_limô
(
FøngAcc
 *
ø
, 
ªq_bur°
, 
ªq_øã
)

406 
ts
 = 
jiffõs
 * 
FRANG_FREQ
 / 
HZ
;

407 
rsum
 = 0;

408 
i
 = 
ts
 % 
FRANG_FREQ
;

410 i‡(
ø
->
hi°‹y
[
i
].
ts
 !=Ås) {

411 
ø
->
hi°‹y
[
i
].
ts
 =Ås;

412 
ø
->
hi°‹y
[
i
].
c⁄n_√w
 = 0;

413 
ø
->
hi°‹y
[
i
].
ªq
 = 0;

415 
ø
->
hi°‹y
[
i
].
ªq
++;

417 i‡(
ªq_bur°
 && 
ø
->
hi°‹y
[
i
].
ªq
 >Ñeq_burst) {

418 
	`‰™g_limmsg
("ªque°†bur°", 
ø
->
hi°‹y
[
i
].
ªq
,

419 
ªq_bur°
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

420  
TFW_BLOCK
;

423 
i
 = 0; i < 
FRANG_FREQ
; i++)

424 i‡(
	`‰™g_time_ö_‰ame
(
ts
, 
ø
->
hi°‹y
[
i
].ts))

425 
rsum
 +
ø
->
hi°‹y
[
i
].
ªq
;

426 i‡(
ªq_øã
 && 
rsum
 >Ñeq_rate) {

427 
	`‰™g_limmsg
("ªque°Ñ©e", 
rsum
, 
ªq_øã
,

428 &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

429  
TFW_BLOCK
;

432  
TFW_PASS
;

433 
	}
}

436 
	$‰™g_hâp_uri_Àn
(c⁄° 
TfwHâpReq
 *
ªq
, 
FøngAcc
 *
ø
, 
uri_Àn
)

438 i‡(
ªq
->
uri_∑th
.
Àn
 > 
uri_Àn
) {

439 
	`‰™g_limmsg
("HTTP URIÜígth", 
ªq
->
uri_∑th
.
Àn
,

440 
uri_Àn
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

441  
TFW_BLOCK
;

444  
TFW_PASS
;

445 
	}
}

459 
	$__‰™g_hâp_fõld_Àn
(c⁄° 
TfwHâpReq
 *
ªq
, 
FøngAcc
 *
ø
,

460 
fõld_Àn
)

462 c⁄° 
TfwSå
 *
fõld
, *
íd
, *
dup
, *
dup_íd
;

463 
	`__FRANG_CFG_VAR
(
hdr_˙t
, 
hâp_hdr_˙t
);

465 i‡(
hdr_˙t
 && 
ªq
->
h_tbl
->
off
 >= hdr_cnt) {

466 
	`‰™g_limmsg
("HTTP hódî†numbî", 
ªq
->
h_tbl
->
off
,

467 
hdr_˙t
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

468  
TFW_BLOCK
;

471 
	`FOR_EACH_HDR_FIELD
(
fõld
, 
íd
, 
ªq
) {

472 
	`TFW_STR_FOR_EACH_DUP
(
dup
, 
fõld
, 
dup_íd
) {

473 i‡(
fõld
->
Àn
 > 
fõld_Àn
) {

474 
	`‰™g_limmsg
("HTTP fieldÜength",

475 
fõld
->
Àn
, 
fõld_Àn
,

476 &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

477  
TFW_BLOCK
;

482  
TFW_PASS
;

483 
	}
}

486 
	$‰™g_hâp_fõld_Àn
(c⁄° 
TfwHâpReq
 *
ªq
, 
FøngAcc
 *
ø
, 
fõld_Àn
)

488 i‡(
ªq
->
∑r£r
.
hdr
.
Àn
 > 
fõld_Àn
) {

489 
	`‰™g_limmsg
("HTTP in-progress fieldÜength",

490 
ªq
->
∑r£r
.
hdr
.
Àn
, 
fõld_Àn
,

491 &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

492  
TFW_BLOCK
;

495  
	`__‰™g_hâp_fõld_Àn
(
ªq
, 
ø
, 
fõld_Àn
);

496 
	}
}

499 
	$‰™g_hâp_mëhods
(c⁄° 
TfwHâpReq
 *
ªq
, 
FøngAcc
 *
ø
, 
m_mask
)

501 
mbô
 = (1UL << 
ªq
->
mëhod
);

503 i‡(!(
m_mask
 & 
mbô
)) {

504 
	`‰™g_msg
("ª°ri˘ed HTTP mëhod", &
	`FRANG_ACC2CLI
(
ø
)->
addr
,

505 ": %u (%#lxu)\n", 
ªq
->
mëhod
, 
mbô
);

506  
TFW_BLOCK
;

508  
TFW_PASS
;

509 
	}
}

512 
	$‰™g_hâp_˘_check
(c⁄° 
TfwHâpReq
 *
ªq
, 
FøngAcc
 *
ø
, 
FøngCtVÆ
 *
˘_vÆs
)

514 
TfwSå
 
fõld
, *
s
;

515 
FøngCtVÆ
 *
cuº
;

517 i‡(
ªq
->
mëhod
 !
TFW_HTTP_METH_POST
)

518  
TFW_PASS
;

520 i‡(
	`TFW_STR_EMPTY
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_CONTENT_TYPE
])) {

521 
	`‰™g_msg
("C⁄ã¡-Ty≥ hódî fõld", &
	`FRANG_ACC2CLI
(
ø
)->
addr
,

523  
TFW_BLOCK
;

526 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_CONTENT_TYPE
],

527 
TFW_HTTP_HDR_CONTENT_TYPE
, &
fõld
);

548 
cuº
 = 
˘_vÆs
; cuº->
°r
; ++curr) {

549 i‡(
	`tfw_°r_eq_c°r
(&
fõld
, 
cuº
->
°r
, cuº->
Àn
,

550 
TFW_STR_EQ_PREFIX_CASEI
))

551  
TFW_PASS
;

555 
s
 = 
	`TFW_STR_CHUNK
(&
fõld
, 0);

556 i‡(
s
) {

557 
	`‰™g_msg
("ª°ri˘ed C⁄ã¡-Ty≥", &
	`FRANG_ACC2CLI
(
ø
)->
addr
,

558 ": %.*s\n", 
	`PR_TFW_STR
(
s
));

560 
	`‰™g_msg
("restrictedÉmpty Content-Type",

561 &
	`FRANG_ACC2CLI
(
ø
)->
addr
, "\n");

564  
TFW_BLOCK
;

565 
	}
}

573 
	$‰™g_hâp_ho°_check
(c⁄° 
TfwHâpReq
 *
ªq
, 
FøngAcc
 *
ø
)

575 
TfwAddr
 
addr
;

576 
TfwSå
 
fõld
;

577 
ªt
 = 
TFW_PASS
;

579 
	`BUG_ON
(!
ªq
);

580 
	`BUG_ON
(!
ªq
->
h_tbl
);

586 i‡(
	`TFW_STR_EMPTY
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
])) {

587 
	`‰™g_msg
("Ho° hódî fõld", &
	`FRANG_ACC2CLI
(
ø
)->
addr
,

589  
ªq
->
vîsi⁄
 > 
TFW_HTTP_VER_10
 ? 
TFW_BLOCK
 : 
TFW_PASS
;

592 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
],

593 
TFW_HTTP_HDR_HOST
, &
fõld
);

594 i‡(!
	`TFW_STR_EMPTY
(&
fõld
)) {

596 i‡(!
	`tfw_addr_±⁄
(&
fõld
, &
addr
)) {

597 
	`‰™g_msg
("Host header field contains IPáddress",

598 &
	`FRANG_ACC2CLI
(
ø
)->
addr
, "\n");

599  
TFW_BLOCK
;

603 i‡(
ªq
->
Êags
 & 
TFW_HTTP_F_URI_FULL
) {

604 *
hdrho°
;

607 i‡(
	`TFW_STR_EMPTY
(&
fõld
Ë+ TFW_STR_EMPTY(&
ªq
->
ho°
) == 1) {

608 
	`‰™g_msg
("Host headeránd URI host mismatch",

609 &
	`FRANG_ACC2CLI
(
ø
)->
addr
, "\n");

610  
TFW_BLOCK
;

613 
hdrho°
 = 
	`tfw_poﬁ_Æloc
(
ªq
->
poﬁ
, 
fõld
.
Àn
 + 1);

614 i‡(
	`u∆ikñy
(!
hdrho°
)) {

615 
	`TFW_ERR
("CanÇotállocate memory\n");

616  
TFW_BLOCK
;

618 
	`tfw_°r_to_c°r
(&
fõld
, 
hdrho°
, fõld.
Àn
 + 1);

624 i‡(!
	`tfw_°r_eq_c°r
(&
ªq
->
ho°
, 
hdrho°
, 
fõld
.
Àn
,

625 
TFW_STR_EQ_CASEI
))

627 
	`‰™g_msg
("Host header isÇotÉqualÅo host in URL",

628 &
	`FRANG_ACC2CLI
(
ø
)->
addr
, "\n");

629 
ªt
 = 
TFW_BLOCK
;

632 
	`tfw_poﬁ_‰ì
(
ªq
->
poﬁ
, 
hdrho°
, 
fõld
.
Àn
 + 1);

634 i‡(
	`TFW_STR_EMPTY
(&
fõld
)) {

636 
	`‰™g_msg
("Host header isÉmpty",

637 &
	`FRANG_ACC2CLI
(
ø
)->
addr
, "\n");

638 
ªt
 = 
TFW_BLOCK
;

641  
ªt
;

642 
	}
}

649 
	$‰™g_ª•_qu™tum
(
t‰ame
)

651  
jiffõs
 * 
FRANG_FREQ
 / (
t‰ame
 * 
HZ
);

652 
	}
}

655 
	$‰™g_bad_ª•_limô
(
FøngAcc
 *
ø
, 
FøngHâpRe•CodeBlock
 *
ª•_cblk
)

657 
FøngRe•CodeSèt
 *
°©
 = 
ø
->
ª•_code_°©
;

658 
˙t
 = 0;

659 c⁄° 
ts
 = 
	`‰™g_ª•_qu™tum
(
ª•_cblk
->
tf
);

660 
i
 = 0;

662 ; 
i
 < 
FRANG_FREQ
; ++i) {

663 i‡(
	`‰™g_time_ö_‰ame
(
ts
, 
°©
[
i
].ts))

664 
˙t
 +
°©
[
i
].cnt;

666 i‡(
˙t
 > 
ª•_cblk
->
limô
) {

667 
	`‰™g_limmsg
("hâp_ª•_code_blockÜimô", 
˙t
,

668 
ª•_cblk
->
limô
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

669  
TFW_BLOCK
;

671  
TFW_PASS
;

672 
	}
}

678 
	#TFW_GFSM_FRANG_STATE
(
s
Ë((
TFW_FSM_FRANG_REQ
 << 
TFW_GFSM_FSM_SHIFT
Ë| (s))

	)

680 
	mTFW_FRANG_REQ_FSM_INIT
 = 
TFW_GFSM_FRANG_STATE
(0),

681 
	mTFW_FRANG_REQ_FSM_DONE
 = 
TFW_GFSM_FRANG_STATE
(
TFW_GFSM_STATE_LAST
)

685 
	mFøng_Req_0
 = 0,

687 
	mFøng_Req_Hdr_Sèπ
,

688 
	mFøng_Req_Hdr_Mëhod
,

689 
	mFøng_Req_Hdr_UriLí
,

690 
	mFøng_Req_Hdr_FõldDup
,

691 
	mFøng_Req_Hdr_FõldLí
,

692 
	mFøng_Req_Hdr_FõldLíFöÆ
,

693 
	mFøng_Req_Hdr_Cæf
,

694 
	mFøng_Req_Hdr_Ho°
,

695 
	mFøng_Req_Hdr_C⁄ã¡Ty≥
,

697 
	mFøng_Req_Hdr_NoSèã
,

699 
	mFøng_Req_Body_Sèπ
,

700 
	mFøng_Req_Body_Timeout
,

701 
	mFøng_Req_Body_ChunkC¡
,

702 
	mFøng_Req_Body_Lí
,

704 
	mFøng_Req_Body_NoSèã
,

706 
	mFøng_Req_D⁄e


710 
	mTFW_FRANG_RESP_FSM_INIT
 = 
TFW_FSM_FRANG_RESP
 << 
TFW_GFSM_FSM_SHIFT


714 
	#FSM_HDR_STATE
(
°©e
) \

715 ((
°©e
 > 
Føng_Req_Hdr_Sèπ
Ë&& (°©ê< 
Føng_Req_Hdr_NoSèã
))

	)

717 
	#__FRANG_FSM_MOVE
(
°
Ë
	`T_FSM_MOVE
(°, i‡(
r
Ë
	`T_FSM_EXIT
(); )

	)

719 
	#__FRANG_FSM_JUMP_EXIT
(
°
) \

721 
__fsm_c⁄°_°©e
 = 
°
; \

722 
	`T_FSM_EXIT
(); \

723 } 0)

	)

726 
	$‰™g_hâp_ªq_¥o˚ss
(
FøngAcc
 *
ø
, 
TfwC⁄n
 *
c⁄n
, 
TfwFsmD©a
 *
d©a
)

728 
r
 = 
TFW_PASS
;

729 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
d©a
->req;

730 
sk_buff
 *
skb
 = 
d©a
->skb;

731 
sk_buff
 *
hód_skb
 = 
ªq
->
msg
.
skb_hód
;

732 
	`__FRANG_CFG_VAR
(
hdr_tmt
, 
˛¡_hdr_timeout
);

733 
	`__FRANG_CFG_VAR
(
hchnk_˙t
, 
hâp_hchunk_˙t
);

734 
	`T_FSM_INIT
(
Føng_Req_0
, "frang");

736 
	`BUG_ON
(!
ø
);

737 
	`BUG_ON
(
ªq
 !
	`c⁄èöî_of
(
c⁄n
->
msg
, 
TfwHâpReq
, msg));

738 
	`‰™g_dbg
("checkÑequest for client %s,ácc=%p\n",

739 &
	`FRANG_ACC2CLI
(
ø
)->
addr
,Ña);

741 
	`•ö_lock
(&
ø
->
lock
);

760 i‡(
hdr_tmt
 && (
skb
 !
hód_skb
Ë&& 
	`FSM_HDR_STATE
(
ªq
->
‰™g_°
))

762 
°¨t
 = 
ªq
->
tm_hódî
;

763 
dñè
 = 
hdr_tmt
;

765 i‡(
	`time_is_bef‹e_jiffõs
(
°¨t
 + 
dñè
)) {

766 
	`‰™g_limmsg
("˛õ¡ hódîÅimeout", 
jiffõs
 - 
°¨t
,

767 
dñè
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

768 
	`•ö_u∆ock
(&
ø
->
lock
);

769  
TFW_BLOCK
;

777 i‡(
hchnk_˙t
 && 
	`FSM_HDR_STATE
(
ªq
->
‰™g_°
)) {

778 i‡(
ªq
->
chunk_˙t
 > 
hchnk_˙t
) {

779 
	`‰™g_limmsg
("HTTP hódî chunk cou¡", 
ªq
->
chunk_˙t
,

780 
hchnk_˙t
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

781 
	`•ö_u∆ock
(&
ø
->
lock
);

782  
TFW_BLOCK
;

786 
	`T_FSM_START
(
ªq
->
‰™g_°
) {

794 
	`T_FSM_STATE
(
Føng_Req_0
) {

795 
	`__FRANG_CFG_VAR
(
ªq_bur°
,Ñeq_burst);

796 
	`__FRANG_CFG_VAR
(
ªq_øã
,Ñeq_rate);

797 
	`__FRANG_CFG_VAR
(
ª•_cblk
, 
hâp_ª•_code_block
);

798 i‡(
ªq_bur°
 || 
ªq_øã
)

799 
r
 = 
	`‰™g_ªq_limô
(
ø
, 
ªq_bur°
, 
ªq_øã
);

800 i‡(
r
 =
TFW_PASS
 && 
ª•_cblk
)

801 
r
 = 
	`‰™g_bad_ª•_limô
(
ø
, 
ª•_cblk
);

802 
	`__FRANG_FSM_MOVE
(
Føng_Req_Hdr_Sèπ
);

810 
	`T_FSM_STATE
(
Føng_Req_Hdr_Sèπ
) {

811 i‡(
hdr_tmt
) {

812 
ªq
->
tm_hódî
 = 
jiffõs
;

814 
	`T_FSM_JMP
(
Føng_Req_Hdr_Mëhod
);

821 
	`T_FSM_STATE
(
Føng_Req_Hdr_Mëhod
) {

822 
	`__FRANG_CFG_VAR
(
m_mask
, 
hâp_mëhods_mask
);

823 i‡(
m_mask
) {

824 i‡(
ªq
->
mëhod
 =
_TFW_HTTP_METH_NONE
) {

825 
	`T_FSM_EXIT
();

827 
r
 = 
	`‰™g_hâp_mëhods
(
ªq
, 
ø
, 
m_mask
);

829 
	`__FRANG_FSM_MOVE
(
Føng_Req_Hdr_UriLí
);

833 
	`T_FSM_STATE
(
Føng_Req_Hdr_UriLí
) {

834 
	`__FRANG_CFG_VAR
(
uri_Àn
, 
hâp_uri_Àn
);

835 i‡(
uri_Àn
) {

836 
r
 = 
	`‰™g_hâp_uri_Àn
(
ªq
, 
ø
, 
uri_Àn
);

837 i‡(!(
ªq
->
uri_∑th
.
Êags
 & 
TFW_STR_COMPLETE
))

838 
	`__FRANG_FSM_JUMP_EXIT
(
Føng_Req_Hdr_UriLí
);

840 
	`__FRANG_FSM_MOVE
(
Føng_Req_Hdr_FõldDup
);

844 
	`T_FSM_STATE
(
Føng_Req_Hdr_FõldDup
) {

845 i‡(
ªq
->
Êags
 & 
TFW_HTTP_F_FIELD_DUPENTRY
) {

846 
	`‰™g_msg
("duplicate header field found",

847 &
	`FRANG_ACC2CLI
(
ø
)->
addr
, "\n");

848 
r
 = 
TFW_BLOCK
;

850 
	`__FRANG_FSM_MOVE
(
Føng_Req_Hdr_FõldLí
);

854 
	`T_FSM_STATE
(
Føng_Req_Hdr_FõldLí
) {

855 
	`__FRANG_CFG_VAR
(
fõld_Àn
, 
hâp_fõld_Àn
);

856 i‡(
fõld_Àn
)

857 
r
 = 
	`‰™g_hâp_fõld_Àn
(
ªq
, 
ø
, 
fõld_Àn
);

858 
	`__FRANG_FSM_MOVE
(
Føng_Req_Hdr_Cæf
);

865 
	`T_FSM_STATE
(
Føng_Req_Hdr_Cæf
) {

866 i‡(
ªq
->
¸lf
.
Êags
 & 
TFW_STR_COMPLETE
)

867 
	`T_FSM_JMP
(
Føng_Req_Hdr_FõldLíFöÆ
);

868 
	`__FRANG_FSM_JUMP_EXIT
(
Føng_Req_Hdr_FõldDup
);

875 
	`T_FSM_STATE
(
Føng_Req_Hdr_FõldLíFöÆ
) {

876 
	`__FRANG_CFG_VAR
(
fõld_Àn
, 
hâp_fõld_Àn
);

877 i‡(
fõld_Àn
)

878 
r
 = 
	`__‰™g_hâp_fõld_Àn
(
ªq
, 
ø
, 
fõld_Àn
);

879 
	`__FRANG_FSM_MOVE
(
Føng_Req_Hdr_Ho°
);

883 
	`T_FSM_STATE
(
Føng_Req_Hdr_Ho°
) {

884 
	`__FRANG_CFG_VAR
(
ho°_ªquúed
, 
hâp_ho°_ªquúed
);

885 i‡(
ho°_ªquúed
)

886 
r
 = 
	`‰™g_hâp_ho°_check
(
ªq
, 
ø
);

887 
	`__FRANG_FSM_MOVE
(
Føng_Req_Hdr_C⁄ã¡Ty≥
);

894 
	`T_FSM_STATE
(
Føng_Req_Hdr_C⁄ã¡Ty≥
) {

895 
	`__FRANG_CFG_VAR
(
˘_ªquúed
, 
hâp_˘_ªquúed
);

896 
	`__FRANG_CFG_VAR
(
˘_vÆs
, 
hâp_˘_vÆs
);

897 i‡(
˘_ªquúed
 || 
˘_vÆs
)

898 
r
 = 
	`‰™g_hâp_˘_check
(
ªq
, 
ø
, 
˘_vÆs
);

899 
	`__FRANG_FSM_MOVE
(
Føng_Req_Body_Sèπ
);

906 
	`T_FSM_STATE
(
Føng_Req_Body_Sèπ
) {

907 
	`__FRANG_CFG_VAR
(
body_Àn
, 
hâp_body_Àn
);

908 
	`__FRANG_CFG_VAR
(
body_timeout
, 
˛¡_body_timeout
);

909 
	`__FRANG_CFG_VAR
(
bchunk_˙t
, 
hâp_bchunk_˙t
);

910 i‡(
body_Àn
 || 
body_timeout
 || 
bchunk_˙t
) {

911 
ªq
->
chunk_˙t
 = 0;

912 
ªq
->
tm_bchunk
 = 
jiffõs
;

913 
	`__FRANG_FSM_MOVE
(
Føng_Req_Body_ChunkC¡
);

915 
	`__FRANG_FSM_JUMP_EXIT
(
Føng_Req_D⁄e
);

923 
	`T_FSM_STATE
(
Føng_Req_Body_Timeout
) {

928 
	`__FRANG_CFG_VAR
(
body_timeout
, 
˛¡_body_timeout
);

929 i‡(
body_timeout
) {

930 
°¨t
 = 
ªq
->
tm_bchunk
;

931 
dñè
 = 
body_timeout
;

933 i‡(
	`time_is_bef‹e_jiffõs
(
°¨t
 + 
dñè
)) {

934 
	`‰™g_limmsg
("client bodyÅimeout",

935 
jiffõs
 - 
°¨t
, 
dñè
,

936 &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

937 
r
 = 
TFW_BLOCK
;

939 
ªq
->
tm_bchunk
 = 
jiffõs
;

941 
	`__FRANG_FSM_MOVE
(
Føng_Req_Body_ChunkC¡
);

945 
	`T_FSM_STATE
(
Føng_Req_Body_ChunkC¡
) {

946 
	`__FRANG_CFG_VAR
(
bchunk_˙t
, 
hâp_bchunk_˙t
);

947 i‡(
bchunk_˙t
 && 
ªq
->
chunk_˙t
 > bchunk_cnt) {

948 
	`‰™g_limmsg
("HTTP body chunk cou¡", 
ªq
->
chunk_˙t
,

949 
bchunk_˙t
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

950 
r
 = 
TFW_BLOCK
;

952 
	`__FRANG_FSM_MOVE
(
Føng_Req_Body_Lí
);

956 
	`T_FSM_STATE
(
Føng_Req_Body_Lí
) {

957 
	`__FRANG_CFG_VAR
(
body_Àn
, 
hâp_body_Àn
);

958 i‡(
body_Àn
 && (
ªq
->
body
.
Àn
 > body_len)) {

959 
	`‰™g_limmsg
("HTTP bodyÜígth", 
ªq
->
body
.
Àn
,

960 
body_Àn
, &
	`FRANG_ACC2CLI
(
ø
)->
addr
);

961 
r
 = 
TFW_BLOCK
;

963 
	`__FRANG_FSM_JUMP_EXIT
(
Føng_Req_Body_Timeout
);

967 
	`T_FSM_STATE
(
Føng_Req_D⁄e
) {

968 
	`tfw_gfsm_move
(&
c⁄n
->
°©e
, 
TFW_FRANG_REQ_FSM_DONE
, 
d©a
);

969 
	`T_FSM_EXIT
();

973 
	`T_FSM_FINISH
(
r
, 
ªq
->
‰™g_°
);

975 
	`•ö_u∆ock
(&
ø
->
lock
);

977  
r
;

978 
	}
}

981 
	$‰™g_hâp_ªq_h™dÀr
(*
obj
, 
TfwFsmD©a
 *
d©a
)

983 
r
;

984 
TfwC⁄n
 *
c⁄n
 = (TfwC⁄¿*)
obj
;

985 
FøngAcc
 *
ø
 = 
c⁄n
->
sk
->
sk_£curôy
;

986 
boﬁ
 
ù_block
 = 
	`tfw_vho°_globÆ_‰™g_cfg
()->ip_block;

988 i‡(((
TfwHâpReq
 *)
d©a
->
ªq
)->
Êags
 & 
TFW_HTTP_F_WHITELIST
)

989  
TFW_PASS
;

991 
r
 = 
	`‰™g_hâp_ªq_¥o˚ss
(
ø
, 
c⁄n
, 
d©a
);

992 i‡(
r
 =
TFW_BLOCK
 && 
ù_block
)

993 
	`tfw_fûãr_block_ù
(&
	`FRANG_ACC2CLI
(
ø
)->
addr
.
v6
.
sö6_addr
);

995  
r
;

996 
	}
}

1005 
	$‰™g_ª•_h™dÀr
(*
obj
, 
TfwFsmD©a
 *
d©a
)

1007 
ts
, 
i
;

1008 
FøngAcc
 *
ø
;

1009 
FøngRe•CodeSèt
 *
°©
;

1010 
TfwHâpRe•
 *
ª•
;

1011 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
d©a
->req;

1012 
	`__FRANG_CFG_VAR
(
c⁄f
, 
hâp_ª•_code_block
);

1014 i‡(!
c⁄f
)

1015  
TFW_PASS
;

1017 
ª•
 = (
TfwHâpRe•
 *)
d©a
->resp;

1018 
ø
 = (
FøngAcc
 *)
ªq
->
c⁄n
->
sk
->
sk_£curôy
;

1019 
°©
 = 
ø
->
ª•_code_°©
;

1020 
	`‰™g_dbg
("client %s checkÑesponse %d,ácc=%p\n",

1021 &
	`FRANG_ACC2CLI
(
ø
)->
addr
, 
ª•
->
°©us
,Ña);

1023 i‡(!
	`tfw_hâp_ª•_code_ønge
(
ª•
->
°©us
)

1024 || !
	`ã°_bô
(
	`HTTP_CODE_BIT_NUM
(
ª•
->
°©us
), 
c⁄f
->
codes
))

1025  
TFW_PASS
;

1027 
	`•ö_lock
(&
ø
->
lock
);

1029 
ts
 = 
	`‰™g_ª•_qu™tum
(
c⁄f
->
tf
);

1030 
i
 = 
ts
 % 
FRANG_FREQ
;

1031 i‡(
ts
 !
°©
[
i
].ts) {

1032 
°©
[
i
].
ts
 =Ås;

1033 
°©
[
i
].
˙t
 = 1;

1035 ++
°©
[
i
].
˙t
;

1038 
	`•ö_u∆ock
(&
ø
->
lock
);

1040  
TFW_PASS
;

1041 
	}
}

1043 
TfwCœssifõr
 
	g‰™g_˛ass_›s
 = {

1044 .
«me
 = "frang",

1045 .
	g˛assify_c⁄n_e°ab
 = 
‰™g_c⁄n_√w
,

1046 .
	g˛assify_c⁄n_˛o£
 = 
‰™g_c⁄n_˛o£
,

1055 
__öô


1056 
	$tfw_hâp_limôs_öô
()

1058 
r
;

1060 
	`ãm≥°a_ªgi°î_›s
(&
ãm≥°a_›s
);

1062 
	`BUILD_BUG_ON
(((
FøngAcc
Ë> (
TfwCœssifõrPrvt
)));

1064 
	`tfw_˛assifõr_ªgi°î
(&
‰™g_˛ass_›s
);

1066 
r
 = 
	`tfw_gfsm_ªgi°î_fsm
(
TFW_FSM_FRANG_REQ
, 
‰™g_hâp_ªq_h™dÀr
);

1067 i‡(
r
) {

1068 
	`TFW_ERR_NL
("frang: can'tÑegisterÑequest fsm\n");

1069 
îr_fsm
;

1072 
r
 = 
	`tfw_gfsm_ªgi°î_fsm
(
TFW_FSM_FRANG_RESP
, 
‰™g_ª•_h™dÀr
);

1073 i‡(
r
) {

1074 
	`TFW_ERR_NL
("frang: can'tÑegisterÑesponse fsm\n");

1075 
îr_fsm_ª•
;

1078 
¥io0
 = 
	`tfw_gfsm_ªgi°î_hook
(
TFW_FSM_HTTP
,

1079 
TFW_GFSM_HOOK_PRIORITY_ANY
,

1080 
TFW_HTTP_FSM_REQ_MSG
, 
TFW_FSM_FRANG_REQ
,

1081 
TFW_FRANG_REQ_FSM_INIT
);

1082 i‡(
¥io0
 < 0) {

1083 
	`TFW_ERR_NL
("frang: can'tÑegister gfsm msg hook\n");

1084 
r
 = 
¥io0
;

1085 
îr_hook
;

1087 
¥io1
 = 
	`tfw_gfsm_ªgi°î_hook
(
TFW_FSM_HTTP
,

1088 
TFW_GFSM_HOOK_PRIORITY_ANY
,

1089 
TFW_HTTP_FSM_REQ_CHUNK
, 
TFW_FSM_FRANG_REQ
,

1090 
TFW_FRANG_REQ_FSM_INIT
);

1091 i‡(
¥io1
 < 0) {

1092 
	`TFW_ERR_NL
("frang: can'tÑegister gfsm chunk hook\n");

1093 
r
 = 
¥io1
;

1094 
îr_hook2
;

1096 
¥io3
 = 
	`tfw_gfsm_ªgi°î_hook
(
TFW_FSM_HTTP
,

1097 
TFW_GFSM_HOOK_PRIORITY_ANY
,

1098 
TFW_HTTP_FSM_RESP_MSG_FWD
,

1099 
TFW_FSM_FRANG_RESP
,

1100 
TFW_FRANG_RESP_FSM_INIT
);

1101 i‡(
¥io3
 < 0) {

1102 
	`TFW_ERR_NL
("frang: can'tÑegister gfsm msg fwd hook\n");

1103 
r
 = 
¥io3
;

1104 
îr_hook3
;

1108 
îr_hook3
:

1109 
	`tfw_gfsm_uƒegi°î_hook
(
TFW_FSM_HTTP
, 
¥io1
, 
TFW_HTTP_FSM_REQ_CHUNK
);

1110 
îr_hook2
:

1111 
	`tfw_gfsm_uƒegi°î_hook
(
TFW_FSM_HTTP
, 
¥io0
, 
TFW_HTTP_FSM_REQ_MSG
);

1112 
îr_hook
:

1113 
	`tfw_gfsm_uƒegi°î_fsm
(
TFW_FSM_FRANG_RESP
);

1114 
îr_fsm_ª•
:

1115 
	`tfw_gfsm_uƒegi°î_fsm
(
TFW_FSM_FRANG_REQ
);

1116 
îr_fsm
:

1117 
	`tfw_˛assifõr_uƒegi°î
();

1118 
	`ãm≥°a_uƒegi°î_›s
(&
ãm≥°a_›s
);

1119  
r
;

1120 
	}
}

1123 
	$tfw_hâp_limôs_exô
()

1125 
	`TFW_DBG
("frangÉxit\n");

1127 
	`tfw_gfsm_uƒegi°î_hook
(
TFW_FSM_HTTP
, 
¥io3
, 
TFW_HTTP_FSM_RESP_MSG_FWD
);

1128 
	`tfw_gfsm_uƒegi°î_hook
(
TFW_FSM_HTTP
, 
¥io1
, 
TFW_HTTP_FSM_REQ_CHUNK
);

1129 
	`tfw_gfsm_uƒegi°î_hook
(
TFW_FSM_HTTP
, 
¥io0
, 
TFW_HTTP_FSM_REQ_MSG
);

1130 
	`tfw_gfsm_uƒegi°î_fsm
(
TFW_FSM_FRANG_RESP
);

1131 
	`tfw_gfsm_uƒegi°î_fsm
(
TFW_FSM_FRANG_REQ
);

1132 
	`tfw_˛assifõr_uƒegi°î
();

1133 
	`ãm≥°a_uƒegi°î_›s
(&
ãm≥°a_›s
);

1134 
	}
}

	@http_limits.h

21 #i‚de‡
__HTTP_LIMITS__


22 
	#__HTTP_LIMITS__


	)

24 
	~<löux/ö6.h
>

25 
	~<√t/sock.h
>

26 
	~<√t/t˝.h
>

28 
	~"ãm≥°a_fw.h
"

29 
	~"c⁄√˘i⁄.h
"

38 #ifde‡
CONFIG_DEBUG_LOCK_ALLOC


39 
	#TFW_CLASSIFIER_ACCSZ
 512

	)

41 
	#TFW_CLASSIFIER_ACCSZ
 256

	)

44 °ru˘ { 
	m_
[
TFW_CLASSIFIER_ACCSZ
]; } 
	tTfwCœssifõrPrvt
;

55 *
	m«me
;

59 (*
	m˛assify_ùv4
)(
sk_buff
 *
	mskb
);

60 (*
	m˛assify_ùv6
)(
sk_buff
 *
	mskb
);

64 (*
	m˛assify_t˝
)(
t˝hdr
 *
	mth
);

70 (*
	m˛assify_c⁄n_e°ab
)(
sock
 *
	msk
);

74 (*
	m˛assify_c⁄n_˛o£
)(
sock
 *
	msk
);

78 (*
	m˛assify_t˝_timî_ªå™s
)();

82 (*
	m˛assify_t˝_timî_kì∑live
)();

86 (*
	m˛assify_t˝_wödow
)();

91 (*
	m˛assify_t˝_zwp
)();

92 } 
	tTfwCœssifõr
;

94 
tfw_˛assifõr_add_öp‹t
(
__be16
 
p‹t
);

95 
tfw_˛assifõr_˛ónup_öp‹t
();

97 
tfw_˛assify_shrök
();

99 
tfw_˛assify_ùv4
(
sk_buff
 *
skb
);

100 
tfw_˛assify_ùv6
(
sk_buff
 *
skb
);

102 
tfw_˛assifõr_ªgi°î
(
TfwCœssifõr
 *
mod
);

103 
tfw_˛assifõr_uƒegi°î
();

119 
DECLARE_BITMAP
(
codes
, 512);

120 
	mlimô
;

121 
	mtf
;

122 } 
	tFøngHâpRe•CodeBlock
;

125 *
	m°r
;

126 
size_t
 
	mÀn
;

127 } 
	tFøngCtVÆ
;

129 
‰™g_cfg_t
 
	tFøngCfg
;

131 
	s‰™g_cfg_t
 {

133 
	mªq_øã
;

134 
	mªq_bur°
;

135 
	mc⁄n_øã
;

136 
	mc⁄n_bur°
;

137 
	mc⁄n_max
;

143 
	m˛¡_hdr_timeout
;

144 
	m˛¡_body_timeout
;

147 
	mhâp_uri_Àn
;

148 
	mhâp_fõld_Àn
;

149 
	mhâp_body_Àn
;

150 
	mhâp_hchunk_˙t
;

151 
	mhâp_bchunk_˙t
;

152 
	mhâp_hdr_˙t
;

153 
boﬁ
 
	mhâp_˘_ªquúed
;

154 
boﬁ
 
	mhâp_ho°_ªquúed
;

156 
boﬁ
 
	mù_block
;

159 
	mhâp_mëhods_mask
;

161 
FøngCtVÆ
 *
	mhâp_˘_vÆs
;

162 
FøngHâpRe•CodeBlock
 *
	mhâp_ª•_code_block
;

	@http_match.c

69 
	~<löux/˘y≥.h
>

70 
	~"hâp_m©ch.h
"

71 
	~"hâp_msg.h
"

72 
	~"cfg.h
"

85 
boﬁ


86 
	$hdr_vÆ_eq
(c⁄° 
TfwHâpReq
 *
ªq
, 
tfw_hâp_hdr_t
 
id
, 
tfw_hâp_m©ch_›_t
 
›
,

87 c⁄° *
°r
, 
°r_Àn
, 
tfw_°r_eq_Êags_t
 
Êags
)

89 
TfwSå
 *
hdr
;

90 
TfwSå
 
hdr_vÆ
;

92 
	`BUG_ON
(
id
 < 0 || id >
TFW_HTTP_HDR_NUM
);

94 
hdr
 = &
ªq
->
h_tbl
->
tbl
[
id
];

95 i‡(
	`TFW_STR_EMPTY
(
hdr
))

96  
Ál£
;

98 
	`tfw_hâp_msg_˛¡hdr_vÆ
(
hdr
, 
id
, &
hdr_vÆ
);

100 i‡(
›
 =
TFW_HTTP_MATCH_O_SUFFIX
)

101  
	`tfw_°r_eq_c°r_off
(&
hdr_vÆ
, hdr_vÆ.
Àn
 - 
°r_Àn
,

102 
°r
, 
°r_Àn
, 
Êags
);

104  
	`tfw_°r_eq_c°r
(&
hdr_vÆ
, 
°r
, 
°r_Àn
, 
Êags
);

105 
	}
}

110 
tfw_°r_eq_Êags_t


111 
	$m≠_›_to_°r_eq_Êags
(
tfw_hâp_m©ch_›_t
 
›
)

113 c⁄° 
tfw_°r_eq_Êags_t
 
Êags_tbl
[] = {

114 [ 0 ... 
_TFW_HTTP_MATCH_O_COUNT
 ] = -1,

115 [
TFW_HTTP_MATCH_O_EQ
] = 
TFW_STR_EQ_DEFAULT
,

116 [
TFW_HTTP_MATCH_O_PREFIX
] = 
TFW_STR_EQ_PREFIX
,

117 [
TFW_HTTP_MATCH_O_SUFFIX
] = 
TFW_STR_EQ_DEFAULT
,

119 
	`BUG_ON
(
Êags_tbl
[
›
] < 0);

120  
Êags_tbl
[
›
];

121 
	}
}

123 
boﬁ


124 
	$m©ch_mëhod
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

126 i‡(
ruÀ
->
›
 =
TFW_HTTP_MATCH_O_EQ
)

127  
ªq
->
mëhod
 =
ruÀ
->
¨g
.method;

130 
	`BUG
();

132 
	}
}

134 
boﬁ


135 
	$m©ch_uri
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

137 c⁄° 
TfwSå
 *
uri_∑th
 = &
ªq
->uri_path;

138 c⁄° 
TfwHâpM©chArg
 *
¨g
 = &
ruÀ
->arg;

139 
tfw_°r_eq_Êags_t
 
Êags
 = 
	`m≠_›_to_°r_eq_Êags
(
ruÀ
->
›
);

147 
Êags
 |
TFW_STR_EQ_CASEI
;

149 i‡(
ruÀ
->
›
 =
TFW_HTTP_MATCH_O_SUFFIX
)

150  
	`tfw_°r_eq_c°r_off
(
uri_∑th
, uri_∑th->
Àn
 - 
¨g
->len,

151 
¨g
->
°r
,árg->
Àn
, 
Êags
);

153  
	`tfw_°r_eq_c°r
(
uri_∑th
, 
¨g
->
°r
,árg->
Àn
, 
Êags
);

154 
	}
}

156 
boﬁ


157 
	$m©ch_ho°
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

159 c⁄° 
TfwSå
 *
ho°
 = &
ªq
->host;

160 c⁄° 
TfwHâpM©chArg
 *
¨g
 = &
ruÀ
->arg;

161 
tfw_°r_eq_Êags_t
 
Êags
 = 
	`m≠_›_to_°r_eq_Êags
(
ruÀ
->
›
);

173 
Êags
 |
TFW_STR_EQ_CASEI
;

175 i‡(
ho°
->
Àn
 == 0)

176  
	`hdr_vÆ_eq
(
ªq
, 
TFW_HTTP_HDR_HOST
,

177 
ruÀ
->
›
, 
¨g
->
°r
,árg->
Àn
, 
Êags
);

179 i‡(
ruÀ
->
›
 =
TFW_HTTP_MATCH_O_SUFFIX
)

180  
	`tfw_°r_eq_c°r_off
(
ho°
, ho°->
Àn
 - 
¨g
->len,

181 
¨g
->
°r
,árg->
Àn
, 
Êags
);

183  
	`tfw_°r_eq_c°r
(
ho°
, 
¨g
->
°r
,árg->
Àn
, 
Êags
);

184 
	}
}

186 
boﬁ


187 
	$m©ch_hdr
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

189 c⁄° 
tfw_hâp_hdr_t
 
id_tbl
[] = {

190 [0 ... 
_TFW_HTTP_MATCH_F_COUNT
] = -1,

191 [
TFW_HTTP_MATCH_F_HDR_CONN
] = 
TFW_HTTP_HDR_CONNECTION
,

192 [
TFW_HTTP_MATCH_F_HDR_HOST
] = 
TFW_HTTP_HDR_HOST
,

193 [
TFW_HTTP_MATCH_F_HDR_CTYPE
] = 
TFW_HTTP_HDR_CONTENT_TYPE
,

194 [
TFW_HTTP_MATCH_F_HDR_UAGENT
] = 
TFW_HTTP_HDR_USER_AGENT
,

195 [
TFW_HTTP_MATCH_F_HDR_COOKIE
] = 
TFW_HTTP_HDR_COOKIE
,

196 [
TFW_HTTP_MATCH_F_HDR_REFERER
] = 
TFW_HTTP_HDR_REFERER
,

197 [
TFW_HTTP_MATCH_F_HDR_NMATCH
] = 
TFW_HTTP_HDR_IF_NONE_MATCH
,

198 [
TFW_HTTP_MATCH_F_HDR_XFRWD
] = 
TFW_HTTP_HDR_X_FORWARDED_FOR
,

201 c⁄° 
TfwHâpM©chArg
 *
¨g
 = &
ruÀ
->arg;

202 
tfw_°r_eq_Êags_t
 
Êags
 = 
	`m≠_›_to_°r_eq_Êags
(
ruÀ
->
›
);

203 
tfw_hâp_hdr_t
 
id
 = 
id_tbl
[
ruÀ
->
fõld
];

204 
	`BUG_ON
(
id
 < 0);

208 
Êags
 |
TFW_STR_EQ_CASEI
;

210  
	`hdr_vÆ_eq
(
ªq
, 
id
, 
ruÀ
->
›
, 
¨g
->
°r
,árg->
Àn
, 
Êags
);

211 
	}
}

213 
	#_MOVE_TO_COND
(
p
, 
íd
, 
c⁄d
) \

214 (
p
Ë< (
íd
Ë&& !(
c⁄d
)) \

215 (
p
)++;

	)

220 
boﬁ


221 
	$m©ch_hdr_øw
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

223 
i
;

224 
tfw_°r_eq_Êags_t
 
Êags
 = 
	`m≠_›_to_°r_eq_Êags
(
ruÀ
->
›
);

226 
i
 = 0; i < 
ªq
->
h_tbl
->
off
; ++i) {

227 c⁄° 
TfwSå
 *
hdr
, *
dup
, *
íd
, *
chunk
;

228 c⁄° *
c
, *
˚nd
, *
p
, *
≥nd
;

229 
¥ev
;

230 
˙um
;

232 
hdr
 = &
ªq
->
h_tbl
->
tbl
[
i
];

233 i‡(
	`TFW_STR_EMPTY
(
hdr
)) {

237 
	`TFW_STR_FOR_EACH_DUP
(
dup
, 
hdr
, 
íd
) {

239 
p
 = 
ruÀ
->
¨g
.
°r
;

240 
≥nd
 = 
ruÀ
->
¨g
.
°r
 +ÑuÀ->¨g.
Àn
;

241 
˙um
 = 0;

242 
chunk
 = 
	`TFW_STR_CHUNK
(
dup
, 0);

243 i‡(!
chunk
) {

244  
p
 =
NULL
;

246 
c
 = 
chunk
->
±r
;

247 
˚nd
 = 
chunk
->
±r
 + chunk->
Àn
;

249 
	#_TRY_NEXT_CHUNK
(
ok_code
, 
îr_code
) \

250 i‡(
	`u∆ikñy
(
c
 =
˚nd
)) { \

251 ++
˙um
; \

252 
chunk
 = 
	`TFW_STR_CHUNK
(
dup
, 
˙um
); \

253 i‡(
chunk
) { \

254 
c
 = 
chunk
->
±r
; \

255 
˚nd
 = 
chunk
->
±r
 + chunk->
Àn
; \

256 
ok_code
; \

258 
îr_code
; \

260 }

	)

262 
¥ev
 = *
p
;

263 
°©e_comm⁄
:

264 
p
 !
≥nd
 && 
c
 !
˚nd
) {

268 i‡(*
p
 !
	`tﬁowî
(*
c
)) {

275 i‡(
	`is•a˚
(
¥ev
) ||Örev == ':') {

276 i‡(
	`is•a˚
(*
c
)) {

277 
c
++;

278 
°©e_hdr_•
;

281 i‡(
	`is•a˚
(*
p
)) {

282 
¥ev
 = *
p
++;

283 
°©e_ruÀ_•
;

287  
Ál£
;

290 
¥ev
 = *
p
++;

291 
c
++;

294 i‡(
p
 =
≥nd
 && 
Êags
 & 
TFW_STR_EQ_PREFIX
) {

295  
åue
;

298 
	`_TRY_NEXT_CHUNK
(
°©e_comm⁄
, {

302 i‡(
p
 =
≥nd
) {

303  
åue
;

309 i‡(
	`is•a˚
(*
p
)) {

310 
p
++;

311 
°©e_ruÀ_•
;

318 i‡(
	`is•a˚
(*
c
)) {

319 
c
++;

320 
°©e_hdr_•
;

323  
Ál£
;

325 
°©e_ruÀ_•
:

326 
	`_MOVE_TO_COND
(
p
, 
≥nd
, !
	`is•a˚
(*p));

327 
°©e_comm⁄
;

329 
°©e_hdr_•
:

330 
	`_MOVE_TO_COND
(
c
, 
˚nd
, !
	`is•a˚
(*c));

331 
°©e_comm⁄
;

335  
Ál£
;

336 
	}
}

338 
boﬁ


339 
	$m©ch_wûdˇrd
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

341 i‡((
ruÀ
->
›
 =
TFW_HTTP_MATCH_O_WILDCARD
)

342 && (
ruÀ
->
¨g
.
ty≥
 =
TFW_HTTP_MATCH_A_WILDCARD
))

343  
åue
;

344  
Ál£
;

345 
	}
}

347 
boﬁ


348 
	$m©ch_m¨k
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

350 
	`BUG_ON
(
ruÀ
->
›
 !
TFW_HTTP_MATCH_O_EQ
);

351  
ªq
->
msg
.
skb_hód
->
m¨k
 =
ruÀ
->
¨g
.
num
;

352 
	}
}

355 
	$boﬁ
 (*
	tm©ch_‚
)(c⁄° 
	tTfwHâpReq
 *, c⁄° 
	tTfwHâpM©chRuÀ
 *);

357 c⁄° 
m©ch_‚
 
m©ch_‚_tbl
[
_TFW_HTTP_MATCH_F_COUNT
] = {

358 [
TFW_HTTP_MATCH_F_WILDCARD
] = 
m©ch_wûdˇrd
,

359 [
TFW_HTTP_MATCH_F_HDR_CONN
] = 
m©ch_hdr
,

360 [
TFW_HTTP_MATCH_F_HDR_HOST
] = 
m©ch_hdr
,

361 [
TFW_HTTP_MATCH_F_HDR_CTYPE
] = 
m©ch_hdr
,

362 [
TFW_HTTP_MATCH_F_HDR_UAGENT
] = 
m©ch_hdr
,

363 [
TFW_HTTP_MATCH_F_HDR_COOKIE
] = 
m©ch_hdr
,

364 [
TFW_HTTP_MATCH_F_HDR_REFERER
] = 
m©ch_hdr
,

365 [
TFW_HTTP_MATCH_F_HDR_NMATCH
] = 
m©ch_hdr
,

366 [
TFW_HTTP_MATCH_F_HDR_XFRWD
] = 
m©ch_hdr
,

367 [
TFW_HTTP_MATCH_F_HDR_RAW
] = 
m©ch_hdr_øw
,

368 [
TFW_HTTP_MATCH_F_HOST
] = 
m©ch_ho°
,

369 [
TFW_HTTP_MATCH_F_METHOD
] = 
m©ch_mëhod
,

370 [
TFW_HTTP_MATCH_F_URI
] = 
m©ch_uri
,

371 [
TFW_HTTP_MATCH_F_MARK
] = 
m©ch_m¨k
,

372 
	}
};

379 
boﬁ


380 
	$do_evÆ
(c⁄° 
TfwHâpReq
 *
ªq
, c⁄° 
TfwHâpM©chRuÀ
 *
ruÀ
)

382 
m©ch_‚
 match_fn;

383 
tfw_hâp_m©ch_Êd_t
 
fõld
;

385 
	`TFW_DBG2
("rule: %p, field: %#x, op: %#x,árg:%d:%d'%.*s'\n",

386 
ruÀ
,ÑuÀ->
fõld
,ÑuÀ->
›
,ÑuÀ->
¨g
.
ty≥
,ÑuÀ->¨g.
Àn
,

387 
ruÀ
->
¨g
.
Àn
,ÑuÀ->¨g.
°r
);

389 
	`BUG_ON
(!
ªq
 || !
ruÀ
);

390 
	`BUG_ON
(
ruÀ
->
fõld
 <0 ||ÑuÀ->fõld >
_TFW_HTTP_MATCH_F_COUNT
);

391 
	`BUG_ON
(
ruÀ
->
›
 <0 ||ÑuÀ->› >
_TFW_HTTP_MATCH_O_COUNT
);

392 
	`BUG_ON
(
ruÀ
->
a˘
.
ty≥
 <= 0 ||

393 
ruÀ
->
a˘
.
ty≥
 >
_TFW_HTTP_MATCH_ACT_COUNT
);

394 
	`BUG_ON
(
ruÀ
->
¨g
.
ty≥
 <= 0 ||

395 
ruÀ
->
¨g
.
ty≥
 >
_TFW_HTTP_MATCH_A_COUNT
);

396 
	`BUG_ON
(
ruÀ
->
¨g
.
Àn
 < 0 ||

397 
ruÀ
->
¨g
.
Àn
 >
TFW_HTTP_MATCH_MAX_ARG_LEN
);

399 
fõld
 = 
ruÀ
->field;

400 
m©ch_‚
 = 
m©ch_‚_tbl
[
fõld
];

401 
	`BUG_ON
(!
m©ch_‚
);

403 i‡(!(
	`m©ch_‚
(
ªq
, 
ruÀ
Ë^ÑuÀ->
öv
))

404  
Ál£
;

409 i‡(
ruÀ
->
a˘
.
ty≥
 =
TFW_HTTP_MATCH_ACT_MARK
) {

410 
ªq
->
msg
.
skb_hód
->
m¨k
 = 
ruÀ
->
a˘
.mark;

411  
Ál£
;

413  
åue
;

414 
	}
}

420 
TfwHâpM©chRuÀ
 *

421 
	$tfw_hâp_m©ch_ªq
(c⁄° 
TfwHâpReq
 *
ªq
, 
li°_hód
 *
ml°
)

423 
TfwHâpM©chRuÀ
 *
ruÀ
;

425 
	`TFW_DBG2
("M©chögÑeque°: %p,Üi°: %p\n", 
ªq
, 
ml°
);

427 
	`li°_f‹_óch_íåy
(
ruÀ
, 
ml°
, 
li°
) {

428 i‡(
	`do_evÆ
(
ªq
, 
ruÀ
))

429  
ruÀ
;

432  
NULL
;

433 
	}
}

434 
EXPORT_SYMBOL
(
tfw_hâp_m©ch_ªq
);

439 
TfwHâpChaö
 *

440 
	$tfw_hâp_chaö_add
(c⁄° *
«me
, 
TfwHâpTabÀ
 *
èbÀ
)

442 
TfwHâpChaö
 *
chaö
;

443 
«me_sz
 = 
«me
 ? (
	`°æí
(name) + 1) : 0;

444 
size
 = (
TfwHâpChaö
Ë+ 
«me_sz
;

446 i‡(!(
chaö
 = 
	`tfw_poﬁ_Æloc
(
èbÀ
->
poﬁ
, 
size
))) {

447 
	`TFW_ERR
("Can'tállocate memory for HTTP chain\n");

448  
NULL
;

451 
	`mem£t
(
chaö
, 0, 
size
);

452 
	`INIT_LIST_HEAD
(&
chaö
->
li°
);

453 
	`INIT_LIST_HEAD
(&
chaö
->
m¨k_li°
);

454 
	`INIT_LIST_HEAD
(&
chaö
->
m©ch_li°
);

455 
chaö
->
poﬁ
 = 
èbÀ
->pool;

457 i‡(
«me
) {

458 
chaö
->
«me
 = (*)(chain + 1);

459 
	`mem˝y
((*)
chaö
->
«me
, (*Íame, 
«me_sz
);

462 
	`li°_add
(&
chaö
->
li°
, &
èbÀ
->
hód
);

464  
chaö
;

465 
	}
}

466 
EXPORT_SYMBOL
(
tfw_hâp_chaö_add
);

472 
	$tfw_hâp_èbÀ_‰ì
(
TfwHâpTabÀ
 *
èbÀ
)

474 i‡(
èbÀ
)

475 
	`tfw_poﬁ_de°roy
(
èbÀ
->
poﬁ
);

476 
	}
}

477 
EXPORT_SYMBOL
(
tfw_hâp_èbÀ_‰ì
);

483 
TfwHâpM©chRuÀ
 *

484 
	$tfw_hâp_ruÀ_√w
(
TfwHâpChaö
 *
chaö
, 
tfw_hâp_m©ch_¨g_t
 
ty≥
,

485 
size_t
 
¨g_size
)

487 
TfwHâpM©chRuÀ
 *
ruÀ
;

488 
li°_hód
 *
hód
;

489 
size_t
 
size
 = (
ty≥
 =
TFW_HTTP_MATCH_A_STR
)

490 ? 
	`TFW_HTTP_MATCH_RULE_SIZE
(
¨g_size
)

491 : (
TfwHâpM©chRuÀ
);

493 
	`BUG_ON
(!
chaö
 || !chaö->
poﬁ
);

494 i‡(!(
ruÀ
 = 
	`tfw_poﬁ_Æloc
(
chaö
->
poﬁ
, 
size
))) {

495 
	`TFW_ERR_NL
("Can'tállocateáÑule for http chain: %p\n",

496 
chaö
->
«me
);

497  
NULL
;

500 
hód
 = (
ty≥
 =
TFW_HTTP_MATCH_A_NUM
)

501 ? &
chaö
->
m¨k_li°


502 : &
chaö
->
m©ch_li°
;

503 
	`mem£t
(
ruÀ
, 0, 
size
);

504 
	`INIT_LIST_HEAD
(&
ruÀ
->
li°
);

505 
	`li°_add_èû
(&
ruÀ
->
li°
, 
hód
);

507  
ruÀ
;

508 
	}
}

509 
EXPORT_SYMBOL
(
tfw_hâp_ruÀ_√w
);

512 
	$tfw_hâp_ruÀ_öô
(
TfwHâpM©chRuÀ
 *
ruÀ
, 
tfw_hâp_m©ch_Êd_t
 
fõld
,

513 
tfw_hâp_m©ch_›_t
 
›
, 
tfw_hâp_m©ch_¨g_t
 
ty≥
,

514 c⁄° *
¨g
, 
size_t
 
¨g_Àn
)

516 
ruÀ
->
fõld
 = field;

517 
ruÀ
->
›
 = op;

518 
ruÀ
->
¨g
.
ty≥
 =Åype;

520 i‡(
ty≥
 =
TFW_HTTP_MATCH_A_WILDCARD
)

523 i‡(
ty≥
 =
TFW_HTTP_MATCH_A_NUM
) {

524 i‡(
	`tfw_cfg_∑r£_uöt
(
¨g
, &
ruÀ
->¨g.
num
)) {

525 
	`TFW_ERR_NL
("http_match: invalid 'mark' condition:"

526 " '%s'\n", 
¨g
);

527  -
EINVAL
;

529 
ruÀ
->
›
 = 
TFW_HTTP_MATCH_O_EQ
;

533 i‡(
ty≥
 =
TFW_HTTP_MATCH_A_METHOD
) {

534 i‡(
	`tfw_hâp_tbl_mëhod
(
¨g
, &
ruÀ
->¨g.
mëhod
)) {

535 
	`TFW_ERR_NL
("http_tbl: invalid 'method' condition:"

536 " '%s'\n", 
¨g
);

537  -
EINVAL
;

539 
ruÀ
->
›
 = 
TFW_HTTP_MATCH_O_EQ
;

543 
ruÀ
->
¨g
.
Àn
 = 
¨g_Àn
;

544 
	`mem˝y
(
ruÀ
->
¨g
.
°r
,árg, 
¨g_Àn
);

545 i‡(
fõld
 =
TFW_HTTP_MATCH_F_HDR_RAW
) {

546 *
p
 = 
ruÀ
->
¨g
.
°r
;

547 (*
p
 = 
	`tﬁowî
(*p)))

548 
p
++;

552 
	}
}

553 
EXPORT_SYMBOL
(
tfw_hâp_ruÀ_öô
);

556 
	$tfw_hâp_¨g_adju°
(c⁄° *
¨g
, 
size_t
 
Àn
, size_à*
size_out
,

557 
tfw_hâp_m©ch_›_t
 *
›_out
)

559 
boﬁ
 
esˇ≥d
;

560 *
¨g_out
, *
pos
;

561 
i
;

563 i‡(!(
¨g_out
 = 
	`kzÆloc
(
Àn
 + 1, 
GFP_KERNEL
))) {

564 
	`TFW_ERR_NL
("HTTPÅables: unableÅoállocateÑule"

566  
NULL
;

569 *
›_out
 = 
TFW_HTTP_MATCH_O_EQ
;

570 i‡(
Àn
 > 1 && 
¨g
[len - 1] == '*' &&árg[len - 2] != '\\')

571 *
›_out
 = 
TFW_HTTP_MATCH_O_PREFIX
;

573 i‡(
¨g
[0] == '*') {

574 i‡(*
›_out
 =
TFW_HTTP_MATCH_O_PREFIX
)

575 
	`TFW_WARN_NL
("HTTPÅables: unableÅo match"

577 "ÖªfixÖ©ã∫ i†≠∂õd\n", 
¨g
);

579 *
›_out
 = 
TFW_HTTP_MATCH_O_SUFFIX
;

582 
Àn
 = 0;

583 
esˇ≥d
 = 
Ál£
;

584 
pos
 = 
¨g_out
;

585 
i
 = 0; 
¨g
[i]; ++i) {

586 i‡(
¨g
[
i
] ='*' && !
esˇ≥d
 && (i == 0 || !arg[i + 1]))

588 i‡(
¨g
[
i
] !'\\' || 
esˇ≥d
) {

589 
esˇ≥d
 = 
Ál£
;

590 *
pos
 = 
¨g
[
i
];

591 ++
Àn
;

592 ++
pos
;

594 i‡(
¨g
[
i
] == '\\') {

595 
esˇ≥d
 = 
åue
;

598 *
size_out
 = 
Àn
 + 1;

600  
¨g_out
;

601 
	}
}

602 
EXPORT_SYMBOL
(
tfw_hâp_¨g_adju°
);

	@http_match.h

21 #i‚de‡
__TFW_HTTP_MATCH_H__


22 
	#__TFW_HTTP_MATCH_H__


	)

24 
	~<löux/li°.h
>

26 
	~"addr.h
"

27 
	~"hâp.h
"

28 
	~"hâp_tbl.h
"

31 
	mTFW_HTTP_MATCH_F_NA
 = 0,

32 
	mTFW_HTTP_MATCH_F_WILDCARD
,

33 
	mTFW_HTTP_MATCH_F_HDR_CONN
,

34 
	mTFW_HTTP_MATCH_F_HDR_HOST
,

35 
	mTFW_HTTP_MATCH_F_HDR_CTYPE
,

36 
	mTFW_HTTP_MATCH_F_HDR_UAGENT
,

37 
	mTFW_HTTP_MATCH_F_HDR_COOKIE
,

38 
	mTFW_HTTP_MATCH_F_HDR_REFERER
,

39 
	mTFW_HTTP_MATCH_F_HDR_NMATCH
,

40 
	mTFW_HTTP_MATCH_F_HDR_XFRWD
,

41 
	mTFW_HTTP_MATCH_F_HDR_RAW
,

42 
	mTFW_HTTP_MATCH_F_HOST
,

43 
	mTFW_HTTP_MATCH_F_METHOD
,

44 
	mTFW_HTTP_MATCH_F_URI
,

45 
	mTFW_HTTP_MATCH_F_MARK
,

46 
	m_TFW_HTTP_MATCH_F_COUNT


47 } 
	ttfw_hâp_m©ch_Êd_t
;

50 
	mTFW_HTTP_MATCH_O_NA
 = 0,

51 
	mTFW_HTTP_MATCH_O_WILDCARD
,

52 
	mTFW_HTTP_MATCH_O_EQ
,

53 
	mTFW_HTTP_MATCH_O_PREFIX
,

54 
	mTFW_HTTP_MATCH_O_SUFFIX
,

55 
	m_TFW_HTTP_MATCH_O_COUNT


56 } 
	ttfw_hâp_m©ch_›_t
;

58 
tfw_hâp_m©ch_›_t
 
	ttfw_m©ch_t
;

61 
	mTFW_HTTP_MATCH_A_NA
 = 0,

62 
	mTFW_HTTP_MATCH_A_WILDCARD
,

63 
	mTFW_HTTP_MATCH_A_ADDR
,

64 
	mTFW_HTTP_MATCH_A_METHOD
,

65 
	mTFW_HTTP_MATCH_A_NUM
,

66 
	mTFW_HTTP_MATCH_A_STR
,

67 
	m_TFW_HTTP_MATCH_A_COUNT


68 } 
	ttfw_hâp_m©ch_¨g_t
;

71 
	mTFW_HTTP_MATCH_ACT_NA
 = 0,

72 
	mTFW_HTTP_MATCH_ACT_CHAIN
,

73 
	mTFW_HTTP_MATCH_ACT_VHOST
,

74 
	mTFW_HTTP_MATCH_ACT_MARK
,

75 
	mTFW_HTTP_MATCH_ACT_BLOCK
,

76 
	m_TFW_HTTP_MATCH_ACT_COUNT


77 } 
	ttfw_hâp_ruÀ_a˘_t
;

80 
tfw_hâp_m©ch_¨g_t
 
	mty≥
;

81 
	mÀn
;

83 
tfw_hâp_mëh_t
 
	mmëhod
;

84 
	mnum
;

85 
TfwAddr
 
	maddr
;

86 
	m°r
[0];

88 } 
	tTfwHâpM©chArg
;

91 
tfw_hâp_ruÀ_a˘_t
 
	mty≥
;

93 
TfwHâpChaö
 *
	mchaö
;

94 
TfwVho°
 *
	mvho°
;

95 
	mm¨k
;

97 } 
	tTfwHâpA˘i⁄
;

100 
li°_hód
 
	mli°
;

101 
tfw_hâp_m©ch_Êd_t
 
	mfõld
;

102 
tfw_hâp_m©ch_›_t
 
	m›
;

103 
TfwHâpA˘i⁄
 
	ma˘
;

104 
	möv
;

105 
TfwHâpM©chArg
 
	m¨g
;

107 } 
	tTfwHâpM©chRuÀ
;

109 
	#TFW_HTTP_MATCH_MAX_ARG_LEN
 (1<<16)

	)

114 
	#TFW_HTTP_MATCH_RULE_SIZE
(
¨g_Àn
) \

115 (
	`off£tof
(
TfwHâpM©chRuÀ
, 
¨g
.
°r
Ë+ 
¨g_Àn
)

	)

117 
TfwHâpChaö
 *
tfw_hâp_chaö_add
(c⁄° *
«me
, 
TfwHâpTabÀ
 *
èbÀ
);

118 
tfw_hâp_èbÀ_‰ì
(
TfwHâpTabÀ
 *
èbÀ
);

124 
TfwHâpM©chRuÀ
 *
tfw_hâp_m©ch_ªq
(c⁄° 
TfwHâpReq
 *
ªq
,

125 
li°_hód
 *
ml°
);

130 
TfwHâpM©chRuÀ
 *
tfw_hâp_ruÀ_√w
(
TfwHâpChaö
 *
chaö
,

131 
tfw_hâp_m©ch_¨g_t
 
ty≥
,

132 
size_t
 
¨g_Àn
);

134 
tfw_hâp_ruÀ_öô
(
TfwHâpM©chRuÀ
 *
ruÀ
, 
tfw_hâp_m©ch_Êd_t
 
fõld
,

135 
tfw_hâp_m©ch_›_t
 
›
, 
tfw_hâp_m©ch_¨g_t
 
ty≥
,

136 c⁄° *
¨g
, 
size_t
 
¨g_Àn
 );

138 c⁄° *
tfw_hâp_¨g_adju°
(c⁄° *
¨g
, 
size_t
 
Àn
, size_à*
size_out
,

139 
tfw_hâp_m©ch_›_t
 *
›_out
);

141 
	#tfw_hâp_chaö_ruÀs_f‹_óch
(
chaö
, 
func
) \

143 
r
 = 0; \

144 
TfwHâpM©chRuÀ
 *
ruÀ
; \

145 i‡(
chaö
) { \

146 
	`li°_f‹_óch_íåy
(
ruÀ
, &(
chaö
)->
m©ch_li°
, 
li°
) \

147 
r
 |
	`func
(
ruÀ
); \

148 
	`li°_f‹_óch_íåy
(
ruÀ
, &(
chaö
)->
m¨k_li°
, 
li°
) \

149 
r
 |
	`func
(
ruÀ
); \

151 
r
; \

152 })

	)

	@http_msg.c

23 
	~<löux/˘y≥.h
>

25 #i‚de‡
DBG_HTTP_PARSER


26 #unde‡
DEBUG


28 
	~"lib/°r.h
"

29 
	~"gfsm.h
"

30 
	~"hâp_msg.h
"

31 
	~"ss_skb.h
"

38 
TfwSå
 *

39 
	$tfw_hâp_msg_make_hdr
(
TfwPoﬁ
 *
poﬁ
, c⁄° *
«me
, c⁄° *
vÆ
)

41 
size_t
 
n_Àn
 = 
	`°æí
(
«me
);

42 
size_t
 
v_Àn
 = 
vÆ
 ? 
	`°æí
(val) : 0;

43 c⁄° 
TfwSå
 
tmp_hdr
 = {

44 .
±r
 = (
TfwSå
 []){

45 { .
±r
 = (*)
«me
, .
Àn
 = 
n_Àn
 },

46 { .
±r
 = 
S_DLM
, .
Àn
 = 
	`SLEN
(S_DLM) },

47 { .
±r
 = (*)
vÆ
, .
Àn
 = 
v_Àn
 },

49 .
Àn
 = 
n_Àn
 + 
	`SLEN
(
S_DLM
Ë+ 
v_Àn
,

50 .
eﬁí
 = 2,

51 .
Êags
 = (
vÆ
 ? 3 : 2Ë<< 
TFW_STR_CN_SHIFT


54  
	`tfw_°rdup
(
poﬁ
, &
tmp_hdr
);

55 
	}
}

62 
	$__tfw_hâp_msg_föd_hdr
(c⁄° 
TfwSå
 *
hdr
, c⁄° *
¨øy
, 
size_t
 
n
,

63 
size_t
 
membî_sz
)

65 
size_t
 
°¨t
 = 0, 
íd
 = 
n
;

66 
ªsu…
, 
fc
;

67 c⁄° 
TfwSå
 *
h
;

69 i‡(!
	`TFW_STR_DUP
(
hdr
))

70 
h
 = 
hdr
;

72 
h
 = (
TfwSå
 *)
hdr
->
±r
;

73 
fc
 = 
	`tﬁowî
(*(*)(
	`TFW_STR_CHUNK
(
h
, 0)->
±r
));

75 
°¨t
 < 
íd
) {

76 
size_t
 
mid
 = 
°¨t
 + (
íd
 - start) / 2;

77 c⁄° 
TfwSå
 *
sh
 = 
¨øy
 + 
mid
 * 
membî_sz
;

78 
sc
 = *(*)
sh
->
±r
;

80 
ªsu…
 = 
fc
 - 
sc
;

81 i‡(!
ªsu…
)

82 
ªsu…
 = 
	`tfw_°ricmp•n
(
h
, 
sh
, ':');

84 i‡(
ªsu…
 < 0)

85 
íd
 = 
mid
;

86 i‡(
ªsu…
 > 0)

87 
°¨t
 = 
mid
 + 1;

89  
sh
;

92  
NULL
;

93 
	}
}

94 
EXPORT_SYMBOL
(
__tfw_hâp_msg_föd_hdr
);

97 
TfwSå
 
	mhdr
;

98 
	mid
;

99 } 
	tTfwHdrDef
;

100 
	#TfwSåDefV
(
v
, 
id
Ë{{ (v), 
NULL
, (vË- 1, 0 }, (idË}

	)

102 
ölöe
 

103 
	$__tfw_hâp_msg_•ec_hid
(c⁄° 
TfwSå
 *
hdr
, c⁄° 
TfwHdrDef
 
¨øy
[])

105 c⁄° 
TfwHdrDef
 *
def
;

107 
def
 = (
TfwHdrDef
 *)
	`__tfw_hâp_msg_föd_hdr
(
hdr
, 
¨øy
, 
TFW_HTTP_HDR_RAW
,

108 (
TfwHdrDef
));

110  
def
 ? def->
id
 : 
TFW_HTTP_HDR_RAW
;

111 
	}
}

117 
	$tfw_hâp_msg_ª•_•ec_hid
(c⁄° 
TfwSå
 *
hdr
)

119 c⁄° 
TfwHdrDef
 
ª•_hdrs
[] = {

120 
	`TfwSåDefV
("c⁄√˘i⁄:", 
TFW_HTTP_HDR_CONNECTION
),

121 
	`TfwSåDefV
("c⁄ã¡-Àngth:", 
TFW_HTTP_HDR_CONTENT_LENGTH
),

122 
	`TfwSåDefV
("c⁄ã¡-ty≥:", 
TFW_HTTP_HDR_CONTENT_TYPE
),

123 
	`TfwSåDefV
("cookõ:", 
TFW_HTTP_HDR_COOKIE
),

124 
	`TfwSåDefV
("ëag:", 
TFW_HTTP_HDR_ETAG
),

125 
	`TfwSåDefV
("ho°:", 
TFW_HTTP_HDR_HOST
),

126 
	`TfwSåDefV
("kìp-Æive:", 
TFW_HTTP_HDR_KEEP_ALIVE
),

127 
	`TfwSåDefV
("ª„ªr:", 
TFW_HTTP_HDR_REFERER
),

128 
	`TfwSåDefV
("£rvî:", 
TFW_HTTP_HDR_SERVER
),

129 
	`TfwSåDefV
("å™s„r-ícodög:",
TFW_HTTP_HDR_TRANSFER_ENCODING
),

130 
	`TfwSåDefV
("x-f‹w¨ded-f‹:", 
TFW_HTTP_HDR_X_FORWARDED_FOR
),

133 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
ª•_hdrs
Ë!
TFW_HTTP_HDR_RAW
);

135  
	`__tfw_hâp_msg_•ec_hid
(
hdr
, 
ª•_hdrs
);

136 
	}
}

142 
	$tfw_hâp_msg_ªq_•ec_hid
(c⁄° 
TfwSå
 *
hdr
)

144 c⁄° 
TfwHdrDef
 
ªq_hdrs
[] = {

145 
	`TfwSåDefV
("c⁄√˘i⁄:", 
TFW_HTTP_HDR_CONNECTION
),

146 
	`TfwSåDefV
("c⁄ã¡-Àngth:", 
TFW_HTTP_HDR_CONTENT_LENGTH
),

147 
	`TfwSåDefV
("c⁄ã¡-ty≥:", 
TFW_HTTP_HDR_CONTENT_TYPE
),

148 
	`TfwSåDefV
("cookõ:", 
TFW_HTTP_HDR_COOKIE
),

149 
	`TfwSåDefV
("ho°:", 
TFW_HTTP_HDR_HOST
),

150 
	`TfwSåDefV
("if-n⁄e-m©ch:", 
TFW_HTTP_HDR_IF_NONE_MATCH
),

151 
	`TfwSåDefV
("kìp-Æive:", 
TFW_HTTP_HDR_KEEP_ALIVE
),

152 
	`TfwSåDefV
("ª„ªr:", 
TFW_HTTP_HDR_REFERER
),

153 
	`TfwSåDefV
("å™s„r-ícodög:",
TFW_HTTP_HDR_TRANSFER_ENCODING
),

154 
	`TfwSåDefV
("u£r-agít:", 
TFW_HTTP_HDR_USER_AGENT
),

155 
	`TfwSåDefV
("x-f‹w¨ded-f‹:", 
TFW_HTTP_HDR_X_FORWARDED_FOR
),

158 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
ªq_hdrs
Ë!
TFW_HTTP_HDR_RAW
);

160  
	`__tfw_hâp_msg_•ec_hid
(
hdr
, 
ªq_hdrs
);

161 
	}
}

168 
	$__hâp_msg_hdr_vÆ
(
TfwSå
 *
hdr
, 
id
, TfwSå *
vÆ
, 
boﬁ
 
˛õ¡
)

170 c⁄° 
size_t
 
hdr_Àns
[] = {

171 [
TFW_HTTP_HDR_HOST
] = 
	`SLEN
("Host:"),

172 [
TFW_HTTP_HDR_CONTENT_LENGTH
] = 
	`SLEN
("Content-Length:"),

173 [
TFW_HTTP_HDR_CONTENT_TYPE
] = 
	`SLEN
("Content-Type:"),

174 [
TFW_HTTP_HDR_CONNECTION
] = 
	`SLEN
("Connection:"),

175 [
TFW_HTTP_HDR_X_FORWARDED_FOR
] = 
	`SLEN
("X-Forwarded-For:"),

176 [
TFW_HTTP_HDR_KEEP_ALIVE
] = 
	`SLEN
("Keep-Alive:"),

177 [
TFW_HTTP_HDR_TRANSFER_ENCODING
] = 
	`SLEN
("Transfer-Encoding:"),

178 [
TFW_HTTP_HDR_SERVER
] = 
	`SLEN
("Server:"),

179 [
TFW_HTTP_HDR_COOKIE
] = 
	`SLEN
("Cookie:"),

180 [
TFW_HTTP_HDR_ETAG
] = 
	`SLEN
("ETag:"),

181 [
TFW_HTTP_HDR_REFERER
] = 
	`SLEN
("Referer:"),

184 
TfwSå
 *
c
, *
íd
;

185 
∆í
;

187 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
hdr_Àns
Ë!
TFW_HTTP_HDR_RAW
);

189 i‡(
	`u∆ikñy
(
	`TFW_STR_PLAIN
(
hdr
))) {

190 
	`TFW_STR_INIT
(
vÆ
);

193 
	`BUG_ON
(
	`TFW_STR_DUP
(
hdr
));

194 
	`BUG_ON
(
id
 >
TFW_HTTP_HDR_RAW
);

196 i‡(
	`u∆ikñy
(
id
 =
TFW_HTTP_HDR_SERVER
 && 
˛õ¡
))

197 
∆í
 = 
	`SLEN
("User-Agent:");

198 i‡(
	`u∆ikñy
(
id
 =
TFW_HTTP_HDR_ETAG
 && 
˛õ¡
))

199 
∆í
 = 
	`SLEN
("If-None-Match:");

201 
∆í
 = 
hdr_Àns
[
id
];

208 
	`BUG_ON
(
id
 =
TFW_HTTP_HDR_HOST
 ? 
∆í
 > 
hdr
->
Àn
 :Çlen >= hdr->len);

210 *
vÆ
 = *
hdr
;

218 
c
 = 
hdr
->
±r
, 
íd
 = (
TfwSå
 *)hdr->±∏+ 
	`TFW_STR_CHUNKN
(hdr);

219 
c
 < 
íd
; ++c)

221 
	`BUG_ON
(!
c
->
Àn
);

223 i‡(
∆í
 > 0) {

224 
∆í
 -
c
->
Àn
;

225 
vÆ
->
Àn
 -
c
->len;

227 i‡(
	`u∆ikñy
(((*)
c
->
±r
)[0] == ' '

228 || ((*)
c
->
±r
)[0] == '\t'))

236 
vÆ
->
Àn
 -
c
->len;

239 
vÆ
->
±r
 = 
c
;

242 
	`BUG_ON
(
	`TFW_STR_CHUNKN
(
vÆ
) < 1);

243 
	`TFW_STR_CHUNKN_SUB
(
vÆ
, 1);

247 
	`TFW_STR_INIT
(
vÆ
);

248 
	}
}

249 
EXPORT_SYMBOL
(
__hâp_msg_hdr_vÆ
);

257 
ölöe
 
boﬁ


258 
	$__hdr_is_söguœr
(c⁄° 
TfwSå
 *
hdr
)

260 c⁄° 
TfwSå
 
hdr_söguœr
[] = {

261 
	#TfwSå_°rög
(
v
Ë{ (v), 
NULL
, (vË- 1, 0 }

	)

262 
	`TfwSå_°rög
("authorization:"),

263 
	`TfwSå_°rög
("from:"),

264 
	`TfwSå_°rög
("if-unmodified-since:"),

265 
	`TfwSå_°rög
("location:"),

266 
	`TfwSå_°rög
("max-forwards:"),

267 
	`TfwSå_°rög
("proxy-authorization:"),

268 
	`TfwSå_°rög
("referer:"),

269 #unde‡
TfwSå_°rög


272  
	`tfw_hâp_msg_föd_hdr
(
hdr
, 
hdr_söguœr
);

273 
	}
}

282 
	$tfw_hâp_msg_hdr_lookup
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
)

284 
id
;

285 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

287 
id
 = 
TFW_HTTP_HDR_RAW
; id < 
ht
->
off
; ++id) {

288 
TfwSå
 *
h
 = &
ht
->
tbl
[
id
];

290 i‡(
h
->
Êags
 & 
TFW_STR_DUPLICATE
)

291 
h
 = 
	`TFW_STR_CHUNK
(h, 0);

292 i‡(!
	`tfw_°ricmp•n
(
hdr
, 
h
, ':'))

296  
id
;

297 
	}
}

304 
ölöe
 

305 
	$__hdr_lookup
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
)

307 
id
 = 
	`tfw_hâp_msg_hdr_lookup
(
hm
, 
hdr
);

309 i‡((
id
 < 
hm
->
h_tbl
->
off
Ë&& 
	`__hdr_is_söguœr
(
hdr
))

310 
hm
->
Êags
 |
TFW_HTTP_F_FIELD_DUPENTRY
;

312  
id
;

313 
	}
}

319 
	$tfw_hâp_msg_hdr_›í
(
TfwHâpMsg
 *
hm
, *
hdr_°¨t
)

321 
TfwSå
 *
hdr
 = &
hm
->
∑r£r
.hdr;

323 
	`BUG_ON
(!
	`TFW_STR_EMPTY
(
hdr
));

325 
hdr
->
±r
 = 
hdr_°¨t
;

326 
hdr
->
skb
 = 
	`ss_skb_≥ek_èû
(&
hm
->
msg
.
skb_hód
);

328 
	`BUG_ON
(!
hdr
->
skb
);

330 
	`TFW_DBG3
("open headerát %p (char=[%c]), skb=%p\n",

331 
hdr_°¨t
, *hdr_°¨t, 
hdr
->
skb
);

332 
	}
}

339 
	$tfw_hâp_msg_hdr_˛o£
(
TfwHâpMsg
 *
hm
, 
id
)

341 
TfwSå
 *
h
;

342 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

344 
	`BUG_ON
(
hm
->
∑r£r
.
hdr
.
Êags
 & 
TFW_STR_DUPLICATE
);

345 
	`BUG_ON
(
id
 > 
TFW_HTTP_HDR_RAW
);

348 
hm
->
∑r£r
.
hdr
.
Êags
 |
TFW_STR_COMPLETE
;

351 i‡(
	`likñy
(
id
 < 
TFW_HTTP_HDR_RAW
)) {

352 
h
 = &
ht
->
tbl
[
id
];

353 i‡(
	`TFW_STR_EMPTY
(
h
))

355 
d⁄e
;

364 
	`BUG_ON
(
id
 < 
TFW_HTTP_HDR_NONSINGULAR
);

369 
hm
->
Êags
 |
TFW_HTTP_F_FIELD_DUPENTRY
;

370 
du∂iˇã
;

379 
id
 = 
	`__hdr_lookup
(
hm
, &hm->
∑r£r
.
hdr
);

382 i‡(
	`u∆ikñy
(
id
 =
ht
->
size
)) {

383 i‡(
	`tfw_hâp_msg_grow_hdr_tbl
(
hm
))

384  
TFW_BLOCK
;

386 
ht
 = 
hm
->
h_tbl
;

389 
h
 = &
ht
->
tbl
[
id
];

391 i‡(
	`TFW_STR_EMPTY
(
h
))

393 
d⁄e
;

395 
du∂iˇã
:

396 
h
 = 
	`tfw_°r_add_du∂iˇã
(
hm
->
poﬁ
, h);

397 i‡(
	`u∆ikñy
(!
h
)) {

398 
	`TFW_WARN
("C™nŸ clo£ hódî %∞id=%d\n", &
hm
->
∑r£r
.
hdr
, 
id
);

399  
TFW_BLOCK
;

402 
d⁄e
:

403 *
h
 = 
hm
->
∑r£r
.
hdr
;

405 
	`TFW_STR_INIT
(&
hm
->
∑r£r
.
hdr
);

406 
	`TFW_DBG3
("store header w/Ötr=%pÜen=%luÉolen=%u flags=%x id=%d\n",

407 
h
->
±r
, h->
Àn
, h->
eﬁí
, h->
Êags
, 
id
);

410 i‡(
id
 =
ht
->
off
)

411 
ht
->
off
++;

413  
TFW_PASS
;

414 
	}
}

430 
	$__tfw_hâp_msg_add_°r_d©a
(
TfwHâpMsg
 *
hm
, 
TfwSå
 *
°r
, *
d©a
,

431 
size_t
 
Àn
, 
sk_buff
 *
skb
)

433 
	`BUG_ON
(
°r
->
Êags
 & (
TFW_STR_DUPLICATE
 | 
TFW_STR_COMPLETE
));

435 
	`TFW_DBG3
("store field chunkÜen=%lu data=%p(%c) field=<%#x,%lu,%p>\n",

436 
Àn
, 
d©a
, 
	`i•röt
(*(*)data) ? *(*)data : '.',

437 
°r
->
Êags
, så->
Àn
, så->
±r
);

439 i‡(
	`TFW_STR_EMPTY
(
°r
)) {

440 i‡(!
°r
->
±r
)

441 
	`__tfw_hâp_msg_£t_°r_d©a
(
°r
, 
d©a
, 
skb
);

442 
°r
->
Àn
 = 
d©a
 +Üí - så->
±r
;

443 
	`BUG_ON
(!
°r
->
Àn
);

445 i‡(
	`likñy
(
Àn
)) {

446 
TfwSå
 *
¢
 = 
	`tfw_°r_add_compound
(
hm
->
poﬁ
, 
°r
);

447 i‡(!
¢
) {

448 
	`TFW_WARN
("Cannot grow HTTP data string\n");

449  -
ENOMEM
;

451 
	`__tfw_hâp_msg_£t_°r_d©a
(
¢
, 
d©a
, 
skb
);

452 
	`tfw_°r_updÀn
(
°r
, 
d©a
 + 
Àn
);

456 
	}
}

459 
	$tfw_hâp_msg_grow_hdr_tbl
(
TfwHâpMsg
 *
hm
)

461 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

462 
size_t
 
‹dî
 = 
ht
->
size
 / 
TFW_HTTP_HDR_NUM
, 
√w_‹dî
 = order << 1;

464 
ht
 = 
	`tfw_poﬁ_ªÆloc
(
hm
->
poﬁ
, ht, 
	`TFW_HHTBL_SZ
(
‹dî
),

465 
	`TFW_HHTBL_SZ
(
√w_‹dî
));

466 i‡(!
ht
)

467  -
ENOMEM
;

468 
ht
->
size
 = 
	`__HHTBL_SZ
(
√w_‹dî
);

469 
ht
->
off
 = 
hm
->
h_tbl
->off;

470 
	`bzîo_Á°
(
ht
->
tbl
 + 
	`__HHTBL_SZ
(
‹dî
),

471 
	`__HHTBL_SZ
(
‹dî
Ë* (
TfwSå
));

472 
hm
->
h_tbl
 = 
ht
;

474 
	`TFW_DBG3
("grow hâ∞hódî†èbÀÅÿ%d iãms\n", 
ht
->
size
);

477 
	}
}

483 
	$__hdr_add
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
, 
hid
)

485 
r
;

486 
TfwSå
 
ô
 = {};

487 
TfwSå
 *
h
 = 
	`TFW_STR_CHUNK
(&
hm
->
¸lf
, 0);

489 
r
 = 
	`ss_skb_gë_room
(
hm
->
msg
.
skb_hód
, hm->
¸lf
.
skb
, 
h
->
±r
,

490 
	`tfw_°r_tŸÆ_Àn
(
hdr
), &
ô
);

491 i‡(
r
)

492  
r
;

494 
	`tfw_°r_fixup_eﬁ
(&
ô
, 
	`tfw_°r_eﬁí
(
hdr
));

495 i‡(
	`tfw_°r˝y
(&
ô
, 
hdr
))

496  
TFW_BLOCK
;

504 
hm
->
h_tbl
->
tbl
[
hid
] = 
ô
;

507 
	}
}

516 
	$__hdr_ex∑nd
(
TfwHâpMsg
 *
hm
, 
TfwSå
 *
‹ig_hdr
, c⁄° TfwSå *
hdr
, 
boﬁ
 
≠≥nd
)

518 
r
;

519 
TfwSå
 *
h
, 
ô
 = {};

521 i‡(
	`TFW_STR_DUP
(
‹ig_hdr
))

522 
‹ig_hdr
 = 
	`__TFW_STR_CH
(orig_hdr, 0);

523 
	`BUG_ON
(!
≠≥nd
 && (
hdr
->
Àn
 < 
‹ig_hdr
->len));

525 
h
 = 
	`TFW_STR_LAST
(
‹ig_hdr
);

526 
r
 = 
	`ss_skb_gë_room
(
hm
->
msg
.
skb_hód
, 
h
->
skb
, (*)h->
±r
 + h->
Àn
,

527 
≠≥nd
 ? 
hdr
->
Àn
 : hdr->À¿- 
‹ig_hdr
->Àn, &
ô
);

528 i‡(
r
)

529  
r
;

531 i‡(
	`tfw_°rˇt
(
hm
->
poﬁ
, 
‹ig_hdr
, &
ô
)) {

532 
	`TFW_WARN
("Cannot concatenate hdr %.*s with %.*s\n",

533 
	`PR_TFW_STR
(
‹ig_hdr
), PR_TFW_STR(
hdr
));

534  
TFW_BLOCK
;

537  
	`tfw_°r˝y
(
≠≥nd
 ? &
ô
 : 
‹ig_hdr
, 
hdr
Ë? 
TFW_BLOCK
 : 0;

538 
	}
}

544 
	$__hdr_dñ
(
TfwHâpMsg
 *
hm
, 
hid
)

546 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

547 
TfwSå
 *
dup
, *
íd
, *
hdr
 = &
ht
->
tbl
[
hid
];

550 
	`TFW_STR_FOR_EACH_DUP
(
dup
, 
hdr
, 
íd
) {

551 i‡(
	`ss_skb_cutoff_d©a
(
hm
->
msg
.
skb_hód
, 
dup
, 0,

552 
	`tfw_°r_eﬁí
(
dup
)))

553  
TFW_BLOCK
;

557 i‡(
hid
 < 
TFW_HTTP_HDR_RAW
) {

558 
	`TFW_STR_INIT
(&
ht
->
tbl
[
hid
]);

560 i‡(
hid
 < 
ht
->
off
 - 1)

561 
	`memmove
(&
ht
->
tbl
[
hid
], &ht->tbl[hid + 1],

562 (
ht
->
off
 - 
hid
 - 1Ë* (
TfwSå
));

563 --
ht
->
off
;

567 
	}
}

580 
	$__hdr_sub
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
, 
hid
)

582 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

583 
TfwSå
 *
d°
, *
tmp
, *
íd
, *
‹ig_hdr
 = &
ht
->
tbl
[
hid
];

585 
	`TFW_STR_FOR_EACH_DUP
(
d°
, 
‹ig_hdr
, 
íd
) {

586 i‡(
d°
->
Àn
 < 
hdr
->len)

593 i‡(
d°
->
Àn
 !
hdr
->len

594 && 
	`ss_skb_cutoff_d©a
(
hm
->
msg
.
skb_hód
, 
d°
, 
hdr
->
Àn
, 0))

595  
TFW_BLOCK
;

596 i‡(
	`tfw_°r˝y
(
d°
, 
hdr
))

597  
TFW_BLOCK
;

598 
˛ónup
;

601 i‡(
	`__hdr_ex∑nd
(
hm
, 
‹ig_hdr
, 
hdr
, 
Ál£
))

602  
TFW_BLOCK
;

603 
d°
 = 
	`TFW_STR_DUP
(
‹ig_hdr
Ë? 
	`__TFW_STR_CH
(orig_hdr, 0) : orig_hdr;

605 
˛ónup
:

606 
	`TFW_STR_FOR_EACH_DUP
(
tmp
, 
‹ig_hdr
, 
íd
) {

607 i‡(
tmp
 !
d°


608 && 
	`ss_skb_cutoff_d©a
(
hm
->
msg
.
skb_hód
, 
tmp
, 0,

609 
	`tfw_°r_eﬁí
(
tmp
)))

610  
TFW_BLOCK
;

613 *
‹ig_hdr
 = *
d°
;

614  
TFW_PASS
;

615 
	}
}

634 
	$tfw_hâp_msg_hdr_x‰m_°r
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
, 
hid
,

635 
boﬁ
 
≠≥nd
)

637 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

638 
TfwSå
 *
‹ig_hdr
 = 
NULL
;

639 c⁄° 
TfwSå
 *
s_vÆ
 = 
	`TFW_STR_CHUNK
(
hdr
, 2);

641 i‡(
	`u∆ikñy
(!
ht
)) {

642 
	`TFW_WARN
("TryÅoádjustÜightweightÑesponse.");

643  -
EINVAL
;

647 i‡(
hid
 < 
TFW_HTTP_HDR_RAW
) {

648 
‹ig_hdr
 = &
ht
->
tbl
[
hid
];

649 i‡(
	`TFW_STR_EMPTY
(
‹ig_hdr
Ë&& !
s_vÆ
)

653 
hid
 = 
	`__hdr_lookup
(
hm
, 
hdr
);

654 i‡(
hid
 =
ht
->
off
 && !
s_vÆ
)

657 i‡(
hid
 =
ht
->
size
)

658 i‡(
	`tfw_hâp_msg_grow_hdr_tbl
(
hm
))

659  -
ENOMEM
;

660 i‡(
hid
 =
ht
->
off
)

661 ++
ht
->
off
;

663 
‹ig_hdr
 = &
ht
->
tbl
[
hid
];

666 i‡(
	`u∆ikñy
(
≠≥nd
 && 
hid
 < 
TFW_HTTP_HDR_NONSINGULAR
)) {

667 
	`TFW_WARN
("AµídögÅÿn⁄söguœ∏hódî %d\n", 
hid
);

668  -
ENOENT
;

671 i‡(!
‹ig_hdr
 || 
	`TFW_STR_EMPTY
(orig_hdr)) {

672 i‡(
	`u∆ikñy
(!
s_vÆ
))

674  
	`__hdr_add
(
hm
, 
hdr
, 
hid
);

677 i‡(!
s_vÆ
)

678  
	`__hdr_dñ
(
hm
, 
hid
);

680 i‡(
≠≥nd
) {

681 
TfwSå
 
hdr_≠p
 = {

682 .
±r
 = (
TfwSå
 []){

683 { .
±r
 = ", ", .
Àn
 = 2 },

684 { .
±r
 = 
s_vÆ
->±r, .
Àn
 = s_val->len }

686 .
Àn
 = 
s_vÆ
->len + 2,

687 .
Êags
 = 2 << 
TFW_STR_CN_SHIFT


689  
	`__hdr_ex∑nd
(
hm
, 
‹ig_hdr
, &
hdr_≠p
, 
åue
);

692  
	`__hdr_sub
(
hm
, 
hdr
, 
hid
);

693 
	}
}

699 
	$tfw_hâp_msg_hdr_x‰m
(
TfwHâpMsg
 *
hm
, *
«me
, 
size_t
 
n_Àn
,

700 *
vÆ
, 
size_t
 
v_Àn
, 
hid
, 
boﬁ
 
≠≥nd
)

702 
TfwSå
 
√w_hdr
 = {

703 .
±r
 = (
TfwSå
 []){

704 { .
±r
 = 
«me
, .
Àn
 = 
n_Àn
 },

705 { .
±r
 = 
S_DLM
, .
Àn
 = 
	`SLEN
(S_DLM) },

706 { .
±r
 = 
vÆ
, .
Àn
 = 
v_Àn
 },

708 .
Àn
 = 
n_Àn
 + 
	`SLEN
(
S_DLM
Ë+ 
v_Àn
,

709 .
eﬁí
 = 2,

710 .
Êags
 = (
vÆ
 ? 3 : 2Ë<< 
TFW_STR_CN_SHIFT


713 
	`BUG_ON
(!
vÆ
 && 
v_Àn
);

715  
	`tfw_hâp_msg_hdr_x‰m_°r
(
hm
, &
√w_hdr
, 
hid
, 
≠≥nd
);

716 
	}
}

725 
	$tfw_hâp_msg_dñ_hbh_hdrs
(
TfwHâpMsg
 *
hm
)

727 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

728 
hid
 = 
ht
->
off
;

729 
r
 = 0;

732 
hid
--;

733 i‡(
hid
 =
TFW_HTTP_HDR_CONNECTION
)

735 i‡(
ht
->
tbl
[
hid
].
Êags
 & 
TFW_STR_HBH_HDR
)

736 i‡((
r
 = 
	`__hdr_dñ
(
hm
, 
hid
)))

737  
r
;

738 } 
hid
);

741 
	}
}

747 
	$tfw_hâp_msg_hdr_add
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
)

749 
hid
;

750 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

752 
hid
 = 
ht
->
off
;

753 i‡(
hid
 =
ht
->
size
)

754 i‡(
	`tfw_hâp_msg_grow_hdr_tbl
(
hm
))

755  -
ENOMEM
;

756 ++
ht
->
off
;

758  
	`__hdr_add
(
hm
, 
hdr
, 
hid
);

759 
	}
}

780 
	$tfw_hâp_msg_£tup
(
TfwHâpMsg
 *
hm
, 
TfwMsgIãr
 *
ô
, 
size_t
 
d©a_Àn
)

782 
r
;

784 i‡((
r
 = 
	`tfw_msg_ôî_£tup
(
ô
, &
hm
->
msg
.
skb_hód
, 
d©a_Àn
)))

785  
r
;

786 
	`TFW_DBG2
("Së u∞HTTP mesßgê%pK wôh %lu byã†d©a\n", 
hm
, 
d©a_Àn
);

789 
	}
}

790 
EXPORT_SYMBOL
(
tfw_hâp_msg_£tup
);

793 
	$__hâp_msg_add_d©a_‰ag
(
TfwMsgIãr
 *
ô
, 
TfwHâpMsg
 *
hm
, 
TfwSå
 *
fõld
,

794 c⁄° 
TfwSå
 *
d©a
, 
off
)

796 *
p
;

797 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
ô
->
skb
)->
‰ags
[it->frag];

798 
f_size
, 
d_size
, 
f_room
, 
n_c›y
;

800 
√xt_‰ag
:

801 i‡(!
‰ag
)

802  -
E2BIG
;

804 
d_size
 = 
d©a
->
Àn
 - 
off
;

805 
f_size
 = 
	`skb_‰ag_size
(
‰ag
);

806 
f_room
 = 
PAGE_SIZE
 - 
‰ag
->
∑ge_off£t
 - 
f_size
;

807 
n_c›y
 = 
	`mö
(
d_size
, 
f_room
);

808 i‡(!
n_c›y
)

811 
p
 = (*)
	`skb_‰ag_addªss
(
‰ag
Ë+ 
f_size
;

812 
	`mem˝y_Á°
(
p
, (*)
d©a
->
±r
 + 
off
, 
n_c›y
);

813 
	`skb_‰ag_size_add
(
‰ag
, 
n_c›y
);

814 
	`ss_skb_adju°_d©a_Àn
(
ô
->
skb
, 
n_c›y
);

816 i‡(
	`__tfw_hâp_msg_add_°r_d©a
(
hm
, 
fõld
, 
p
, 
n_c›y
, 
ô
->
skb
))

817  -
ENOMEM
;

819 i‡(
d_size
 > 
f_room
) {

820 
‰ag
 = 
	`ss_skb_‰ag_√xt
(&
ô
->
skb
, it->
skb_hód
, &it->frag);

821 
off
 +
n_c›y
;

822 
√xt_‰ag
;

826 
	}
}

835 
	$tfw_hâp_msg_add_d©a
(
TfwMsgIãr
 *
ô
, 
TfwHâpMsg
 *
hm
, 
TfwSå
 *
fõld
,

836 c⁄° 
TfwSå
 *
d©a
)

838 *
p
;

839 
n_c›y
;

841 
	`WARN_ON_ONCE
(
	`TFW_STR_DUP
(
d©a
));

842 
	`WARN_ON_ONCE
(!
	`TFW_STR_PLAIN
(
d©a
));

844 
n_c›y
 = 
	`mö
(
d©a
->
Àn
, ()
	`skb_èûroom
(
ô
->
skb
));

845 i‡(!
n_c›y
)

848 i‡(
ô
->
‰ag
 >= 0)

849 
add_‰ag
;

851 
p
 = 
	`skb_put
(
ô
->
skb
, 
n_c›y
);

852 
	`mem˝y_Á°
(
p
, (*)
d©a
->
±r
, 
n_c›y
);

854 i‡(
	`__tfw_hâp_msg_add_°r_d©a
(
hm
, 
fõld
, 
p
, 
n_c›y
, 
ô
->
skb
))

855  -
ENOMEM
;

857 i‡(
d©a
->
Àn
 =
n_c›y
) {

858 i‡(!
	`skb_èûroom
(
ô
->
skb
))

859 
ô
->
‰ag
 = 0;

863 
add_‰ag
:

864 
ô
->
‰ag
 = 0;

865  
	`__hâp_msg_add_d©a_‰ag
(
ô
, 
hm
, 
fõld
, 
d©a
, 
n_c›y
);

866 
	}
}

869 
	$tfw_hâp_msg_∑ú
(
TfwHâpRe•
 *
ª•
, 
TfwHâpReq
 *
ªq
)

871 i‡(
	`u∆ikñy
(
ª•
->
∑ú
 || 
ªq
->pair))

872 
	`TFW_WARN
("Response-RequestÖairing is broken!\n");

874 
ª•
->
ªq
 =Ñeq;

875 
ªq
->
ª•
 =Ñesp;

876 
	}
}

879 
	$tfw_hâp_msg_u≈aú
(
TfwHâpMsg
 *
msg
)

881 i‡(!
msg
->
∑ú
)

884 
msg
->
∑ú
->∑ú = 
NULL
;

885 
msg
->
∑ú
 = 
NULL
;

886 
	}
}

889 
	$tfw_hâp_msg_‰ì
(
TfwHâpMsg
 *
m
)

891 
	`TFW_DBG3
("Fªêmsg=%p\n", 
m
);

892 i‡(!
m
)

895 
	`tfw_hâp_msg_u≈aú
(
m
);

896 
	`ss_skb_queue_purge
(&
m
->
msg
.
skb_hód
);

898 i‡(
m
->
de°ru˘‹
)

899 
m
->
	`de°ru˘‹
(m);

900 
	`tfw_poﬁ_de°roy
(
m
->
poﬁ
);

901 
	}
}

902 
EXPORT_SYMBOL
(
tfw_hâp_msg_‰ì
);

910 
TfwHâpMsg
 *

911 
	$__tfw_hâp_msg_Æloc
(
ty≥
, 
boﬁ
 
fuŒ
)

913 
TfwHâpMsg
 *
hm
 = (
ty≥
 & 
C⁄n_C t
)

914 ? (
TfwHâpMsg
 *)
	`tfw_poﬁ_√w
(
TfwHâpReq
,

915 
TFW_POOL_ZERO
)

916 : (
TfwHâpMsg
 *)
	`tfw_poﬁ_√w
(
TfwHâpRe•
,

917 
TFW_POOL_ZERO
);

918 i‡(!
hm
) {

919 
	`TFW_WARN
("Insufficient memoryÅo create %s message\n",

920 ((
ty≥
 & 
C⁄n_C t
) ? "request" : "response"));

921  
NULL
;

924 
	`BUILD_BUG_ON
(
	`FIELD_SIZEOF
(
TfwHâpMsg
, 
Êags
Ë* 
BITS_PER_BYTE


925 < 
_TFW_HTTP_FLAGS_NUM
);

927 i‡(
fuŒ
) {

928 
hm
->
h_tbl
 = (
TfwHâpHdrTbl
 *)
	`tfw_poﬁ_Æloc
(hm->
poﬁ
,

929 
	`TFW_HHTBL_SZ
(1));

930 i‡(
	`u∆ikñy
(!
hm
->
h_tbl
)) {

931 
	`TFW_WARN
("Insufficient memoryÅo create headerÅable"

933 ((
ty≥
 & 
C⁄n_C t
) ? "request" : "response"));

934 
	`tfw_poﬁ_de°roy
(
hm
->
poﬁ
);

935  
NULL
;

937 
hm
->
h_tbl
->
size
 = 
	`__HHTBL_SZ
(1);

938 
hm
->
h_tbl
->
off
 = 
TFW_HTTP_HDR_RAW
;

939 
	`bzîo_Á°
(
hm
->
h_tbl
->
tbl
, 
	`__HHTBL_SZ
(1Ë* (
TfwSå
));

941 i‡(
ty≥
 & 
C⁄n_C t
)

942 
	`tfw_hâp_öô_∑r£r_ªq
((
TfwHâpReq
 *)
hm
);

944 
	`tfw_hâp_öô_∑r£r_ª•
((
TfwHâpRe•
 *)
hm
);

947 
hm
->
msg
.
skb_hód
 = 
NULL
;

949 i‡(
ty≥
 & 
C⁄n_C t
) {

950 
	`INIT_LIST_HEAD
(&
hm
->
msg
.
£q_li°
);

951 
	`INIT_LIST_HEAD
(&((
TfwHâpReq
 *)
hm
)->
fwd_li°
);

952 
	`INIT_LIST_HEAD
(&((
TfwHâpReq
 *)
hm
)->
nù_li°
);

953 
hm
->
de°ru˘‹
 = 
tfw_hâp_ªq_de°ru˘
;

956  
hm
;

957 
	}
}

	@http_msg.h

21 #i‚de‡
__TFW_HTTP_MSG_H__


22 
	#__TFW_HTTP_MSG_H__


	)

24 
	~"hâp.h
"

26 
	#S_F_SET_COOKIE
 "Së-Cookõ: "

	)

27 
	#S_CRLF
 "\r\n"

	)

28 
	#S_DLM
 ": "

	)

30 
	#SLEN
(
s
Ë((sË- 1)

	)

32 
TfwSå
 *
tfw_hâp_msg_make_hdr
(
TfwPoﬁ
 *
poﬁ
, c⁄° *
«me
, c⁄° *
vÆ
);

33 
tfw_hâp_msg_ª•_•ec_hid
(c⁄° 
TfwSå
 *
hdr
);

34 
tfw_hâp_msg_ªq_•ec_hid
(c⁄° 
TfwSå
 *
hdr
);

36 c⁄° *
__tfw_hâp_msg_föd_hdr
(c⁄° 
TfwSå
 *
hdr
, c⁄° *
¨øy
,

37 
size_t
 
n
, size_à
membî_sz
);

38 
	#tfw_hâp_msg_föd_hdr
(
hdr
, 
¨øy
) \

39 (
TfwSå
 *)
	`__tfw_hâp_msg_föd_hdr
(
hdr
, 
¨øy
, \

40 
	`ARRAY_SIZE
(
¨øy
), (
TfwSå
))

	)

42 
ölöe
 

43 
	$__tfw_hâp_msg_£t_°r_d©a
(
TfwSå
 *
°r
, *
d©a
, 
sk_buff
 *
skb
)

45 
°r
->
±r
 = 
d©a
;

46 
°r
->
skb
 = skb;

47 
	}
}

48 
	#tfw_hâp_msg_£t_°r_d©a
(
hm
, 
°r
, 
d©a
) \

49 
	`__tfw_hâp_msg_£t_°r_d©a
(
°r
, 
d©a
, \

50 
	`ss_skb_≥ek_èû
(&
hm
->
msg
.
skb_hód
))

	)

52 
__hâp_msg_hdr_vÆ
(
TfwSå
 *
hdr
, 
id
, TfwSå *
vÆ
, 
boﬁ
 
˛õ¡
);

54 
ölöe
 

55 
	$tfw_hâp_msg_˛¡hdr_vÆ
(
TfwSå
 *
hdr
, 
id
, TfwSå *
vÆ
)

57 
	`__hâp_msg_hdr_vÆ
(
hdr
, 
id
, 
vÆ
, 
åue
);

58 
	}
}

60 
ölöe
 

61 
	$tfw_hâp_msg_§vhdr_vÆ
(
TfwSå
 *
hdr
, 
id
, TfwSå *
vÆ
)

63 
	`__hâp_msg_hdr_vÆ
(
hdr
, 
id
, 
vÆ
, 
Ál£
);

64 
	}
}

66 
tfw_hâp_msg_∑ú
(
TfwHâpRe•
 *
ª•
, 
TfwHâpReq
 *
ªq
);

67 
TfwHâpMsg
 *
__tfw_hâp_msg_Æloc
(
ty≥
, 
boﬁ
 
fuŒ
);

69 
ölöe
 
TfwHâpReq
 *

70 
	$tfw_hâp_msg_Æloc_ªq_light
()

72  (
TfwHâpReq
 *)
	`__tfw_hâp_msg_Æloc
(
C⁄n_C t
, 
Ál£
);

73 
	}
}

75 
ölöe
 
TfwHâpRe•
 *

76 
	$__tfw_hâp_msg_Æloc_ª•
(
TfwHâpReq
 *
ªq
, 
boﬁ
 
fuŒ
)

78 
TfwHâpRe•
 *
ª•
 = (TfwHâpRe• *)
	`__tfw_hâp_msg_Æloc
(
C⁄n_Srv
, 
fuŒ
);

79 i‡(
ª•
)

80 
	`tfw_hâp_msg_∑ú
(
ª•
, 
ªq
);

82  
ª•
;

83 
	}
}

85 
ölöe
 
TfwHâpRe•
 *

86 
	$tfw_hâp_msg_Æloc_ª•
(
TfwHâpReq
 *
ªq
)

88  
	`__tfw_hâp_msg_Æloc_ª•
(
ªq
, 
åue
);

89 
	}
}

91 
ölöe
 
TfwHâpRe•
 *

92 
	$tfw_hâp_msg_Æloc_ª•_light
(
TfwHâpReq
 *
ªq
)

94  
	`__tfw_hâp_msg_Æloc_ª•
(
ªq
, 
Ál£
);

95 
	}
}

97 
__tfw_hâp_msg_add_°r_d©a
(
TfwHâpMsg
 *
hm
, 
TfwSå
 *
°r
, *
d©a
,

98 
size_t
 
Àn
, 
sk_buff
 *
skb
);

99 
	#tfw_hâp_msg_add_°r_d©a
(
hm
, 
°r
, 
d©a
, 
Àn
) \

100 
	`__tfw_hâp_msg_add_°r_d©a
(
hm
, 
°r
, 
d©a
, 
Àn
, \

101 
	`ss_skb_≥ek_èû
(&
hm
->
msg
.
skb_hód
))

	)

103 
tfw_hâp_msg_hdr_lookup
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
);

104 
tfw_hâp_msg_hdr_add
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
);

105 
tfw_hâp_msg_hdr_x‰m_°r
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
hdr
,

106 
hid
, 
boﬁ
 
≠≥nd
);

107 
tfw_hâp_msg_hdr_x‰m
(
TfwHâpMsg
 *
hm
, *
«me
, 
size_t
 
n_Àn
,

108 *
vÆ
, 
size_t
 
v_Àn
, 
hid
, 
boﬁ
 
≠≥nd
);

110 
	#TFW_HTTP_MSG_HDR_XFRM
(
hm
, 
«me
, 
vÆ
, 
hid
, 
≠≥nd
) \

111 
	`tfw_hâp_msg_hdr_x‰m
(
hm
, 
«me
, “ameË- 1, 
vÆ
, \

112 (
vÆ
Ë- 1, 
hid
, 
≠≥nd
)

	)

113 
	#TFW_HTTP_MSG_HDR_DEL
(
hm
, 
«me
, 
hid
) \

114 
	`tfw_hâp_msg_hdr_x‰m
(
hm
, 
«me
, “ameË- 1, 
NULL
, 0, 
hid
, 0)

	)

116 
tfw_hâp_msg_dñ_hbh_hdrs
(
TfwHâpMsg
 *
hm
);

118 
tfw_hâp_msg_£tup
(
TfwHâpMsg
 *
hm
, 
TfwMsgIãr
 *
ô
, 
size_t
 
d©a_Àn
);

119 
tfw_hâp_msg_add_d©a
(
TfwMsgIãr
 *
ô
, 
TfwHâpMsg
 *
hm
, 
TfwSå
 *
fõld
,

120 c⁄° 
TfwSå
 *
d©a
);

122 
tfw_hâp_msg_hdr_›í
(
TfwHâpMsg
 *
hm
, *
hdr_°¨t
);

123 
tfw_hâp_msg_hdr_˛o£
(
TfwHâpMsg
 *
hm
, 
id
);

124 
tfw_hâp_msg_grow_hdr_tbl
(
TfwHâpMsg
 *
hm
);

125 
tfw_hâp_msg_‰ì
(
TfwHâpMsg
 *
m
);

	@http_norm.h

31 #i‚de‡
__TFW_HTTP_NORM_H__


32 
	#__TFW_HTTP_NORM_H__


	)

35 #ifde‡
TFW_HTTP_NORMALIZATION


41 #ifde‡
TFW_HTTP_NORM_URI


43 
	$TFW_HTTP_STATE
(
Req_UriN‹m
) {

45 
	}
}

50 #ifde‡
TFW_HTTP_NORM_POST


52 
	$TFW_HTTP_STATE
(
Req_Po°N‹m
) {

54 
	}
}

59 #ifde‡
TFW_HTTP_NORM_RESP


61 
	$TFW_HTTP_STATE
(
Re•_BodyN‹m
) {

63 
	}
}

	@http_parser.c

21 
	~<löux/˘y≥.h
>

22 
	~<löux/kî√l.h
>

24 #i‚de‡
DBG_HTTP_PARSER


25 #unde‡
DEBUG


27 
	~"gfsm.h
"

28 
	~"hâp_msg.h
"

29 
	~"hty≥.h
"

39 
	mRGí_OWS
 = 10000,

41 
	mRGí_EoL
,

42 
	mRGí_CR
,

43 
	mRGí_CRLFCR
,

45 
	mRGí_Hdr
,

46 
	mRGí_HdrOthî
,

47 
	mRGí_HdrOthîN
,

48 
	mRGí_HdrOthîV
,

50 
	mRGí_BodyInô
,

51 
	mRGí_BodySèπ
,

52 
	mRGí_BodyChunk
,

53 
	mRGí_BodyChunkLí
,

54 
	mRGí_BodyChunkExt
,

55 
	mRGí_BodyRódChunk
,

56 
	mRGí_BodyEoL
,

57 
	mRGí_BodyCR
,

64 
	#__d©a_off
(
pos
Ë(
size_t
)(’osË- 
d©a
)

	)

65 
	#__d©a_ªmaö
(
pos
Ë(
Àn
 - 
	`__d©a_off
’os))

	)

66 
	#__d©a_avaûabÀ
(
pos
, 
num
Ë“um <
	`__d©a_ªmaö
’os))

	)

75 
	#__msg_fõld_›í
(
fõld
, 
pos
) \

76 
	`tfw_hâp_msg_£t_°r_d©a
(
msg
, 
fõld
, 
pos
)

	)

78 
	#__msg_fõld_fixup
(
fõld
, 
pos
) \

79 
	`tfw_hâp_msg_add_°r_d©a
(
msg
, 
fõld
, 
d©a
, 
	`__d©a_off
(
pos
))

	)

81 
	#__msg_fõld_föish
(
fõld
, 
pos
) \

83 
	`__msg_fõld_fixup
(
fõld
, 
pos
); \

84 (
fõld
)->
Êags
 |
TFW_STR_COMPLETE
; \

85 } 0)

	)

87 
	#__msg_hdr_chunk_fixup
(
d©a
, 
Àn
) \

88 
	`tfw_hâp_msg_add_°r_d©a
(
msg
, &msg->
∑r£r
.
hdr
, 
d©a
, 
Àn
)

	)

96 
	#__FSM_DECLARE_VARS
(
±r
) \

97 
TfwHâpMsg
 *
msg
 = (TfwHâpMsg *)(
±r
); \

98 
TfwHâpP¨£r
 *
∑r£r
 = &
msg
->parser; \

99 *
p
 = 
d©a
; \

100 
c
 = *
p
; \

101 
__fsm_c⁄°_°©e
; \

102 
__maybe_unu£d
 
__fsm_n
; \

103 
size_t
 
__maybe_unu£d
 
__fsm_sz
; \

104 
TfwSå
 
__maybe_unu£d
 *
chunk
 = &
∑r£r
->
_tmp_chunk
; \

105 

	)

106 
	#TFW_PARSER_BLOCK
(
°
) \

108 
	`TFW_WARN
("ParserÉrror: state=" #st " input=%#x('%.*s')" \

110 ()
c
, 
	`mö
(16U, ()(
d©a
 + 
Àn
 - 
p
)),Ö, \

111 
Àn
, 
p
 - 
d©a
); \

112  
TFW_BLOCK
; \

113 } 0)

	)

115 
	#__FSM_START
(
s
) \

116 
fsm_ªíãr
: 
	`__©åibuã__
((
unu£d
)) \

117 
	`TFW_DBG3
("íã∏FSMáà°©ê%d\n", 
s
); \

118 
s
)

	)

120 
	#__FSM_STATE
(
°
) \

121 
°
: \

122 
°
: 
	`__©åibuã__
((
unu£d
)) \

123 
__fsm_c⁄°_°©e
 = 
°
; \

124 
c
 = *
p
; \

125 
	`TFW_DBG3
("parser: " #st "(%d:%d): c=%#x(%c),Ö_off=%ld\n", \

126 
°
, 
∑r£r
->
_i_°
, 
c
, 
	`i•röt
(cË? c : '.', 
p
 - 
d©a
);

	)

128 
	#__FSM_EXIT
(
ªt
) \

130 
r
 = 
ªt
; \

131 
d⁄e
; \

132 } 0)

	)

134 
	#FSM_EXIT
(
ªt
) \

136 
p
 += 1; \

137 
	`__FSM_EXIT
(
ªt
); \

138 } 0)

	)

140 
	#__FSM_FINISH
(
m
) \

141 
d⁄e
: \

142 
∑r£r
->
°©e
 = 
__fsm_c⁄°_°©e
; \

144 *
∑r£d
 = 
	`__d©a_off
(
p
);

	)

146 
	#__FSM_MOVE_nofixup_n
(
to
, 
n
) \

148 
p
 +
n
; \

149 i‡(
	`u∆ikñy
(
	`__d©a_off
(
p
Ë>
Àn
)) { \

150 
__fsm_c⁄°_°©e
 = 
to
; \

151 
	`__FSM_EXIT
(
TFW_POSTPONE
); \

153 
to
; \

154 } 0)

	)

156 
	#__FSM_MOVE_nf
(
to
, 
n
, 
fõld
) \

158 
p
 +
n
; \

159 i‡(
	`u∆ikñy
(
	`__d©a_off
(
p
Ë>
Àn
)) { \

160 
__fsm_c⁄°_°©e
 = 
to
; \

162 
	`BUG_ON
(!(
fõld
)->
±r
); \

163 
	`__msg_fõld_fixup
(
fõld
, 
d©a
 + 
Àn
); \

164 
	`__FSM_EXIT
(
TFW_POSTPONE
); \

166 
to
; \

167 } 0)

	)

169 
	#__FSM_MOVE_nofixup
(
to
Ë
	`__FSM_MOVE_nofixup_n
—o, 1)

	)

170 
	#__FSM_MOVE_n
(
to
, 
n
Ë
	`__FSM_MOVE_nf
—o,Ç, &
msg
->
∑r£r
.
hdr
)

	)

171 
	#__FSM_MOVE_f
(
to
, 
fõld
Ë
	`__FSM_MOVE_nf
—o, 1, fõld)

	)

172 
	#__FSM_MOVE
(
to
Ë
	`__FSM_MOVE_nf
—o, 1, &
msg
->
∑r£r
.
hdr
)

	)

174 
	#__FSM_JMP
(
to
Ëdÿ{ to; } 0)

	)

176 
	#__FSM_MATCH_MOVE_f
(
Æphabë
, 
to
, 
fõld
) \

178 
__fsm_n
 = 
	`__d©a_ªmaö
(
p
); \

179 
__fsm_sz
 = 
tfw_m©ch_
##
	`Æphabë
(
p
, 
__fsm_n
); \

180 i‡(
	`u∆ikñy
(
__fsm_sz
 =
__fsm_n
)) { \

182 
	`BUG_ON
(!(
fõld
)->
±r
); \

183 
	`__msg_fõld_fixup
(
fõld
, 
d©a
 + 
Àn
); \

184 
__fsm_c⁄°_°©e
 = 
to
; \

185 
p
 +
__fsm_sz
; \

186 
	`__FSM_EXIT
(
TFW_POSTPONE
); \

188 } 0)

	)

190 
	#__FSM_MATCH_MOVE
(
Æphabë
, 
to
Ë
	`__FSM_MATCH_MOVE_f
(alphabet,Åo, \

191 &
msg
->
∑r£r
.
hdr
)

	)

193 
	#__FSM_MATCH_MOVE_nofixup
(
Æphabë
, 
to
) \

195 
__fsm_n
 = 
	`__d©a_ªmaö
(
p
); \

196 
__fsm_sz
 = 
tfw_m©ch_
##
	`Æphabë
(
p
, 
__fsm_n
); \

197 
p
 +
__fsm_sz
; \

198 i‡(
	`u∆ikñy
(
__fsm_sz
 =
__fsm_n
)) { \

199 
__fsm_c⁄°_°©e
 = 
to
; \

200 
	`__FSM_EXIT
(
TFW_POSTPONE
); \

202 } 0)

	)

210 
	#__FSM_I_chunk_Êags
(
Êag
) \

212 
	`TFW_DBG3
("∑r£r:ádd chunk fœgs: %u\n", 
Êag
); \

213 
	`TFW_STR_CURR
(&
msg
->
∑r£r
.
hdr
)->
Êags
 |
Êag
; \

214 } 0)

	)

216 
	#__FSM_I_MOVE_föish_n
(
to
, 
n
, 
föish
) \

218 
∑r£r
->
_i_°
 = 
to
; \

219 
p
 +
n
; \

220 i‡(
	`u∆ikñy
(
	`__d©a_off
(
p
Ë>
Àn
)) { \

221 
__fsm_c⁄°_°©e
 = 
to
; \

223 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
); \

224 
r
 = 
TFW_POSTPONE
; \

225 
föish
; \

226 
	`__FSM_EXIT
(
r
); \

228 
to
; \

229 } 0)

	)

231 
	#__FSM_I_MOVE_n
(
to
, 
n
Ë
	`__FSM_I_MOVE_föish_n
—o,Ç, {})

	)

232 
	#__FSM_I_MOVE
(
to
Ë
	`__FSM_I_MOVE_n
—o, 1)

	)

234 
	#__FSM_I_JMP
(
to
Ëdÿ{ to; } 0)

	)

236 
	#__FSM_I_MATCH_MOVE_föish
(
Æphabë
, 
to
, 
föish
) \

238 
__fsm_n
 = 
	`__d©a_ªmaö
(
p
); \

239 
__fsm_sz
 = 
tfw_m©ch_
##
	`Æphabë
(
p
, 
__fsm_n
); \

240 i‡(
	`u∆ikñy
(
__fsm_sz
 =
__fsm_n
)) { \

241 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
); \

242 
∑r£r
->
_i_°
 = 
to
; \

243 
__fsm_c⁄°_°©e
 = 
to
; \

244 
r
 = 
TFW_POSTPONE
; \

245 
föish
; \

246 
	`__FSM_EXIT
(
r
); \

248 } 0)

	)

250 
	#__FSM_I_MATCH_MOVE
(
Æphabë
, 
n
) \

251 
	`__FSM_I_MATCH_MOVE_föish
(
Æphabë
, 
n
, {})

	)

262 
	#__FSM_I_MOVE_fixup
(
to
, 
n
, 
Êag
) \

264 
	`__msg_hdr_chunk_fixup
(
p
, 
n
); \

265 
	`__FSM_I_chunk_Êags
(
Êag
); \

266 
∑r£r
->
_i_°
 = 
to
; \

267 
p
 +
n
; \

268 i‡(
	`u∆ikñy
(
	`__d©a_off
(
p
Ë>
Àn
)) { \

269 
__fsm_c⁄°_°©e
 = 
to
; \

270 
	`__FSM_EXIT
(
TFW_POSTPONE
); \

272 
to
; \

273 } 0)

	)

275 
	#__FSM_I_MATCH_MOVE_fixup
(
Æphabë
, 
to
, 
Êag
) \

277 
__fsm_n
 = 
	`__d©a_ªmaö
(
p
); \

278 
__fsm_sz
 = 
tfw_m©ch_
##
	`Æphabë
(
p
, 
__fsm_n
); \

279 i‡(
	`u∆ikñy
(
__fsm_sz
 =
__fsm_n
)) { \

280 
	`__msg_hdr_chunk_fixup
(
p
, 
__fsm_sz
); \

281 
	`__FSM_I_chunk_Êags
(
Êag
); \

282 
∑r£r
->
_i_°
 = 
to
; \

283 
__fsm_c⁄°_°©e
 = 
to
; \

284 
	`__FSM_EXIT
(
TFW_POSTPONE
); \

286 } 0)

	)

289 
	#__FSM_TX_COND
(
°
, 
c⁄dôi⁄
, 
°_√xt
, 
fõld
) \

290 
	`__FSM_STATE
(
°
) { \

291 i‡(
	`likñy
(
c⁄dôi⁄
)) \

292 
	`__FSM_MOVE_f
(
°_√xt
, 
fõld
); \

293 
	`TFW_PARSER_BLOCK
(
°
); \

294 }

	)

296 
	#__FSM_TX_COND_nofixup
(
°
, 
c⁄dôi⁄
, 
°_√xt
) \

297 
	`__FSM_STATE
(
°
) { \

298 i‡(
	`likñy
(
c⁄dôi⁄
)) \

299 
	`__FSM_MOVE_nofixup
(
°_√xt
); \

300 
	`TFW_PARSER_BLOCK
(
°
); \

301 }

	)

304 
	#__FSM_TX
(
°
, 
ch
, 
°_√xt
) \

305 
	`__FSM_TX_COND
(
°
, 
c
 =(
ch
), 
°_√xt
, 
NULL
)

	)

306 
	#__FSM_TX_f
(
°
, 
ch
, 
°_√xt
, 
fõld
) \

307 
	`__FSM_TX_COND
(
°
, 
c
 =(
ch
), 
°_√xt
, 
fõld
)

	)

308 
	#__FSM_TX_nofixup
(
°
, 
ch
, 
°_√xt
) \

309 
	`__FSM_TX_COND_nofixup
(
°
, 
c
 =(
ch
), 
°_√xt
)

	)

312 
	#__FSM_TX_LC
(
°
, 
ch
, 
°_√xt
) \

313 
	`__FSM_TX_COND
(
°
, 
	`TFW_LC
(
c
Ë=(
ch
), 
°_√xt
)

	)

314 
	#__FSM_TX_LC_nofixup
(
°
, 
ch
, 
°_√xt
) \

315 
	`__FSM_TX_COND_nofixup
(
°
, 
	`TFW_LC
(
c
Ë=(
ch
), 
°_√xt
)

	)

318 
	#__FSM_TX_AF
(
°
, 
ch
, 
°_√xt
, 
°_ÁŒback
) \

319 
	`__FSM_STATE
(
°
) { \

320 i‡(
	`likñy
(
	`TFW_LC
(
c
Ë=
ch
)) \

321 
	`__FSM_MOVE
(
°_√xt
); \

323 
	`__FSM_JMP
(
°_ÁŒback
); \

324 }

	)

327 
	#__FSM_TX_AF_OWS
(
°
, 
ch
, 
°_√xt
, 
°_ÁŒback
) \

328 
	`__FSM_STATE
(
°
) { \

329 i‡(
	`likñy
(
	`TFW_LC
(
c
Ë=
ch
)) { \

330 
∑r£r
->
_i_°
 = 
°_√xt
; \

331 
	`__FSM_MOVE
(
RGí_OWS
); \

334 
	`__FSM_JMP
(
°_ÁŒback
); \

335 }

	)

337 
	#__FSM_METH_MOVE
(
°
, 
ch
, 
°_√xt
) \

338 
	`__FSM_STATE
(
°
) { \

339 i‡(
	`likñy
(
c
 =(
ch
))) \

340 
	`__FSM_MOVE_nofixup
(
°_√xt
); \

341 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
); \

342 }

	)

344 
	#__FSM_METH_MOVE_föish
(
°
, 
ch
, 
m_ty≥
) \

345 
	`__FSM_STATE
(
°
) { \

346 i‡(
	`u∆ikñy
(
c
 !(
ch
))) \

347 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
); \

348 
ªq
->
mëhod
 = (
m_ty≥
); \

349 
	`__FSM_MOVE_nofixup
(
Req_MUS∑˚
); \

350 }

	)

356 
	#TFW_LC_INT
 0x20202020

	)

357 
	#TFW_LC_LONG
 0x2020202020202020UL

	)

358 
	#TFW_CHAR4_INT
(
a
, 
b
, 
c
, 
d
) \

359 ((
d
 << 24Ë| (
c
 << 16Ë| (
b
 << 8Ë| 
a
)

	)

360 
	#TFW_CHAR8_INT
(
a
, 
b
, 
c
, 
d
, 
e
, 
f
, 
g
, 
h
) \

361 ((()
h
 << 56Ë| (()
g
 << 48Ë| (()
f
 << 40) \

362 | (()
e
 << 32Ë| (
d
 << 24Ë| (
c
 << 16Ë| (
b
 << 8Ë| 
a
)

	)

363 
	#TFW_P2LCINT
(
p
Ë((*(*)’)Ë| 
TFW_LC_INT
)

	)

368 
	#C4_INT_LCM
(
p
, 
a
, 
b
, 
c
, 
d
) \

369 !((*(*)(
p
Ë| 
TFW_LC_INT
Ë^ 
	`TFW_CHAR4_INT
(
a
, 
b
, 
c
, 
d
))

	)

370 
	#C8_INT_LCM
(
p
, 
a
, 
b
, 
c
, 
d
, 
e
, 
f
, 
g
, 
h
) \

371 !((*(*)(
p
Ë| 
TFW_LC_LONG
) \

372 ^ 
	`TFW_CHAR8_INT
(
a
, 
b
, 
c
, 
d
, 
e
, 
f
, 
g
, 
h
))

	)

374 
	#IN_ALPHABET
(
c
, 
a
Ë◊[¯>> 6] & (1UL << (¯& 0x3f)))

	)

376 
	#CSTR_EQ
 0

	)

377 
	#CSTR_POSTPONE
 
TFW_POSTPONE


	)

378 
	#CSTR_NEQ
 
TFW_BLOCK


	)

379 
	#CSTR_BADLEN
 -3

	)

394 
	$__åy_°r
(
TfwSå
 *
hdr
, TfwSå* 
chunk
, *
p
, 
size_t
 
Àn
,

395 c⁄° *
°r
, 
size_t
 
°r_Àn
)

397 
size_t
 
off£t
 = 
chunk
->
Àn
;

399 i‡(
	`u∆ikñy
(
off£t
 > 
°r_Àn
 ||

400 (
	`TFW_LC
(*
p
Ë!TFW_LC(*(
°r
 + 
off£t
)))))

401  
CSTR_NEQ
;

403 
Àn
 = 
	`mö
÷í, 
°r_Àn
 - 
off£t
);

404 i‡(
	`tfw_c°ricmp_2lc
(
p
, 
°r
 + 
off£t
, 
Àn
) ||

405 (
chunk
->
Àn
 && !
	`tfw_°r_eq_c°r_pos
(
hdr
, chunk->
±r
, 
°r
,

406 
chunk
->
Àn
, 
TFW_STR_EQ_CASEI
)))

407  
CSTR_NEQ
;

409 
chunk
->
Àn
 +=Üen;

410  
Àn
;

411 
	}
}

418 
	$∑r£_öt_a
(*
d©a
, 
size_t
 
Àn
, c⁄° *
dñimôî_a
,

419 *
acc
)

421 *
p
;

423 
p
 = 
d©a
;Ö - d©®< 
Àn
; ++p) {

424 i‡(
	`u∆ikñy
(
	`IN_ALPHABET
(*
p
, 
dñimôî_a
)))

425  
p
 - 
d©a
;

426 i‡(
	`u∆ikñy
(!
	`isdigô
(*
p
)))

427  
CSTR_NEQ
;

428 i‡(
	`u∆ikñy
(*
acc
 > (
UINT_MAX
 - 10) / 10))

429  
CSTR_BADLEN
;

430 *
acc
 = *ac¯* 10 + *
p
 - '0';

433  
CSTR_POSTPONE
;

434 
	}
}

439 
ölöe
 

440 
	$∑r£_öt_ws
(*
d©a
, 
size_t
 
Àn
, *
acc
)

451 c⁄° 
whôe•a˚_a
[] 
____ˇchñöe_Æig√d
 = {

454  
	`∑r£_öt_a
(
d©a
, 
Àn
, 
whôe•a˚_a
, 
acc
);

455 
	}
}

460 
ölöe
 

461 
	$∑r£_öt_li°
(*
d©a
, 
size_t
 
Àn
, *
acc
)

473 c⁄° 
ws_comma_a
[] 
____ˇchñöe_Æig√d
 = {

476  
	`∑r£_öt_a
(
d©a
, 
Àn
, 
ws_comma_a
, 
acc
);

477 
	}
}

484 
	$∑r£_öt_hex
(*
d©a
, 
size_t
 
Àn
, *
acc
, *
˙t
)

486 *
p
;

488 
p
 = 
d©a
;Ö - d©®< 
Àn
; ++p) {

489 i‡(
	`u∆ikñy
(
	`IS_CRLF
(*
p
) || (*p == ';'))) {

490 i‡(
	`u∆ikñy
(*
acc
 > 
LONG_MAX
))

491  
CSTR_BADLEN
;

492  
p
 - 
d©a
;

494 i‡(
	`u∆ikñy
(!
	`isxdigô
(*
p
)))

495  
CSTR_NEQ
;

496 i‡(
	`u∆ikñy
(*
˙t
 >= (() * 2)))

497  
CSTR_BADLEN
;

498 *
acc
 = (*ac¯<< 4Ë+ (*
p
 & 0xf) + (*p >> 6) * 9;

499 ++*
˙t
;

502  
CSTR_POSTPONE
;

503 
	}
}

510 
	$m¨k_•ec_hbh
(
TfwHâpMsg
 *
hm
)

512 
TfwHâpHbhHdrs
 *
hbh_hdrs
 = &
hm
->
∑r£r
.
hbh_∑r£r
;

513 
id
;

515 
id
 = 0; id < 
TFW_HTTP_HDR_RAW
; ++id) {

516 
TfwSå
 *
hdr
 = &
hm
->
h_tbl
->
tbl
[
id
];

517 i‡((
hbh_hdrs
->
•ec
 & (0x1 << 
id
)Ë&& (!
	`TFW_STR_EMPTY
(
hdr
)))

518 
hdr
->
Êags
 |
TFW_STR_HBH_HDR
;

520 
	}
}

527 
	$m¨k_øw_hbh
(
TfwHâpMsg
 *
hm
, 
TfwSå
 *
hdr
)

529 
TfwHâpHbhHdrs
 *
hbh
 = &
hm
->
∑r£r
.
hbh_∑r£r
;

530 
i
;

541 
i
 = 0; i < 
hbh
->
off
; ++i) {

542 
TfwSå
 *
hbh_«me
 = &
hbh
->
øw
[
i
];

543 i‡((
hbh_«me
->
Êags
 & 
TFW_STR_HBH_HDR
)

544 && !(
	`tfw_°ricmp•n
(&
hbh
->
øw
[
i
], 
hdr
, ':')))

546 
hdr
->
Êags
 |
TFW_STR_HBH_HDR
;

547 
hbh_«me
->
Êags
 = hbh_name->flags &

548 ~()
TFW_STR_HBH_HDR
;

552 
	}
}

561 
boﬁ


562 
	$__m¨k_hbh_hdr
(
TfwHâpMsg
 *
hm
, 
TfwSå
 *
hdr
)

564 
TfwHâpHdrTbl
 *
ht
 = 
hm
->
h_tbl
;

565 
hid
 = 
	`tfw_hâp_msg_hdr_lookup
(
hm
, 
hdr
);

571 i‡((
hid
 >
ht
->
off
Ë|| (
	`TFW_STR_EMPTY
(&ht->
tbl
[hid])))

572  
Ál£
;

574 
ht
->
tbl
[
hid
].
Êags
 |
TFW_STR_HBH_HDR
;

575  
åue
;

576 
	}
}

593 
	$__hbh_∑r£r_add_d©a
(
TfwHâpMsg
 *
hm
, *
d©a
, 
Àn
, 
boﬁ
 
œ°
)

595 
TfwSå
 *
hdr
, *
≠≥nd
;

596 
TfwHâpHbhHdrs
 *
hbh
 = &
hm
->
∑r£r
.
hbh_∑r£r
;

597 c⁄° 
TfwSå
 
block
[] = {

598 
	#TfwSå_°rög
(
v
Ë{ (v), 
NULL
, (vË- 1, 0 }

	)

600 
	`TfwSå_°rög
("age:"),

601 
	`TfwSå_°rög
("authorization:"),

602 
	`TfwSå_°rög
("cache-control:"),

603 
	`TfwSå_°rög
("connection:"),

604 
	`TfwSå_°rög
("content-length:"),

605 
	`TfwSå_°rög
("content-type:"),

606 
	`TfwSå_°rög
("cookie:"),

607 
	`TfwSå_°rög
("date:"),

608 
	`TfwSå_°rög
("etag:"),

609 
	`TfwSå_°rög
("expires:"),

610 
	`TfwSå_°rög
("host:"),

611 
	`TfwSå_°rög
("pragma:"),

612 
	`TfwSå_°rög
("server:"),

613 
	`TfwSå_°rög
("transfer-encoding:"),

614 
	`TfwSå_°rög
("user-agent:"),

615 
	`TfwSå_°rög
("x-forwarded-for:"),

616 #unde‡
TfwSå_°rög


619 i‡(
hbh
->
off
 =
TFW_HBH_TOKENS_MAX
)

620  
CSTR_NEQ
;

621 
hdr
 = &
hbh
->
øw
[hbh->
off
];

623 i‡(!
	`TFW_STR_EMPTY
(
hdr
)) {

624 
≠≥nd
 = 
	`tfw_°r_add_compound
(
hm
->
poﬁ
, 
hdr
);

627 
≠≥nd
 = (
TfwSå
 *)
	`tfw_poﬁ_Æloc
(
hm
->
poﬁ
, (TfwStr));

628 
hdr
->
±r
 = 
≠≥nd
;

629 
	`__TFW_STR_CHUNKN_SET
(
hdr
, 1);

631 i‡(!
≠≥nd
)

632  -
ENOMEM
;

633 
≠≥nd
->
Àn
 =Üen;

634 
≠≥nd
->
±r
 = 
d©a
;

635 
hdr
->
Àn
 +=Üen;

637 i‡(
œ°
) {

638 
TfwSå
 
s_cﬁ⁄
 = { .
±r
 = ":", .
Àn
 = 1 };

639 
≠≥nd
 = 
	`tfw_°r_add_compound
(
hm
->
poﬁ
, 
hdr
);

640 i‡(!
≠≥nd
)

641  -
ENOMEM
;

642 *
≠≥nd
 = 
s_cﬁ⁄
;

643 
hdr
->
Àn
 +
s_cﬁ⁄
.len;

644 ++
hbh
->
off
;

646 i‡(
	`tfw_hâp_msg_föd_hdr
(
hdr
, 
block
))

647  
CSTR_NEQ
;

652 i‡(!
	`__m¨k_hbh_hdr
(
hm
, 
hdr
))

653 
hdr
->
Êags
 |
TFW_STR_HBH_HDR
;

657 
	}
}

661 
	mI_0
,

663 
	mI_C⁄n
,

664 
	mI_C⁄nOthî
,

665 
	mI_C⁄tLí
,

666 
	mI_C⁄tTy≥
,

667 
	mI_KìpAlive
,

668 
	mI_KìpAliveTO
,

669 
	mI_KìpAliveExt
,

670 
	mI_TønsEncod
,

671 
	mI_TønsEncodChunked
,

672 
	mI_TønsEncodOthî
,

674 
	mI_Eèg
,

675 
	mI_Eèg_W
,

676 
	mI_Eèg_We
,

677 
	mI_Eèg_Wók
,

678 
	mI_Eèg_VÆ
,

680 
	mI_D©e
,

681 
	mI_D©eDay
,

682 
	mI_D©eM⁄thSP
,

683 
	mI_D©eM⁄th
,

684 
	mI_D©eM⁄th_A
,

685 
	mI_D©eM⁄th_J
,

686 
	mI_D©eM⁄th_M
,

687 
	mI_D©eM⁄th_Othî
,

688 
	mI_D©eYórSP
,

689 
	mI_D©eYór
,

690 
	mI_D©eHourSP
,

691 
	mI_D©eHour
,

692 
	mI_D©eMöC 
,

693 
	mI_D©eMö
,

694 
	mI_D©eSecC 
,

695 
	mI_D©eSec
,

696 
	mI_D©eSecSP
,

697 
	mI_D©eZ⁄e
,

699 
	mI_EoT
,

700 
	mI_EoL
,

704 
	#TRY_STR_INIT
() \

705 
	`TFW_STR_INIT
(
chunk
)

	)

711 
	#TRY_STR_LAMBDA_föish
(
°r
, 
œmbda
, 
föish
, 
°©e
) \

712 i‡(!
chunk
->
±r
) \

713 
chunk
->
±r
 = 
p
; \

714 
__fsm_n
 = 
	`__åy_°r
(&
∑r£r
->
hdr
, 
chunk
, 
p
, 
	`__d©a_ªmaö
(p), \

715 
°r
, (str) - 1); \

716 i‡(
__fsm_n
 > 0) { \

717 i‡(
chunk
->
Àn
 =((
°r
) - 1)) { \

718 
œmbda
; \

719 
	`TRY_STR_INIT
(); \

720 
	`__FSM_I_MOVE_n
(
°©e
, 
__fsm_n
); \

722 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
); \

723 
föish
; \

724  
CSTR_POSTPONE
; \

725 }

	)

727 
	#TRY_STR_LAMBDA
(
°r
, 
œmbda
, 
°©e
) \

728 
	`TRY_STR_LAMBDA_föish
(
°r
, 
œmbda
, { }, 
°©e
)

	)

730 
	#TRY_STR
(
°r
, 
°©e
) \

731 
	`TRY_STR_LAMBDA
(
°r
, { }, 
°©e
)

	)

740 
	#RGEN_EOL
() \

741 
	`__FSM_STATE
(
RGí_EoL
) { \

742 i‡(
c
 == '\r') \

743 
	`__FSM_MOVE_nofixup
(
RGí_CR
); \

744 i‡(
c
 == '\n') { \

745 i‡(
∑r£r
->
hdr
.
±r
) { \

746 
	`tfw_°r_£t_eﬁí
(&
∑r£r
->
hdr
, 1); \

747 i‡(
	`tfw_hâp_msg_hdr_˛o£
(
msg
, 
∑r£r
->
_hdr_èg
)) \

748 
	`TFW_PARSER_BLOCK
(
RGí_EoL
); \

750 
	`__FSM_MOVE_nofixup
(
RGí_Hdr
); \

752 
	`TFW_PARSER_BLOCK
(
RGí_EoL
); \

754 
	`__FSM_STATE
(
RGí_CR
) { \

755 i‡(
	`u∆ikñy
(
c
 != '\n')) \

756 
	`TFW_PARSER_BLOCK
(
RGí_CR
); \

757 i‡(
∑r£r
->
hdr
.
±r
) { \

758 
	`tfw_°r_£t_eﬁí
(&
∑r£r
->
hdr
, 2); \

759 i‡(
	`tfw_hâp_msg_hdr_˛o£
(
msg
, 
∑r£r
->
_hdr_èg
)) \

760 
	`TFW_PARSER_BLOCK
(
RGí_CR
); \

763 
	`__FSM_MOVE_nofixup
(
RGí_Hdr
); \

764 }

	)

771 
	#TFW_HTTP_PARSE_CRLF
() \

773 i‡(
	`u∆ikñy
(
c
 == '\r')) { \

774 i‡(
msg
->
¸lf
.
Êags
 & 
TFW_STR_COMPLETE
) \

775 
	`__FSM_MOVE_nofixup
(
RGí_CRLFCR
); \

776 i‡(!
msg
->
¸lf
.
±r
) \

778 
	`tfw_hâp_msg_£t_°r_d©a
(
msg
, &msg->
¸lf
, 
p
); \

779 
	`__FSM_MOVE_f
(
RGí_CRLFCR
, &
msg
->
¸lf
); \

781 i‡(
c
 == '\n') { \

782 i‡(!
msg
->
¸lf
.
±r
) { \

787 
	`tfw_hâp_msg_£t_°r_d©a
(
msg
, &msg->
¸lf
, 
p
); \

788 
msg
->
¸lf
.
Àn
 = 1; \

789 
msg
->
¸lf
.
Êags
 |
TFW_STR_COMPLETE
; \

790 
	`__FSM_JMP
(
RGí_BodyInô
); \

792 
	`FSM_EXIT
(
TFW_PASS
); \

794 } 0)

	)

799 
	#RGEN_CRLF
() \

800 
	`__FSM_STATE
(
RGí_CRLFCR
) { \

801 i‡(
	`u∆ikñy
(
c
 != '\n')) \

802 
	`TFW_PARSER_BLOCK
(
RGí_CRLFCR
); \

803 
	`m¨k_•ec_hbh
(
msg
); \

804 i‡(!(
msg
->
¸lf
.
Êags
 & 
TFW_STR_COMPLETE
)) { \

805 
	`BUG_ON
(!
msg
->
¸lf
.
±r
); \

806 
	`__msg_fõld_föish
(&
msg
->
¸lf
, 
p
 + 1); \

807 
	`__FSM_JMP
(
RGí_BodyInô
); \

809 
	`FSM_EXIT
(
TFW_PASS
); \

810 }

	)

819 
	#__TFW_HTTP_PARSE_SPECHDR_VAL
(
°_cuº
, 
°_i
, 
hm
, 
func
, 
id
, 
ßvevÆ
) \

820 
	`__FSM_STATE
(
°_cuº
) { \

821 
	`BUG_ON
(
	`__d©a_off
(
p
Ë> 
Àn
); \

822 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
); \

823 i‡(
∑r£r
->
_i_°
 =
I_0
) { \

824 
	`TRY_STR_INIT
(); \

825 
∑r£r
->
_i_°
 = 
°_i
; \

831 i‡(
id
 < 
TFW_HTTP_HDR_NONSINGULAR
 \

832 && 
	`u∆ikñy
(!
	`TFW_STR_EMPTY
(&(
msg
)->
h_tbl
->
tbl
[
id
]))) \

833 
	`TFW_PARSER_BLOCK
(
°_cuº
); \

835 
	`__msg_hdr_chunk_fixup
(
d©a
, 
p
 - data); \

836 
__fsm_n
 = 
	`func
(
hm
, 
p
, 
__fsm_sz
); \

837 
	`TFW_DBG3
("parse special header " #func ":Ñet=%d data_len=%lu" \

838 " id=%d\n", 
__fsm_n
, 
__fsm_sz
, 
id
); \

839 
__fsm_n
) { \

840 
CSTR_POSTPONE
: \

842 
r
 = 
TFW_POSTPONE
; \

843 
p
 +
__fsm_sz
; \

844 
d⁄e
; \

845 
CSTR_BADLEN
: \

846 
CSTR_NEQ
: \

847 
	`TFW_PARSER_BLOCK
(
°_cuº
); \

849 
	`BUG_ON
(
__fsm_n
 < 0); \

851 i‡(
ßvevÆ
) \

852 
	`__msg_hdr_chunk_fixup
(
p
, 
__fsm_n
); \

853 
∑r£r
->
_i_°
 = 
RGí_EoL
; \

854 
∑r£r
->
_hdr_èg
 = 
id
; \

855 
	`__FSM_MOVE_n
(
RGí_OWS
, 
__fsm_n
); \

857 }

	)

859 
	#TFW_HTTP_PARSE_SPECHDR_VAL
(
°_cuº
, 
°_i
, 
hm
, 
func
, 
id
) \

860 
	`__TFW_HTTP_PARSE_SPECHDR_VAL
(
°_cuº
, 
°_i
, 
hm
, 
func
, 
id
, 1)

	)

862 
	#__TFW_HTTP_PARSE_RAWHDR_VAL
(
°_cuº
, 
°_i
, 
hm
, 
func
, 
ßvevÆ
) \

863 
	`__FSM_STATE
(
°_cuº
) { \

864 
	`BUG_ON
(
	`__d©a_off
(
p
Ë> 
Àn
); \

865 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
); \

866 i‡(
∑r£r
->
_i_°
 =
I_0
) { \

867 
	`TRY_STR_INIT
(); \

868 
∑r£r
->
_i_°
 = 
°_i
; \

875 
	`__msg_hdr_chunk_fixup
(
d©a
, 
p
 - data); \

876 
__fsm_n
 = 
	`func
(
hm
, 
p
, 
__fsm_sz
); \

877 
	`TFW_DBG3
("parseÑaw header " #func ":Ñet=%d data_len=%lu\n", \

878 
__fsm_n
, 
__fsm_sz
); \

879 
__fsm_n
) { \

880 
CSTR_POSTPONE
: \

882 
r
 = 
TFW_POSTPONE
; \

883 
p
 +
__fsm_sz
; \

884 
d⁄e
; \

885 
CSTR_BADLEN
: \

886 
CSTR_NEQ
: \

887 
	`TFW_PARSER_BLOCK
(
°_cuº
); \

889 
	`BUG_ON
(
__fsm_n
 < 0); \

891 i‡(
ßvevÆ
) \

892 
	`__msg_hdr_chunk_fixup
(
p
, 
__fsm_n
); \

893 
	`m¨k_øw_hbh
(
msg
, &
∑r£r
->
hdr
); \

894 
∑r£r
->
_i_°
 = 
RGí_EoL
; \

895 
∑r£r
->
_hdr_èg
 = 
TFW_HTTP_HDR_RAW
; \

896 
	`__FSM_MOVE_n
(
RGí_OWS
, 
__fsm_n
); \

898 }

	)

900 
	#TFW_HTTP_PARSE_RAWHDR_VAL
(
°_cuº
, 
°_i
, 
hm
, 
func
) \

901 
	`__TFW_HTTP_PARSE_RAWHDR_VAL
(
°_cuº
, 
°_i
, 
hm
, 
func
, 1)

	)

909 
	#RGEN_HDR_OTHER
() \

910 
	`__FSM_STATE
(
RGí_HdrOthî
) { \

911 
∑r£r
->
_hdr_èg
 = 
TFW_HTTP_HDR_RAW
; \

914 
	`__FSM_STATE
(
RGí_HdrOthîN
) { \

915 
	`__FSM_MATCH_MOVE
(
tokí
, 
RGí_HdrOthîN
); \

916 i‡(
	`likñy
(*(
p
 + 
__fsm_sz
) == ':')) { \

917 
∑r£r
->
_i_°
 = 
RGí_HdrOthîV
; \

918 
	`__FSM_MOVE_n
(
RGí_OWS
, 
__fsm_sz
 + 1); \

920 
	`TFW_PARSER_BLOCK
(
RGí_HdrOthîN
); \

922 
	`__FSM_STATE
(
RGí_HdrOthîV
) { \

927 
	`__FSM_MATCH_MOVE
(
˘ext_vch¨
, 
RGí_HdrOthîV
); \

928 i‡(!
	`IS_CRLF
(*(
p
 + 
__fsm_sz
))) \

929 
	`TFW_PARSER_BLOCK
(
RGí_HdrOthîV
); \

930 
	`__msg_hdr_chunk_fixup
(
d©a
, 
	`__d©a_off
(
p
 + 
__fsm_sz
)); \

931 
	`m¨k_øw_hbh
(
msg
, &
∑r£r
->
hdr
); \

932 
	`__FSM_MOVE_n
(
RGí_EoL
, 
__fsm_sz
); \

933 }

	)

936 
	#TFW_HTTP_INIT_REQ_BODY_PARSING
() \

937 
	`__FSM_STATE
(
RGí_BodyInô
) { \

938 
TfwSå
 *
tbl
 = 
msg
->
h_tbl
->tbl; \

940 
	`TFW_DBG3
("parseÑequest body: flags=%#x content_length=%lu\n", \

941 
msg
->
Êags
, msg->
c⁄ã¡_Àngth
); \

943 i‡(!
	`TFW_STR_EMPTY
(&
tbl
[
TFW_HTTP_HDR_TRANSFER_ENCODING
])) { \

945 i‡(!
	`TFW_STR_EMPTY
(&
tbl
[
TFW_HTTP_HDR_CONTENT_LENGTH
])) \

946 
	`TFW_PARSER_BLOCK
(
RGí_BodyInô
); \

947 i‡(
msg
->
Êags
 & 
TFW_HTTP_F_CHUNKED
) \

948 
	`__FSM_MOVE_nofixup
(
RGí_BodySèπ
); \

954 
	`TFW_PARSER_BLOCK
(
RGí_BodyInô
); \

956 i‡(
msg
->
c⁄ã¡_Àngth
) { \

957 
∑r£r
->
to_ªad
 = 
msg
->
c⁄ã¡_Àngth
; \

958 
	`__FSM_MOVE_nofixup
(
RGí_BodySèπ
); \

961 
msg
->
body
.
Êags
 |
TFW_STR_COMPLETE
; \

962 
	`FSM_EXIT
(
TFW_PASS
); \

963 }

	)

966 
	#TFW_HTTP_INIT_RESP_BODY_PARSING
() \

967 
	`__FSM_STATE
(
RGí_BodyInô
) { \

968 
TfwSå
 *
tbl
 = 
msg
->
h_tbl
->tbl; \

970 
	`TFW_DBG3
("parseÑesponse body: flags=%#x content_length=%lu\n", \

971 
msg
->
Êags
, msg->
c⁄ã¡_Àngth
); \

974 i‡(
msg
->
Êags
 & 
TFW_HTTP_F_VOID_BODY
) { \

975 
msg
->
body
.
Êags
 |
TFW_STR_COMPLETE
; \

976 
	`FSM_EXIT
(
TFW_PASS
); \

978 i‡(!
	`TFW_STR_EMPTY
(&
tbl
[
TFW_HTTP_HDR_TRANSFER_ENCODING
])) { \

980 i‡(!
	`TFW_STR_EMPTY
(&
tbl
[
TFW_HTTP_HDR_CONTENT_LENGTH
])) \

981 
	`TFW_PARSER_BLOCK
(
RGí_BodyInô
); \

982 i‡(
msg
->
Êags
 & 
TFW_HTTP_F_CHUNKED
) \

983 
	`__FSM_MOVE_nofixup
(
RGí_BodySèπ
); \

984 
	`__FSM_MOVE_nofixup
(
Re•_BodyU∆imSèπ
); \

986 i‡(!
	`TFW_STR_EMPTY
(&
tbl
[
TFW_HTTP_HDR_CONTENT_LENGTH
])) \

988 i‡(
msg
->
c⁄ã¡_Àngth
) { \

989 
∑r£r
->
to_ªad
 = 
msg
->
c⁄ã¡_Àngth
; \

990 
	`__FSM_MOVE_nofixup
(
RGí_BodySèπ
); \

993 
msg
->
body
.
Êags
 |
TFW_STR_COMPLETE
; \

994 
	`FSM_EXIT
(
TFW_PASS
); \

1004 
	`__FSM_MOVE_nofixup
(
Re•_BodyU∆imSèπ
); \

1005 }

	)

1007 
	#TFW_HTTP_PARSE_BODY_UNLIM
() \

1008 
	`__FSM_STATE
(
Re•_BodyU∆imSèπ
) { \

1009 
	`tfw_hâp_msg_£t_°r_d©a
(
msg
, &msg->
body
, 
p
); \

1012 
	`__FSM_STATE
(
Re•_BodyU∆imRód
) { \

1013 
	`__FSM_MOVE_nf
(
Re•_BodyU∆imRód
, 
	`__d©a_ªmaö
(
p
), &
msg
->
body
); \

1014 }

	)

1016 
	#TFW_HTTP_PARSE_BODY
() \

1018 
	`__FSM_STATE
(
RGí_BodySèπ
) { \

1019 
	`tfw_hâp_msg_£t_°r_d©a
(
msg
, &msg->
body
, 
p
); \

1022 
	`__FSM_STATE
(
RGí_BodyChunk
) { \

1023 
	`TFW_DBG3
("ªad body:Åo_ªad=%ld\n", 
∑r£r
->
to_ªad
); \

1024 i‡(
∑r£r
->
to_ªad
 == -1) { \

1026 i‡(!
	`isxdigô
(
c
)) \

1027 
	`TFW_PARSER_BLOCK
(
RGí_BodyChunk
); \

1028 
	`__FSM_JMP
(
RGí_BodyChunkLí
); \

1032 
	`__FSM_STATE
(
RGí_BodyRódChunk
) { \

1033 
	`BUG_ON
(
∑r£r
->
to_ªad
 < 0); \

1034 
__fsm_sz
 = 
	`mö_t
(, 
∑r£r
->
to_ªad
, 
	`__d©a_ªmaö
(
p
)); \

1035 
∑r£r
->
to_ªad
 -
__fsm_sz
; \

1036 i‡(
∑r£r
->
to_ªad
) \

1037 
	`__FSM_MOVE_nf
(
RGí_BodyRódChunk
, 
__fsm_sz
, &
msg
->
body
); \

1038 i‡(
msg
->
Êags
 & 
TFW_HTTP_F_CHUNKED
) { \

1039 
∑r£r
->
to_ªad
 = -1; \

1040 
	`__FSM_MOVE_nf
(
RGí_BodyEoL
, 
__fsm_sz
, &
msg
->
body
); \

1043 i‡(
	`tfw_hâp_msg_add_°r_d©a
(
msg
, &msg->
body
, 
p
, 
__fsm_sz
)) \

1044 
	`TFW_PARSER_BLOCK
(
RGí_BodyRódChunk
); \

1045 
msg
->
body
.
Êags
 |
TFW_STR_COMPLETE
; \

1046 
p
 +
__fsm_sz
; \

1047 
r
 = 
TFW_PASS
; \

1048 
d⁄e
; \

1050 
	`__FSM_STATE
(
RGí_BodyChunkLí
) { \

1051 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
); \

1053 
__fsm_n
 = 
	`∑r£_öt_hex
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
, &∑r£r->
_˙t
); \

1054 
	`TFW_DBG3
("data chunk:Ñemain_len=%zuÑet=%dÅo_read=%lu\n", \

1055 
__fsm_sz
, 
__fsm_n
, 
∑r£r
->
_acc
); \

1056 
__fsm_n
) { \

1057 
CSTR_POSTPONE
: \

1058 
	`__FSM_MOVE_nf
(
RGí_BodyChunkLí
, 
__fsm_sz
, &
msg
->
body
); \

1059 
CSTR_BADLEN
: \

1060 
CSTR_NEQ
: \

1061 
	`TFW_PARSER_BLOCK
(
RGí_BodyChunkLí
); \

1063 
∑r£r
->
to_ªad
 =Ö¨£r->
_acc
; \

1064 
∑r£r
->
_acc
 = 0; \

1065 
∑r£r
->
_˙t
 = 0; \

1066 
	`__FSM_MOVE_nf
(
RGí_BodyChunkExt
, 
__fsm_n
, &
msg
->
body
); \

1069 
	`__FSM_STATE
(
RGí_BodyChunkExt
) { \

1070 i‡(
	`u∆ikñy
(
c
 =';' || c ='=' || 
	`IS_TOKEN
(c))) \

1071 
	`__FSM_MOVE_f
(
RGí_BodyChunkExt
, &
msg
->
body
); \

1074 
	`__FSM_STATE
(
RGí_BodyEoL
) { \

1075 i‡(
	`likñy
(
c
 == '\r')) \

1076 
	`__FSM_MOVE_f
(
RGí_BodyCR
, &
msg
->
body
); \

1079 
	`__FSM_STATE
(
RGí_BodyCR
) { \

1080 i‡(
	`u∆ikñy
(
c
 != '\n')) \

1081 
	`TFW_PARSER_BLOCK
(
RGí_BodyCR
); \

1082 i‡(
∑r£r
->
to_ªad
) \

1083 
	`__FSM_MOVE_f
(
RGí_BodyChunk
, &
msg
->
body
); \

1088 i‡(
	`tfw_hâp_msg_add_°r_d©a
(
msg
, &msg->
body
, 
d©a
, \

1089 
	`__d©a_off
(
p
) + 1)) \

1090 
	`TFW_PARSER_BLOCK
(
RGí_BodyCR
); \

1091 
msg
->
body
.
Êags
 |
TFW_STR_COMPLETE
; \

1093 
	`__FSM_MOVE_nofixup
(
RGí_Hdr
); \

1094 }

	)

1101 
	#RGEN_OWS
() \

1102 
	`__FSM_STATE
(
RGí_OWS
) { \

1103 i‡(
	`likñy
(
	`IS_WS
(
c
))) \

1104 
	`__FSM_MOVE
(
RGí_OWS
); \

1105 
∑r£r
->
°©e
 =Ö¨£r->
_i_°
; \

1106 
∑r£r
->
_i_°
 = 0; \

1107 
	`BUG_ON
(
	`u∆ikñy
(
	`__d©a_off
(
p
Ë>
Àn
)); \

1108 
fsm_ªíãr
; \

1109 }

	)

1115 
	#TRY_HBH_TOKEN
(
«me
, 
œmbda
) \

1116 
	`TRY_STR_LAMBDA_föish
(
«me
, 
œmbda
, { \

1117 i‡(
	`__hbh_∑r£r_add_d©a
(
hm
, 
d©a
, 
Àn
, 
Ál£
)) \

1118 
r
 = 
CSTR_NEQ
; \

1119 }, 
I_EoT
)

	)

1132 
	$__∑r£_c⁄√˘i⁄
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

1134 
r
 = 
CSTR_NEQ
;

1135 
	`__FSM_DECLARE_VARS
(
hm
);

1137 
	`BUILD_BUG_ON
((
∑r£r
->
hbh_∑r£r
.
•ec
Ë* 8 < 
TFW_HTTP_HDR_RAW
);

1139 
	`__FSM_START
(
∑r£r
->
_i_°
) {

1155 
	`__FSM_STATE
(
I_C⁄n
) {

1157 
	`TRY_HBH_TOKEN
("close", {

1158 i‡(
msg
->
Êags
 & 
TFW_HTTP_F_CONN_KA
)

1159  
CSTR_NEQ
;

1160 
msg
->
Êags
 |
TFW_HTTP_F_CONN_CLOSE
;

1163 
	`TRY_HBH_TOKEN
("keep-alive", {

1164 
hid
 = 
TFW_HTTP_HDR_KEEP_ALIVE
;

1166 i‡(
msg
->
Êags
 & 
TFW_HTTP_F_CONN_CLOSE
)

1167  
CSTR_NEQ
;

1168 
msg
->
Êags
 |
TFW_HTTP_F_CONN_KA
;

1170 
∑r£r
->
hbh_∑r£r
.
•ec
 |0x1 << 
hid
;

1171 i‡(!
	`TFW_STR_EMPTY
(&
msg
->
h_tbl
->
tbl
[
hid
]))

1172 
msg
->
h_tbl
->
tbl
[
hid
].
Êags
 |
TFW_STR_HBH_HDR
;

1174 
	`TRY_STR_INIT
();

1175 
	`__FSM_I_MOVE_n
(
I_C⁄nOthî
, 0);

1184 
	`__FSM_STATE
(
I_C⁄nOthî
) {

1185 
	`__FSM_I_MATCH_MOVE_föish
(
tokí
, 
I_C⁄nOthî
, {

1186 i‡(
	`__hbh_∑r£r_add_d©a
(
hm
, 
p
, 
__fsm_sz
, 
Ál£
))

1187 
r
 = 
CSTR_NEQ
;

1189 
msg
->
Êags
 |
TFW_HTTP_F_CONN_EXTRA
;

1190 
c
 = *(
p
 + 
__fsm_sz
);

1191 i‡(
	`__hbh_∑r£r_add_d©a
(
hm
, 
p
, 
__fsm_sz
, 
åue
))

1192  
CSTR_NEQ
;

1193 i‡(
	`IS_WS
(
c
) || c == ',')

1194 
	`__FSM_I_MOVE_n
(
I_EoT
, 
__fsm_sz
 + 1);

1195 i‡(
	`IS_CRLF
(
c
))

1196  
	`__d©a_off
(
p
 + 
__fsm_sz
);

1197  
CSTR_NEQ
;

1201 
	`__FSM_STATE
(
I_EoT
) {

1202 i‡(
	`IS_WS
(
c
) || c == ',')

1203 
	`__FSM_I_MOVE
(
I_EoT
);

1204 i‡(
	`IS_TOKEN
(
c
))

1205 
	`__FSM_I_MOVE_n
(
I_C⁄n
, 0);

1206 i‡(
	`IS_CRLF
(
c
))

1207  
	`__d©a_off
(
p
);

1208  
CSTR_NEQ
;

1212 
d⁄e
:

1213 
	`TFW_DBG3
("∑r£r: C⁄√˘i⁄Ö¨£d: fœg†%#x\n", 
msg
->
Êags
);

1215  
r
;

1216 
	}
}

1222 
	$__∑r£_c⁄ã¡_Àngth
(
TfwHâpMsg
 *
msg
, *
d©a
, 
size_t
 
Àn
)

1224 
r
;

1232 i‡(
	`TFW_CONN_TYPE
(
msg
->
c⁄n
Ë& 
C⁄n_Srv
) {

1233 
TfwHâpRe•
 *
ª•
 = (TfwHâpRe• *)
msg
;

1234 i‡(
ª•
->
°©us
 - 100U < 100U ||Ñesp->status == 204)

1235  
CSTR_NEQ
;

1250 
r
 = 
	`∑r£_öt_ws
(
d©a
, 
Àn
, &
msg
->
c⁄ã¡_Àngth
);

1251 i‡(
r
 =
CSTR_POSTPONE
)

1252 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

1254 
	`TFW_DBG3
("%s: c⁄ã¡_Àngth=%lu\n", 
__func__
, 
msg
->
c⁄ã¡_Àngth
);

1256  
r
;

1257 
	}
}

1263 
	$__∑r£_c⁄ã¡_ty≥
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

1265 
r
 = 
CSTR_NEQ
;

1266 
	`__FSM_DECLARE_VARS
(
hm
);

1268 
	`__FSM_START
(
∑r£r
->
_i_°
) {

1270 
	`__FSM_STATE
(
I_C⁄tTy≥
) {

1288 
	`__FSM_I_MATCH_MOVE
(
˘ext_vch¨
, 
I_C⁄tTy≥
);

1289 i‡(
	`IS_CRLF
(*(
p
 + 
__fsm_sz
)))

1290  
	`__d©a_off
(
p
 + 
__fsm_sz
);

1291  
CSTR_NEQ
;

1295 
d⁄e
:

1296  
r
;

1297 
	}
}

1303 
	$__∑r£_å™s„r_ícodög
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

1305 
r
 = 
CSTR_NEQ
;

1306 
	`__FSM_DECLARE_VARS
(
hm
);

1308 
	`__FSM_START
(
∑r£r
->
_i_°
) {

1317 
	`__FSM_STATE
(
I_TønsEncod
) {

1318 i‡(
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_Srv
) {

1319 
°©us
 = ((
TfwHâpRe•
 *)
hm
)->status;

1320 i‡((
°©us
 - 100U < 100U) || (status == 204))

1321  
CSTR_NEQ
;

1323 
	`__FSM_I_JMP
(
I_TønsEncodChunked
);

1326 
	`__FSM_STATE
(
I_TønsEncodChunked
) {

1332 
	`TRY_STR_LAMBDA
("chunked", {

1333 i‡(
	`u∆ikñy
(
msg
->
Êags
 & 
TFW_HTTP_F_CHUNKED
))

1334  
CSTR_NEQ
;

1335 
msg
->
Êags
 |
TFW_HTTP_F_CHUNKED
;

1336 }, 
I_EoT
);

1337 
	`TRY_STR_INIT
();

1338 
	`__FSM_I_MOVE_n
(
I_TønsEncodOthî
, 0);

1341 
	`__FSM_STATE
(
I_TønsEncodOthî
) {

1346 
	`__FSM_I_MATCH_MOVE
(
tokí
, 
I_TønsEncodOthî
);

1347 
c
 = *(
p
 + 
__fsm_sz
);

1348 i‡(
	`IS_WS
(
c
) || c == ',')

1349 
	`__FSM_I_MOVE_n
(
I_EoT
, 
__fsm_sz
 + 1);

1350 i‡(
	`IS_CRLF
(
c
)) {

1352 i‡(
	`u∆ikñy
(
msg
->
Êags
 & 
TFW_HTTP_F_CHUNKED
))

1353  
CSTR_NEQ
;

1354  
	`__d©a_off
(
p
 + 
__fsm_sz
);

1356  
CSTR_NEQ
;

1360 
	`__FSM_STATE
(
I_EoT
) {

1361 i‡(
	`IS_WS
(
c
) || c == ',')

1362 
	`__FSM_I_MOVE
(
I_EoT
);

1363 i‡(
	`IS_TOKEN
(
c
))

1364 
	`__FSM_I_MOVE_n
(
I_TønsEncodChunked
, 0);

1365 i‡(
	`IS_CRLF
(
c
))

1366  
	`__d©a_off
(
p
);

1367  
CSTR_NEQ
;

1371 
d⁄e
:

1372  
r
;

1373 
	}
}

1382 
	mReq_0
,

1384 
	mReq_Mëhod
,

1385 
	mReq_MëhodUnknown
,

1386 
	mReq_MëhC
,

1387 
	mReq_MëhCo
,

1388 
	mReq_MëhC›
,

1389 
	mReq_MëhD
,

1390 
	mReq_MëhDe
,

1391 
	mReq_MëhDñ
,

1392 
	mReq_MëhDñe
,

1393 
	mReq_MëhDñë
,

1394 
	mReq_MëhG
,

1395 
	mReq_MëhGe
,

1396 
	mReq_MëhH
,

1397 
	mReq_MëhHe
,

1398 
	mReq_MëhHó
,

1399 
	mReq_MëhL
,

1400 
	mReq_MëhLo
,

1401 
	mReq_MëhLoc
,

1402 
	mReq_MëhM
,

1403 
	mReq_MëhMk
,

1404 
	mReq_MëhMkc
,

1405 
	mReq_MëhMkco
,

1406 
	mReq_MëhMo
,

1407 
	mReq_MëhMov
,

1408 
	mReq_MëhO
,

1409 
	mReq_MëhOp
,

1410 
	mReq_MëhO±
,

1411 
	mReq_MëhO±i
,

1412 
	mReq_MëhO±io
,

1413 
	mReq_MëhO±i⁄
,

1414 
	mReq_MëhP
,

1415 
	mReq_MëhPa
,

1416 
	mReq_MëhP©
,

1417 
	mReq_MëhP©c
,

1418 
	mReq_MëhPo
,

1419 
	mReq_MëhPos
,

1420 
	mReq_MëhPr
,

1421 
	mReq_MëhPro
,

1422 
	mReq_MëhPr›
,

1423 
	mReq_MëhPr›f
,

1424 
	mReq_MëhPr›fi
,

1425 
	mReq_MëhPr›fö
,

1426 
	mReq_MëhPr›p
,

1427 
	mReq_MëhPr›∑
,

1428 
	mReq_MëhPr›∑t
,

1429 
	mReq_MëhPr›∑tc
,

1430 
	mReq_MëhPu
,

1431 
	mReq_MëhPur
,

1432 
	mReq_MëhPurg
,

1433 
	mReq_MëhT
,

1434 
	mReq_MëhTr
,

1435 
	mReq_MëhTø
,

1436 
	mReq_MëhTøc
,

1437 
	mReq_MëhU
,

1438 
	mReq_MëhUn
,

1439 
	mReq_MëhU∆
,

1440 
	mReq_MëhU∆o
,

1441 
	mReq_MëhU∆oc
,

1442 
	mReq_MUS∑˚
,

1443 
	mReq_Uri
,

1444 
	mReq_UriSchH
,

1445 
	mReq_UriSchHt
,

1446 
	mReq_UriSchHâ
,

1447 
	mReq_UriSchHâp
,

1448 
	mReq_UriSchHâpCﬁ⁄
,

1449 
	mReq_UriSchHâpCﬁ⁄Sœsh
,

1455 
	mReq_UriAuth‹ôySèπ
,

1456 
	mReq_UriAuth‹ôy
,

1457 
	mReq_UriAuth‹ôyRe£tHo°
,

1458 
	mReq_UriAuth‹ôyIPv6
,

1459 
	mReq_UriAuth‹ôyEnd
,

1460 
	mReq_UriP‹t
,

1461 
	mReq_UriAbsP©h
,

1462 
	mReq_HâpVî
,

1463 
	mReq_HâpVîT1
,

1464 
	mReq_HâpVîT2
,

1465 
	mReq_HâpVîP
,

1466 
	mReq_HâpVîSœsh
,

1467 
	mReq_HâpVî11
,

1468 
	mReq_HâpVîDŸ
,

1469 
	mReq_HâpVî12
,

1471 
	mReq_Hdr
,

1472 
	mReq_HdrA
,

1473 
	mReq_HdrAc
,

1474 
	mReq_HdrAcc
,

1475 
	mReq_HdrAc˚
,

1476 
	mReq_HdrAc˚p
,

1477 
	mReq_HdrAc˚±
,

1478 
	mReq_HdrAc˚±V
,

1479 
	mReq_HdrAu
,

1480 
	mReq_HdrAut
,

1481 
	mReq_HdrAuth
,

1482 
	mReq_HdrAutho
,

1483 
	mReq_HdrAuth‹
,

1484 
	mReq_HdrAuth‹i
,

1485 
	mReq_HdrAuth‹iz
,

1486 
	mReq_HdrAuth‹iza
,

1487 
	mReq_HdrAuth‹iz©
,

1488 
	mReq_HdrAuth‹iz©i
,

1489 
	mReq_HdrAuth‹iz©io
,

1490 
	mReq_HdrAuth‹iz©i⁄
,

1491 
	mReq_HdrAuth‹iz©i⁄V
,

1492 
	mReq_HdrC
,

1493 
	mReq_HdrCa
,

1494 
	mReq_HdrCac
,

1495 
	mReq_HdrCach
,

1496 
	mReq_HdrCache
,

1497 
	mReq_HdrCache_
,

1498 
	mReq_HdrCache_C
,

1499 
	mReq_HdrCache_Co
,

1500 
	mReq_HdrCache_C⁄
,

1501 
	mReq_HdrCache_C⁄t
,

1502 
	mReq_HdrCache_C⁄å
,

1503 
	mReq_HdrCache_C⁄åo
,

1504 
	mReq_HdrCache_C⁄åﬁ
,

1505 
	mReq_HdrCache_C⁄åﬁV
,

1506 
	mReq_HdrCo
,

1507 
	mReq_HdrC⁄
,

1508 
	mReq_HdrC⁄n
,

1509 
	mReq_HdrC⁄√
,

1510 
	mReq_HdrC⁄√c
,

1511 
	mReq_HdrC⁄√˘
,

1512 
	mReq_HdrC⁄√˘i
,

1513 
	mReq_HdrC⁄√˘io
,

1514 
	mReq_HdrC⁄√˘i⁄
,

1515 
	mReq_HdrC⁄√˘i⁄V
,

1516 
	mReq_HdrC⁄t
,

1517 
	mReq_HdrC⁄ã
,

1518 
	mReq_HdrC⁄ãn
,

1519 
	mReq_HdrC⁄ã¡
,

1520 
	mReq_HdrC⁄ã¡_
,

1521 
	mReq_HdrC⁄ã¡_L
,

1522 
	mReq_HdrC⁄ã¡_Le
,

1523 
	mReq_HdrC⁄ã¡_Lí
,

1524 
	mReq_HdrC⁄ã¡_Líg
,

1525 
	mReq_HdrC⁄ã¡_Lígt
,

1526 
	mReq_HdrC⁄ã¡_Lígth
,

1527 
	mReq_HdrC⁄ã¡_LígthV
,

1528 
	mReq_HdrC⁄ã¡_T
,

1529 
	mReq_HdrC⁄ã¡_Ty
,

1530 
	mReq_HdrC⁄ã¡_Typ
,

1531 
	mReq_HdrC⁄ã¡_Ty≥
,

1532 
	mReq_HdrC⁄ã¡_Ty≥V
,

1533 
	mReq_HdrCoo
,

1534 
	mReq_HdrCook
,

1535 
	mReq_HdrCooki
,

1536 
	mReq_HdrCookõ
,

1537 
	mReq_HdrCookõV
,

1538 
	mReq_HdrH
,

1539 
	mReq_HdrHo
,

1540 
	mReq_HdrHos
,

1541 
	mReq_HdrHo°
,

1542 
	mReq_HdrHo°V
,

1543 
	mReq_HdrI
,

1544 
	mReq_HdrIf
,

1545 
	mReq_HdrIf_
,

1546 
	mReq_HdrIf_M
,

1547 
	mReq_HdrIf_Mo
,

1548 
	mReq_HdrIf_Mod
,

1549 
	mReq_HdrIf_Modi
,

1550 
	mReq_HdrIf_Modif
,

1551 
	mReq_HdrIf_Modifi
,

1552 
	mReq_HdrIf_Modifõ
,

1553 
	mReq_HdrIf_Modifõd
,

1554 
	mReq_HdrIf_Modifõd_
,

1555 
	mReq_HdrIf_Modifõd_S
,

1556 
	mReq_HdrIf_Modifõd_Si
,

1557 
	mReq_HdrIf_Modifõd_Sö
,

1558 
	mReq_HdrIf_Modifõd_Söc
,

1559 
	mReq_HdrIf_Modifõd_Sö˚
,

1560 
	mReq_HdrIf_Modifõd_Sö˚V
,

1561 
	mReq_HdrIf_N
,

1562 
	mReq_HdrIf_No
,

1563 
	mReq_HdrIf_N⁄
,

1564 
	mReq_HdrIf_N⁄e
,

1565 
	mReq_HdrIf_N⁄e_
,

1566 
	mReq_HdrIf_N⁄e_M
,

1567 
	mReq_HdrIf_N⁄e_Ma
,

1568 
	mReq_HdrIf_N⁄e_M©
,

1569 
	mReq_HdrIf_N⁄e_M©c
,

1570 
	mReq_HdrIf_N⁄e_M©ch
,

1571 
	mReq_HdrIf_N⁄e_M©chV
,

1572 
	mReq_HdrK
,

1573 
	mReq_HdrKe
,

1574 
	mReq_HdrKì
,

1575 
	mReq_HdrKìp
,

1576 
	mReq_HdrKìp_
,

1577 
	mReq_HdrKìp_A
,

1578 
	mReq_HdrKìp_Al
,

1579 
	mReq_HdrKìp_Ali
,

1580 
	mReq_HdrKìp_Aliv
,

1581 
	mReq_HdrKìp_Alive
,

1582 
	mReq_HdrKìp_AliveV
,

1583 
	mReq_HdrP
,

1584 
	mReq_HdrPr
,

1585 
	mReq_HdrPø
,

1586 
	mReq_HdrPøg
,

1587 
	mReq_HdrPøgm
,

1588 
	mReq_HdrPøgma
,

1589 
	mReq_HdrPøgmaV
,

1590 
	mReq_HdrR
,

1591 
	mReq_HdrRe
,

1592 
	mReq_HdrRef
,

1593 
	mReq_HdrRe„
,

1594 
	mReq_HdrRe„r
,

1595 
	mReq_HdrRe„ª
,

1596 
	mReq_HdrRe„ªr
,

1597 
	mReq_HdrRe„ªrV
,

1598 
	mReq_HdrT
,

1599 
	mReq_HdrTr
,

1600 
	mReq_HdrTø
,

1601 
	mReq_HdrTøn
,

1602 
	mReq_HdrTøns
,

1603 
	mReq_HdrTønsf
,

1604 
	mReq_HdrTøns„
,

1605 
	mReq_HdrTøns„r
,

1606 
	mReq_HdrTøns„r_
,

1607 
	mReq_HdrTøns„r_E
,

1608 
	mReq_HdrTøns„r_En
,

1609 
	mReq_HdrTøns„r_Enc
,

1610 
	mReq_HdrTøns„r_Enco
,

1611 
	mReq_HdrTøns„r_Encod
,

1612 
	mReq_HdrTøns„r_Encodi
,

1613 
	mReq_HdrTøns„r_Encodö
,

1614 
	mReq_HdrTøns„r_Encodög
,

1615 
	mReq_HdrTøns„r_EncodögV
,

1616 
	mReq_HdrU
,

1617 
	mReq_HdrUs
,

1618 
	mReq_HdrU£
,

1619 
	mReq_HdrU£r
,

1620 
	mReq_HdrU£r_
,

1621 
	mReq_HdrU£r_A
,

1622 
	mReq_HdrU£r_Ag
,

1623 
	mReq_HdrU£r_Age
,

1624 
	mReq_HdrU£r_Agí
,

1625 
	mReq_HdrU£r_Agít
,

1626 
	mReq_HdrU£r_AgítV
,

1627 
	mReq_HdrX
,

1628 
	mReq_HdrX_
,

1629 
	mReq_HdrX_F
,

1630 
	mReq_HdrX_Fo
,

1631 
	mReq_HdrX_F‹
,

1632 
	mReq_HdrX_F‹w
,

1633 
	mReq_HdrX_F‹wa
,

1634 
	mReq_HdrX_F‹w¨
,

1635 
	mReq_HdrX_F‹w¨d
,

1636 
	mReq_HdrX_F‹w¨de
,

1637 
	mReq_HdrX_F‹w¨ded
,

1638 
	mReq_HdrX_F‹w¨ded_
,

1639 
	mReq_HdrX_F‹w¨ded_F
,

1640 
	mReq_HdrX_F‹w¨ded_Fo
,

1641 
	mReq_HdrX_F‹w¨ded_F‹
,

1642 
	mReq_HdrX_F‹w¨ded_F‹V
,

1645 
	mReq_UriN‹m
,

1647 
	mReq_SèãsNum


1650 #ifde‡
TFW_HTTP_NORMALIZATION


1651 
	#TFW_HTTP_URI_HOOK
 
Req_UriN‹m


	)

1653 
	#TFW_HTTP_URI_HOOK
 
Req_UriAbsP©h


	)

1658 
	mRe•_0
 = 5000,

1660 
	mRe•_HâpVî
,

1661 
	mRe•_HâpVîT1
,

1662 
	mRe•_HâpVîT2
,

1663 
	mRe•_HâpVîP
,

1664 
	mRe•_HâpVîSœsh
,

1665 
	mRe•_HâpVî11
,

1666 
	mRe•_HâpVîDŸ
,

1667 
	mRe•_HâpVî12
,

1668 
	mRe•_SS∑˚
,

1669 
	mRe•_SètusCode
,

1670 
	mRe•_Rós⁄Phø£
,

1672 
	mRe•_Hdr
,

1673 
	mRe•_HdrA
,

1674 
	mRe•_HdrAg
,

1675 
	mRe•_HdrAge
,

1676 
	mRe•_HdrAgeV
,

1677 
	mRe•_HdrC
,

1678 
	mRe•_HdrCa
,

1679 
	mRe•_HdrCac
,

1680 
	mRe•_HdrCach
,

1681 
	mRe•_HdrCache
,

1682 
	mRe•_HdrCache_
,

1683 
	mRe•_HdrCache_C
,

1684 
	mRe•_HdrCache_Co
,

1685 
	mRe•_HdrCache_C⁄
,

1686 
	mRe•_HdrCache_C⁄t
,

1687 
	mRe•_HdrCache_C⁄å
,

1688 
	mRe•_HdrCache_C⁄åo
,

1689 
	mRe•_HdrCache_C⁄åﬁ
,

1690 
	mRe•_HdrCache_C⁄åﬁV
,

1691 
	mRe•_HdrCo
,

1692 
	mRe•_HdrC⁄
,

1693 
	mRe•_HdrC⁄n
,

1694 
	mRe•_HdrC⁄√
,

1695 
	mRe•_HdrC⁄√c
,

1696 
	mRe•_HdrC⁄√˘
,

1697 
	mRe•_HdrC⁄√˘i
,

1698 
	mRe•_HdrC⁄√˘io
,

1699 
	mRe•_HdrC⁄√˘i⁄
,

1700 
	mRe•_HdrC⁄√˘i⁄V
,

1701 
	mRe•_HdrC⁄t
,

1702 
	mRe•_HdrC⁄ã
,

1703 
	mRe•_HdrC⁄ãn
,

1704 
	mRe•_HdrC⁄ã¡
,

1705 
	mRe•_HdrC⁄ã¡_
,

1706 
	mRe•_HdrC⁄ã¡_L
,

1707 
	mRe•_HdrC⁄ã¡_Le
,

1708 
	mRe•_HdrC⁄ã¡_Lí
,

1709 
	mRe•_HdrC⁄ã¡_Líg
,

1710 
	mRe•_HdrC⁄ã¡_Lígt
,

1711 
	mRe•_HdrC⁄ã¡_Lígth
,

1712 
	mRe•_HdrC⁄ã¡_LígthV
,

1713 
	mRe•_HdrC⁄ã¡_T
,

1714 
	mRe•_HdrC⁄ã¡_Ty
,

1715 
	mRe•_HdrC⁄ã¡_Typ
,

1716 
	mRe•_HdrC⁄ã¡_Ty≥
,

1717 
	mRe•_HdrC⁄ã¡_Ty≥V
,

1718 
	mRe•_HdrD
,

1719 
	mRe•_HdrDa
,

1720 
	mRe•_HdrD©
,

1721 
	mRe•_HdrD©e
,

1722 
	mRe•_HdrD©eV
,

1723 
	mRe•_HdrE
,

1724 
	mRe•_HdrEt
,

1725 
	mRe•_HdrEè
,

1726 
	mRe•_HdrEèg
,

1727 
	mRe•_HdrEègV
,

1728 
	mRe•_HdrEx
,

1729 
	mRe•_HdrExp
,

1730 
	mRe•_HdrExpi
,

1731 
	mRe•_HdrExpú
,

1732 
	mRe•_HdrExpúe
,

1733 
	mRe•_HdrExpúes
,

1734 
	mRe•_HdrExpúesV
,

1735 
	mRe•_HdrK
,

1736 
	mRe•_HdrKe
,

1737 
	mRe•_HdrKì
,

1738 
	mRe•_HdrKìp
,

1739 
	mRe•_HdrKìp_
,

1740 
	mRe•_HdrKìp_A
,

1741 
	mRe•_HdrKìp_Al
,

1742 
	mRe•_HdrKìp_Ali
,

1743 
	mRe•_HdrKìp_Aliv
,

1744 
	mRe•_HdrKìp_Alive
,

1745 
	mRe•_HdrKìp_AliveV
,

1746 
	mRe•_HdrL
,

1747 
	mRe•_HdrLa
,

1748 
	mRe•_HdrLas
,

1749 
	mRe•_HdrLa°
,

1750 
	mRe•_HdrLa°_
,

1751 
	mRe•_HdrLa°_M
,

1752 
	mRe•_HdrLa°_Mo
,

1753 
	mRe•_HdrLa°_Mod
,

1754 
	mRe•_HdrLa°_Modi
,

1755 
	mRe•_HdrLa°_Modif
,

1756 
	mRe•_HdrLa°_Modifi
,

1757 
	mRe•_HdrLa°_Modifõ
,

1758 
	mRe•_HdrLa°_Modifõd
,

1759 
	mRe•_HdrLa°_ModifõdV
,

1760 
	mRe•_HdrS
,

1761 
	mRe•_HdrSe
,

1762 
	mRe•_HdrSî
,

1763 
	mRe•_HdrSîv
,

1764 
	mRe•_HdrSîve
,

1765 
	mRe•_HdrSîvî
,

1766 
	mRe•_HdrSîvîV
,

1767 
	mRe•_HdrT
,

1768 
	mRe•_HdrTr
,

1769 
	mRe•_HdrTø
,

1770 
	mRe•_HdrTøn
,

1771 
	mRe•_HdrTøns
,

1772 
	mRe•_HdrTønsf
,

1773 
	mRe•_HdrTøns„
,

1774 
	mRe•_HdrTøns„r
,

1775 
	mRe•_HdrTøns„r_
,

1776 
	mRe•_HdrTøns„r_E
,

1777 
	mRe•_HdrTøns„r_En
,

1778 
	mRe•_HdrTøns„r_Enc
,

1779 
	mRe•_HdrTøns„r_Enco
,

1780 
	mRe•_HdrTøns„r_Encod
,

1781 
	mRe•_HdrTøns„r_Encodi
,

1782 
	mRe•_HdrTøns„r_Encodö
,

1783 
	mRe•_HdrTøns„r_Encodög
,

1784 
	mRe•_HdrTøns„r_EncodögV
,

1785 
	mRe•_HdrD⁄e
,

1787 
	mRe•_BodyU∆imSèπ
,

1788 
	mRe•_BodyU∆imRód
,

1790 
	mRe•_SèãsNum


1798 
	mReq_I_0
,

1801 
	mReq_I_H_Sèπ
,

1802 
	mReq_I_H
,

1803 
	mReq_I_H_v6
,

1804 
	mReq_I_H_v6_End
,

1805 
	mReq_I_H_P‹t
,

1807 
	mReq_I_Ac˚±
,

1808 
	mReq_I_Ac˚±Othî
,

1810 
	mReq_I_Auth
,

1812 
	mReq_I_CC
,

1813 
	mReq_I_CC_m
,

1814 
	mReq_I_CC_n
,

1815 
	mReq_I_CC_o
,

1816 
	mReq_I_CC_MaxAgeV
,

1817 
	mReq_I_CC_MöFªshV
,

1818 
	mReq_I_CC_MaxSèÀ
,

1819 
	mReq_I_CC_MaxSèÀV
,

1820 
	mReq_I_CC_Ext
,

1822 
	mReq_I_Pøgma
,

1823 
	mReq_I_Pøgma_Ext
,

1825 
	mReq_I_XFF
,

1826 
	mReq_I_XFF_Node_Id
,

1827 
	mReq_I_XFF_Sï
,

1829 
	mReq_I_U£rAgít
,

1831 
	mReq_I_CookõSèπ
,

1832 
	mReq_I_CookõName
,

1833 
	mReq_I_CookõVÆ
,

1834 
	mReq_I_CookõSemicﬁ⁄
,

1835 
	mReq_I_CookõSP
,

1837 
	mReq_I_Re„ªr
,

1839 
	mReq_I_EoT
,

1844 
	$__ªq_∑r£_ac˚±
(
TfwHâpReq
 *
ªq
, *
d©a
, 
size_t
 
Àn
)

1846 
r
 = 
CSTR_NEQ
;

1847 
	`__FSM_DECLARE_VARS
(
ªq
);

1849 
	`__FSM_START
(
∑r£r
->
_i_°
) {

1851 
	`__FSM_STATE
(
Req_I_Ac˚±
) {

1852 
	`TRY_STR_LAMBDA
("text/html", {

1853 
msg
->
Êags
 |
TFW_HTTP_F_ACCEPT_HTML
;

1854 }, 
I_EoT
);

1855 
	`TRY_STR_INIT
();

1856 
	`__FSM_I_MOVE_n
(
Req_I_Ac˚±Othî
, 0);

1859 
	`__FSM_STATE
(
Req_I_Ac˚±Othî
) {

1860 
	`__FSM_I_MATCH_MOVE
(
uri
, 
Req_I_Ac˚±Othî
);

1861 
c
 = *(
p
 + 
__fsm_sz
);

1862 i‡(
	`IS_WS
(
c
) || c == ',')

1863 
	`__FSM_I_MOVE_n
(
I_EoT
, 
__fsm_sz
 + 1);

1864 i‡(
	`IS_CRLF
(
c
)) {

1865  
	`__d©a_off
(
p
 + 
__fsm_sz
);

1867  
CSTR_NEQ
;

1871 
	`__FSM_STATE
(
I_EoT
) {

1872 i‡(
	`IS_WS
(
c
) || c == ',')

1873 
	`__FSM_I_MOVE
(
I_EoT
);

1874 i‡(
c
 == ';')

1875 
	`__FSM_I_MOVE
(
Req_I_Ac˚±Othî
);

1876 i‡(
	`IS_TOKEN
(
c
))

1877 
	`__FSM_I_MOVE_n
(
Req_I_Ac˚±
, 0);

1878 i‡(
	`IS_CRLF
(
c
))

1879  
	`__d©a_off
(
p
);

1880  
CSTR_NEQ
;

1885 
d⁄e
:

1886  
r
;

1887 
	}
}

1890 
	$__ªq_∑r£_auth‹iz©i⁄
(
TfwHâpReq
 *
ªq
, *
d©a
, 
size_t
 
Àn
)

1892 
r
 = 
CSTR_NEQ
;

1893 
	`__FSM_DECLARE_VARS
(
ªq
);

1895 
	`__FSM_START
(
∑r£r
->
_i_°
) {

1897 
	`__FSM_STATE
(
Req_I_Auth
) {

1902 
	`__FSM_I_MATCH_MOVE
(
˘ext_vch¨
, 
Req_I_Auth
);

1903 i‡(
	`IS_CRLF
(*(
p
 + 
__fsm_sz
))) {

1904 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_HDR_AUTHORIZATION
;

1905  
	`__d©a_off
(
p
 + 
__fsm_sz
);

1907  
CSTR_NEQ
;

1912 
d⁄e
:

1913  
r
;

1914 
	}
}

1920 
	$__ªq_∑r£_ˇche_c⁄åﬁ
(
TfwHâpReq
 *
ªq
, *
d©a
, 
size_t
 
Àn
)

1922 
r
 = 
CSTR_NEQ
;

1923 
	`__FSM_DECLARE_VARS
(
ªq
);

1925 
	`__FSM_START
(
∑r£r
->
_i_°
) {

1927 
	`__FSM_STATE
(
Req_I_CC
) {

1928 
	`TFW_LC
(
c
)) {

1930 
	`__FSM_I_MOVE_n
(
Req_I_CC_m
, 0);

1932 
	`__FSM_I_MOVE_n
(
Req_I_CC_n
, 0);

1934 
	`__FSM_I_MOVE_n
(
Req_I_CC_o
, 0);

1936 
	`__FSM_I_MOVE_n
(
Req_I_CC_Ext
, 0);

1939 
	`__FSM_STATE
(
Req_I_CC_m
) {

1940 
	`TRY_STR
("max-age=", 
Req_I_CC_MaxAgeV
);

1941 
	`TRY_STR
("mö-‰esh=", 
Req_I_CC_MöFªshV
);

1942 
	`TRY_STR
("max-°Æe", 
Req_I_CC_MaxSèÀ
);

1943 
	`TRY_STR_INIT
();

1944 
	`__FSM_I_MOVE_n
(
Req_I_CC_Ext
, 0);

1947 
	`__FSM_STATE
(
Req_I_CC_n
) {

1948 
	`TRY_STR_LAMBDA
("no-cache", {

1949 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_NO_CACHE
;

1950 }, 
Req_I_EoT
);

1951 
	`TRY_STR_LAMBDA
("no-store", {

1952 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_NO_STORE
;

1953 }, 
Req_I_EoT
);

1954 
	`TRY_STR_LAMBDA
("no-transform", {

1955 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_NO_TRANSFORM
;

1956 }, 
Req_I_EoT
);

1957 
	`TRY_STR_INIT
();

1958 
	`__FSM_I_MOVE_n
(
Req_I_CC_Ext
, 0);

1961 
	`__FSM_STATE
(
Req_I_CC_o
) {

1962 
	`TRY_STR_LAMBDA
("only-if-cached", {

1963 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_OIFCACHED
;

1964 }, 
Req_I_EoT
);

1965 
	`TRY_STR_INIT
();

1966 
	`__FSM_I_MOVE_n
(
Req_I_CC_Ext
, 0);

1969 
	`__FSM_STATE
(
Req_I_CC_MaxAgeV
) {

1970 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

1971 
__fsm_n
 = 
	`∑r£_öt_li°
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

1972 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

1973 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

1974 i‡(
__fsm_n
 < 0) {

1975 i‡(
__fsm_n
 !
CSTR_BADLEN
)

1976  
__fsm_n
;

1977 
∑r£r
->
_acc
 = 
UINT_MAX
;

1979 
ªq
->
ˇche_˘l
.
max_age
 = 
∑r£r
->
_acc
;

1980 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_MAX_AGE
;

1981 
∑r£r
->
_acc
 = 0;

1982 
	`__FSM_I_MOVE_n
(
Req_I_EoT
, 
__fsm_n
);

1985 
	`__FSM_STATE
(
Req_I_CC_MöFªshV
) {

1986 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

1987 
__fsm_n
 = 
	`∑r£_öt_li°
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

1988 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

1989 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

1990 i‡(
__fsm_n
 < 0) {

1991 i‡(
__fsm_n
 !
CSTR_BADLEN
)

1992  
__fsm_n
;

1993 
∑r£r
->
_acc
 = 
UINT_MAX
;

1995 
ªq
->
ˇche_˘l
.
mö_‰esh
 = 
∑r£r
->
_acc
;

1996 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_MIN_FRESH
;

1997 
∑r£r
->
_acc
 = 0;

1998 
	`__FSM_I_MOVE_n
(
Req_I_EoT
, 
__fsm_n
);

2001 
	`__FSM_STATE
(
Req_I_CC_MaxSèÀ
) {

2002 i‡(
c
 == '=')

2003 
	`__FSM_I_MOVE
(
Req_I_CC_MaxSèÀV
);

2004 
ªq
->
ˇche_˘l
.
max_°Æe
 = 
UINT_MAX
;

2005 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_MAX_STALE
;

2006 
	`__FSM_I_MOVE_n
(
Req_I_EoT
, 0);

2009 
	`__FSM_STATE
(
Req_I_CC_MaxSèÀV
) {

2010 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2011 
__fsm_n
 = 
	`∑r£_öt_li°
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

2012 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

2013 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

2014 i‡(
__fsm_n
 < 0) {

2015 i‡(
__fsm_n
 !
CSTR_BADLEN
)

2016  
__fsm_n
;

2017 
∑r£r
->
_acc
 = 
UINT_MAX
;

2019 
ªq
->
ˇche_˘l
.
max_°Æe
 = 
∑r£r
->
_acc
;

2020 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_MAX_STALE
;

2021 
∑r£r
->
_acc
 = 0;

2022 
	`__FSM_I_MOVE_n
(
Req_I_EoT
, 
__fsm_n
);

2025 
	`__FSM_STATE
(
Req_I_CC_Ext
) {

2027 
	`__FSM_I_MATCH_MOVE
(
qëokí
, 
Req_I_CC_Ext
);

2028 
c
 = *(
p
 + 
__fsm_sz
);

2029 i‡(
	`IS_WS
(
c
) || c == ',')

2030 
	`__FSM_I_MOVE_n
(
Req_I_EoT
, 
__fsm_sz
 + 1);

2031 i‡(
	`IS_CRLF
(
c
))

2032  
	`__d©a_off
(
p
 + 
__fsm_sz
);

2033  
CSTR_NEQ
;

2037 
	`__FSM_STATE
(
Req_I_EoT
) {

2038 i‡(
	`IS_WS
(
c
) || c == ',')

2039 
	`__FSM_I_MOVE
(
Req_I_EoT
);

2040 i‡(
	`IS_TOKEN
(
c
))

2041 
	`__FSM_I_MOVE_n
(
Req_I_CC
, 0);

2042 i‡(
	`IS_CRLF
(
c
))

2043  
	`__d©a_off
(
p
);

2044  
CSTR_NEQ
;

2048 
d⁄e
:

2049  
r
;

2050 
	}
}

2053 
	$__ªq_∑r£_cookõ
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

2055 
r
 = 
CSTR_NEQ
;

2056 
	`__FSM_DECLARE_VARS
(
hm
);

2065 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2067 
	`__FSM_STATE
(
Req_I_CookõSèπ
) {

2068 
	`__FSM_I_MATCH_MOVE_fixup
(
tokí
, 
Req_I_CookõName
, 
TFW_STR_NAME
);

2073 i‡(
	`likñy
(
__fsm_sz
 && *(
p
 + __fsm_sz) == '='))

2074 
	`__FSM_I_MOVE_fixup
(
Req_I_CookõVÆ
, 
__fsm_sz
 + 1,

2075 
TFW_STR_NAME
);

2076  
CSTR_NEQ
;

2083 
	`__FSM_STATE
(
Req_I_CookõName
) {

2084 
	`__FSM_I_MATCH_MOVE_fixup
(
tokí
, 
Req_I_CookõName
, 
TFW_STR_NAME
);

2085 i‡(*(
p
 + 
__fsm_sz
) != '=')

2086  
CSTR_NEQ
;

2088 
	`__FSM_I_MOVE_fixup
(
Req_I_CookõVÆ
, 
__fsm_sz
 + 1, 
TFW_STR_NAME
);

2095 
	`__FSM_STATE
(
Req_I_CookõVÆ
) {

2096 
	`__FSM_I_MATCH_MOVE_fixup
(
cookõ
, 
Req_I_CookõVÆ
, 
TFW_STR_VALUE
);

2097 
c
 = *(
p
 + 
__fsm_sz
);

2098 i‡(
c
 == ';') {

2099 i‡(
	`likñy
(
__fsm_sz
)) {

2101 
	`__msg_hdr_chunk_fixup
(
p
, 
__fsm_sz
);

2102 
	`__FSM_I_chunk_Êags
(
TFW_STR_VALUE
);

2104 
	`__FSM_I_MOVE_n
(
Req_I_CookõSemicﬁ⁄
, 
__fsm_sz
);

2106 i‡(
	`u∆ikñy
(
	`IS_CRLFWS
(
c
))) {

2108 i‡(
	`likñy
(
__fsm_sz
)) {

2109 
	`__msg_hdr_chunk_fixup
(
p
, 
__fsm_sz
);

2110 
	`__FSM_I_chunk_Êags
(
TFW_STR_VALUE
);

2112  
	`__d©a_off
(
p
 + 
__fsm_sz
);

2114  
CSTR_NEQ
;

2118 
	`__FSM_STATE
(
Req_I_CookõSemicﬁ⁄
) {

2123 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 2))) {

2124 i‡(
	`likñy
(*(
p
 + 1) == ' '))

2125 
	`__FSM_I_MOVE_fixup
(
Req_I_CookõSèπ
, 2, 0);

2126  
CSTR_NEQ
;

2132 
	`__FSM_I_MOVE_fixup
(
Req_I_CookõSP
, 1, 0);

2135 
	`__FSM_STATE
(
Req_I_CookõSP
) {

2136 i‡(
	`u∆ikñy
(
c
 != ' '))

2137  
CSTR_NEQ
;

2139 
	`__FSM_I_MOVE_fixup
(
Req_I_CookõSèπ
, 1, 0);

2143 
d⁄e
:

2144  
r
;

2145 
	}
}

2147 
	#__FSM_TX_ETAG
(
°
, 
ch
, 
°_√xt
) \

2148 
	`__FSM_STATE
(
°
) { \

2149 i‡(
	`likñy
(
c
 =(
ch
))) \

2150 
	`__FSM_I_MOVE_fixup
(
°_√xt
, 1, 0); \

2151  
CSTR_NEQ
; \

2152 }

	)

2158 
	$__∑r£_ëag
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

2160 
wók
, 
r
 = 
CSTR_NEQ
;

2161 
	`__FSM_DECLARE_VARS
(
hm
);

2172 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2174 
	`__FSM_STATE
(
I_Eèg
) {

2175 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
hm
;

2177 i‡(
	`likñy
(
c
 == '"')) {

2178 i‡(
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_C t
)

2179 
ªq
->
c⁄d
.
Êags
 |
TFW_HTTP_COND_ETAG_LIST
;

2180 
	`__FSM_I_MOVE_fixup
(
I_Eèg_VÆ
, 1, 0);

2183 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 3))

2184 && (*
p
 == 'W') && (*(p + 1) == '/') && (*(p + 2) == '"'))

2186 
	`__FSM_I_MOVE_fixup
(
I_Eèg_Wók
, 3, 0);

2188 i‡(
c
 == 'W')

2189 
	`__FSM_I_MOVE_fixup
(
I_Eèg_W
, 1, 0);

2191 i‡((
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_C t
Ë&& 
c
 == '*') {

2192 i‡(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_ETAG_LIST
)

2193  
CSTR_NEQ
;

2195 
ªq
->
c⁄d
.
Êags
 |
TFW_HTTP_COND_ETAG_ANY
;

2196 
	`__FSM_I_MOVE_fixup
(
I_EoL
, 1, 0);

2199 i‡(
	`IS_WS
(
c
))

2200 
	`__FSM_I_MOVE_fixup
(
I_Eèg
, 1, 0);

2201  
CSTR_NEQ
;

2204 
	`__FSM_TX_ETAG
(
I_Eèg_W
, '/', 
I_Eèg_We
);

2205 
	`__FSM_TX_ETAG
(
I_Eèg_We
, '"', 
I_Eèg_Wók
);

2212 
	`__FSM_STATE
(
I_Eèg_Wók
) {

2213 
∑r£r
->
hdr
.
Êags
 |
TFW_STR_ETAG_WEAK
;

2214 
	`__FSM_JMP
(
I_Eèg_VÆ
);

2221 
	`__FSM_STATE
(
I_Eèg_VÆ
) {

2222 
wók
 = 
∑r£r
->
hdr
.
Êags
 & 
TFW_STR_ETAG_WEAK
;

2223 
	`__FSM_I_MATCH_MOVE_fixup
(
tokí
, 
I_Eèg_VÆ
,

2224 (
TFW_STR_VALUE
 | 
wók
));

2225 
c
 = *(
p
 + 
__fsm_sz
);

2226 i‡(
	`likñy
(
c
 == '"')) {

2227 
∑r£r
->
hdr
.
Êags
 &~
TFW_STR_ETAG_WEAK
;

2228 
	`__FSM_I_MOVE_fixup
(
I_EoT
, 
__fsm_sz
 + 1,

2229 
TFW_STR_VALUE
 | 
wók
);

2231  
CSTR_NEQ
;

2235 
	`__FSM_STATE
(
I_EoT
) {

2236 i‡(
	`IS_WS
(
c
))

2237 
	`__FSM_I_MOVE_fixup
(
I_EoT
, 1, 0);

2238 i‡(
	`IS_CRLF
(
c
))

2239  
	`__d©a_off
(
p
);

2240 i‡((
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_C t
Ë&& 
c
 == ',')

2241 
	`__FSM_I_MOVE_fixup
(
I_Eèg
, 1, 0);

2242  
CSTR_NEQ
;

2245 
	`__FSM_STATE
(
I_EoL
) {

2246 i‡(
	`IS_WS
(
c
))

2247 
	`__FSM_I_MOVE_fixup
(
I_EoL
, 1, 0);

2248 i‡(
	`IS_CRLF
(
c
))

2249  
	`__d©a_off
(
p
);

2250  
CSTR_NEQ
;

2253 
d⁄e
:

2254  
r
;

2255 
	}
}

2264 
	$__ªq_∑r£_ho°
(
TfwHâpReq
 *
ªq
, *
d©a
, 
size_t
 
Àn
)

2266 
r
 = 
CSTR_NEQ
;

2267 
	`__FSM_DECLARE_VARS
(
ªq
);

2269 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2271 
	`__FSM_STATE
(
Req_I_H_Sèπ
) {

2272 i‡(
	`likñy
(
	`iß um
(
c
) || c == '.' || c == '-'))

2273 
	`__FSM_I_MOVE
(
Req_I_H
);

2274 i‡(
	`likñy
(
c
 == '['))

2275 
	`__FSM_I_MOVE
(
Req_I_H_v6
);

2276 i‡(
	`u∆ikñy
(
	`IS_CRLFWS
(
c
)))

2278  
CSTR_NEQ
;

2281 
	`__FSM_STATE
(
Req_I_H
) {

2283 i‡(
	`likñy
(
	`iß um
(
c
) || c == '.' || c == '-'))

2284 
	`__FSM_I_MOVE
(
Req_I_H
);

2285 i‡(
c
 == ':')

2286 
	`__FSM_I_MOVE
(
Req_I_H_P‹t
);

2287 i‡(
	`IS_CRLFWS
(
c
))

2288  
	`__d©a_off
(
p
);

2289  
CSTR_NEQ
;

2292 
	`__FSM_STATE
(
Req_I_H_v6
) {

2294 i‡(
	`likñy
(
	`isxdigô
(
c
) || c == ':'))

2295 
	`__FSM_I_MOVE
(
Req_I_H_v6
);

2296 i‡(
	`likñy
(
c
 == ']'))

2297 
	`__FSM_I_MOVE
(
Req_I_H_v6_End
);

2298  
CSTR_NEQ
;

2301 
	`__FSM_STATE
(
Req_I_H_v6_End
) {

2302 i‡(
	`likñy
(
	`IS_CRLFWS
(
c
)))

2303  
	`__d©a_off
(
p
);

2304 i‡(
	`likñy
(
c
 == ':'))

2305 
	`__FSM_I_MOVE
(
Req_I_H_P‹t
);

2306  
CSTR_NEQ
;

2309 
	`__FSM_STATE
(
Req_I_H_P‹t
) {

2311 i‡(
	`likñy
(
	`isdigô
(
c
)))

2312 
	`__FSM_I_MOVE
(
Req_I_H_P‹t
);

2313 i‡(
	`IS_CRLFWS
(
c
))

2314  
	`__d©a_off
(
p
);

2315  
CSTR_NEQ
;

2319 
d⁄e
:

2320  
r
;

2321 
	}
}

2324 
	$__ªq_∑r£_ª„ªr
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

2326 
r
 = 
CSTR_NEQ
;

2327 
	`__FSM_DECLARE_VARS
(
hm
);

2329 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2331 
	`__FSM_STATE
(
Req_I_Re„ªr
) {

2332 
	`__FSM_I_MATCH_MOVE
(
uri
, 
Req_I_Re„ªr
);

2333 i‡(
	`IS_WS
(*(
p
 + 
__fsm_sz
)))

2334 
	`__FSM_I_MOVE_n
(
Req_I_EoT
, 
__fsm_sz
 + 1);

2335 i‡(
	`IS_CRLF
(*(
p
 + 
__fsm_sz
)))

2336  
	`__d©a_off
(
p
 + 
__fsm_sz
);

2337  
CSTR_NEQ
;

2339 
	`__FSM_STATE
(
Req_I_EoT
) {

2340 i‡(
	`IS_WS
(
c
))

2341 
	`__FSM_I_MOVE
(
Req_I_EoT
);

2342 i‡(
	`IS_CRLF
(
c
))

2343  
	`__d©a_off
(
p
);

2344  
CSTR_NEQ
;

2349 
d⁄e
:

2350  
r
;

2351 
	}
}

2362 
	#SEC24H
 (24 * 3600)

	)

2364 
	#SB_FEB
 (31 * 
SEC24H
)

	)

2365 
	#SB_MAR
 (
SB_FEB
 + 28 * 
SEC24H
)

	)

2366 
	#SB_APR
 (
SB_MAR
 + 31 * 
SEC24H
)

	)

2367 
	#SB_MAY
 (
SB_APR
 + 30 * 
SEC24H
)

	)

2368 
	#SB_JUN
 (
SB_MAY
 + 31 * 
SEC24H
)

	)

2369 
	#SB_JUL
 (
SB_JUN
 + 30 * 
SEC24H
)

	)

2370 
	#SB_AUG
 (
SB_JUL
 + 31 * 
SEC24H
)

	)

2371 
	#SB_SEP
 (
SB_AUG
 + 31 * 
SEC24H
)

	)

2372 
	#SB_OCT
 (
SB_SEP
 + 30 * 
SEC24H
)

	)

2373 
	#SB_NOV
 (
SB_OCT
 + 31 * 
SEC24H
)

	)

2374 
	#SB_DEC
 (
SB_NOV
 + 30 * 
SEC24H
)

	)

2376 
	#EPOCH_DAYS
 (1970 * 365 + 1970 / 4 - 1970 / 100 + 1970 / 400)

	)

2379 
	$__yór_day_£cs
(
yór
, 
day_£c
)

2381 
days
 = 
yór
 * 365 + year / 4 - year / 100 + year / 400;

2384 i‡(
yór
 % 4 == 0 && !(year % 100 == 0 && year % 400 != 0))

2385 
day_£c
 +
SEC24H
;

2387 i‡(
days
 < 
EPOCH_DAYS
)

2390  (
days
 - 
EPOCH_DAYS
Ë* 
SEC24H
 + 
day_£c
;

2391 
	}
}

2393 
size_t


2394 
	$__skù_wìkday
(*
p
, 
size_t
 
Àn
)

2396 
lc
, *
c
, *
íd
 = 
p
 + 
Àn
;

2398 
c
 = 
p
; c < 
íd
; ++c) {

2399 
lc
 = 
	`TFW_LC
(*
c
);

2400 i‡(()(
lc
 - 'a') > ()('z' - 'a') &&Üc != ',')

2401  (*
c
 !' 'Ë? 
CSTR_NEQ
 : c - 
p
;

2403  
Àn
;

2404 
	}
}

2407 
	$__∑r£_hâp_d©e
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

2409 c⁄° 
cﬁ⁄_a
[] 
____ˇchñöe_Æig√d
 = {

2413 
r
 = 
CSTR_NEQ
;

2414 
TfwHâpRe•
 *
ª•
 = (TfwHâpRe• *)
hm
;

2415 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
hm
;

2416 
	`__FSM_DECLARE_VARS
(
hm
);

2418 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2420 
	`__FSM_STATE
(
I_D©e
) {

2421 
∑r£r
->
°©e
) {

2422 
Re•_HdrExpúesV
:

2427 i‡(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_HDR_EXPIRES
)

2428 
	`__FSM_I_MOVE_n
(
I_EoL
, 0);

2430 
Re•_HdrD©eV
:

2431 i‡(
ª•
->
Êags
 & 
TFW_HTTP_F_HDR_DATE
)

2432  
CSTR_NEQ
;

2434 
Re•_HdrLa°_ModifõdV
:

2435 i‡(
ª•
->
Êags
 & 
TFW_HTTP_F_HDR_LMODIFIED
)

2436  
CSTR_NEQ
;

2438 
Req_HdrIf_Modifõd_Sö˚V
:

2439 i‡(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_IF_MSINCE
)

2440  
CSTR_NEQ
;

2443 
	`TFW_DBG2
("%s: Unknown date header, caller's FSM "

2445 
__func__
, 
∑r£r
->
°©e
);

2446 
	`BUG
();

2447  
CSTR_NEQ
;

2453 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2454 
__fsm_n
 = 
	`__skù_wìkday
(
p
, 
__fsm_sz
);

2455 i‡(
__fsm_sz
 =
__fsm_n
)

2456 
	`__FSM_I_MOVE_n
(
I_D©e
, 
__fsm_sz
);

2457 i‡(
	`u∆ikñy
(
__fsm_n
 =
CSTR_NEQ
))

2458  
CSTR_NEQ
;

2459 
	`__FSM_I_MOVE_n
(
I_D©eDay
, 
__fsm_n
 + 1);

2462 
	`__FSM_STATE
(
I_D©eDay
) {

2463 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2465 
__fsm_n
 = 
	`∑r£_öt_ws
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

2466 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

2467 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

2468 i‡(
__fsm_n
 < 0)

2469  
__fsm_n
;

2470 i‡(
∑r£r
->
_acc
 < 1 ||Öarser->_acc > 31)

2471  
CSTR_BADLEN
;

2473 
∑r£r
->
_d©e
 = (∑r£r->
_acc
 - 1Ë* 
SEC24H
;

2474 
∑r£r
->
_acc
 = 0;

2475 
	`__FSM_I_MOVE_n
(
I_D©eM⁄thSP
, 
__fsm_n
);

2478 
	`__FSM_STATE
(
I_D©eM⁄thSP
) {

2479 i‡(
	`likñy
(
c
 == ' '))

2480 
	`__FSM_I_MOVE
(
I_D©eM⁄th
);

2481  
CSTR_NEQ
;

2484 
	`__FSM_STATE
(
I_D©eM⁄th
) {

2485 
c
) {

2487 
	`__FSM_I_MOVE_n
(
I_D©eM⁄th_A
, 0);

2489 
	`__FSM_I_MOVE_n
(
I_D©eM⁄th_J
, 0);

2491 
	`__FSM_I_MOVE_n
(
I_D©eM⁄th_M
, 0);

2493 
	`__FSM_I_MOVE_n
(
I_D©eM⁄th_Othî
, 0);

2496 
	`__FSM_STATE
(
I_D©eM⁄th_A
) {

2497 
	`TRY_STR_LAMBDA
("apr", {

2498 
∑r£r
->
_d©e
 +
SB_APR
;

2499 }, 
I_D©eYórSP
);

2500 
	`TRY_STR_LAMBDA
("aug", {

2501 
∑r£r
->
_d©e
 +
SB_AUG
;

2502 }, 
I_D©eYórSP
);

2503 
	`TRY_STR_INIT
();

2504  
CSTR_NEQ
;

2507 
	`__FSM_STATE
(
I_D©eM⁄th_J
) {

2508 
	`TRY_STR
("j™", 
I_D©eYórSP
);

2509 
	`TRY_STR_LAMBDA
("jun", {

2510 
∑r£r
->
_d©e
 +
SB_JUN
;

2511 }, 
I_D©eYórSP
);

2512 
	`TRY_STR_LAMBDA
("jul", {

2513 
∑r£r
->
_d©e
 +
SB_JUL
;

2514 }, 
I_D©eYórSP
);

2515 
	`TRY_STR_INIT
();

2516  
CSTR_NEQ
;

2519 
	`__FSM_STATE
(
I_D©eM⁄th_M
) {

2520 
	`TRY_STR_LAMBDA
("mar", {

2522 
∑r£r
->
_d©e
 +
SB_MAR
;

2523 }, 
I_D©eYórSP
);

2524 
	`TRY_STR_LAMBDA
("may", {

2525 
∑r£r
->
_d©e
 +
SB_MAY
;

2526 }, 
I_D©eYórSP
);

2527 
	`TRY_STR_INIT
();

2528  
CSTR_NEQ
;

2531 
	`__FSM_STATE
(
I_D©eM⁄th_Othî
) {

2532 
	`TRY_STR_LAMBDA
("feb", {

2533 
∑r£r
->
_d©e
 +
SB_FEB
;

2534 }, 
I_D©eYórSP
);

2535 
	`TRY_STR_LAMBDA
("sep", {

2536 
∑r£r
->
_d©e
 +
SB_SEP
;

2537 }, 
I_D©eYórSP
);

2538 
	`TRY_STR_LAMBDA
("oct", {

2539 
∑r£r
->
_d©e
 +
SB_OCT
;

2540 }, 
I_D©eYórSP
);

2541 
	`TRY_STR_LAMBDA
("nov", {

2542 
∑r£r
->
_d©e
 +
SB_NOV
;

2543 }, 
I_D©eYórSP
);

2544 
	`TRY_STR_LAMBDA
("dec", {

2545 
∑r£r
->
_d©e
 +
SB_DEC
;

2546 }, 
I_D©eYórSP
);

2547 
	`TRY_STR_INIT
();

2548  
CSTR_NEQ
;

2552 
	`__FSM_STATE
(
I_D©eYórSP
) {

2553 i‡(
c
 == ' ')

2554 
	`__FSM_I_MOVE
(
I_D©eYór
);

2555  
CSTR_NEQ
;

2559 
	`__FSM_STATE
(
I_D©eYór
) {

2560 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2561 
__fsm_n
 = 
	`∑r£_öt_ws
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

2562 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

2563 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

2564 i‡(
__fsm_n
 < 0)

2565  
__fsm_n
;

2566 
∑r£r
->
_d©e
 = 
	`__yór_day_£cs
’¨£r->
_acc
,Öarser->_date);

2567 i‡(
∑r£r
->
_d©e
 < 0)

2568  
CSTR_NEQ
;

2569 
∑r£r
->
_acc
 = 0;

2570 
	`__FSM_I_MOVE_n
(
I_D©eHourSP
, 
__fsm_n
);

2573 
	`__FSM_STATE
(
I_D©eHourSP
) {

2574 i‡(
	`likñy
(
c
 == ' '))

2575 
	`__FSM_I_MOVE
(
I_D©eHour
);

2576  
CSTR_NEQ
;

2579 
	`__FSM_STATE
(
I_D©eHour
) {

2580 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2581 
__fsm_n
 = 
	`∑r£_öt_a
(
p
, 
__fsm_sz
, 
cﬁ⁄_a
, &
∑r£r
->
_acc
);

2582 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

2583 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

2584 i‡(
__fsm_n
 < 0)

2585  
__fsm_n
;

2586 
∑r£r
->
_d©e
 +∑r£r->
_acc
 * 3600;

2587 
∑r£r
->
_acc
 = 0;

2588 
	`__FSM_I_MOVE_n
(
I_D©eMöC 
, 
__fsm_n
);

2591 
	`__FSM_STATE
(
I_D©eMöC 
) {

2592 i‡(
	`likñy
(
c
 == ':'))

2593 
	`__FSM_I_MOVE
(
I_D©eMö
);

2594  
CSTR_NEQ
;

2597 
	`__FSM_STATE
(
I_D©eMö
) {

2598 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2599 
__fsm_n
 = 
	`∑r£_öt_a
(
p
, 
__fsm_sz
, 
cﬁ⁄_a
, &
∑r£r
->
_acc
);

2600 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

2601 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

2602 i‡(
__fsm_n
 < 0)

2603  
__fsm_n
;

2604 
∑r£r
->
_d©e
 +∑r£r->
_acc
 * 60;

2605 
∑r£r
->
_acc
 = 0;

2606 
	`__FSM_I_MOVE_n
(
I_D©eSecC 
, 
__fsm_n
);

2609 
	`__FSM_STATE
(
I_D©eSecC 
) {

2610 i‡(
	`likñy
(
c
 == ':'))

2611 
	`__FSM_I_MOVE
(
I_D©eSec
);

2612  
CSTR_NEQ
;

2615 
	`__FSM_STATE
(
I_D©eSec
) {

2616 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2617 
__fsm_n
 = 
	`∑r£_öt_ws
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

2618 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

2619 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

2620 i‡(
__fsm_n
 < 0)

2621  
__fsm_n
;

2622 
∑r£r
->
_d©e
 +∑r£r->
_acc
;

2623 
∑r£r
->
_acc
 = 0;

2624 
	`__FSM_I_MOVE_n
(
I_D©eSecSP
, 
__fsm_n
);

2627 
	`__FSM_STATE
(
I_D©eSecSP
) {

2628 i‡(
	`likñy
(
c
 == ' '))

2629 
	`__FSM_I_MOVE
(
I_D©eZ⁄e
);

2630  
CSTR_NEQ
;

2633 
	`__FSM_STATE
(
I_D©eZ⁄e
) {

2634 
	`TRY_STR
("gmt", 
I_EoL
);

2635 
	`TRY_STR_INIT
();

2636  
CSTR_NEQ
;

2639 
	`__FSM_STATE
(
I_EoL
) {

2641 
	`__FSM_I_MATCH_MOVE
(
n˘l
, 
I_EoL
);

2642 i‡(!
	`IS_CRLF
(*(
p
 + 
__fsm_sz
)))

2643  
CSTR_NEQ
;

2644 
	`TFW_DBG3
("%s:Ö¨£d d©ê%lu", 
__func__
, 
∑r£r
->
_d©e
);

2645 
∑r£r
->
°©e
) {

2646 
Re•_HdrExpúesV
:

2647 
ª•
->
ˇche_˘l
.
expúes
 = 
∑r£r
->
_d©e
;

2648 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_HDR_EXPIRES
;

2650 
Re•_HdrD©eV
:

2651 
ª•
->
d©e
 = 
∑r£r
->
_d©e
;

2652 
ª•
->
Êags
 |
TFW_HTTP_F_HDR_DATE
;

2654 
Re•_HdrLa°_ModifõdV
:

2655 
ª•
->
œ°_modifõd
 = 
∑r£r
->
_d©e
;

2656 
ª•
->
Êags
 |
TFW_HTTP_F_HDR_LMODIFIED
;

2658 
Req_HdrIf_Modifõd_Sö˚V
:

2659 
ªq
->
c⁄d
.
m_d©e
 = 
∑r£r
->
_d©e
;

2660 
ªq
->
c⁄d
.
Êags
 |
TFW_HTTP_COND_IF_MSINCE
;

2663  
	`__d©a_off
(
p
 + 
__fsm_sz
);

2667 
d⁄e
:

2668  
r
;

2669 
	}
}

2677 
	$__ªq_∑r£_if_msö˚
(
TfwHâpMsg
 *
msg
, *
d©a
, 
size_t
 
Àn
)

2679 
ªt
;

2680 
ªt
 = 
	`__∑r£_hâp_d©e
(
msg
, 
d©a
, 
Àn
);

2681 i‡(
ªt
 < 
CSTR_POSTPONE
) {

2683 
	`BUG_ON
(
msg
->
∑r£r
.
°©e
 !
Req_HdrIf_Modifõd_Sö˚V
);

2684 
msg
->
∑r£r
.
_d©e
 = 0;

2685 
msg
->
∑r£r
.
_i_°
 = 
I_EoL
;

2686 
ªt
 = 
	`__∑r£_hâp_d©e
(
msg
, 
d©a
, 
Àn
);

2688  
ªt
;

2689 
	}
}

2696 
	$__ªq_∑r£_¥agma
(
TfwHâpReq
 *
ªq
, *
d©a
, 
size_t
 
Àn
)

2698 
r
 = 
CSTR_NEQ
;

2699 
	`__FSM_DECLARE_VARS
(
ªq
);

2701 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2703 
	`__FSM_STATE
(
Req_I_Pøgma
) {

2704 
	`TRY_STR_LAMBDA
("no-cache", {

2705 
ªq
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_PRAGMA_NO_CACHE
;

2706 }, 
Req_I_Pøgma_Ext
);

2707 
	`TRY_STR_INIT
();

2708 
	`__FSM_I_MOVE_n
(
Req_I_Pøgma_Ext
, 0);

2711 
	`__FSM_STATE
(
Req_I_Pøgma_Ext
) {

2713 
	`__FSM_I_MATCH_MOVE
(
qëokí
, 
Req_I_Pøgma_Ext
);

2714 
c
 = *(
p
 + 
__fsm_sz
);

2715 i‡(
	`IS_WS
(
c
) || c == ',')

2716 
	`__FSM_I_MOVE_n
(
Req_I_EoT
, 
__fsm_sz
 + 1);

2717 i‡(
	`IS_CRLF
(
c
))

2718  
	`__d©a_off
(
p
 + 
__fsm_sz
);

2719  
CSTR_NEQ
;

2723 
	`__FSM_STATE
(
Req_I_EoT
) {

2724 i‡(
	`IS_WS
(
c
) || c == ',')

2725 
	`__FSM_I_MOVE
(
Req_I_EoT
);

2726 i‡(
	`IS_CRLF
(
c
))

2727  
	`__d©a_off
(
p
);

2728 
	`__FSM_I_MOVE_n
(
Req_I_Pøgma_Ext
, 0);

2732 
d⁄e
:

2733  
r
;

2734 
	}
}

2737 
	$__ªq_∑r£_u£r_agít
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

2739 
r
 = 
CSTR_NEQ
;

2740 
	`__FSM_DECLARE_VARS
(
hm
);

2742 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2744 
	`__FSM_STATE
(
Req_I_U£rAgít
) {

2753 
	`__FSM_I_MATCH_MOVE
(
˘ext_vch¨
, 
Req_I_U£rAgít
);

2754 i‡(
	`IS_CRLF
(*(
p
 + 
__fsm_sz
)))

2755  
	`__d©a_off
(
p
 + 
__fsm_sz
);

2756  
CSTR_NEQ
;

2761 
d⁄e
:

2762  
r
;

2763 
	}
}

2769 
	$__ªq_∑r£_x_f‹w¨ded_f‹
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

2771 
r
 = 
CSTR_NEQ
;

2772 
	`__FSM_DECLARE_VARS
(
hm
);

2774 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2776 
	`__FSM_STATE
(
Req_I_XFF
) {

2778 i‡(
	`u∆ikñy
(
	`IS_WS
(
c
)))

2779 
	`__FSM_I_MOVE
(
Req_I_XFF
);

2787 
	`__FSM_I_MATCH_MOVE
(
xff
, 
Req_I_XFF_Node_Id
);

2788 i‡(
	`u∆ikñy
(!
__fsm_sz
))

2789  
CSTR_NEQ
;

2790 
	`__FSM_I_MOVE_n
(
Req_I_XFF_Sï
, 
__fsm_sz
);

2797 
	`__FSM_STATE
(
Req_I_XFF_Node_Id
) {

2798 
	`__FSM_I_MATCH_MOVE
(
xff
, 
Req_I_XFF_Node_Id
);

2799 
	`__FSM_I_MOVE_n
(
Req_I_XFF_Sï
, 
__fsm_sz
);

2802 
	`__FSM_STATE
(
Req_I_XFF_Sï
) {

2807 i‡(
	`likñy
(
	`IS_CRLF
(
c
)))

2808  
	`__d©a_off
(
p
);

2811 i‡(
	`u∆ikñy
(
	`IS_WS
(
c
)))

2812 
	`__FSM_I_MOVE
(
Req_I_XFF_Sï
);

2818 i‡(
	`likñy
(
c
 == ','))

2819 
	`__FSM_I_MOVE
(
Req_I_XFF
);

2821  
CSTR_NEQ
;

2825 
d⁄e
:

2826  
r
;

2827 
	}
}

2830 
	$__∑r£_kìp_Æive
(
TfwHâpMsg
 *
hm
, *
d©a
, 
size_t
 
Àn
)

2832 
r
 = 
CSTR_NEQ
;

2833 
	`__FSM_DECLARE_VARS
(
hm
);

2835 
	`__FSM_START
(
∑r£r
->
_i_°
) {

2837 
	`__FSM_STATE
(
I_KìpAlive
) {

2838 
	`TRY_STR
("timeout=", 
I_KìpAliveTO
);

2839 
	`TRY_STR_INIT
();

2840 
	`__FSM_I_MOVE_n
(
I_KìpAliveExt
, 0);

2843 
	`__FSM_STATE
(
I_KìpAliveTO
) {

2844 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

2845 
__fsm_n
 = 
	`∑r£_öt_li°
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

2846 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

2847 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

2848 i‡(
__fsm_n
 < 0)

2849  
__fsm_n
;

2850 
hm
->
kìp_Æive
 = 
∑r£r
->
_acc
;

2851 
∑r£r
->
_acc
 = 0;

2852 
	`__FSM_I_MOVE_n
(
I_EoT
, 
__fsm_n
);

2859 
	`__FSM_STATE
(
I_KìpAliveExt
) {

2860 
	`__FSM_I_MATCH_MOVE
(
qëokí
, 
I_KìpAliveExt
);

2861 
c
 = *(
p
 + 
__fsm_sz
);

2862 i‡(
	`IS_WS
(
c
) || c == ',')

2863 
	`__FSM_I_MOVE_n
(
I_EoT
, 
__fsm_sz
 + 1);

2864 i‡(
	`IS_CRLF
(
c
))

2865  
	`__d©a_off
(
p
 + 
__fsm_sz
);

2866  
CSTR_NEQ
;

2870 
	`__FSM_STATE
(
I_EoT
) {

2871 i‡(
	`IS_WS
(
c
) || c == ',')

2872 
	`__FSM_I_MOVE
(
I_EoT
);

2873 i‡(
c
 == '=')

2874 
	`__FSM_I_MOVE
(
I_KìpAliveExt
);

2875 i‡(
	`IS_TOKEN
(
c
))

2876 
	`__FSM_I_MOVE_n
(
I_KìpAlive
, 0);

2877 i‡(
	`IS_CRLF
(
c
))

2878  
	`__d©a_off
(
p
);

2879  
CSTR_NEQ
;

2883 
d⁄e
:

2884  
r
;

2885 
	}
}

2890 
ölöe
 

2891 
	$__∑r£r_öô
(
TfwHâpP¨£r
 *
∑r£r
)

2893 
∑r£r
->
to_ªad
 = -1;

2894 
	}
}

2897 
	$tfw_hâp_öô_∑r£r_ªq
(
TfwHâpReq
 *
ªq
)

2899 
TfwHâpHbhHdrs
 *
hbh_hdrs
 = &
ªq
->
∑r£r
.
hbh_∑r£r
;

2901 
	`__∑r£r_öô
(&
ªq
->
∑r£r
);

2902 
ªq
->
∑r£r
.
°©e
 = 
Req_0
;

2905 
	`BUG_ON
(
hbh_hdrs
->
•ec
);

2907 
hbh_hdrs
->
•ec
 = 0x1 << 
TFW_HTTP_HDR_CONNECTION
;

2908 
	}
}

2911 
	$tfw_hâp_∑r£_ªq
(*
ªq_d©a
, *
d©a
, 
size_t
 
Àn
,

2912 *
∑r£d
)

2914 
r
 = 
TFW_BLOCK
;

2915 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
ªq_d©a
;

2916 
	`__FSM_DECLARE_VARS
(
ªq
);

2917 *
∑r£d
 = 0;

2919 
	`TFW_DBG
("parse %lu client data bytes (%.*s%s) onÑeq=%p\n",

2920 
Àn
, 
	`mö
(500, (Óí), 
d©a
,Üí > 500 ? "..." : "", 
ªq
);

2922 
	`__FSM_START
(
∑r£r
->
°©e
) {

2927 
	`__FSM_STATE
(
Req_0
) {

2928 i‡(
	`u∆ikñy
(
	`IS_CRLF
(
c
)))

2929 
	`__FSM_MOVE_nofixup
(
Req_0
);

2934 
	`__FSM_STATE
(
Req_Mëhod
) {

2936 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 4))) {

2937 *(*)
p
) {

2939 
	`TFW_CHAR4_INT
('G', 'E', 'T', ' '):

2940 
ªq
->
mëhod
 = 
TFW_HTTP_METH_GET
;

2941 
	`__FSM_MOVE_nofixup_n
(
Req_Uri
, 4);

2942 
	`TFW_CHAR4_INT
('H', 'E', 'A', 'D'):

2943 
ªq
->
mëhod
 = 
TFW_HTTP_METH_HEAD
;

2944 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 4);

2945 
	`TFW_CHAR4_INT
('P', 'O', 'S', 'T'):

2946 
ªq
->
mëhod
 = 
TFW_HTTP_METH_POST
;

2947 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 4);

2949 
	`TFW_CHAR4_INT
('P', 'U', 'R', 'G'):

2950 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5))

2951 && (*(
p
 + 4) == 'E'))

2953 
ªq
->
mëhod
 = 
TFW_HTTP_METH_PURGE
;

2954 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 5);

2956 
	`__FSM_MOVE_nofixup_n
(
Req_MëhPurg
, 4);

2962 
	`TFW_CHAR4_INT
('C', 'O', 'P', 'Y'):

2963 
ªq
->
mëhod
 = 
TFW_HTTP_METH_COPY
;

2964 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 4);

2965 
	`TFW_CHAR4_INT
('D', 'E', 'L', 'E'):

2966 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 6))

2967 && (*(
p
 + 4) == 'T') && (*(p + 5) == 'E'))

2969 
ªq
->
mëhod
 = 
TFW_HTTP_METH_DELETE
;

2970 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 6);

2972 
	`__FSM_MOVE_nofixup_n
(
Req_MëhDñe
, 4);

2973 
	`TFW_CHAR4_INT
('L', 'O', 'C', 'K'):

2974 
ªq
->
mëhod
 = 
TFW_HTTP_METH_LOCK
;

2975 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 4);

2976 
	`TFW_CHAR4_INT
('M', 'K', 'C', 'O'):

2977 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5))

2978 && (*(
p
 + 4) == 'L'))

2980 
ªq
->
mëhod
 = 
TFW_HTTP_METH_MKCOL
;

2981 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 5);

2983 
	`__FSM_MOVE_nofixup_n
(
Req_MëhMkco
, 4);

2984 
	`TFW_CHAR4_INT
('M', 'O', 'V', 'E'):

2985 
ªq
->
mëhod
 = 
TFW_HTTP_METH_MOVE
;

2986 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 4);

2987 
	`TFW_CHAR4_INT
('O', 'P', 'T', 'I'):

2988 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 8))

2989 && (*((*)
p
 + 1)

2990 =
	`TFW_CHAR4_INT
('O', 'N', 'S', ' ')))

2992 
ªq
->
mëhod
 = 
TFW_HTTP_METH_OPTIONS
;

2993 
	`__FSM_MOVE_nofixup_n
(
Req_Uri
, 8);

2995 
	`__FSM_MOVE_nofixup_n
(
Req_MëhO±i
, 4);

2996 
	`TFW_CHAR4_INT
('P', 'A', 'T', 'C'):

2997 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5))

2998 && (*(
p
 + 4) == 'H'))

3000 
ªq
->
mëhod
 = 
TFW_HTTP_METH_PATCH
;

3001 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 5);

3003 
	`__FSM_MOVE_nofixup_n
(
Req_MëhP©c
, 4);

3004 
	`TFW_CHAR4_INT
('P', 'R', 'O', 'P'):

3005 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 8))

3006 && (*((*)
p
 + 1)

3007 =
	`TFW_CHAR4_INT
('F', 'I', 'N', 'D')))

3009 
ªq
->
mëhod
 = 
TFW_HTTP_METH_PROPFIND
;

3010 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 8);

3012 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 9))

3013 && (*((*)
p
 + 1)

3014 =
	`TFW_CHAR4_INT
('P', 'A', 'T', 'C'))

3015 && (*(
p
 + 8) == 'H'))

3017 
ªq
->
mëhod
 = 
TFW_HTTP_METH_PROPPATCH
;

3018 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 9);

3020 
	`__FSM_MOVE_nofixup_n
(
Req_MëhPr›
, 4);

3021 
	`TFW_CHAR4_INT
('P', 'U', 'T', ' '):

3022 
ªq
->
mëhod
 = 
TFW_HTTP_METH_PUT
;

3023 
	`__FSM_MOVE_nofixup_n
(
Req_Uri
, 4);

3024 
	`TFW_CHAR4_INT
('T', 'R', 'A', 'C'):

3025 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5))

3026 && (*(
p
 + 4) == 'E'))

3028 
ªq
->
mëhod
 = 
TFW_HTTP_METH_TRACE
;

3029 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 5);

3031 
	`__FSM_MOVE_nofixup_n
(
Req_MëhTøc
, 4);

3032 
	`TFW_CHAR4_INT
('U', 'N', 'L', 'O'):

3033 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 6))

3034 && (*(
p
 + 4) == 'C') && (*(p + 5) == 'K'))

3036 
ªq
->
mëhod
 = 
TFW_HTTP_METH_UNLOCK
;

3037 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 6);

3039 
	`__FSM_MOVE_nofixup_n
(
Req_MëhU∆o
, 4);

3041 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
);

3044 
c
) {

3046 
	`__FSM_MOVE_nofixup
(
Req_MëhG
);

3048 
	`__FSM_MOVE_nofixup
(
Req_MëhH
);

3050 
	`__FSM_MOVE_nofixup
(
Req_MëhP
);

3052 
	`__FSM_MOVE_nofixup
(
Req_MëhC
);

3054 
	`__FSM_MOVE_nofixup
(
Req_MëhD
);

3056 
	`__FSM_MOVE_nofixup
(
Req_MëhL
);

3058 
	`__FSM_MOVE_nofixup
(
Req_MëhM
);

3060 
	`__FSM_MOVE_nofixup
(
Req_MëhO
);

3062 
	`__FSM_MOVE_nofixup
(
Req_MëhT
);

3064 
	`__FSM_MOVE_nofixup
(
Req_MëhU
);

3066 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
);

3068 
	`__FSM_STATE
(
Req_MëhodUnknown
) {

3069 
	`__FSM_MATCH_MOVE_nofixup
(
tokí
, 
Req_MëhodUnknown
);

3070 
ªq
->
mëhod
 = 
_TFW_HTTP_METH_UNKNOWN
;

3071 
	`__FSM_MOVE_nofixup_n
(
Req_MUS∑˚
, 0);

3078 
	`__FSM_STATE
(
Req_MUS∑˚
) {

3079 i‡(
	`u∆ikñy
(
c
 != ' '))

3080 
	`TFW_PARSER_BLOCK
(
Req_MUS∑˚
);

3081 
	`__FSM_MOVE_nofixup
(
Req_Uri
);

3084 
	`__FSM_STATE
(
Req_Uri
) {

3085 i‡(
	`likñy
(
c
 == '/')) {

3086 
	`__msg_fõld_›í
(&
ªq
->
uri_∑th
, 
p
);

3087 
	`__FSM_MOVE_f
(
Req_UriAbsP©h
, &
ªq
->
uri_∑th
);

3089 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 7)

3090 && 
	`C4_INT_LCM
(
p
, 'h', 't', 't', 'p')

3091 && *(
p
 + 4) == ':' && *(p + 5) == '/'

3092 && *(
p
 + 6) == '/'))

3093 
	`__FSM_MOVE_nofixup_n
(
Req_UriAuth‹ôySèπ
, 7);

3096 i‡(
	`likñy
(
	`TFW_LC
(
c
) == 'h'))

3097 
	`__FSM_MOVE_nofixup
(
Req_UriSchH
);

3099 
	`TFW_PARSER_BLOCK
(
Req_Uri
);

3111 
	`__FSM_STATE
(
Req_UriAuth‹ôySèπ
) {

3112 
ªq
->
Êags
 |
TFW_HTTP_F_URI_FULL
;

3113 i‡(
	`likñy
(
	`iß um
(
c
) || c == '.' || c == '-')) {

3114 
	`__msg_fõld_›í
(&
ªq
->
ho°
, 
p
);

3115 
	`__FSM_MOVE_f
(
Req_UriAuth‹ôy
, &
ªq
->
ho°
);

3116 } i‡(
	`likñy
(
c
 == '/')) {

3122 
	`TFW_DBG3
("Handling http:///path\n");

3123 
	`tfw_hâp_msg_£t_°r_d©a
(
msg
, &
ªq
->
ho°
, 
p
);

3124 
ªq
->
ho°
.
Êags
 |
TFW_STR_COMPLETE
;

3125 
	`__FSM_MOVE_f
(
Req_UriAbsP©h
, &
ªq
->
uri_∑th
);

3126 } i‡(
c
 == '[') {

3127 
	`__msg_fõld_›í
(&
ªq
->
ho°
, 
p
);

3128 
	`__FSM_MOVE_f
(
Req_UriAuth‹ôyIPv6
, &
ªq
->
ho°
);

3130 
	`TFW_PARSER_BLOCK
(
Req_UriAuth‹ôySèπ
);

3133 
	`__FSM_STATE
(
Req_UriAuth‹ôy
) {

3134 i‡(
	`likñy
(
	`iß um
(
c
) || c == '.' || c == '-' || c == '@')) {

3135 i‡(
	`u∆ikñy
(
c
 == '@')) {

3136 i‡(!
	`TFW_STR_EMPTY
(&
ªq
->
u£röfo
)) {

3137 
	`TFW_DBG
("Second '@' ináuthority\n");

3138 
	`TFW_PARSER_BLOCK
(
Req_UriAuth‹ôy
);

3140 
	`TFW_DBG3
("Authority contains userinfo\n");

3142 
ªq
->
u£röfo
 =Ñeq->
ho°
;

3143 
	`__msg_fõld_föish
(&
ªq
->
u£röfo
, 
p
);

3144 
	`TFW_STR_INIT
(&
ªq
->
ho°
);

3146 
	`__FSM_MOVE_nofixup
(
Req_UriAuth‹ôyRe£tHo°
);

3149 
	`__FSM_MOVE_f
(
Req_UriAuth‹ôy
, &
ªq
->
ho°
);

3151 
	`__FSM_JMP
(
Req_UriAuth‹ôyEnd
);

3154 
	`__FSM_STATE
(
Req_UriAuth‹ôyIPv6
) {

3155 i‡(
	`likñy
(
	`isxdigô
(
c
) || c == ':')) {

3156 
	`__FSM_MOVE_f
(
Req_UriAuth‹ôyIPv6
, &
ªq
->
ho°
);

3157 } if(
c
 == ']') {

3158 
	`__FSM_MOVE_f
(
Req_UriAuth‹ôyEnd
, &
ªq
->
ho°
);

3160 
	`TFW_PARSER_BLOCK
(
Req_UriAuth‹ôyIPv6
);

3163 
	`__FSM_STATE
(
Req_UriAuth‹ôyRe£tHo°
) {

3164 i‡(
	`likñy
(
	`iß um
(
c
) || c == '.' || c == '-')) {

3165 
	`__msg_fõld_›í
(&
ªq
->
ho°
, 
p
);

3166 
	`__FSM_MOVE_f
(
Req_UriAuth‹ôy
, &
ªq
->
ho°
);

3167 } i‡(
c
 == '[') {

3168 
	`__msg_fõld_›í
(&
ªq
->
ho°
, 
p
);

3169 
	`__FSM_MOVE_f
(
Req_UriAuth‹ôyIPv6
, &
ªq
->
ho°
);

3171 
	`__FSM_JMP
(
Req_UriAuth‹ôyEnd
);

3174 
	`__FSM_STATE
(
Req_UriAuth‹ôyEnd
) {

3176 
	`__msg_fõld_föish
(&
ªq
->
ho°
, 
p
);

3177 
	`TFW_DBG3
("UserinfoÜen = %i, hostÜen = %i\n",

3178 ()
ªq
->
u£röfo
.
Àn
, (Ïeq->
ho°
.len);

3179 i‡(
	`likñy
(
c
 == '/')) {

3180 
	`__msg_fõld_›í
(&
ªq
->
uri_∑th
, 
p
);

3181 
	`__FSM_MOVE_f
(
Req_UriAbsP©h
, &
ªq
->
uri_∑th
);

3183 i‡(
c
 == ' ') {

3184 
	`__FSM_MOVE_nofixup
(
Req_HâpVî
);

3186 i‡(
c
 == ':') {

3187 
	`__FSM_MOVE_nofixup
(
Req_UriP‹t
);

3190 
	`TFW_PARSER_BLOCK
(
Req_UriAuth‹ôyEnd
);

3195 
	`__FSM_STATE
(
Req_UriP‹t
) {

3196 i‡(
	`likñy
(
	`isdigô
(
c
)))

3197 
	`__FSM_MOVE_nofixup
(
Req_UriP‹t
);

3198 i‡(
	`likñy
(
c
 == '/')) {

3199 
	`__msg_fõld_›í
(&
ªq
->
uri_∑th
, 
p
);

3200 
	`__FSM_MOVE_f
(
Req_UriAbsP©h
, &
ªq
->
uri_∑th
);

3202 i‡(
c
 == ' ') {

3203 
	`__FSM_MOVE_nofixup
(
Req_HâpVî
);

3206 
	`TFW_PARSER_BLOCK
(
Req_UriP‹t
);

3226 
	`__FSM_STATE
(
Req_UriAbsP©h
) {

3228 i‡(
c
 == ' ') {

3229 
	`__msg_fõld_föish
(&
ªq
->
uri_∑th
, 
p
);

3230 
	`__FSM_MOVE_nofixup
(
Req_HâpVî
);

3232 
	`__FSM_MATCH_MOVE_f
(
uri
, 
TFW_HTTP_URI_HOOK
, &
ªq
->
uri_∑th
);

3233 i‡(
	`u∆ikñy
(*(
p
 + 
__fsm_sz
) != ' '))

3234 
	`TFW_PARSER_BLOCK
(
Req_UriAbsP©h
);

3235 
	`__msg_fõld_föish
(&
ªq
->
uri_∑th
, 
p
 + 
__fsm_sz
);

3236 
	`__FSM_MOVE_nofixup_n
(
Req_HâpVî
, 
__fsm_sz
 + 1);

3240 
	#TFW_HTTP_NORM_URI


	)

3241 
	~"hâp_n‹m.h
"

3242 #unde‡
TFW_HTTP_NORM_URI


3245 
	`__FSM_STATE
(
Req_HâpVî
) {

3246 i‡(
	`u∆ikñy
(!
	`__d©a_avaûabÀ
(
p
, 8))) {

3248 i‡(
c
 == 'H')

3249 
	`__FSM_MOVE_nofixup
(
Req_HâpVîT1
);

3250 
	`TFW_PARSER_BLOCK
(
Req_HâpVî
);

3253 *(*)
p
) {

3254 
	`TFW_CHAR8_INT
('H', 'T', 'T', 'P', '/', '1', '.', '1'):

3255 
ªq
->
vîsi⁄
 = 
TFW_HTTP_VER_11
;

3256 
	`__FSM_MOVE_nofixup_n
(
RGí_EoL
, 8);

3257 
	`TFW_CHAR8_INT
('H', 'T', 'T', 'P', '/', '1', '.', '0'):

3258 
ªq
->
vîsi⁄
 = 
TFW_HTTP_VER_10
;

3259 
	`__FSM_MOVE_nofixup_n
(
RGí_EoL
, 8);

3261 
	`TFW_PARSER_BLOCK
(
Req_HâpVî
);

3272 
	`__FSM_STATE
(
RGí_Hdr
) {

3273 
	`TFW_HTTP_PARSE_CRLF
();

3275 
	`tfw_hâp_msg_hdr_›í
(
msg
, 
p
);

3277 
	`TFW_LC
(
c
)) {

3279 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 7)

3280 && 
	`C4_INT_LCM
(
p
 + 1, 'c', 'c', 'e', 'p')

3281 && 
	`TFW_LC
(*(
p
 + 6)) == 't'

3282 && *(
p
 + 13) == ':'))

3284 
∑r£r
->
_i_°
 = 
Req_HdrAc˚±V
;

3285 
	`__FSM_MOVE_n
(
RGí_OWS
, 7);

3287 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 14)

3288 && 
	`C8_INT_LCM
(
p
 + 1, 'u', 't', 'h', 'o',

3290 && 
	`C4_INT_LCM
(
p
 + 9, 't', 'i', 'o', 'n')

3291 && *(
p
 + 13) == ':'))

3293 
∑r£r
->
_i_°
 = 
Req_HdrAuth‹iz©i⁄V
;

3294 
	`__FSM_MOVE_n
(
RGí_OWS
, 14);

3296 
	`__FSM_MOVE
(
Req_HdrA
);

3299 i‡(
	`u∆ikñy
(!
	`__d©a_avaûabÀ
(
p
, 14)))

3300 
	`__FSM_MOVE
(
Req_HdrC
);

3302 
	`TFW_P2LCINT
(
p
 + 1)) {

3303 
	`TFW_CHAR4_INT
('a', 'c', 'h', 'e'):

3304 i‡(
	`likñy
(*(
p
 + 5) == '-'

3305 && 
	`C8_INT_LCM
(
p
 + 6, 'c', 'o', 'n',

3309 
∑r£r
->
_i_°
 = 
Req_HdrCache_C⁄åﬁV
;

3310 
	`__FSM_MOVE_n
(
RGí_OWS
, 14);

3312 
	`__FSM_MOVE_n
(
RGí_HdrOthî
, 5);

3313 
	`TFW_CHAR4_INT
('o', 'n', 'n', 'e'):

3314 i‡(
	`likñy
(
	`C4_INT_LCM
(
p
 + 5, 'c', 't', 'i', 'o')

3315 && 
	`TFW_LC
(*(
p
 + 9)) == 'n'

3316 && *(
p
 + 10) == ':'))

3318 
∑r£r
->
_i_°
 = 
Req_HdrC⁄√˘i⁄V
;

3319 
	`__FSM_MOVE_n
(
RGí_OWS
, 11);

3321 
	`__FSM_MOVE_n
(
RGí_HdrOthî
, 5);

3322 
	`TFW_CHAR4_INT
('o', 'n', 't', 'e'):

3323 i‡(
	`likñy
(
	`TFW_LC
(*(
p
 + 5)) == 'n'

3324 && 
	`TFW_LC
(*(
p
 + 6)) == 't'

3325 && *(
p
 + 7) == '-'))

3327 
	`__FSM_MOVE_n
(
Req_HdrC⁄ã¡_
, 8);

3329 
	`__FSM_MOVE_n
(
RGí_HdrOthî
, 5);

3330 
	`TFW_CHAR4_INT
('o', 'o', 'k', 'i'):

3331 i‡(
	`likñy
(
	`TFW_LC
(*(
p
 + 5)) == 'e'

3332 && *(
p
 + 6) == ':'))

3334 
∑r£r
->
_i_°
 = 
Req_HdrCookõV
;

3335 
	`__FSM_MOVE_n
(
RGí_OWS
, 7);

3337 
	`__FSM_MOVE_n
(
RGí_HdrOthî
, 5);

3339 
	`__FSM_MOVE
(
RGí_HdrOthî
);

3342 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5)

3343 && 
	`C4_INT_LCM
(
p
 + 1, 'o', 's', 't', ':'))) {

3344 
∑r£r
->
_i_°
 = 
Req_HdrHo°V
;

3345 
∑r£r
->
_hdr_èg
 = 
TFW_HTTP_HDR_HOST
;

3346 
	`__FSM_MOVE_n
(
RGí_OWS
, 5);

3348 
	`__FSM_MOVE
(
Req_HdrH
);

3350 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 18)

3351 && 
	`TFW_LC
(*(
p
 + 1)) == 'f'

3352 && *(
p
 + 2) == '-'

3353 && 
	`C8_INT_LCM
(
p
 + 3, 'm', 'o', 'd', 'i',

3355 && *(
p
 + 11) == '-'

3356 && 
	`C4_INT_LCM
(
p
 + 12, 's', 'i', 'n', 'c')

3357 && 
	`TFW_LC
(*(
p
 + 16)) == 'e'

3358 && *(
p
 + 17) == ':'))

3360 
∑r£r
->
_i_°
 = 
Req_HdrIf_Modifõd_Sö˚V
;

3361 
	`__FSM_MOVE_n
(
RGí_OWS
, 18);

3363 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 14)

3364 && 
	`TFW_LC
(*(
p
 + 1)) == 'f'

3365 && *(
p
 + 2) == '-'

3366 && 
	`C4_INT_LCM
(
p
 + 3, 'n', 'o', 'n', 'e')

3367 && *(
p
 + 7) == '-'

3368 && 
	`C4_INT_LCM
(
p
 + 8, 'm', 'a', 't', 'c')

3369 && 
	`TFW_LC
(*(
p
 + 12)) == 'h'

3370 && *(
p
 + 13) == ':'))

3372 
∑r£r
->
_i_°
 = 
Req_HdrIf_N⁄e_M©chV
;

3373 
	`__FSM_MOVE_n
(
RGí_OWS
, 14);

3375 
	`__FSM_MOVE
(
Req_HdrI
);

3377 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 11)

3378 && 
	`C4_INT_LCM
(
p
, 'k', 'e', 'e', 'p')

3379 && *(
p
 + 4) == '-'

3380 && 
	`C4_INT_LCM
(
p
 + 5, 'a', 'l', 'i', 'v')

3381 && 
	`TFW_LC
(*(
p
 + 9)) == 'e'

3382 && *(
p
 + 10) == ':'))

3384 
∑r£r
->
_i_°
 = 
Req_HdrKìp_AliveV
;

3385 
	`__FSM_MOVE_n
(
RGí_OWS
, 11);

3387 
	`__FSM_MOVE
(
Req_HdrK
);

3389 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 7)

3390 && 
	`C4_INT_LCM
(
p
 + 1, 'r', 'a', 'g', 'm')

3391 && 
	`TFW_LC
(*(
p
 + 5)) == 'a'

3392 && *(
p
 + 6) == ':'))

3394 
∑r£r
->
_i_°
 = 
Req_HdrPøgmaV
;

3395 
	`__FSM_MOVE_n
(
RGí_OWS
, 7);

3397 
	`__FSM_MOVE
(
Req_HdrP
);

3399 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 8)

3400 && 
	`C4_INT_LCM
(
p
 + 1, 'e', 'f', 'e', 'r')

3401 && 
	`TFW_LC
(*(
p
 + 5)) == 'e'

3402 && 
	`TFW_LC
(*(
p
 + 6)) == 'r'

3403 && *(
p
 + 7) == ':'))

3405 
∑r£r
->
_i_°
 = 
Req_HdrRe„ªrV
;

3406 
	`__FSM_MOVE_n
(
RGí_OWS
, 8);

3408 
	`__FSM_MOVE
(
Req_HdrR
);

3410 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 18)

3411 && 
	`C8_INT_LCM
(
p
, 't', 'r', 'a', 'n',

3413 && *(
p
 + 8) == '-'

3414 && 
	`C8_INT_LCM
(
p
 + 9, 'e', 'n', 'c', 'o',

3416 && *(
p
 + 17) == ':'))

3418 
∑r£r
->
_i_°
 = 
Req_HdrTøns„r_EncodögV
;

3419 
	`__FSM_MOVE_n
(
RGí_OWS
, 18);

3421 
	`__FSM_MOVE
(
Req_HdrT
);

3423 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 16)

3424 && *(
p
 + 1) == '-'

3425 && *(
p
 + 11) == '-'

3426 && 
	`C8_INT_LCM
(
p
, 'x', '-', 'f', 'o',

3428 && 
	`C8_INT_LCM
(
p
 + 8, 'd', 'e', 'd', '-',

3431 
∑r£r
->
_i_°
 = 
Req_HdrX_F‹w¨ded_F‹V
;

3432 
	`__FSM_MOVE_n
(
RGí_OWS
, 16);

3434 
	`__FSM_MOVE
(
Req_HdrX
);

3436 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 11)

3437 && 
	`C4_INT_LCM
(
p
, 'u', 's', 'e', 'r')

3438 && *(
p
 + 4) == '-'

3439 && 
	`C4_INT_LCM
(
p
 + 5, 'a', 'g', 'e', 'n')

3440 && 
	`TFW_LC
(*(
p
 + 9)) == 't'

3441 && *(
p
 + 10) == ':'))

3443 
∑r£r
->
_i_°
 = 
Req_HdrU£r_AgítV
;

3444 
	`__FSM_MOVE_n
(
RGí_OWS
, 11);

3446 
	`__FSM_MOVE
(
Req_HdrU
);

3448 
	`__FSM_JMP
(
RGí_HdrOthî
);

3453 
	`__FSM_STATE
(
Req_HdrC⁄ã¡_
) {

3454 
	`TFW_LC
(
c
)) {

3456 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 7)

3457 && 
	`C4_INT_LCM
(
p
 + 1, 'e', 'n', 'g', 't')

3458 && 
	`TFW_LC
(*(
p
 + 5)) == 'h'

3459 && *(
p
 + 6) == ':'))

3461 
∑r£r
->
_i_°
 = 
Req_HdrC⁄ã¡_LígthV
;

3462 
	`__FSM_MOVE_n
(
RGí_OWS
, 7);

3464 
	`__FSM_MOVE
(
Req_HdrC⁄ã¡_L
);

3466 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5)

3467 && 
	`C4_INT_LCM
(
p
 + 1, 'y', 'p', 'e', ':')))

3469 
∑r£r
->
_i_°
 = 
Req_HdrC⁄ã¡_Ty≥V
;

3470 
	`__FSM_MOVE_n
(
RGí_OWS
, 5);

3472 
	`__FSM_MOVE
(
Req_HdrC⁄ã¡_T
);

3474 
	`__FSM_JMP
(
RGí_HdrOthî
);

3479 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Req_HdrAc˚±V
, 
Req_I_Ac˚±
,

3480 
ªq
, 
__ªq_∑r£_ac˚±
);

3483 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Req_HdrAuth‹iz©i⁄V
, 
Req_I_Auth
,

3484 
ªq
, 
__ªq_∑r£_auth‹iz©i⁄
);

3487 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Req_HdrCache_C⁄åﬁV
, 
Req_I_CC
, 
ªq
,

3488 
__ªq_∑r£_ˇche_c⁄åﬁ
);

3491 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrC⁄√˘i⁄V
, 
I_C⁄n
, 
msg
,

3492 
__∑r£_c⁄√˘i⁄
, 
TFW_HTTP_HDR_CONNECTION
);

3495 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrC⁄ã¡_LígthV
, 
I_C⁄tLí
,

3496 
msg
, 
__∑r£_c⁄ã¡_Àngth
,

3497 
TFW_HTTP_HDR_CONTENT_LENGTH
);

3500 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrC⁄ã¡_Ty≥V
, 
I_C⁄tTy≥
,

3501 
msg
, 
__∑r£_c⁄ã¡_ty≥
,

3502 
TFW_HTTP_HDR_CONTENT_TYPE
);

3505 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrHo°V
, 
Req_I_H_Sèπ
, 
ªq
,

3506 
__ªq_∑r£_ho°
, 
TFW_HTTP_HDR_HOST
);

3509 
	`__TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrIf_N⁄e_M©chV
, 
I_Eèg
, 
msg
,

3510 
__∑r£_ëag
, 
TFW_HTTP_HDR_IF_NONE_MATCH
, 0);

3513 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Req_HdrIf_Modifõd_Sö˚V
, 
I_D©e
, 
msg
,

3514 
__ªq_∑r£_if_msö˚
);

3517 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrKìp_AliveV
, 
I_KìpAlive
, 
msg
,

3518 
__∑r£_kìp_Æive
, 
TFW_HTTP_HDR_KEEP_ALIVE
);

3521 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Req_HdrPøgmaV
, 
Req_I_Pøgma
,

3522 
ªq
, 
__ªq_∑r£_¥agma
);

3525 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrRe„ªrV
, 
Req_I_Re„ªr
, 
msg
,

3526 
__ªq_∑r£_ª„ªr
, 
TFW_HTTP_HDR_REFERER
);

3529 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrTøns„r_EncodögV
, 
I_TønsEncod
,

3530 
msg
, 
__∑r£_å™s„r_ícodög
,

3531 
TFW_HTTP_HDR_TRANSFER_ENCODING
);

3534 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrX_F‹w¨ded_F‹V
, 
Req_I_XFF
,

3535 
msg
, 
__ªq_∑r£_x_f‹w¨ded_f‹
,

3536 
TFW_HTTP_HDR_X_FORWARDED_FOR
);

3539 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrU£r_AgítV
, 
Req_I_U£rAgít
,

3540 
msg
, 
__ªq_∑r£_u£r_agít
,

3541 
TFW_HTTP_HDR_USER_AGENT
);

3544 
	`__TFW_HTTP_PARSE_SPECHDR_VAL
(
Req_HdrCookõV
, 
Req_I_CookõSèπ
,

3545 
msg
, 
__ªq_∑r£_cookõ
,

3546 
TFW_HTTP_HDR_COOKIE
, 0);

3548 
	`RGEN_HDR_OTHER
();

3549 
	`RGEN_OWS
();

3550 
	`RGEN_EOL
();

3551 
	`RGEN_CRLF
();

3556 
	`TFW_HTTP_INIT_REQ_BODY_PARSING
();

3557 
	`TFW_HTTP_PARSE_BODY
();

3563 
	`__FSM_METH_MOVE
(
Req_MëhG
, 'E', 
Req_MëhGe
);

3564 
	`__FSM_METH_MOVE_föish
(
Req_MëhGe
, 'T', 
TFW_HTTP_METH_GET
);

3566 
	`__FSM_STATE
(
Req_MëhP
) {

3567 
c
)

3570 
	`__FSM_MOVE_nofixup
(
Req_MëhPo
);

3572 
	`__FSM_MOVE_nofixup
(
Req_MëhPa
);

3574 
	`__FSM_MOVE_nofixup
(
Req_MëhPr
);

3576 
	`__FSM_MOVE_nofixup
(
Req_MëhPu
);

3578 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
);

3581 
	`__FSM_METH_MOVE
(
Req_MëhPo
, 'S', 
Req_MëhPos
);

3582 
	`__FSM_METH_MOVE_föish
(
Req_MëhPos
, 'T', 
TFW_HTTP_METH_POST
);

3584 
	`__FSM_METH_MOVE
(
Req_MëhPa
, 'T', 
Req_MëhP©
);

3585 
	`__FSM_METH_MOVE
(
Req_MëhP©
, 'C', 
Req_MëhP©c
);

3586 
	`__FSM_METH_MOVE_föish
(
Req_MëhP©c
, 'H', 
TFW_HTTP_METH_PATCH
);

3588 
	`__FSM_METH_MOVE
(
Req_MëhPr
, 'O', 
Req_MëhPro
);

3589 
	`__FSM_METH_MOVE
(
Req_MëhPro
, 'P', 
Req_MëhPr›
);

3590 
	`__FSM_STATE
(
Req_MëhPr›
) {

3591 
c
)

3594 
	`__FSM_MOVE_nofixup
(
Req_MëhPr›f
);

3596 
	`__FSM_MOVE_nofixup
(
Req_MëhPr›p
);

3598 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
);

3601 
	`__FSM_METH_MOVE
(
Req_MëhPr›f
, 'I', 
Req_MëhPr›fi
);

3602 
	`__FSM_METH_MOVE
(
Req_MëhPr›fi
, 'N', 
Req_MëhPr›fö
);

3603 
	`__FSM_METH_MOVE_föish
(
Req_MëhPr›fö
, 'D', 
TFW_HTTP_METH_PROPFIND
);

3605 
	`__FSM_METH_MOVE
(
Req_MëhPr›p
, 'A', 
Req_MëhPr›∑
);

3606 
	`__FSM_METH_MOVE
(
Req_MëhPr›∑
, 'T', 
Req_MëhPr›∑t
);

3607 
	`__FSM_METH_MOVE
(
Req_MëhPr›∑t
, 'C', 
Req_MëhPr›∑tc
);

3608 
	`__FSM_METH_MOVE_föish
(
Req_MëhPr›∑tc
, 'H', 
TFW_HTTP_METH_PROPPATCH
);

3610 
	`__FSM_STATE
(
Req_MëhPu
) {

3611 
c
)

3614 
	`__FSM_MOVE_nofixup
(
Req_MëhPur
);

3617 
ªq
->
mëhod
 = 
TFW_HTTP_METH_PUT
;

3618 
	`__FSM_MOVE_nofixup
(
Req_MUS∑˚
);

3620 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
);

3623 
	`__FSM_METH_MOVE
(
Req_MëhPur
, 'G', 
Req_MëhPurg
);

3624 
	`__FSM_METH_MOVE_föish
(
Req_MëhPurg
, 'E', 
TFW_HTTP_METH_PURGE
);

3626 
	`__FSM_METH_MOVE
(
Req_MëhH
, 'E', 
Req_MëhHe
);

3627 
	`__FSM_METH_MOVE
(
Req_MëhHe
, 'A', 
Req_MëhHó
);

3628 
	`__FSM_METH_MOVE_föish
(
Req_MëhHó
, 'D', 
TFW_HTTP_METH_HEAD
);

3630 
	`__FSM_METH_MOVE
(
Req_MëhC
, 'O', 
Req_MëhCo
);

3631 
	`__FSM_METH_MOVE
(
Req_MëhCo
, 'P', 
Req_MëhC›
);

3632 
	`__FSM_METH_MOVE_föish
(
Req_MëhC›
, 'Y', 
TFW_HTTP_METH_COPY
);

3634 
	`__FSM_METH_MOVE
(
Req_MëhD
, 'E', 
Req_MëhDe
);

3635 
	`__FSM_METH_MOVE
(
Req_MëhDe
, 'L', 
Req_MëhDñ
);

3636 
	`__FSM_METH_MOVE
(
Req_MëhDñ
, 'E', 
Req_MëhDñe
);

3637 
	`__FSM_METH_MOVE
(
Req_MëhDñe
, 'T', 
Req_MëhDñë
);

3638 
	`__FSM_METH_MOVE_föish
(
Req_MëhDñë
, 'E', 
TFW_HTTP_METH_DELETE
);

3640 
	`__FSM_METH_MOVE
(
Req_MëhL
, 'O', 
Req_MëhLo
);

3641 
	`__FSM_METH_MOVE
(
Req_MëhLo
, 'C', 
Req_MëhLoc
);

3642 
	`__FSM_METH_MOVE_föish
(
Req_MëhLoc
, 'K', 
TFW_HTTP_METH_LOCK
);

3644 
	`__FSM_STATE
(
Req_MëhM
) {

3645 
c
)

3648 
	`__FSM_MOVE_nofixup
(
Req_MëhMk
);

3650 
	`__FSM_MOVE_nofixup
(
Req_MëhMo
);

3652 
	`__FSM_MOVE_nofixup
(
Req_MëhodUnknown
);

3655 
	`__FSM_METH_MOVE
(
Req_MëhMk
, 'C', 
Req_MëhMkc
);

3656 
	`__FSM_METH_MOVE
(
Req_MëhMkc
, 'O', 
Req_MëhMkco
);

3657 
	`__FSM_METH_MOVE_föish
(
Req_MëhMkco
, 'L', 
TFW_HTTP_METH_MKCOL
);

3659 
	`__FSM_METH_MOVE
(
Req_MëhMo
, 'V', 
Req_MëhMov
);

3660 
	`__FSM_METH_MOVE_föish
(
Req_MëhMov
, 'E', 
TFW_HTTP_METH_MOVE
);

3662 
	`__FSM_METH_MOVE
(
Req_MëhO
, 'P', 
Req_MëhOp
);

3663 
	`__FSM_METH_MOVE
(
Req_MëhOp
, 'T', 
Req_MëhO±
);

3664 
	`__FSM_METH_MOVE
(
Req_MëhO±
, 'I', 
Req_MëhO±i
);

3665 
	`__FSM_METH_MOVE
(
Req_MëhO±i
, 'O', 
Req_MëhO±io
);

3666 
	`__FSM_METH_MOVE
(
Req_MëhO±io
, 'N', 
Req_MëhO±i⁄
);

3667 
	`__FSM_METH_MOVE_föish
(
Req_MëhO±i⁄
, 'S', 
TFW_HTTP_METH_OPTIONS
);

3669 
	`__FSM_METH_MOVE
(
Req_MëhT
, 'R', 
Req_MëhTr
);

3670 
	`__FSM_METH_MOVE
(
Req_MëhTr
, 'A', 
Req_MëhTø
);

3671 
	`__FSM_METH_MOVE
(
Req_MëhTø
, 'C', 
Req_MëhTøc
);

3672 
	`__FSM_METH_MOVE_föish
(
Req_MëhTøc
, 'E', 
TFW_HTTP_METH_TRACE
);

3674 
	`__FSM_METH_MOVE
(
Req_MëhU
, 'N', 
Req_MëhUn
);

3675 
	`__FSM_METH_MOVE
(
Req_MëhUn
, 'L', 
Req_MëhU∆
);

3676 
	`__FSM_METH_MOVE
(
Req_MëhU∆
, 'O', 
Req_MëhU∆o
);

3677 
	`__FSM_METH_MOVE
(
Req_MëhU∆o
, 'C', 
Req_MëhU∆oc
);

3678 
	`__FSM_METH_MOVE_föish
(
Req_MëhU∆oc
, 'K', 
TFW_HTTP_METH_UNLOCK
);

3681 
	`__FSM_TX_LC_nofixup
(
Req_UriSchH
, 't', 
Req_UriSchHt
);

3682 
	`__FSM_TX_LC_nofixup
(
Req_UriSchHt
, 't', 
Req_UriSchHâ
);

3683 
	`__FSM_TX_LC_nofixup
(
Req_UriSchHâ
, 'p', 
Req_UriSchHâp
);

3684 
	`__FSM_TX_nofixup
(
Req_UriSchHâp
, ':', 
Req_UriSchHâpCﬁ⁄
);

3685 
	`__FSM_TX_nofixup
(
Req_UriSchHâpCﬁ⁄
, '/', 
Req_UriSchHâpCﬁ⁄Sœsh
);

3686 
	`__FSM_TX_nofixup
(
Req_UriSchHâpCﬁ⁄Sœsh
, '/', 
Req_UriAuth‹ôySèπ
);

3689 
	`__FSM_TX_nofixup
(
Req_HâpVîT1
, 'T', 
Req_HâpVîT2
);

3690 
	`__FSM_TX_nofixup
(
Req_HâpVîT2
, 'T', 
Req_HâpVîP
);

3691 
	`__FSM_TX_nofixup
(
Req_HâpVîP
, 'P', 
Req_HâpVîSœsh
);

3692 
	`__FSM_TX_nofixup
(
Req_HâpVîSœsh
, '/', 
Req_HâpVî11
);

3693 
	`__FSM_TX_nofixup
(
Req_HâpVî11
, '1', 
Req_HâpVîDŸ
);

3694 
	`__FSM_TX_nofixup
(
Req_HâpVîDŸ
, '.', 
Req_HâpVî12
);

3695 
	`__FSM_STATE
(
Req_HâpVî12
) {

3696 
c
) {

3698 
ªq
->
vîsi⁄
 = 
TFW_HTTP_VER_11
;

3699 
	`__FSM_MOVE_nofixup
(
RGí_EoL
);

3701 
ªq
->
vîsi⁄
 = 
TFW_HTTP_VER_10
;

3702 
	`__FSM_MOVE_nofixup
(
RGí_EoL
);

3704 
	`TFW_PARSER_BLOCK
(
Req_HâpVî12
);

3708 
	`__FSM_STATE
(
Req_HdrA
) {

3709 
	`TFW_LC
(
c
)) {

3711 
	`__FSM_MOVE
(
Req_HdrAc
);

3713 
	`__FSM_MOVE
(
Req_HdrAu
);

3715 
	`__FSM_JMP
(
RGí_HdrOthî
);

3720 
	`__FSM_TX_AF
(
Req_HdrAc
, 'c', 
Req_HdrAcc
, 
RGí_HdrOthî
);

3721 
	`__FSM_TX_AF
(
Req_HdrAcc
, 'e', 
Req_HdrAc˚
, 
RGí_HdrOthî
);

3722 
	`__FSM_TX_AF
(
Req_HdrAc˚
, 'p', 
Req_HdrAc˚p
, 
RGí_HdrOthî
);

3723 
	`__FSM_TX_AF
(
Req_HdrAc˚p
, 't', 
Req_HdrAc˚±
, 
RGí_HdrOthî
);

3724 
	`__FSM_TX_AF
(
Req_HdrAc˚±
, ':', 
Req_HdrAc˚±V
, 
RGí_HdrOthî
);

3727 
	`__FSM_TX_AF
(
Req_HdrAu
, 't', 
Req_HdrAut
, 
RGí_HdrOthî
);

3728 
	`__FSM_TX_AF
(
Req_HdrAut
, 'h', 
Req_HdrAuth
, 
RGí_HdrOthî
);

3729 
	`__FSM_TX_AF
(
Req_HdrAuth
, 'o', 
Req_HdrAutho
, 
RGí_HdrOthî
);

3730 
	`__FSM_TX_AF
(
Req_HdrAutho
, 'r', 
Req_HdrAuth‹
, 
RGí_HdrOthî
);

3731 
	`__FSM_TX_AF
(
Req_HdrAuth‹
, 'i', 
Req_HdrAuth‹i
, 
RGí_HdrOthî
);

3732 
	`__FSM_TX_AF
(
Req_HdrAuth‹i
, 'z', 
Req_HdrAuth‹iz
, 
RGí_HdrOthî
);

3733 
	`__FSM_TX_AF
(
Req_HdrAuth‹iz
, 'a', 
Req_HdrAuth‹iza
, 
RGí_HdrOthî
);

3734 
	`__FSM_TX_AF
(
Req_HdrAuth‹iza
, 't', 
Req_HdrAuth‹iz©
, 
RGí_HdrOthî
);

3735 
	`__FSM_TX_AF
(
Req_HdrAuth‹iz©
, 'i', 
Req_HdrAuth‹iz©i
, 
RGí_HdrOthî
);

3736 
	`__FSM_TX_AF
(
Req_HdrAuth‹iz©i
, 'o', 
Req_HdrAuth‹iz©io
, 
RGí_HdrOthî
);

3737 
	`__FSM_TX_AF
(
Req_HdrAuth‹iz©io
, 'n', 
Req_HdrAuth‹iz©i⁄
, 
RGí_HdrOthî
);

3738 
	`__FSM_TX_AF_OWS
(
Req_HdrAuth‹iz©i⁄
, ':', 
Req_HdrAuth‹iz©i⁄V
, 
RGí_HdrOthî
);

3740 
	`__FSM_STATE
(
Req_HdrC
) {

3741 
	`TFW_LC
(
c
)) {

3743 
	`__FSM_MOVE
(
Req_HdrCa
);

3745 
	`__FSM_MOVE
(
Req_HdrCo
);

3747 
	`__FSM_JMP
(
RGí_HdrOthî
);

3752 
	`__FSM_TX_AF
(
Req_HdrCa
, 'c', 
Req_HdrCac
, 
RGí_HdrOthî
);

3753 
	`__FSM_TX_AF
(
Req_HdrCac
, 'h', 
Req_HdrCach
, 
RGí_HdrOthî
);

3754 
	`__FSM_TX_AF
(
Req_HdrCach
, 'e', 
Req_HdrCache
, 
RGí_HdrOthî
);

3755 
	`__FSM_TX_AF
(
Req_HdrCache
, '-', 
Req_HdrCache_
, 
RGí_HdrOthî
);

3756 
	`__FSM_TX_AF
(
Req_HdrCache_
, 'c', 
Req_HdrCache_C
, 
RGí_HdrOthî
);

3757 
	`__FSM_TX_AF
(
Req_HdrCache_C
, 'o', 
Req_HdrCache_Co
, 
RGí_HdrOthî
);

3758 
	`__FSM_TX_AF
(
Req_HdrCache_Co
, 'n', 
Req_HdrCache_C⁄
, 
RGí_HdrOthî
);

3759 
	`__FSM_TX_AF
(
Req_HdrCache_C⁄
, 't', 
Req_HdrCache_C⁄t
, 
RGí_HdrOthî
);

3760 
	`__FSM_TX_AF
(
Req_HdrCache_C⁄t
, 'r', 
Req_HdrCache_C⁄å
, 
RGí_HdrOthî
);

3761 
	`__FSM_TX_AF
(
Req_HdrCache_C⁄å
, 'o', 
Req_HdrCache_C⁄åo
, 
RGí_HdrOthî
);

3762 
	`__FSM_TX_AF
(
Req_HdrCache_C⁄åo
, 'l', 
Req_HdrCache_C⁄åﬁ
, 
RGí_HdrOthî
);

3763 
	`__FSM_TX_AF_OWS
(
Req_HdrCache_C⁄åﬁ
, ':', 
Req_HdrCache_C⁄åﬁV
, 
RGí_HdrOthî
);

3765 
	`__FSM_STATE
(
Req_HdrCo
) {

3766 
	`TFW_LC
(
c
)) {

3768 
	`__FSM_MOVE
(
Req_HdrC⁄
);

3770 
	`__FSM_MOVE
(
Req_HdrCoo
);

3772 
	`__FSM_JMP
(
RGí_HdrOthî
);

3777 
	`__FSM_STATE
(
Req_HdrC⁄
) {

3778 
	`TFW_LC
(
c
)) {

3780 
	`__FSM_MOVE
(
Req_HdrC⁄n
);

3782 
	`__FSM_MOVE
(
Req_HdrC⁄t
);

3784 
	`__FSM_JMP
(
RGí_HdrOthî
);

3787 
	`__FSM_TX_AF
(
Req_HdrC⁄n
, 'e', 
Req_HdrC⁄√
, 
RGí_HdrOthî
);

3788 
	`__FSM_TX_AF
(
Req_HdrC⁄√
, 'c', 
Req_HdrC⁄√c
, 
RGí_HdrOthî
);

3789 
	`__FSM_TX_AF
(
Req_HdrC⁄√c
, 't', 
Req_HdrC⁄√˘
, 
RGí_HdrOthî
);

3790 
	`__FSM_TX_AF
(
Req_HdrC⁄√˘
, 'i', 
Req_HdrC⁄√˘i
, 
RGí_HdrOthî
);

3791 
	`__FSM_TX_AF
(
Req_HdrC⁄√˘i
, 'o', 
Req_HdrC⁄√˘io
, 
RGí_HdrOthî
);

3792 
	`__FSM_TX_AF
(
Req_HdrC⁄√˘io
, 'n', 
Req_HdrC⁄√˘i⁄
, 
RGí_HdrOthî
);

3793 
	`__FSM_TX_AF_OWS
(
Req_HdrC⁄√˘i⁄
, ':', 
Req_HdrC⁄√˘i⁄V
, 
RGí_HdrOthî
);

3796 
	`__FSM_TX_AF
(
Req_HdrC⁄t
, 'e', 
Req_HdrC⁄ã
, 
RGí_HdrOthî
);

3797 
	`__FSM_TX_AF
(
Req_HdrC⁄ã
, 'n', 
Req_HdrC⁄ãn
, 
RGí_HdrOthî
);

3798 
	`__FSM_TX_AF
(
Req_HdrC⁄ãn
, 't', 
Req_HdrC⁄ã¡
, 
RGí_HdrOthî
);

3799 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡
, '-', 
Req_HdrC⁄ã¡_
, 
RGí_HdrOthî
);

3802 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_L
, 'e', 
Req_HdrC⁄ã¡_Le
, 
RGí_HdrOthî
);

3803 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_Le
, 'n', 
Req_HdrC⁄ã¡_Lí
, 
RGí_HdrOthî
);

3804 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_Lí
, 'g', 
Req_HdrC⁄ã¡_Líg
, 
RGí_HdrOthî
);

3805 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_Líg
, 't', 
Req_HdrC⁄ã¡_Lígt
, 
RGí_HdrOthî
);

3806 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_Lígt
, 'h', 
Req_HdrC⁄ã¡_Lígth
, 
RGí_HdrOthî
);

3807 
	`__FSM_TX_AF_OWS
(
Req_HdrC⁄ã¡_Lígth
, ':', 
Req_HdrC⁄ã¡_LígthV
, 
RGí_HdrOthî
);

3810 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_T
, 'y', 
Req_HdrC⁄ã¡_Ty
, 
RGí_HdrOthî
);

3811 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_Ty
, 'p', 
Req_HdrC⁄ã¡_Typ
, 
RGí_HdrOthî
);

3812 
	`__FSM_TX_AF
(
Req_HdrC⁄ã¡_Typ
, 'e', 
Req_HdrC⁄ã¡_Ty≥
, 
RGí_HdrOthî
);

3813 
	`__FSM_TX_AF_OWS
(
Req_HdrC⁄ã¡_Ty≥
, ':', 
Req_HdrC⁄ã¡_Ty≥V
, 
RGí_HdrOthî
);

3816 
	`__FSM_TX_AF
(
Req_HdrH
, 'o', 
Req_HdrHo
, 
RGí_HdrOthî
);

3817 
	`__FSM_TX_AF
(
Req_HdrHo
, 's', 
Req_HdrHos
, 
RGí_HdrOthî
);

3818 
	`__FSM_TX_AF
(
Req_HdrHos
, 't', 
Req_HdrHo°
, 
RGí_HdrOthî
);

3820 
	`__FSM_STATE
(
Req_HdrHo°
) {

3821 i‡(
	`likñy
(
c
 == ':')) {

3822 
∑r£r
->
_i_°
 = 
Req_HdrHo°V
;

3823 
	`__FSM_MOVE
(
RGí_OWS
);

3825 
	`__FSM_JMP
(
RGí_HdrOthî
);

3829 
	`__FSM_TX_AF
(
Req_HdrI
, 'f', 
Req_HdrIf
, 
RGí_HdrOthî
);

3830 
	`__FSM_TX_AF
(
Req_HdrIf
, '-', 
Req_HdrIf_
, 
RGí_HdrOthî
);

3831 
	`__FSM_STATE
(
Req_HdrIf_
) {

3832 
	`TFW_LC
(
c
)) {

3834 
	`__FSM_MOVE
(
Req_HdrIf_M
);

3836 
	`__FSM_MOVE
(
Req_HdrIf_N
);

3838 
	`__FSM_JMP
(
RGí_HdrOthî
);

3843 
	`__FSM_TX_AF
(
Req_HdrIf_M
, 'o', 
Req_HdrIf_Mo
, 
RGí_HdrOthî
);

3844 
	`__FSM_TX_AF
(
Req_HdrIf_Mo
, 'd', 
Req_HdrIf_Mod
, 
RGí_HdrOthî
);

3845 
	`__FSM_TX_AF
(
Req_HdrIf_Mod
, 'i', 
Req_HdrIf_Modi
, 
RGí_HdrOthî
);

3846 
	`__FSM_TX_AF
(
Req_HdrIf_Modi
, 'f', 
Req_HdrIf_Modif
, 
RGí_HdrOthî
);

3847 
	`__FSM_TX_AF
(
Req_HdrIf_Modif
, 'i', 
Req_HdrIf_Modifi
, 
RGí_HdrOthî
);

3848 
	`__FSM_TX_AF
(
Req_HdrIf_Modifi
, 'e', 
Req_HdrIf_Modifõ
, 
RGí_HdrOthî
);

3849 
	`__FSM_TX_AF
(
Req_HdrIf_Modifõ
, 'd', 
Req_HdrIf_Modifõd
, 
RGí_HdrOthî
);

3850 
	`__FSM_TX_AF
(
Req_HdrIf_Modifõd
, '-', 
Req_HdrIf_Modifõd_
, 
RGí_HdrOthî
);

3851 
	`__FSM_TX_AF
(
Req_HdrIf_Modifõd_
, 's', 
Req_HdrIf_Modifõd_S
, 
RGí_HdrOthî
);

3852 
	`__FSM_TX_AF
(
Req_HdrIf_Modifõd_S
, 'i', 
Req_HdrIf_Modifõd_Si
, 
RGí_HdrOthî
);

3853 
	`__FSM_TX_AF
(
Req_HdrIf_Modifõd_Si
, 'n', 
Req_HdrIf_Modifõd_Sö
, 
RGí_HdrOthî
);

3854 
	`__FSM_TX_AF
(
Req_HdrIf_Modifõd_Sö
, 'c', 
Req_HdrIf_Modifõd_Söc
, 
RGí_HdrOthî
);

3855 
	`__FSM_TX_AF
(
Req_HdrIf_Modifõd_Söc
, 'e', 
Req_HdrIf_Modifõd_Sö˚
, 
RGí_HdrOthî
);

3856 
	`__FSM_TX_AF_OWS
(
Req_HdrIf_Modifõd_Sö˚
, ':', 
Req_HdrIf_Modifõd_Sö˚V
, 
RGí_HdrOthî
);

3859 
	`__FSM_TX_AF
(
Req_HdrIf_N
, 'o', 
Req_HdrIf_No
, 
RGí_HdrOthî
);

3860 
	`__FSM_TX_AF
(
Req_HdrIf_No
, 'n', 
Req_HdrIf_N⁄
, 
RGí_HdrOthî
);

3861 
	`__FSM_TX_AF
(
Req_HdrIf_N⁄
, 'e', 
Req_HdrIf_N⁄e
, 
RGí_HdrOthî
);

3862 
	`__FSM_TX_AF
(
Req_HdrIf_N⁄e
, '-', 
Req_HdrIf_N⁄e_
, 
RGí_HdrOthî
);

3863 
	`__FSM_TX_AF
(
Req_HdrIf_N⁄e_
, 'm', 
Req_HdrIf_N⁄e_M
, 
RGí_HdrOthî
);

3864 
	`__FSM_TX_AF
(
Req_HdrIf_N⁄e_M
, 'a', 
Req_HdrIf_N⁄e_Ma
, 
RGí_HdrOthî
);

3865 
	`__FSM_TX_AF
(
Req_HdrIf_N⁄e_Ma
, 't', 
Req_HdrIf_N⁄e_M©
, 
RGí_HdrOthî
);

3866 
	`__FSM_TX_AF
(
Req_HdrIf_N⁄e_M©
, 'c', 
Req_HdrIf_N⁄e_M©c
, 
RGí_HdrOthî
);

3867 
	`__FSM_TX_AF
(
Req_HdrIf_N⁄e_M©c
, 'h', 
Req_HdrIf_N⁄e_M©ch
, 
RGí_HdrOthî
);

3868 
	`__FSM_TX_AF_OWS
(
Req_HdrIf_N⁄e_M©ch
, ':', 
Req_HdrIf_N⁄e_M©chV
, 
RGí_HdrOthî
);

3871 
	`__FSM_TX_AF
(
Req_HdrK
, 'e', 
Req_HdrKe
, 
RGí_HdrOthî
);

3872 
	`__FSM_TX_AF
(
Req_HdrKe
, 'e', 
Req_HdrKì
, 
RGí_HdrOthî
);

3873 
	`__FSM_TX_AF
(
Req_HdrKì
, 'p', 
Req_HdrKìp
, 
RGí_HdrOthî
);

3874 
	`__FSM_TX_AF
(
Req_HdrKìp
, '-', 
Req_HdrKìp_
, 
RGí_HdrOthî
);

3875 
	`__FSM_TX_AF
(
Req_HdrKìp_
, 'a', 
Req_HdrKìp_A
, 
RGí_HdrOthî
);

3876 
	`__FSM_TX_AF
(
Req_HdrKìp_A
, 'l', 
Req_HdrKìp_Al
, 
RGí_HdrOthî
);

3877 
	`__FSM_TX_AF
(
Req_HdrKìp_Al
, 'i', 
Req_HdrKìp_Ali
, 
RGí_HdrOthî
);

3878 
	`__FSM_TX_AF
(
Req_HdrKìp_Ali
, 'v', 
Req_HdrKìp_Aliv
, 
RGí_HdrOthî
);

3879 
	`__FSM_TX_AF
(
Req_HdrKìp_Aliv
, 'e', 
Req_HdrKìp_Alive
, 
RGí_HdrOthî
);

3880 
	`__FSM_TX_AF_OWS
(
Req_HdrKìp_Alive
, ':', 
Req_HdrKìp_AliveV
, 
RGí_HdrOthî
);

3883 
	`__FSM_TX_AF
(
Req_HdrP
, 'r', 
Req_HdrPr
, 
RGí_HdrOthî
);

3884 
	`__FSM_TX_AF
(
Req_HdrPr
, 'a', 
Req_HdrPø
, 
RGí_HdrOthî
);

3885 
	`__FSM_TX_AF
(
Req_HdrPø
, 'g', 
Req_HdrPøg
, 
RGí_HdrOthî
);

3886 
	`__FSM_TX_AF
(
Req_HdrPøg
, 'm', 
Req_HdrPøgm
, 
RGí_HdrOthî
);

3887 
	`__FSM_TX_AF
(
Req_HdrPøgm
, 'a', 
Req_HdrPøgma
, 
RGí_HdrOthî
);

3888 
	`__FSM_TX_AF_OWS
(
Req_HdrPøgma
, ':', 
Req_HdrPøgmaV
, 
RGí_HdrOthî
);

3891 
	`__FSM_TX_AF
(
Req_HdrR
, 'e', 
Req_HdrRe
, 
RGí_HdrOthî
);

3892 
	`__FSM_TX_AF
(
Req_HdrRe
, 'f', 
Req_HdrRef
, 
RGí_HdrOthî
);

3893 
	`__FSM_TX_AF
(
Req_HdrRef
, 'e', 
Req_HdrRe„
, 
RGí_HdrOthî
);

3894 
	`__FSM_TX_AF
(
Req_HdrRe„
, 'r', 
Req_HdrRe„r
, 
RGí_HdrOthî
);

3895 
	`__FSM_TX_AF
(
Req_HdrRe„r
, 'e', 
Req_HdrRe„ª
, 
RGí_HdrOthî
);

3896 
	`__FSM_TX_AF
(
Req_HdrRe„ª
, 'r', 
Req_HdrRe„ªr
, 
RGí_HdrOthî
);

3897 
	`__FSM_TX_AF_OWS
(
Req_HdrRe„ªr
, ':', 
Req_HdrRe„ªrV
, 
RGí_HdrOthî
);

3900 
	`__FSM_TX_AF
(
Req_HdrT
, 'r', 
Req_HdrTr
, 
RGí_HdrOthî
);

3901 
	`__FSM_TX_AF
(
Req_HdrTr
, 'a', 
Req_HdrTø
, 
RGí_HdrOthî
);

3902 
	`__FSM_TX_AF
(
Req_HdrTø
, 'n', 
Req_HdrTøn
, 
RGí_HdrOthî
);

3903 
	`__FSM_TX_AF
(
Req_HdrTøn
, 's', 
Req_HdrTøns
, 
RGí_HdrOthî
);

3904 
	`__FSM_TX_AF
(
Req_HdrTøns
, 'f', 
Req_HdrTønsf
, 
RGí_HdrOthî
);

3905 
	`__FSM_TX_AF
(
Req_HdrTønsf
, 'e', 
Req_HdrTøns„
, 
RGí_HdrOthî
);

3906 
	`__FSM_TX_AF
(
Req_HdrTøns„
, 'r', 
Req_HdrTøns„r
, 
RGí_HdrOthî
);

3907 
	`__FSM_TX_AF
(
Req_HdrTøns„r
, '-', 
Req_HdrTøns„r_
, 
RGí_HdrOthî
);

3908 
	`__FSM_TX_AF
(
Req_HdrTøns„r_
, 'e', 
Req_HdrTøns„r_E
, 
RGí_HdrOthî
);

3909 
	`__FSM_TX_AF
(
Req_HdrTøns„r_E
, 'n', 
Req_HdrTøns„r_En
, 
RGí_HdrOthî
);

3910 
	`__FSM_TX_AF
(
Req_HdrTøns„r_En
, 'c', 
Req_HdrTøns„r_Enc
, 
RGí_HdrOthî
);

3911 
	`__FSM_TX_AF
(
Req_HdrTøns„r_Enc
, 'o', 
Req_HdrTøns„r_Enco
, 
RGí_HdrOthî
);

3912 
	`__FSM_TX_AF
(
Req_HdrTøns„r_Enco
, 'd', 
Req_HdrTøns„r_Encod
, 
RGí_HdrOthî
);

3913 
	`__FSM_TX_AF
(
Req_HdrTøns„r_Encod
, 'i', 
Req_HdrTøns„r_Encodi
, 
RGí_HdrOthî
);

3914 
	`__FSM_TX_AF
(
Req_HdrTøns„r_Encodi
, 'n', 
Req_HdrTøns„r_Encodö
, 
RGí_HdrOthî
);

3915 
	`__FSM_TX_AF
(
Req_HdrTøns„r_Encodö
, 'g', 
Req_HdrTøns„r_Encodög
, 
RGí_HdrOthî
);

3916 
	`__FSM_TX_AF_OWS
(
Req_HdrTøns„r_Encodög
, ':', 
Req_HdrTøns„r_EncodögV
, 
RGí_HdrOthî
);

3919 
	`__FSM_TX_AF
(
Req_HdrX
, '-', 
Req_HdrX_
, 
RGí_HdrOthî
);

3920 
	`__FSM_TX_AF
(
Req_HdrX_
, 'f', 
Req_HdrX_F
, 
RGí_HdrOthî
);

3921 
	`__FSM_TX_AF
(
Req_HdrX_F
, 'o', 
Req_HdrX_Fo
, 
RGí_HdrOthî
);

3922 
	`__FSM_TX_AF
(
Req_HdrX_Fo
, 'r', 
Req_HdrX_F‹
, 
RGí_HdrOthî
);

3923 
	`__FSM_TX_AF
(
Req_HdrX_F‹
, 'w', 
Req_HdrX_F‹w
, 
RGí_HdrOthî
);

3924 
	`__FSM_TX_AF
(
Req_HdrX_F‹w
, 'a', 
Req_HdrX_F‹wa
, 
RGí_HdrOthî
);

3925 
	`__FSM_TX_AF
(
Req_HdrX_F‹wa
, 'r', 
Req_HdrX_F‹w¨
, 
RGí_HdrOthî
);

3926 
	`__FSM_TX_AF
(
Req_HdrX_F‹w¨
, 'd', 
Req_HdrX_F‹w¨d
, 
RGí_HdrOthî
);

3927 
	`__FSM_TX_AF
(
Req_HdrX_F‹w¨d
, 'e', 
Req_HdrX_F‹w¨de
, 
RGí_HdrOthî
);

3928 
	`__FSM_TX_AF
(
Req_HdrX_F‹w¨de
, 'd', 
Req_HdrX_F‹w¨ded
, 
RGí_HdrOthî
);

3929 
	`__FSM_TX_AF
(
Req_HdrX_F‹w¨ded
, '-', 
Req_HdrX_F‹w¨ded_
, 
RGí_HdrOthî
);

3930 
	`__FSM_TX_AF
(
Req_HdrX_F‹w¨ded_
, 'f', 
Req_HdrX_F‹w¨ded_F
, 
RGí_HdrOthî
);

3931 
	`__FSM_TX_AF
(
Req_HdrX_F‹w¨ded_F
, 'o', 
Req_HdrX_F‹w¨ded_Fo
, 
RGí_HdrOthî
);

3932 
	`__FSM_TX_AF
(
Req_HdrX_F‹w¨ded_Fo
, 'r', 
Req_HdrX_F‹w¨ded_F‹
, 
RGí_HdrOthî
);

3934 
	`__FSM_TX_AF_OWS
(
Req_HdrX_F‹w¨ded_F‹
, ':', 
Req_HdrX_F‹w¨ded_F‹V
, 
RGí_HdrOthî
);

3937 
	`__FSM_TX_AF
(
Req_HdrU
, 's', 
Req_HdrUs
, 
RGí_HdrOthî
);

3938 
	`__FSM_TX_AF
(
Req_HdrUs
, 'e', 
Req_HdrU£
, 
RGí_HdrOthî
);

3939 
	`__FSM_TX_AF
(
Req_HdrU£
, 'r', 
Req_HdrU£r
, 
RGí_HdrOthî
);

3940 
	`__FSM_TX_AF
(
Req_HdrU£r
, '-', 
Req_HdrU£r_
, 
RGí_HdrOthî
);

3941 
	`__FSM_TX_AF
(
Req_HdrU£r_
, 'a', 
Req_HdrU£r_A
, 
RGí_HdrOthî
);

3942 
	`__FSM_TX_AF
(
Req_HdrU£r_A
, 'g', 
Req_HdrU£r_Ag
, 
RGí_HdrOthî
);

3943 
	`__FSM_TX_AF
(
Req_HdrU£r_Ag
, 'e', 
Req_HdrU£r_Age
, 
RGí_HdrOthî
);

3944 
	`__FSM_TX_AF
(
Req_HdrU£r_Age
, 'n', 
Req_HdrU£r_Agí
, 
RGí_HdrOthî
);

3945 
	`__FSM_TX_AF
(
Req_HdrU£r_Agí
, 't', 
Req_HdrU£r_Agít
, 
RGí_HdrOthî
);

3946 
	`__FSM_TX_AF_OWS
(
Req_HdrU£r_Agít
, ':', 
Req_HdrU£r_AgítV
, 
RGí_HdrOthî
);

3949 
	`__FSM_TX_AF
(
Req_HdrCoo
, 'k', 
Req_HdrCook
, 
RGí_HdrOthî
);

3950 
	`__FSM_TX_AF
(
Req_HdrCook
, 'i', 
Req_HdrCooki
, 
RGí_HdrOthî
);

3951 
	`__FSM_TX_AF
(
Req_HdrCooki
, 'e', 
Req_HdrCookõ
, 
RGí_HdrOthî
);

3952 
	`__FSM_TX_AF_OWS
(
Req_HdrCookõ
, ':', 
Req_HdrCookõV
, 
RGí_HdrOthî
);

3955 
	`__FSM_FINISH
(
ªq
);

3957  
r
;

3958 
	}
}

3970 
	mRe•_I_0
,

3973 
	mRe•_I_Age
,

3974 
	mRe•_I_AgeVÆ
,

3976 
	mRe•_I_CC
,

3977 
	mRe•_I_CC_m
,

3978 
	mRe•_I_CC_n
,

3979 
	mRe•_I_CC_p
,

3980 
	mRe•_I_CC_s
,

3981 
	mRe•_I_CC_MaxAgeV
,

3982 
	mRe•_I_CC_SMaxAgeV
,

3984 
	mRe•_I_Sîvî
,

3986 
	mRe•_I_Ext
,

3987 
	mRe•_I_EoT
,

3988 
	mRe•_I_EoL
,

3992 
	$__ª•_∑r£_age
(
TfwHâpRe•
 *
ª•
, *
d©a
, 
size_t
 
Àn
)

3994 
r
 = 
CSTR_NEQ
;

3995 
	`__FSM_DECLARE_VARS
(
ª•
);

3997 
	`__FSM_START
(
∑r£r
->
_i_°
) {

3999 
	`__FSM_STATE
(
Re•_I_Age
) {

4000 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

4001 
__fsm_n
 = 
	`∑r£_öt_ws
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

4002 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

4003 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

4004 i‡(
__fsm_n
 < 0)

4005  
__fsm_n
;

4006 
ª•
->
ˇche_˘l
.
age
 = 
∑r£r
->
_acc
;

4007 
∑r£r
->
_acc
 = 0;

4008 
	`__FSM_I_MOVE_n
(
Re•_I_EoL
, 
__fsm_n
);

4010 
	`__FSM_STATE
(
Re•_I_EoL
) {

4011 i‡(
	`IS_WS
(
c
))

4012 
	`__FSM_I_MOVE
(
Re•_I_EoL
);

4013 i‡(
	`IS_CRLF
(
c
)) {

4014 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_HDR_AGE
;

4015  
	`__d©a_off
(
p
);

4017  
CSTR_NEQ
;

4021 
d⁄e
:

4022  
r
;

4023 
	}
}

4029 
	$__ª•_∑r£_ˇche_c⁄åﬁ
(
TfwHâpRe•
 *
ª•
, *
d©a
, 
size_t
 
Àn
)

4031 
r
 = 
CSTR_NEQ
;

4032 
	`__FSM_DECLARE_VARS
(
ª•
);

4034 
	`__FSM_START
(
∑r£r
->
_i_°
) {

4036 
	`__FSM_STATE
(
Re•_I_CC
) {

4037 
	`TFW_LC
(
c
)) {

4039 
	`__FSM_I_MOVE_n
(
Re•_I_CC_m
, 0);

4041 
	`__FSM_I_MOVE_n
(
Re•_I_CC_n
, 0);

4043 
	`__FSM_I_MOVE_n
(
Re•_I_CC_p
, 0);

4045 
	`__FSM_I_MOVE_n
(
Re•_I_CC_s
, 0);

4047 
	`__FSM_I_MOVE_n
(
Re•_I_Ext
, 0);

4050 
	`__FSM_STATE
(
Re•_I_CC_m
) {

4051 
	`TRY_STR
("max-age=", 
Re•_I_CC_MaxAgeV
);

4052 
	`TRY_STR_LAMBDA
("must-revalidate", {

4053 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_MUST_REVAL
;

4054 }, 
Re•_I_EoT
);

4055 
	`TRY_STR_INIT
();

4056 
	`__FSM_I_MOVE_n
(
Re•_I_Ext
, 0);

4059 
	`__FSM_STATE
(
Re•_I_CC_n
) {

4060 
	`TRY_STR_LAMBDA
("no-cache", {

4061 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_NO_CACHE
;

4062 }, 
Re•_I_EoT
);

4063 
	`TRY_STR_LAMBDA
("no-store", {

4064 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_NO_STORE
;

4065 }, 
Re•_I_EoT
);

4066 
	`TRY_STR_LAMBDA
("no-transform", {

4067 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_NO_TRANSFORM
;

4068 }, 
Re•_I_EoT
);

4069 
	`TRY_STR_INIT
();

4070 
	`__FSM_I_MOVE_n
(
Re•_I_Ext
, 0);

4073 
	`__FSM_STATE
(
Re•_I_CC_p
) {

4074 
	`TRY_STR_LAMBDA
("public", {

4075 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_PUBLIC
;

4076 }, 
Re•_I_EoT
);

4077 
	`TRY_STR_LAMBDA
("private", {

4078 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_PRIVATE
;

4079 }, 
Re•_I_EoT
);

4080 
	`TRY_STR_LAMBDA
("proxy-revalidate", {

4081 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_PROXY_REVAL
;

4082 }, 
Re•_I_EoT
);

4083 
	`TRY_STR_INIT
();

4084 
	`__FSM_I_MOVE_n
(
Re•_I_Ext
, 0);

4087 
	`__FSM_STATE
(
Re•_I_CC_s
) {

4088 
	`TRY_STR
("s-maxage=", 
Re•_I_CC_SMaxAgeV
);

4089 
	`TRY_STR_INIT
();

4090 
	`__FSM_I_MOVE_n
(
Re•_I_Ext
, 0);

4093 
	`__FSM_STATE
(
Re•_I_CC_MaxAgeV
) {

4094 i‡(
	`u∆ikñy
(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MAX_AGE
)) {

4095 
ª•
->
ˇche_˘l
.
max_age
 = 0;

4096 
	`__FSM_I_MOVE_n
(
Re•_I_Ext
, 0);

4098 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

4099 
__fsm_n
 = 
	`∑r£_öt_li°
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

4100 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

4101 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

4102 i‡(
__fsm_n
 < 0) {

4103 i‡(
__fsm_n
 !
CSTR_BADLEN
)

4104  
__fsm_n
;

4105 
∑r£r
->
_acc
 = 
UINT_MAX
;

4107 
ª•
->
ˇche_˘l
.
max_age
 = 
∑r£r
->
_acc
;

4108 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_MAX_AGE
;

4109 
∑r£r
->
_acc
 = 0;

4110 
	`__FSM_I_MOVE_n
(
Re•_I_EoT
, 
__fsm_n
);

4113 
	`__FSM_STATE
(
Re•_I_CC_SMaxAgeV
) {

4114 i‡(
	`u∆ikñy
(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_S_MAXAGE
)) {

4115 
ª•
->
ˇche_˘l
.
s_maxage
 = 0;

4116 
	`__FSM_I_MOVE_n
(
Re•_I_Ext
, 0);

4118 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

4119 
__fsm_n
 = 
	`∑r£_öt_li°
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

4120 i‡(
__fsm_n
 =
CSTR_POSTPONE
)

4121 
	`__msg_hdr_chunk_fixup
(
d©a
, 
Àn
);

4122 i‡(
__fsm_n
 < 0) {

4123 i‡(
__fsm_n
 !
CSTR_BADLEN
)

4124  
__fsm_n
;

4125 
∑r£r
->
_acc
 = 
UINT_MAX
;

4127 
ª•
->
ˇche_˘l
.
s_maxage
 = 
∑r£r
->
_acc
;

4128 
ª•
->
ˇche_˘l
.
Êags
 |
TFW_HTTP_CC_S_MAXAGE
;

4129 
∑r£r
->
_acc
 = 0;

4130 
	`__FSM_I_MOVE_n
(
Re•_I_EoT
, 
__fsm_n
);

4133 
	`__FSM_STATE
(
Re•_I_Ext
) {

4135 
	`__FSM_I_MATCH_MOVE
(
qëokí
, 
Re•_I_Ext
);

4136 
c
 = *(
p
 + 
__fsm_sz
);

4137 i‡(
	`IS_WS
(
c
) || c == ',')

4138 
	`__FSM_I_MOVE_n
(
Re•_I_EoT
, 
__fsm_sz
 + 1);

4139 i‡(
	`IS_CRLF
(
c
))

4140  
	`__d©a_off
(
p
 + 
__fsm_sz
);

4141  
CSTR_NEQ
;

4145 
	`__FSM_STATE
(
Re•_I_EoT
) {

4146 i‡(
	`IS_WS
(
c
) || c == ',')

4147 
	`__FSM_I_MOVE
(
Re•_I_EoT
);

4153 i‡(
c
 == '=')

4154 
	`__FSM_I_MOVE
(
Re•_I_Ext
);

4155 i‡(
	`IS_TOKEN
(
c
))

4156 
	`__FSM_I_MOVE_n
(
Re•_I_CC
, 0);

4157 i‡(
	`IS_CRLF
(
c
))

4158  
	`__d©a_off
(
p
);

4159  
CSTR_NEQ
;

4163 
d⁄e
:

4164  
r
;

4165 
	}
}

4174 
	$__ª•_∑r£_expúes
(
TfwHâpMsg
 *
msg
, *
d©a
, 
size_t
 
Àn
)

4176 
ªt
;

4178 
ªt
 = 
	`__∑r£_hâp_d©e
(
msg
, 
d©a
, 
Àn
);

4179 i‡(
ªt
 < 
CSTR_POSTPONE
) {

4184 
	`BUG_ON
(
msg
->
∑r£r
.
°©e
 !
Re•_HdrExpúesV
);

4185 
msg
->
∑r£r
.
_d©e
 = 0;

4186 
msg
->
∑r£r
.
_i_°
 = 
I_EoL
;

4187 
ªt
 = 
	`__∑r£_hâp_d©e
(
msg
, 
d©a
, 
Àn
);

4189  
ªt
;

4190 
	}
}

4193 
	$__ª•_∑r£_£rvî
(
TfwHâpRe•
 *
ª•
, *
d©a
, 
size_t
 
Àn
)

4195 
r
 = 
CSTR_NEQ
;

4196 
	`__FSM_DECLARE_VARS
(
ª•
);

4198 
	`__FSM_START
(
∑r£r
->
_i_°
) {

4200 
	`__FSM_STATE
(
Re•_I_Sîvî
) {

4209 
	`__FSM_I_MATCH_MOVE
(
˘ext_vch¨
, 
Re•_I_Sîvî
);

4210 i‡(
	`IS_CRLF
(*(
p
 + 
__fsm_sz
)))

4211  
	`__d©a_off
(
p
 + 
__fsm_sz
);

4212  
CSTR_NEQ
;

4216 
d⁄e
:

4217  
r
;

4218 
	}
}

4224 
boﬁ


4225 
	$tfw_hâp_∑r£_ãrmö©e
(
TfwHâpMsg
 *
hm
)

4227 
	`BUG_ON
(!
hm
);

4228 
	`BUG_ON
(!(
	`TFW_CONN_TYPE
(
hm
->
c⁄n
Ë& 
C⁄n_Srv
));

4236 i‡(
hm
->
∑r£r
.
°©e
 =
Re•_BodyU∆imRód


4237 || 
hm
->
∑r£r
.
°©e
 =
Re•_BodyU∆imSèπ
)

4239 
c_Àn
[
TFW_ULTOA_BUF_SIZ
] = {0};

4240 
size_t
 
digs
;

4241 
r
;

4243 
	`BUG_ON
(
hm
->
body
.
Êags
 & 
TFW_STR_COMPLETE
);

4244 
hm
->
body
.
Êags
 |
TFW_STR_COMPLETE
;

4245 
hm
->
c⁄ã¡_Àngth
 = hm->
body
.
Àn
;

4246 i‡(!(
digs
 = 
	`tfw_u…ﬂ
(
hm
->
c⁄ã¡_Àngth
, 
c_Àn
,

4247 
TFW_ULTOA_BUF_SIZ
)))

4248  
Ál£
;

4249 
r
 = 
	`tfw_hâp_msg_hdr_x‰m
(
hm
, "Content-Length",

4251 
c_Àn
, 
digs
,

4252 
TFW_HTTP_HDR_CONTENT_LENGTH
, 0);

4253  (
r
 == 0);

4255  
Ál£
;

4256 
	}
}

4259 
	$tfw_hâp_öô_∑r£r_ª•
(
TfwHâpRe•
 *
ª•
)

4261 
TfwHâpHbhHdrs
 *
hbh_hdrs
 = &
ª•
->
∑r£r
.
hbh_∑r£r
;

4263 
	`__∑r£r_öô
(&
ª•
->
∑r£r
);

4264 
ª•
->
∑r£r
.
°©e
 = 
Re•_0
;

4267 
	`BUG_ON
(
hbh_hdrs
->
•ec
);

4274 
hbh_hdrs
->
•ec
 = (0x1 << 
TFW_HTTP_HDR_CONNECTION
) |

4275 (0x1 << 
TFW_HTTP_HDR_SERVER
);

4276 
	}
}

4282 
	$tfw_hâp_adj_∑r£r_ª•
(
TfwHâpRe•
 *
ª•
)

4284 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

4286 i‡(
ªq
->
mëhod
 =
TFW_HTTP_METH_HEAD
)

4287 
ª•
->
Êags
 |
TFW_HTTP_F_VOID_BODY
;

4288 
	}
}

4291 
	$tfw_hâp_∑r£_ª•
(*
ª•_d©a
, *
d©a
, 
size_t
 
Àn
,

4292 *
∑r£d
)

4294 
r
 = 
TFW_BLOCK
;

4295 
TfwHâpRe•
 *
ª•
 = (TfwHâpRe• *)
ª•_d©a
;

4296 
	`__FSM_DECLARE_VARS
(
ª•
);

4297 *
∑r£d
 = 0;

4299 
	`BUILD_BUG_ON
(()
Req_SèãsNum
 >()
Re•_0
);

4300 
	`BUILD_BUG_ON
(()
Re•_SèãsNum
 >()
RGí_OWS
);

4302 
	`TFW_DBG
("parse %lu server data bytes (%.*s%s) onÑesp=%p\n",

4303 
Àn
, 
	`mö
(500, (Óí), 
d©a
,Üí > 500 ? "..." : "", 
ª•
);

4305 
	`__FSM_START
(
∑r£r
->
°©e
) {

4310 
	`__FSM_STATE
(
Re•_0
) {

4311 i‡(
	`u∆ikñy
(
	`IS_CRLF
(
c
)))

4312 
	`__FSM_MOVE_nofixup
(
Re•_0
);

4313 
	`tfw_hâp_adj_∑r£r_ª•
(
ª•
);

4318 
	`__FSM_STATE
(
Re•_HâpVî
) {

4319 i‡(
	`u∆ikñy
(!
	`__d©a_avaûabÀ
(
p
, 9))) {

4321 i‡(
c
 == 'H') {

4322 
	`__msg_fõld_›í
(&
ª•
->
s_löe
, 
p
);

4323 
	`__FSM_MOVE_f
(
Re•_HâpVîT1
, &
ª•
->
s_löe
);

4325 
	`TFW_PARSER_BLOCK
(
Re•_HâpVî
);

4328 *(*)
p
) {

4329 
	`TFW_CHAR8_INT
('H', 'T', 'T', 'P', '/', '1', '.', '1'):

4330 
ª•
->
vîsi⁄
 = 
TFW_HTTP_VER_11
;

4331 i‡(*(
p
 + 8) == ' ') {

4332 
	`__msg_fõld_›í
(&
ª•
->
s_löe
, 
p
);

4333 
	`__FSM_MOVE_nf
(
Re•_SètusCode
, 9,

4334 &
ª•
->
s_löe
);

4336 
	`TFW_PARSER_BLOCK
(
Re•_HâpVî
);

4337 
	`TFW_CHAR8_INT
('H', 'T', 'T', 'P', '/', '1', '.', '0'):

4338 
ª•
->
vîsi⁄
 = 
TFW_HTTP_VER_10
;

4339 i‡(*(
p
 + 8) == ' ') {

4340 
	`__msg_fõld_›í
(&
ª•
->
s_löe
, 
p
);

4341 
	`__FSM_MOVE_nf
(
Re•_SètusCode
, 9,

4342 &
ª•
->
s_löe
);

4346 
	`TFW_PARSER_BLOCK
(
Re•_HâpVî
);

4351 
	`__FSM_STATE
(
Re•_SètusCode
) {

4352 
__fsm_sz
 = 
	`__d©a_ªmaö
(
p
);

4353 
__fsm_n
 = 
	`∑r£_öt_li°
(
p
, 
__fsm_sz
, &
∑r£r
->
_acc
);

4354 
∑r£r
->
_i_°
 = 
I_C⁄n
;

4355 
__fsm_n
) {

4356 
CSTR_POSTPONE
:

4358 
	`__FSM_MOVE_nf
(
Re•_SètusCode
, 
__fsm_sz
,

4359 &
ª•
->
s_löe
);

4360 
CSTR_BADLEN
:

4361 
CSTR_NEQ
:

4363 
	`TFW_PARSER_BLOCK
(
Re•_SètusCode
);

4366 
ª•
->
°©us
 = 
∑r£r
->
_acc
;

4367 
∑r£r
->
_acc
 = 0;

4370 i‡(
ª•
->
°©us
 - 100U < 100U ||Ñesp->status == 204

4371 || 
ª•
->
°©us
 == 304)

4373 
msg
->
Êags
 |
TFW_HTTP_F_VOID_BODY
;

4375 
	`__FSM_MOVE_nf
(
Re•_Rós⁄Phø£
, 
__fsm_n
,

4376 &
ª•
->
s_löe
);

4385 
	`__FSM_STATE
(
Re•_Rós⁄Phø£
) {

4386 
	`__FSM_MATCH_MOVE_f
(
˘ext_vch¨
, 
Re•_Rós⁄Phø£
,

4387 &
ª•
->
s_löe
);

4388 i‡(
	`IS_CRLF
(*(
p
 + 
__fsm_sz
))) {

4389 
	`__msg_fõld_föish
(&
ª•
->
s_löe
, 
p
 + 
__fsm_sz
);

4390 
	`__FSM_MOVE_nofixup_n
(
RGí_EoL
, 
__fsm_sz
);

4392 
	`TFW_PARSER_BLOCK
(
Re•_Rós⁄Phø£
);

4402 
	`__FSM_STATE
(
RGí_Hdr
) {

4403 
	`TFW_HTTP_PARSE_CRLF
();

4405 
	`tfw_hâp_msg_hdr_›í
(
msg
, 
p
);

4407 
	`TFW_LC
(
c
)) {

4409 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 4)

4410 && 
	`C4_INT_LCM
(
p
, 'a', 'g', 'e', ':')))

4412 
∑r£r
->
_i_°
 = 
Re•_HdrAgeV
;

4413 
	`__FSM_MOVE_n
(
RGí_OWS
, 4);

4415 
	`__FSM_MOVE
(
Re•_HdrA
);

4418 i‡(
	`u∆ikñy
(!
	`__d©a_avaûabÀ
(
p
, 14)))

4419 
	`__FSM_MOVE
(
Re•_HdrC
);

4421 
	`TFW_P2LCINT
(
p
 + 1)) {

4422 
	`TFW_CHAR4_INT
('a', 'c', 'h', 'e'):

4423 i‡(
	`likñy
(*(
p
 + 5) == '-'

4424 && 
	`C8_INT_LCM
(
p
 + 6, 'c', 'o', 'n',

4428 
∑r£r
->
_i_°
 = 
Re•_HdrCache_C⁄åﬁV
;

4429 
	`__FSM_MOVE_n
(
RGí_OWS
, 14);

4431 
	`__FSM_MOVE_n
(
RGí_HdrOthî
, 5);

4432 
	`TFW_CHAR4_INT
('o', 'n', 'n', 'e'):

4433 i‡(
	`likñy
(
	`C4_INT_LCM
(
p
 + 5, 'c', 't', 'i', 'o')

4434 && 
	`TFW_LC
(*(
p
 + 9)) == 'n'

4435 && *(
p
 + 10) == ':'))

4437 
∑r£r
->
_i_°
 = 
Re•_HdrC⁄√˘i⁄V
;

4438 
	`__FSM_MOVE_n
(
RGí_OWS
, 11);

4440 
	`__FSM_MOVE_n
(
RGí_HdrOthî
, 5);

4441 
	`TFW_CHAR4_INT
('o', 'n', 't', 'e'):

4442 i‡(
	`likñy
(
	`TFW_LC
(*(
p
 + 5)) == 'n'

4443 && 
	`TFW_LC
(*(
p
 + 6)) == 't'

4444 && *(
p
 + 7) == '-'))

4446 
	`__FSM_MOVE_n
(
Re•_HdrC⁄ã¡_
, 8);

4448 
	`__FSM_MOVE_n
(
RGí_HdrOthî
, 5);

4450 
	`__FSM_MOVE
(
RGí_HdrOthî
);

4453 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5)

4454 && 
	`C4_INT_LCM
(
p
 + 1, 'a', 't', 'e', ':')))

4456 
∑r£r
->
_i_°
 = 
Re•_HdrD©eV
;

4457 
	`__FSM_MOVE_n
(
RGí_OWS
, 5);

4459 
	`__FSM_MOVE
(
Re•_HdrD
);

4461 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5)

4462 && 
	`C4_INT_LCM
(
p
 + 1, 't', 'a', 'g', ':')))

4464 
∑r£r
->
_i_°
 = 
Re•_HdrEègV
;

4465 
	`__FSM_MOVE_n
(
RGí_OWS
, 5);

4467 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 8)

4468 && 
	`C8_INT_LCM
(
p
, 'e', 'x', 'p', 'i',

4471 
∑r£r
->
_i_°
 = 
Re•_HdrExpúesV
;

4472 
	`__FSM_MOVE_n
(
RGí_OWS
, 8);

4474 
	`__FSM_MOVE
(
Re•_HdrE
);

4476 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 11)

4477 && 
	`C4_INT_LCM
(
p
, 'k', 'e', 'e', 'p')

4478 && *(
p
 + 4) == '-'

4479 && 
	`C4_INT_LCM
(
p
 + 5, 'a', 'l', 'i', 'v')

4480 && 
	`TFW_LC
(*(
p
 + 9)) == 'e'

4481 && *(
p
 + 10) == ':'))

4483 
∑r£r
->
_i_°
 = 
Re•_HdrKìp_AliveV
;

4484 
	`__FSM_MOVE_n
(
RGí_OWS
, 11);

4486 
	`__FSM_MOVE
(
Re•_HdrK
);

4488 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 14)

4489 && 
	`C4_INT_LCM
(
p
, 'l', 'a', 's', 't')

4490 && *(
p
 + 4) == '-'

4491 && 
	`C8_INT_LCM
(
p
 + 5, 'm', 'o', 'd', 'i',

4493 && *(
p
 + 13) == ':'))

4495 
∑r£r
->
_i_°
 = 
Re•_HdrLa°_ModifõdV
;

4496 
	`__FSM_MOVE_n
(
RGí_OWS
, 14);

4498 
	`__FSM_MOVE
(
Re•_HdrL
);

4501 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 7)

4502 && 
	`C4_INT_LCM
(
p
 + 1, 'e', 'r', 'v', 'e')

4503 && *(
p
 + 5) == 'r' && *(p + 6) == ':'))

4505 
∑r£r
->
_i_°
 = 
Re•_HdrSîvîV
;

4506 
	`__FSM_MOVE_n
(
RGí_OWS
, 7);

4508 
	`__FSM_MOVE
(
Re•_HdrS
);

4510 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 18)

4511 && 
	`C8_INT_LCM
(
p
, 't', 'r', 'a', 'n',

4513 && *(
p
 + 8) == '-'

4514 && 
	`C8_INT_LCM
(
p
 + 9, 'e', 'n', 'c', 'o',

4516 && *(
p
 + 17) == ':'))

4518 
∑r£r
->
_i_°
 = 
Re•_HdrTøns„r_EncodögV
;

4519 
	`__FSM_MOVE_n
(
RGí_OWS
, 18);

4521 
	`__FSM_MOVE
(
Re•_HdrT
);

4523 
	`__FSM_JMP
(
RGí_HdrOthî
);

4528 
	`__FSM_STATE
(
Re•_HdrC⁄ã¡_
) {

4529 
	`TFW_LC
(
c
)) {

4531 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 7)

4532 && 
	`C4_INT_LCM
(
p
 + 1, 'e', 'n', 'g', 't')

4533 && 
	`TFW_LC
(*(
p
 + 5)) == 'h'

4534 && *(
p
 + 6) == ':'))

4536 
∑r£r
->
_i_°
 = 
Re•_HdrC⁄ã¡_LígthV
;

4537 
	`__FSM_MOVE_n
(
RGí_OWS
, 7);

4539 
	`__FSM_MOVE
(
Re•_HdrC⁄ã¡_L
);

4541 i‡(
	`likñy
(
	`__d©a_avaûabÀ
(
p
, 5)

4542 && 
	`C4_INT_LCM
(
p
 + 1, 'y', 'p', 'e', ':')))

4544 
∑r£r
->
_i_°
 = 
Re•_HdrC⁄ã¡_Ty≥V
;

4545 
	`__FSM_MOVE_n
(
RGí_OWS
, 5);

4547 
	`__FSM_MOVE
(
Re•_HdrC⁄ã¡_T
);

4549 
	`__FSM_JMP
(
RGí_HdrOthî
);

4554 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Re•_HdrAgeV
, 
Re•_I_Age
, 
ª•
,

4555 
__ª•_∑r£_age
);

4558 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Re•_HdrCache_C⁄åﬁV
, 
Re•_I_CC
, 
ª•
,

4559 
__ª•_∑r£_ˇche_c⁄åﬁ
);

4562 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Re•_HdrC⁄√˘i⁄V
, 
I_C⁄n
, 
msg
,

4563 
__∑r£_c⁄√˘i⁄
, 
TFW_HTTP_HDR_CONNECTION
);

4566 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Re•_HdrC⁄ã¡_LígthV
, 
I_C⁄tLí
,

4567 
msg
, 
__∑r£_c⁄ã¡_Àngth
,

4568 
TFW_HTTP_HDR_CONTENT_LENGTH
);

4571 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Re•_HdrC⁄ã¡_Ty≥V
, 
I_C⁄tTy≥
,

4572 
msg
, 
__∑r£_c⁄ã¡_ty≥
,

4573 
TFW_HTTP_HDR_CONTENT_TYPE
);

4576 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Re•_HdrD©eV
, 
I_D©e
, 
msg
,

4577 
__∑r£_hâp_d©e
);

4580 
	`__TFW_HTTP_PARSE_SPECHDR_VAL
(
Re•_HdrEègV
, 
I_Eèg
, 
msg
,

4581 
__∑r£_ëag
, 
TFW_HTTP_HDR_ETAG
, 0);

4584 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Re•_HdrExpúesV
, 
I_D©e
, 
msg
,

4585 
__ª•_∑r£_expúes
);

4588 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Re•_HdrKìp_AliveV
, 
I_KìpAlive
, 
msg
,

4589 
__∑r£_kìp_Æive
, 
TFW_HTTP_HDR_KEEP_ALIVE
);

4592 
	`TFW_HTTP_PARSE_RAWHDR_VAL
(
Re•_HdrLa°_ModifõdV
, 
I_D©e
, 
msg
,

4593 
__∑r£_hâp_d©e
);

4596 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Re•_HdrSîvîV
, 
Re•_I_Sîvî
, 
ª•
,

4597 
__ª•_∑r£_£rvî
, 
TFW_HTTP_HDR_SERVER
);

4600 
	`TFW_HTTP_PARSE_SPECHDR_VAL
(
Re•_HdrTøns„r_EncodögV
, 
I_TønsEncod
,

4601 
msg
, 
__∑r£_å™s„r_ícodög
,

4602 
TFW_HTTP_HDR_TRANSFER_ENCODING
);

4604 
	`RGEN_HDR_OTHER
();

4605 
	`RGEN_OWS
();

4606 
	`RGEN_EOL
();

4607 
	`RGEN_CRLF
();

4611 
	`TFW_HTTP_INIT_RESP_BODY_PARSING
();

4612 
	`TFW_HTTP_PARSE_BODY
();

4613 
	`TFW_HTTP_PARSE_BODY_UNLIM
();

4618 
	`__FSM_TX_f
(
Re•_HâpVîT1
, 'T', 
Re•_HâpVîT2
, &
ª•
->
s_löe
);

4619 
	`__FSM_TX_f
(
Re•_HâpVîT2
, 'T', 
Re•_HâpVîP
, &
ª•
->
s_löe
);

4620 
	`__FSM_TX_f
(
Re•_HâpVîP
, 'P', 
Re•_HâpVîSœsh
, &
ª•
->
s_löe
);

4621 
	`__FSM_TX_f
(
Re•_HâpVîSœsh
, '/', 
Re•_HâpVî11
, &
ª•
->
s_löe
);

4622 
	`__FSM_TX_f
(
Re•_HâpVî11
, '1', 
Re•_HâpVîDŸ
, &
ª•
->
s_löe
);

4623 
	`__FSM_TX_f
(
Re•_HâpVîDŸ
, '.', 
Re•_HâpVî12
, &
ª•
->
s_löe
);

4624 
	`__FSM_STATE
(
Re•_HâpVî12
) {

4625 
c
) {

4627 
ª•
->
vîsi⁄
 = 
TFW_HTTP_VER_11
;

4628 
	`__FSM_MOVE_f
(
Re•_SS∑˚
, &
ª•
->
s_löe
);

4630 
ª•
->
vîsi⁄
 = 
TFW_HTTP_VER_10
;

4631 
	`__FSM_MOVE_f
(
Re•_SS∑˚
, &
ª•
->
s_löe
);

4633 
	`TFW_PARSER_BLOCK
(
Re•_HâpVî12
);

4636 
	`__FSM_TX_f
(
Re•_SS∑˚
, ' ', 
Re•_SètusCode
, &
ª•
->
s_löe
);

4639 
	`__FSM_TX_AF
(
Re•_HdrA
, 'g', 
Re•_HdrAg
, 
RGí_HdrOthî
);

4640 
	`__FSM_TX_AF
(
Re•_HdrAg
, 'e', 
Re•_HdrAge
, 
RGí_HdrOthî
);

4641 
	`__FSM_TX_AF_OWS
(
Re•_HdrAge
, ':', 
Re•_HdrAgeV
, 
RGí_HdrOthî
);

4643 
	`__FSM_STATE
(
Re•_HdrC
) {

4644 
	`TFW_LC
(
c
)) {

4646 
	`__FSM_MOVE
(
Re•_HdrCa
);

4648 
	`__FSM_MOVE
(
Re•_HdrCo
);

4650 
	`__FSM_JMP
(
RGí_HdrOthî
);

4655 
	`__FSM_TX_AF
(
Re•_HdrCa
, 'c', 
Re•_HdrCac
, 
RGí_HdrOthî
);

4656 
	`__FSM_TX_AF
(
Re•_HdrCac
, 'h', 
Re•_HdrCach
, 
RGí_HdrOthî
);

4657 
	`__FSM_TX_AF
(
Re•_HdrCach
, 'e', 
Re•_HdrCache
, 
RGí_HdrOthî
);

4658 
	`__FSM_TX_AF
(
Re•_HdrCache
, '-', 
Re•_HdrCache_
, 
RGí_HdrOthî
);

4659 
	`__FSM_TX_AF
(
Re•_HdrCache_
, 'c', 
Re•_HdrCache_C
, 
RGí_HdrOthî
);

4660 
	`__FSM_TX_AF
(
Re•_HdrCache_C
, 'o', 
Re•_HdrCache_Co
, 
RGí_HdrOthî
);

4661 
	`__FSM_TX_AF
(
Re•_HdrCache_Co
, 'n', 
Re•_HdrCache_C⁄
, 
RGí_HdrOthî
);

4662 
	`__FSM_TX_AF
(
Re•_HdrCache_C⁄
, 't', 
Re•_HdrCache_C⁄t
, 
RGí_HdrOthî
);

4663 
	`__FSM_TX_AF
(
Re•_HdrCache_C⁄t
, 'r', 
Re•_HdrCache_C⁄å
, 
RGí_HdrOthî
);

4664 
	`__FSM_TX_AF
(
Re•_HdrCache_C⁄å
, 'o', 
Re•_HdrCache_C⁄åo
, 
RGí_HdrOthî
);

4665 
	`__FSM_TX_AF
(
Re•_HdrCache_C⁄åo
, 'l', 
Re•_HdrCache_C⁄åﬁ
, 
RGí_HdrOthî
);

4666 
	`__FSM_TX_AF_OWS
(
Re•_HdrCache_C⁄åﬁ
, ':', 
Re•_HdrCache_C⁄åﬁV
, 
RGí_HdrOthî
);

4669 
	`__FSM_TX_AF
(
Re•_HdrCo
, 'n', 
Re•_HdrC⁄
, 
RGí_HdrOthî
);

4670 
	`__FSM_STATE
(
Re•_HdrC⁄
) {

4671 
	`TFW_LC
(
c
)) {

4673 
	`__FSM_MOVE
(
Re•_HdrC⁄n
);

4675 
	`__FSM_MOVE
(
Re•_HdrC⁄t
);

4677 
	`__FSM_JMP
(
RGí_HdrOthî
);

4680 
	`__FSM_TX_AF
(
Re•_HdrC⁄n
, 'e', 
Re•_HdrC⁄√
, 
RGí_HdrOthî
);

4681 
	`__FSM_TX_AF
(
Re•_HdrC⁄√
, 'c', 
Re•_HdrC⁄√c
, 
RGí_HdrOthî
);

4682 
	`__FSM_TX_AF
(
Re•_HdrC⁄√c
, 't', 
Re•_HdrC⁄√˘
, 
RGí_HdrOthî
);

4683 
	`__FSM_TX_AF
(
Re•_HdrC⁄√˘
, 'i', 
Re•_HdrC⁄√˘i
, 
RGí_HdrOthî
);

4684 
	`__FSM_TX_AF
(
Re•_HdrC⁄√˘i
, 'o', 
Re•_HdrC⁄√˘io
, 
RGí_HdrOthî
);

4685 
	`__FSM_TX_AF
(
Re•_HdrC⁄√˘io
, 'n', 
Re•_HdrC⁄√˘i⁄
, 
RGí_HdrOthî
);

4686 
	`__FSM_TX_AF_OWS
(
Re•_HdrC⁄√˘i⁄
, ':', 
Re•_HdrC⁄√˘i⁄V
, 
RGí_HdrOthî
);

4689 
	`__FSM_TX_AF
(
Re•_HdrC⁄t
, 'e', 
Re•_HdrC⁄ã
, 
RGí_HdrOthî
);

4690 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã
, 'n', 
Re•_HdrC⁄ãn
, 
RGí_HdrOthî
);

4691 
	`__FSM_TX_AF
(
Re•_HdrC⁄ãn
, 't', 
Re•_HdrC⁄ã¡
, 
RGí_HdrOthî
);

4692 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡
, '-', 
Re•_HdrC⁄ã¡_
, 
RGí_HdrOthî
);

4695 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_L
, 'e', 
Re•_HdrC⁄ã¡_Le
, 
RGí_HdrOthî
);

4696 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_Le
, 'n', 
Re•_HdrC⁄ã¡_Lí
, 
RGí_HdrOthî
);

4697 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_Lí
, 'g', 
Re•_HdrC⁄ã¡_Líg
, 
RGí_HdrOthî
);

4698 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_Líg
, 't', 
Re•_HdrC⁄ã¡_Lígt
, 
RGí_HdrOthî
);

4699 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_Lígt
, 'h', 
Re•_HdrC⁄ã¡_Lígth
, 
RGí_HdrOthî
);

4700 
	`__FSM_TX_AF_OWS
(
Re•_HdrC⁄ã¡_Lígth
, ':', 
Re•_HdrC⁄ã¡_LígthV
, 
RGí_HdrOthî
);

4703 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_T
, 'y', 
Re•_HdrC⁄ã¡_Ty
, 
RGí_HdrOthî
);

4704 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_Ty
, 'p', 
Re•_HdrC⁄ã¡_Typ
, 
RGí_HdrOthî
);

4705 
	`__FSM_TX_AF
(
Re•_HdrC⁄ã¡_Typ
, 'e', 
Re•_HdrC⁄ã¡_Ty≥
, 
RGí_HdrOthî
);

4706 
	`__FSM_TX_AF_OWS
(
Re•_HdrC⁄ã¡_Ty≥
, ':', 
Re•_HdrC⁄ã¡_Ty≥V
, 
RGí_HdrOthî
);

4709 
	`__FSM_TX_AF
(
Re•_HdrD
, 'a', 
Re•_HdrDa
, 
RGí_HdrOthî
);

4710 
	`__FSM_TX_AF
(
Re•_HdrDa
, 't', 
Re•_HdrD©
, 
RGí_HdrOthî
);

4711 
	`__FSM_TX_AF
(
Re•_HdrD©
, 'e', 
Re•_HdrD©e
, 
RGí_HdrOthî
);

4712 
	`__FSM_TX_AF_OWS
(
Re•_HdrD©e
, ':', 
Re•_HdrD©eV
, 
RGí_HdrOthî
);

4714 
	`__FSM_STATE
(
Re•_HdrE
) {

4715 
	`TFW_LC
(
c
)) {

4717 
	`__FSM_MOVE
(
Re•_HdrEt
);

4719 
	`__FSM_MOVE
(
Re•_HdrEx
);

4721 
	`__FSM_JMP
(
RGí_HdrOthî
);

4725 
	`__FSM_TX_AF
(
Re•_HdrEt
, 'a', 
Re•_HdrEè
, 
RGí_HdrOthî
);

4726 
	`__FSM_TX_AF
(
Re•_HdrEè
, 'g', 
Re•_HdrEèg
, 
RGí_HdrOthî
);

4727 
	`__FSM_TX_AF_OWS
(
Re•_HdrEèg
, ':', 
Re•_HdrEègV
, 
RGí_HdrOthî
);

4730 
	`__FSM_TX_AF
(
Re•_HdrEx
, 'p', 
Re•_HdrExp
, 
RGí_HdrOthî
);

4731 
	`__FSM_TX_AF
(
Re•_HdrExp
, 'i', 
Re•_HdrExpi
, 
RGí_HdrOthî
);

4732 
	`__FSM_TX_AF
(
Re•_HdrExpi
, 'r', 
Re•_HdrExpú
, 
RGí_HdrOthî
);

4733 
	`__FSM_TX_AF
(
Re•_HdrExpú
, 'e', 
Re•_HdrExpúe
, 
RGí_HdrOthî
);

4734 
	`__FSM_TX_AF
(
Re•_HdrExpúe
, 's', 
Re•_HdrExpúes
, 
RGí_HdrOthî
);

4735 
	`__FSM_TX_AF_OWS
(
Re•_HdrExpúes
, ':', 
Re•_HdrExpúesV
, 
RGí_HdrOthî
);

4738 
	`__FSM_TX_AF
(
Re•_HdrK
, 'e', 
Re•_HdrKe
, 
RGí_HdrOthî
);

4739 
	`__FSM_TX_AF
(
Re•_HdrKe
, 'e', 
Re•_HdrKì
, 
RGí_HdrOthî
);

4740 
	`__FSM_TX_AF
(
Re•_HdrKì
, 'p', 
Re•_HdrKìp
, 
RGí_HdrOthî
);

4741 
	`__FSM_TX_AF
(
Re•_HdrKìp
, '-', 
Re•_HdrKìp_
, 
RGí_HdrOthî
);

4742 
	`__FSM_TX_AF
(
Re•_HdrKìp_
, 'a', 
Re•_HdrKìp_A
, 
RGí_HdrOthî
);

4743 
	`__FSM_TX_AF
(
Re•_HdrKìp_A
, 'l', 
Re•_HdrKìp_Al
, 
RGí_HdrOthî
);

4744 
	`__FSM_TX_AF
(
Re•_HdrKìp_Al
, 'i', 
Re•_HdrKìp_Ali
, 
RGí_HdrOthî
);

4745 
	`__FSM_TX_AF
(
Re•_HdrKìp_Ali
, 'v', 
Re•_HdrKìp_Aliv
, 
RGí_HdrOthî
);

4746 
	`__FSM_TX_AF
(
Re•_HdrKìp_Aliv
, 'e', 
Re•_HdrKìp_Alive
, 
RGí_HdrOthî
);

4747 
	`__FSM_TX_AF_OWS
(
Re•_HdrKìp_Alive
, ':', 
Re•_HdrKìp_AliveV
, 
RGí_HdrOthî
);

4750 
	`__FSM_TX_AF
(
Re•_HdrL
, 'a', 
Re•_HdrLa
, 
RGí_HdrOthî
);

4751 
	`__FSM_TX_AF
(
Re•_HdrLa
, 's', 
Re•_HdrLas
, 
RGí_HdrOthî
);

4752 
	`__FSM_TX_AF
(
Re•_HdrLas
, 't', 
Re•_HdrLa°
, 
RGí_HdrOthî
);

4753 
	`__FSM_TX_AF
(
Re•_HdrLa°
, '-', 
Re•_HdrLa°_
, 
RGí_HdrOthî
);

4754 
	`__FSM_TX_AF
(
Re•_HdrLa°_
, 'm', 
Re•_HdrLa°_M
, 
RGí_HdrOthî
);

4755 
	`__FSM_TX_AF
(
Re•_HdrLa°_M
, 'o', 
Re•_HdrLa°_Mo
, 
RGí_HdrOthî
);

4756 
	`__FSM_TX_AF
(
Re•_HdrLa°_Mo
, 'd', 
Re•_HdrLa°_Mod
, 
RGí_HdrOthî
);

4757 
	`__FSM_TX_AF
(
Re•_HdrLa°_Mod
, 'i', 
Re•_HdrLa°_Modi
, 
RGí_HdrOthî
);

4758 
	`__FSM_TX_AF
(
Re•_HdrLa°_Modi
, 'f', 
Re•_HdrLa°_Modif
, 
RGí_HdrOthî
);

4759 
	`__FSM_TX_AF
(
Re•_HdrLa°_Modif
, 'i', 
Re•_HdrLa°_Modifi
, 
RGí_HdrOthî
);

4760 
	`__FSM_TX_AF
(
Re•_HdrLa°_Modifi
, 'e', 
Re•_HdrLa°_Modifõ
, 
RGí_HdrOthî
);

4761 
	`__FSM_TX_AF
(
Re•_HdrLa°_Modifõ
, 'd', 
Re•_HdrLa°_Modifõd
, 
RGí_HdrOthî
);

4762 
	`__FSM_TX_AF_OWS
(
Re•_HdrLa°_Modifõd
, ':', 
Re•_HdrLa°_ModifõdV
, 
RGí_HdrOthî
);

4765 
	`__FSM_TX_AF
(
Re•_HdrS
, 'e', 
Re•_HdrSe
, 
RGí_HdrOthî
);

4766 
	`__FSM_TX_AF
(
Re•_HdrSe
, 'r', 
Re•_HdrSî
, 
RGí_HdrOthî
);

4767 
	`__FSM_TX_AF
(
Re•_HdrSî
, 'v', 
Re•_HdrSîv
, 
RGí_HdrOthî
);

4768 
	`__FSM_TX_AF
(
Re•_HdrSîv
, 'e', 
Re•_HdrSîve
, 
RGí_HdrOthî
);

4769 
	`__FSM_TX_AF
(
Re•_HdrSîve
, 'r', 
Re•_HdrSîvî
, 
RGí_HdrOthî
);

4770 
	`__FSM_TX_AF_OWS
(
Re•_HdrSîvî
, ':', 
Re•_HdrSîvîV
, 
RGí_HdrOthî
);

4773 
	`__FSM_TX_AF
(
Re•_HdrT
, 'r', 
Re•_HdrTr
, 
RGí_HdrOthî
);

4774 
	`__FSM_TX_AF
(
Re•_HdrTr
, 'a', 
Re•_HdrTø
, 
RGí_HdrOthî
);

4775 
	`__FSM_TX_AF
(
Re•_HdrTø
, 'n', 
Re•_HdrTøn
, 
RGí_HdrOthî
);

4776 
	`__FSM_TX_AF
(
Re•_HdrTøn
, 's', 
Re•_HdrTøns
, 
RGí_HdrOthî
);

4777 
	`__FSM_TX_AF
(
Re•_HdrTøns
, 'f', 
Re•_HdrTønsf
, 
RGí_HdrOthî
);

4778 
	`__FSM_TX_AF
(
Re•_HdrTønsf
, 'e', 
Re•_HdrTøns„
, 
RGí_HdrOthî
);

4779 
	`__FSM_TX_AF
(
Re•_HdrTøns„
, 'r', 
Re•_HdrTøns„r
, 
RGí_HdrOthî
);

4780 
	`__FSM_TX_AF
(
Re•_HdrTøns„r
, '-', 
Re•_HdrTøns„r_
, 
RGí_HdrOthî
);

4781 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_
, 'e', 
Re•_HdrTøns„r_E
, 
RGí_HdrOthî
);

4782 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_E
, 'n', 
Re•_HdrTøns„r_En
, 
RGí_HdrOthî
);

4783 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_En
, 'c', 
Re•_HdrTøns„r_Enc
, 
RGí_HdrOthî
);

4784 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_Enc
, 'o', 
Re•_HdrTøns„r_Enco
, 
RGí_HdrOthî
);

4785 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_Enco
, 'd', 
Re•_HdrTøns„r_Encod
, 
RGí_HdrOthî
);

4786 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_Encod
, 'i', 
Re•_HdrTøns„r_Encodi
, 
RGí_HdrOthî
);

4787 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_Encodi
, 'n', 
Re•_HdrTøns„r_Encodö
, 
RGí_HdrOthî
);

4788 
	`__FSM_TX_AF
(
Re•_HdrTøns„r_Encodö
, 'g', 
Re•_HdrTøns„r_Encodög
, 
RGí_HdrOthî
);

4789 
	`__FSM_TX_AF_OWS
(
Re•_HdrTøns„r_Encodög
, ':', 
Re•_HdrTøns„r_EncodögV
, 
RGí_HdrOthî
);

4792 
	`__FSM_FINISH
(
ª•
);

4794  
r
;

4795 
	}
}

	@http_sched_hash.c

38 
	~<löux/hash.h
>

39 
	~<löux/moduÀ.h
>

41 
	~"lib/hash.h
"

42 
	~"ãm≥°a_fw.h
"

43 
	~"log.h
"

44 
	~"£rvî.h
"

45 
	~"hâp_msg.h
"

47 
MODULE_AUTHOR
(
TFW_AUTHOR
);

48 
MODULE_DESCRIPTION
("Tempesta hash-based scheduler");

49 
MODULE_VERSION
("0.4.3");

50 
MODULE_LICENSE
("GPL");

53 
	mhash
;

54 
TfwSrvC⁄n
 *
	mc⁄n
;

55 } 
	tTfwHashC⁄n
;

58 
rcu_hód
 
	mrcu
;

59 
size_t
 
	mc⁄n_n
;

60 
TfwHashC⁄n
 
	mc⁄ns
[0];

61 } 
	tTfwHashC⁄nLi°
;

64 
TfwSîvî
 *
	m§v
;

65 
TfwHashC⁄nLi°
 *
	m˛
;

66 } 
	tTfwHashSrvC⁄nLi°
;

69 
__Æways_ölöe
 

70 
	$__hash_64
(
vÆ
)

72  
vÆ
 * 
GOLDEN_RATIO_64
;

73 
	}
}

76 
	$__ˇlc_§v_hash
(
TfwSîvî
 *
§v
)

78 
hash
;

88 
hash
 = 
	`hash_ˇlc
((*)&
§v
->
addr
, 
	`tfw_addr_ß_Àn
(&srv->addr));

98  
	`__hash_64
(
hash
);

99 
	}
}

107 
ssize_t


108 
	$__b£¨ch
(c⁄° 
hash
, 
TfwHashC⁄nLi°
 *
˛
)

110 
ssize_t
 
°¨t
 = 0, 
íd
 = (ssize_t)
˛
->
c⁄n_n
 - 1, 
mid
 = 0;

111 
mid_hash
;

113 
°¨t
 < 
íd
) {

114 
mid
 = 
°¨t
 + (
íd
 - start) / 2;

116 
mid_hash
 = 
˛
->
c⁄ns
[
mid
].
hash
;

117 i‡(
hash
 < 
mid_hash
)

118 
íd
 = 
mid
;

119 i‡(
hash
 > 
mid_hash
)

120 
°¨t
 = 
mid
 + 1;

122  
mid
;

128  
°¨t
;

129 
	}
}

131 
ölöe
 

132 
	$__is_c⁄n_suôabÀ
(
TfwSrvC⁄n
 *
c⁄n
, 
boﬁ
 
hm⁄ô‹
)

134  (
hm⁄ô‹
 || !
	`tfw_§v_su•íded
((
TfwSîvî
 *)
c⁄n
->
≥î
))

135 && !
	`tfw_§v_c⁄n_ª°ri˘ed
(
c⁄n
)

136 && !
	`tfw_§v_c⁄n_queue_fuŒ
(
c⁄n
)

137 && 
	`tfw_§v_c⁄n_gë_if_live
(
c⁄n
);

138 
	}
}

160 
ölöe
 
TfwSrvC⁄n
 *

161 
	$__föd_be°_c⁄n
(
TfwMsg
 *
msg
, 
TfwHashC⁄nLi°
 *
˛
)

163 
ssize_t
 
l_idx
, 
r_idx
, 
idx
;

164 
TfwSrvC⁄n
 *
c⁄n
;

165 
boﬁ
 
hm⁄ô‹
 = ((
TfwHâpReq
 *)
msg
)->
Êags
 & 
TFW_HTTP_F_HMONITOR
;

166 
msg_hash
 = 
	`tfw_hâp_ªq_key_ˇlc
((
TfwHâpReq
 *)
msg
);

167 
be°_hash
 = (~0UL ^ 
msg_hash
);

169 i‡(
	`u∆ikñy
(!
˛
->
c⁄n_n
))

170  
NULL
;

177 
idx
 = 
	`__b£¨ch
(
be°_hash
, 
˛
);

178 
c⁄n
 = 
˛
->
c⁄ns
[
idx
].conn;

179 i‡(
	`likñy
(
	`__is_c⁄n_suôabÀ
(
c⁄n
, 
hm⁄ô‹
)))

180  
c⁄n
;

186 
r_idx
 = 
idx
 + 1;

187 
l_idx
 = 
idx
 - 1;

188 
l_idx
 >0 || 
r_idx
 < (
ssize_t
)
˛
->
c⁄n_n
) {

189 
l_diff
 = (
l_idx
 >= 0)

190 ? (
be°_hash
 - 
˛
->
c⁄ns
[
l_idx
].
hash
)

191 : 
ULONG_MAX
;

192 
r_diff
 = (
r_idx
 < (
ssize_t
)
˛
->
c⁄n_n
)

193 ? (
˛
->
c⁄ns
[
r_idx
].
hash
 - 
be°_hash
)

194 : 
ULONG_MAX
;

195 
ssize_t
 
be°_idx
 = (
l_diff
 <
r_diff
Ë? 
l_idx
 : 
r_idx
;

197 
c⁄n
 = 
˛
->
c⁄ns
[
be°_idx
].conn;

198 i‡(
	`likñy
(
	`__is_c⁄n_suôabÀ
(
c⁄n
, 
hm⁄ô‹
)))

199  
c⁄n
;

201 i‡(
l_diff
 <
r_diff
)

202 --
l_idx
;

204 ++
r_idx
;

207  
NULL
;

208 
	}
}

210 
TfwSrvC⁄n
 *

211 
	$tfw_sched_hash_gë_sg_c⁄n
(
TfwMsg
 *
msg
, 
TfwSrvGroup
 *
sg
)

213 
TfwHashC⁄nLi°
 *
˛
;

214 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
NULL
;

216 
	`rcu_ªad_lock_bh
();

217 
˛
 = 
	`rcu_dîe„ªn˚_bh
(
sg
->
sched_d©a
);

219 i‡(
	`likñy
(
˛
))

220 
§v_c⁄n
 = 
	`__föd_be°_c⁄n
(
msg
, 
˛
);

222 
	`rcu_ªad_u∆ock_bh
();

224  
§v_c⁄n
;

225 
	}
}

231 
TfwSrvC⁄n
 *

232 
	$tfw_sched_hash_gë_§v_c⁄n
(
TfwMsg
 *
msg
, 
TfwSîvî
 *
§v
)

234 
TfwHashC⁄nLi°
 *
˛
;

235 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
NULL
;

237 
	`rcu_ªad_lock_bh
();

238 
˛
 = 
	`rcu_dîe„ªn˚_bh
(
§v
->
sched_d©a
);

240 i‡(
	`likñy
(
˛
))

241 
§v_c⁄n
 = 
	`__föd_be°_c⁄n
(
msg
, 
˛
);

243 
	`rcu_ªad_u∆ock_bh
();

245  
§v_c⁄n
;

246 
	}
}

249 
	$tfw_sched_hash_˛ónup_rcu_cb
(
rcu_hód
 *
rcu
)

251 
TfwHashC⁄nLi°
 *
˛
 = 
	`c⁄èöî_of
(
rcu
, TfwHashConnList,Ñcu);

252 
	`k‰ì
(
˛
);

253 
	}
}

256 
	$tfw_sched_hash_dñ_gΩ
(
TfwSrvGroup
 *
sg
)

258 
TfwSîvî
 *
§v
;

259 
TfwHashC⁄nLi°
 *
˛
 = 
	`rcu_dîe„ªn˚_bh_check
(
sg
->
sched_d©a
, 1);

261 
	`RCU_INIT_POINTER
(
sg
->
sched_d©a
, 
NULL
);

262 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

263 
	`WARN_ON_ONCE
(
	`rcu_dîe„ªn˚_bh_check
(
§v
->
sched_d©a
, 1)

264 && !
˛
);

265 
	`RCU_INIT_POINTER
(
§v
->
sched_d©a
, 
NULL
);

267 i‡(!
˛
)

270 
	`ˇŒ_rcu_bh
(&
˛
->
rcu
, 
tfw_sched_hash_˛ónup_rcu_cb
);

271 
	}
}

274 
	$__add_c⁄n
(
TfwHashC⁄nLi°
 *
˛
, 
TfwSrvC⁄n
 *
c⁄n
, 
hash
)

276 
ssize_t
 
idx
;

277 
TfwHashC⁄n
 
√w_hc⁄
 = {
hash
, 
c⁄n
};

280 i‡(
	`u∆ikñy
(!
˛
->
c⁄n_n
)) {

281 
˛
->
c⁄ns
[0] = 
√w_hc⁄
;

282 ++
˛
->
c⁄n_n
;

287 
idx
 = 
	`__b£¨ch
(
hash
, 
˛
);

288 i‡(
˛
->
c⁄ns
[
idx
].
hash
 == hash)

289  -
EEXIST
;

292 i‡((
hash
 > 
˛
->
c⁄ns
[
idx
].hashË&& (idx !(
ssize_t
)˛->
c⁄n_n
))

293 ++
idx
;

295 i‡((
size_t
)
idx
 !
˛
->
c⁄n_n
)

296 
	`memmove
(&
˛
->
c⁄ns
[
idx
+1], &cl->conns[idx],

297 (
TfwHashC⁄n
Ë* (
˛
->
c⁄n_n
 - (
size_t
)
idx
));

299 
˛
->
c⁄ns
[
idx
] = 
√w_hc⁄
;

300 ++
˛
->
c⁄n_n
;

303 
	}
}

310 
	$__fûl_§v_li°s
(
TfwHashC⁄nLi°
 *
˛
, 
size_t
 
§v_n
, 
TfwHashSrvC⁄nLi°
 *
§v_˛s
)

312 
size_t
 
i
, 
j
;

314 
i
 = 0; i < 
§v_n
; ++i) {

315 
TfwSîvî
 *
§v
 = 
§v_˛s
[
i
].srv;

316 
TfwHashC⁄nLi°
 *
s˛
 = 
§v_˛s
[
i
].
˛
;

318 
j
 = 0; j < 
˛
->
c⁄n_n
; ++j) {

319 
TfwHashC⁄n
 *
hc⁄n
 = &
˛
->
c⁄ns
[
j
];

320 i‡((
TfwSîvî
 *)
hc⁄n
->
c⁄n
->
≥î
 =
§v
) {

321 
s˛
->
c⁄ns
[s˛->
c⁄n_n
] = *
hc⁄n
;

322 ++
s˛
->
c⁄n_n
;

325 
	`rcu_assign_poöãr
(
§v
->
sched_d©a
, 
s˛
);

327 
	}
}

330 
	$tfw_sched_hash_add_c⁄ns
(
TfwSîvî
 *
§v
, 
TfwHashC⁄nLi°
 *
˛
, 
size_t
 *
£ed
,

331 
size_t
 
£ed_öc
)

333 
TfwSrvC⁄n
 *
c⁄n
;

334 
§v_hash
 = 
	`__ˇlc_§v_hash
(
§v
);

336 
	`li°_f‹_óch_íåy
(
c⁄n
, &
§v
->
c⁄n_li°
, 
li°
) {

337 
hash
;

339 
hash
 = 
	`__hash_64
(
§v_hash
 ^ *
£ed
);

340 *
£ed
 +
£ed_öc
;

341 } 
	`__add_c⁄n
(
˛
, 
c⁄n
, 
hash
));

343 
	}
}

346 
	$tfw_sched_hash_add_gΩ
(
TfwSrvGroup
 *
sg
, *
d©a
)

348 
size_t
 
size
, 
c⁄n_n
 = 0, 
off£t
 = 0, 
£ed
, 
£ed_öc
, 
i
 = 0;

349 
TfwSîvî
 *
§v
;

350 
TfwHashC⁄nLi°
 *
˛
;

351 
TfwHashSrvC⁄nLi°
 *
§v_˛s
;

353 i‡(
	`u∆ikñy
(!
sg
->
§v_n
 || 
	`li°_em±y
(&sg->
§v_li°
)))

354  -
EINVAL
;

356 
£ed
 = 
	`gë_øndom_l⁄g
();

357 
£ed_öc
 = 
	`gë_øndom_öt
();

359 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
)

360 
c⁄n_n
 +
§v
->conn_n;

362 
size
 = (
TfwHashC⁄nLi°
Ë* (
sg
->
§v_n
 + 1)

363 + (
TfwHashC⁄n
Ë* 
c⁄n_n
 * 2;

364 i‡(!(
˛
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
)))

365  -
ENOMEM
;

366 i‡(!(
§v_˛s
 = 
	`kˇŒoc
(
sg
->
§v_n
, (
TfwHashSrvC⁄nLi°
),

367 
GFP_KERNEL
)))

369 
	`k‰ì
(
˛
);

370  -
ENOMEM
;

372 
off£t
 = (
TfwHashC⁄nLi°
Ë+ (
TfwHashC⁄n
Ë* 
c⁄n_n
;

378 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

380 
§v_˛s
[
i
].
§v
 = srv;

381 
§v_˛s
[
i
].
˛
 = (*)˛ + 
off£t
;

382 
off£t
 +(
TfwHashC⁄nLi°
)

383 + (
TfwHashC⁄n
Ë* 
§v
->
c⁄n_n
;

384 ++
i
;

386 
	`tfw_sched_hash_add_c⁄ns
(
§v
, 
˛
, &
£ed
, 
£ed_öc
);

389 
	`__fûl_§v_li°s
(
˛
, 
sg
->
§v_n
, 
§v_˛s
);

391 
	`rcu_assign_poöãr
(
sg
->
sched_d©a
, 
˛
);

392 
	`k‰ì
(
§v_˛s
);

395 
	}
}

398 
	$tfw_sched_hash_add_§v
(
TfwSîvî
 *
§v
)

400 
size_t
 
size
, 
£ed
, 
£ed_öc
 = 0;

401 
TfwHashC⁄nLi°
 *
˛
 = 
	`rcu_dîe„ªn˚_check
(
§v
->
sched_d©a
, 1);

403 i‡(
	`u∆ikñy
(
˛
))

404  -
EEXIST
;

406 
£ed
 = 
	`gë_øndom_l⁄g
();

407 
£ed_öc
 = 
	`gë_øndom_öt
();

409 
size
 = (
TfwHashC⁄nLi°
Ë+ 
§v
->
c⁄n_n
 * (
TfwHashC⁄n
);

410 i‡(!(
˛
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
)))

411  -
ENOMEM
;

413 
	`tfw_sched_hash_add_c⁄ns
(
§v
, 
˛
, &
£ed
, 
£ed_öc
);

415 
	`rcu_assign_poöãr
(
§v
->
sched_d©a
, 
˛
);

418 
	}
}

421 
	$tfw_sched_hash_put_§v_d©a
(
rcu_hód
 *
rcu
)

423 
TfwHashC⁄nLi°
 *
˛
 = 
	`c⁄èöî_of
(
rcu
, TfwHashConnList,Ñcu);

424 
	`k‰ì
(
˛
);

425 
	}
}

428 
	$tfw_sched_hash_dñ_§v
(
TfwSîvî
 *
§v
)

430 
TfwHashC⁄nLi°
 *
˛
 = 
	`rcu_dîe„ªn˚_bh_check
(
§v
->
sched_d©a
, 1);

432 
	`RCU_INIT_POINTER
(
§v
->
sched_d©a
, 
NULL
);

433 i‡(
˛
)

434 
	`ˇŒ_rcu_bh
(&
˛
->
rcu
, 
tfw_sched_hash_put_§v_d©a
);

435 
	}
}

437 
TfwScheduÀr
 
	gtfw_sched_hash
 = {

438 .
«me
 = "hash",

439 .
	gli°
 = 
LIST_HEAD_INIT
(
tfw_sched_hash
.
li°
),

440 .
	gadd_gΩ
 = 
tfw_sched_hash_add_gΩ
,

441 .
	gdñ_gΩ
 = 
tfw_sched_hash_dñ_gΩ
,

442 .
	gadd_§v
 = 
tfw_sched_hash_add_§v
,

443 .
	gdñ_§v
 = 
tfw_sched_hash_dñ_§v
,

444 .
	gsched_sg_c⁄n
 = 
tfw_sched_hash_gë_sg_c⁄n
,

445 .
	gsched_§v_c⁄n
 = 
tfw_sched_hash_gë_§v_c⁄n
,

449 
	$tfw_sched_hash_öô
()

451 
	`TFW_DBG
("sched_hash: init\n");

452  
	`tfw_sched_ªgi°î
(&
tfw_sched_hash
);

453 
	}
}

456 
	$tfw_sched_hash_exô
()

458 
	`TFW_DBG
("sched_hash:Éxit\n");

459 
	`tfw_sched_uƒegi°î
(&
tfw_sched_hash
);

460 
	}
}

	@http_sched_ratio.c

20 
	~<löux/kî√l.h
>

21 
	~<löux/moduÀ.h
>

22 
	~<löux/s‹t.h
>

24 
	~"ãm≥°a_fw.h
"

25 
	~"≠m.h
"

26 
	~"log.h
"

27 
	~"£rvî.h
"

28 
	~"hâp.h
"

30 
	#TFW_SCHED_RATIO_INTVL
 (
HZ
 / 20Ë

	)

46 
rcu_hód
 
	mrcu
;

47 
TfwSîvî
 *
	m§v
;

48 
TfwSrvC⁄n
 **
	mc⁄n
;

49 
©omic64_t
 
	mcou¡î
;

50 
size_t
 
	mc⁄n_n
;

51 
	m£q
;

52 } 
	tTfwR©ioSrvDesc
;

63 
size_t
 
	msdidx
;

64 
	mweight
;

65 
	m¸©io
;

66 
	m‹©io
;

67 } 
	tTfwR©ioSrvD©a
;

84 
•ölock_t
 
	mlock
;

85 
size_t
 
	mcsidx
;

86 
size_t
 
	mªidx
;

87 
	mrôî
;

88 
	m¸sum
;

89 
	m‹sum
;

90 } 
	tTfwR©ioSchD©a
;

99 
	m˙t
;

100 
	mπt
;

101 } 
	tTfwR©ioH°Unô
;

118 
	mc€ff_a
;

119 
	mc€ff_b
;

120 
	m˙t_avg
;

121 
	mπt_avg
;

122 
	m˙t_πt_avg
;

123 
	m˙t_avg_πt_avg
;

124 
	m˙t_sq_avg
;

125 
	m˙t_avg_sq
;

126 
TfwR©ioH°Unô
 *
	mhi°
;

127 } 
	tTfwR©ioH°Desc
;

138 
	mahód
;

139 
size_t
 
	m¶Ÿ_n
;

140 
	mcou¡î
;

141 
TfwR©ioH°Desc
 *
	mh°desc
;

142 } 
	tTfwR©ioH°D©a
;

155 
rcu_hód
 
	mrcu
;

156 
TfwR©ioSrvD©a
 *
	m§vd©a
;

157 
TfwR©ioSchD©a
 
	mschd©a
;

158 } 
	tTfwR©ioD©a
;

174 
rcu_hód
 
	mrcu
;

175 
size_t
 
	m§v_n
;

176 
size_t
 
	mpsidx
;

177 
	mötvl
;

178 
©omic_t
 
	mª¨m
;

179 
timî_li°
 
	mtimî
;

180 
TfwR©ioH°D©a
 *
	mh°d©a
;

181 
TfwR©ioSrvDesc
 *
	m§vdesc
;

182 
TfwR©ioD©a
 
__rcu
 *
	mπod©a
;

183 } 
	tTfwR©io
;

189 
	$tfw_sched_øtio_§vd©a_sw≠
(*
lhs
, *
rhs
, 
size
)

191 
TfwR©ioSrvD©a
 *
lhs_d©a
 = (TfwR©ioSrvD©®*)
lhs
;

192 
TfwR©ioSrvD©a
 *
rhs_d©a
 = (TfwR©ioSrvD©®*)
rhs
;

193 
TfwR©ioSrvD©a
 
tmp
 = *
lhs_d©a
;

194 *
lhs_d©a
 = *
rhs_d©a
;

195 *
rhs_d©a
 = 
tmp
;

196 
	}
}

203 
	$tfw_sched_øtio_§vd©a_cmp
(c⁄° *
lhs
, c⁄° *
rhs
)

205 
lhs_øtio
 = ((c⁄° 
TfwR©ioSrvD©a
 *)
lhs
)->
‹©io
;

206 
rhs_øtio
 = ((c⁄° 
TfwR©ioSrvD©a
 *)
rhs
)->
‹©io
;

208  (
rhs_øtio
 < 
lhs_øtio
) ? -1 : (rhs_ratio >Ühs_ratio);

209 
	}
}

218 
	$tfw_sched_øtio_ˇlc
(
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
,

219 
sum_wgt
, 
size_t
 
max_vÆ_idx
,

220 
size_t
 *
¨g_ovidx
)

222 
size_t
 
si
, 
⁄e_vÆ_idx
;

223 
diff
, 
max_wgt
, 
‹©io
;

224 
unô
, 
sum_øtio
 = 0;

225 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

226 
TfwR©ioSchD©a
 *
schd©a
 = &
πod©a
->schdata;

229 
schd©a
->
csidx
 = 0;

230 
schd©a
->
rôî
 = 1;

231 
schd©a
->
ªidx
 = 
øtio
->
§v_n
;

240 
diff
 = 
⁄e_vÆ_idx
 = 0;

241 
max_wgt
 = 
§vd©a
[
max_vÆ_idx
].
weight
;

242 
unô
 = ((
max_wgt
 + 
øtio
->
§v_n
Ë* max_wgtË/ 
sum_wgt
;

243 
si
 = 0; sò< 
øtio
->
§v_n
; ++si) {

244 
‹©io
 = (
unô
 * 
§vd©a
[
si
].
weight
Ë/ 
max_wgt
 ? : 1;

245 
§vd©a
[
si
].
¸©io
 = srvd©a[si].
‹©io
 = oratio;

246 
diff
 |(
‹©io
 !
§vd©a
[0].oratio);

247 
sum_øtio
 +
‹©io
;

248 i‡((
‹©io
 =1Ë&& !
⁄e_vÆ_idx
)

249 
⁄e_vÆ_idx
 = 
si
;

251 
schd©a
->
¸sum
 = schd©a->
‹sum
 = 
sum_øtio
;

254 *
¨g_ovidx
 = 
⁄e_vÆ_idx
;

256  
diff
;

257 
	}
}

264 
	$tfw_sched_øtio_ˇlc_°©ic
(
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
)

266 
sum_wgt
;

267 
diff
;

268 
size_t
 
si
, 
max_vÆ_idx
, 
⁄e_vÆ_idx
;

269 
TfwR©ioSrvDesc
 *
§vdesc
 = 
øtio
->srvdesc;

270 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

279 
sum_wgt
 = 
diff
 = 
max_vÆ_idx
 = 0;

280 
si
 = 0; sò< 
øtio
->
§v_n
; ++si) {

281 
weight
 = 
§vdesc
[
si
].
§v
->weight;

282 
§vd©a
[
si
].
sdidx
 = si;

283 
§vd©a
[
si
].
weight
 = weight;

284 
§vd©a
[
si
].
¸©io
 = srvd©a[si].
‹©io
 = 1;

285 i‡(
§vd©a
[
max_vÆ_idx
].
weight
 < weight)

286 
max_vÆ_idx
 = 
si
;

287 
sum_wgt
 +
weight
;

288 
diff
 |(
weight
 !
§vd©a
[0].weight);

295 i‡(!
diff
) {

296 
TfwR©ioSchD©a
 *
schd©a
 = &
πod©a
->schdata;

299 
schd©a
->
csidx
 = 0;

300 
schd©a
->
rôî
 = 1;

301 
schd©a
->
ªidx
 = 
øtio
->
§v_n
;

303 
schd©a
->
¸sum
 = schd©a->
‹sum
 = 
øtio
->
§v_n
;

307 i‡(!
	`tfw_sched_øtio_ˇlc
(
øtio
, 
πod©a
, 
sum_wgt
,

308 
max_vÆ_idx
, &
⁄e_vÆ_idx
))

312 
	`s‹t
(
§vd©a
, 
øtio
->
§v_n
, (srvdata[0]),

313 
tfw_sched_øtio_§vd©a_cmp
, 
tfw_sched_øtio_§vd©a_sw≠
);

314 
	}
}

355 
	$__tfw_sched_øtio_ˇlc_dy«mic
(
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
,

356 
sum_wgt
, 
size_t
 
max_vÆ_idx
)

358 
size_t
 
si
, 
⁄e_vÆ_idx
, 
À·
 = 0, 
right
 = 0;

359 
max_øtio
, 
has_⁄e_vÆ
;

360 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

363 i‡(!
	`tfw_sched_øtio_ˇlc
(
øtio
, 
πod©a
, 
sum_wgt
,

364 
max_vÆ_idx
, &
⁄e_vÆ_idx
))

373 
has_⁄e_vÆ
 = (
§vd©a
[
⁄e_vÆ_idx
].
‹©io
 == 1);

375 i‡(
has_⁄e_vÆ
) {

376 
‹sum
 = 
πod©a
->
schd©a
.orsum;

377 
TfwR©ioSrvD©a
 
sdít_⁄e
 = 
§vd©a
[
⁄e_vÆ_idx
];

378 
TfwR©ioSrvD©a
 
sdít_max
 = 
§vd©a
[
max_vÆ_idx
];

381 
max_øtio
 = 
§vd©a
[
max_vÆ_idx
].
‹©io
;

383 
si
 = 0; sò< 
øtio
->
§v_n
; ++si) {

384 i‡(
§vd©a
[
si
].
‹©io
 == 1) {

385 
§vd©a
[
si
].
weight
 = 
sdít_max
.weight;

386 
§vd©a
[
si
].
‹©io
 =

387 
§vd©a
[
si
].
¸©io
 = 
sdít_max
.
‹©io
;

388 
‹sum
 +
sdít_max
.
‹©io
 - 1;

389 } i‡(
§vd©a
[
si
].
‹©io
 =
sdít_max
.oratio) {

390 
§vd©a
[
si
].
weight
 = 
sdít_⁄e
.weight;

391 
§vd©a
[
si
].
‹©io
 =

392 
§vd©a
[
si
].
¸©io
 = 
sdít_⁄e
.
‹©io
;

393 
‹sum
 -
sdít_max
.
‹©io
 - 1;

396 
πod©a
->
schd©a
.
¸sum
 =Ñtod©a->schd©a.
‹sum
 = orsum;

400 
	`s‹t
(
§vd©a
, 
øtio
->
§v_n
, (srvdata[0]),

401 
tfw_sched_øtio_§vd©a_cmp
, 
tfw_sched_øtio_§vd©a_sw≠
);

410 i‡(!
has_⁄e_vÆ
) {

411 
À·
 = 0;

412 
right
 = 
øtio
->
§v_n
 - 1;

414 
si
 = 0; sò< 
øtio
->
§v_n
; ++si)

415 i‡(
§vd©a
[
si
].
‹©io
 =
max_øtio
) {

416 
À·
 = 
si
 + 1;

417 } i‡(
§vd©a
[
si
].
‹©io
 == 1) {

418 
right
 = 
si
 - 1;

422 
À·
 < 
right
) {

423 
size_t
 
À·_sdidx
 = 
§vd©a
[
À·
].
sdidx
;

424 
§vd©a
[
À·
++].
sdidx
 = srvd©a[
right
].sdidx;

425 
§vd©a
[
right
--].
sdidx
 = 
À·_sdidx
;

429 
	}
}

453 
ölöe
 

454 
	$__tfw_sched_øtio_gë_πt
(
size_t
 
si
, 
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
)

456 
ªˇlc
;

457 
vÆ
[
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)] = { 0 };

458 
TfwPr˙éSèts
 
p°©s
 = {

459 .
ôh
 = 
tfw_p°©s_ôh
,

460 .
vÆ
 = val,

461 .
psz
 = 
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)

463 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

464 
TfwR©ioSrvDesc
 *
§vdesc
 = 
øtio
->srvdesc;

466 
p°©s
.
£q
 = 
§vdesc
[
si
].seq;

467 
ªˇlc
 = 
	`tfw_≠m_°©s
(
§vdesc
[
si
].
§v
->
≠mªf
, &
p°©s
);

468 
§vdesc
[
si
].
£q
 = 
p°©s
.seq;

470 
§vd©a
[
si
].
sdidx
 = si;

471 
§vd©a
[
si
].
weight
 = 
p°©s
.
vÆ
[
øtio
->
psidx
] ? : 1;

473  
ªˇlc
;

474 
	}
}

485 
	$tfw_sched_øtio_ˇlc_dy«mic
(
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
)

487 
size_t
 
si
, 
max_vÆ_idx
 = 0;

488 
sum_wgt
 = 0;

489 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

496 
si
 = 0; sò< 
øtio
->
§v_n
; ++si) {

497 
	`__tfw_sched_øtio_gë_πt
(
si
, 
øtio
, 
πod©a
);

498 i‡(
§vd©a
[
max_vÆ_idx
].
weight
 < srvd©a[
si
].weight)

499 
max_vÆ_idx
 = 
si
;

500 
sum_wgt
 +
§vd©a
[
si
].
weight
;

503 
	`__tfw_sched_øtio_ˇlc_dy«mic
(
øtio
, 
πod©a
, 
sum_wgt
, 
max_vÆ_idx
);

504 
	}
}

529 
	$tfw_sched_øtio_ˇlc_¥edi˘
(
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
)

531 c⁄° 
MUL
 = 1000;

532 
ni
, 
sz
;

533 
size_t
 
si
, 
max_vÆ_idx
;

534 
sum_wgt
;

535 
˙t
, 
πt
, 
ahód
, 
¥edi˘i⁄
;

536 
TfwR©ioH°D©a
 *
h°d©a
 = 
øtio
->hstdata;

537 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

539 
ni
 = 
h°d©a
->
cou¡î
 % h°d©a->
¶Ÿ_n
;

540 
˙t
 = 
h°d©a
->
cou¡î
 * 
MUL
;

541 
ahód
 = 
h°d©a
->
cou¡î
 + hstdata->ahead;

543 
sum_wgt
 = 
max_vÆ_idx
 = 0;

544 
si
 = 0; sò< 
øtio
->
§v_n
; ++si) {

545 
TfwR©ioH°Desc
 *
hd
 = &
h°d©a
->
h°desc
[
si
];

547 
	`__tfw_sched_øtio_gë_πt
(
si
, 
øtio
, 
πod©a
);

549 
πt
 = 
§vd©a
[
si
].
weight
 * 
MUL
;

556 i‡(
	`u∆ikñy
(
h°d©a
->
cou¡î
 < h°d©a->
¶Ÿ_n
)) {

557 
sz
 = 
ni
 + 1;

558 
hd
->
˙t_avg
 = (hd->˙t_avg * 
ni
 + 
˙t
Ë/ 
sz
;

559 
hd
->
πt_avg
 = (hd->πt_avg * 
ni
 + 
πt
Ë/ 
sz
;

560 
hd
->
˙t_πt_avg
 =

561 (
hd
->
˙t_πt_avg
 * 
ni
 + 
˙t
 * 
πt
Ë/ 
sz
;

562 
hd
->
˙t_avg_πt_avg
 = hd->
˙t_avg
 * hd->
πt_avg
;

563 
hd
->
˙t_sq_avg
 =

564 (
hd
->
˙t_sq_avg
 * 
ni
 + 
˙t
 * c¡Ë/ 
sz
;

565 
hd
->
˙t_avg_sq
 = hd->
˙t_avg
 * hd->cnt_avg;

567 
h_˙t
 = 
hd
->
hi°
[
ni
].
˙t
;

568 
h_πt
 = 
hd
->
hi°
[
ni
].
πt
;

569 
sz
 = 
h°d©a
->
¶Ÿ_n
;

570 
hd
->
˙t_avg
 = hd->˙t_avg - (
h_˙t
 - 
˙t
Ë/ 
sz
;

571 
hd
->
πt_avg
 = hd->πt_avg - (
h_πt
 - 
πt
Ë/ 
sz
;

572 
hd
->
˙t_πt_avg
 = hd->cnt_rtt_avg

573 - (
h_˙t
 * 
h_πt
 - 
˙t
 * 
πt
Ë/ 
sz
;

574 
hd
->
˙t_avg_πt_avg
 = hd->
˙t_avg
 * hd->
πt_avg
;

575 
hd
->
˙t_sq_avg
 = hd->cnt_sq_avg

576 - (
h_˙t
 * h_˙à- 
˙t
 * c¡Ë/ 
sz
;

577 
hd
->
˙t_avg_sq
 = hd->
˙t_avg
 * hd->cnt_avg;

580 
hd
->
hi°
[
ni
].
˙t
 = cnt;

581 
hd
->
hi°
[
ni
].
πt
 =Ñtt;

583 i‡(
hd
->
˙t_sq_avg
 =hd->
˙t_avg_sq
) {

584 
hd
->
c€ff_a
 = 0;

585 
hd
->
c€ff_b
 = hd->
˙t_avg


586 ? 
hd
->
πt_avg
 / hd->
˙t_avg
 : 1;

588 
hd
->
c€ff_b
 = (hd->
˙t_πt_avg
 - hd->
˙t_avg_πt_avg
)

589 / (
hd
->
˙t_sq_avg
 - hd->
˙t_avg_sq
);

590 
hd
->
c€ff_a
 = (hd->
πt_avg
 - hd->
c€ff_b
 * hd->
˙t_avg
)

591 / 
MUL
;

594 
¥edi˘i⁄
 = 
hd
->
c€ff_a
 + hd->
c€ff_b
 * 
ahód
;

595 
§vd©a
[
si
].
weight
 = 
¥edi˘i⁄
 <= 0 ? 1 :Örediction;

597 i‡(
§vd©a
[
max_vÆ_idx
].
weight
 < srvd©a[
si
].weight)

598 
max_vÆ_idx
 = 
si
;

599 
sum_wgt
 +
§vd©a
[
si
].
weight
;

602 ++
h°d©a
->
cou¡î
;

604 
	`__tfw_sched_øtio_ˇlc_dy«mic
(
øtio
, 
πod©a
, 
sum_wgt
, 
max_vÆ_idx
);

605 
	}
}

610 
TfwR©ioD©a
 *

611 
	$tfw_sched_øtio_πod©a_gë
(
TfwR©io
 *
øtio
)

613 
size_t
 
size
;

614 
TfwR©ioD©a
 *
πod©a
;

616 
size
 = (
TfwR©ioD©a
Ë+ (
TfwR©ioSrvD©a
Ë* 
øtio
->
§v_n
;

617 i‡(!(
πod©a
 = 
	`kmÆloc
(
size
, 
GFP_ATOMIC
)))

618  
NULL
;

619 
πod©a
->
§vd©a
 = (
TfwR©ioSrvD©a
 *)(rtodata + 1);

620 
	`•ö_lock_öô
(&
πod©a
->
schd©a
.
lock
);

622  
πod©a
;

623 
	}
}

629 
	$tfw_sched_øtio_πod©a_put
(
rcu_hód
 *
rcup
)

631 
TfwR©ioD©a
 *
πod©a
 = 
	`c⁄èöî_of
(
rcup
, TfwR©ioD©a, 
rcu
);

632 
	`k‰ì
(
πod©a
);

633 
	}
}

644 
tfw_sched_øtio_ˇlc_tm‚
(
TfwR©io
 *
øtio
,

645 (*
ˇlc_‚
)(
TfwR©io
 *, 
TfwR©ioD©a
 *))

647 
TfwR©ioD©a
 *
¸tod©a
, *
ƒtod©a
;

655 i‡(!(
ƒtod©a
 = 
	`tfw_sched_øtio_πod©a_gë
(
øtio
))) {

656 
	`TFW_ERR
("SchedÑatio: Insufficient memory\n");

657 
ª¨m
;

661 
	`ˇlc_‚
(
øtio
, 
ƒtod©a
);

668 
¸tod©a
 = 
øtio
->
πod©a
;

669 
	`rcu_assign_poöãr
(
øtio
->
πod©a
, 
ƒtod©a
);

670 
	`ˇŒ_rcu_bh
(&
¸tod©a
->
rcu
, 
tfw_sched_øtio_πod©a_put
);

672 
ª¨m
:

673 
	`smp_mb
();

674 i‡(
	`©omic_ªad
(&
øtio
->
ª¨m
))

675 
	`mod_timî
(&
øtio
->
timî
, 
jiffõs
 +Ñ©io->
ötvl
);

676 
	}
}

682 
	$tfw_sched_øtio_dy«mic_tm‚
(
tm‚_d©a
)

684 
	`tfw_sched_øtio_ˇlc_tm‚
((
TfwR©io
 *)
tm‚_d©a
,

685 
tfw_sched_øtio_ˇlc_dy«mic
);

686 
	}
}

692 
	$tfw_sched_øtio_¥edi˘_tm‚
(
tm‚_d©a
)

694 
	`tfw_sched_øtio_ˇlc_tm‚
((
TfwR©io
 *)
tm‚_d©a
,

695 
tfw_sched_øtio_ˇlc_¥edi˘
);

696 
	}
}

717 
ölöe
 
boﬁ


718 
	$tfw_sched_øtio_is_§v_tu∫
(
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
, 
size_t
 
csidx
)

720 
hódsum2
, 
èûsum2
;

721 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

722 
TfwR©ioSchD©a
 *
schd©a
 = &
πod©a
->schdata;

724 i‡(!
csidx
)

725  
åue
;

727 
hódsum2
 = (
§vd©a
[0].
¸©io
 + srvd©a[
csidx
 - 1].cratio) * csidx;

728 
èûsum2
 = (
§vd©a
[
csidx
].
¸©io


729 + (
§vd©a
[
øtio
->
§v_n
 - 1].
¸©io


730 ? : 
§vd©a
[
øtio
->
§v_n
 - 1].
‹©io
))

731 * (
øtio
->
§v_n
 - 
csidx
);

733  
èûsum2
 * 
schd©a
->
rôî
 > 
hódsum2
;

734 
	}
}

748 
TfwR©ioSrvDesc
 *

749 
	$tfw_sched_øtio_√xt_§v
(
TfwR©io
 *
øtio
, 
TfwR©ioD©a
 *
πod©a
)

751 
size_t
 
csidx
;

752 
TfwR©ioSrvD©a
 *
§vd©a
 = 
πod©a
->srvdata;

753 
TfwR©ioSchD©a
 *
schd©a
 = &
πod©a
->schdata;

756 
	`•ö_lock
(&
schd©a
->
lock
);

757 
ªåy
:

758 
csidx
 = 
schd©a
->csidx;

759 i‡(!
§vd©a
[
csidx
].
¸©io
) {

769 i‡(
schd©a
->
ªidx
 !
csidx
) {

770 ++
schd©a
->
csidx
;

771 i‡(
schd©a
->
csidx
 =
øtio
->
§v_n
) {

772 
schd©a
->
csidx
 = 0;

773 
schd©a
->
rôî
 = 1;

775 
ªåy
;

777 
§vd©a
[
csidx
].
¸©io
 = srvd©a[csidx].
‹©io
;

778 ++
schd©a
->
ªidx
;

790 i‡(
	`likñy
(
	`tfw_sched_øtio_is_§v_tu∫
(
øtio
, 
πod©a
, 
csidx
))) {

791 --
§vd©a
[
csidx
].
¸©io
;

792 i‡(
	`u∆ikñy
(!--
schd©a
->
¸sum
)) {

793 
schd©a
->
csidx
 = 0;

794 
schd©a
->
rôî
 = 1;

795 
schd©a
->
¸sum
 = schd©a->
‹sum
;

796 
schd©a
->
ªidx
 = 0;

797 } i‡(
	`u∆ikñy
(++
schd©a
->
csidx
 =
øtio
->
§v_n
)) {

798 
	`BUG_ON
(
schd©a
->
ªidx
 !
øtio
->
§v_n
);

799 
schd©a
->
csidx
 = 0;

800 
schd©a
->
rôî
 = 1;

802 
	`•ö_u∆ock
(&
schd©a
->
lock
);

803  
øtio
->
§vdesc
 + 
§vd©a
[
csidx
].
sdidx
;

809 
schd©a
->
csidx
 = 0;

810 ++
schd©a
->
rôî
;

811 
ªåy
;

812 
	}
}

824 
ölöe
 
TfwSrvC⁄n
 *

825 
	$__sched_§v
(
TfwR©ioSrvDesc
 *
§vdesc
, 
skùnù
, *
nùc⁄n
)

827 
size_t
 
ci
;

829 
ci
 = 0; cò< 
§vdesc
->
c⁄n_n
; ++ci) {

830 
idxvÆ
 = 
	`©omic64_öc_ªtu∫
(&
§vdesc
->
cou¡î
);

831 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
§vdesc
->
c⁄n
[
idxvÆ
 % srvdesc->
c⁄n_n
];

833 i‡(
	`u∆ikñy
(
	`tfw_§v_c⁄n_ª°ri˘ed
(
§v_c⁄n
)

834 || 
	`tfw_§v_c⁄n_queue_fuŒ
(
§v_c⁄n
)))

836 i‡(
skùnù
 && 
	`tfw_§v_c⁄n_ha¢ù
(
§v_c⁄n
)) {

837 i‡(
	`likñy
(
	`tfw_§v_c⁄n_live
(
§v_c⁄n
)))

838 ++(*
nùc⁄n
);

841 i‡(
	`likñy
(
	`tfw_§v_c⁄n_gë_if_live
(
§v_c⁄n
)))

842  
§v_c⁄n
;

845  
NULL
;

846 
	}
}

852 
TfwSrvC⁄n
 *

853 
	$tfw_sched_øtio_sched_§v_c⁄n
(
TfwMsg
 *
msg
, 
TfwSîvî
 *
§v
)

855 
skùnù
 = 1, 
nùc⁄n
 = 0;

856 
TfwR©ioSrvDesc
 *
§vdesc
;

857 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
NULL
;

863 i‡(!(((
TfwHâpReq
 *)
msg
)->
Êags
 & 
TFW_HTTP_F_HMONITOR
)

864 && 
	`tfw_§v_su•íded
(
§v
))

865  
NULL
;

867 
	`rcu_ªad_lock_bh
();

868 
§vdesc
 = 
	`rcu_dîe„ªn˚_bh
(
§v
->
sched_d©a
);

869 i‡(
	`u∆ikñy
(!
§vdesc
))

870 
d⁄e
;

872 
ªrun
:

873 i‡((
§v_c⁄n
 = 
	`__sched_§v
(
§vdesc
, 
skùnù
, &
nùc⁄n
)))

874 
d⁄e
;

875 i‡(
skùnù
 && 
nùc⁄n
) {

876 
skùnù
 = 0;

877 
ªrun
;

879 
d⁄e
:

880 
	`rcu_ªad_u∆ock_bh
();

881  
§v_c⁄n
;

882 
	}
}

903 
TfwSrvC⁄n
 *

904 
	$tfw_sched_øtio_sched_sg_c⁄n
(
TfwMsg
 *
msg
, 
TfwSrvGroup
 *
sg
)

906 
©ãm±s
, 
skùnù
 = 1, 
nùc⁄n
 = 0;

907 
TfwR©io
 *
øtio
;

908 
TfwR©ioSrvDesc
 *
§vdesc
;

909 
TfwSrvC⁄n
 *
§v_c⁄n
;

910 
TfwR©ioD©a
 *
πod©a
;

912 
	`rcu_ªad_lock_bh
();

913 
øtio
 = 
	`rcu_dîe„ªn˚_bh
(
sg
->
sched_d©a
);

914 i‡(
	`u∆ikñy
(!
øtio
)) {

915 
	`rcu_ªad_u∆ock_bh
();

916  
NULL
;

919 
πod©a
 = 
	`rcu_dîe„ªn˚_bh
(
øtio
->rtodata);

920 
	`BUG_ON
(!
πod©a
);

921 
ªrun
:

950 
©ãm±s
 = 
øtio
->
§v_n
;

951 
©ãm±s
--) {

952 
§vdesc
 = 
	`tfw_sched_øtio_√xt_§v
(
øtio
, 
πod©a
);

953 i‡(
	`tfw_§v_su•íded
(
§vdesc
->
§v
))

956 i‡((
§v_c⁄n
 = 
	`__sched_§v
(
§vdesc
, 
skùnù
, &
nùc⁄n
))) {

957 
	`rcu_ªad_u∆ock_bh
();

958  
§v_c⁄n
;

962 i‡(
skùnù
 && 
nùc⁄n
) {

963 
skùnù
 = 0;

964 
ªrun
;

967 
	`rcu_ªad_u∆ock_bh
();

968  
NULL
;

969 
	}
}

975 
	$tfw_sched_øtio_˛ónup
(
TfwR©io
 *
øtio
)

977 
size_t
 
si
;

980 
si
 = 0; sò< 
øtio
->
§v_n
; ++si)

981 
	`k‰ì
(
øtio
->
§vdesc
[
si
].
c⁄n
);

983 
	`k‰ì
(
øtio
->
h°d©a
);

984 
	`k‰ì
(
øtio
->
πod©a
);

986 
	`k‰ì
(
øtio
);

987 
	}
}

990 
	$tfw_sched_øtio_˛ónup_rcu_cb
(
rcu_hód
 *
rcu
)

992 
TfwR©io
 *
øtio
 = 
	`c⁄èöî_of
(
rcu
, TfwRatio,Ñcu);

993 
	`tfw_sched_øtio_˛ónup
(
øtio
);

994 
	}
}

1000 
	$tfw_sched_øtio_dñ_gΩ
(
TfwSrvGroup
 *
sg
)

1002 
TfwR©io
 *
øtio
 = 
	`rcu_dîe„ªn˚_bh_check
(
sg
->
sched_d©a
, 1);

1003 
TfwSîvî
 *
§v
;

1005 
	`RCU_INIT_POINTER
(
sg
->
sched_d©a
, 
NULL
);

1006 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

1007 
	`WARN_ON_ONCE
(
	`rcu_dîe„ªn˚_bh_check
(
§v
->
sched_d©a
, 1)

1008 && !
øtio
);

1009 
	`RCU_INIT_POINTER
(
§v
->
sched_d©a
, 
NULL
);

1011 i‡(!
øtio
)

1017 i‡(
sg
->
Êags
 & (
TFW_SG_F_SCHED_RATIO_DYNAMIC


1018 | 
TFW_SG_F_SCHED_RATIO_PREDICT
))

1020 
	`©omic_£t
(&
øtio
->
ª¨m
, 0);

1021 
	`smp_mb__a·î_©omic
();

1022 
	`dñ_timî_sync
(&
øtio
->
timî
);

1026 
	`ˇŒ_rcu_bh
(&
øtio
->
rcu
, 
tfw_sched_øtio_˛ónup_rcu_cb
);

1027 
	}
}

1030 
	$tfw_sched_øtio_§vdesc_£tup_§v
(
TfwSîvî
 *
§v
, 
TfwR©ioSrvDesc
 *
§vdesc
)

1032 
size_t
 
size
, 
ci
 = 0;

1033 
TfwSrvC⁄n
 **
c⁄n
, *
§v_c⁄n
;

1035 
size
 = (
TfwSrvC⁄n
 *Ë* 
§v
->
c⁄n_n
;

1036 i‡(!(
§vdesc
->
c⁄n
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
)))

1037  -
ENOMEM
;

1039 
c⁄n
 = 
§vdesc
->conn;

1040 
	`li°_f‹_óch_íåy
(
§v_c⁄n
, &
§v
->
c⁄n_li°
, 
li°
) {

1041 i‡(
	`u∆ikñy
(
ci
++ =
§v
->
c⁄n_n
))

1042 
îr
;

1043 *
c⁄n
++ = 
§v_c⁄n
;

1045 i‡(
	`u∆ikñy
(
ci
 !
§v
->
c⁄n_n
))

1046 
îr
;

1048 
§vdesc
->
c⁄n_n
 = 
§v
->conn_n;

1049 
§vdesc
->
§v
 = srv;

1050 
	`©omic64_£t
(&
§vdesc
->
cou¡î
, 0);

1053 
îr
:

1054 
	`k‰ì
(
§vdesc
->
c⁄n
);

1055  -
EINVAL
;

1056 
	}
}

1070 
	$tfw_sched_øtio_§vdesc_£tup
(
TfwSrvGroup
 *
sg
, 
TfwR©io
 *
øtio
)

1072 
r
;

1073 
size_t
 
si
 = 0;

1074 
TfwSîvî
 *
§v
;

1075 
TfwR©ioSrvDesc
 *
§vdesc
 = 
øtio
->srvdesc;

1077 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

1078 i‡(
	`u∆ikñy
((
si
++ =
sg
->
§v_n
Ë|| !
§v
->
c⁄n_n


1079 || 
	`li°_em±y
(&
§v
->
c⁄n_li°
)))

1080  -
EINVAL
;

1081 i‡((
r
 = 
	`tfw_sched_øtio_§vdesc_£tup_§v
(
§v
, 
§vdesc
)))

1082  
r
;

1083 ++
§vdesc
;

1085 i‡(
	`u∆ikñy
(
si
 !
sg
->
§v_n
))

1086  -
EINVAL
;

1089 
	}
}

1091 
TfwR©io
 *

1092 
	$tfw_sched_øtio_add_gΩ_comm⁄
(
TfwSrvGroup
 *
sg
)

1094 
ªt
;

1095 
size_t
 
size
;

1096 
TfwR©io
 *
øtio
;

1097 
TfwR©ioD©a
 *
πod©a
;

1099 
	`TFW_DBG2
("%s: SG=[%s]\n", 
__func__
, 
sg
->
«me
);

1101 
size
 = (
TfwR©io
Ë+ (
TfwR©ioSrvDesc
Ë* 
sg
->
§v_n
;

1102 i‡(!(
øtio
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
)))

1103  
NULL
;

1105 
øtio
->
§v_n
 = 
sg
->srv_n;

1106 
øtio
->
psidx
 = 
sg
->
Êags
 & 
TFW_SG_M_PSTATS_IDX
;

1108 
øtio
->
§vdesc
 = (
TfwR©ioSrvDesc
 *)(ratio + 1);

1109 i‡((
ªt
 = 
	`tfw_sched_øtio_§vdesc_£tup
(
sg
, 
øtio
)))

1110 
˛ónup
;

1112 i‡(!(
πod©a
 = 
	`tfw_sched_øtio_πod©a_gë
(
øtio
)))

1113 
˛ónup
;

1114 
	`rcu_assign_poöãr
(
øtio
->
πod©a
,Ñtodata);

1116  
øtio
;

1118 
˛ónup
:

1119 
	`tfw_sched_øtio_˛ónup
(
øtio
);

1120  
NULL
;

1121 
	}
}

1123 
TfwR©io
 *

1124 
	$tfw_sched_øtio_add_gΩ_°©ic
(
TfwSrvGroup
 *
sg
)

1126 
TfwR©io
 *
øtio
;

1128 i‡(!(
øtio
 = 
	`tfw_sched_øtio_add_gΩ_comm⁄
(
sg
)))

1129  
øtio
;

1132 
	`tfw_sched_øtio_ˇlc_°©ic
(
øtio
,Ñ©io->
πod©a
);

1134  
øtio
;

1135 
	}
}

1137 
TfwR©io
 *

1138 
	$tfw_sched_øtio_add_gΩ_dy«mic
(
TfwSrvGroup
 *
sg
, *
¨g
)

1140 
TfwR©io
 *
øtio
;

1141 
TfwSchªfPªdi˘
 *
schªf
 = 
¨g
;

1143 
	`TFW_DBG2
("%s: SG=[%s]\n", 
__func__
, 
sg
->
«me
);

1145 i‡(!(
øtio
 = 
	`tfw_sched_øtio_add_gΩ_comm⁄
(
sg
)))

1146  
øtio
;

1149 i‡(
sg
->
Êags
 & 
TFW_SG_F_SCHED_RATIO_PREDICT
) {

1150 
size_t
 
size
, 
¶Ÿ_n
;

1151 
TfwR©ioH°Unô
 *
hunô
;

1152 
TfwR©ioH°D©a
 *
hd©a
;

1153 
TfwR©ioH°Desc
 *
hdesc
, *
hdesc_íd
;

1155 
	`BUG_ON
(!
schªf
);

1157 
¶Ÿ_n
 = 
schªf
->
∑°
 * schªf->
øã
;

1158 
size
 = (
TfwR©ioH°D©a
)

1159 + (
TfwR©ioH°Desc
Ë* 
sg
->
§v_n


1160 + (
TfwR©ioH°Unô
Ë* 
sg
->
§v_n
 * 
¶Ÿ_n
;

1161 i‡(!(
øtio
->
h°d©a
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
)))

1162 
˛ónup
;

1164 
hd©a
 = 
øtio
->
h°d©a
;

1165 
hd©a
->
h°desc
 = (
TfwR©ioH°Desc
 *)(hdata + 1);

1166 
hd©a
->
¶Ÿ_n
 = slot_n;

1167 
hd©a
->
ahód
 = 
schªf
->ahód * schªf->
øã
;

1169 
hdesc_íd
 = 
hd©a
->
h°desc
 + 
sg
->
§v_n
;

1170 
hunô
 = (
TfwR©ioH°Unô
 *)
hdesc_íd
;

1171 
hdesc
 = 
hd©a
->
h°desc
; hdes¯< 
hdesc_íd
; ++hdesc) {

1172 
hdesc
->
hi°
 = 
hunô
;

1173 
hunô
 +
¶Ÿ_n
;

1182 
	`tfw_sched_øtio_ˇlc_°©ic
(
øtio
,Ñ©io->
πod©a
);

1185 i‡(
sg
->
Êags
 & 
TFW_SG_F_SCHED_RATIO_DYNAMIC
) {

1186 
øtio
->
ötvl
 = 
TFW_SCHED_RATIO_INTVL
;

1187 
	`©omic_£t
(&
øtio
->
ª¨m
, 1);

1188 
	`smp_mb__a·î_©omic
();

1189 
	`£tup_timî
(&
øtio
->
timî
,

1190 
tfw_sched_øtio_dy«mic_tm‚
, ()
øtio
);

1191 
	`mod_timî
(&
øtio
->
timî
, 
jiffõs
 +Ñ©io->
ötvl
);

1192 } i‡(
sg
->
Êags
 & 
TFW_SG_F_SCHED_RATIO_PREDICT
) {

1193 
øtio
->
ötvl
 = 
	`m£cs_to_jiffõs
(1000 / 
schªf
->
øã
);

1194 
	`©omic_£t
(&
øtio
->
ª¨m
, 1);

1195 
	`smp_mb__a·î_©omic
();

1196 
	`£tup_timî
(&
øtio
->
timî
,

1197 
tfw_sched_øtio_¥edi˘_tm‚
, ()
øtio
);

1198 
	`mod_timî
(&
øtio
->
timî
, 
jiffõs
 +Ñ©io->
ötvl
);

1201  
øtio
;

1203 
˛ónup
:

1204 
	`tfw_sched_øtio_˛ónup
(
øtio
);

1205  
NULL
;

1206 
	}
}

1209 
	$tfw_sched_øtio_£t_sched_d©a
(
TfwSrvGroup
 *
sg
, 
TfwR©io
 *
øtio
)

1211 
size_t
 
i
;

1213 i‡(!
øtio
)

1216 
i
 = 0; i < 
øtio
->
§v_n
; ++i) {

1217 
TfwR©ioSrvDesc
 *
§vdesc
 = &
øtio
->§vdesc[
i
];

1219 
	`rcu_assign_poöãr
(
§vdesc
->
§v
->
sched_d©a
, srvdesc);

1221 
	`rcu_assign_poöãr
(
sg
->
sched_d©a
, 
øtio
);

1222 
	}
}

1225 
	$tfw_sched_øtio_add_gΩ
(
TfwSrvGroup
 *
sg
, *
¨g
)

1227 
TfwR©io
 *
øtio
 = 
NULL
;

1229 i‡(
	`u∆ikñy
(!
sg
->
§v_n
 || 
	`li°_em±y
(&sg->
§v_li°
)))

1230  -
EINVAL
;

1232 
sg
->
Êags
 & 
TFW_SG_M_SCHED_RATIO_TYPE
) {

1233 
TFW_SG_F_SCHED_RATIO_STATIC
:

1234 
øtio
 = 
	`tfw_sched_øtio_add_gΩ_°©ic
(
sg
);

1236 
TFW_SG_F_SCHED_RATIO_DYNAMIC
:

1237 
TFW_SG_F_SCHED_RATIO_PREDICT
:

1238 
øtio
 = 
	`tfw_sched_øtio_add_gΩ_dy«mic
(
sg
, 
¨g
);

1241  -
EINVAL
;

1243 
	`tfw_sched_øtio_£t_sched_d©a
(
sg
, 
øtio
);

1245  
øtio
 ? 0 : -
EINVAL
;

1246 
	}
}

1249 
	$tfw_sched_øtio_add_§v
(
TfwSîvî
 *
§v
)

1251 
TfwR©ioSrvDesc
 *
§vdesc
 = 
	`rcu_dîe„ªn˚_bh_check
(
§v
->
sched_d©a
, 1);

1252 
r
;

1254 i‡(
	`u∆ikñy
(
§vdesc
))

1255  -
EEXIST
;

1257 i‡(!(
§vdesc
 = 
	`kzÆloc
((
TfwR©ioSrvDesc
), 
GFP_KERNEL
)))

1258  -
ENOMEM
;

1259 i‡((
r
 = 
	`tfw_sched_øtio_§vdesc_£tup_§v
(
§v
, 
§vdesc
))) {

1260 
	`k‰ì
(
§vdesc
);

1261  
r
;

1264 
	`rcu_assign_poöãr
(
§v
->
sched_d©a
, 
§vdesc
);

1267 
	}
}

1270 
	$tfw_sched_øtio_put_§v_d©a
(
rcu_hód
 *
rcu
)

1272 
TfwR©ioSrvDesc
 *
§vdesc
 = 
	`c⁄èöî_of
(
rcu
, TfwRatioSrvDesc,Ñcu);

1273 
	`k‰ì
(
§vdesc
->
c⁄n
);

1274 
	`k‰ì
(
§vdesc
);

1275 
	}
}

1278 
	$tfw_sched_øtio_dñ_§v
(
TfwSîvî
 *
§v
)

1280 
TfwR©ioSrvDesc
 *
§vdesc
 = 
	`rcu_dîe„ªn˚_bh_check
(
§v
->
sched_d©a
, 1);

1282 
	`RCU_INIT_POINTER
(
§v
->
sched_d©a
, 
NULL
);

1283 i‡(
§vdesc
)

1284 
	`ˇŒ_rcu_bh
(&
§vdesc
->
rcu
, 
tfw_sched_øtio_put_§v_d©a
);

1285 
	}
}

1287 
TfwScheduÀr
 
	gtfw_sched_øtio
 = {

1288 .
«me
 = "ratio",

1289 .
	gli°
 = 
LIST_HEAD_INIT
(
tfw_sched_øtio
.
li°
),

1290 .
	gadd_gΩ
 = 
tfw_sched_øtio_add_gΩ
,

1291 .
	gdñ_gΩ
 = 
tfw_sched_øtio_dñ_gΩ
,

1292 .
	gadd_§v
 = 
tfw_sched_øtio_add_§v
,

1293 .
	gdñ_§v
 = 
tfw_sched_øtio_dñ_§v
,

1294 .
	gsched_sg_c⁄n
 = 
tfw_sched_øtio_sched_sg_c⁄n
,

1295 .
	gsched_§v_c⁄n
 = 
tfw_sched_øtio_sched_§v_c⁄n
,

1299 
	$tfw_sched_øtio_öô
()

1301 
	`TFW_DBG
("%s: inô\n", 
tfw_sched_øtio
.
«me
);

1302  
	`tfw_sched_ªgi°î
(&
tfw_sched_øtio
);

1303 
	}
}

1306 
	$tfw_sched_øtio_exô
()

1308 
	`TFW_DBG
("%s:Éxô\n", 
tfw_sched_øtio
.
«me
);

1309 
	`tfw_sched_uƒegi°î
(&
tfw_sched_øtio
);

1310 
	}
}

	@http_sess.c

36 
	~<¸y±o/hash.h
>

37 
	~<löux/˘y≥.h
>

38 
	~<löux/hashèbÀ.h
>

39 
	~<löux/¶ab.h
>

40 
	~<löux/time.h
>

41 
	~<löux/vmÆloc.h
>

43 
	~"lib/hash.h
"

44 
	~"lib/°r.h
"

45 
	~"addr.h
"

46 
	~"cfg.h
"

47 
	~"˛õ¡.h
"

48 
	~"hâp_msg.h
"

49 
	~"hâp_£ss.h
"

51 
	#STICKY_NAME_MAXLEN
 (32)

	)

52 
	#STICKY_NAME_DEFAULT
 "__tfw"

	)

53 
	#STICKY_KEY_MAXLEN
 
	`FIELD_SIZEOF
(
TfwHâpSess
, 
hmac
)

	)

55 
	#SESS_HASH_BITS
 17

	)

56 
	#SESS_HASH_SZ
 (1 << 
SESS_HASH_BITS
)

	)

64 
TfwSå
 
	m«me
;

65 
TfwSå
 
	m«me_eq
;

66 
	m£ss_li„time
;

67 
u_öt
 
	míabÀd
 : 1,

68 
	míf‹˚
 : 1;

69 } 
	tTfwCfgSticky
;

75 
	mts
;

76 
	mhmac
[
STICKY_KEY_MAXLEN
];

77 } 
	t__©åibuã__
((
	t∑cked
)Ë
	tStickyVÆ
;

80 
hli°_hód
 
	mli°
;

81 
•ölock_t
 
	mlock
;

82 } 
	tSessHashBuckë
;

84 
TfwCfgSticky
 
	gtfw_cfg_°icky
;

86 
¸y±o_shash
 *
	gtfw_°icky_shash
;

87 
	gtfw_°icky_key
[
STICKY_KEY_MAXLEN
];

88 
boﬁ
 
	gtfw_cfg_°icky_£ss
 = 
Ál£
;

90 
SessHashBuckë
 
	g£ss_hash
[
SESS_HASH_SZ
] = {

91 [0 ... (
SESS_HASH_SZ
 - 1)] = {

92 
HLIST_HEAD_INIT
,

96 
kmem_ˇche
 *
	g£ss_ˇche
;

109 
TfwSå
 
	mbody
;

110 
time_t
 
	mdñay_mö
;

111 
time_t
 
	mdñay_ønge
;

112 
time_t
 
	mdñay_limô
;

113 
	m°_code
;

114 } 
	tTfwCfgJsCh
;

116 
TfwCfgJsCh
 *
	gtfw_cfg_js_ch
 = 
NULL
;

117 c⁄° 
	gtfw_cfg_jsch_code_dÊt
 = 503;

118 
	#TFW_CFG_JS_PATH
 "/ëc/ãm≥°a/js_chÆÀnge.html"

	)

120 
	gtfw_cfg_ªdúe˘_°_code
;

121 c⁄° 
	gtfw_cfg_ªdúe˘_°_code_dÊt
 = 302;

129 
boﬁ


130 
	$tfw_hâp_°icky_ªdúe˘_Ælõd
(
TfwHâpReq
 *
ªq
)

132 i‡(!
tfw_cfg_js_ch
)

133  
åue
;

135  (
ªq
->
mëhod
 =
TFW_HTTP_METH_GET
)

136 && (
ªq
->
Êags
 & 
TFW_HTTP_F_ACCEPT_HTML
);

137 
	}
}

140 
	$tfw_hâp_°icky_£nd_ªdúe˘
(
TfwHâpReq
 *
ªq
, 
StickyVÆ
 *
sv
)

142 
ts_be64
 = 
	`˝u_to_be64
(
sv
->
ts
);

143 
TfwSå
 
chunks
[3], 
cookõ
 = { 0 };

144 
	`DEFINE_TFW_STR
(
s_eq
, "=");

145 
TfwHâpRe•
 *
ª•
;

146 
buf
[(*
sv
) * 2];

147 
TfwSå
 *
body
 = 
tfw_cfg_js_ch
 ? &tfw_cfg_js_ch->body : 
NULL
;

148 
r
;

150 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
fwd_li°
));

151 
	`WARN_ON_ONCE
(!
	`li°_em±y
(&
ªq
->
nù_li°
));

158 i‡(!
	`tfw_hâp_°icky_ªdúe˘_Ælõd
(
ªq
))

159  
TFW_HTTP_SESS_JS_NOT_SUPPORTED
;

161 i‡(!(
ª•
 = 
	`tfw_hâp_msg_Æloc_ª•_light
(
ªq
)))

162  -
ENOMEM
;

173 
	`bö2hex
(
buf
, &
ts_be64
, (ts_be64));

174 
	`bö2hex
(&
buf
[(
ts_be64
Ë* 2], 
sv
->
hmac
, (sv->hmac));

176 
	`bzîo_Á°
(
chunks
, (chunks));

177 
chunks
[0] = 
tfw_cfg_°icky
.
«me
;

178 
chunks
[1] = 
s_eq
;

179 
chunks
[2].
±r
 = 
buf
;

180 
chunks
[2].
Àn
 = (*
sv
) * 2;

182 
cookõ
.
±r
 = 
chunks
;

183 
cookõ
.
Àn
 = 
chunks
[0].len + chunks[1].len + chunks[2].len;

184 
	`__TFW_STR_CHUNKN_SET
(&
cookõ
, 3);

186 
r
 = 
	`tfw_hâp_¥ï_ªdúe˘
((
TfwHâpMsg
 *)
ª•
, 
tfw_cfg_ªdúe˘_°_code
,

187 &
cookõ
, 
body
);

188 i‡(
r
) {

189 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

190  
TFW_HTTP_SESS_FAILURE
;

193 
	`tfw_hâp_ª•_fwd
(
ª•
);

195  
TFW_HTTP_SESS_REDIRECT_SENT
;

196 
	}
}

199 
	$£¨ch_cookõ
(
TfwPoﬁ
 *
poﬁ
, c⁄° 
TfwSå
 *
cookõ
, TfwSå *
vÆ
)

201 c⁄° *c⁄° 
c°r
 = 
tfw_cfg_°icky
.
«me_eq
.
±r
;

202 c⁄° 
˛í
 = 
tfw_cfg_°icky
.
«me_eq
.
Àn
;

203 
TfwSå
 *
chunk
, *
íd
, *
√xt
;

204 
TfwSå
 
tmp
 = { .
Êags
 = 0, };

205 
n
 = 
	`TFW_STR_CHUNKN
(
cookõ
);

207 
	`BUG_ON
(!
	`TFW_STR_PLAIN
(&
tfw_cfg_°icky
.
«me_eq
));

210 
íd
 = (
TfwSå
*)
cookõ
->
±r
 + 
	`TFW_STR_CHUNKN
(cookie);

211 
chunk
 = 
cookõ
->
±r
; chunk !
íd
; ++chunk, --
n
) {

212 i‡(!(
chunk
->
Êags
 & 
TFW_STR_NAME
))

219 
tmp
.
±r
 = (*)
chunk
;

220 
	`__TFW_STR_CHUNKN_SET
(&
tmp
, 
n
);

221 i‡(
	`tfw_°r_eq_c°r
(&
tmp
, 
c°r
, 
˛í
, 
TFW_STR_EQ_PREFIX
))

224 i‡(
chunk
 =
íd
)

228 ++
chunk
; chunk !
íd
; ++chunk)

229 i‡(
chunk
->
Êags
 & 
TFW_STR_VALUE
)

235 i‡(
	`u∆ikñy
(
chunk
 =
íd
))

239 
√xt
 = 
chunk
 + 1;

240 i‡(
	`likñy
(
√xt
 =
íd
 || *(*Íext->
±r
 == ';')) {

241 
	`TFW_DBG3
("%s:Öœö cookõ vÆue: %.*s\n", 
__func__
,

242 ()
chunk
->
Àn
, (*)chunk->
±r
);

243 *
vÆ
 = *
chunk
;

248 
	`TFW_DBG3
("%s: compound cookõ vÆuêfound\n", 
__func__
);

249 
vÆ
->
±r
 = 
chunk
;

250 
	`TFW_STR_CHUNKN_ADD
(
vÆ
, 1);

251 
vÆ
->
Àn
 = 
chunk
->len;

252 ; 
chunk
 !
íd
; ++chunk) {

253 i‡(*(*)
chunk
->
±r
 == ';')

256 
	`TFW_STR_CHUNKN_ADD
(
vÆ
, 1);

257 
vÆ
->
Àn
 +
chunk
->len;

259 
	`BUG_ON
(
	`TFW_STR_CHUNKN
(
vÆ
) < 2);

262 
	}
}

271 
	$tfw_hâp_°icky_gë
(
TfwHâpReq
 *
ªq
, 
TfwSå
 *
cookõ_vÆ
)

273 
TfwSå
 
vÆue
 = { 0 };

274 
TfwSå
 *
hdr
;

283 
hdr
 = &
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_COOKIE
];

284 i‡(
	`TFW_STR_EMPTY
(
hdr
))

286 
	`tfw_hâp_msg_˛¡hdr_vÆ
(
hdr
, 
TFW_HTTP_HDR_COOKIE
, &
vÆue
);

288  
	`£¨ch_cookõ
(
ªq
->
poﬁ
, &
vÆue
, 
cookõ_vÆ
);

289 
	}
}

291 #ifde‡
DEBUG


292 
	#TFW_DBG_PRINT_STICKY_COOKIE
(
addr
, 
ua
, 
sv
) \

294 
abuf
[
TFW_ADDR_STR_BUF_SIZE
] = {0}; \

295 
hbuf
[
STICKY_KEY_MAXLEN
 * 2] = {0}; \

296 
	`tfw_addr_fmt_v6
(&(
addr
)->
v6
.
sö6_addr
, 0, 
abuf
); \

297 
	`bö2hex
(
hbuf
, 
tfw_°icky_key
, 
STICKY_KEY_MAXLEN
); \

298 
	`TFW_DBG
("http_sess: calculate sticky cookie for %s," \

299 "Ås=%#lx“ow=%#lx)...\n", 
abuf
, (
sv
)->
ts
, 
jiffõs
); \

300 
	`TFW_DBG
("\t...£¸ë: %.*s\n", ()
STICKY_KEY_MAXLEN
 * 2, 
hbuf
);\

301 
	`tfw_°r_d¥öt
(
ua
, "\t...User-Agent"); \

302 } 0)

	)

304 
	#TFW_DBG_PRINT_STICKY_COOKIE
(
addr
, 
ua
, 
sv
)

	)

317 
	$__°icky_ˇlc
(
TfwHâpReq
 *
ªq
, 
StickyVÆ
 *
sv
)

319 
r
, 
addr_Àn
;

320 
TfwSå
 
ua_vÆue
 = { 0 };

321 
TfwAddr
 *
addr
 = &
ªq
->
c⁄n
->
≥î
->addr;

322 
TfwSå
 *
hdr
, *
c
, *
íd
;

323 
desc
[(
shash_desc
)

324 + 
	`¸y±o_shash_descsize
(
tfw_°icky_shash
)]

325 
CRYPTO_MINALIGN_ATTR
;

326 
shash_desc
 *shash_des¯(shash_des¯*)
desc
;

329 
hdr
 = &
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_USER_AGENT
];

330 i‡(!
	`TFW_STR_EMPTY
(
hdr
))

331 
	`tfw_hâp_msg_˛¡hdr_vÆ
(
hdr
, 
TFW_HTTP_HDR_USER_AGENT
,

332 &
ua_vÆue
);

334 
addr_Àn
 = 
	`tfw_addr_ß_Àn
(
addr
);

336 
	`bzîo_Á°
(
desc
, (desc));

337 
shash_desc
->
tfm
 = 
tfw_°icky_shash
;

338 
shash_desc
->
Êags
 = 0;

340 
	`TFW_DBG_PRINT_STICKY_COOKIE
(
addr
, &
ua_vÆue
, 
sv
);

342 i‡((
r
 = 
	`¸y±o_shash_öô
(
shash_desc
)))

343  
r
;

344 i‡((
r
 = 
	`¸y±o_shash_upd©e
(
shash_desc
, (
u8
 *)&
addr
->
ß
, 
addr_Àn
)))

345  
r
;

346 i‡(
ua_vÆue
.
Àn
) {

347 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, &
ua_vÆue
, 
íd
) {

348 
r
 = 
	`¸y±o_shash_upd©e
(
shash_desc
, 
c
->
±r
, c->
Àn
);

349 i‡(
r
)

350  
r
;

353  
	`¸y±o_shash_föup
(
shash_desc
, (
u8
 *)&
sv
->
ts
, (sv->ts),

354 
sv
->
hmac
);

355 
	}
}

358 
	$tfw_hâp_°icky_ˇlc
(
TfwHâpReq
 *
ªq
, 
StickyVÆ
 *
sv
)

360 
sv
->
ts
 = 
jiffõs
;

362  
	`__°icky_ˇlc
(
ªq
, 
sv
);

363 
	}
}

372 
	$tfw_hâp_°icky_add
(
TfwHâpRe•
 *
ª•
)

374 c⁄° 
Àn
 = (
StickyVÆ
) * 2;

375 
r
;

376 
TfwHâpSess
 *
£ss
 = 
ª•
->
ªq
->sess;

377 
ts_be64
 = 
	`˝u_to_be64
(
£ss
->
ts
);

378 
buf
[
Àn
];

379 
TfwSå
 
£t_cookõ
 = {

380 .
±r
 = (
TfwSå
 []) {

381 { .
±r
 = 
S_F_SET_COOKIE
, .
Àn
 = 
	`SLEN
(S_F_SET_COOKIE) },

382 { .
±r
 = 
tfw_cfg_°icky
.
«me_eq
.ptr,

383 .
Àn
 = 
tfw_cfg_°icky
.
«me_eq
.len },

384 { .
±r
 = 
buf
, .
Àn
 =Üen },

386 .
Àn
 = 
	`SLEN
(
S_F_SET_COOKIE
Ë+ 
tfw_cfg_°icky
.
«me_eq
.len +Üen,

387 .
eﬁí
 = 2,

388 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


392 
	`bö2hex
(
buf
, &
ts_be64
, (ts_be64));

393 
	`bö2hex
(&
buf
[(
ts_be64
Ë* 2], 
£ss
->
hmac
, (sess->hmac));

395 
	`TFW_DBG
("%s: \"" 
S_F_SET_COOKIE
 "%.*s=%.*s\"\n", 
__func__
,

396 
	`PR_TFW_STR
(&
tfw_cfg_°icky
.
«me
), 
Àn
, 
buf
);

398 
r
 = 
	`tfw_hâp_msg_hdr_add
((
TfwHâpMsg
 *)
ª•
, &
£t_cookõ
);

399 i‡(
r
)

400 
	`TFW_WARN
("C™nŸádd \"" 
S_F_SET_COOKIE
 "%.*s=%.*s\"\n",

401 
	`PR_TFW_STR
(&
tfw_cfg_°icky
.
«me
), 
Àn
, 
buf
);

402  
r
;

403 
	}
}

414 
	$tfw_hâp_°icky_nŸfound
(
TfwHâpReq
 *
ªq
)

416 
StickyVÆ
 
sv
 = {};

425 i‡(!
tfw_cfg_°icky
.
íf‹˚
)

426  
TFW_HTTP_SESS_SUCCESS
;

429 i‡(
	`tfw_hâp_°icky_ˇlc
(
ªq
, &
sv
) != 0)

430  
TFW_HTTP_SESS_FAILURE
;

432  
	`tfw_hâp_°icky_£nd_ªdúe˘
(
ªq
, &
sv
);

433 
	}
}

435 
	#£ss_w¨n
(
check
, 
addr
, 
fmt
, ...) \

437 
abuf
[
TFW_ADDR_STR_BUF_SIZE
] = {0}; \

438 
	`tfw_addr_fmt_v6
(&(
addr
)->
v6
.
sö6_addr
, 0, 
abuf
); \

439 
	`TFW_WARN
("hâp_£ss: %†f‹ %s" 
fmt
, 
check
, 
abuf
, ##
__VA_ARGS__
); \

440 } 0)

	)

446 
	$tfw_hâp_°icky_vîify
(
TfwHâpReq
 *
ªq
, 
TfwSå
 *
vÆue
, 
StickyVÆ
 *
sv
)

448 
i
 = 0, 
hi
;

449 *
p
, 
b
;

450 
TfwAddr
 *
addr
 = &
ªq
->
c⁄n
->
≥î
->addr;

451 
TfwSå
 *
c
, *
íd
;

453 
	`TFW_DBG
("Sticky cookie found%s: \"%.*s\"\n",

454 
	`TFW_STR_PLAIN
(
vÆue
) ? "" : ", starts with",

455 
	`TFW_STR_PLAIN
(
vÆue
) ?

456 ()
vÆue
->
Àn
 :

457 ()((
TfwSå
*)
vÆue
->
±r
)->
Àn
,

458 
	`TFW_STR_PLAIN
(
vÆue
) ?

459 (*)
vÆue
->
±r
 :

460 (*)((
TfwSå
*)
vÆue
->
±r
)->ptr);

462 i‡(
vÆue
->
Àn
 !(
StickyVÆ
) * 2) {

463 
	`£ss_w¨n
("bad sticky cookõÜígth", 
addr
, ": %lu(%lu)\n",

464 
vÆue
->
Àn
, (
StickyVÆ
) * 2);

465  
TFW_HTTP_SESS_VIOLATE
;

468 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
vÆue
, 
íd
) {

469 
p
 = 
c
->
±r
;Ö < (*)c->±∏+ c->
Àn
; ++p) {

470 i‡(
i
++ =(
sv
->
ts
) * 2)

471 
ts_föished
;

472 
sv
->
ts
 = (sv->t†<< 4Ë+ 
	`hex_to_bö
(*
p
);

475 
ts_föished
:

477 i‡(
	`__°icky_ˇlc
(
ªq
, 
sv
))

478  
TFW_HTTP_SESS_VIOLATE
;

479 
i
 = 0, 
hi
 = 1; (
c
Ë< 
íd
; ++(c)) {

480  ; 
p
 < (*)
c
->
±r
 + c->
Àn
; ++p) {

481 
b
 = 
hi
 ? 
	`hex_asc_hi
(
sv
->
hmac
[
i
])

482 : 
	`hex_asc_lo
(
sv
->
hmac
[
i
]);

483 i‡(
b
 !*
p
) {

484 
n
 = (
sv
->
hmac
) * 2;

485 
buf
[
n
];

486 
	`bö2hex
(
buf
, 
sv
->
hmac
, (sv->hmac));

487 
	`£ss_w¨n
("bad sticky cookie value",

488 
addr
, ": %c(pos=%d),"

490 *
p
, 
i
, 
sv
->
ts
, 
n
, 
buf
);

491  
TFW_HTTP_SESS_VIOLATE
;

493 
hi
 = !hi;

494 
i
 +
hi
;

497 
	`BUG_ON
(
i
 !
STICKY_KEY_MAXLEN
);

500 
ªq
->
Êags
 |
TFW_HTTP_F_HAS_STICKY
;

502  
TFW_HTTP_SESS_SUCCESS
;

503 
	}
}

509 
	$tfw_hâp_°icky_ªq_¥o˚ss
(
TfwHâpReq
 *
ªq
, 
StickyVÆ
 *
sv
)

511 
r
;

512 
TfwSå
 
cookõ_vÆ
 = {};

518 
r
 = 
	`tfw_hâp_°icky_gë
(
ªq
, &
cookõ_vÆ
);

519 i‡(
r
 < 0)

520  
r
;

521 i‡(
r
 == 0)

522  
	`tfw_hâp_°icky_nŸfound
(
ªq
);

523 i‡(
r
 == 1) {

532 i‡(
	`tfw_hâp_°icky_vîify
(
ªq
, &
cookõ_vÆ
, 
sv
))

533  
	`tfw_hâp_°icky_£nd_ªdúe˘
(
ªq
, 
sv
);

534  
TFW_HTTP_SESS_SUCCESS
;

536 
	`TFW_WARN
("Mu…ùÀ Tem≥°®°icky cookõ†found: %d\n", 
r
);

538  
TFW_HTTP_SESS_FAILURE
;

539 
	}
}

545 
	$tfw_hâp_£ss_ª•_¥o˚ss
(
TfwHâpRe•
 *
ª•
)

547 
TfwHâpReq
 *
ªq
 = 
ª•
->req;

549 i‡(!
tfw_cfg_°icky
.
íabÀd
 || 
ªq
->
Êags
 & 
TFW_HTTP_F_WHITELIST
)

551 
	`BUG_ON
(!
ªq
->
£ss
);

559 i‡(
ªq
->
Êags
 & 
TFW_HTTP_F_HAS_STICKY
)

561  
	`tfw_hâp_°icky_add
(
ª•
);

562 
	}
}

569 
	$tfw_hâp_£ss_u≈ö_§v
(
TfwStickyC⁄n
 *
°_c⁄n
)

571 
TfwSîvî
 *
§v
;

573 i‡(!
°_c⁄n
->
§v_c⁄n
)

576 
§v
 = (
TfwSîvî
 *)
°_c⁄n
->
§v_c⁄n
->
≥î
;

577 
°_c⁄n
->
§v_c⁄n
 = 
NULL
;

578 
	`tfw_£rvî_u≈ö_£ss
(
§v
);

579 
	}
}

582 
	$tfw_hâp_£ss_put
(
TfwHâpSess
 *
£ss
)

584 i‡(
	`©omic_dec_™d_ã°
(&
£ss
->
u£rs
)) {

589 
	`tfw_hâp_£ss_u≈ö_§v
(&
£ss
->
°_c⁄n
);

590 
	`kmem_ˇche_‰ì
(
£ss_ˇche
, 
£ss
);

592 
	}
}

599 
	$tfw_hâp_£ss_ªmove
(
TfwHâpSess
 *
£ss
)

601 
	`hash_dñ
(&
£ss
->
híåy
);

602 
	`tfw_hâp_£ss_put
(
£ss
);

603 
	}
}

609 
	$tfw_hâp_£ss_check_jsch
(
StickyVÆ
 *
sv
)

611 
time_t
 
cur_time
, 
mö_time
, 
max_time
;

613 i‡(!
tfw_cfg_js_ch
)

616 
cur_time
 = 
jiffõs
;

617 
mö_time
 = 
sv
->
ts
 + 
tfw_cfg_js_ch
->
dñay_mö


618 + 
sv
->
ts
 % 
tfw_cfg_js_ch
->
dñay_ønge
;

619 
max_time
 = 
sv
->
ts
 + 
tfw_cfg_js_ch
->
dñay_limô
;

620 i‡((
mö_time
 <
cur_time
Ë&& (cur_timê<
max_time
))

623 
	`TFW_DBG
("sess: jsch block:ÑequestÑecieved outsideállowedÖeriod.\n");

625  
TFW_HTTP_SESS_VIOLATE
;

626 
	}
}

633 
	$tfw_hâp_£ss_obèö
(
TfwHâpReq
 *
ªq
)

635 
r
;

636 
key
;

637 
TfwHâpSess
 *
£ss
;

638 
SessHashBuckë
 *
hb
;

639 
hli°_node
 *
tmp
;

640 
StickyVÆ
 
sv
 = { };

642 i‡(!
tfw_cfg_°icky
.
íabÀd
 || 
ªq
->
Êags
 & 
TFW_HTTP_F_WHITELIST
)

643  
TFW_HTTP_SESS_SUCCESS
;

645 i‡((
r
 = 
	`tfw_hâp_°icky_ªq_¥o˚ss
(
ªq
, &
sv
)))

646  
r
;

659 i‡(!
sv
.
ts
) {

661 i‡(
	`tfw_hâp_°icky_ˇlc
(
ªq
, &
sv
))

662  
TFW_HTTP_SESS_FAILURE
;

665 
key
 = 
	`hash_ˇlc
(
sv
.
hmac
, (sv.hmac));

666 
hb
 = &
£ss_hash
[
	`hash_mö
(
key
, 
SESS_HASH_BITS
)];

668 
	`•ö_lock
(&
hb
->
lock
);

670 
	`hli°_f‹_óch_íåy_ß„
(
£ss
, 
tmp
, &
hb
->
li°
, 
híåy
) {

672 i‡(
£ss
->
expúes
 < 
jiffõs
) {

673 
	`tfw_hâp_£ss_ªmove
(
£ss
);

677 i‡(!
	`memcmp_Á°
(
sv
.
hmac
, 
£ss
->hmac, (sess->hmac)))

678 
found
;

681 i‡((
r
 = 
	`tfw_hâp_£ss_check_jsch
(&
sv
))) {

682 
	`•ö_u∆ock
(&
hb
->
lock
);

683  
r
;

686 i‡(!(
£ss
 = 
	`kmem_ˇche_Æloc
(
£ss_ˇche
, 
GFP_ATOMIC
))) {

687 
	`•ö_u∆ock
(&
hb
->
lock
);

688  -
ENOMEM
;

691 
	`mem˝y_Á°
(
£ss
->
hmac
, 
sv
.hmac, (sv.hmac));

692 
	`hli°_add_hód
(&
£ss
->
híåy
, &
hb
->
li°
);

697 
	`©omic_£t
(&
£ss
->
u£rs
, 1);

698 
£ss
->
ts
 = 
sv
.ts;

699 
£ss
->
expúes
 = 
tfw_cfg_°icky
.
£ss_li„time


700 ? 
sv
.
ts
 + 
tfw_cfg_°icky
.
£ss_li„time
 * 
HZ


702 
£ss
->
°_c⁄n
.
§v_c⁄n
 = 
NULL
;

703 
	`rwlock_öô
(&
£ss
->
°_c⁄n
.
lock
);

705 
	`TFW_DBG
("√w sessi⁄ %p\n", 
£ss
);

707 
found
:

708 
	`©omic_öc
(&
£ss
->
u£rs
);

710 
	`•ö_u∆ock
(&
hb
->
lock
);

712 
ªq
->
£ss
 = sess;

714  
TFW_HTTP_SESS_SUCCESS
;

715 
	}
}

718 
	$tfw_hâp_£ss_£t_expúed
(
TfwHâpSess
 *
£ss
)

720 
£ss
->
expúes
 = 0;

721 
	}
}

724 
	$tfw_hâp_£ss_u£_°icky_£ss
(
boﬁ
 
u£
)

726 
	`WRITE_ONCE
(
tfw_cfg_°icky_£ss
, 
u£
);

727 
	}
}

729 
boﬁ


730 
	$tfw_hâp_£ss_has_°icky_£ss
()

732  
	`READ_ONCE
(
tfw_cfg_°icky_£ss
);

733 
	}
}

738 
ölöe
 
TfwSrvC⁄n
 *

739 
	$__åy_c⁄n
(
TfwMsg
 *
msg
, 
TfwSrvC⁄n
 *
§v_c⁄n
)

741 
TfwSîvî
 *
§v
;

743 i‡(
	`u∆ikñy
(!
§v_c⁄n
))

744  
NULL
;

746 
§v
 = (
TfwSîvî
 *)
§v_c⁄n
->
≥î
;

747 i‡(
	`tfw_§v_su•íded
(
§v
))

748  
NULL
;

750 i‡(!
	`tfw_§v_c⁄n_ª°ri˘ed
(
§v_c⁄n
)

751 && !
	`tfw_§v_c⁄n_queue_fuŒ
(
§v_c⁄n
)

752 && !
	`tfw_§v_c⁄n_ha¢ù
(
§v_c⁄n
)

753 && 
	`tfw_§v_c⁄n_gë_if_live
(
§v_c⁄n
))

755  
§v_c⁄n
;

762  
§v
->
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, srv);

763 
	}
}

769 
	$tfw_hâp_£ss_pö_§v
(
TfwStickyC⁄n
 *
°_c⁄n
, 
TfwSrvC⁄n
 *
§v_c⁄n
)

771 
TfwSîvî
 *
§v
;

773 
	`tfw_hâp_£ss_u≈ö_§v
(
°_c⁄n
);

775 i‡(!
§v_c⁄n
)

778 
§v
 = (
TfwSîvî
 *)
§v_c⁄n
->
≥î
;

779 i‡(
§v
->
sg
->
Êags
 & 
TFW_SRV_STICKY
) {

780 
	`tfw_£rvî_pö_£ss
(
§v
);

781 
°_c⁄n
->
§v_c⁄n
 = srv_conn;

783 
	}
}

792 
TfwSrvC⁄n
 *

793 
	$tfw_hâp_£ss_gë_§v_c⁄n
(
TfwMsg
 *
msg
)

795 
TfwHâpSess
 *
£ss
 = ((
TfwHâpReq
 *)
msg
)->sess;

796 
TfwStickyC⁄n
 *
°_c⁄n
;

797 
TfwSrvC⁄n
 *
§v_c⁄n
;

799 
	`BUG_ON
(!
£ss
);

800 
°_c⁄n
 = &
£ss
->st_conn;

802 
	`ªad_lock
(&
°_c⁄n
->
lock
);

805 i‡(!
°_c⁄n
->
§v_c⁄n
 && !
	`tfw_hâp_£ss_has_°icky_£ss
()) {

806 
	`ªad_u∆ock
(&
°_c⁄n
->
lock
);

807  
	`tfw_vho°_gë_§v_c⁄n
(
msg
);

810 i‡((
§v_c⁄n
 = 
	`__åy_c⁄n
(
msg
, 
°_c⁄n
->srv_conn))) {

811 
	`ªad_u∆ock
(&
°_c⁄n
->
lock
);

812  
§v_c⁄n
;

815 
	`ªad_u∆ock
(&
°_c⁄n
->
lock
);

816 
	`wrôe_lock
(&
°_c⁄n
->
lock
);

821 i‡((
§v_c⁄n
 = 
	`__åy_c⁄n
(
msg
, 
°_c⁄n
->srv_conn))) {

822 
	`wrôe_u∆ock
(&
°_c⁄n
->
lock
);

823  
§v_c⁄n
;

826 i‡(
°_c⁄n
->
§v_c⁄n
) {

828 
TfwSîvî
 *
§v
 = (TfwSîvî *)
°_c⁄n
->
§v_c⁄n
->
≥î
;

829 
addr_°r
[
TFW_ADDR_STR_BUF_SIZE
] = { 0 };

831 
	`tfw_addr_¡›
(&
§v
->
addr
, 
addr_°r
, (addr_str));

833 i‡(!(
§v
->
sg
->
Êags
 & 
TFW_SRV_STICKY_FAILOVER
))

841 i‡(
	`u∆ikñy
(
	`ã°_bô
(
TFW_CFG_B_DEL
, &
§v
->
Êags
))) {

842 
	`TFW_LOG
("sticky sched: server %s"

844 
addr_°r
);

845 
	`tfw_hâp_£ss_£t_expúed
(
£ss
);

846 
îr
;

848 
	`TFW_ERR
("sticky sched:Öinned server %s in group '%s'"

850 
addr_°r
, 
§v
->
sg
->
«me
);

851 
îr
;

853 
	`TFW_WARN
("sticky sched:Öinned server %s in group '%s'"

855 
addr_°r
, 
§v
->
sg
->
«me
);

858 
§v_c⁄n
 = 
	`tfw_vho°_gë_§v_c⁄n
(
msg
);

859 
	`tfw_hâp_£ss_pö_§v
(
°_c⁄n
, 
§v_c⁄n
);

860 
îr
:

861 
	`wrôe_u∆ock
(&
°_c⁄n
->
lock
);

863  
§v_c⁄n
;

864 
	}
}

867 
	$tfw_cfg›_°icky
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

869 
size_t
 
i
, 
Àn
;

870 c⁄° *
vÆ
;

872 
vÆ
 = 
	`tfw_cfg_gë_©å
(
˚
, "«me", 
STICKY_NAME_DEFAULT
);

873 
Àn
 = 
	`°æí
(
vÆ
);

874 i‡(
Àn
 =0 ||Üí > 
STICKY_NAME_MAXLEN
)

875  -
EINVAL
;

876 
	`mem˝y
(
tfw_cfg_°icky
.
«me
.
±r
, 
vÆ
, 
Àn
);

877 
tfw_cfg_°icky
.
«me
.
Àn
 =Üen;

878 ((*)
tfw_cfg_°icky
.
«me_eq
.
±r
)[
Àn
] = '=';

879 
tfw_cfg_°icky
.
«me_eq
.
Àn
 =Üen + 1;

881 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
vÆ
) {

882 i‡(!
	`°rˇ£cmp
(
vÆ
, "enforce")) {

883 
tfw_cfg_°icky
.
íf‹˚
 = 1;

889 
	}
}

892 
	$tfw_cfg›_˛ónup_°icky
(
TfwCfgS≥c
 *
cs
)

894 
i
;

896 
i
 = 0; i < 
SESS_HASH_SZ
; ++i) {

897 
TfwHâpSess
 *
£ss
;

898 
hli°_node
 *
tmp
;

899 
SessHashBuckë
 *
hb
 = &
£ss_hash
[
i
];

901 
	`hli°_f‹_óch_íåy_ß„
(
£ss
, 
tmp
, &
hb
->
li°
, 
híåy
)

902 
	`tfw_hâp_£ss_ªmove
(
£ss
);

904 
	`mem£t
(
tfw_cfg_°icky
.
«me
.
±r
, 0, 
STICKY_NAME_MAXLEN
 + 1);

905 
tfw_cfg_°icky
.
«me
.
Àn
 =Åfw_cfg_°icky.
«me_eq
.len = 0;

906 
tfw_cfg_°icky
.
íf‹˚
 = 0;

907 
	}
}

910 
	$tfw_cfg›_°icky_£¸ë
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

912 
r
;

913 
Àn
 = ()
	`°æí
(
˚
->
vÆs
[0]);

915 i‡(
	`tfw_cfg_check_sögÀ_vÆ
(
˚
))

916  -
EINVAL
;

917 i‡(
Àn
 > 
STICKY_KEY_MAXLEN
)

918  -
EINVAL
;

920 i‡(
Àn
) {

921 
	`mem£t
(
tfw_°icky_key
, 0, 
STICKY_KEY_MAXLEN
);

922 
	`mem˝y
(
tfw_°icky_key
, 
˚
->
vÆs
[0], 
Àn
);

925 
	`gë_øndom_byãs
(
tfw_°icky_key
, (tfw_sticky_key));

926 
Àn
 = (
tfw_°icky_key
);

929 
r
 = 
	`¸y±o_shash_£tkey
(
tfw_°icky_shash
, (
u8
 *)
tfw_°icky_key
, 
Àn
);

930 i‡(
r
)

931  
r
;

934 
	}
}

937 
	$tfw_cfg›_£ss_li„time
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

939 
r
;

941 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

946 i‡(!
r
 && !
tfw_cfg_°icky
.
£ss_li„time
)

947 
tfw_cfg_°icky
.
£ss_li„time
 = 
UINT_MAX
;

949  
r
;

950 
	}
}

953 
	$tfw_cfg_›_jsch_∑r£_time
(
TfwCfgS≥c
 *
cs
, c⁄° *
key
, c⁄° *
vÆ
,

954 
time_t
 *
time
)

956 
r
, 
öt_vÆ
;

958 i‡((
r
 = 
	`tfw_cfg_∑r£_öt
(
vÆ
, &
öt_vÆ
))) {

959 
	`TFW_ERR_NL
("%s: c™'à∑r£ key '%s'\n", 
cs
->
«me
, 
key
);

960  
r
;

962 *
time
 = 
öt_vÆ
 * 
HZ
 / 1000;

965 
	}
}

968 
	$tfw_cfg_›_jsch_∑r£_ª•_code
(
TfwCfgS≥c
 *
cs
, c⁄° *
vÆ
)

970 
r
, 
öt_vÆ
;

972 i‡((
r
 = 
	`tfw_cfg_∑r£_öt
(
vÆ
, &
öt_vÆ
))) {

973 
	`TFW_ERR_NL
("%s: c™'à∑r£ key 'ª•_code'\n", 
cs
->
«me
);

974  
r
;

976 i‡((
r
 = 
	`tfw_cfg_check_ønge
(
öt_vÆ
, 100, 599)))

977  
r
;

978 
tfw_cfg_js_ch
->
°_code
 = 
öt_vÆ
;

981 
	}
}

984 
	$tfw_cfg›_jsch_£t_dñay_limô
(
TfwCfgS≥c
 *
cs
, 
time_t
 
limô
)

986 
time_t
 
mö_limô
 = 
tfw_cfg_js_ch
->
dñay_mö
 +Åfw_cfg_js_ch->
dñay_ønge
;

987 
time_t
 
w¨n_limô
 = 
mö_limô
 + 
HZ
 / 10;

988 c⁄° 
time_t
 
def_limô
 = 
mö_limô
 + 
HZ
;

990 i‡(!
limô
) {

991 
tfw_cfg_js_ch
->
dñay_limô
 = 
def_limô
;

995 i‡(
limô
 < 
mö_limô
) {

996 
	`TFW_WARN_NL
("%s: delayÜimit isÅooÜow, "

999 
cs
->
«me
, 
mö_limô
 * 1000 / 
HZ
);

1000 
tfw_cfg_js_ch
->
dñay_limô
 = 
mö_limô
;

1004 i‡(
limô
 < 
w¨n_limô
)

1005 
	`TFW_WARN_NL
("%s: delayÜimit isÜessÅhan "

1008 
cs
->
«me
, 
w¨n_limô
 * 1000 / 
HZ
);

1009 
tfw_cfg_js_ch
->
dñay_limô
 = 
limô
;

1010 
	}
}

1013 
	$tfw_cfg›_jsch_£t_body
(
TfwCfgS≥c
 *
cs
, c⁄° *
s¸ùt
)

1015 *
body_d©a
;

1016 
size_t
 
sz
;

1018 
body_d©a
 = 
	`tfw_hâp_msg_body_dup
(
s¸ùt
, &
sz
);

1019 i‡(!
body_d©a
) {

1020 
	`k‰ì
(
tfw_cfg_js_ch
);

1021 
tfw_cfg_js_ch
 = 
NULL
;

1022  -
ENOMEM
;

1024 
tfw_cfg_js_ch
->
body
.
Àn
 = 
sz
;

1025 
tfw_cfg_js_ch
->
body
.
±r
 = 
body_d©a
;

1028 
	}
}

1031 
	$tfw_cfg›_js_chÆÀnge
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1033 
time_t
 
dñay_limô
 = 0;

1034 
i
, 
r
;

1035 c⁄° *
key
, *
vÆ
;

1037 
tfw_cfg_js_ch
 = 
	`kzÆloc
((
TfwCfgJsCh
), 
GFP_KERNEL
);

1038 i‡(!
tfw_cfg_js_ch
) {

1039 
	`TFW_ERR_NL
("%s: c™'àÆlo¯mem‹y\n", 
cs
->
«me
);

1040  -
ENOMEM
;

1043 i‡(
˚
->
vÆ_n
 > 1) {

1044 
	`TFW_ERR_NL
("invalidÇumber of values; 1Öossible, got: %zu\n",

1045 
˚
->
vÆ_n
);

1046  -
EINVAL
;

1048 
	`TFW_CFG_ENTRY_FOR_EACH_ATTR
(
˚
, 
i
, 
key
, 
vÆ
) {

1049 i‡(!
	`°rˇ£cmp
(
key
, "delay_min")) {

1050 
r
 = 
	`tfw_cfg_›_jsch_∑r£_time
(
cs
, 
key
, 
vÆ
,

1051 &
tfw_cfg_js_ch
->
dñay_mö
);

1052 i‡(
r
)

1053  
r
;

1054 } i‡(!
	`°rˇ£cmp
(
key
, "delay_range")) {

1055 
r
 = 
	`tfw_cfg_›_jsch_∑r£_time
(
cs
, 
key
, 
vÆ
,

1056 &
tfw_cfg_js_ch
->
dñay_ønge
);

1057 i‡(
r
)

1058  
r
;

1059 } i‡(!
	`°rˇ£cmp
(
key
, "delay_limit")) {

1060 
r
 = 
	`tfw_cfg_›_jsch_∑r£_time
(
cs
, 
key
, 
vÆ
,

1061 &
dñay_limô
);

1062 i‡(
r
)

1063  
r
;

1064 } i‡(!
	`°rˇ£cmp
(
key
, "resp_code")) {

1065 
r
 = 
	`tfw_cfg_›_jsch_∑r£_ª•_code
(
cs
, 
vÆ
);

1066 i‡(
r
)

1067  
r
;

1069 
	`TFW_ERR_NL
("%s: unsupportedárgument: '%s=%s'.\n",

1070 
cs
->
«me
, 
key
, 
vÆ
);

1071  -
EINVAL
;

1074 i‡(!
tfw_cfg_js_ch
->
dñay_mö
) {

1075 
	`TFW_ERR_NL
("%s:Ñequiredárgument 'delay_min'Çot set.\n",

1076 
cs
->
«me
);

1077  -
EINVAL
;

1079 i‡(!
tfw_cfg_js_ch
->
dñay_ønge
) {

1080 
	`TFW_ERR_NL
("%s:Ñequiredárgument 'delay_range'Çot set.\n",

1081 
cs
->
«me
);

1082  -
EINVAL
;

1084 i‡(!
tfw_cfg_js_ch
->
°_code
)

1085 
tfw_cfg_js_ch
->
°_code
 = 
tfw_cfg_jsch_code_dÊt
;

1087 
	`tfw_cfg›_jsch_£t_dñay_limô
(
cs
, 
dñay_limô
);

1089  
	`tfw_cfg›_jsch_£t_body
(
cs
,

1090 
˚
->
vÆ_n
 ? ce->
vÆs
[0] : 
TFW_CFG_JS_PATH
);

1091 
	}
}

1094 
	$tfw_cfg›_˛ónup_js_chÆÀnge
(
TfwCfgS≥c
 *
cs
)

1096 i‡(!
tfw_cfg_js_ch
)

1099 i‡(
tfw_cfg_js_ch
->
body
.
±r
)

1100 
	`‰ì_∑ges
(()
tfw_cfg_js_ch
->
body
.
±r
,

1101 
	`gë_‹dî
(
tfw_cfg_js_ch
->
body
.
Àn
));

1102 
	`k‰ì
(
tfw_cfg_js_ch
);

1103 
tfw_cfg_js_ch
 = 
NULL
;

1104 
	}
}

1107 
	$tfw_hâp_£ss_cfgíd
()

1109 i‡(
tfw_cfg_js_ch
 && 
	`TFW_STR_EMPTY
(&
tfw_cfg_°icky
.
«me
)) {

1110 
	`TFW_ERR_NL
("JavaScript challengeÑequires sticky cookies "

1112  -
EINVAL
;

1114 i‡(
tfw_cfg_js_ch
) {

1115 
tfw_cfg_°icky
.
íf‹˚
 = 
åue
;

1116 
tfw_cfg_ªdúe˘_°_code
 = 
tfw_cfg_js_ch
->
°_code
;

1118 
tfw_cfg_ªdúe˘_°_code
 = 
tfw_cfg_ªdúe˘_°_code_dÊt
;

1122 
	}
}

1125 
	$tfw_hâp_£ss_°¨t
()

1127 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1129 
tfw_cfg_°icky
.
íabÀd
 = !
	`TFW_STR_EMPTY
(&tfw_cfg_°icky.
«me
);

1132 
	}
}

1135 
	$tfw_hâp_£ss_°›
()

1137 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1139 
tfw_cfg_°icky
.
íabÀd
 = 0;

1140 
	}
}

1142 
TfwCfgS≥c
 
	gtfw_hâp_£ss_•ecs
[] = {

1144 .
«me
 = "sticky",

1145 .
	gh™dÀr
 = 
tfw_cfg›_°icky
,

1146 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_°icky
,

1147 .
	gÆlow_n⁄e
 = 
åue
,

1150 .
	g«me
 = "sticky_secret",

1151 .
	gdeÊt
 = "\"\"",

1152 .
	gh™dÀr
 = 
tfw_cfg›_°icky_£¸ë
,

1153 .
	gÆlow_n⁄e
 = 
åue
,

1157 .
	g«me
 = "sess_lifetime",

1158 .
	gdeÊt
 = "0",

1159 .
	gh™dÀr
 = 
tfw_cfg›_£ss_li„time
,

1160 .
	gde°
 = &
tfw_cfg_°icky
.
£ss_li„time
,

1161 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

1162 .
ønge
 = { 0, 
INT_MAX
 },

1164 .
	gÆlow_n⁄e
 = 
åue
,

1167 .
	g«me
 = "js_challenge",

1168 .
	gh™dÀr
 = 
tfw_cfg›_js_chÆÀnge
,

1169 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_js_chÆÀnge
,

1170 .
	gÆlow_n⁄e
 = 
åue
,

1175 
TfwMod
 
	gtfw_hâp_£ss_mod
 = {

1176 .
«me
 = "http_sess",

1177 .
	gcfgíd
 = 
tfw_hâp_£ss_cfgíd
,

1178 .
	g°¨t
 = 
tfw_hâp_£ss_°¨t
,

1179 .
	g°›
 = 
tfw_hâp_£ss_°›
,

1180 .
	g•ecs
 = 
tfw_hâp_£ss_•ecs
,

1183 
__öô


1184 
	$tfw_hâp_£ss_öô
()

1186 
i
, 
ªt
 = -
ENOMEM
;

1187 
u_ch¨
 *
±r
;

1189 i‡((
±r
 = 
	`kzÆloc
(
STICKY_NAME_MAXLEN
 + 1, 
GFP_KERNEL
)Ë=
NULL
)

1190  -
ENOMEM
;

1192 
tfw_cfg_°icky
.
«me
.
±r
 =Åfw_cfg_°icky.
«me_eq
.ptr =Ötr;

1193 
tfw_cfg_°icky
.
«me
.
Àn
 =Åfw_cfg_°icky.
«me_eq
.len = 0;

1195 
tfw_°icky_shash
 = 
	`¸y±o_Æloc_shash
("hmac(sha1)", 0, 0);

1196 i‡(
	`IS_ERR
(
tfw_°icky_shash
)) {

1197 
	`¥_îr
("shashállocation failed\n");

1198 
ªt
 = ()
	`PTR_ERR
(
tfw_°icky_shash
);

1199 
îr
;

1202 
£ss_ˇche
 = 
	`kmem_ˇche_¸óã
("tfw_£ss_ˇche", (
TfwHâpSess
),

1203 0, 0, 
NULL
);

1204 i‡(!
£ss_ˇche
)

1205 
îr_shash
;

1211 
i
 = 0; i < 
SESS_HASH_SZ
; ++i)

1212 
	`•ö_lock_öô
(&
£ss_hash
[
i
].
lock
);

1214 
	`tfw_mod_ªgi°î
(&
tfw_hâp_£ss_mod
);

1218 
îr_shash
:

1219 
	`¸y±o_‰ì_shash
(
tfw_°icky_shash
);

1220 
îr
:

1221 
	`k‰ì
(
tfw_cfg_°icky
.
«me
.
±r
);

1222  
ªt
;

1223 
	}
}

1226 
	$tfw_hâp_£ss_exô
()

1228 
	`tfw_mod_uƒegi°î
(&
tfw_hâp_£ss_mod
);

1229 
	`kmem_ˇche_de°roy
(
£ss_ˇche
);

1230 
	`k‰ì
(
tfw_cfg_°icky
.
«me
.
±r
);

1231 
	`mem£t
(&
tfw_cfg_°icky
, 0, (tfw_cfg_sticky));

1232 
	`¸y±o_‰ì_shash
(
tfw_°icky_shash
);

1233 
	}
}

	@http_sess.h

20 #i‚de‡
__TFW_HTTP_SESS_H__


21 
	#__TFW_HTTP_SESS_H__


	)

23 
	~"hâp.h
"

58 
TfwSrvC⁄n
 *
	m§v_c⁄n
;

59 
rwlock_t
 
	mlock
;

60 } 
	tTfwStickyC⁄n
;

72 
	stfw_hâp_£ss_t
 {

73 
	mhmac
[
SHA1_DIGEST_SIZE
];

74 
hli°_node
 
	mhíåy
;

75 
©omic_t
 
	mu£rs
;

76 
	mts
;

77 
	mexpúes
;

78 
TfwStickyC⁄n
 
	m°_c⁄n
;

83 
	mTFW_HTTP_SESS_FAILURE
 = -1,

85 
	mTFW_HTTP_SESS_SUCCESS
 = 0,

87 
	mTFW_HTTP_SESS_REDIRECT_SENT
,

89 
	mTFW_HTTP_SESS_VIOLATE
,

91 
	mTFW_HTTP_SESS_JS_NOT_SUPPORTED


94 
tfw_hâp_£ss_obèö
(
TfwHâpReq
 *
ªq
);

95 
tfw_hâp_£ss_ª•_¥o˚ss
(
TfwHâpRe•
 *
ª•
);

96 
tfw_hâp_£ss_put
(
TfwHâpSess
 *
£ss
);

99 
TfwSrvC⁄n
 *
tfw_hâp_£ss_gë_§v_c⁄n
(
TfwMsg
 *
msg
);

101 
tfw_hâp_£ss_u£_°icky_£ss
(
boﬁ
 
u£
);

	@http_tbl.c

102 
	~<löux/°rög.h
>

103 
	~<löux/˘y≥.h
>

105 
	~"hâp_tbl.h
"

106 
	~"ãm≥°a_fw.h
"

107 
	~"cfg.h
"

108 
	~"hâp_m©ch.h
"

109 
	~"£rvî.h
"

112 
TfwHâpTabÀ
 
__rcu
 *
	gtfw_èbÀ
;

114 
TfwHâpTabÀ
 *
	gtfw_èbÀ_ªc⁄fig
;

116 
TfwHâpChaö
 *
	gtfw_chaö_íåy
;

123 
TfwVho°
 *

124 
	$tfw_hâp_tbl_sˇn
(
TfwMsg
 *
msg
, 
TfwHâpTabÀ
 *
èbÀ
, 
boﬁ
 *
block
)

126 
TfwHâpChaö
 *
chaö
;

127 
TfwHâpM©chRuÀ
 *
ruÀ
;

129 
chaö
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
èbÀ
->
hód
, 
TfwHâpChaö
, 
li°
);

130 
	`BUG_ON
(!
chaö
 || chaö->
«me
);

131 
chaö
) {

132 
ruÀ
 = 
	`tfw_hâp_m©ch_ªq
((
TfwHâpReq
 *)
msg
, &
chaö
->
m¨k_li°
);

133 i‡(!
ruÀ
)

134 
ruÀ
 = 
	`tfw_hâp_m©ch_ªq
((
TfwHâpReq
 *)
msg
,

135 &
chaö
->
m©ch_li°
);

136 i‡(
	`u∆ikñy
(!
ruÀ
)) {

137 
	`TFW_DBG
("http_tbl: NoÑule found in HTTP"

138 " chaö '%s'\n", 
chaö
->
«me
);

139  
NULL
;

141 
chaö
 = (
ruÀ
->
a˘
.
ty≥
 =
TFW_HTTP_MATCH_ACT_CHAIN
)

142 ? 
ruÀ
->
a˘
.
chaö


143 : 
NULL
;

147 i‡(
ruÀ
->
a˘
.
ty≥
 =
TFW_HTTP_MATCH_ACT_VHOST
)

148  
ruÀ
->
a˘
.
vho°
;

151 i‡(
ruÀ
->
a˘
.
ty≥
 =
TFW_HTTP_MATCH_ACT_BLOCK
)

152 *
block
 = 
åue
;

154  
NULL
;

155 
	}
}

164 
TfwVho°
 *

165 
	$tfw_hâp_tbl_vho°
(
TfwMsg
 *
msg
, 
boﬁ
 *
block
)

167 
TfwVho°
 *
vho°
 = 
NULL
;

168 
TfwHâpTabÀ
 *
a˘ive_èbÀ
;

170 
	`rcu_ªad_lock_bh
();

172 
a˘ive_èbÀ
 = 
	`rcu_dîe„ªn˚_bh
(
tfw_èbÀ
);

173 if(!
a˘ive_èbÀ
)

174 
d⁄e
;

176 
	`BUG_ON
(
	`li°_em±y
(&
a˘ive_èbÀ
->
hód
));

177 i‡((
vho°
 = 
	`tfw_hâp_tbl_sˇn
(
msg
, 
a˘ive_èbÀ
, 
block
)))

178 
	`tfw_vho°_gë
(
vho°
);

179 
d⁄e
:

180 
	`rcu_ªad_u∆ock_bh
();

181  
vho°
;

182 
	}
}

191 c⁄° 
TfwCfgEnum
 
	gtfw_hâp_tbl_cfg_fõld_íum
[] = {

192 { "uri", 
TFW_HTTP_MATCH_F_URI
 },

193 { "ho°", 
TFW_HTTP_MATCH_F_HOST
 },

194 { "hdr_ho°", 
TFW_HTTP_MATCH_F_HDR_HOST
 },

195 { "hdr_c⁄n", 
TFW_HTTP_MATCH_F_HDR_CONN
 },

196 { "hdr_˘y≥", 
TFW_HTTP_MATCH_F_HDR_CTYPE
 },

197 { "hdr_uagít", 
TFW_HTTP_MATCH_F_HDR_UAGENT
 },

198 { "hdr_cookõ", 
TFW_HTTP_MATCH_F_HDR_COOKIE
 },

199 { "hdr_ªf", 
TFW_HTTP_MATCH_F_HDR_REFERER
 },

200 { "hdr_nm©ch", 
TFW_HTTP_MATCH_F_HDR_NMATCH
 },

201 { "hdr_x‰wd", 
TFW_HTTP_MATCH_F_HDR_XFRWD
 },

202 { "m¨k", 
TFW_HTTP_MATCH_F_MARK
 },

203 { "hdr_øw", 
TFW_HTTP_MATCH_F_HDR_RAW
 },

204 { "mëhod", 
TFW_HTTP_MATCH_F_METHOD
 },

208 c⁄° 
TfwCfgEnum
 
	gtfw_hâp_tbl_cfg_mëhod_íum
[] = {

209 { "c›y", 
TFW_HTTP_METH_COPY
 },

210 { "dñëe", 
TFW_HTTP_METH_DELETE
 },

211 { "gë", 
TFW_HTTP_METH_GET
 },

212 { "hód", 
TFW_HTTP_METH_HEAD
 },

213 { "lock", 
TFW_HTTP_METH_LOCK
 },

214 { "mkcﬁ", 
TFW_HTTP_METH_MKCOL
 },

215 { "move", 
TFW_HTTP_METH_MOVE
 },

216 { "›ti⁄s", 
TFW_HTTP_METH_OPTIONS
 },

217 { "∑tch", 
TFW_HTTP_METH_PATCH
 },

218 { "po°", 
TFW_HTTP_METH_POST
 },

219 { "¥›föd", 
TFW_HTTP_METH_PROPFIND
 },

220 { "¥›∑tch", 
TFW_HTTP_METH_PROPPATCH
 },

221 { "put", 
TFW_HTTP_METH_PUT
 },

222 { "åa˚", 
TFW_HTTP_METH_TRACE
 },

223 { "u∆ock", 
TFW_HTTP_METH_UNLOCK
, },

224 { "purge", 
TFW_HTTP_METH_PURGE
 },

228 c⁄° 
tfw_hâp_m©ch_¨g_t


229 
	gtfw_hâp_tbl_cfg_¨g_ty≥s
[
_TFW_HTTP_MATCH_F_COUNT
] = {

230 [
TFW_HTTP_MATCH_F_WILDCARD
] = 
TFW_HTTP_MATCH_A_WILDCARD
,

231 [
TFW_HTTP_MATCH_F_HDR_CONN
] = 
TFW_HTTP_MATCH_A_STR
,

232 [
TFW_HTTP_MATCH_F_HDR_HOST
] = 
TFW_HTTP_MATCH_A_STR
,

233 [
TFW_HTTP_MATCH_F_HDR_CTYPE
] = 
TFW_HTTP_MATCH_A_STR
,

234 [
TFW_HTTP_MATCH_F_HDR_UAGENT
] = 
TFW_HTTP_MATCH_A_STR
,

235 [
TFW_HTTP_MATCH_F_HDR_COOKIE
] = 
TFW_HTTP_MATCH_A_STR
,

236 [
TFW_HTTP_MATCH_F_HDR_REFERER
] = 
TFW_HTTP_MATCH_A_STR
,

237 [
TFW_HTTP_MATCH_F_HDR_NMATCH
] = 
TFW_HTTP_MATCH_A_STR
,

238 [
TFW_HTTP_MATCH_F_HDR_XFRWD
] = 
TFW_HTTP_MATCH_A_STR
,

239 [
TFW_HTTP_MATCH_F_HDR_RAW
] = 
TFW_HTTP_MATCH_A_STR
,

240 [
TFW_HTTP_MATCH_F_HOST
] = 
TFW_HTTP_MATCH_A_STR
,

241 [
TFW_HTTP_MATCH_F_METHOD
] = 
TFW_HTTP_MATCH_A_METHOD
,

242 [
TFW_HTTP_MATCH_F_URI
] = 
TFW_HTTP_MATCH_A_STR
,

243 [
TFW_HTTP_MATCH_F_MARK
] = 
TFW_HTTP_MATCH_A_NUM
,

247 
	$tfw_hâp_tbl_mëhod
(c⁄° *
¨g
, 
tfw_hâp_mëh_t
 *
mëhod
)

249 i‡(
	`tfw_cfg_m≠_íum
(
tfw_hâp_tbl_cfg_mëhod_íum
, 
¨g
, 
mëhod
))

251 
	`TFW_ERR_NL
("http_tbl: invalid 'method' condition:"

252 " '%s'\n", 
¨g
);

253  -
EINVAL
;

256 
	}
}

258 
TfwHâpChaö
 *

259 
	$tfw_chaö_lookup
(c⁄° *
«me
)

261 
TfwHâpChaö
 *
chaö
;

263 
	`li°_f‹_óch_íåy
(
chaö
, &
tfw_èbÀ_ªc⁄fig
->
hód
, 
li°
) {

264 i‡(
chaö
->
«me
 && !
	`°rˇ£cmp
(chain->name,Çame))

265  
chaö
;

267  
NULL
;

268 
	}
}

270 
ölöe
 
boﬁ


271 
	$tfw_hâp_ruÀ_deÁu…_exi°
(
li°_hód
 *
hód
)

273 
TfwHâpM©chRuÀ
 *
ruÀ
;

275 
ruÀ
 = !
	`li°_em±y
(
hód
)

276 ? 
	`li°_œ°_íåy
(
hód
, 
TfwHâpM©chRuÀ
, 
li°
)

277 : 
NULL
;

279 i‡(
ruÀ


280 && !
ruÀ
->
öv


281 && 
ruÀ
->
fõld
 =
TFW_HTTP_MATCH_F_WILDCARD


282 && 
ruÀ
->
a˘
.
ty≥
 !
TFW_HTTP_MATCH_ACT_MARK
)

283  
åue
;

285  
Ál£
;

286 
	}
}

289 
	$tfw_hâp_tbl_cfg°¨t
()

291 
	`BUG_ON
(
tfw_èbÀ_ªc⁄fig
);

293 
tfw_èbÀ_ªc⁄fig
 = 
	`tfw_poﬁ_√w
(
TfwHâpTabÀ
, 
TFW_POOL_ZERO
);

294 i‡(!
tfw_èbÀ_ªc⁄fig
) {

295 
	`TFW_ERR_NL
("Can't createá memoryÖool\n");

296  -
ENOMEM
;

299 
	`INIT_LIST_HEAD
(&
tfw_èbÀ_ªc⁄fig
->
hód
);

302 
	}
}

309 
	$tfw_cfg›_hâp_tbl_chaö_begö
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

311 
TfwHâpChaö
 *
chaö
;

312 c⁄° *
«me
 = 
NULL
;

314 
	`BUG_ON
(!
tfw_èbÀ_ªc⁄fig
);

315 
	`BUG_ON
(
tfw_chaö_íåy
);

317 
	`TFW_DBG
("http_tbl: begin http_chain\n");

319 i‡(
˚
->
vÆ_n
 > 1) {

320 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

321  -
EINVAL
;

323 i‡(
˚
->
©å_n
) {

324 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

325  -
EINVAL
;

328 
chaö
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
tfw_èbÀ_ªc⁄fig
->
hód
,

329 
TfwHâpChaö
, 
li°
);

330 i‡(
chaö
 && !chaö->
«me
) {

331 
	`TFW_ERR_NL
("Main HTTP chain must be only oneándÜast\n");

332  -
EINVAL
;

334 i‡(
˚
->
vÆ_n
) {

335 
«me
 = 
˚
->
vÆs
[0];

336 
	`li°_f‹_óch_íåy
(
chaö
, &
tfw_èbÀ_ªc⁄fig
->
hód
, 
li°
) {

337 i‡(!
	`°rˇ£cmp
(
chaö
->
«me
,Çame)) {

338 
	`TFW_ERR_NL
("Duplicate http chain"

339 "É¡ry: '%s'\n", 
«me
);

340  -
EINVAL
;

345 
tfw_chaö_íåy
 = 
	`tfw_hâp_chaö_add
(
«me
, 
tfw_èbÀ_ªc⁄fig
);

346 i‡(!
tfw_chaö_íåy
)

347  -
ENOMEM
;

350 
	}
}

353 
	$tfw_cfg›_hâp_tbl_chaö_föish
(
TfwCfgS≥c
 *
cs
)

355 
	`TFW_DBG
("http_tbl: finish http_chain\n");

356 
	`BUG_ON
(!
tfw_chaö_íåy
);

357 
tfw_chaö_íåy
 = 
NULL
;

359 
	}
}

389 
	$tfw_cfg›_hâp_ruÀ
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

391 
r
;

392 
övît
;

393 
TfwHâpM©chRuÀ
 *
ruÀ
;

394 c⁄° *
ö_fõld
, *
a˘i⁄
, *
a˘i⁄_vÆ
, *
ö_¨g
, *
¨g
 = 
NULL
;

395 
tfw_hâp_m©ch_›_t
 
›
 = 
TFW_HTTP_MATCH_O_WILDCARD
;

396 
tfw_hâp_m©ch_Êd_t
 
fõld
 = 
TFW_HTTP_MATCH_F_WILDCARD
;

397 
tfw_hâp_m©ch_¨g_t
 
ty≥
 = 
TFW_HTTP_MATCH_A_WILDCARD
;

398 
TfwCfgRuÀ
 *
cfg_ruÀ
 = &
e
->
ruÀ
;

399 
size_t
 
Àn
, 
¨g_size
 = 0;

400 
TfwHâpChaö
 *
chaö
 = 
NULL
;

401 
TfwVho°
 *
vho°
 = 
NULL
;

403 
	`BUG_ON
(!
tfw_chaö_íåy
);

404 i‡((
r
 = 
	`tfw_cfg_check_vÆ_n
(
e
, 0)))

405  
r
;

406 i‡(
e
->
©å_n
) {

407 
	`TFW_ERR_NL
("Attibutes count must be zero\n");

408  -
EINVAL
;

411 
övît
 = 
cfg_ruÀ
->
öv
;

412 
ö_fõld
 = 
cfg_ruÀ
->
f°
;

413 
ö_¨g
 = 
cfg_ruÀ
->
¢d
;

414 i‡(
ö_¨g
)

415 
Àn
 = 
	`°æí
(
ö_¨g
);

416 
a˘i⁄
 = 
cfg_ruÀ
->
a˘
;

417 
a˘i⁄_vÆ
 = 
cfg_ruÀ
->
vÆ
;

418 
	`BUG_ON
(!
a˘i⁄
);

420 i‡(
	`tfw_hâp_ruÀ_deÁu…_exi°
(&
tfw_chaö_íåy
->
m©ch_li°
)) {

421 
	`TFW_ERR_NL
("http_tbl: default HTTPÑule must be"

423 
tfw_chaö_íåy
->
«me
 ? : "main" );

424  -
EINVAL
;

428 i‡(
ö_¨g
 && (ö_¨g[0] !'*' || 
Àn
 > 1)) {

429 
	`BUG_ON
(!
ö_fõld
);

430 
r
 = 
	`tfw_cfg_m≠_íum
(
tfw_hâp_tbl_cfg_fõld_íum
,

431 
ö_fõld
, &
fõld
);

432 i‡(
r
) {

433 
	`TFW_ERR_NL
("http_tbl: invalidÑule field: '%s'\n",

434 
ö_fõld
);

435  
r
;

437 
ty≥
 = 
tfw_hâp_tbl_cfg_¨g_ty≥s
[
fõld
];

438 i‡(!(
¨g
 = 
	`tfw_hâp_¨g_adju°
(
ö_¨g
, 
Àn
, &
¨g_size
, &
›
)))

439  -
ENOMEM
;

441 
ruÀ
 = 
	`tfw_hâp_ruÀ_√w
(
tfw_chaö_íåy
, 
ty≥
, 
¨g_size
);

442 i‡(!
ruÀ
) {

443 
	`TFW_ERR_NL
("http_tbl: can'tállocate memory forÑule\n");

444 
r
 = -
ENOMEM
;

445 
îr
;

447 
	`BUG_ON
(
ty≥
 !
TFW_HTTP_MATCH_A_STR


448 && 
ty≥
 !
TFW_HTTP_MATCH_A_NUM


449 && 
ty≥
 !
TFW_HTTP_MATCH_A_METHOD


450 && 
ty≥
 !
TFW_HTTP_MATCH_A_WILDCARD
);

451 
ruÀ
->
öv
 = 
övît
;

452 
r
 = 
	`tfw_hâp_ruÀ_öô
(
ruÀ
, 
fõld
, 
›
, 
ty≥
, 
¨g
, 
¨g_size
 - 1);

453 i‡(
r
)

454 
îr
;

455 
	`k‰ì
(
¨g
);

459 i‡(!
	`°rˇ£cmp
(
a˘i⁄
, "mark")) {

460 i‡(!
a˘i⁄_vÆ
 ||

461 
	`tfw_cfg_∑r£_uöt
(
a˘i⁄_vÆ
,&
ruÀ
->
a˘
.
m¨k
))

463 
	`TFW_ERR_NL
("http_tbl: 'mark'áction must have"

465 
a˘i⁄_vÆ
);

466  -
EINVAL
;

468 
ruÀ
->
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_MARK
;

469 } i‡(
a˘i⁄_vÆ
) {

470 
	`TFW_ERR_NL
("http_tbl:Çot 'mark'áctions mustÇot have"

471 "ány vÆue: '%s'\n", 
a˘i⁄_vÆ
);

472  -
EINVAL
;

473 } i‡(!
	`°rˇ£cmp
(
a˘i⁄
, "block")) {

474 
ruÀ
->
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_BLOCK
;

475 } i‡((
chaö
 = 
	`tfw_chaö_lookup
(
a˘i⁄
))) {

476 
ruÀ
->
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_CHAIN
;

477 
ruÀ
->
a˘
.
chaö
 = chain;

478 } i‡((
vho°
 = 
	`tfw_vho°_lookup
(
a˘i⁄
))) {

479 
ruÀ
->
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_VHOST
;

480 
ruÀ
->
a˘
.
vho°
 = vhost;

482 
	`TFW_ERR_NL
("http_tbl:Çeither http_chainÇor vhost with"

483 " s≥cifõdÇamêwîêfound: '%s'\n", 
a˘i⁄
);

484  -
EINVAL
;

487 i‡(
chaö
 =
tfw_chaö_íåy
) {

488 
	`TFW_ERR_NL
("http_tbl: cyclicÑeference of http_chainÅo"

489 " it£lf: '%s'\n", 
tfw_chaö_íåy
->
«me
);

490  -
EINVAL
;

493 i‡(
vho°
 && !
	`°rˇ£cmp
(vho°->
«me
, 
TFW_VH_DFT_NAME
))

494 
tfw_èbÀ_ªc⁄fig
->
chaö_dÊt
 = 
åue
;

497 
îr
:

498 
	`k‰ì
(
¨g
);

499  
r
;

500 
	}
}

503 
	$tfw_cfg›_ªÀa£_ruÀ
(
TfwHâpM©chRuÀ
 *
ruÀ
)

505 i‡(
ruÀ
->
a˘
.
ty≥
 =
TFW_HTTP_MATCH_ACT_VHOST
)

506 
	`tfw_vho°_put
(
ruÀ
->
a˘
.
vho°
);

508 
	}
}

511 
	$tfw_cfg›_‰ì_èbÀ
(
TfwHâpTabÀ
 *
èbÀ
)

513 
TfwHâpChaö
 *
chaö
;

515 i‡(!
èbÀ
)

518 
	`li°_f‹_óch_íåy
(
chaö
, &
èbÀ
->
hód
, 
li°
) {

519 
	`tfw_hâp_chaö_ruÀs_f‹_óch
(
chaö
, 
tfw_cfg›_ªÀa£_ruÀ
);

521 
	`tfw_hâp_èbÀ_‰ì
(
èbÀ
);

522 
	}
}

525 
	$tfw_cfg›_ª∂a˚_a˘ive_èbÀ
(
TfwHâpTabÀ
 *
√w_èbÀ
)

527 
TfwHâpTabÀ
 *
a˘ive_èbÀ
 = 
tfw_èbÀ
;

529 
	`rcu_assign_poöãr
(
tfw_èbÀ
, 
√w_èbÀ
);

530 
	`synchr⁄ize_rcu_bh
();

532 
	`tfw_cfg›_‰ì_èbÀ
(
a˘ive_èbÀ
);

533 
	}
}

536 
	$tfw_hâp_tbl_°¨t
()

538 
	`tfw_cfg›_ª∂a˚_a˘ive_èbÀ
(
tfw_èbÀ_ªc⁄fig
);

539 
tfw_èbÀ_ªc⁄fig
 = 
NULL
;

542 
	}
}

545 
	$tfw_hâp_tbl_cfgíd
()

547 
r
;

548 
TfwVho°
 *
vho°_dÊt
;

549 
TfwHâpChaö
 *
chaö
;

550 
TfwHâpM©chRuÀ
 *
ruÀ
;

559 
	`BUG_ON
(!
tfw_èbÀ_ªc⁄fig
);

560 
chaö
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
tfw_èbÀ_ªc⁄fig
->
hód
,

561 
TfwHâpChaö
, 
li°
);

562 i‡(
chaö
 && !chaö->
«me
)

565 i‡(!(
chaö
 = 
	`tfw_hâp_chaö_add
(
NULL
, 
tfw_èbÀ_ªc⁄fig
)))

566  -
ENOMEM
;

568 i‡(
tfw_èbÀ_ªc⁄fig
->
chaö_dÊt
)

571 i‡(!(
vho°_dÊt
 = 
	`tfw_vho°_lookup
(
TFW_VH_DFT_NAME
)))

574 
ruÀ
 = 
	`tfw_hâp_ruÀ_√w
(
chaö
, 
TFW_HTTP_MATCH_A_WILDCARD
, 0);

575 i‡(!
ruÀ
) {

576 
	`TFW_ERR_NL
("http_tbl: can'tállocate memory for"

578 
r
 = -
ENOMEM
;

579 
îr
;

581 
r
 = 
	`tfw_hâp_ruÀ_öô
(
ruÀ
, 
TFW_HTTP_MATCH_F_WILDCARD
,

582 
TFW_HTTP_MATCH_O_WILDCARD
,

583 
TFW_HTTP_MATCH_A_WILDCARD
,

584 
NULL
, 0);

585 i‡(
r
)

586 
îr
;

588 
ruÀ
->
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_VHOST
;

589 
ruÀ
->
a˘
.
vho°
 = 
vho°_dÊt
;

592 
îr
:

593 
	`tfw_vho°_put
(
vho°_dÊt
);

594  
r
;

595 
	}
}

602 
	$__tfw_cfg›_ruÀs_˛ónup
()

604 
	`tfw_cfg›_‰ì_èbÀ
(
tfw_èbÀ_ªc⁄fig
);

605 
tfw_èbÀ_ªc⁄fig
 = 
NULL
;

607 i‡(!
	`tfw_run°©e_is_ªc⁄fig
())

608 
	`tfw_cfg›_ª∂a˚_a˘ive_èbÀ
(
NULL
);

609 
	}
}

612 
	$tfw_cfg›_ruÀs_˛ónup
(
TfwCfgS≥c
 *
cs
)

614 
tfw_chaö_íåy
 = 
NULL
;

615 
	`__tfw_cfg›_ruÀs_˛ónup
();

616 
	}
}

619 
	$tfw_hâp_tbl_cfg˛ón
()

621 
	`__tfw_cfg›_ruÀs_˛ónup
();

622 
	}
}

624 
TfwCfgS≥c
 
	gtfw_hâp_tbl_ruÀs_•ecs
[] = {

626 .
«me
 = 
TFW_CFG_RULE_NAME
,

627 .
	gdeÊt
 = 
NULL
,

628 .
	gh™dÀr
 = 
tfw_cfg›_hâp_ruÀ
,

629 .
	gÆlow_n⁄e
 = 
åue
,

630 .
	gÆlow_ª≥©
 = 
åue
,

631 .
	gÆlow_ªc⁄fig
 = 
åue
,

636 
TfwCfgS≥c
 
	gtfw_hâp_tbl_•ecs
[] = {

638 .
«me
 = "http_chain",

639 .
	gdeÊt
 = 
NULL
,

640 .
	gh™dÀr
 = 
tfw_cfg_h™dÀ_chûdªn
,

641 .
	g˛ónup
 = 
tfw_cfg›_ruÀs_˛ónup
,

642 .
	gde°
 = 
tfw_hâp_tbl_ruÀs_•ecs
,

643 .
	g•ec_ext
 = &(
TfwCfgS≥cChûd
) {

644 .
begö_hook
 = 
tfw_cfg›_hâp_tbl_chaö_begö
,

645 .
	gföish_hook
 = 
tfw_cfg›_hâp_tbl_chaö_föish


647 .
	gÆlow_n⁄e
 = 
åue
,

648 .
	gÆlow_ª≥©
 = 
åue
,

649 .
	gÆlow_ªc⁄fig
 = 
åue
,

654 
TfwMod
 
	gtfw_hâp_tbl_mod
 = {

655 .
«me
 = "http_tbl",

656 .
	gcfg°¨t
 = 
tfw_hâp_tbl_cfg°¨t
,

657 .
	gcfgíd
 = 
tfw_hâp_tbl_cfgíd
,

658 .
	g°¨t
 = 
tfw_hâp_tbl_°¨t
,

659 .
	gcfg˛ón
 = 
tfw_hâp_tbl_cfg˛ón
,

660 .
	g•ecs
 = 
tfw_hâp_tbl_•ecs
,

670 
	$tfw_hâp_tbl_öô
()

672 
	`tfw_mod_ªgi°î
(&
tfw_hâp_tbl_mod
);

674 
	}
}

677 
	$tfw_hâp_tbl_exô
()

679 
	`BUG_ON
(
tfw_èbÀ_ªc⁄fig
);

680 
	`tfw_mod_uƒegi°î
(&
tfw_hâp_tbl_mod
);

681 
	}
}

	@http_tbl.h

21 #i‚de‡
__HTTP_TBL__


22 
	#__HTTP_TBL__


	)

24 
	~"hâp.h
"

36 
li°_hód
 
	mli°
;

37 
li°_hód
 
	mm¨k_li°
;

38 
li°_hód
 
	mm©ch_li°
;

39 c⁄° *
	m«me
;

40 
TfwPoﬁ
 *
	mpoﬁ
;

41 } 
	tTfwHâpChaö
;

52 
li°_hód
 
	mhód
;

53 
boﬁ
 
	mchaö_dÊt
;

54 
TfwPoﬁ
 *
	mpoﬁ
;

55 } 
	tTfwHâpTabÀ
;

57 
TfwVho°
 *
tfw_hâp_tbl_vho°
(
TfwMsg
 *
msg
, 
boﬁ
 *
block
);

58 
tfw_hâp_tbl_mëhod
(c⁄° *
¨g
, 
tfw_hâp_mëh_t
 *
mëhod
);

	@htype.h

22 #i‚de‡
__HTYPE_H__


23 
	#__HTYPE_H__


	)

28 c⁄° 
	gtokí_a
[] 
__©åibuã__
((
Æig√d
(64))) = {

50 c⁄° 
	g__tfw_l˘
[] 
__©åibuã__
((
Æig√d
(64))) = {

88 
	#IS_CRLF
(
c
Ë((cË='\r' || (cË='\n')

	)

92 
	#IS_WS
(
c
Ë((cË=' ' || (cË='\t')

	)

97 
	#IS_CRLFWS
(
c
Ë(
	`IS_WS
(cË|| 
	`IS_CRLF
(c))

	)

104 
	#IS_TOKEN
(
c
Ë(
tokí_a
[c])

	)

111 
	#TFW_LC
(
c
Ë
__tfw_l˘
[c]

	)

	@log.h

21 #i‚de‡
__TFW_LOG_H__


22 
	#__TFW_LOG_H__


	)

24 
	~<löux/kî√l.h
>

26 
	#BANNER
 "fw"

	)

27 
	~"lib/log.h
"

29 
	#TFW_ERR
(...Ë
	`T_ERR
(
__VA_ARGS__
)

	)

30 
	#TFW_ERR_NL
(...Ë
	`T_ERR_NL
(
__VA_ARGS__
)

	)

31 
	#TFW_WARN
(...Ë
	`T_WARN
(
__VA_ARGS__
)

	)

32 
	#TFW_WARN_NL
(...Ë
	`T_WARN_NL
(
__VA_ARGS__
)

	)

33 
	#TFW_LOG
(...Ë
	`T_LOG
(
__VA_ARGS__
)

	)

34 
	#TFW_LOG_NL
(...Ë
	`T_LOG_NL
(
__VA_ARGS__
)

	)

35 
	#TFW_DBG
(...Ë
	`T_DBG
(
__VA_ARGS__
)

	)

36 
	#TFW_DBG2
(...Ë
	`T_DBG2
(
__VA_ARGS__
)

	)

37 
	#TFW_DBG3
(...Ë
	`T_DBG3
(
__VA_ARGS__
)

	)

46 
	#TFW_WITH_ADDR_FMT
(
addr_±r
, 
fmtd_addr_v¨_«me
, 
a˘i⁄_ex¥
) \

48 
fmtd_addr_v¨_«me
[
TFW_ADDR_STR_BUF_SIZE
] = { 0 }; \

49 
	`tfw_addr_¡›
(
addr_±r
, 
fmtd_addr_v¨_«me
, \

50 (
fmtd_addr_v¨_«me
)); \

51 
a˘i⁄_ex¥
; \

52 } 0)

	)

55 
	#TFW_WITH_ADDR6_FMT
(
addr_±r
, 
fmtd_addr_v¨_«me
, 
a˘i⁄_ex¥
) \

57 
fmtd_addr_v¨_«me
[
TFW_ADDR_STR_BUF_SIZE
] = { 0 }; \

58 
	`tfw_addr_fmt_v6
(
addr_±r
, 0, 
fmtd_addr_v¨_«me
); \

59 
a˘i⁄_ex¥
; \

60 } 0)

	)

63 
	#TFW_DBG_ADDR
(
msg
, 
addr_±r
) \

64 
	`TFW_WITH_ADDR_FMT
(
addr_±r
, 
addr_°r
, \

65 
	`T_DBG
("%s: %s\n", 
msg
, 
addr_°r
))

	)

66 
	#TFW_DBG_ADDR6
(
msg
, 
addr_±r
) \

67 
	`TFW_WITH_ADDR6_FMT
(
addr_±r
, 
addr_°r
, \

68 
	`T_DBG
("%s: %s\n", 
msg
, 
addr_°r
))

	)

71 
	#TFW_LOG_ADDR
(
msg
, 
addr_±r
) \

72 
	`TFW_WITH_ADDR_FMT
(
addr_±r
, 
addr_°r
, \

73 
	`T_LOG
("%s: %s\n", 
msg
, 
addr_°r
))

	)

74 
	#TFW_LOG_ADDR6
(
msg
, 
addr_±r
) \

75 
	`TFW_WITH_ADDR6_FMT
(
addr_±r
, 
addr_°r
, \

76 
	`T_LOG
("%s: %s\n", 
msg
, 
addr_°r
))

	)

79 
	#TFW_WARN_ADDR
(
msg
, 
addr_±r
) \

80 
	`TFW_WITH_ADDR_FMT
(
addr_±r
, 
addr_°r
, \

81 
	`T_WARN
("%s: %s\n", 
msg
, 
addr_°r
))

	)

82 
	#TFW_WARN_ADDR6
(
msg
, 
addr_±r
) \

83 
	`TFW_WITH_ADDR6_FMT
(
addr_±r
, 
addr_°r
, \

84 
	`T_WARN
("%s: %s\n", 
msg
, 
addr_°r
))

	)

87 
	#TFW_ERR_ADDR
(
msg
, 
addr_±r
) \

88 
	`TFW_WITH_ADDR_FMT
(
addr_±r
, 
addr_°r
, \

89 
	`T_ERR
("%s: %s\n", 
msg
, 
addr_°r
))

	)

90 
	#TFW_ERR_ADDR6
(
msg
, 
addr_±r
) \

91 
	`TFW_WITH_ADDR6_FMT
(
addr_±r
, 
addr_°r
, \

92 
	`T_ERR
("%s: %s\n", 
msg
, 
addr_°r
))

	)

	@main.c

21 
	~<löux/ty≥s.h
>

22 
	~<asm/Âu/≠i.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/moduÀ.h
>

25 
	~<√t/√t_«me•a˚.h
>

27 
	~"ãm≥°a_fw.h
"

28 
	~"cfg.h
"

29 
	~"log.h
"

30 
	~"°r.h
"

31 
	~"sync_sockë.h
"

32 
	~"£rvî.h
"

33 
	~"vho°.h
"

35 
MODULE_AUTHOR
(
TFW_AUTHOR
);

36 
MODULE_DESCRIPTION
(
TFW_NAME
);

37 
MODULE_VERSION
(
TFW_VERSION
);

38 
MODULE_LICENSE
("GPL");

40 (*
	texô_‚
)();

41 
exô_‚
 
exô_hooks
[32];

42 
size_t
 
exô_hooks_n
;

44 
	`DEFINE_MUTEX
(
tfw_sys˘l_mtx
);

45 
boﬁ
 
tfw_°¨ãd
 = 
Ál£
;

46 
boﬁ
 
tfw_ªc⁄fig
 = 
Ál£
;

52 
	`LIST_HEAD
(
tfw_mods
);

53 
	`DEFINE_RWLOCK
(
tfw_mods_lock
);

58 
boﬁ


59 
	$tfw_run°©e_is_ªc⁄fig
()

61  
	`READ_ONCE
(
tfw_ªc⁄fig
);

62 
	}
}

63 
EXPORT_SYMBOL
(
tfw_run°©e_is_ªc⁄fig
);

72 
	$tfw_mod_ªgi°î
(
TfwMod
 *
mod
)

74 
	`BUG_ON
(!
mod
 || !mod->
«me
);

75 
	`TFW_DBG2
("%s: %s\n", 
__func__
, 
mod
->
«me
);

77 
	`wrôe_lock
(&
tfw_mods_lock
);

78 
	`INIT_LIST_HEAD
(&
mod
->
li°
);

79 
	`li°_add_èû
(&
mod
->
li°
, &
tfw_mods
);

80 
	`wrôe_u∆ock
(&
tfw_mods_lock
);

81 
	}
}

82 
EXPORT_SYMBOL
(
tfw_mod_ªgi°î
);

88 
	$tfw_mod_uƒegi°î
(
TfwMod
 *
mod
)

90 
	`BUG_ON
(!
mod
 || !mod->
«me
);

91 
	`TFW_DBG2
("%s: %s\n", 
__func__
, 
mod
->
«me
);

93 
	`wrôe_lock
(&
tfw_mods_lock
);

94 
	`li°_dñ
(&
mod
->
li°
);

95 
	`wrôe_u∆ock
(&
tfw_mods_lock
);

96 
	}
}

97 
EXPORT_SYMBOL
(
tfw_mod_uƒegi°î
);

99 
TfwMod
 *

100 
	$tfw_mod_föd
(c⁄° *
«me
)

102 
TfwMod
 *
mod
;

104 
	`ªad_lock
(&
tfw_mods_lock
);

105 
	`li°_f‹_óch_íåy
(
mod
, &
tfw_mods
, 
li°
) {

106 i‡(!
«me
 || !
	`°rˇ£cmp
“ame, 
mod
->name)) {

107 
	`ªad_u∆ock
(&
tfw_mods_lock
);

108  
mod
;

111 
	`ªad_u∆ock
(&
tfw_mods_lock
);

113  
NULL
;

114 
	}
}

116 
ölöe
 

117 
	$tfw_˛ónup
(
li°_hód
 *
mod_li°
)

123 i‡(!
	`tfw_run°©e_is_ªc⁄fig
())

124 
	`ss_synchr⁄ize
();

126 
	`tfw_cfg_˛ónup
(
mod_li°
);

128 i‡(!
	`tfw_run°©e_is_ªc⁄fig
())

129 
	`tfw_sg_waô_ªÀa£
();

130 
	`TFW_LOG
("New configuration is cleaned.\n");

131 
	}
}

133 
ölöe
 

134 
	$tfw_mods_°›
(
li°_hód
 *
mod_li°
)

136 
TfwMod
 *
mod
;

138 
	`ss_°›
();

140 
	`TFW_LOG
("Stoppingáll modules...\n");

141 
	`MOD_FOR_EACH_REVERSE
(
mod
, 
mod_li°
) {

142 
	`TFW_DBG2
("mod_°›(): %s\n", 
mod
->
«me
);

143 i‡(
mod
->
°›
)

144 
mod
->
	`°›
();

147 
	`TFW_LOG
("modulesáre stopped\n");

148 
	}
}

151 
	$tfw_°›
(
li°_hód
 *
mod_li°
)

153 
	`tfw_mods_°›
(
mod_li°
);

154 
	`tfw_˛ónup
(
mod_li°
);

155 
	}
}

158 
	$tfw_mods_cfg°¨t
(
li°_hód
 *
mod_li°
)

160 
ªt
;

161 
TfwMod
 *
mod
;

163 
	`TFW_DBG2
("PrepareÅhe configurationÖrocessing...\n");

164 
	`MOD_FOR_EACH
(
mod
, 
mod_li°
) {

165 i‡(!
mod
->
cfg°¨t
)

167 
	`TFW_DBG2
("mod_cfg°¨t(): %s\n", 
mod
->
«me
);

168 i‡((
ªt
 = 
mod
->
	`cfg°¨t
())) {

169 
	`TFW_ERR_NL
("UnableÅoÖrepare forÅhe configuration "

170 "o‡moduÀ '%s': %d\n", 
mod
->
«me
, 
ªt
);

171  
ªt
;

174 
	`TFW_LOG
("Prepearing forÅhe configurationÖrocessing.\n");

177 
	}
}

180 
	$tfw_mods_°¨t
(
li°_hód
 *
mod_li°
)

182 
ªt
;

183 
TfwMod
 *
mod
;

185 
	`TFW_DBG2
("starting modules...\n");

186 
	`MOD_FOR_EACH
(
mod
, 
mod_li°
) {

187 i‡(!
mod
->
°¨t
)

189 
	`TFW_DBG2
("mod_°¨t(): %s\n", 
mod
->
«me
);

190 i‡((
ªt
 = 
mod
->
	`°¨t
())) {

191 
	`TFW_ERR_NL
("UnableÅo start module '%s': %d\n",

192 
mod
->
«me
, 
ªt
);

193  
ªt
;

196 
	`TFW_LOG
("modulesáre started\n");

199 
	}
}

202 
	$tfw_mods_cfgíd
(
li°_hód
 *
mod_li°
)

204 
ªt
;

205 
TfwMod
 *
mod
;

207 
	`TFW_DBG2
("CompletingÅhe configurationÖrocessing...\n");

208 
	`MOD_FOR_EACH
(
mod
, 
mod_li°
) {

209 i‡(!
mod
->
cfgíd
)

211 
	`TFW_DBG2
("mod_cfgíd(): %s\n", 
mod
->
«me
);

212 i‡((
ªt
 = 
mod
->
	`cfgíd
())) {

213 
	`TFW_ERR_NL
("UnableÅo completeÅhe configuration "

214 "o‡moduÀ '%s': %d\n", 
mod
->
«me
, 
ªt
);

215  
ªt
;

218 
	`TFW_LOG
("ConfigurationÖrocessing is completed.\n");

221 
	}
}

224 
	$tfw_°¨t
(
li°_hód
 *
mod_li°
)

226 
ªt
;

228 
	`ss_°¨t
();

229 i‡((
ªt
 = 
	`tfw_mods_cfg°¨t
(
mod_li°
)))

230 
˛ónup
;

231 i‡((
ªt
 = 
	`tfw_cfg_∑r£
(
mod_li°
)))

232 
˛ónup
;

233 i‡((
ªt
 = 
	`tfw_mods_cfgíd
(
mod_li°
)))

234 
˛ónup
;

235 i‡((
ªt
 = 
	`tfw_mods_°¨t
(
mod_li°
)))

236 
°›_mods
;

237 
	`tfw_cfg_c⁄˛ude
(
mod_li°
);

238 
	`WRITE_ONCE
(
tfw_°¨ãd
, 
åue
);

240 
°›_mods
:

246 
	`WRITE_ONCE
(
tfw_ªc⁄fig
, 
Ál£
);

247 
	`tfw_mods_°›
(
mod_li°
);

248 
	`WRITE_ONCE
(
tfw_°¨ãd
, 
Ál£
);

249 
˛ónup
:

250 
	`TFW_WARN_NL
("ConfigurationÖarsing has failed. Clean up...\n");

251 
	`tfw_˛ónup
(
mod_li°
);

252  
ªt
;

253 
	}
}

260 
	$tfw_˘l‚_°©e_ch™ge
(c⁄° *
ﬁd_°©e
, c⁄° *
√w_°©e
)

262 
	`TFW_DBG2
("gŸ sèã vü sys˘l: %s\n", 
√w_°©e
);

264 i‡(!
	`°rˇ£cmp
("°¨t", 
√w_°©e
)) {

265 
r
;

267 i‡(
	`READ_ONCE
(
tfw_°¨ãd
)) {

268 
	`WRITE_ONCE
(
tfw_ªc⁄fig
, 
åue
);

269 
	`TFW_LOG
("LiveÑeconfiguration of Tempesta.\n");

272 
r
 = 
	`tfw_°¨t
(&
tfw_mods
);

273 
	`WRITE_ONCE
(
tfw_ªc⁄fig
, 
Ál£
);

275  
r
;

278 i‡(!
	`°rˇ£cmp
("°›", 
√w_°©e
)) {

279 i‡(!
	`READ_ONCE
(
tfw_°¨ãd
)) {

280 
	`TFW_WARN_NL
("TryingÅo stopán inactive system\n");

281  -
EINVAL
;

284 
	`tfw_°›
(&
tfw_mods
);

285 
	`WRITE_ONCE
(
tfw_°¨ãd
, 
Ál£
);

290 
	`TFW_ERR_NL
("invalid state: '%s'. Should beÉither 'start' or 'stop'\n",

291 
√w_°©e
);

293  -
EINVAL
;

294 
	}
}

300 
	$tfw_˘l‚_°©e_io
(
˘l_èbÀ
 *
˘l
, 
is_wrôe
,

301 
__u£r
 *
u£r_buf
, 
size_t
 *
À≈
, 
loff_t
 *
µos
)

303 
r
 = 0;

305 
	`muãx_lock
(&
tfw_sys˘l_mtx
);

307 i‡(
is_wrôe
) {

308 
√w_°©e_buf
[
˘l
->
maxÀn
];

309 *
√w_°©e
, *
ﬁd_°©e
;

310 
size_t
 
c›õd_d©a_Àn
;

312 
c›õd_d©a_Àn
 = 
	`mö
((
size_t
)
˘l
->
maxÀn
, *
À≈
);

313 
r
 = 
	`°∫˝y_‰om_u£r
(
√w_°©e_buf
, 
u£r_buf
, 
c›õd_d©a_Àn
);

314 i‡(
r
 < 0)

315 
out
;

317 
√w_°©e_buf
[
r
] = 0;

318 
√w_°©e
 = 
	`°rim
(
√w_°©e_buf
);

319 
ﬁd_°©e
 = 
˘l
->
d©a
;

321 
r
 = 
	`tfw_˘l‚_°©e_ch™ge
(
ﬁd_°©e
, 
√w_°©e
);

322 i‡(
r
)

323 
out
;

326 
r
 = 
	`¥oc_do°rög
(
˘l
, 
is_wrôe
, 
u£r_buf
, 
À≈
, 
µos
);

327 
out
:

328 
	`muãx_u∆ock
(&
tfw_sys˘l_mtx
);

329  
r
;

330 
	}
}

332 
	gtfw_sys˘l_°©e_buf
[32];

333 
˘l_èbÀ_hódî
 *
	gtfw_sys˘l_hdr
;

334 
˘l_èbÀ
 
	gtfw_sys˘l_tbl
[] = {

336 .
¥o˙ame
 = "state",

337 .
	gd©a
 = 
tfw_sys˘l_°©e_buf
,

338 .
	gmaxÀn
 = (
tfw_sys˘l_°©e_buf
) - 1,

339 .
	gmode
 = 0644,

340 .
	g¥oc_h™dÀr
 = 
tfw_˘l‚_°©e_io
,

345 
	#DO_INIT
(
mod
) \

347 
tfw_
##
mod
##
	`_öô
(); \

348 
tfw_
##
mod
##
	`_exô
(); \

349 
	`BUG_ON
(
exô_hooks_n
 >
	`ARRAY_SIZE
(
exô_hooks
)); \

350 
	`TFW_DBG
("init: %s\n", #mod); \

351 
r
 = 
tfw_
##
mod
##
	`_öô
(); \

352 i‡(
r
) { \

353 
	`TFW_ERR_NL
("can't initialize Tempesta FW module: '%s' (%d)\n", \

354 #mod, 
r
); \

355 
îr
; \

357 
exô_hooks
[
exô_hooks_n
++] = 
tfw_
##
mod
##
_exô
; \

358 } 0)

	)

361 
	$tfw_exô
()

363 
i
;

365 
	`TFW_LOG
("exiting...\n");

368 
	`rcu_b¨rõr_bh
();

370 
i
 = 
exô_hooks_n
 - 1; i >= 0; --i)

371 
exô_hooks
[
i
]();

373 
	`uƒegi°î_√t_sys˘l_èbÀ
(
tfw_sys˘l_hdr
);

374 
	}
}

376 
__öô


377 
	$tfw_öô
()

379 
r
;

382 
	`kî√l_Âu_begö
();

383 
	`tfw_°r_öô_c⁄°
();

384 
	`kî√l_Âu_íd
();

386 
	`TFW_LOG
("Initializing Tempesta FW kernel module...\n");

388 
tfw_sys˘l_hdr
 = 
	`ªgi°î_√t_sys˘l
(&
öô_√t
, "net/tempesta",

389 
tfw_sys˘l_tbl
);

390 i‡(!
tfw_sys˘l_hdr
) {

391 
	`TFW_ERR_NL
("can'tÑegister sysctlÅable\n");

396 
	`DO_INIT
(
poﬁ
);

397 
	`DO_INIT
(
cfg
);

398 
	`DO_INIT
(
≠m
);

399 
	`DO_INIT
(
vho°
);

405 
	`DO_INIT
(
és
);

406 
	`DO_INIT
(
hâp
);

407 
	`DO_INIT
(
hâp_limôs
);

408 
	`DO_INIT
(
fûãr
);

409 
	`DO_INIT
(
ˇche
);

410 
	`DO_INIT
(
hâp_£ss
);

412 
	`DO_INIT
(
sync_sockë
);

413 
	`DO_INIT
(
£rvî
);

414 
	`DO_INIT
(
˛õ¡
);

415 
	`DO_INIT
(
sock_§v
);

416 
	`DO_INIT
(
sock_˛¡
);

417 
	`DO_INIT
(
¥ocfs
);

418 
	`DO_INIT
(
hâp_tbl
);

419 
	`DO_INIT
(
sched_hash
);

420 
	`DO_INIT
(
sched_øtio
);

423 
îr
:

424 
	`tfw_exô
();

425  
r
;

426 
	}
}

428 
moduÀ_öô
(
tfw_öô
);

429 
moduÀ_exô
(
tfw_exô
);

	@msg.c

20 
	~"lib/°r.h
"

21 
	~"msg.h
"

35 
	$tfw_msg_wrôe
(
TfwMsgIãr
 *
ô
, c⁄° 
TfwSå
 *
d©a
)

37 *
p
;

38 c⁄° 
TfwSå
 *
c
, *
íd
;

39 
skb_‰ag_t
 *
‰ag
;

40 
c_off
 = 0, 
f_size
, 
c_size
, 
f_room
, 
n_c›y
;

42 
	`BUG_ON
(
	`TFW_STR_DUP
(
d©a
));

43 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
d©a
, 
íd
) {

44 
this_chunk
:

45 i‡(!
‰ag
)

46  -
E2BIG
;

48 
c_size
 = 
c
->
Àn
 - 
c_off
;

49 i‡(
ô
->
‰ag
 >= 0) {

50 
‰ag
 = &
	`skb_shöfo
(
ô
->
skb
)->
‰ags
[it->frag];

51 
f_size
 = 
	`skb_‰ag_size
(
‰ag
);

52 
f_room
 = 
PAGE_SIZE
 - 
‰ag
->
∑ge_off£t
 - 
f_size
;

53 
p
 = (*)
	`skb_‰ag_addªss
(
‰ag
Ë+ 
f_size
;

54 
n_c›y
 = 
	`mö
(
c_size
, 
f_room
);

55 
	`skb_‰ag_size_add
(
‰ag
, 
n_c›y
);

56 
	`ss_skb_adju°_d©a_Àn
(
ô
->
skb
, 
n_c›y
);

58 
f_room
 = 
	`skb_èûroom
(
ô
->
skb
);

59 
n_c›y
 = 
	`mö
(
c_size
, 
f_room
);

60 
p
 = 
	`skb_put
(
ô
->
skb
, 
n_c›y
);

63 
	`mem˝y_Á°
(
p
, (*)
c
->
±r
 + 
c_off
, 
n_c›y
);

65 i‡(
c_size
 < 
f_room
) {

71 
c_off
 = 0;

73 
‰ag
 = 
	`ss_skb_‰ag_√xt
(&
ô
->
skb
, it->
skb_hód
,

74 &
ô
->
‰ag
);

80 i‡(
c_size
 =
f_room
) {

81 
c_off
 = 0;

83 
c_off
 +
n_c›y
;

84 
this_chunk
;

90 
	}
}

91 
EXPORT_SYMBOL
(
tfw_msg_wrôe
);

94 
	$tfw_msg_ôî_£tup
(
TfwMsgIãr
 *
ô
, 
sk_buff
 **
skb_hód
, 
size_t
 
d©a_Àn
)

96 
r
;

98 i‡((
r
 = 
	`ss_skb_Æloc_d©a
(
skb_hód
, 
d©a_Àn
)))

99  
r
;

100 
ô
->
skb
 = it->
skb_hód
 = *skb_head;

101 
ô
->
‰ag
 = 
d©a_Àn
 ? -1 : 0;

103 
	`BUG_ON
(!
ô
->
skb
);

106 
	}
}

	@msg.h

23 #i‚de‡
__TFW_MSG_H__


24 
	#__TFW_MSG_H__


	)

26 
	~<löux/skbuff.h
>

28 
	~"sync_sockë.h
"

45 
li°_hód
 
	m£q_li°
;

46 
sk_buff
 *
	mskb_hód
;

47 
	mss_Êags
;

48 
size_t
 
	mÀn
;

49 } 
	tTfwMsg
;

59 
	m‰ag
;

60 
sk_buff
 *
	mskb
;

61 
sk_buff
 *
	mskb_hód
;

62 } 
	tTfwMsgIãr
;

64 
tfw_msg_wrôe
(
TfwMsgIãr
 *
ô
, c⁄° 
TfwSå
 *
d©a
);

65 
tfw_msg_ôî_£tup
(
TfwMsgIãr
 *
ô
, 
sk_buff
 **
skb_hód
,

66 
size_t
 
d©a_Àn
);

	@peer.h

20 #i‚de‡
__PEER_H__


21 
	#__PEER_H__


	)

23 
	~<löux/li°.h
>

24 
	~<löux/•ölock.h
>

26 
	~"addr.h
"

33 
	#TFW_PEER_COMMON
 \

34 
li°_hód
 
c⁄n_li°
; \

35 
•ölock_t
 
c⁄n_lock
; \

36 
TfwAddr
 
addr
;

	)

39 
	mTFW_PEER_COMMON
;

40 } 
	tTfwPìr
;

42 
ölöe
 

43 
	$tfw_≥î_öô
(
TfwPìr
 *
p
, c⁄° 
TfwAddr
 *
addr
)

45 
	`INIT_LIST_HEAD
(&
p
->
c⁄n_li°
);

46 
	`•ö_lock_öô
(&
p
->
c⁄n_lock
);

48 
	`mem˝y
(&
p
->
addr
,áddr, (p->addr));

49 
	}
}

51 
ölöe
 

52 
	$tfw_≥î_add_c⁄n
(
TfwPìr
 *
p
, 
li°_hód
 *
c⁄n_li°
)

54 
	`•ö_lock_bh
(&
p
->
c⁄n_lock
);

56 
	`li°_add
(
c⁄n_li°
, &
p
->conn_list);

58 
	`•ö_u∆ock_bh
(&
p
->
c⁄n_lock
);

59 
	}
}

61 
ölöe
 

62 
	$tfw_≥î_dñ_c⁄n
(
TfwPìr
 *
p
, 
li°_hód
 *
c⁄n_li°
)

64 
	`•ö_lock_bh
(&
p
->
c⁄n_lock
);

66 
	`li°_dñ_öô
(
c⁄n_li°
);

68 
	`•ö_u∆ock_bh
(&
p
->
c⁄n_lock
);

69 
	}
}

71 
	#tfw_≥î_f‹_óch_c⁄n
(
p
, 
c⁄n
, 
membî
, 
cb
) \

73 
r
 = 0; \

74 
	`•ö_lock_bh
(&(
p
)->
c⁄n_lock
); \

75 
	`li°_f‹_óch_íåy
(
c⁄n
, &(
p
)->
c⁄n_li°
, 
membî
) { \

76 
r
 = (
cb
)(
c⁄n
); \

77 i‡(
	`u∆ikñy
((
r
))) \

80 
	`•ö_u∆ock_bh
(&(
p
)->
c⁄n_lock
); \

81 
r
; \

82 })

	)

	@pool.c

44 
	~<löux/gÂ.h
>

46 
	~"lib/°r.h
"

47 
	~"poﬁ.h
"

49 
	#TFW_POOL_CHUNK_SZ
(
p
Ë(
PAGE_SIZE
 << (p)->
‹dî
)

	)

50 
	#TFW_POOL_CHUNK_BASE
(
c
Ë(()(cË& 
PAGE_MASK
)

	)

51 
	#TFW_POOL_CHUNK_END
(
p
Ë(
	`TFW_POOL_CHUNK_BASE
(’)->
cuº
Ë+ (p)->
off
)

	)

52 
	#TFW_POOL_ALIGN_SZ
(
n
Ë((“Ë+ 7Ë& ~7UL)

	)

53 
	#TFW_POOL_HEAD_OFF
 (
	`TFW_POOL_ALIGN_SZ
((
TfwPoﬁ
)) \

54 + 
	`TFW_POOL_ALIGN_SZ
((
TfwPoﬁChunk
)))

	)

55 
	#TFW_POOL_PGCACHE_SZ
 512

	)

57 
DEFINE_PER_CPU
(, 
pg_√xt
);

58 
__≥r˝u
 (*
pg_ˇche
)[
TFW_POOL_PGCACHE_SZ
];

74 
	$tfw_poﬁ_Æloc_∑ges
(
‹dî
)

76 *
pgn
;

77 
pg_ªs
;

79 
	`¥ìm±_dißbÀ
();

81 
pgn
 = 
	`this_˝u_±r
(&
pg_√xt
);

83 i‡(
	`likñy
(*
pgn
 && !
‹dî
)) {

84 --*
pgn
;

85 
pg_ªs
 = ((*)
	`this_˝u_±r
(
pg_ˇche
))[*
pgn
];

87 
	`¥ìm±_íabÀ
();

89  
pg_ªs
;

91 
	`¥ìm±_íabÀ
();

93  
	`__gë_‰ì_∑ges
(
GFP_ATOMIC
, 
‹dî
);

94 
	}
}

97 
	$tfw_poﬁ_‰ì_∑ges
(
addr
, 
‹dî
)

99 *
pgn
;

101 
	`¥ìm±_dißbÀ
();

103 
pgn
 = 
	`this_˝u_±r
(&
pg_√xt
);

105 i‡(
	`likñy
(*
pgn
 < 
TFW_POOL_PGCACHE_SZ
 && !
‹dî
)) {

106 ((*)
	`this_˝u_±r
(
pg_ˇche
))[*
pgn
] = 
addr
;

107 ++*
pgn
;

109 
	`¥ìm±_íabÀ
();

113 
	`¥ìm±_íabÀ
();

115 
	`‰ì_∑ges
(
addr
, 
‹dî
);

116 
	}
}

119 
	$tfw_poﬁ_Æloc
(
TfwPoﬁ
 *
p
, 
size_t
 
n
)

121 *
a
;

123 
n
 = 
	`TFW_POOL_ALIGN_SZ
(n);

125 i‡(
	`u∆ikñy
(
p
->
off
 + 
n
 > 
	`TFW_POOL_CHUNK_SZ
(p))) {

126 
TfwPoﬁChunk
 *
c
, *
cuº
 = 
p
->curr;

127 
off
 = 
	`TFW_POOL_ALIGN_SZ
((
TfwPoﬁChunk
)Ë+ 
n
;

128 
‹dî
 = 
	`gë_‹dî
(
off
);

130 
c
 = (
TfwPoﬁChunk
 *)
	`tfw_poﬁ_Æloc_∑ges
(
‹dî
);

131 i‡(!
c
)

132  
NULL
;

133 
c
->
√xt
 = 
cuº
;

134 
c
->
‹dî
 = order;

136 
cuº
->
off
 = 
p
->off;

138 
p
->
‹dî
 = order;

139 
p
->
off
 = off;

140 
p
->
cuº
 = 
c
;

142  (*)
	`TFW_POOL_ALIGN_SZ
(()(
c
 + 1));

145 
a
 = (*)
	`TFW_POOL_CHUNK_END
(
p
);

146 
p
->
off
 +
n
;

148  
a
;

149 
	}
}

150 
EXPORT_SYMBOL
(
tfw_poﬁ_Æloc
);

153 
	$tfw_poﬁ_ªÆloc
(
TfwPoﬁ
 *
p
, *
±r
, 
size_t
 
ﬁd_n
, size_à
√w_n
)

155 *
a
;

157 
	`BUG_ON
(
√w_n
 < 
ﬁd_n
);

159 
ﬁd_n
 = 
	`TFW_POOL_ALIGN_SZ
(old_n);

160 
√w_n
 = 
	`TFW_POOL_ALIGN_SZ
(new_n);

162 i‡((*)
±r
 + 
ﬁd_n
 =(*)
	`TFW_POOL_CHUNK_END
(
p
)

163 && 
p
->
off
 - 
ﬁd_n
 + 
√w_n
 <
	`TFW_POOL_CHUNK_SZ
(p))

165 
p
->
off
 +
√w_n
 - 
ﬁd_n
;

166  
±r
;

169 
a
 = 
	`tfw_poﬁ_Æloc
(
p
, 
√w_n
);

170 i‡(
	`likñy
(
a
))

171 
	`mem˝y_Á°
(
a
, 
±r
, 
ﬁd_n
);

173  
a
;

174 
	}
}

175 
EXPORT_SYMBOL
(
tfw_poﬁ_ªÆloc
);

183 
	$tfw_poﬁ_‰ì
(
TfwPoﬁ
 *
p
, *
±r
, 
size_t
 
n
)

185 
n
 = 
	`TFW_POOL_ALIGN_SZ
(n);

188 i‡(
	`u∆ikñy
((*)
±r
 + 
n
 !(*)
	`TFW_POOL_CHUNK_END
(
p
)))

191 
p
->
off
 -
n
;

194 i‡(
	`u∆ikñy
(
p
->
off
 =
	`TFW_POOL_ALIGN_SZ
((
TfwPoﬁChunk
)))) {

195 
TfwPoﬁChunk
 *
√xt
 = 
p
->
cuº
->next;

196 
	`tfw_poﬁ_‰ì_∑ges
(
	`TFW_POOL_CHUNK_BASE
(
p
->
cuº
),Ö->
‹dî
);

197 
p
->
cuº
 = 
√xt
;

198 
p
->
‹dî
 = 
√xt
->order;

199 
p
->
off
 = 
√xt
->off;

201 
	}
}

202 
EXPORT_SYMBOL
(
tfw_poﬁ_‰ì
);

207 
TfwPoﬁ
 *

208 
	$__tfw_poﬁ_√w
(
size_t
 
n
)

210 
TfwPoﬁ
 *
p
;

211 
TfwPoﬁChunk
 *
c
;

212 
‹dî
;

214 
‹dî
 = 
	`gë_‹dî
(
	`TFW_POOL_ALIGN_SZ
(
n
Ë+ 
TFW_POOL_HEAD_OFF
);

216 
c
 = (
TfwPoﬁChunk
 *)
	`tfw_poﬁ_Æloc_∑ges
(
‹dî
);

217 i‡(
	`u∆ikñy
(!
c
))

218  
NULL
;

220 
p
 = (
TfwPoﬁ
 *)((*)
c
 + 
	`TFW_POOL_ALIGN_SZ
((*c)));

222 
c
->
√xt
 = 
NULL
;

223 
p
->
‹dî
 = 
c
->order = order;

224 
p
->
off
 = 
c
->of‡
TFW_POOL_HEAD_OFF
;

225 
p
->
cuº
 = 
c
;

227  
p
;

228 
	}
}

229 
EXPORT_SYMBOL
(
__tfw_poﬁ_√w
);

232 
	$tfw_poﬁ_de°roy
(
TfwPoﬁ
 *
p
)

234 
TfwPoﬁChunk
 *
c
, *
√xt
;

236 i‡(!
p
)

239 
c
 = 
p
->
cuº
; c; c = 
√xt
) {

240 
√xt
 = 
c
->next;

241 
	`tfw_poﬁ_‰ì_∑ges
(
	`TFW_POOL_CHUNK_BASE
(
c
), c->
‹dî
);

243 
	}
}

244 
EXPORT_SYMBOL
(
tfw_poﬁ_de°roy
);

247 
	$tfw_poﬁ_öô
()

249 
pg_ˇche
 = 
	`Æloc_≥r˝u
([
TFW_POOL_PGCACHE_SZ
]);

250 i‡(
pg_ˇche
 =
NULL
)

251  -
ENOMEM
;

253 
	}
}

256 
	$tfw_poﬁ_exô
()

258 
i
;

260 
	`f‹_óch_⁄löe_˝u
(
i
) {

261 
pgn
 = 
	`≥r_˝u
(
pg_√xt
, 
i
);

262 *
pgc
 = (*)
	`≥r_˝u_±r
(
pg_ˇche
, 
i
);

263 
pgn
--)

264 
	`‰ì_∑ge
(
pgc
[
pgn
]);

267 
	`‰ì_≥r˝u
(
pg_ˇche
);

268 
	}
}

	@pool.h

23 #i‚de‡
__TFW_POOL_H__


24 
	#__TFW_POOL_H__


	)

26 
	~<löux/ˇche.h
>

27 
	~"log.h
"

29 
	#TFW_POOL_ZERO
 0x1

	)

38 
	stfw_poﬁ_chunk_t
 {

39 
tfw_poﬁ_chunk_t
 *
	m√xt
;

40 
	m‹dî
;

41 
	moff
;

42 } 
	tTfwPoﬁChunk
;

51 
TfwPoﬁChunk
 *
	mcuº
;

52 
	m‹dî
;

53 
	moff
;

54 } 
	tTfwPoﬁ
;

56 
	#tfw_poﬁ_√w
(
°ru˘_«me
, 
mask
) \

58 
°ru˘_«me
 *
s
 = 
NULL
; \

59 
TfwPoﬁ
 *
p
 = 
	`__tfw_poﬁ_√w
((
°ru˘_«me
)); \

60 i‡(
	`likñy
(
p
)) { \

61 
s
 = 
	`tfw_poﬁ_Æloc
(
p
, (
°ru˘_«me
)); \

62 
	`BUG_ON
(!
s
); \

63 i‡(
mask
 & 
TFW_POOL_ZERO
) \

64 
	`mem£t
(
s
, 0, (
°ru˘_«me
)); \

65 
s
->
poﬁ
 = 
p
; \

67 
	`TFW_ERR
("Can'tállocÇew " #struct_name); \

69 
s
; \

70 })

	)

72 
TfwPoﬁ
 *
__tfw_poﬁ_√w
(
size_t
 
n
);

73 *
tfw_poﬁ_Æloc
(
TfwPoﬁ
 *
p
, 
size_t
 
n
);

74 *
tfw_poﬁ_ªÆloc
(
TfwPoﬁ
 *
p
, *
±r
, 
size_t
 
ﬁd_n
, size_à
√w_n
);

75 
tfw_poﬁ_‰ì
(
TfwPoﬁ
 *
p
, *
±r
, 
size_t
 
n
);

76 
tfw_poﬁ_de°roy
(
TfwPoﬁ
 *
p
);

	@procfs.c

20 
	~<löux/¥oc_fs.h
>

21 
	~<löux/£q_fûe.h
>

23 
	~"≠m.h
"

24 
	~"£rvî.h
"

25 
	~"¥ocfs.h
"

30 
DEFINE_PER_CPU_ALIGNED
(
TfwPîfSèt
, 
tfw_≥rf°©
);

33 
	$tfw_≥rf°©_cﬁÀ˘
(
TfwPîfSèt
 *
°©
)

35 
	#SADD
(
x
Ë
°©
->x +
p˝_°©
->
	)
x

37 
˝u
;

44 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

45 
TfwPîfSèt
 *
p˝_°©
 = 
	`≥r_˝u_±r
(&
tfw_≥rf°©
, 
˝u
);

48 
	`SADD
(
ss
.
pÊ_hôs
);

49 
	`SADD
(
ss
.
pÊ_mis£s
);

50 
	`SADD
(
ss
.
wq_fuŒ
);

53 
	`SADD
(
ˇche
.
hôs
);

54 
	`SADD
(
ˇche
.
mis£s
);

57 
	`SADD
(
˛¡
.
rx_mesßges
);

58 
	`SADD
(
˛¡
.
msgs_f‹w¨ded
);

59 
	`SADD
(
˛¡
.
msgs_‰omˇche
);

60 
	`SADD
(
˛¡
.
msgs_∑r£º
);

61 
	`SADD
(
˛¡
.
msgs_fûtout
);

62 
	`SADD
(
˛¡
.
msgs_Ÿhîr
);

63 
	`SADD
(
˛¡
.
⁄löe
);

64 
	`SADD
(
˛¡
.
c⁄n_©ãm±s
);

65 
	`SADD
(
˛¡
.
c⁄n_disc⁄√˘s
);

66 
	`SADD
(
˛¡
.
c⁄n_e°ablished
);

67 
	`SADD
(
˛¡
.
rx_byãs
);

70 
	`SADD
(
£rv
.
rx_mesßges
);

71 
	`SADD
(
£rv
.
msgs_f‹w¨ded
);

72 
	`SADD
(
£rv
.
msgs_∑r£º
);

73 
	`SADD
(
£rv
.
msgs_fûtout
);

74 
	`SADD
(
£rv
.
msgs_Ÿhîr
);

75 
	`SADD
(
£rv
.
c⁄n_©ãm±s
);

76 
	`SADD
(
£rv
.
c⁄n_disc⁄√˘s
);

77 
	`SADD
(
£rv
.
c⁄n_e°ablished
);

78 
	`SADD
(
£rv
.
c⁄n_ª°ri˘ed
);

79 
	`SADD
(
£rv
.
rx_byãs
);

81 #unde‡
SADD


82 
	}
}

85 
	$tfw_≥rf°©_£q_show
(
£q_fûe
 *
£q
, *
off
)

87 
	#SPRNE
(
m
, 
e
Ë
	`£q_¥ötf
(
£q
, m": %Œu\n",É)

	)

88 
	#SPRN
(
m
, 
c
Ë
	`£q_¥ötf
(
£q
, m": %Œu\n", 
°©
.c)

	)

90 
TfwPîfSèt
 
°©
;

91 
u64
 
£rv_c⁄n_a˘ive
, 
£rv_c⁄n_sched
;

92 
SsSèt
 *
ss_°©
 = 
	`kmÆloc
((SsSètË* 
	`num_⁄löe_˝us
(),

93 
GFP_KERNEL
);

94 i‡(!
ss_°©
)

95 
	`TFW_WARN
("Cannotállocate sync sockets statistics\n");

97 
	`mem£t
(&
°©
, 0, (stat));

98 
	`tfw_≥rf°©_cﬁÀ˘
(&
°©
);

101 
	`SPRN
("SSÖÊ hôs\t\t\t\t", 
ss
.
pÊ_hôs
);

102 
	`SPRN
("SSÖÊ mis£s\t\t\t\t", 
ss
.
pÊ_mis£s
);

103 
	`SPRN
("SS w‹k queuêfuŒ\t\t\t", 
ss
.
wq_fuŒ
);

104 i‡(
ss_°©
) {

105 
˝u
;

107 
	`ss_gë_°©
(
ss_°©
);

108 
	`£q_¥ötf
(
£q
, "SS work queues' sizes\t\t\t:");

109 
	`f‹_óch_⁄löe_˝u
(
˝u
)

110 
	`£q_¥ötf
(
£q
, " %u", 
ss_°©
[
˝u
].
rb_wq_sz
);

111 
	`£q_¥ötf
(
£q
, "\nSS backlog's sizes\t\t\t:");

112 
	`f‹_óch_⁄löe_˝u
(
˝u
)

113 
	`£q_¥ötf
(
£q
, " %u", 
ss_°©
[
˝u
].
backlog_sz
);

114 
	`£q_¥ötf
(
£q
, "\n");

115 
	`k‰ì
(
ss_°©
);

117 
	`£q_¥ötf
(
£q
, "SS work queues' sizes\t\t\t:Ç/a\n");

118 
	`£q_¥ötf
(
£q
, "SS backlog's sizes\t\t\t:Ç/a\n");

122 
	`SPRN
("Cachêhôs\t\t\t\t", 
ˇche
.
hôs
);

123 
	`SPRN
("Cachêmis£s\t\t\t\t", 
ˇche
.
mis£s
);

126 
	`SPRN
("Clõ¡ mesßge†ª˚ived\t\t", 
˛¡
.
rx_mesßges
);

127 
	`SPRN
("Clõ¡ mesßge†f‹w¨ded\t\t", 
˛¡
.
msgs_f‹w¨ded
);

128 
	`SPRN
("Clõ¡ mesßge†£rved from cache\t", 
˛¡
.
msgs_‰omˇche
);

129 
	`SPRN
("Clõ¡ mesßge†∑rsögÉº‹s\t\t", 
˛¡
.
msgs_∑r£º
);

130 
	`SPRN
("Clõ¡ mesßge†fûãªd out\t\t", 
˛¡
.
msgs_fûtout
);

131 
	`SPRN
("Clõ¡ mesßge†ŸhîÉº‹s\t\t", 
˛¡
.
msgs_Ÿhîr
);

132 
	`SPRN
("Clõ¡†⁄löe\t\t\t\t", 
˛¡
.
⁄löe
);

133 
	`SPRN
("Clõ¡ c⁄√˘i⁄áâem±s\t\t", 
˛¡
.
c⁄n_©ãm±s
);

134 
	`SPRN
("Clõ¡É°ablished c⁄√˘i⁄s\t\t", 
˛¡
.
c⁄n_e°ablished
);

135 
	`SPRNE
("Client connectionsáctive\t\t",

136 
°©
.
˛¡
.
c⁄n_e°ablished
 - sèt.˛¡.
c⁄n_disc⁄√˘s
);

137 
	`SPRN
("Clõ¡ RX byãs\t\t\t\t", 
˛¡
.
rx_byãs
);

140 
£rv_c⁄n_a˘ive
 = 
°©
.
£rv
.
c⁄n_e°ablished


141 - 
°©
.
£rv
.
c⁄n_disc⁄√˘s
;

142 
£rv_c⁄n_sched
 = 
£rv_c⁄n_a˘ive
 - 
°©
.
£rv
.
c⁄n_ª°ri˘ed
;

144 
	`SPRN
("Sîvî mesßge†ª˚ived\t\t", 
£rv
.
rx_mesßges
);

145 
	`SPRN
("Sîvî mesßge†f‹w¨ded\t\t", 
£rv
.
msgs_f‹w¨ded
);

146 
	`SPRN
("Sîvî mesßge†∑rsögÉº‹s\t\t", 
£rv
.
msgs_∑r£º
);

147 
	`SPRN
("Sîvî mesßge†fûãªd out\t\t", 
£rv
.
msgs_fûtout
);

148 
	`SPRN
("Sîvî mesßge†ŸhîÉº‹s\t\t", 
£rv
.
msgs_Ÿhîr
);

149 
	`SPRN
("Sîvî c⁄√˘i⁄áâem±s\t\t", 
£rv
.
c⁄n_©ãm±s
);

150 
	`SPRN
("SîvîÉ°ablished c⁄√˘i⁄s\t\t", 
£rv
.
c⁄n_e°ablished
);

151 
	`SPRNE
("Sîvî c⁄√˘i⁄†a˘ive\t\t", 
£rv_c⁄n_a˘ive
);

152 
	`SPRNE
("Sîvî c⁄√˘i⁄†scheduœbÀ\t\t", 
£rv_c⁄n_sched
);

153 
	`SPRN
("Sîvî RX byãs\t\t\t\t", 
£rv
.
rx_byãs
);

156 #unde‡
SPRN


157 #unde‡
SPRNE


158 
	}
}

161 
	$tfw_≥rf°©_£q_›í
(
öode
 *öode, 
fûe
 *file)

163  
	`sögÀ_›í
(
fûe
, 
tfw_≥rf°©_£q_show
, 
	`PDE_DATA
(
öode
));

164 
	}
}

167 
	$tfw_§v°©s_£q_show
(
£q_fûe
 *
£q
, *
off
)

169 
	#SPRNE
(
m
, 
e
Ë
	`£q_¥ötf
(
£q
, m": %dms\n",É)

	)

171 
size_t
 
i
, 
rc
;

172 
TfwSrvC⁄n
 *
§v_c⁄n
;

173 
TfwSîvî
 *
§v
 = 
£q
->
¥iv©e
;

174 
qsize
[
§v
->
c⁄n_n
];

175 
boﬁ
 
hm
 = 
	`ã°_bô
(
TFW_SRV_B_HMONITOR
, &
§v
->
Êags
);

176 
vÆ
[
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)] = { 0 };

177 
TfwPr˙éSèts
 
p°©s
 = {

178 .
ôh
 = 
tfw_p°©s_ôh
,

179 .
vÆ
 = val,

180 .
psz
 = 
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)

183 
	`tfw_≠m_°©s_bh
(
§v
->
≠mªf
, &
p°©s
);

185 
	`SPRNE
("MöimÆÑe•⁄£Åime\t\t", 
p°©s
.
vÆ
[
TFW_PSTATS_IDX_MIN
]);

186 
	`SPRNE
("Avîagêª•⁄£Åime\t\t", 
p°©s
.
vÆ
[
TFW_PSTATS_IDX_AVG
]);

187 
	`SPRNE
("Medü¿Ñe•⁄£Åime\t\t", 
p°©s
.
vÆ
[
TFW_PSTATS_IDX_P50
]);

188 
	`SPRNE
("MaximumÑe•⁄£Åime\t\t", 
p°©s
.
vÆ
[
TFW_PSTATS_IDX_MAX
]);

190 
	`£q_¥ötf
(
£q
, "Percentiles\n");

191 
i
 = 
TFW_PSTATS_IDX_ITH
; i < 
	`ARRAY_SIZE
(
tfw_p°©s_ôh
); ++i)

192 
	`£q_¥ötf
(
£q
, "%02d%%:\t%dms\n",

193 
p°©s
.
ôh
[
i
],Ö°©s.
vÆ
[i]);

195 
i
 = 
rc
 = 0;

196 
	`li°_f‹_óch_íåy
(
§v_c⁄n
, &
§v
->
c⁄n_li°
, 
li°
) {

197 
qsize
[
i
++] = 
	`READ_ONCE
(
§v_c⁄n
->qsize);

198 i‡(
	`tfw_§v_c⁄n_ª°ri˘ed
(
§v_c⁄n
))

199 
rc
++;

202 #ifde‡
DEBUG


203 
	`£q_¥ötf
(
£q
, "References\t\t\t: %zd\n",

204 
	`©omic64_ªad
(&
§v
->
ªf˙t
));

206 
	`£q_¥ötf
(
£q
, "TotalÖinned sessions\t\t: %zd\n",

207 
	`©omic64_ªad
(&
§v
->
£ss_n
));

208 
	`£q_¥ötf
(
£q
, "Total schedulable connections\t: %zd\n",

209 
§v
->
c⁄n_n
 - 
rc
);

211 
	`£q_¥ötf
(
£q
, "HTTP hó…h m⁄ô‹ i†íabÀd\t: %d\n", 
hm
);

212 i‡(
hm
) {

213 
TfwHMSèts
 *
hm_°©s
;

214 
	`£q_¥ötf
(
£q
, "HTTPávailability\t: %d\n",

215 !
	`tfw_§v_su•íded
(
§v
));

216 i‡((
hm_°©s
 = 
	`tfw_≠m_hm_°©s
(
§v
->
≠mªf
))) {

217 
	`£q_¥ötf
(
£q
, "\tTime untilÇext health"

219 
hm_°©s
->
πime
);

220 
i
 = 0; i < 
hm_°©s
->
c˙t
; ++i)

221 
	`£q_¥ötf
(
£q
, "\tHTTP '%d' codes\t: %u\n",

222 
hm_°©s
->
rsums
[
i
].
code
,

223 
hm_°©s
->
rsums
[
i
].
sum
);

224 
	`k‰ì
(
hm_°©s
);

228 
	`£q_¥ötf
(
£q
, "Maximum forwarding queue size\t: %u\n",

229 
§v
->
sg
->
max_qsize
);

230 
i
 = 0; i < 
§v
->
c⁄n_n
; ++i)

231 
	`£q_¥ötf
(
£q
, "\tConnection %03zd queue size\t: %u\n",

232 
i
, 
qsize
[i]);

235 #unde‡
SPRNE


236 
	}
}

239 
	$tfw_§v°©s_£q_ªc⁄fig
(
£q_fûe
 *
£q
, *
off
)

242 
	`£q_¥ötf
(
£q
,

246 
	}
}

249 
	$tfw_§v°©s_£q_›í
(
öode
 *öode, 
fûe
 *file)

251 i‡(!
	`tfw_run°©e_is_ªc⁄fig
())

252  
	`sögÀ_›í
(
fûe
, 
tfw_§v°©s_£q_show
, 
	`PDE_DATA
(
öode
));

253  
	`sögÀ_›í
(
fûe
, 
tfw_§v°©s_£q_ªc⁄fig
, 
	`PDE_DATA
(
öode
));

254 
	}
}

259 
¥oc_dú_íåy
 *
	gtfw_¥ocfs_ãm≥°a
;

260 
¥oc_dú_íåy
 *
	gtfw_¥ocfs_≥rf°©
;

261 
¥oc_dú_íåy
 *
	gtfw_¥ocfs_§v°©s
;

262 
¥oc_dú_íåy
 *
	gtfw_¥ocfs_sg°©s
;

264 
fûe_›î©i⁄s
 
	gtfw_§v°©s_f›s
 = {

265 .
ow√r
 = 
THIS_MODULE
,

266 .
	g›í
 = 
tfw_§v°©s_£q_›í
,

267 .
	gªad
 = 
£q_ªad
,

268 .
	gŒ£ek
 = 
£q_l£ek
,

269 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

273 
	$tfw_¥ocfs_§v_¸óã
(
TfwSîvî
 *
§v
)

275 
¥oc_dú_íåy
 *
pfs_§v
;

276 
§v_«me
[
TFW_ADDR_STR_BUF_SIZE
] = { 0 };

278 
	`tfw_addr_¡›
(&
§v
->
addr
, 
§v_«me
, (srv_name));

279 
pfs_§v
 = 
	`¥oc_¸óã_d©a
(
§v_«me
, 
S_IRUGO
,

280 
tfw_¥ocfs_sg°©s
,

281 &
tfw_§v°©s_f›s
, 
§v
);

283  
pfs_§v
 ? 0 : -
ENOENT
;

284 
	}
}

287 
	$tfw_¥ocfs_sg_¸óã
(
TfwSrvGroup
 *
sg
)

289 i‡(!(
tfw_¥ocfs_sg°©s
 = 
	`¥oc_mkdú
(
sg
->
«me
, 
tfw_¥ocfs_§v°©s
)))

290  -
ENOENT
;

292 
	}
}

295 
	$tfw_¥ocfs_cfgíd
()

297 
TfwPr˙éSèts
 
p°©s
 = {

298 .
ôh
 = 
tfw_p°©s_ôh
,

299 .
psz
 = 
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)

302 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

304 i‡(
	`tfw_≠m_p°©s_vîify
(&
p°©s
))

305  -
EINVAL
;

307 
	}
}

310 
	$tfw_¥ocfs_˛ónup
()

312 
	`ªmove_¥oc_subåì
("£rvîs", 
tfw_¥ocfs_ãm≥°a
);

313 
tfw_¥ocfs_§v°©s
 = 
NULL
;

314 
	}
}

317 
	$tfw_¥ocfs_°¨t
()

319 i‡(!
tfw_¥ocfs_ãm≥°a
)

320  -
ENOENT
;

322 
	`tfw_¥ocfs_˛ónup
();

323 i‡(!(
tfw_¥ocfs_§v°©s
 = 
	`¥oc_mkdú
("£rvîs", 
tfw_¥ocfs_ãm≥°a
)))

324  -
ENOENT
;

326  
	`tfw_sg_f‹_óch_§v
(
tfw_¥ocfs_sg_¸óã
, 
tfw_¥ocfs_§v_¸óã
);

327 
	}
}

330 
	$tfw_¥ocfs_°›
()

332 
	`tfw_¥ocfs_˛ónup
();

333 
	}
}

335 
TfwCfgS≥c
 
	gtfw_¥ocfs_•ecs
[] = {

339 
TfwMod
 
	gtfw_¥ocfs_mod
 = {

340 .
«me
 = "procfs",

341 .
	gcfgíd
 = 
tfw_¥ocfs_cfgíd
,

342 .
	g°¨t
 = 
tfw_¥ocfs_°¨t
,

343 .
	g°›
 = 
tfw_¥ocfs_°›
,

344 .
	g•ecs
 = 
tfw_¥ocfs_•ecs
,

350 
fûe_›î©i⁄s
 
	gtfw_≥rf°©_f›s
 = {

351 .
ow√r
 = 
THIS_MODULE
,

352 .
	g›í
 = 
tfw_≥rf°©_£q_›í
,

353 .
	gªad
 = 
£q_ªad
,

354 .
	gŒ£ek
 = 
£q_l£ek
,

355 .
	gªÀa£
 = 
sögÀ_ªÀa£
,

359 
	$tfw_¥ocfs_öô
()

361 
tfw_¥ocfs_ãm≥°a
 = 
	`¥oc_mkdú
("ãm≥°a", 
NULL
);

362 i‡(!
tfw_¥ocfs_ãm≥°a
)

363 
out
;

365 
tfw_¥ocfs_≥rf°©
 = 
	`¥oc_¸óã
("≥rf°©", 
S_IRUGO
,

366 
tfw_¥ocfs_ãm≥°a
,

367 &
tfw_≥rf°©_f›s
);

368 i‡(!
tfw_¥ocfs_≥rf°©
)

369 
out_ãm≥°a
;

371 
	`tfw_mod_ªgi°î
(&
tfw_¥ocfs_mod
);

375 
out
:

376  -
ENOMEM
;

377 
out_ãm≥°a
:

378 
	`ªmove_¥oc_íåy
("ãm≥°a", 
NULL
);

379 
out
;

380 
	}
}

383 
	$tfw_¥ocfs_exô
()

385 
	`tfw_mod_uƒegi°î
(&
tfw_¥ocfs_mod
);

386 
	`ªmove_¥oc_íåy
("≥rf°©", 
tfw_¥ocfs_ãm≥°a
);

387 
	`ªmove_¥oc_íåy
("ãm≥°a", 
NULL
);

388 
	}
}

	@procfs.h

20 #i‚de‡
__TFW_PROCFS_H__


21 
	#__TFW_PROCFS_H__


	)

23 
	~"ãm≥°a_fw.h
"

31 
u64
 
	mpÊ_hôs
;

32 
u64
 
	mpÊ_mis£s
;

33 
u64
 
	mwq_fuŒ
;

34 } 
	tTfwSsSèt
;

53 
	#TFW_STAT_COMMON
 \

54 
u64
 
rx_mesßges
; \

55 
u64
 
msgs_f‹w¨ded
; \

56 
u64
 
msgs_∑r£º
; \

57 
u64
 
msgs_fûtout
; \

58 
u64
 
msgs_Ÿhîr
; \

59 
u64
 
c⁄n_©ãm±s
; \

60 
u64
 
c⁄n_e°ablished
; \

61 
u64
 
c⁄n_disc⁄√˘s
; \

62 
u64
 
rx_byãs
;

	)

65 
	mTFW_STAT_COMMON
;

66 
u64
 
	mc⁄n_ª°ri˘ed
;

67 } 
	tTfwSrvSèt
;

74 
	mTFW_STAT_COMMON
;

75 
u64
 
	mmsgs_‰omˇche
;

76 
u64
 
	m⁄löe
;

77 } 
	tTfwC tSèt
;

86 
u64
 
	mhôs
;

87 
u64
 
	mmis£s
;

88 } 
	tTfwCacheSèt
;

91 
TfwSsSèt
 
	mss
;

92 
TfwC tSèt
 
	m˛¡
;

93 
TfwSrvSèt
 
	m£rv
;

94 
TfwCacheSèt
 
	mˇche
;

95 } 
	tTfwPîfSèt
;

97 
DECLARE_PER_CPU_ALIGNED
(
TfwPîfSèt
, 
tfw_≥rf°©
);

105 
	#TFW_INC_STAT_BH
(...Ë
	`this_˝u_öc
(
tfw_≥rf°©
.
__VA_ARGS__
)

	)

106 
	#TFW_DEC_STAT_BH
(...Ë
	`this_˝u_dec
(
tfw_≥rf°©
.
__VA_ARGS__
)

	)

107 
	#TFW_ADD_STAT_BH
(
vÆ
, ...) \

108 
	`this_˝u_add
(
tfw_≥rf°©
.
__VA_ARGS__
, 
vÆ
)

	)

	@sched.c

23 
	~"ãm≥°a_fw.h
"

24 
	~"log.h
"

25 
	~"£rvî.h
"

26 
	~"hâp_£ss.h
"

35 
LIST_HEAD
(
sched_li°
);

43 
TfwScheduÀr
 *

44 
	$tfw_sched_lookup
(c⁄° *
«me
)

46 
TfwScheduÀr
 *
sched
;

48 
	`li°_f‹_óch_íåy
(
sched
, &
sched_li°
, 
li°
) {

49 i‡(!
«me
 || !
	`°rˇ£cmp
“ame, 
sched
->name))

50  
sched
;

53  
NULL
;

54 
	}
}

61 
	$tfw_sched_ªgi°î
(
TfwScheduÀr
 *
sched
)

63 
	`TFW_LOG
("Regi°îögÇew scheduÀr: %s\n", 
sched
->
«me
);

64 
	`BUG_ON
(!
	`li°_em±y
(&
sched
->
li°
));

65 
	`li°_add_èû
(&
sched
->
li°
, &
sched_li°
);

68 
	}
}

75 
	$tfw_sched_uƒegi°î
(
TfwScheduÀr
 *
sched
)

77 
	`TFW_LOG
("Un-ªgi°îög scheduÀr: %s\n", 
sched
->
«me
);

78 
	`BUG_ON
(
	`li°_em±y
(&
sched
->
li°
));

79 
	`li°_dñ_öô
(&
sched
->
li°
);

80 
	}
}

	@server.c

23 
	~<löux/¶ab.h
>

24 
	~<löux/rw£m.h
>

26 
	~"lib/hash.h
"

27 
	~"≠m.h
"

28 
	~"˛õ¡.h
"

29 
	~"log.h
"

30 
	~"£rvî.h
"

33 
kmem_ˇche
 *
	g§v_ˇche
;

35 
©omic64_t
 
	ga˘_sg_n
 = 
ATOMIC64_INIT
(0);

66 
	#TFW_SG_HBITS
 10

	)

67 
DECLARE_HASHTABLE
(
sg_hash
, 
TFW_SG_HBITS
);

68 
DECLARE_HASHTABLE
(
sg_hash_ªc⁄fig
, 
TFW_SG_HBITS
);

74 
DECLARE_RWSEM
(
sg_£m
);

77 
	$tfw_£rvî_de°roy
(
TfwSîvî
 *
§v
)

79 i‡(
§v
->
˛ónup
)

80 
§v
->
	`˛ónup
(srv);

82 
	`BUG_ON
(!
	`li°_em±y
(&
§v
->
c⁄n_li°
));

83 
	`BUG_ON
(
	`timî_≥ndög
(&
§v
->
gs_timî
));

85 
	`tfw_≠m_dñ_§v
(
§v
);

86 i‡(
§v
->
sg
)

87 
	`tfw_sg_put
(
§v
->
sg
);

88 
	`kmem_ˇche_‰ì
(
§v_ˇche
, 
§v
);

89 
	}
}

91 
TfwSîvî
 *

92 
	$tfw_£rvî_¸óã
(c⁄° 
TfwAddr
 *
addr
)

94 
TfwSîvî
 *
§v
 = 
	`kmem_ˇche_Æloc
(
§v_ˇche
, 
GFP_KERNEL
 | 
__GFP_ZERO
);

95 i‡(!
§v
)

96  
NULL
;

98 
	`tfw_≥î_öô
((
TfwPìr
 *)
§v
, 
addr
);

99 
	`INIT_LIST_HEAD
(&
§v
->
li°
);

100 
	`©omic64_£t
(&
§v
->
ªf˙t
, 1);

102  
§v
;

103 
	}
}

105 
TfwSîvî
 *

106 
	$tfw_£rvî_lookup
(
TfwSrvGroup
 *
sg
, 
TfwAddr
 *
addr
)

108 
TfwSîvî
 *
§v
;

110 
	`down_ªad
(&
sg_£m
);

112 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

113 i‡(
	`tfw_addr_eq
(&
§v
->
addr
,áddr)) {

114 
	`tfw_£rvî_gë
(
§v
);

115 
	`up_ªad
(&
sg_£m
);

116  
§v
;

118 
	`tfw_§v_lo›_sched_rcu
();

121 
	`up_ªad
(&
sg_£m
);

123  
NULL
;

124 
	}
}

127 
	$tfw_£rvî_°¨t_sched
(
TfwSîvî
 *
§v
)

129 
	`TFW_DBG_ADDR
("Sèπ scheduÀ∏f‹ sîvî", &
§v
->
addr
);

130 i‡(
§v
->
sg
->
sched
->
add_§v
)

131  
§v
->
sg
->
sched
->
	`add_§v
(srv);

134 
	}
}

137 
	$tfw_£rvî_°›_sched
(
TfwSîvî
 *
§v
)

139 
	`TFW_DBG_ADDR
("St› scheduÀ∏f‹ sîvî", &
§v
->
addr
);

140 i‡(
§v
->
sg
->
sched
 && srv->sg->sched->
dñ_§v
)

141 
§v
->
sg
->
sched
->
	`dñ_§v
(srv);

142 
	}
}

149 
TfwSrvGroup
 *

150 
	$tfw_sg_lookup
(c⁄° *
«me
, 
Àn
)

152 
TfwSrvGroup
 *
sg
;

153 
key
 = 
	`hash_ˇlc
(
«me
, 
Àn
);

155 
	`down_ªad
(&
sg_£m
);

156 
	`hash_f‹_óch_possibÀ
(
sg_hash
, 
sg
, 
li°
, 
key
) {

157 i‡(
	`tfw_sg_«me_m©ch
(
sg
, 
«me
, 
Àn
)) {

158 
	`tfw_sg_gë
(
sg
);

159 
	`up_ªad
(&
sg_£m
);

160  
sg
;

162 
	`tfw_§v_lo›_sched_rcu
();

164 
	`up_ªad
(&
sg_£m
);

166  
NULL
;

167 
	}
}

176 
TfwSrvGroup
 *

177 
	$tfw_sg_lookup_ªc⁄fig
(c⁄° *
«me
, 
Àn
)

179 
TfwSrvGroup
 *
sg
;

180 
key
 = 
	`hash_ˇlc
(
«me
, 
Àn
);

182 
	`down_ªad
(&
sg_£m
);

183 
	`hash_f‹_óch_possibÀ
(
sg_hash_ªc⁄fig
, 
sg
, 
li°_ªc⁄fig
, 
key
) {

184 i‡(
	`tfw_sg_«me_m©ch
(
sg
, 
«me
, 
Àn
)) {

185 
	`tfw_sg_gë
(
sg
);

186 
	`up_ªad
(&
sg_£m
);

187  
sg
;

189 
	`tfw_§v_lo›_sched_rcu
();

191 
	`up_ªad
(&
sg_£m
);

193  
NULL
;

194 
	}
}

195 
EXPORT_SYMBOL
(
tfw_sg_lookup_ªc⁄fig
);

202 
TfwSrvGroup
 *

203 
	$tfw_sg_√w
(c⁄° *
«me
, 
Àn
, 
gÂ_t
 
Êags
)

205 
TfwSrvGroup
 *
sg
;

206 
size_t
 
«me_size
 = 
	`°æí
(
«me
) + 1;

208 
	`TFW_DBG
("Cª©ê√w sîvî group: '%s'\n", 
«me
);

210 
sg
 = 
	`kzÆloc
((*sgË+ 
«me_size
, 
Êags
);

211 i‡(!
sg
)

212  
NULL
;

214 
	`INIT_HLIST_NODE
(&
sg
->
li°
);

215 
	`INIT_HLIST_NODE
(&
sg
->
li°_ªc⁄fig
);

216 
	`INIT_LIST_HEAD
(&
sg
->
§v_li°
);

217 
	`©omic64_£t
(&
sg
->
ªf˙t
, 1);

218 
sg
->
∆í
 = 
Àn
;

219 
	`mem˝y
(
sg
->
«me
,Çame, 
«me_size
);

221 
	`©omic64_öc
(&
a˘_sg_n
);

223  
sg
;

224 
	}
}

232 
	$tfw_sg_add_ªc⁄fig
(
TfwSrvGroup
 *
sg
)

234 
key
;

236 
	`TFW_DBG
("AddÇew sîvî group: '%s'\n", 
sg
->
«me
);

238 i‡(
	`tfw_sg_lookup_ªc⁄fig
(
sg
->
«me
, sg->
∆í
)) {

239 
	`TFW_ERR
("du∂iˇã sîvî group: '%s'\n", 
sg
->
«me
);

240  -
EINVAL
;

243 
key
 = 
	`hash_ˇlc
(
sg
->
«me
, sg->
∆í
);

245 
	`tfw_sg_gë
(
sg
);

246 
	`down_wrôe
(&
sg_£m
);

247 
	`hash_add
(
sg_hash_ªc⁄fig
, &
sg
->
li°_ªc⁄fig
, 
key
);

248 
	`up_wrôe
(&
sg_£m
);

251 
	}
}

262 
	$tfw_sg_≠∂y_ªc⁄fig
(
hli°_hód
 *
dñ_sg
)

264 
i
;

265 
key
;

266 
hli°_node
 *
tmp
;

267 
TfwSrvGroup
 *
sg
;

269 
	`TFW_DBG
("ApplyÑeconfig groups\n");

271 
	`down_wrôe
(&
sg_£m
);

273 
	`hash_f‹_óch_ß„
(
sg_hash
, 
i
, 
tmp
, 
sg
, 
li°
) {

274 i‡(
	`hli°_unhashed
(&
sg
->
li°_ªc⁄fig
)) {

275 
	`hash_dñ
(&
sg
->
li°
);

276 
	`hli°_add_hód
(&
sg
->
li°
, 
dñ_sg
);

279 
	`hash_dñ
(&
sg
->
li°_ªc⁄fig
);

280 
	`tfw_sg_put
(
sg
);

282 
	`tfw_§v_lo›_sched_rcu
();

284 
	`hash_f‹_óch_ß„
(
sg_hash_ªc⁄fig
, 
i
, 
tmp
, 
sg
, 
li°_ªc⁄fig
) {

285 
	`hash_dñ
(&
sg
->
li°_ªc⁄fig
);

286 
key
 = 
	`hash_ˇlc
(
sg
->
«me
, sg->
∆í
);

287 
	`hash_add
(
sg_hash
, &
sg
->
li°
, 
key
);

288 
	`tfw_§v_lo›_sched_rcu
();

291 
	`up_wrôe
(&
sg_£m
);

292 
	}
}

302 
	$tfw_sg_dr›_ªc⁄fig
()

304 
i
;

305 
TfwSrvGroup
 *
sg
;

306 
hli°_node
 *
tmp
;

308 
	`down_wrôe
(&
sg_£m
);

309 
	`hash_f‹_óch_ß„
(
sg_hash_ªc⁄fig
, 
i
, 
tmp
, 
sg
, 
li°_ªc⁄fig
) {

310 
	`hash_dñ
(&
sg
->
li°_ªc⁄fig
);

311 
	`tfw_sg_put
(
sg
);

312 
	`tfw_§v_lo›_sched_rcu
();

314 
	`up_wrôe
(&
sg_£m
);

315 
	}
}

322 
	$tfw_sg_add_§v
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
)

324 
	`BUG_ON
(
§v
->
sg
);

325 
	`tfw_£rvî_gë
(
§v
);

326 
	`tfw_sg_gë
(
sg
);

327 
§v
->
sg
 = sg;

329 
	`TFW_DBG2
("AddÇew backíd sîvîÅÿgrou∞'%s'\n", 
sg
->
«me
);

330 
	`down_wrôe
(&
sg_£m
);

331 
	`li°_add
(&
§v
->
li°
, &
sg
->
§v_li°
);

332 ++
sg
->
§v_n
;

333 
	`up_wrôe
(&
sg_£m
);

334 
	}
}

341 
	$__tfw_sg_dñ_§v
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
, 
boﬁ
 
lock
)

343 
	`BUG_ON
(
§v
->
sg
 != sg);

349 
	`TFW_DBG2
("Removêbackíd sîvî from grou∞'%s'\n", 
sg
->
«me
);

351 i‡(
lock
)

352 
	`down_wrôe
(&
sg_£m
);

353 
	`li°_dñ_öô
(&
§v
->
li°
);

354 --
sg
->
§v_n
;

355 i‡(
lock
)

356 
	`up_wrôe
(&
sg_£m
);

357 
	`tfw_£rvî_put
(
§v
);

358 
	}
}

361 
	$tfw_sg_°¨t_sched
(
TfwSrvGroup
 *
sg
, 
TfwScheduÀr
 *
sched
, *
¨g
)

363 
	`TFW_DBG2
("Start scheduler '%s' for group '%s'\n",

364 
sched
->
«me
, 
sg
->name);

365 
sg
->
sched
 = sched;

366 i‡(
sched
->
add_gΩ
)

367  
sched
->
	`add_gΩ
(
sg
, 
¨g
);

370 
	}
}

373 
	$tfw_sg_°›_sched
(
TfwSrvGroup
 *
sg
)

375 
	`TFW_DBG2
("Stop scheduler '%s' for group '%s'\n",

376 (
sg
->
sched
 ? sg->sched->
«me
 : ""), sg->name);

377 i‡(
sg
->
sched
 && sg->sched->
dñ_gΩ
)

378 
sg
->
sched
->
	`dñ_gΩ
(sg);

379 
	}
}

388 
__tfw_sg_f‹_óch_§v
(
TfwSrvGroup
 *
sg
,

389 (*
cb
)(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
, *
d©a
),

390 *
d©a
)

392 
r
 = 0;

393 
TfwSîvî
 *
§v
, *
tmp
;

395 
	`down_wrôe
(&
sg_£m
);

396 
	`li°_f‹_óch_íåy_ß„
(
§v
, 
tmp
, &
sg
->
§v_li°
, 
li°
) {

397 i‡((
r
 = 
	`cb
(
sg
, 
§v
, 
d©a
)))

399 
	`tfw_§v_lo›_sched_rcu
();

401 
	`up_wrôe
(&
sg_£m
);

403  
r
;

404 
	}
}

412 
tfw_sg_f‹_óch_§v
((*
sg_cb
)(
TfwSrvGroup
 *
sg
),

413 (*
§v_cb
)(
TfwSîvî
 *
§v
))

415 
i
, 
r
 = 0;

416 
TfwSrvGroup
 *
sg
;

417 
TfwSîvî
 *
§v
, *
tmp
;

419 
	`down_wrôe
(&
sg_£m
);

420 
	`hash_f‹_óch
(
sg_hash
, 
i
, 
sg
, 
li°
) {

421 i‡(
sg_cb
 && (
r
 = 
	`sg_cb
(
sg
)))

422 
íd
;

423 
	`li°_f‹_óch_íåy_ß„
(
§v
, 
tmp
, &
sg
->
§v_li°
, 
li°
) {

424 i‡((
r
 = 
	`§v_cb
(
§v
)))

425 
íd
;

426 
	`tfw_§v_lo›_sched_rcu
();

428 
	`tfw_§v_lo›_sched_rcu
();

430 
íd
:

431 
	`up_wrôe
(&
sg_£m
);

433  
r
;

434 
	}
}

440 
tfw_sg_f‹_óch_§v_ªc⁄fig
((*
cb
)(
TfwSîvî
 *
§v
))

442 
i
, 
r
 = 0;

443 
TfwSrvGroup
 *
sg
;

444 
TfwSîvî
 *
§v
, *
tmp
;

446 
	`down_wrôe
(&
sg_£m
);

447 
	`hash_f‹_óch
(
sg_hash_ªc⁄fig
, 
i
, 
sg
, 
li°_ªc⁄fig
) {

448 
	`li°_f‹_óch_íåy_ß„
(
§v
, 
tmp
, &
sg
->
§v_li°
, 
li°
)

449 i‡((
r
 = 
	`cb
(
§v
)))

450 
íd
;

451 
	`tfw_§v_lo›_sched_rcu
();

453 
íd
:

454 
	`up_wrôe
(&
sg_£m
);

456  
r
;

457 
	}
}

463 
	$tfw_sg_de°roy
(
TfwSrvGroup
 *
sg
)

465 
	`TFW_DBG2
("ªÀa£ group: '%s'\n", 
sg
->
«me
);

466 
	`WARN_ON
(!
	`li°_em±y
(&
sg
->
§v_li°
));

468 
	`k‰ì
(
sg
);

469 
	`©omic64_dec
(&
a˘_sg_n
);

470 
	}
}

471 
EXPORT_SYMBOL
(
tfw_sg_de°roy
);

478 
	$tfw_sg_ªÀa£
(
TfwSrvGroup
 *
sg
)

480 
TfwSîvî
 *
§v
, *
§v_tmp
;

482 
	`tfw_sg_°›_sched
(
sg
);

484 
	`down_wrôe
(&
sg_£m
);

485 
	`li°_f‹_óch_íåy_ß„
(
§v
, 
§v_tmp
, &
sg
->
§v_li°
, 
li°
) {

486 
	`__tfw_sg_dñ_§v
(
sg
, 
§v
, 
Ál£
);

487 
	`tfw_§v_lo›_sched_rcu
();

489 
	`up_wrôe
(&
sg_£m
);

490 
	}
}

496 
	$tfw_sg_ªÀa£_Æl
()

498 
i
;

499 
TfwSrvGroup
 *
sg
;

500 
hli°_node
 *
tmp
;

501 
TfwSîvî
 *
§v
, *
§v_tmp
;

503 
	`down_wrôe
(&
sg_£m
);

505 
	`hash_f‹_óch_ß„
(
sg_hash
, 
i
, 
tmp
, 
sg
, 
li°
) {

506 
	`tfw_sg_°›_sched
(
sg
);

507 
	`li°_f‹_óch_íåy_ß„
(
§v
, 
§v_tmp
, &
sg
->
§v_li°
, 
li°
) {

508 
	`__tfw_sg_dñ_§v
(
sg
, 
§v
, 
Ál£
);

509 
	`tfw_§v_lo›_sched_rcu
();

511 
	`hash_dñ
(&
sg
->
li°
);

512 
	`tfw_sg_put
(
sg
);

513 
	`tfw_§v_lo›_sched_rcu
();

515 
	`hash_öô
(
sg_hash
);

517 
	`up_wrôe
(&
sg_£m
);

518 
	}
}

528 
	$tfw_sg_waô_ªÀa£
()

530 
ãnd
 = 
jiffõs
 + 
HZ
 * 5;

531 
œ°_n
 = 
	`©omic64_ªad
(&
a˘_sg_n
), 
cuº_n
;

533 
	`might_¶ìp
();

538 (
cuº_n
 = 
	`©omic64_ªad
(&
a˘_sg_n
))) {

539 
	`scheduÀ
();

540 i‡(
	`time_is_a·î_jiffõs
(
ãnd
))

542 i‡(
cuº_n
 < 0) {

543 
	`TFW_ERR_NL
("Bug in server groupÑeference counting!\n");

546 i‡(
cuº_n
 =
œ°_n
) {

547 
	`TFW_ERR_NL
("Got stuck inÑeleasing of server groups! "

549 
cuº_n
);

552 
	`TFW_WARN_NL
("pending for server callbacksÅo complete for 5s, "

554 
œ°_n
 - 
cuº_n
, curr_n);

555 
ãnd
 = 
jiffõs
 + 
HZ
 * 5;

556 
œ°_n
 = 
cuº_n
;

558 
	}
}

560 
__öô


561 
	$tfw_£rvî_öô
()

563 
§v_ˇche
 = 
	`kmem_ˇche_¸óã
("tfw_§v_ˇche", (
TfwSîvî
),

564 0, 0, 
NULL
);

565 i‡(!
§v_ˇche
)

566  -
ENOMEM
;

568 
	}
}

571 
	$tfw_£rvî_exô
()

573 
	`kmem_ˇche_de°roy
(
§v_ˇche
);

574 
	}
}

	@server.h

21 #i‚de‡
__SERVER_H__


22 
	#__SERVER_H__


	)

24 
	~"addr.h
"

25 
	~"c⁄√˘i⁄.h
"

26 
	~"≥î.h
"

27 
	~"°r.h
"

33 
	#TFW_SRV_MAX_CONN_N
 
USHRT_MAX


	)

34 
	#TFW_SG_MAX_SRV_N
 
USHRT_MAX


	)

35 
	#TFW_SG_MAX_CONN_N
 \

36 (()
TFW_SG_MAX_SRV_N
 * 
TFW_SRV_MAX_CONN_N
)

	)

38 
tfw_§v_group_t
 
	tTfwSrvGroup
;

39 
tfw_scheduÀr_t
 
	tTfwScheduÀr
;

57 
	mTFW_PEER_COMMON
;

58 
li°_hód
 
	mli°
;

59 
timî_li°
 
	mgs_timî
;

60 
TfwSrvGroup
 *
	msg
;

61 
__rcu
 *
	msched_d©a
;

62 *
	m≠mªf
;

63 
size_t
 
	mc⁄n_n
;

64 
©omic64_t
 
	m£ss_n
;

65 
©omic64_t
 
	mªf˙t
;

66 
	mweight
;

67 
	mÊags
;

68 (*
	m˛ónup
)(*);

69 } 
	tTfwSîvî
;

79 
	mTFW_SRV_B_HMONITOR
 = 0x8,

82 
	mTFW_SRV_B_SUSPEND


85 
	#TFW_SRV_F_HMONITOR
 (1 << 
TFW_SRV_B_HMONITOR
)

	)

86 
	#TFW_SRV_F_SUSPEND
 (1 << 
TFW_SRV_B_SUSPEND
)

	)

111 
	stfw_§v_group_t
 {

112 
hli°_node
 
	mli°
;

113 
hli°_node
 
	mli°_ªc⁄fig
;

114 
li°_hód
 
	m§v_li°
;

115 
TfwScheduÀr
 *
	msched
;

116 
__rcu
 *
	msched_d©a
;

117 
size_t
 
	m§v_n
;

118 
©omic64_t
 
	mªf˙t
;

119 
	mmax_qsize
;

120 
	mmax_ªfwd
;

121 
	mmax_jqage
;

122 
	mmax_ª˙s
;

123 
	mÊags
;

124 
	m∆í
;

125 
	m«me
[0];

134 
	m∑°
;

135 
	møã
;

136 
	mahód
;

137 } 
	tTfwSchªfPªdi˘
;

142 
	#TFW_SG_M_PSTATS_IDX
 0x000f

	)

143 
	#TFW_SG_F_SCHED_RATIO_STATIC
 0x0010

	)

144 
	#TFW_SG_F_SCHED_RATIO_DYNAMIC
 0x0020

	)

145 
	#TFW_SG_F_SCHED_RATIO_PREDICT
 0x0040

	)

146 
	#TFW_SG_M_SCHED_RATIO_TYPE
 (
TFW_SG_F_SCHED_RATIO_STATIC
 \

147 | 
TFW_SG_F_SCHED_RATIO_DYNAMIC
 \

148 | 
TFW_SG_F_SCHED_RATIO_PREDICT
)

	)

150 
	#TFW_SRV_RETRY_NIP
 0x0100

	)

151 
	#TFW_SRV_STICKY
 0x0200

	)

152 
	#TFW_SRV_STICKY_FAILOVER
 0x0400

	)

153 
	#TFW_SRV_STICKY_FLAGS
 \

154 (
TFW_SRV_STICKY
 | 
TFW_SRV_STICKY_FAILOVER
)

	)

187 
	stfw_scheduÀr_t
 {

188 c⁄° *
	m«me
;

189 
li°_hód
 
	mli°
;

190 (*
	madd_gΩ
)(
TfwSrvGroup
 *
	msg
, *
	m¨g
);

191 (*
	mdñ_gΩ
)(
TfwSrvGroup
 *
	msg
);

192 (*
	madd_§v
)(
TfwSîvî
 *
	m§v
);

193 (*
	mdñ_§v
)(
TfwSîvî
 *
	m§v
);

194 
	mTfwSrvC⁄n
 *(*
	msched_sg_c⁄n
)(
TfwMsg
 *
	mmsg
, 
TfwSrvGroup
 *
	msg
);

195 
	mTfwSrvC⁄n
 *(*
	msched_§v_c⁄n
)(
TfwMsg
 *
	mmsg
, 
TfwSîvî
 *
	m§v
);

199 
TfwSîvî
 *
tfw_£rvî_¸óã
(c⁄° 
TfwAddr
 *
addr
);

200 
tfw_£rvî_de°roy
(
TfwSîvî
 *
§v
);

201 
TfwSîvî
 *
tfw_£rvî_lookup
(
TfwSrvGroup
 *
sg
, 
TfwAddr
 *
addr
);

202 
tfw_£rvî_°¨t_sched
(
TfwSîvî
 *
§v
);

203 
tfw_£rvî_°›_sched
(
TfwSîvî
 *
§v
);

205 
tfw_§v_c⁄n_ªÀa£
(
TfwSrvC⁄n
 *
§v_c⁄n
);

207 
ölöe
 
boﬁ


208 
	$tfw_£rvî_live
(
TfwSîvî
 *
§v
)

210  
	`©omic64_ªad
(&
§v
->
ªf˙t
) > 0;

211 
	}
}

213 
ölöe
 

214 
	$tfw_£rvî_gë
(
TfwSîvî
 *
§v
)

216 
	`©omic64_öc
(&
§v
->
ªf˙t
);

217 
	}
}

219 
ölöe
 

220 
	$tfw_£rvî_put
(
TfwSîvî
 *
§v
)

222 
rc
;

224 i‡(
	`u∆ikñy
(!
§v
))

227 
rc
 = 
	`©omic64_dec_ªtu∫
(&
§v
->
ªf˙t
);

228 i‡(
	`likñy
(
rc
))

230 
	`tfw_£rvî_de°roy
(
§v
);

231 
	}
}

233 
ölöe
 

234 
	$tfw_£rvî_pö_£ss
(
TfwSîvî
 *
§v
)

236 
	`©omic64_öc
(&
§v
->
£ss_n
);

237 
	`tfw_£rvî_gë
(
§v
);

238 
	}
}

240 
ölöe
 

241 
	$tfw_£rvî_u≈ö_£ss
(
TfwSîvî
 *
§v
)

243 
	`©omic64_dec
(&
§v
->
£ss_n
);

244 
	`tfw_£rvî_put
(
§v
);

245 
	}
}

254 
ölöe
 
boﬁ


255 
	$tfw_§v_c⁄n_queue_fuŒ
(
TfwSrvC⁄n
 *
§v_c⁄n
)

257 
TfwSrvGroup
 *
sg
 = ((
TfwSîvî
 *)
§v_c⁄n
->
≥î
)->sg;

258  (
	`ACCESS_ONCE
(
§v_c⁄n
->
qsize
Ë>
sg
->
max_qsize
);

259 
	}
}

267 
ölöe
 
boﬁ


268 
	$tfw_§v_c⁄n_√ed_ªsched
(
TfwSrvC⁄n
 *
§v_c⁄n
)

270 
TfwSrvGroup
 *
sg
 = ((
TfwSîvî
 *)
§v_c⁄n
->
≥î
)->sg;

271  ((
	`ACCESS_ONCE
(
§v_c⁄n
->
ª˙s
Ë>
sg
->
max_ª˙s
));

272 
	}
}

277 
ölöe
 

278 
	$tfw_§v_m¨k_Æive
(
TfwSîvî
 *
§v
)

280 
	`˛ór_bô
(
TFW_SRV_B_SUSPEND
, &
§v
->
Êags
);

281 
	}
}

286 
ölöe
 
boﬁ


287 
	$tfw_§v_su•íded
(
TfwSîvî
 *
§v
)

289  
	`ã°_bô
(
TFW_SRV_B_SUSPEND
, &
§v
->
Êags
);

290 
	}
}

293 
TfwSrvGroup
 *
tfw_sg_lookup
(c⁄° *
«me
, 
Àn
);

294 
TfwSrvGroup
 *
tfw_sg_lookup_ªc⁄fig
(c⁄° *
«me
, 
Àn
);

295 
TfwSrvGroup
 *
tfw_sg_√w
(c⁄° *
«me
, 
Àn
, 
gÂ_t
 
Êags
);

296 
tfw_sg_add_ªc⁄fig
(
TfwSrvGroup
 *
sg
);

297 
tfw_sg_≠∂y_ªc⁄fig
(
hli°_hód
 *
dñ_sg
);

298 
tfw_sg_dr›_ªc⁄fig
();

300 
tfw_sg_add_§v
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
);

301 
__tfw_sg_dñ_§v
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
, 
boﬁ
 
lock
);

302 
	#tfw_sg_dñ_§v
(
sg
, 
§v
Ë
	`__tfw_sg_dñ_§v
(sg, srv, 
åue
)

	)

303 
tfw_sg_°¨t_sched
(
TfwSrvGroup
 *
sg
, 
TfwScheduÀr
 *
sched
, *
¨g
);

304 
tfw_sg_°›_sched
(
TfwSrvGroup
 *
sg
);

305 
__tfw_sg_f‹_óch_§v
(
TfwSrvGroup
 *
sg
,

306 (*
cb
)(
TfwSrvGroup
 *, 
TfwSîvî
 *, *),

307 *
d©a
);

308 
	`tfw_sg_f‹_óch_§v
((*
sg_cb
)(
TfwSrvGroup
 *
sg
),

309 (*
§v_cb
)(
TfwSîvî
 *
§v
));

310 
	`tfw_sg_f‹_óch_§v_ªc⁄fig
((*
cb
)(
TfwSîvî
 *
§v
));

311 
	`tfw_sg_de°roy
(
TfwSrvGroup
 *
sg
);

312 
	`tfw_sg_ªÀa£
(
TfwSrvGroup
 *
sg
);

313 
	`tfw_sg_ªÀa£_Æl
();

314 
	`tfw_sg_waô_ªÀa£
();

316 
ölöe
 
boﬁ


317 
	$tfw_sg_live
(
TfwSrvGroup
 *
sg
)

319  
	`©omic64_ªad
(&
sg
->
ªf˙t
) > 0;

320 
	}
}

322 
ölöe
 

323 
	$tfw_sg_gë
(
TfwSrvGroup
 *
sg
)

325 
	`©omic64_öc
(&
sg
->
ªf˙t
);

326 
	}
}

328 
ölöe
 

329 
	$tfw_sg_put
(
TfwSrvGroup
 *
sg
)

331 i‡(
	`u∆ikñy
(!
sg
))

333 i‡(
	`likñy
(
	`©omic64_dec_ªtu∫
(&
sg
->
ªf˙t
)))

335 
	`tfw_sg_de°roy
(
sg
);

336 
	}
}

338 
ölöe
 
boﬁ


339 
	$tfw_sg_«me_m©ch
(
TfwSrvGroup
 *
sg
, c⁄° *
«me
, 
Àn
)

341  
Àn
 =
sg
->
∆í
 && !
	`°∫ˇ£cmp
(sg->
«me
,Çame,Üen);

342 
	}
}

345 
TfwScheduÀr
 *
tfw_sched_lookup
(c⁄° *
«me
);

346 
tfw_sched_ªgi°î
(
TfwScheduÀr
 *
sched
);

347 
tfw_sched_uƒegi°î
(
TfwScheduÀr
 *
sched
);

	@sock.c

21 
	~<löux/úq_w‹k.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/ãm≥°a.h
>

24 
	~<√t/¥Ÿocﬁ.h
>

25 
	~<√t/öë_comm⁄.h
>

26 
	~<√t/ù6_rouã.h
>

28 #i‚de‡
DBG_SS


29 #unde‡
DEBUG


31 
	~"lib/°r.h
"

32 
	~"addr.h
"

33 
	~"log.h
"

34 
	~"¥ocfs.h
"

35 
	~"sync_sockë.h
"

36 
	~"ãm≥°a_fw.h
"

37 
	~"w‹k_queue.h
"

40 
	mSS_SEND
,

41 
	mSS_CLOSE
,

42 } 
	tSsA˘i⁄
;

45 
sock
 *
	msk
;

46 
sk_buff
 *
	mskb_hód
;

47 
	mÊags
;

48 
SsA˘i⁄
 
	ma˘i⁄
;

49 
	m__unu£d
[1];

50 } 
	tSsW‹k
;

65 
li°_hód
 
	mhód
;

66 
•ölock_t
 
	mlock
;

67 
	mtu∫
;

68 
size_t
 
	msize
;

69 } 
	tSsClo£Backlog
;

80 
	mtickë
;

81 
li°_hód
 
	mli°
;

82 
SsW‹k
 
	msw
;

83 } 
	tSsCblNode
;

86 #i‡
deföed
(
DEBUG
) && (DEBUG >= 2)

87 c⁄° *
	gss_°©íame
[] = {

94 #ifde‡
CONFIG_DEBUG_SPINLOCK


95 
	#TFW_VALIDATE_SK_LOCK_OWNER
(
sk
) \

96 
	`BUG_ON
(
sk
->
sk_lock
.
¶ock
.
æock
.
ow√r_˝u
 !
	`øw_smp_¥o˚ss‹_id
())

	)

98 
	#TFW_VALIDATE_SK_LOCK_OWNER
(
sk
)

	)

118 
	#SS_V_ACT_NEWCONN
 0x0000000000000001UL

	)

119 
	#SS_M_ACT_NEWCONN
 0x00000000ffffffffUL

	)

120 
	#SS_V_ACT_LIVECONN
 0x0000000100000000UL

	)

122 
boﬁ
 
	g__ss_a˘ive
 = 
Ál£
;

123 
	$DEFINE_PER_CPU
(
©omic64_t
, 
__ss_a˘_˙t
Ë
____ˇchñöe_Æig√d


124 
	`ATOMIC_INIT
(0);

125 
	`DEFINE_PER_CPU
(
TfwRBQueue
, 
si_wq
);

126 
	`DEFINE_PER_CPU
(
úq_w‹k
, 
ùi_w‹k
);

132 
	`DEFINE_PER_CPU
(
SsClo£Backlog
, 
˛o£_backlog
);

133 
kmem_ˇche
 *
ss_cbacklog_ˇche
;

136 
	$ss_sk_öcomög_˝u_upd©e
(
sock
 *
sk
)

138 i‡(
sk
->
sk_öcomög_˝u
 == -1)

139 
sk
->
sk_öcomög_˝u
 = 
	`øw_smp_¥o˚ss‹_id
();

140 
	}
}

153 
	$ss_a˘ive_gu¨d_íãr
(
vÆ
)

155 
©omic64_t
 *
a˙t
 = 
	`this_˝u_±r
(&
__ss_a˘_˙t
);

157 i‡(
	`u∆ikñy
(!
	`READ_ONCE
(
__ss_a˘ive
)))

158  
SS_BAD
;

159 
	`©omic64_add
(
vÆ
, 
a˙t
);

160 i‡(
	`u∆ikñy
(!
	`READ_ONCE
(
__ss_a˘ive
))) {

161 
	`©omic64_sub
(
vÆ
, 
a˙t
);

162  
SS_BAD
;

165  
SS_OK
;

166 
	}
}

169 
	$ss_a˘ive_gu¨d_exô
(
vÆ
)

171 
	`©omic64_sub
(
vÆ
, 
	`this_˝u_±r
(&
__ss_a˘_˙t
));

172 
	}
}

178 
	#SS_CALL_GUARD_ENTER
(
cb
, 
sk
) \

180 
	`ss_a˘ive_gu¨d_íãr
(
SS_V_ACT_LIVECONN
); \

181 
	`SS_CALL
(
cb
, 
sk
); \

182 })

	)

184 
	#SS_CALL_GUARD_EXIT
(
cb
, 
sk
) \

186 
	`SS_CALL
(
cb
, 
sk
); \

187 
	`ss_a˘ive_gu¨d_exô
(
SS_V_ACT_LIVECONN
); \

188 } 0)

	)

191 
	$ss_ùi
(
úq_w‹k
 *
w‹k
)

193 
	`øi£_so·úq
(
NET_TX_SOFTIRQ
);

194 
	}
}

202 
	$ss_tu∫°ûe_push
(
tickë
, 
SsW‹k
 *
sw
, 
˝u
)

204 
úq_w‹k
 *
iw
 = &
	`≥r_˝u
(
ùi_w‹k
, 
˝u
);

205 
SsClo£Backlog
 *
cb
 = &
	`≥r_˝u
(
˛o£_backlog
, 
˝u
);

206 
SsCblNode
 *
˙
;

208 
˙
 = 
	`kmem_ˇche_Æloc
(
ss_cbacklog_ˇche
, 
GFP_ATOMIC
);

209 i‡(!
˙
)

210  -
ENOMEM
;

211 
˙
->
tickë
 =Åicket;

212 
	`mem˝y
(&
˙
->
sw
, sw, (*sw));

213 
	`•ö_lock_bh
(&
cb
->
lock
);

214 
	`li°_add
(&
˙
->
li°
, &
cb
->
hód
);

215 
cb
->
size
++;

216 i‡(
cb
->
tu∫
 > 
tickë
)

217 
cb
->
tu∫
 = 
tickë
;

218 
	`•ö_u∆ock_bh
(&
cb
->
lock
);

220 
	`tfw_øi£_so·úq
(
˝u
, 
iw
, 
ss_ùi
);

223 
	}
}

226 
	$ss_tu∫°ûe_upd©e_tu∫
(
SsClo£Backlog
 *
cb
)

228 i‡(
	`li°_em±y
(&
cb
->
hód
)) {

229 
cb
->
tu∫
 = 
LONG_MAX
;

231 
SsCblNode
 *
˙
 = 
	`li°_fú°_íåy
(&
cb
->
hód
, SsCblNode, 
li°
);

232 
cb
->
tu∫
 = 
˙
->
tickë
;

234 
	}
}

237 
	$ss_backlog_vÆid©e_˛ónup
(
˝u
)

239 
SsClo£Backlog
 *
cb
 = &
	`≥r_˝u
(
˛o£_backlog
, 
˝u
);

241 
	`WARN_ON
(!
	`li°_em±y
(&
cb
->
hód
));

242 
	`WARN_ON
(
cb
->
size
);

243 
	`WARN_ON
(
cb
->
tu∫
 !
LONG_MAX
);

244 
	}
}

247 
	$ss_wq_push
(
SsW‹k
 *
sw
, 
˝u
)

249 
TfwRBQueue
 *
wq
 = &
	`≥r_˝u
(
si_wq
, 
˝u
);

250 
úq_w‹k
 *
iw
 = &
	`≥r_˝u
(
ùi_w‹k
, 
˝u
);

251 
r
;

253 
r
 = 
	`tfw_wq_push
(
wq
, 
sw
, 
˝u
, 
iw
, 
ss_ùi
);

254 i‡(
r
)

255 
	`TFW_INC_STAT_BH
(
ss
.
wq_fuŒ
);

256  
r
;

257 
	}
}

260 
	$ss_wq_p›
(
SsW‹k
 *
sw
, *
tickë
)

262 
TfwRBQueue
 *
wq
 = 
	`this_˝u_±r
(&
si_wq
);

263 
SsClo£Backlog
 *
cb
 = 
	`this_˝u_±r
(&
˛o£_backlog
);

269 i‡(!*
tickë
 && !
	`tfw_wq_p›_tickë
(
wq
, 
sw
,Åicket))

280 i‡(*
tickë
 + 1 >
cb
->
tu∫
) {

281 
SsCblNode
 *
˙
 = 
NULL
;

283 
	`•ö_lock
(&
cb
->
lock
);

284 i‡(!
	`li°_em±y
(&
cb
->
hód
)) {

285 
˙
 = 
	`li°_fú°_íåy
(&
cb
->
hód
, 
SsCblNode
, 
li°
);

286 
	`li°_dñ
(&
˙
->
li°
);

287 
	`ss_tu∫°ûe_upd©e_tu∫
(
cb
);

288 
cb
->
size
--;

290 
	`•ö_u∆ock
(&
cb
->
lock
);

291 i‡(
˙
) {

292 
	`mem˝y_Á°
(
sw
, &
˙
->sw, (*sw));

293 
	`kmem_ˇche_‰ì
(
ss_cbacklog_ˇche
, 
˙
);

298  
	`tfw_wq_p›_tickë
(
wq
, 
sw
, 
tickë
);

299 
	}
}

301 
size_t


302 
	$__ss_˛o£_q_sz
(
˝u
)

304 
TfwRBQueue
 *
wq
 = &
	`≥r_˝u
(
si_wq
, 
˝u
);

305 
SsClo£Backlog
 *
cb
 = &
	`≥r_˝u
(
˛o£_backlog
, 
˝u
);

307  
	`tfw_wq_size
(
wq
Ë+ 
cb
->
size
;

308 
	}
}

310 
size_t


311 
	$ss_˛o£_q_sz
()

313  
	`__ss_˛o£_q_sz
(
	`smp_¥o˚ss‹_id
());

314 
	}
}

321 
boﬁ


322 
	$ss_sock_a˘ive
(
sock
 *
sk
)

324  (1 << 
sk
->
sk_°©e
Ë& (
TCPF_ESTABLISHED
 | 
TCPF_CLOSE_WAIT
);

325 
	}
}

336 
	$ss_do_£nd
(
sock
 *
sk
, 
sk_buff
 **
skb_hód
, 
Êags
)

338 
t˝_sock
 *
ç
 = 
	`t˝_sk
(
sk
);

339 
sk_buff
 *
skb
;

340 
size
, 
mss
 = 
	`t˝_£nd_mss
(
sk
, &size, 
MSG_DONTWAIT
);

341 
m¨k
 = (*
skb_hód
)->mark;

343 
	`TFW_DBG3
("[%d]: %s: sk=%p queue_empty=%d send_head=%p"

345 
	`smp_¥o˚ss‹_id
(), 
__func__
,

346 
sk
, 
	`t˝_wrôe_queue_em±y
(sk), 
	`t˝_£nd_hód
(sk),

347 
sk
->
sk_°©e
, 
mss
, 
size
);

350 i‡(
	`u∆ikñy
(!
	`ss_sock_a˘ive
(
sk
))) {

351 
	`ss_skb_queue_purge
(
skb_hód
);

355 (
skb
 = 
	`ss_skb_dequeue
(
skb_hód
))) {

361 i‡(!
skb
->
Àn
) {

362 
	`TFW_DBG3
("[%d]: %s: drop skb=%p data_len=%uÜen=%u\n",

363 
	`smp_¥o˚ss‹_id
(), 
__func__
,

364 
skb
, skb->
d©a_Àn
, skb->
Àn
);

365 
	`k‰ì_skb
(
skb
);

369 
	`ss_skb_öô_f‹_xmô
(
skb
);

370 i‡(
Êags
 & 
SS_F_ENCRYPT
)

371 
	`ãm≥°a_és_skb_£ây≥
(
skb
, 
	`SS_SKB_F2TYPE
(
Êags
));

373 
skb
->
m¨k
 = mark;

375 
	`TFW_DBG3
("[%d]: %s:Éntail skb=%p data_len=%uÜen=%u mark=%u"

376 "Åls_ty≥=%x\n", 
	`smp_¥o˚ss‹_id
(), 
__func__
,

377 
skb
, skb->
d©a_Àn
, skb->
Àn
, skb->
m¨k
,

378 
	`ãm≥°a_és_skb_ty≥
(
skb
));

380 
	`skb_íèû
(
sk
, 
skb
);

382 
ç
->
wrôe_£q
 +
skb
->
Àn
;

383 
	`TCP_SKB_CB
(
skb
)->
íd_£q
 +skb->
Àn
;

386 
	`TFW_DBG3
("[%d]: %s: sk=%p send_head=%p sk_state=%d flags=%x\n",

387 
	`smp_¥o˚ss‹_id
(), 
__func__
,

388 
sk
, 
	`t˝_£nd_hód
(sk), sk->
sk_°©e
, 
Êags
);

394 i‡(
Êags
 & 
SS_F_CONN_CLOSE
)

397 
	`t˝_push
(
sk
, 
MSG_DONTWAIT
, 
mss
, 
TCP_NAGLE_OFF
|
TCP_NAGLE_PUSH
, 
size
);

398 
	}
}

408 
	$ss_£nd
(
sock
 *
sk
, 
sk_buff
 **
skb_hód
, 
Êags
)

410 
˝u
, 
r
 = 0;

411 
sk_buff
 *
skb
, *
twö_skb
;

412 
SsW‹k
 
sw
 = {

413 .
sk
 = sk,

414 .
Êags
 = flags,

415 .
a˘i⁄
 = 
SS_SEND
,

418 
	`BUG_ON
(!
sk
);

419 i‡(
	`WARN_ON_ONCE
(!*
skb_hód
))

422 
˝u
 = 
sk
->
sk_öcomög_˝u
;

424 
	`TFW_DBG3
("[%d]: %s: sk=%p (cpu=%d) state=%s\n",

425 
	`smp_¥o˚ss‹_id
(), 
__func__
, 
sk
, 
˝u
,

426 
ss_°©íame
[
sk
->
sk_°©e
]);

432 i‡(
	`u∆ikñy
(!
	`ss_sock_a˘ive
(
sk
))) {

433 
	`TFW_DBG2
("Aâem±Åÿ£nd o¿öa˘ivêsockë %p\n", 
sk
);

434  -
EBADF
;

442 i‡(
Êags
 & 
SS_F_KEEP_SKB
) {

443 
skb
 = *
skb_hód
;

446 
twö_skb
 = 
	`pskb_c›y_f‹_˛⁄e
(
skb
, 
GFP_ATOMIC
);

447 i‡(!
twö_skb
) {

448 
	`TFW_WARN
("UnableÅo copyánÉgress SKB.\n");

449 
r
 = -
ENOMEM
;

450 
îr
;

452 
	`ss_skb_queue_èû
(&
sw
.
skb_hód
, 
twö_skb
);

453 
skb
 = skb->
√xt
;

454 } 
skb
 !*
skb_hód
);

456 
sw
.
skb_hód
 = *skb_head;

457 *
skb_hód
 = 
NULL
;

471 
	`sock_hﬁd
(
sk
);

472 i‡(
	`ss_wq_push
(&
sw
, 
˝u
)) {

473 
	`TFW_DBG2
("Cannot schedule socket %p forÅransmission"

474 " (queuêsizê%d)\n", 
sk
,

475 
	`tfw_wq_size
(&
	`≥r_˝u
(
si_wq
, 
˝u
)));

476 
	`sock_put
(
sk
);

477 
r
 = -
EBUSY
;

478 
îr
;

482 
îr
:

483 
	`ss_skb_queue_purge
(&
sw
.
skb_hód
);

484  
r
;

485 
	}
}

486 
EXPORT_SYMBOL
(
ss_£nd
);

512 
	$ss_do_˛o£
(
sock
 *
sk
)

514 
sk_buff
 *
skb
;

515 
d©a_was_uƒód
 = 0;

517 i‡(
	`u∆ikñy
(!
sk
))

519 
	`TFW_DBG2
("[%d]: Close socket %p (%s):áccount=%dÑefcnt=%u\n",

520 
	`smp_¥o˚ss‹_id
(), 
sk
, 
ss_°©íame
[sk->
sk_°©e
],

521 
	`sk_has_accou¡
(
sk
), 
	`ªfcou¡_ªad
(&sk->
sk_ªf˙t
));

522 
	`as£π_•ö_locked
(&
sk
->
sk_lock
.
¶ock
);

523 
	`TFW_VALIDATE_SK_LOCK_OWNER
(
sk
);

524 
	`WARN_ON_ONCE
(
sk
->
sk_°©e
 =
TCP_LISTEN
);

526 
	`WARN_ON_ONCE
(
	`sock_Êag
(
sk
, 
SOCK_LINGER
));

528 
	`WARN_ON_ONCE
(
	`t˝_sk
(
sk
)->
ª∑ú
);

530 
	`WARN_ON_ONCE
(!(
sk
->
sk_Æloˇti⁄
 & 
GFP_ATOMIC
));

533 
sk
->
sk_shutdown
 = 
SHUTDOWN_MASK
;

535 (
skb
 = 
	`__skb_dequeue
(&
sk
->
sk_ª˚ive_queue
)Ë!
NULL
) {

536 
u32
 
Àn
 = 
	`TCP_SKB_CB
(
skb
)->
íd_£q
 - TCP_SKB_CB(skb)->
£q
 -

537 
	`t˝_hdr
(
skb
)->
fö
;

538 
d©a_was_uƒód
 +
Àn
;

539 
	`TFW_DBG3
("[%d]: fªêrcv skb %p\n", 
	`smp_¥o˚ss‹_id
(), 
skb
);

540 
	`__k‰ì_skb
(
skb
);

543 
	`sk_mem_ª˛aim
(
sk
);

545 i‡(
sk
->
sk_°©e
 =
TCP_CLOSE
)

546 
adjudge_to_dóth
;

548 i‡(
d©a_was_uƒód
) {

549 
	`NET_INC_STATS
(
	`sock_√t
(
sk
), 
LINUX_MIB_TCPABORTONCLOSE
);

550 
	`t˝_£t_°©e
(
sk
, 
TCP_CLOSE
);

551 
	`t˝_£nd_a˘ive_ª£t
(
sk
, sk->
sk_Æloˇti⁄
);

553 i‡(
	`t˝_˛o£_°©e
(
sk
)) {

555 
t˝_sock
 *
ç
 = 
	`t˝_sk
(
sk
);

556 
mss_now
 = 
	`t˝_cuºít_mss
(
sk
);

558 
skb
 = 
	`t˝_wrôe_queue_èû
(
sk
);

560 i‡(
skb
 && 
	`t˝_£nd_hód
(
sk
)) {

562 
	`TCP_SKB_CB
(
skb
)->
t˝_Êags
 |
TCPHDR_FIN
;

563 
	`TCP_SKB_CB
(
skb
)->
íd_£q
++;

564 
ç
->
wrôe_£q
++;

568 
skb
 = 
	`Æloc_skb_f˛⁄e
(
MAX_TCP_HEADER
,

569 
sk
->
sk_Æloˇti⁄
);

570 i‡(!
skb
) {

571 
	`TFW_WARN
("can't send FIN dueÅo badálloc");

573 
	`skb_ª£rve
(
skb
, 
MAX_TCP_HEADER
);

574 
	`t˝_öô_n⁄d©a_skb
(
skb
, 
ç
->
wrôe_£q
,

575 
TCPHDR_ACK
 | 
TCPHDR_FIN
);

576 
	`t˝_queue_skb
(
sk
, 
skb
);

579 
	`__t˝_push_≥ndög_‰ames
(
sk
, 
mss_now
, 
TCP_NAGLE_OFF
);

582 
adjudge_to_dóth
:

583 
	`sock_hﬁd
(
sk
);

584 
	`sock_‹ph™
(
sk
);

590 
	`WARN_ON
(
sk
->
sk_backlog
.
èû
);

592 
	`≥r˝u_cou¡î_öc
(
sk
->
sk_¥Ÿ
->
‹ph™_cou¡
);

594 i‡(
sk
->
sk_°©e
 =
TCP_FIN_WAIT2
) {

595 c⁄° 
tmo
 = 
	`t˝_fö_time
(
sk
);

596 i‡(
tmo
 > 
TCP_TIMEWAIT_LEN
) {

597 
	`öë_csk_ª£t_kì∑live_timî
(
sk
,

598 
tmo
 - 
TCP_TIMEWAIT_LEN
);

600 
	`t˝_time_waô
(
sk
, 
TCP_FIN_WAIT2
, 
tmo
);

604 i‡(
sk
->
sk_°©e
 !
TCP_CLOSE
) {

605 
	`sk_mem_ª˛aim
(
sk
);

606 i‡(
	`t˝_check_oom
(
sk
, 0)) {

607 
	`t˝_£t_°©e
(
sk
, 
TCP_CLOSE
);

608 
	`t˝_£nd_a˘ive_ª£t
(
sk
, 
GFP_ATOMIC
);

609 
	`__NET_INC_STATS
(
	`sock_√t
(
sk
),

610 
LINUX_MIB_TCPABORTONMEMORY
);

613 i‡(
sk
->
sk_°©e
 =
TCP_CLOSE
) {

614 
ªque°_sock
 *
ªq
 = 
	`t˝_sk
(
sk
)->
Á°›í_rsk
;

615 i‡(
ªq
 !
NULL
)

616 
	`ªqsk_Á°›í_ªmove
(
sk
, 
ªq
, 
Ál£
);

617 
	`öë_csk_de°roy_sock
(
sk
);

619 
	}
}

631 
	$ss_lökîr‹
(
sock
 *
sk
)

633 
	`ss_do_˛o£
(
sk
);

634 
	`SS_CALL_GUARD_EXIT
(
c⁄√˘i⁄_îr‹
, 
sk
);

635 
	`sock_put
(
sk
);

636 
	}
}

647 
	$ss_˛o£
(
sock
 *
sk
, 
Êags
)

649 
˝u
;

650 
tickë
;

651 
SsW‹k
 
sw
 = {

652 .
sk
 = sk,

653 .
Êags
 = flags,

654 .
a˘i⁄
 = 
SS_CLOSE
,

657 i‡(
	`u∆ikñy
(!
sk
))

658  
SS_OK
;

660 
	`ss_sk_öcomög_˝u_upd©e
(
sk
);

661 
˝u
 = 
sk
->
sk_öcomög_˝u
;

663 
	`sock_hﬁd
(
sk
);

664 
tickë
 = 
	`ss_wq_push
(&
sw
, 
˝u
);

665 i‡(!
tickë
)

666  
SS_OK
;

667 i‡(!(
Êags
 & 
SS_F_SYNC
))

668 
îr
;

674 i‡(
	`ss_tu∫°ûe_push
(
tickë
, &
sw
, 
˝u
)) {

675 
	`TFW_WARN
("C™nŸ scheduÀ sockë %∞f‹ closög\n", 
sk
);

676 
îr
;

679  
SS_OK
;

680 
îr
:

681 
	`sock_put
(
sk
);

682  
SS_BAD
;

683 
	}
}

684 
EXPORT_SYMBOL
(
ss_˛o£
);

690 
	$ss_t˝_¥o˚ss_skb
(
sock
 *
sk
, 
sk_buff
 *
skb
, *
¥o˚s£d
)

692 
boﬁ
 
t˝_fö
;

693 
r
 = 0, 
off£t
, 
cou¡
;

694 *
c⁄n
;

695 
sk_buff
 *
skb_hód
 = 
NULL
;

696 
t˝_sock
 *
ç
 = 
	`t˝_sk
(
sk
);

699 
off£t
 = 
ç
->
c›õd_£q
 - 
	`TCP_SKB_CB
(
skb
)->
£q
;

700 i‡(
	`TCP_SKB_CB
(
skb
)->
t˝_Êags
 & 
TCPHDR_SYN
)

701 
off£t
--;

704 
t˝_fö
 = 
	`TCP_SKB_CB
(
skb
)->
t˝_Êags
 & 
TCPHDR_FIN
;

706 i‡(
	`ss_skb_uƒﬁl
(&
skb_hód
, 
skb
)) {

707 
	`__k‰ì_skb
(
skb
);

708  
SS_DROP
;

711 (
skb
 = 
	`ss_skb_dequeue
(&
skb_hód
))) {

712 
off
;

714 
	`WARN_ON_ONCE
(
skb
->
èû_lock
);

715 
	`WARN_ON_ONCE
(
	`skb_has_‰ag_li°
(
skb
));

716 
	`WARN_ON_ONCE
(
skb
->
sk
 || skb->
de°ru˘‹
);

718 i‡(
	`u∆ikñy
(
off£t
 >
skb
->
Àn
)) {

719 
off£t
 -
skb
->
Àn
;

720 
	`__k‰ì_skb
(
skb
);

728 
cou¡
 = 
skb
->
Àn
 - 
off£t
;

729 
ç
->
c›õd_£q
 +
cou¡
;

730 *
¥o˚s£d
 +
cou¡
;

731 
off
 = 
off£t
;

732 
off£t
 = 0;

734 
c⁄n
 = 
sk
->
sk_u£r_d©a
;

742 
	`BUG_ON
(
c⁄n
 =
NULL
);

744 i‡(
	`SS_CONN_TYPE
(
sk
Ë& 
C⁄n_St›
) {

745 
	`__k‰ì_skb
(
skb
);

749 
r
 = 
	`SS_CALL
(
c⁄√˘i⁄_ªcv
, 
c⁄n
, 
skb
, 
off
);

751 i‡(
r
 < 0) {

752 
	`TFW_DBG2
("[%d]: ProcessingÉrror: sk=%pKÑ=%d\n",

753 
	`smp_¥o˚ss‹_id
(), 
sk
, 
r
);

754 
out
;

757 i‡(
t˝_fö
) {

758 
	`TFW_DBG2
("Received data FIN on sk=%p, cpu=%d\n",

759 
sk
, 
	`smp_¥o˚ss‹_id
());

760 ++
ç
->
c›õd_£q
;

761 
r
 = 
SS_DROP
;

763 
out
:

764 i‡(
skb_hód
)

765 
	`ss_skb_queue_purge
(&
skb_hód
);

767  
r
;

768 
	}
}

779 
boﬁ


780 
	$ss_t˝_¥o˚ss_d©a
(
sock
 *
sk
)

782 
boﬁ
 
dr›lök
 = 
åue
;

783 
r
, 
cou¡
, 
¥o˚s£d
 = 0;

784 
skb_Àn
, 
skb_£q
;

785 
sk_buff
 *
skb
, *
tmp
;

786 
t˝_sock
 *
ç
 = 
	`t˝_sk
(
sk
);

788 
	`skb_queue_wÆk_ß„
(&
sk
->
sk_ª˚ive_queue
, 
skb
, 
tmp
) {

789 i‡(
	`u∆ikñy
(
	`bef‹e
(
ç
->
c›õd_£q
, 
	`TCP_SKB_CB
(
skb
)->
£q
))) {

790 
	`TFW_WARN
("recvmsg bug: TCP sequence gapát seq %X"

792 
ç
->
c›õd_£q
, 
	`TCP_SKB_CB
(
skb
)->
£q
);

793 
out
;

796 
	`__skb_u∆ök
(
skb
, &
sk
->
sk_ª˚ive_queue
);

797 
	`skb_‹ph™
(
skb
);

799 
	`WARN_ON_ONCE
(
	`skb_sh¨ed
(
skb
));

802 
skb_Àn
 = 
skb
->
Àn
;

803 
skb_£q
 = 
	`TCP_SKB_CB
(
skb
)->
£q
;

805 
cou¡
 = 0;

806 
r
 = 
	`ss_t˝_¥o˚ss_skb
(
sk
, 
skb
, &
cou¡
);

807 
¥o˚s£d
 +
cou¡
;

809 i‡(
r
 < 0)

810 
out
;

811 i‡(!
cou¡
)

812 
	`TFW_WARN
("recvmsg bug: overlapping TCP segmentát %X"

814 
ç
->
c›õd_£q
, 
skb_£q
,Åp->
rcv_nxt
,

815 
skb_Àn
);

817 
dr›lök
 = 
Ál£
;

818 
out
:

823 
	`t˝_rcv_•a˚_adju°
(
sk
);

824 i‡(
¥o˚s£d
)

825 
	`t˝_˛ónup_rbuf
(
sk
, 
¥o˚s£d
);

827  
dr›lök
;

828 
	}
}

840 
	$ss_t˝_d©a_ªady
(
sock
 *
sk
)

842 
	`TFW_DBG3
("[%d]: %s: sk=%p state=%s\n",

843 
	`smp_¥o˚ss‹_id
(), 
__func__
, 
sk
, 
ss_°©íame
[sk->
sk_°©e
]);

844 
	`as£π_•ö_locked
(&
sk
->
sk_lock
.
¶ock
);

845 
	`TFW_VALIDATE_SK_LOCK_OWNER
(
sk
);

847 i‡(!
	`skb_queue_em±y
(&
sk
->
sk_îr‹_queue
)) {

852 
	`TFW_ERR
("îr‹ d©®ö sockë %p\n", 
sk
);

854 i‡(!
	`skb_queue_em±y
(&
sk
->
sk_ª˚ive_queue
)) {

855 i‡(
	`ss_t˝_¥o˚ss_d©a
(
sk
) &&

856 !(
	`SS_CONN_TYPE
(
sk
Ë& 
C⁄n_St›
)) {

868 
	`ss_lökîr‹
(
sk
);

876 
t˝_sock
 *
ç
 = 
	`t˝_sk
(
sk
);

877 i‡(
ç
->
urg_d©a
 & 
TCP_URG_VALID
) {

878 
ç
->
urg_d©a
 = 0;

879 
	`TFW_DBG3
("[%d]: urgent data in socket %p\n",

880 
	`smp_¥o˚ss‹_id
(), 
sk
);

883 
	}
}

889 
	$ss_t˝_°©e_ch™ge
(
sock
 *
sk
)

891 
	`TFW_DBG3
("[%d]: %s: sk=%p state=%s\n",

892 
	`smp_¥o˚ss‹_id
(), 
__func__
, 
sk
, 
ss_°©íame
[sk->
sk_°©e
]);

893 
	`ss_sk_öcomög_˝u_upd©e
(
sk
);

894 
	`as£π_•ö_locked
(&
sk
->
sk_lock
.
¶ock
);

895 
	`TFW_VALIDATE_SK_LOCK_OWNER
(
sk
);

897 i‡(
sk
->
sk_°©e
 =
TCP_ESTABLISHED
) {

899 
SsPrŸo
 *
¥Ÿo
 = 
sk
->
sk_u£r_d©a
;

900 
sock
 *
lsk
 = 
¥Ÿo
->
li°íî
;

901 
r
;

903 i‡(
	`ss_a˘ive_gu¨d_íãr
(
SS_V_ACT_NEWCONN
)) {

910 
	`ss_do_˛o£
(
sk
);

911 
	`sock_put
(
sk
);

917 i‡(!
lsk
)

918 
	`SS_CALL_GUARD_EXIT
(
c⁄√˘i⁄_dr›
, 
sk
);

934 
r
 = 
lsk
 ? 
	`SS_CALL_GUARD_ENTER
(
c⁄√˘i⁄_√w
, 
sk
)

935 : 
	`SS_CALL
(
c⁄√˘i⁄_√w
, 
sk
);

936 i‡(
r
) {

937 
	`TFW_DBG2
("[%d]: New connection hook failed,Ñ=%d\n",

938 
	`smp_¥o˚ss‹_id
(), 
r
);

939 
	`ss_lökîr‹
(
sk
);

940 
	`ss_a˘ive_gu¨d_exô
(
SS_V_ACT_NEWCONN
);

944 
	`sock_£t_Êag
(
sk
, 
SOCK_TEMPESTA
);

945 i‡(
lsk
) {

953 
sk
->
sk_Æloˇti⁄
 = 
GFP_ATOMIC
;

955 
	`ss_a˘ive_gu¨d_exô
(
SS_V_ACT_NEWCONN
);

957 i‡(
sk
->
sk_°©e
 =
TCP_CLOSE_WAIT
) {

972 i‡(!
	`skb_queue_em±y
(&
sk
->
sk_ª˚ive_queue
))

973 
	`ss_t˝_¥o˚ss_d©a
(
sk
);

974 
	`TFW_DBG2
("[%d]: Pì∏c⁄√˘i⁄ closög\n", 
	`smp_¥o˚ss‹_id
());

975 
	`ss_lökîr‹
(
sk
);

977 i‡(
sk
->
sk_°©e
 =
TCP_CLOSE
) {

996 
	`WARN_ON
(!
	`skb_queue_em±y
(&
sk
->
sk_ª˚ive_queue
));

997 
	`ss_lökîr‹
(
sk
);

999 
	}
}

1002 
	$ss_¥Ÿo_öô
(
SsPrŸo
 *
¥Ÿo
, c⁄° 
SsHooks
 *
hooks
, 
ty≥
)

1004 
¥Ÿo
->
hooks
 = hooks;

1005 
¥Ÿo
->
ty≥
 =Åype;

1011 
	`WARN_ON_ONCE
(
¥Ÿo
->
li°íî
);

1012 
	}
}

1013 
EXPORT_SYMBOL
(
ss_¥Ÿo_öô
);

1016 
	$ss_¥Ÿo_öhîô
(c⁄° 
SsPrŸo
 *
∑ª¡
, SsPrŸÿ*
chûd
, 
chûd_ty≥
)

1018 *
chûd
 = *
∑ª¡
;

1019 
chûd
->
ty≥
 |
chûd_ty≥
;

1020 
	}
}

1032 
	$ss_£t_ˇŒbacks
(
sock
 *
sk
)

1038 
	`WARN_ON_ONCE
(!
sk
->
sk_u£r_d©a
);

1040 
sk
->
sk_d©a_ªady
 = 
ss_t˝_d©a_ªady
;

1041 
sk
->
sk_°©e_ch™ge
 = 
ss_t˝_°©e_ch™ge
;

1042 
	}
}

1043 
EXPORT_SYMBOL
(
ss_£t_ˇŒbacks
);

1053 
	$ss_£t_li°í
(
sock
 *
sk
)

1055 ((
SsPrŸo
 *)
sk
->
sk_u£r_d©a
)->
li°íî
 = sk;

1057 
sk
->
sk_°©e_ch™ge
 = 
ss_t˝_°©e_ch™ge
;

1058 
	`sock_£t_Êag
(
sk
, 
SOCK_TEMPESTA
);

1059 
	}
}

1060 
EXPORT_SYMBOL
(
ss_£t_li°í
);

1071 
	$ss_öë_¸óã
(
√t
 *√t, 
Ámûy
,

1072 
ty≥
, 
¥Ÿocﬁ
, 
sock
 **
nsk
)

1074 
îr
, 
pföë
;

1075 
sock
 *
sk
;

1076 
öë_sock
 *
öë
;

1077 
¥Ÿo
 *
™swî_¥Ÿ
;

1080 
	`WARN_ON_ONCE
(
ty≥
 !
SOCK_STREAM
 || 
¥Ÿocﬁ
 !
IPPROTO_TCP
);

1086 i‡(
Ámûy
 =
AF_INET
) {

1087 
pföë
 = 
PF_INET
;

1088 
™swî_¥Ÿ
 = &
t˝_¥Ÿ
;

1090 
pföë
 = 
PF_INET6
;

1091 
™swî_¥Ÿ
 = &
t˝v6_¥Ÿ
;

1093 
	`WARN_ON
(!
™swî_¥Ÿ
->
¶ab
);

1095 i‡(!(
sk
 = 
	`sk_Æloc
(
√t
, 
pföë
, 
GFP_ATOMIC
, 
™swî_¥Ÿ
, 1)))

1096  -
ENOBUFS
;

1098 
öë
 = 
	`öë_sk
(
sk
);

1099 
öë
->
is_icsk
 = 1;

1100 
öë
->
node‰ag
 = 0;

1101 
öë
->
öë_id
 = 0;

1103 i‡(
√t
->
ùv4
.
sys˘l_ù_no_pmtu_disc
)

1104 
öë
->
pmtudisc
 = 
IP_PMTUDISC_DONT
;

1106 
öë
->
pmtudisc
 = 
IP_PMTUDISC_WANT
;

1108 
	`sock_öô_d©a
(
NULL
, 
sk
);

1109 
sk
->
sk_ty≥
 = 
ty≥
;

1110 
sk
->
sk_Æloˇti⁄
 = 
GFP_ATOMIC
;

1111 
sk
->
sk_öcomög_˝u
 = -1;

1112 
sk
->
sk_de°ru˘
 = 
öë_sock_de°ru˘
;

1113 
sk
->
sk_¥Ÿocﬁ
 = 
¥Ÿocﬁ
;

1114 
sk
->
sk_backlog_rcv
 = sk->
sk_¥Ÿ
->
backlog_rcv
;

1116 i‡(
Ámûy
 =
AF_INET6
) {

1118 c⁄° 
off£t
 = 
sk
->
sk_¥Ÿ
->
obj_size


1119 - (
ùv6_pöfo
);

1120 
ùv6_pöfo
 *
≈
 = (ipv6_pinfo *)

1121 (((
u8
 *)
sk
Ë+ 
off£t
);

1122 
≈
->
h›_limô
 = -1;

1123 
≈
->
mˇ°_h›s
 = 
IPV6_DEFAULT_MCASTHOPS
;

1124 
≈
->
mc_lo›
 = 1;

1125 
≈
->
pmtudisc
 = 
IPV6_PMTUDISC_WANT
;

1126 
sk
->
sk_ùv6⁄ly
 = 
√t
->
ùv6
.
sys˘l
.
bödv6⁄ly
;

1127 
öë
->
pöë6
 = 
≈
;

1130 
öë
->
uc_âl
 = -1;

1131 
öë
->
mc_lo›
 = 1;

1132 
öë
->
mc_âl
 = 1;

1133 
öë
->
mc_Æl
 = 1;

1134 
öë
->
mc_ödex
 = 0;

1135 
öë
->
mc_li°
 = 
NULL
;

1136 
öë
->
rcv_tos
 = 0;

1138 
	`sk_ªf˙t_debug_öc
(
sk
);

1139 i‡(
sk
->
sk_¥Ÿ
->
öô
 && (
îr
 = sk->sk_¥Ÿ->
	`öô
(sk))) {

1140 
	`TFW_ERR
("ˇ¬Ÿ cª©êsockë, %d\n", 
îr
);

1141 
	`sk_comm⁄_ªÀa£
(
sk
);

1142  
îr
;

1145 *
nsk
 = 
sk
;

1148 
	}
}

1151 
	$ss_sock_¸óã
(
Ámûy
, 
ty≥
, 
¥Ÿocﬁ
, 
sock
 **
ªs
)

1153 
ªt
;

1154 
sock
 *
sk
 = 
NULL
;

1155 c⁄° 
√t_¥Ÿo_Ámûy
 *
pf
;

1157 
	`rcu_ªad_lock_bh
();

1158 i‡((
pf
 = 
	`gë_¥Ÿo_Ámûy
(
Ámûy
)Ë=
NULL
)

1159 
out_rcu_u∆ock
;

1160 i‡(!
	`åy_moduÀ_gë
(
pf
->
ow√r
))

1161 
out_rcu_u∆ock
;

1162 
	`rcu_ªad_u∆ock_bh
();

1164 
ªt
 = 
	`ss_öë_¸óã
(&
öô_√t
, 
Ámûy
, 
ty≥
, 
¥Ÿocﬁ
, &
sk
);

1165 
	`moduÀ_put
(
pf
->
ow√r
);

1166 i‡(
ªt
 < 0)

1167 
out_moduÀ_put
;

1169 *
ªs
 = 
sk
;

1172 
out_moduÀ_put
:

1173 
	`moduÀ_put
(
pf
->
ow√r
);

1174 
out_ªt_îr‹
:

1175  
ªt
;

1176 
out_rcu_u∆ock
:

1177 
ªt
 = -
EAFNOSUPPORT
;

1178 
	`rcu_ªad_u∆ock_bh
();

1179 
out_ªt_îr‹
;

1180 
	}
}

1181 
EXPORT_SYMBOL
(
ss_sock_¸óã
);

1188 
	$ss_ªÀa£
(
sock
 *
sk
)

1190 
	`WARN_ON_ONCE
(
	`sock_Êag
(
sk
, 
SOCK_LINGER
));

1192 
sk
->
sk_¥Ÿ
->
	`˛o£
(sk, 0);

1193 
	}
}

1194 
EXPORT_SYMBOL
(
ss_ªÀa£
);

1201 
	$ss_c⁄√˘
(
sock
 *
sk
, 
sockaddr
 *
uaddr
, 
uaddr_Àn
, 
Êags
)

1203 
r
;

1205 
	`WARN_ON_ONCE
((
sk
->
sk_Ámûy
 !
AF_INET
Ë&& (sk->sk_Ámûy !
AF_INET6
));

1206 
	`WARN_ON_ONCE
((
uaddr
->
ß_Ámûy
 !
AF_INET
)

1207 && (
uaddr
->
ß_Ámûy
 !
AF_INET6
));

1209 i‡(
uaddr_Àn
 < (
uaddr
->
ß_Ámûy
))

1210  -
EINVAL
;

1211 i‡(
sk
->
sk_°©e
 !
TCP_CLOSE
)

1212  -
EISCONN
;

1214 i‡(
	`ss_a˘ive_gu¨d_íãr
(
SS_V_ACT_LIVECONN
))

1215  
SS_SHUTDOWN
;

1217 
	`bh_lock_sock
(
sk
);

1218 
r
 = 
sk
->
sk_¥Ÿ
->
	`c⁄√˘
(sk, 
uaddr
, 
uaddr_Àn
);

1219 
	`bh_u∆ock_sock
(
sk
);

1226 i‡(
	`u∆ikñy
(
r
))

1227 
	`ss_a˘ive_gu¨d_exô
(
SS_V_ACT_LIVECONN
);

1229  
r
;

1230 
	}
}

1231 
EXPORT_SYMBOL
(
ss_c⁄√˘
);

1238 
	$ss_böd
(
sock
 *
sk
, 
sockaddr
 *
uaddr
, 
uaddr_Àn
)

1240 
sockë
 
sock
 = {

1241 .
sk
 = sk,

1242 .
ty≥
 = 
sk
->
sk_ty≥


1245 
	`WARN_ON_ONCE
((
sk
->
sk_Ámûy
 !
AF_INET
Ë&& (sk->sk_Ámûy !
AF_INET6
));

1246 
	`WARN_ON_ONCE
(
sk
->
sk_ty≥
 !
SOCK_STREAM
);

1248 i‡(
sk
->
sk_Ámûy
 =
AF_INET
)

1249  
	`öë_böd
(&
sock
, 
uaddr
, 
uaddr_Àn
);

1251  
	`öë6_böd
(&
sock
, 
uaddr
, 
uaddr_Àn
);

1252 
	}
}

1253 
EXPORT_SYMBOL
(
ss_böd
);

1260 
	$ss_li°í
(
sock
 *
sk
, 
backlog
)

1262 
sockë
 
sock
 = {

1263 .
sk
 = sk,

1264 .
ty≥
 = 
sk
->
sk_ty≥
,

1265 .
°©e
 = 
SS_UNCONNECTED


1268 
	`WARN_ON_ONCE
(
sk
->
sk_ty≥
 !
SOCK_STREAM
);

1270  
	`öë_li°í
(&
sock
, 
backlog
);

1271 
	}
}

1272 
EXPORT_SYMBOL
(
ss_li°í
);

1280 
	$ss_gë≥î«me
(
sock
 *
sk
, 
TfwAddr
 *
addr
)

1282 
öë_sock
 *
öë
 = 
	`öë_sk
(
sk
);

1284 i‡(
	`u∆ikñy
(!
öë
->
öë_dp‹t


1285 || ((1 << 
sk
->
sk_°©e
Ë& (
TCPF_CLOSE
 | 
TCPF_SYN_SENT
))))

1286 
	`TFW_WARN
("%s: bad sockë dp‹t=%x sèã=%x\n", 
__func__
,

1287 
öë
->
öë_dp‹t
, 
sk
->
sk_°©e
);

1289 
addr
->
Ámûy
 = 
AF_INET6
;

1290 
addr
->
v6
.
sö6_p‹t
 = 
öë
->
öë_•‹t
;

1291 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

1292 i‡(
	`öë6_sk
(
sk
)) {

1293 
ùv6_pöfo
 *
≈
 = 
	`öë6_sk
(
sk
);

1294 
addr
->
v6
.
sö6_addr
 = 
sk
->
sk_v6_daddr
;

1295 
addr
->
v6
.
sö6_Êowöfo
 = 
≈
->
¢dÊow
 ?Çp->
Êow_œbñ
 : 0;

1296 
addr
->
ö6_¥efix
 = 
	`ùv6_iÁ˚_sc›e_id
(&addr->
v6
.
sö6_addr
,

1297 
sk
->
sk_bound_dev_if
);

1301 
	`ùv6_addr_£t_v4m≠≥d
(
öë
->
öë_daddr
, &
addr
->
v6
.
sö6_addr
);

1302 
addr
->
v6
.
sö6_Êowöfo
 = 0;

1303 
addr
->
ö6_¥efix
 = 0;

1305 
	}
}

1306 
EXPORT_SYMBOL
(
ss_gë≥î«me
);

1308 
	#__sk_˛o£_locked
(
sk
) \

1310 
	`ss_do_˛o£
(
sk
); \

1311 
	`bh_u∆ock_sock
(
sk
); \

1312 
	`SS_CALL_GUARD_EXIT
(
c⁄√˘i⁄_dr›
, 
sk
); \

1313 
	`sock_put
(
sk
); \

1314 } 0)

	)

1317 
	$ss_tx_a˘i⁄
()

1319 
SsW‹k
 
sw
;

1320 
sk_buff
 *
skb
;

1321 
tickë
 = 0;

1322 
budgë
;

1329 
budgë
 = 
	`max
(10UL, 
	`ss_˛o£_q_sz
());

1330 (!
	`ss_a˘ive
(Ë|| 
budgë
--Ë&& !
	`ss_wq_p›
(&
sw
, &
tickë
)) {

1331 
sock
 *
sk
 = 
sw
.sk;

1333 
	`bh_lock_sock
(
sk
);

1334 i‡(
	`sock_Êag
(
sk
, 
SOCK_DEAD
)) {

1336 
	`bh_u∆ock_sock
(
sk
);

1337 
dód_sock
;

1339 
sw
.
a˘i⁄
) {

1340 
SS_SEND
:

1341 
	`ss_do_£nd
(
sk
, &
sw
.
skb_hód
, sw.
Êags
);

1342 i‡(!(
sw
.
Êags
 & 
SS_F_CONN_CLOSE
)) {

1343 
	`bh_u∆ock_sock
(
sk
);

1346 
	`__sk_˛o£_locked
(
sk
);

1348 
SS_CLOSE
:

1349 i‡(!((1 << 
sk
->
sk_°©e
)

1350 & (
TCPF_ESTABLISHED
 | 
TCPF_SYN_SENT
)))

1352 
	`TFW_DBG2
("[%d]: %s: Socket inactive: sk %p\n",

1353 
	`smp_¥o˚ss‹_id
(), 
__func__
, 
sk
);

1354 
	`bh_u∆ock_sock
(
sk
);

1357 
	`__sk_˛o£_locked
(
sk
);

1360 
	`BUG
();

1362 
dód_sock
:

1363 
	`sock_put
(
sk
);

1364 (
skb
 = 
	`ss_skb_dequeue
(&
sw
.
skb_hód
)))

1365 
	`k‰ì_skb
(
skb
);

1373 i‡(!
budgë
)

1374 
	`øi£_so·úq
(
NET_TX_SOFTIRQ
);

1375 
	}
}

1387 
	$ss_gë_°©
(
SsSèt
 *
°©
)

1389 
˝u
;

1391 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1392 
SsClo£Backlog
 *
cb
 = &
	`≥r_˝u
(
˛o£_backlog
, 
˝u
);

1393 
TfwRBQueue
 *
wq
 = &
	`≥r_˝u
(
si_wq
, 
˝u
);

1395 
°©
[
˝u
].
rb_wq_sz
 = 
	`tfw_wq_size
(
wq
);

1396 
°©
[
˝u
].
backlog_sz
 = 
cb
->
size
;

1398 
	}
}

1406 
	$ss_waô_√wc⁄n
()

1408 
˝u
;

1409 
acc
 = 0, 
acc_ﬁd
 = 0;

1410 
t0
 = 
jiffõs
;

1412 
	`might_¶ìp
();

1414 
	`scheduÀ
();

1415 
	`f‹_óch_⁄löe_˝u
(
˝u
)

1416 
acc
 +
	`©omic64_ªad
(
	`≥r_˝u_±r
(&
__ss_a˘_˙t
, 
˝u
));

1417 
	`BUG_ON
(
acc
 < 0);

1418 i‡(!(
acc
 & 
SS_M_ACT_NEWCONN
))

1420 i‡(
acc
 =
acc_ﬁd
) {

1421 i‡(
t0
 + 
HZ
 * 5 < 
jiffõs
) {

1422 
	`TFW_WARN
("pendingÜistening sockets for 5s"

1423 " (c⁄√˘i⁄†cou¡ %#lx)\n", 
acc
);

1427 
acc_ﬁd
 = 
acc
;

1428 
acc
 = 0;

1431 
	}
}

1432 
EXPORT_SYMBOL
(
ss_waô_√wc⁄n
);

1441 
	$ss_synchr⁄ize
()

1443 
˝u
, 
wq_acc
 = 0, 
wq_acc_ﬁd
 = 0;

1444 
acc
 = 0, 
acc_ﬁd
 = 0;

1445 
t0
 = 
jiffõs
;

1447 
	`might_¶ìp
();

1449 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1450 
n_c⁄n
 = 
	`©omic64_ªad
(&
	`≥r_˝u
(
__ss_a˘_˙t
, 
˝u
));

1451 
n_q
 = 
	`__ss_˛o£_q_sz
(
˝u
);

1452 i‡(
n_c⁄n
 + 
n_q
) {

1453 
	`úq_w‹k_sync
(&
	`≥r_˝u
(
ùi_w‹k
, 
˝u
));

1454 
	`scheduÀ
();

1456 
acc
 +
n_c⁄n
;

1457 
wq_acc
 +
n_q
;

1459 
	`BUG_ON
(
acc
 < 0);

1460 i‡(!
acc
 && !
wq_acc
)

1462 i‡(
acc
 =
acc_ﬁd
 && 
wq_acc
 =
wq_acc_ﬁd
) {

1463 i‡(
t0
 + 
HZ
 * 5 < 
jiffõs
) {

1464 
	`TFW_WARN
("pendingáctive connections for 5s"

1466 " queue†cou¡ %d)\n", 
acc
, 
wq_acc
);

1467 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1468 
TfwRBQueue
 *
wq
 = &
	`≥r_˝u
(
si_wq
, 
˝u
);

1469 
SsClo£Backlog
 *
cb
;

1470 
cb
 = &
	`≥r_˝u
(
˛o£_backlog
, 
˝u
);

1471 
	`TFW_WARN
(" cpu %d(%d), backlog size %lu,"

1473 
˝u
, 
	`smp_¥o˚ss‹_id
(), 
cb
->
size
,

1474 
	`tfw_wq_size
(
wq
));

1476 
	`TFW_WARN
("MemoryÜeakage isÖossible\n");

1480 i‡(
acc
 + 
wq_acc
 < 
acc_ﬁd
 + 
wq_acc_ﬁd
) {

1482 
t0
 = 
jiffõs
;

1484 
acc_ﬁd
 = 
acc
;

1485 
wq_acc_ﬁd
 = 
wq_acc
;

1486 
acc
 = 
wq_acc
 = 0;

1488 
	}
}

1489 
EXPORT_SYMBOL
(
ss_synchr⁄ize
);

1502 
	$ss_°¨t
()

1508 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1510 
	`WRITE_ONCE
(
__ss_a˘ive
, 
åue
);

1511 
	}
}

1512 
EXPORT_SYMBOL
(
ss_°¨t
);

1515 
	$ss_°›
()

1517 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1519 
	`WRITE_ONCE
(
__ss_a˘ive
, 
Ál£
);

1520 
	}
}

1521 
EXPORT_SYMBOL
(
ss_°›
);

1523 
boﬁ


1524 
	$ss_a˘ive
()

1526  
	`READ_ONCE
(
__ss_a˘ive
);

1527 
	}
}

1528 
EXPORT_SYMBOL
(
ss_a˘ive
);

1530 
__öô


1531 
	$tfw_sync_sockë_öô
()

1533 
r
, 
˝u
;

1535 
	`TFW_WQ_CHECKSZ
(
SsW‹k
);

1536 
ss_cbacklog_ˇche
 = 
	`kmem_ˇche_¸óã
("ss_cbacklog_cache",

1537 (
SsCblNode
), 0, 0, 
NULL
);

1538 i‡(!
ss_cbacklog_ˇche
)

1539  -
ENOMEM
;

1540 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1541 
SsClo£Backlog
 *
cb
 = &
	`≥r_˝u
(
˛o£_backlog
, 
˝u
);

1542 
TfwRBQueue
 *
wq
 = &
	`≥r_˝u
(
si_wq
, 
˝u
);

1544 i‡((
r
 = 
	`tfw_wq_öô
(
wq
, 
	`˝u_to_node
(
˝u
)))) {

1545 
	`TFW_ERR_NL
("Cannot initialize softirqÅx work queue\n");

1546 
	`kmem_ˇche_de°roy
(
ss_cbacklog_ˇche
);

1547  
r
;

1549 
	`öô_úq_w‹k
(&
	`≥r_˝u
(
ùi_w‹k
, 
˝u
), 
ss_ùi
);

1551 
	`INIT_LIST_HEAD
(&
cb
->
hód
);

1552 
	`•ö_lock_öô
(&
cb
->
lock
);

1553 
cb
->
tu∫
 = 
LONG_MAX
;

1555 
	`ãm≥°a_£t_tx_a˘i⁄
(
ss_tx_a˘i⁄
);

1558 
	}
}

1561 
	$tfw_sync_sockë_exô
()

1563 
˝u
;

1565 
	`ãm≥°a_dñ_tx_a˘i⁄
();

1566 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

1567 
	`úq_w‹k_sync
(&
	`≥r_˝u
(
ùi_w‹k
, 
˝u
));

1568 
	`tfw_wq_de°roy
(&
	`≥r_˝u
(
si_wq
, 
˝u
));

1569 
	`ss_backlog_vÆid©e_˛ónup
(
˝u
);

1571 
	`kmem_ˇche_de°roy
(
ss_cbacklog_ˇche
);

1572 
	}
}

	@sock_clnt.c

23 
	~"ãm≥°a_fw.h
"

24 
	~"cfg.h
"

25 
	~"˛õ¡.h
"

26 
	~"c⁄√˘i⁄.h
"

27 
	~"hâp_limôs.h
"

28 
	~"log.h
"

29 
	~"¥ocfs.h
"

30 
	~"£rvî.h
"

31 
	~"sync_sockë.h
"

32 
	~"és.h
"

40 
kmem_ˇche
 *
	gtfw_˛i_c⁄n_ˇche
;

41 
kmem_ˇche
 *
	gtfw_és_c⁄n_ˇche
;

42 
	gtfw_˛i_cfg_ka_timeout
 = -1;

44 
ölöe
 
kmem_ˇche
 *

45 
	$tfw_˛i_ˇche
(
ty≥
)

47  
ty≥
 & 
TFW_FSM_HTTPS
 ?

48 
tfw_és_c⁄n_ˇche
 : 
tfw_˛i_c⁄n_ˇche
;

49 
	}
}

52 
	$tfw_sock_˛i_kì∑live_timî_cb
(
d©a
)

54 
TfwCliC⁄n
 *
˛i_c⁄n
 = (TfwCliC⁄¿*)
d©a
;

56 
	`TFW_DBG
("ClientÅimeoutÉnd\n");

63 i‡(
	`tfw_c⁄√˘i⁄_˛o£
((
TfwC⁄n
 *)
˛i_c⁄n
, 
Ál£
))

64 
	`mod_timî
(&
˛i_c⁄n
->
timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(1000));

65 
	}
}

67 
TfwCliC⁄n
 *

68 
	$tfw_˛i_c⁄n_Æloc
(
ty≥
)

70 
TfwCliC⁄n
 *
˛i_c⁄n
;

72 i‡(!(
˛i_c⁄n
 = 
	`kmem_ˇche_Æloc
(
	`tfw_˛i_ˇche
(
ty≥
), 
GFP_ATOMIC
)))

73  
NULL
;

75 
	`tfw_c⁄√˘i⁄_öô
((
TfwC⁄n
 *)
˛i_c⁄n
);

76 
	`INIT_LIST_HEAD
(&
˛i_c⁄n
->
£q_queue
);

77 
	`•ö_lock_öô
(&
˛i_c⁄n
->
£q_qlock
);

78 
	`•ö_lock_öô
(&
˛i_c⁄n
->
ªt_qlock
);

79 #ifde‡
CONFIG_LOCKDEP


86 
	`lockdï_öô_m≠
(&
˛i_c⁄n
->
ªt_qlock
.
dï_m≠
, "cli_conn->ret_qlock",

87 &
__lockdï_no_vÆid©e__
, 2);

90 
	`£tup_timî
(&
˛i_c⁄n
->
timî
,

91 
tfw_sock_˛i_kì∑live_timî_cb
,

92 ()
˛i_c⁄n
);

94  
˛i_c⁄n
;

95 
	}
}

98 
	$tfw_˛i_c⁄n_‰ì
(
TfwCliC⁄n
 *
˛i_c⁄n
)

100 
	`BUG_ON
(
	`timî_≥ndög
(&
˛i_c⁄n
->
timî
));

103 
	`tfw_c⁄√˘i⁄_vÆid©e_˛ónup
((
TfwC⁄n
 *)
˛i_c⁄n
);

104 
	`BUG_ON
(!
	`li°_em±y
(&
˛i_c⁄n
->
£q_queue
));

106 
	`kmem_ˇche_‰ì
(
	`tfw_˛i_ˇche
(
	`TFW_CONN_TYPE
(
˛i_c⁄n
)), cli_conn);

107 
	}
}

110 
	$tfw_˛i_c⁄n_ªÀa£
(
TfwCliC⁄n
 *
˛i_c⁄n
)

112 
	`dñ_timî_sync
(&
˛i_c⁄n
->
timî
);

114 i‡(
	`likñy
(
˛i_c⁄n
->
sk
))

115 
	`tfw_c⁄√˘i⁄_u∆ök_to_sk
((
TfwC⁄n
 *)
˛i_c⁄n
);

116 i‡(
	`likñy
(
˛i_c⁄n
->
≥î
))

117 
	`tfw_˛õ¡_put
((
TfwClõ¡
 *)
˛i_c⁄n
->
≥î
);

118 
	`tfw_˛i_c⁄n_‰ì
(
˛i_c⁄n
);

119 
	`TFW_INC_STAT_BH
(
˛¡
.
c⁄n_disc⁄√˘s
);

120 
	}
}

123 
	$tfw_˛i_c⁄n_£nd
(
TfwCliC⁄n
 *
˛i_c⁄n
, 
TfwMsg
 *
msg
)

125 
r
;

127 
r
 = 
	`tfw_c⁄√˘i⁄_£nd
((
TfwC⁄n
 *)
˛i_c⁄n
, 
msg
);

128 
	`mod_timî
(&
˛i_c⁄n
->
timî
,

129 
jiffõs
 + 
	`m£cs_to_jiffõs
(
tfw_˛i_cfg_ka_timeout
 * 1000));

131 i‡(
r
)

133 
	`TFW_DBG
("C™nŸ síd d©®tÿ˛õ¡ (%d)\n", 
r
);

135  
r
;

136 
	}
}

142 
	$tfw_sock_˛¡_√w
(
sock
 *
sk
)

144 
r
 = -
ENOMEM
;

145 
TfwClõ¡
 *
˛i
;

146 
TfwC⁄n
 *
c⁄n
;

147 
SsPrŸo
 *
li°í_sock_¥Ÿo
;

149 
	`TFW_DBG3
("√w clõ¡ sockë: sk=%p, sèã=%u\n", 
sk
, sk->
sk_°©e
);

150 
	`TFW_INC_STAT_BH
(
˛¡
.
c⁄n_©ãm±s
);

158 
li°í_sock_¥Ÿo
 = 
sk
->
sk_u£r_d©a
;

159 
	`tfw_c⁄√˘i⁄_u∆ök_‰om_sk
(
sk
);

161 
˛i
 = 
	`tfw_˛õ¡_obèö
(
sk
, 
NULL
);

162 i‡(!
˛i
) {

163 
	`TFW_ERR
("can't obtainá client forÅheÇew socket\n");

164  -
ENOENT
;

167 
c⁄n
 = (
TfwC⁄n
 *)
	`tfw_˛i_c⁄n_Æloc
(
li°í_sock_¥Ÿo
->
ty≥
);

168 i‡(!
c⁄n
) {

169 
	`TFW_ERR
("can'tállocateáÇew client connection\n");

170 
îr_˛õ¡
;

173 
	`ss_¥Ÿo_öhîô
(
li°í_sock_¥Ÿo
, &
c⁄n
->
¥Ÿo
, 
C⁄n_C t
);

175 
c⁄n
->
de°ru˘‹
 = (*)
tfw_˛i_c⁄n_ªÀa£
;

177 
r
 = 
	`tfw_c⁄√˘i⁄_√w
(
c⁄n
);

178 i‡(
r
) {

179 
	`TFW_ERR
("cannotÉstablisháÇew client connection\n");

180 
îr_c⁄n
;

183 #i‡
	`deföed
(
DEBUG
) && (DEBUG == 3)

184 
	`sock_£t_Êag
(
sk
, 
SOCK_DBG
);

188 
	`tfw_c⁄√˘i⁄_ªvive
(
c⁄n
);

189 
	`tfw_c⁄√˘i⁄_lök_to_sk
(
c⁄n
, 
sk
);

190 
	`tfw_c⁄√˘i⁄_lök_‰om_sk
(
c⁄n
, 
sk
);

191 
	`tfw_c⁄√˘i⁄_lök_≥î
(
c⁄n
, (
TfwPìr
 *)
˛i
);

193 
	`ss_£t_ˇŒbacks
(
sk
);

194 i‡(
	`TFW_CONN_TYPE
(
c⁄n
Ë& 
TFW_FSM_HTTPS
)

200 
c⁄n
->
sk
->
sk_wrôe_xmô
 = 
tfw_és_í¸y±
;

202 
	`TFW_DBG3
("new client socket isáccepted: sk=%p, conn=%p, cli=%p\n",

203 
sk
, 
c⁄n
, 
˛i
);

204 
	`TFW_INC_STAT_BH
(
˛¡
.
c⁄n_e°ablished
);

207 
îr_c⁄n
:

208 
	`tfw_˛i_c⁄n_‰ì
((
TfwCliC⁄n
 *)
c⁄n
);

209 
îr_˛õ¡
:

210 
	`tfw_˛õ¡_put
(
˛i
);

211  
r
;

212 
	}
}

219 
	$tfw_sock_˛¡_do_dr›
(
sock
 *
sk
, c⁄° *
msg
)

221 
TfwC⁄n
 *
c⁄n
 = 
sk
->
sk_u£r_d©a
;

223 
	`TFW_DBG3
("%s: close client socket: sk=%p, conn=%p, client=%p\n",

224 
msg
, 
sk
, 
c⁄n
, c⁄n->
≥î
);

231 
	`tfw_c⁄√˘i⁄_u∆ök_‰om_sk
(
sk
);

232 
	`tfw_c⁄√˘i⁄_u∆ök_‰om_≥î
(
c⁄n
);

233 
	`tfw_c⁄√˘i⁄_dr›
(
c⁄n
);

240 
	`tfw_c⁄√˘i⁄_put
(
c⁄n
);

241 
	}
}

248 
	$tfw_sock_˛¡_dr›
(
sock
 *
sk
)

250 
	`tfw_sock_˛¡_do_dr›
(
sk
, "connectionÜost");

251 
	}
}

258 
	$tfw_sock_˛¡_îr‹
(
sock
 *
sk
)

260 
	`tfw_sock_˛¡_do_dr›
(
sk
, "connectionÉrror");

261 
	}
}

263 c⁄° 
SsHooks
 
	gtfw_sock_˛¡_ss_hooks
 = {

264 .
c⁄√˘i⁄_√w
 = 
tfw_sock_˛¡_√w
,

265 .
	gc⁄√˘i⁄_dr›
 = 
tfw_sock_˛¡_dr›
,

266 .
	gc⁄√˘i⁄_îr‹
 = 
tfw_sock_˛¡_îr‹
,

267 .
	gc⁄√˘i⁄_ªcv
 = 
tfw_c⁄√˘i⁄_ªcv
,

271 
	$__˛i_c⁄n_˛o£_cb
(
TfwC⁄n
 *
c⁄n
)

278  
	`tfw_c⁄√˘i⁄_˛o£
(
c⁄n
, 
Ál£
);

279 
	}
}

282 
	$tfw_˛i_c⁄n_˛o£_Æl
(
TfwClõ¡
 *
˛i
)

284 
TfwC⁄n
 *
c⁄n
;

286  
	`tfw_≥î_f‹_óch_c⁄n
(
˛i
, 
c⁄n
, 
li°
, 
__˛i_c⁄n_˛o£_cb
);

287 
	}
}

295 
	#TFW_LISTEN_SOCK_BACKLOG_LEN
 1024

	)

307 
SsPrŸo
 
	m¥Ÿo
;

308 
sock
 *
	msk
;

309 
li°_hód
 
	mli°
;

310 
TfwAddr
 
	maddr
;

311 } 
	tTfwLi°íSock
;

319 
LIST_HEAD
(
tfw_li°í_socks
);

329 
	$tfw_li°í_sock_add
(c⁄° 
TfwAddr
 *
addr
, 
ty≥
)

331 
TfwLi°íSock
 *
ls
;

334 i‡(!(
ty≥
 =
TFW_FSM_HTTP
 ||Åy≥ =
TFW_FSM_HTTPS
))

335  -
EINVAL
;

338 
	`li°_f‹_óch_íåy
(
ls
, &
tfw_li°í_socks
, 
li°
) {

339 i‡(
	`tfw_addr_eq
(
addr
, &
ls
->addr)) {

340 
	`TFW_LOG_ADDR
("Du∂iˇãÜi°íî wôh", 
addr
);

341  -
EINVAL
;

345 
ls
 = 
	`kzÆloc
((*ls), 
GFP_KERNEL
);

346 i‡(!
ls
)

347  -
ENOMEM
;

349 i‡(
ty≥
 =
TFW_FSM_HTTP
)

350 
	`ss_¥Ÿo_öô
(&
ls
->
¥Ÿo
, &
tfw_sock_˛¡_ss_hooks
, 
C⁄n_HâpC t
);

351 i‡(
ty≥
 =
TFW_FSM_HTTPS
)

352 
	`ss_¥Ÿo_öô
(&
ls
->
¥Ÿo
, &
tfw_sock_˛¡_ss_hooks
, 
C⁄n_HâpsC t
);

354 
	`li°_add
(&
ls
->
li°
, &
tfw_li°í_socks
);

355 
ls
->
addr
 = *addr;

358 
	`tfw_˛assifõr_add_öp‹t
(
addr
->
v4
.
sö_p‹t
);

361 
	}
}

364 
	$tfw_li°í_sock_dñ_Æl
()

366 
TfwLi°íSock
 *
ls
, *
tmp
;

368 
	`li°_f‹_óch_íåy_ß„
(
ls
, 
tmp
, &
tfw_li°í_socks
, 
li°
) {

369 
	`BUG_ON
(
ls
->
sk
);

370 
	`k‰ì
(
ls
);

373 
	`INIT_LIST_HEAD
(&
tfw_li°í_socks
);

374 
	`tfw_˛assifõr_˛ónup_öp‹t
();

375 
	}
}

383 
	$tfw_li°í_sock_°¨t
(
TfwLi°íSock
 *
ls
)

385 
r
;

386 
sock
 *
sk
;

387 
TfwAddr
 *
addr
 = &
ls
->addr;

389 
	`TFW_LOG_ADDR
("O≥¿li°í sockë on", 
addr
);

391 
r
 = 
	`ss_sock_¸óã
(
addr
->
Ámûy
, 
SOCK_STREAM
, 
IPPROTO_TCP
, &
sk
);

392 i‡(
r
) {

393 
	`TFW_ERR_NL
("ˇn'à¸óãÜi°íög sockë (îr: %d)\n", 
r
);

394  
r
;

401 
ls
->
sk
 = sk;

402 
sk
->
sk_u£r_d©a
 = 
ls
;

408 
	`ss_£t_li°í
(
sk
);

410 
	`öë_sk
(
sk
)->
‰ìböd
 = 1;

411 
sk
->
sk_ªu£
 = 1;

412 
r
 = 
	`ss_böd
(
sk
, &
addr
->
ß
, 
	`tfw_addr_ß_Àn
(addr));

413 i‡(
r
) {

414 
	`TFW_ERR_ADDR
("ˇn'àbödÅo", 
addr
);

415  
r
;

418 
	`TFW_DBG
("°¨àli°íög o¿sockë: sk=%p\n", 
sk
);

419 
r
 = 
	`ss_li°í
(
sk
, 
TFW_LISTEN_SOCK_BACKLOG_LEN
);

420 i‡(
r
) {

421 
	`TFW_ERR_NL
("can'tÜisten on front-end socket sk=%p (%d)\n",

422 
sk
, 
r
);

423  
r
;

427 
	}
}

430 
	$tfw_sock_check_l°
(
TfwSîvî
 *
§v
)

432 
TfwLi°íSock
 *
ls
;

434 
	`TFW_DBG3
("Checking server....\n");

435 
	`li°_f‹_óch_íåy
(
ls
, &
tfw_li°í_socks
, 
li°
) {

436 
	`TFW_DBG3
("IteratingÜistener\n");

437 i‡(
	`tfw_addr_ifm©ch
(&
§v
->
addr
, &
ls
->addr))

438  -
EINVAL
;

441 
	}
}

450 
	$tfw_cfg›_li°í
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

452 
r
;

453 
p‹t
;

454 
TfwAddr
 
addr
;

455 c⁄° *
ö_°r
 = 
NULL
;

457 
r
 = 
	`tfw_cfg_check_vÆ_n
(
˚
, 1);

458 i‡(
r
)

459 
∑r£_îr
;

466 
ö_°r
 = 
˚
->
vÆs
[0];

467 
r
 = 
	`tfw_cfg_∑r£_öt
(
ö_°r
, &
p‹t
);

468 i‡(!
r
) {

469 
r
 = 
	`tfw_cfg_check_ønge
(
p‹t
, 0, 65535);

470 i‡(
r
)

471 
∑r£_îr
;

474 
addr
.
v4
.
sö_Ámûy
 = 
AF_INET
;

475 
addr
.
v4
.
sö_addr
.
s_addr
 = 
INADDR_ANY
;

476 
addr
.
v4
.
sö_p‹t
 = 
	`ht⁄s
(
p‹t
);

478 
r
 = 
	`tfw_addr_±⁄
(&
	`TFW_STR_FROM
(
ö_°r
), &
addr
);

479 i‡(
r
)

480 
∑r£_îr
;

483 
r
 = 
	`tfw_cfg_check_ønge
(
˚
->
©å_n
, 0, 1);

484 i‡(
r
)

485 
∑r£_îr
;

487 i‡(!
˚
->
©å_n
)

488  
	`tfw_li°í_sock_add
(&
addr
, 
TFW_FSM_HTTP
);

490 
ö_°r
 = 
	`tfw_cfg_gë_©å
(
˚
, "¥Ÿo", 
NULL
);

491 i‡(!
ö_°r
)

492 
∑r£_îr
;

494 i‡(!
	`°rˇ£cmp
(
ö_°r
, "http")) {

495  
	`tfw_li°í_sock_add
(&
addr
, 
TFW_FSM_HTTP
);

497 i‡(!
	`°rˇ£cmp
(
ö_°r
, "https")) {

498 
	`tfw_és_cfg_ªquúe
();

499  
	`tfw_li°í_sock_add
(&
addr
, 
TFW_FSM_HTTPS
);

502 
∑r£_îr
;

505 
∑r£_îr
:

506 
	`TFW_ERR_NL
("UnableÅoÖarse 'listen' value: '%s'\n",

507 
ö_°r
 ? in_str : "No value specified");

508  -
EINVAL
;

509 
	}
}

512 
	$tfw_cfg›_kì∑live_timeout
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

514 
r
;

516 i‡((
r
 = 
	`tfw_cfg_check_vÆ_n
(
˚
, 1)))

517  -
EINVAL
;

519 i‡((
r
 = 
	`tfw_cfg_∑r£_öt
(
˚
->
vÆs
[0], &
tfw_˛i_cfg_ka_timeout
))) {

520 
	`TFW_ERR_NL
("UnableÅoÖarse 'keepalive_timeout' value: '%s'\n",

521 
˚
->
vÆs
[0] ? : "No value specified");

522  -
EINVAL
;

525 i‡(
tfw_˛i_cfg_ka_timeout
 < 0) {

526 
	`TFW_ERR_NL
("UnableÅoÖarse 'keepalive_timeout' value: '%s'\n",

528  -
EINVAL
;

532 
	}
}

536 
	$tfw_cfg›_˛ónup_sock_˛¡
(
TfwCfgS≥c
 *
cs
)

538 
	`tfw_li°í_sock_dñ_Æl
();

539 
	}
}

542 
	$tfw_sock_˛¡_cfgíd
()

544 
r
;

546 
	`TFW_DBG
("Checking backendsándÜisteners\n");

547 i‡((
r
 = 
	`tfw_sg_f‹_óch_§v_ªc⁄fig
(
tfw_sock_check_l°
))) {

548 
	`TFW_ERR_NL
("One ofÅhe backends is Tempesta itself!"

550  
r
;

554 
	}
}

561 
	$tfw_sock_˛¡_°¨t
()

563 
r
;

564 
TfwLi°íSock
 *
ls
;

566 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

569 
	`li°_f‹_óch_íåy
(
ls
, &
tfw_li°í_socks
, 
li°
) {

570 i‡((
r
 = 
	`tfw_li°í_sock_°¨t
(
ls
))) {

571 
	`TFW_ERR_ADDR
("ˇn'à°¨àli°íög on", &
ls
->
addr
);

572  
r
;

577 
	}
}

580 
	$tfw_sock_˛¡_°›
()

582 
TfwLi°íSock
 *
ls
;

584 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

587 
	`might_¶ìp
();

590 
	`li°_f‹_óch_íåy
(
ls
, &
tfw_li°í_socks
, 
li°
) {

591 i‡(!
ls
->
sk
)

593 
	`ss_ªÀa£
(
ls
->
sk
);

594 
ls
->
sk
 = 
NULL
;

596 
	`ss_waô_√wc⁄n
();

605 
	`loˇl_bh_dißbÀ
();

606 
	`tfw_˛õ¡_f‹_óch
(
tfw_˛i_c⁄n_˛o£_Æl
)) {

613 
	`loˇl_bh_íabÀ
();

614 
	`scheduÀ
();

615 
	`loˇl_bh_dißbÀ
();

617 
	`loˇl_bh_íabÀ
();

618 
	}
}

620 
TfwCfgS≥c
 
	gtfw_sock_˛¡_•ecs
[] = {

622 .
«me
 = "listen",

623 .
	gdeÊt
 = "80",

624 .
	gh™dÀr
 = 
tfw_cfg›_li°í
,

625 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_sock_˛¡
,

626 .
	gÆlow_ª≥©
 = 
åue
,

629 .
	g«me
 = "keepalive_timeout",

630 .
	gdeÊt
 = "75",

631 .
	gh™dÀr
 = 
tfw_cfg›_kì∑live_timeout
,

632 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_sock_˛¡
,

633 .
	gÆlow_ª≥©
 = 
Ál£
,

638 
TfwMod
 
	gtfw_sock_˛¡_mod
 = {

639 .
«me
 = "sock_clnt",

640 .
	gcfgíd
 = 
tfw_sock_˛¡_cfgíd
,

641 .
	g°¨t
 = 
tfw_sock_˛¡_°¨t
,

642 .
	g°›
 = 
tfw_sock_˛¡_°›
,

643 .
	g•ecs
 = 
tfw_sock_˛¡_•ecs
,

653 
	$tfw_sock_˛¡_öô
()

659 
	`BUILD_BUG_ON
(
C⁄n_St›
 & (
C⁄n_C t
 |

660 
C⁄n_Srv
 |

661 
TFW_FSM_HTTP
 |

662 
TFW_FSM_HTTPS
));

663 
	`BUG_ON
(
tfw_˛i_c⁄n_ˇche
);

664 
	`BUG_ON
(
tfw_és_c⁄n_ˇche
);

666 
tfw_˛i_c⁄n_ˇche
 = 
	`kmem_ˇche_¸óã
("tfw_cli_conn_cache",

667 (
TfwCliC⁄n
), 0, 0, 
NULL
);

668 
tfw_és_c⁄n_ˇche
 = 
	`kmem_ˇche_¸óã
("tfw_tls_conn_cache",

669 (
TfwTlsC⁄n
), 0, 0, 
NULL
);

671 i‡(
tfw_˛i_c⁄n_ˇche
 && 
tfw_és_c⁄n_ˇche
) {

672 
	`tfw_mod_ªgi°î
(&
tfw_sock_˛¡_mod
);

676 i‡(
tfw_˛i_c⁄n_ˇche
)

677 
	`kmem_ˇche_de°roy
(
tfw_˛i_c⁄n_ˇche
);

678 i‡(
tfw_és_c⁄n_ˇche
)

679 
	`kmem_ˇche_de°roy
(
tfw_és_c⁄n_ˇche
);

681  -
ENOMEM
;

682 
	}
}

685 
	$tfw_sock_˛¡_exô
()

687 
	`tfw_mod_uƒegi°î
(&
tfw_sock_˛¡_mod
);

688 
	`kmem_ˇche_de°roy
(
tfw_és_c⁄n_ˇche
);

689 
	`kmem_ˇche_de°roy
(
tfw_˛i_c⁄n_ˇche
);

690 
	}
}

	@sock_srv.c

23 
	~<löux/√t.h
>

24 
	~<löux/waô.h
>

25 
	~<löux/‰ìzî.h
>

26 
	~<√t/öë_sock.h
>

28 
	~"≠m.h
"

29 
	~"ãm≥°a_fw.h
"

30 
	~"c⁄√˘i⁄.h
"

31 
	~"hâp_£ss.h
"

32 
	~"addr.h
"

33 
	~"log.h
"

34 
	~"£rvî.h
"

35 
	~"¥ocfs.h
"

123 c⁄° 
	gtfw_§v_tmo_vÆs
[] = { 1, 10, 100, 250, 500, 1000 };

130 
	$tfw_sock_§v_c⁄√˘_åy
(
TfwSrvC⁄n
 *
§v_c⁄n
)

132 
r
;

133 
TfwAddr
 *
addr
;

134 
sock
 *
sk
;

136 
addr
 = &
§v_c⁄n
->
≥î
->addr;

138 
r
 = 
	`ss_sock_¸óã
(
addr
->
Ámûy
, 
SOCK_STREAM
, 
IPPROTO_TCP
, &
sk
);

139 i‡(
r
) {

140 
	`TFW_ERR
("UnableÅo create server socket\n");

153 #i‡
	`deföed
(
DEBUG
) && (DEBUG >= 2)

154 
	`sock_£t_Êag
(
sk
, 
SOCK_DBG
);

156 
	`tfw_c⁄√˘i⁄_lök_‰om_sk
((
TfwC⁄n
 *)
§v_c⁄n
, 
sk
);

157 
	`tfw_c⁄√˘i⁄_lök_to_sk
((
TfwC⁄n
 *)
§v_c⁄n
, 
sk
);

158 
	`tfw_§v_c⁄n_öô_as_dód
(
§v_c⁄n
);

159 
	`ss_£t_ˇŒbacks
(
sk
);

164 
§v_c⁄n
->
de°ru˘‹
 = (*)
tfw_§v_c⁄n_ªÀa£
;

181 
	`TFW_INC_STAT_BH
(
£rv
.
c⁄n_©ãm±s
);

182 
r
 = 
	`ss_c⁄√˘
(
sk
, &
addr
->
ß
, 
	`tfw_addr_ß_Àn
(addr), 0);

183 i‡(
r
) {

184 i‡(
r
 !
SS_SHUTDOWN
)

185 
	`TFW_ERR
("UnableÅo initiateá connectÅo server: %d\n",

186 
r
);

187 
	`tfw_c⁄√˘i⁄_˛o£
((
TfwC⁄n
 *)
§v_c⁄n
, 
åue
);

188 
	`SS_CALL
(
c⁄√˘i⁄_îr‹
, 
sk
);

191 
	}
}

222 
ölöe
 

223 
	$tfw_sock_§v_c⁄√˘_åy_œãr
(
TfwSrvC⁄n
 *
§v_c⁄n
)

225 
timeout
;

228 i‡(
	`u∆ikñy
(!
	`ss_a˘ive
()))

231 i‡(
§v_c⁄n
->
ª˙s
 < 
	`ARRAY_SIZE
(
tfw_§v_tmo_vÆs
)) {

232 i‡(
§v_c⁄n
->
ª˙s
)

233 
	`TFW_DBG_ADDR
("CannotÉstablish connection",

234 &
§v_c⁄n
->
≥î
->
addr
);

235 
timeout
 = 
tfw_§v_tmo_vÆs
[
§v_c⁄n
->
ª˙s
];

237 i‡(
§v_c⁄n
->
ª˙s
 =
	`ARRAY_SIZE
(
tfw_§v_tmo_vÆs
)

238 || !(
§v_c⁄n
->
ª˙s
 % 60))

240 
addr_°r
[
TFW_ADDR_STR_BUF_SIZE
] = { 0 };

241 
	`tfw_addr_fmt_v6
(&
§v_c⁄n
->
≥î
->
addr
.
v6
.
sö6_addr
,

242 0, 
addr_°r
);

243 
	`TFW_WARN
("CannotÉstablish connection with %s in %u"

245 
addr_°r
, 
§v_c⁄n
->
ª˙s
);

248 
	`tfw_c⁄√˘i⁄_ª∑ú
((
TfwC⁄n
 *)
§v_c⁄n
);

249 
timeout
 = 
tfw_§v_tmo_vÆs
[
	`ARRAY_SIZE
(tfw_srv_tmo_vals) - 1];

251 
§v_c⁄n
->
ª˙s
++;

253 
	`mod_timî
(&
§v_c⁄n
->
timî
, 
jiffõs
 + 
	`m£cs_to_jiffõs
(
timeout
));

254 
	}
}

257 
	$tfw_sock_§v_c⁄√˘_ªåy_timî_cb
(
d©a
)

259 
TfwSrvC⁄n
 *
§v_c⁄n
 = (TfwSrvC⁄¿*)
d©a
;

262 
	`tfw_sock_§v_c⁄√˘_åy
(
§v_c⁄n
);

263 
	}
}

265 
ölöe
 

266 
	$__ª£t_ªåy_timî
(
TfwSrvC⁄n
 *
§v_c⁄n
)

268 
§v_c⁄n
->
ª˙s
 = 0;

269 
	}
}

271 
ölöe
 

272 
	$__£tup_ªåy_timî
(
TfwSrvC⁄n
 *
§v_c⁄n
)

274 
	`__ª£t_ªåy_timî
(
§v_c⁄n
);

275 
	`£tup_timî
(&
§v_c⁄n
->
timî
,

276 
tfw_sock_§v_c⁄√˘_ªåy_timî_cb
,

277 ()
§v_c⁄n
);

278 
	}
}

280 
ölöe
 

281 
	$tfw_§v_ª£t_cfg_a˘i⁄s
(
TfwSîvî
 *
§v
)

283 
Êags
, 
√w_Êags
;

286 
√w_Êags
 = 
Êags
 = 
	`READ_ONCE
(
§v
->flags);

287 
√w_Êags
 &~
TFW_CFG_M_ACTION
;

288 } 
	`cmpxchg
(&
§v
->
Êags
, fœgs, 
√w_Êags
) != flags);

289 
	}
}

292 
	$tfw_§v_c⁄n_ªÀa£
(
TfwSrvC⁄n
 *
§v_c⁄n
)

294 
	`tfw_c⁄√˘i⁄_ªÀa£
((
TfwC⁄n
 *)
§v_c⁄n
);

300 i‡(
	`likñy
(
§v_c⁄n
->
sk
))

301 
	`tfw_c⁄√˘i⁄_u∆ök_to_sk
((
TfwC⁄n
 *)
§v_c⁄n
);

315 i‡(
	`likñy
(!
	`ã°_bô
(
TFW_CONN_B_DEL
, &
§v_c⁄n
->
Êags
)))

316 
	`tfw_sock_§v_c⁄√˘_åy_œãr
(
§v_c⁄n
);

317 i‡(
	`ã°_bô
(
TFW_CONN_B_ACTIVE
, &
§v_c⁄n
->
Êags
))

318 
	`tfw_£rvî_put
((
TfwSîvî
 *)
§v_c⁄n
->
≥î
);

319 
	}
}

325 
	$tfw_sock_§v_c⁄√˘_com∂ëe
(
sock
 *
sk
)

327 
r
;

328 
TfwC⁄n
 *
c⁄n
 = 
sk
->
sk_u£r_d©a
;

329 
TfwSîvî
 *
§v
 = (TfwSîvî *)
c⁄n
->
≥î
;

331 
	`BUG_ON
(
c⁄n
->
sk
 != sk);

334 i‡((
r
 = 
	`tfw_c⁄√˘i⁄_√w
(
c⁄n
))) {

335 
	`TFW_ERR
("conn_init() hookÑeturnedÉrror\n");

336  
r
;

340 
	`tfw_c⁄√˘i⁄_ªvive
(
c⁄n
);

343 i‡(
	`u∆ikñy
(
	`tfw_§v_c⁄n_ª°ri˘ed
((
TfwSrvC⁄n
 *)
c⁄n
)))

344 
	`tfw_c⁄√˘i⁄_ª∑ú
(
c⁄n
);

346 
	`__ª£t_ªåy_timî
((
TfwSrvC⁄n
 *)
c⁄n
);

348 
	`TFW_DBG_ADDR
("c⁄√˘ed", &
§v
->
addr
);

349 
	`TFW_INC_STAT_BH
(
£rv
.
c⁄n_e°ablished
);

352 
	}
}

360 
	$tfw_sock_§v_c⁄√˘_dr›
(
sock
 *
sk
)

362 
TfwC⁄n
 *
c⁄n
 = 
sk
->
sk_u£r_d©a
;

364 
	`TFW_INC_STAT_BH
(
£rv
.
c⁄n_disc⁄√˘s
);

365 
	`tfw_c⁄√˘i⁄_dr›
(
c⁄n
);

366 
	`tfw_c⁄√˘i⁄_put
(
c⁄n
);

367 
	}
}

377 
	$tfw_sock_§v_c⁄√˘_Áûovî
(
sock
 *
sk
)

379 
TfwC⁄n
 *
c⁄n
 = 
sk
->
sk_u£r_d©a
;

380 
TfwSîvî
 *
§v
 = (TfwSîvî *)
c⁄n
->
≥î
;

382 
	`TFW_DBG_ADDR
("c⁄√˘i⁄Éº‹", &
§v
->
addr
);

388 i‡(
	`tfw_c⁄√˘i⁄_live
(
c⁄n
)) {

389 
	`TFW_INC_STAT_BH
(
£rv
.
c⁄n_disc⁄√˘s
);

390 
	`tfw_c⁄√˘i⁄_put_to_dóth
(
c⁄n
);

391 
	`tfw_c⁄√˘i⁄_dr›
(
c⁄n
);

394 
	`tfw_c⁄√˘i⁄_u∆ök_‰om_sk
(
sk
);

395 
	`tfw_c⁄√˘i⁄_put
(
c⁄n
);

396 
	}
}

398 c⁄° 
SsHooks
 
	gtfw_sock_§v_ss_hooks
 = {

399 .
c⁄√˘i⁄_√w
 = 
tfw_sock_§v_c⁄√˘_com∂ëe
,

400 .
	gc⁄√˘i⁄_dr›
 = 
tfw_sock_§v_c⁄√˘_dr›
,

401 .
	gc⁄√˘i⁄_îr‹
 = 
tfw_sock_§v_c⁄√˘_Áûovî
,

402 .
	gc⁄√˘i⁄_ªcv
 = 
tfw_c⁄√˘i⁄_ªcv
,

437 
	$tfw_sock_§v_disc⁄√˘
(
TfwC⁄n
 *
c⁄n
)

439 
ªt
 = 0;

440 
TfwSrvC⁄n
 *
§v_c⁄n
 = (TfwSrvC⁄¿*)
c⁄n
;

443 i‡(
	`ã°_bô
(
TFW_CONN_B_DEL
, &
§v_c⁄n
->
Êags
))

447 
	`dñ_timî_sync
(&
c⁄n
->
timî
);

448 
	`£t_bô
(
TFW_CONN_B_DEL
, &
§v_c⁄n
->
Êags
);

455 i‡(
	`©omic_ªad
(&
c⁄n
->
ªf˙t
Ë!
TFW_CONN_DEATHCNT
)

456 
ªt
 = 
	`tfw_c⁄√˘i⁄_˛o£
(
c⁄n
, 
åue
);

458 
	`tfw_§v_c⁄n_ªÀa£
(
§v_c⁄n
);

460  
ªt
;

461 
	}
}

483 
ölöe
 

484 
	$tfw_sock_§v_c⁄n_a˘iv©e
(
TfwSîvî
 *
§v
, 
TfwSrvC⁄n
 *
§v_c⁄n
)

486 
	`tfw_£rvî_gë
(
§v
);

487 
	`£t_bô
(
TFW_CONN_B_ACTIVE
, &
§v_c⁄n
->
Êags
);

488 
	}
}

491 
	$tfw_sock_§v_c⁄√˘_§v
(
TfwSîvî
 *
§v
)

493 
TfwSrvC⁄n
 *
§v_c⁄n
;

503 
	`li°_f‹_óch_íåy
(
§v_c⁄n
, &
§v
->
c⁄n_li°
, 
li°
) {

504 
	`tfw_sock_§v_c⁄n_a˘iv©e
(
§v
, 
§v_c⁄n
);

505 
	`tfw_sock_§v_c⁄√˘_åy_œãr
(
§v_c⁄n
);

507 
	}
}

519 
	$tfw_sock_§v_disc⁄√˘_§v
(
TfwSîvî
 *
§v
)

521 
TfwC⁄n
 *
c⁄n
;

523  
	`tfw_≥î_f‹_óch_c⁄n
(
§v
, 
c⁄n
, 
li°
,

524 
tfw_sock_§v_disc⁄√˘
);

525 
	}
}

543 
kmem_ˇche
 *
	gtfw_§v_c⁄n_ˇche
;

545 
TfwSrvC⁄n
 *

546 
	$tfw_§v_c⁄n_Æloc
()

548 
TfwSrvC⁄n
 *
§v_c⁄n
;

550 
	`might_¶ìp
();

551 i‡(!(
§v_c⁄n
 = 
	`kmem_ˇche_Æloc
(
tfw_§v_c⁄n_ˇche
, 
GFP_KERNEL
)))

552  
NULL
;

554 
	`tfw_c⁄√˘i⁄_öô
((
TfwC⁄n
 *)
§v_c⁄n
);

555 
	`mem£t
((*)
§v_c⁄n
 + (
TfwC⁄n
), 0,

556 (
TfwSrvC⁄n
Ë- (
TfwC⁄n
));

557 
	`INIT_LIST_HEAD
(&
§v_c⁄n
->
fwd_queue
);

558 
	`INIT_LIST_HEAD
(&
§v_c⁄n
->
nù_queue
);

559 
	`•ö_lock_öô
(&
§v_c⁄n
->
fwd_qlock
);

565 
	`©omic_£t
(&
§v_c⁄n
->
ªf˙t
, 
TFW_CONN_DEATHCNT
);

567 
	`__£tup_ªåy_timî
(
§v_c⁄n
);

568 
	`ss_¥Ÿo_öô
(&
§v_c⁄n
->
¥Ÿo
, &
tfw_sock_§v_ss_hooks
, 
C⁄n_HâpSrv
);

570  
§v_c⁄n
;

571 
	}
}

574 
	$tfw_§v_c⁄n_‰ì
(
TfwSrvC⁄n
 *
§v_c⁄n
)

576 
	`BUG_ON
(
	`timî_≥ndög
(&
§v_c⁄n
->
timî
));

579 
	`tfw_c⁄√˘i⁄_vÆid©e_˛ónup
((
TfwC⁄n
 *)
§v_c⁄n
);

580 
	`BUG_ON
(!
	`li°_em±y
(&
§v_c⁄n
->
nù_queue
));

581 
	`BUG_ON
(
	`ACCESS_ONCE
(
§v_c⁄n
->
qsize
));

583 
	`kmem_ˇche_‰ì
(
tfw_§v_c⁄n_ˇche
, 
§v_c⁄n
);

584 
	}
}

586 
TfwSrvC⁄n
 *

587 
	$tfw_sock_§v_√w_c⁄n
(
TfwSîvî
 *
§v
)

589 
TfwSrvC⁄n
 *
§v_c⁄n
;

591 i‡(!(
§v_c⁄n
 = 
	`tfw_§v_c⁄n_Æloc
()))

592  
NULL
;

593 
	`tfw_c⁄√˘i⁄_lök_≥î
((
TfwC⁄n
 *)
§v_c⁄n
, (
TfwPìr
 *)
§v
);

595  
§v_c⁄n
;

596 
	}
}

599 
	$tfw_sock_§v_≠≥nd_c⁄ns_n
(
TfwSîvî
 *
§v
, 
size_t
 
c⁄n_n
)

601 
i
;

602 
TfwSrvC⁄n
 *
§v_c⁄n
;

604 
i
 = 0; i < 
c⁄n_n
; ++i) {

605 i‡(!(
§v_c⁄n
 = 
	`tfw_sock_§v_√w_c⁄n
(
§v
)))

606  -
ENOMEM
;

607 
	`tfw_sock_§v_c⁄n_a˘iv©e
(
§v
, 
§v_c⁄n
);

608 
	`tfw_sock_§v_c⁄√˘_åy_œãr
(
§v_c⁄n
);

609 
	`tfw_§v_lo›_sched_rcu
();

613 
	}
}

616 
	$tfw_sock_§v_add_c⁄ns
(
TfwSîvî
 *
§v
)

618 
i
;

620 
i
 = 0; i < 
§v
->
c⁄n_n
; ++i)

621 i‡(!(
	`tfw_sock_§v_√w_c⁄n
(
§v
)))

622  -
ENOMEM
;

625 
	}
}

628 
	$tfw_sock_§v_dñ_c⁄ns
(*
p§v
)

630 
TfwSrvC⁄n
 *
§v_c⁄n
, *
tmp
;

631 
TfwSîvî
 *
§v
 = 
p§v
;

633 
	`li°_f‹_óch_íåy_ß„
(
§v_c⁄n
, 
tmp
, &
§v
->
c⁄n_li°
, 
li°
) {

634 
	`tfw_c⁄√˘i⁄_u∆ök_‰om_≥î
((
TfwC⁄n
 *)
§v_c⁄n
);

635 
	`tfw_§v_c⁄n_‰ì
(
§v_c⁄n
);

637 
	}
}

640 
	$tfw_sock_§v_°¨t_§v
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
, *
hm
)

642 
r
;

644 
	`TFW_DBG_ADDR
("°¨à£rvî", &
§v
->
addr
);

646 i‡((
r
 = 
	`tfw_sock_§v_add_c⁄ns
(
§v
))) {

647 
	`TFW_ERR_ADDR
("ˇ¬ŸáŒoˇã sîvî c⁄√˘i⁄s", &
§v
->
addr
);

648  
r
;

650 i‡((
r
 = 
	`tfw_≠m_add_§v
(
§v
))) {

651 
	`TFW_ERR_ADDR
("ˇ¬Ÿ inôülizêAPM f‹ sîvî", &
§v
->
addr
);

652  
r
;

654 
	`tfw_sock_§v_c⁄√˘_§v
(
§v
);

655 i‡(
hm
)

656 
	`tfw_≠m_hm_íabÀ_§v
(
§v
, 
hm
);

659 
	}
}

667 
	gtfw_cfg_gø˚_time
 = 0;

669 
LIST_HEAD
(
tfw_gs_£rvîs
);

670 
DEFINE_SPINLOCK
(
tfw_gs_lock
);

673 
	$tfw_sock_§v_gø˚_li°_add
(
TfwSîvî
 *
§v
)

675 
	`•ö_lock
(&
tfw_gs_lock
);

677 
	`tfw_£rvî_gë
(
§v
);

678 
	`li°_add
(&
§v
->
li°
, &
tfw_gs_£rvîs
);

680 
	`•ö_u∆ock
(&
tfw_gs_lock
);

681 
	}
}

684 
	$tfw_sock_§v_gø˚_li°_dñ
(
TfwSîvî
 *
§v
)

686 
	`•ö_lock
(&
tfw_gs_lock
);

688 
	`li°_dñ_öô
(&
§v
->
li°
);

689 
	`tfw_£rvî_put
(
§v
);

691 
	`•ö_u∆ock
(&
tfw_gs_lock
);

692 
	}
}

695 
	$tfw_sock_§v_gø˚_°›
(
TfwSîvî
 *
§v
)

697 
	`tfw_£rvî_°›_sched
(
§v
);

698 
	`tfw_sock_§v_disc⁄√˘_§v
(
§v
);

699 
	`tfw_sock_§v_gø˚_li°_dñ
(
§v
);

700 
	}
}

703 
	$tfw_sock_§v_gø˚_shutdown_cb
(
d©a
)

705 
TfwSîvî
 *
§v
 = (TfwSîvî *)
d©a
;

707 
	`tfw_sock_§v_gø˚_°›
(
§v
);

708 
	}
}

718 
	$tfw_sock_§v_gø˚_shutdown_§v
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
, *
d©a
)

720 
r
 = 0;

722 
	`tfw_£rvî_gë
(
§v
);

723 
	`__tfw_sg_dñ_§v
(
sg
, 
§v
, 
Ál£
);

724 
	`£t_bô
(
TFW_CFG_B_DEL
, &
§v
->
Êags
);

726 i‡(!
tfw_cfg_gø˚_time
) {

727 
r
 = 
	`tfw_sock_§v_disc⁄√˘_§v
(
§v
);

729 i‡((
§v
->
sg
->
Êags
 & 
TFW_SRV_STICKY
) &&

730 
	`©omic64_ªad
(&
§v
->
£ss_n
))

732 
	`tfw_£rvî_°¨t_sched
(
§v
);

734 
	`£tup_timî
(&
§v
->
gs_timî
, 
tfw_sock_§v_gø˚_shutdown_cb
,

735 ()
§v
);

736 
	`tfw_sock_§v_gø˚_li°_add
(
§v
);

737 
	`mod_timî
(&
§v
->
gs_timî
, 
jiffõs
 + 
tfw_cfg_gø˚_time
 * 
HZ
);

739 
	`tfw_£rvî_put
(
§v
);

741  
r
;

742 
	}
}

745 
	$tfw_sock_§v_gø˚_shutdown_sg
(
TfwSrvGroup
 *
sg
)

747 
	`tfw_sg_°›_sched
(
sg
);

748 
	`__tfw_sg_f‹_óch_§v
(
sg
, 
tfw_sock_§v_gø˚_shutdown_§v
, 
NULL
);

749 
	`tfw_sg_put
(
sg
);

750 
	}
}

756 
	$tfw_sock_§v_gø˚_shutdown_now
()

759 
TfwSîvî
 *
§v
;

761 
	`•ö_lock
(&
tfw_gs_lock
);

762 
§v
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
tfw_gs_£rvîs
, 
TfwSîvî
, 
li°
);

763 i‡(
§v
)

764 
	`tfw_£rvî_gë
(
§v
);

765 
	`•ö_u∆ock
(&
tfw_gs_lock
);

767 i‡(!
§v
)

770 i‡(
	`dñ_timî_sync
(&
§v
->
gs_timî
))

771 
	`tfw_sock_§v_gø˚_°›
(
§v
);

772 
	`tfw_£rvî_put
(
§v
);

773 
	`tfw_§v_lo›_sched_rcu
();

775 
	}
}

782 
kmem_ˇche
 *
	gtfw_sg_cfg_ˇche
;

784 
	#TFW_CFG_DFLT_VAL
 "__dÊtvÆ__"

	)

785 
	#TFW_CFG_SG_DFT_NAME
 "deÁu…"

	)

787 
	#TFW_CFG_SG_OPTS_NAME
 "__dÊt›ts__"

	)

790 
	#TFW_CFG_MDF_SG_SRV
 0x1

	)

792 
	#TFW_CFG_MDF_SG_SCHED
 0x2

	)

839 
TfwSrvGroup
 *
	m‹ig_sg
;

840 
TfwSrvGroup
 *
	m∑r£d_sg
;

841 
li°_hód
 
	mli°
;

842 
	mªc⁄f_Êags
;

843 
	mnù_Êags
;

844 
	m°icky_Êags
;

845 
	msched_Êags
;

846 *
	msched_¨g
;

847 *
	mhm_«me
;

848 *
	mhm_¨g
;

849 } 
	tTfwCfgSrvGroup
;

852 
TfwCfgSrvGroup
 *
	gtfw_cfg_sg
 = 
NULL
;

854 
TfwCfgSrvGroup
 *
	gtfw_cfg_sg_def
 = 
NULL
;

860 
TfwCfgSrvGroup
 *
	gtfw_cfg_sg_›ts
 = 
NULL
;

863 
LIST_HEAD
(
sg_cfg_li°
);

866 
boﬁ
 
	gtfw_cfg_u£_°icky_£ss
;

869 
	gtfw_cfg_gø˚_time_ªc⁄fig
 = 0;

872 
boﬁ
 
	mmax_qsize
 : 1;

873 
boﬁ
 
	mmax_ªfwd
 : 1;

874 
boﬁ
 
	mmax_jqage
 : 1;

875 
boﬁ
 
	mmax_ª˙s
 : 1;

876 
boﬁ
 
	mnù_Êags
 : 1;

877 
boﬁ
 
	m°icky_Êags
 : 1;

878 
boﬁ
 
	msched
 : 1;

879 } 
__©åibuã__
((
∑cked
)Ë
	gtfw_cfg_is_£t
;

882 
	#TFW_CFGOP_HAS_DFLT
(
˚
, 
v
) \

883 (
	`tfw_cfg_is_dÊt_vÆue
(
˚
Ë&& 
tfw_cfg_is_£t
.
v
)

	)

884 
	#TFW_CFGOP_INHERIT_OPT
(
˚
, 
v
) \

886 i‡(
	`tfw_cfg_is_dÊt_vÆue
(
˚
Ë&& 
tfw_cfg_is_£t
.
v
) { \

887 
tfw_cfg_sg
->
∑r£d_sg
->
v
 = 
tfw_cfg_sg_›ts
->parsed_sg->v;\

890 })

	)

891 
	#TFW_CFGOP_INHERIT_FLAGS
(
˚
, 
v
) \

893 i‡(
	`tfw_cfg_is_dÊt_vÆue
(
˚
Ë&& 
tfw_cfg_is_£t
.
v
) { \

894 
tfw_cfg_sg
->
v
 = 
tfw_cfg_sg_›ts
->v; \

897 })

	)

900 
	$tfw_cfg›_sg_c›y_›ts
(
TfwSrvGroup
 *
to
, TfwSrvGrou∞*
‰om
)

902 
	`BUG_ON
(!
to
);

903 
	`BUG_ON
(!
‰om
);

905 
to
->
max_qsize
 = 
‰om
->max_qsize;

906 
to
->
max_ªfwd
 = 
‰om
->max_refwd;

907 
to
->
max_jqage
 = 
‰om
->max_jqage;

908 
to
->
max_ª˙s
 = 
‰om
->max_recns;

909 
to
->
Êags
 = 
‰om
->flags;

910 
	}
}

913 
	$tfw_cfg›_sg_c›y_sched_¨g
(**
to
, *
‰om
)

915 i‡(!
‰om
) {

916 *
to
 = 
NULL
;

921 i‡(!(*
to
 = 
	`kzÆloc
((
TfwSchªfPªdi˘
), 
GFP_KERNEL
)))

922  -
ENOMEM
;

923 
	`mem˝y
(*
to
, 
‰om
, (
TfwSchªfPªdi˘
));

926 
	}
}

928 
TfwCfgSrvGroup
 *

929 
	$__tfw_cfg›_√w_sg_cfg
(c⁄° *
«me
, 
Àn
)

931 
TfwCfgSrvGroup
 *
sg_cfg
 = 
	`kmem_ˇche_Æloc
(
tfw_sg_cfg_ˇche
, 
GFP_KERNEL
);

932 i‡(!
sg_cfg
)

933  
NULL
;

935 
	`mem£t
(
sg_cfg
, 0, (
TfwCfgSrvGroup
));

936 
sg_cfg
->
∑r£d_sg
 = 
	`tfw_sg_√w
(
«me
, 
Àn
, 
GFP_KERNEL
);

937 i‡(!
sg_cfg
->
∑r£d_sg
) {

938 
	`kmem_ˇche_‰ì
(
tfw_sg_cfg_ˇche
, 
sg_cfg
);

939  
NULL
;

941 
	`INIT_LIST_HEAD
(&
sg_cfg
->
li°
);

943  
sg_cfg
;

944 
	}
}

946 
TfwCfgSrvGroup
 *

947 
	$tfw_cfg›_√w_sg_cfg
(c⁄° *
«me
, 
size_t
 
Àn
)

949 
TfwCfgSrvGroup
 *
sg_cfg
 = 
	`__tfw_cfg›_√w_sg_cfg
(
«me
, 
Àn
);

950 i‡(!
sg_cfg
)

951  
NULL
;

952 
sg_cfg
->
‹ig_sg
 = 
	`tfw_sg_lookup
(
«me
, 
Àn
);

953 
	`li°_add
(&
sg_cfg
->
li°
, &
sg_cfg_li°
);

955  
sg_cfg
;

956 
	}
}

962 
TfwCfgSrvGroup
 *

963 
	$tfw_cfg›_√w_sg_cfg_def
()

965 
TfwCfgSrvGroup
 *
sg_cfg
;

967 
sg_cfg
 = 
	`__tfw_cfg›_√w_sg_cfg
(
TFW_CFG_SG_DFT_NAME
,

968 (
TFW_CFG_SG_DFT_NAME
) - 1);

969 i‡(!
sg_cfg
)

970  
NULL
;

971 
sg_cfg
->
‹ig_sg
 = 
	`tfw_sg_lookup
(
TFW_CFG_SG_DFT_NAME
,

972 (
TFW_CFG_SG_DFT_NAME
));

974  
sg_cfg
;

975 
	}
}

977 
TfwCfgSrvGroup
*

978 
	$tfw_cfg›_lookup_sg_cfg
(c⁄° *
«me
, 
Àn
)

980 
TfwCfgSrvGroup
 *
sg_cfg
;

982 
	`li°_f‹_óch_íåy
(
sg_cfg
, &
sg_cfg_li°
, 
li°
)

983 i‡(
	`tfw_sg_«me_m©ch
(
sg_cfg
->
∑r£d_sg
, 
«me
, 
Àn
))

984  
sg_cfg
;

986  
NULL
;

987 
	}
}

990 
	$tfw_cfg›_upd©e_§v_hó…h
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
, *
d©a
)

992 
TfwCfgSrvGroup
 *
sg_cfg
 = 
d©a
;

993 
boﬁ
 
‹ig_hm
 = 
	`ã°_bô
(
TFW_SRV_B_HMONITOR
, &
§v
->
Êags
);

1000 i‡((
sg_cfg
->
hm_«me


1001 && 
‹ig_hm


1002 && 
	`tfw_≠m_hm_§v_eq
(
sg_cfg
->
hm_«me
, 
§v
))

1003 || (!
sg_cfg
->
hm_«me
 && !
‹ig_hm
))

1010 i‡(
‹ig_hm
)

1011 
	`tfw_≠m_hm_dißbÀ_§v
(
§v
);

1017 i‡(
sg_cfg
->
hm_«me
)

1018 
	`tfw_≠m_hm_íabÀ_§v
(
§v
, 
sg_cfg
->
hm_¨g
);

1021 
	}
}

1024 
	$tfw_cfg›_ötvÆ
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, *
ötvÆ
)

1026 i‡(
˚
->
vÆ_n
 != 1) {

1027 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

1028  -
EINVAL
;

1030 i‡(
˚
->
©å_n
) {

1031 
	`TFW_ERR_NL
("Arguments mayÇot haveÅhe \'=\' sign\n");

1032  -
EINVAL
;

1035 
cs
->
de°
 = 
ötvÆ
;

1036  
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1037 
	}
}

1040 
	$tfw_cfg›_queue_size
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, *
qsize
)

1042 
r
;

1044 if((
r
 = 
	`tfw_cfg›_ötvÆ
(
cs
, 
˚
, 
qsize
)))

1045  
r
;

1047 *
qsize
 = *qsizê? : 
INT_MAX
;

1050 
	}
}

1053 
	$tfw_cfg›_ö_queue_size
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1055 
	`TFW_CFGOP_INHERIT_OPT
(
˚
, 
max_qsize
);

1056  
	`tfw_cfg›_queue_size
(
cs
, 
˚
, &
tfw_cfg_sg
->
∑r£d_sg
->
max_qsize
);

1057 
	}
}

1060 
	$tfw_cfg›_out_queue_size
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1062 
tfw_cfg_is_£t
.
max_qsize
 = 1;

1063  
	`tfw_cfg›_queue_size
(
cs
, 
˚
,

1064 &
tfw_cfg_sg_›ts
->
∑r£d_sg
->
max_qsize
);

1065 
	}
}

1068 
	$tfw_cfg›_fwd_timeout
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, *
to
)

1070 
r
;

1071 
time
;

1073 if((
r
 = 
	`tfw_cfg›_ötvÆ
(
cs
, 
˚
, &
time
)))

1074  
r
;

1075 *
to
 = 
time
 ? 
	`m£cs_to_jiffõs
—imê* 1000Ë: 
ULONG_MAX
;

1078 
	}
}

1081 
	$tfw_cfg›_ö_fwd_timeout
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1083 
	`TFW_CFGOP_INHERIT_OPT
(
˚
, 
max_jqage
);

1084  
	`tfw_cfg›_fwd_timeout
(
cs
, 
˚
, &
tfw_cfg_sg
->
∑r£d_sg
->
max_jqage
);

1085 
	}
}

1088 
	$tfw_cfg›_out_fwd_timeout
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1090 
tfw_cfg_is_£t
.
max_jqage
 = 1;

1091  
	`tfw_cfg›_fwd_timeout
(
cs
, 
˚
,

1092 &
tfw_cfg_sg_›ts
->
∑r£d_sg
->
max_jqage
);

1093 
	}
}

1096 
	$tfw_cfg›_ö_fwd_ªåõs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1098 
	`TFW_CFGOP_INHERIT_OPT
(
˚
, 
max_ªfwd
);

1099  
	`tfw_cfg›_ötvÆ
(
cs
, 
˚
, &
tfw_cfg_sg
->
∑r£d_sg
->
max_ªfwd
);

1100 
	}
}

1103 
	$tfw_cfg›_out_fwd_ªåõs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1105 
tfw_cfg_is_£t
.
max_ªfwd
 = 1;

1106  
	`tfw_cfg›_ötvÆ
(
cs
, 
˚
, &
tfw_cfg_sg_›ts
->
∑r£d_sg
->
max_ªfwd
);

1107 
	}
}

1109 
ölöe
 

1110 
	$tfw_cfg›_ªåy_nù
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, *
sg_Êags
)

1112 
ªåy_nù
;

1114 i‡(
˚
->
©å_n
) {

1115 
	`TFW_ERR_NL
("Arguments mayÇot haveÅhe \'=\' sign\n");

1116  -
EINVAL
;

1118 i‡(
	`tfw_cfg_is_dÊt_vÆue
(
˚
)) {

1119 
ªåy_nù
 = 0;

1120 } i‡(!
˚
->
vÆ_n
) {

1121 
ªåy_nù
 = 
TFW_SRV_RETRY_NIP
;

1123 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

1124  -
EINVAL
;

1126 *
sg_Êags
 |
ªåy_nù
;

1129 
	}
}

1132 
	$tfw_cfg›_ö_ªåy_nù
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1134 
	`TFW_CFGOP_INHERIT_FLAGS
(
˚
, 
nù_Êags
);

1135  
	`tfw_cfg›_ªåy_nù
(
cs
, 
˚
, &
tfw_cfg_sg
->
nù_Êags
);

1136 
	}
}

1139 
	$tfw_cfg›_out_ªåy_nù
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1141 
tfw_cfg_is_£t
.
nù_Êags
 = 1;

1142  
	`tfw_cfg›_ªåy_nù
(
cs
, 
˚
, &
tfw_cfg_sg_›ts
->
nù_Êags
);

1143 
	}
}

1145 
ölöe
 

1146 
	$tfw_cfg›_°icky_£ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, *
u£_°icky
)

1148 i‡(
˚
->
©å_n
) {

1149 
	`TFW_ERR_NL
("Arguments mayÇot haveÅhe \'=\' sign\n");

1150  -
EINVAL
;

1152 i‡(
˚
->
vÆ_n
 > 1) {

1153 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

1154  -
EINVAL
;

1156 i‡(
	`tfw_cfg_is_dÊt_vÆue
(
˚
)) {

1157 *
u£_°icky
 = 0;

1158 } i‡(!
˚
->
vÆ_n
) {

1159 *
u£_°icky
 = 
TFW_SRV_STICKY
;

1160 } i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[0], "allow_failover")) {

1161 *
u£_°icky
 = 
TFW_SRV_STICKY
 | 
TFW_SRV_STICKY_FAILOVER
;

1163 
	`TFW_ERR_NL
("Unsuµ‹ãdárgumít: %s\n", 
˚
->
vÆs
[0]);

1164  -
EINVAL
;

1166 i‡(*
u£_°icky
 & 
TFW_SRV_STICKY_FLAGS
)

1167 
tfw_cfg_u£_°icky_£ss
 = 
åue
;

1170 
	}
}

1173 
	$tfw_cfg›_ö_°icky_£ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1175 
	`TFW_CFGOP_INHERIT_FLAGS
(
˚
, 
°icky_Êags
);

1176  
	`tfw_cfg›_°icky_£ss
(
cs
, 
˚
, &
tfw_cfg_sg
->
°icky_Êags
);

1177 
	}
}

1180 
	$tfw_cfg›_out_°icky_£ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1182 
tfw_cfg_is_£t
.
°icky_Êags
 = 1;

1183  
	`tfw_cfg›_°icky_£ss
(
cs
, 
˚
, &
tfw_cfg_sg_›ts
->
°icky_Êags
);

1184 
	}
}

1186 
boﬁ


1187 
	$tfw_cfg›_sg_£t_hm_«me
(
TfwCfgSrvGroup
 *
sg_cfg
, c⁄° *
h«me
)

1189 
size_t
 
size
 = 
	`°æí
(
h«me
) + 1;

1190 
sg_cfg
->
hm_«me
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

1191 i‡(!
sg_cfg
->
hm_«me
)

1192  
Ál£
;

1194 
	`mem˝y
(
sg_cfg
->
hm_«me
, 
h«me
, 
size
);

1196  
åue
;

1197 
	}
}

1199 
ölöe
 

1200 
	$tfw_cfg›_hó…h_m⁄ô‹
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
,

1201 
TfwCfgSrvGroup
 *
sg_cfg
)

1203 i‡(
	`tfw_cfg_check_sögÀ_vÆ
(
˚
))

1204  -
EINVAL
;

1205 i‡(!
	`tfw_cfg›_sg_£t_hm_«me
(
sg_cfg
, 
˚
->
vÆs
[0])) {

1206 
	`TFW_ERR_NL
("UnableÅoádd group's health monitorÇame: '%s'\n",

1207 
˚
->
vÆs
[0]);

1208  -
ENOMEM
;

1212 
	}
}

1215 
	$tfw_cfg›_ö_hó…h_m⁄ô‹
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1217  
	`tfw_cfg›_hó…h_m⁄ô‹
(
cs
, 
˚
, 
tfw_cfg_sg
);

1218 
	}
}

1221 
	$tfw_cfg›_out_hó…h_m⁄ô‹
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1223  
	`tfw_cfg›_hó…h_m⁄ô‹
(
cs
, 
˚
, 
tfw_cfg_sg_def
);

1224 
	}
}

1227 
	$tfw_cfg›_c⁄n_ªåõs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, *
ª˙s
)

1229 
r
;

1231 if((
r
 = 
	`tfw_cfg›_ötvÆ
(
cs
, 
˚
, 
ª˙s
)))

1232  
r
;

1233 *
ª˙s
 = *ª˙†? 
	`max_t
(, *ª˙s, 
	`ARRAY_SIZE
(
tfw_§v_tmo_vÆs
))

1234 : 
UINT_MAX
;

1237 
	}
}

1240 
	$tfw_cfg›_ö_c⁄n_ªåõs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1242 
	`TFW_CFGOP_INHERIT_OPT
(
˚
, 
max_ª˙s
);

1243  
	`tfw_cfg›_c⁄n_ªåõs
(
cs
, 
˚
,

1244 &
tfw_cfg_sg
->
∑r£d_sg
->
max_ª˙s
);

1245 
	}
}

1248 
	$tfw_cfg›_out_c⁄n_ªåõs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1250 
tfw_cfg_is_£t
.
max_ª˙s
 = 1;

1251  
	`tfw_cfg›_c⁄n_ªåõs
(
cs
, 
˚
,

1252 &
tfw_cfg_sg_›ts
->
∑r£d_sg
->
max_ª˙s
);

1253 
	}
}

1260 
	$tfw_cfg›_£rvî_‹ig_lookup
(
TfwCfgSrvGroup
 *
sg_cfg
, 
TfwSîvî
 *
§v
)

1262 
TfwSîvî
 *
‹ig_§v
;

1264 i‡(!
sg_cfg
->
‹ig_sg
)

1267 
‹ig_§v
 = 
	`tfw_£rvî_lookup
(
sg_cfg
->
‹ig_sg
, &
§v
->
addr
);

1268 i‡(!
‹ig_§v
) {

1269 
	`£t_bô
(
TFW_CFG_B_ADD
, &
§v
->
Êags
);

1270 
d⁄e
;

1272 i‡(
‹ig_§v
->
c⁄n_n
 !
§v
->conn_n)

1273 
ch™ged
;

1274 i‡(
§v
->
weight
 && (§v->weighà!
‹ig_§v
->weight))

1275 
ch™ged
;

1278 
	`£t_bô
(
TFW_CFG_B_KEEP
, &
‹ig_§v
->
Êags
);

1279 
	`£t_bô
(
TFW_CFG_B_KEEP
, &
§v
->
Êags
);

1281 
	`tfw_£rvî_put
(
‹ig_§v
);

1284 
ch™ged
:

1285 
	`£t_bô
(
TFW_CFG_B_MOD
, &
‹ig_§v
->
Êags
);

1286 
	`£t_bô
(
TFW_CFG_B_MOD
, &
§v
->
Êags
);

1287 
	`tfw_£rvî_put
(
‹ig_§v
);

1288 
d⁄e
:

1289 
sg_cfg
->
ªc⁄f_Êags
 |
TFW_CFG_MDF_SG_SRV
;

1290 
	}
}

1293 
	#TFW_CFG_SRV_CONNS_N_DEF
 32

	)

1294 
	#TFW_CFG_SRV_WEIGHT_MIN
 1

	)

1295 
	#TFW_CFG_SRV_WEIGHT_MAX
 100

	)

1296 
	#TFW_CFG_SRV_WEIGHT_DEF
 50

	)

1302 
	$tfw_cfg›_£rvî
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
TfwCfgSrvGroup
 *
sg_cfg
)

1304 
TfwAddr
 
addr
;

1305 
TfwSîvî
 *
§v
;

1306 
i
, 
c⁄ns_n
 = 0, 
weight
 = 0;

1307 
boﬁ
 
has_c⁄ns_n
 = 
Ál£
, 
has_weight
 = false;

1308 c⁄° *
key
, *
vÆ
;

1310 i‡(
˚
->
vÆ_n
 != 1) {

1311 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

1312  -
EINVAL
;

1314 i‡(
˚
->
©å_n
 > 3) {

1315 
	`TFW_ERR_NL
("InvalidÇumber of key=valueÖairs: %zu\n",

1316 
˚
->
©å_n
);

1317  -
EINVAL
;

1320 i‡(
	`tfw_addr_±⁄
(&
	`TFW_STR_FROM
(
˚
->
vÆs
[0]), &
addr
)) {

1321 
	`TFW_ERR_NL
("InvÆid IPáddªss: '%s'\n", 
˚
->
vÆs
[0]);

1322  -
EINVAL
;

1324 i‡((
§v
 = 
	`tfw_£rvî_lookup
(
sg_cfg
->
∑r£d_sg
, &
addr
))) {

1325 
	`TFW_ERR_NL
("Du∂iˇãd sîvî '%s'\n", 
˚
->
vÆs
[0]);

1326 
	`tfw_£rvî_put
(
§v
);

1327  -
EEXIST
;

1330 
	`TFW_CFG_ENTRY_FOR_EACH_ATTR
(
˚
, 
i
, 
key
, 
vÆ
) {

1331 i‡(!
	`°rˇ£cmp
(
key
, "conns_n")) {

1332 i‡(
has_c⁄ns_n
) {

1333 
	`TFW_ERR_NL
("Du∂iˇãárgumít: '%s'\n", 
key
);

1334  -
EINVAL
;

1336 i‡(
	`tfw_cfg_∑r£_öt
(
vÆ
, &
c⁄ns_n
)) {

1337 
	`TFW_ERR_NL
("InvÆid vÆue: '%s'\n", 
vÆ
);

1338  -
EINVAL
;

1340 
has_c⁄ns_n
 = 
åue
;

1341 } i‡(!
	`°rˇ£cmp
(
key
, "weight")) {

1342 i‡(
has_weight
) {

1343 
	`TFW_ERR_NL
("Du∂iˇãárgumít: '%s'\n", 
key
);

1344  -
EINVAL
;

1346 i‡(
	`tfw_cfg_∑r£_öt
(
vÆ
, &
weight
)) {

1347 
	`TFW_ERR_NL
("InvÆid vÆue: '%s'\n", 
vÆ
);

1348  -
EINVAL
;

1350 
has_weight
 = 
åue
;

1352 
	`TFW_ERR_NL
("Unsuµ‹ãdárgumít: '%s'\n", 
key
);

1353  -
EINVAL
;

1357 i‡(!
has_c⁄ns_n
) {

1358 
c⁄ns_n
 = 
TFW_CFG_SRV_CONNS_N_DEF
;

1359 } i‡((
c⁄ns_n
 < 1Ë|| (c⁄ns_¿> 
TFW_SRV_MAX_CONN_N
)) {

1360 
	`TFW_ERR_NL
("Out ofÑange of [1..%d]: 'conns_n=%d'\n",

1361 
TFW_SRV_MAX_CONN_N
, 
c⁄ns_n
);

1362  -
EINVAL
;

1365 i‡(
has_weight
 && ((
weight
 < 
TFW_CFG_SRV_WEIGHT_MIN
)

1366 || (
weight
 > 
TFW_CFG_SRV_WEIGHT_MAX
)))

1368 
	`TFW_ERR_NL
("Out ofÑange of [%d..%d]: 'weight=%d'\n",

1369 
TFW_CFG_SRV_WEIGHT_MIN
, 
TFW_CFG_SRV_WEIGHT_MAX
,

1370 
weight
);

1371  -
EINVAL
;

1374 i‡(!(
§v
 = 
	`tfw_£rvî_¸óã
(&
addr
))) {

1375 
	`TFW_ERR_NL
("Eº‹ h™dlögÅhê£rvî: '%s'\n", 
˚
->
vÆs
[0]);

1376  -
EINVAL
;

1379 
§v
->
˛ónup
 = 
tfw_sock_§v_dñ_c⁄ns
;

1380 
§v
->
weight
 = weight;

1381 
§v
->
c⁄n_n
 = 
c⁄ns_n
;

1382 
	`tfw_sg_add_§v
(
sg_cfg
->
∑r£d_sg
, 
§v
);

1383 
	`tfw_cfg›_£rvî_‹ig_lookup
(
sg_cfg
, 
§v
);

1385 
	`tfw_£rvî_put
(
§v
);

1388 
	}
}

1399 
	$tfw_cfg›_ö_£rvî
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1401  
	`tfw_cfg›_£rvî
(
cs
, 
˚
, 
tfw_cfg_sg
);

1402 
	}
}

1424 
	$tfw_cfg›_out_£rvî
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1426 i‡(!
tfw_cfg_sg_def
) {

1427 
	`TFW_ERR_NL
("'default' group is declared implicitlyáfter "

1429  -
EINVAL
;

1431 i‡(
	`li°_em±y
(&
tfw_cfg_sg_def
->
∑r£d_sg
->
§v_li°
)) {

1432 
TfwSrvGroup
 *
sg
;

1434 
sg
 = 
tfw_cfg_sg_def
->
‹ig_sg
 ? :Åfw_cfg_sg_def->
∑r£d_sg
;

1435 i‡(
	`tfw_sg_add_ªc⁄fig
(
sg
)) {

1436 
	`TFW_ERR_NL
("UnableÅoÑegister implicit 'default' group\n");

1437  -
EINVAL
;

1439 
	`li°_add
(&
tfw_cfg_sg_def
->
li°
, &
sg_cfg_li°
);

1442  
	`tfw_cfg›_£rvî
(
cs
, 
˚
, 
tfw_cfg_sg_def
);

1443 
	}
}

1458 
	$tfw_cfg›_begö_§v_group
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1460 
TfwCfgSrvGroup
 *
sg_cfg
;

1461 
TfwSrvGroup
 *
sg
;

1462 
∆í
;

1464 
	`BUILD_BUG_ON
(
TFW_CFG_ENTRY_VAL_MAX
 < (
TFW_CFG_SG_DFT_NAME
));

1465 i‡(
˚
->
vÆ_n
 != 1) {

1466 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

1467  -
EINVAL
;

1469 i‡(
˚
->
©å_n
) {

1470 
	`TFW_ERR_NL
("InvalidÇumber of key=valueÖairs: %zu\n",

1471 
˚
->
©å_n
);

1472  -
EINVAL
;

1475 
∆í
 = 
	`°æí
(
˚
->
vÆs
[0]);

1476 i‡(
	`tfw_cfg›_lookup_sg_cfg
(
˚
->
vÆs
[0], 
∆í
)) {

1477 
	`TFW_ERR_NL
("Group '%s'álreadyÉxists in configuration"

1478 "\n", 
˚
->
vÆs
[0]);

1479  -
EINVAL
;

1481 i‡(!
	`memcmp
(
˚
->
vÆs
[0], 
TFW_CFG_SG_DFT_NAME
,

1482 (
TFW_CFG_SG_DFT_NAME
)))

1484 
sg_cfg
 = 
tfw_cfg_sg_def
;

1485 
tfw_cfg_sg_def
 = 
NULL
;

1486 
	`li°_add
(&
sg_cfg
->
li°
, &
sg_cfg_li°
);

1489 
sg_cfg
 = 
	`tfw_cfg›_√w_sg_cfg
(
˚
->
vÆs
[0], 
∆í
);

1490 i‡(!
sg_cfg
) {

1491 
	`TFW_ERR_NL
("UnableÅo createá group: '%s'\n",

1492 
˚
->
vÆs
[0]);

1493  -
ENOMEM
;

1497 
sg
 = 
sg_cfg
->
‹ig_sg
 ? : sg_cfg->
∑r£d_sg
;

1498 i‡(
	`tfw_sg_add_ªc⁄fig
(
sg
)) {

1499 
	`TFW_ERR_NL
("Can'tÑegisterálreadyÑegistered group '%s'\n",

1500 
˚
->
vÆs
[0]);

1501  -
EINVAL
;

1504 
tfw_cfg_sg
 = 
sg_cfg
;

1505 
	`TFW_DBG
("begö srv_group: %s\n", 
tfw_cfg_sg
->
∑r£d_sg
->
«me
);

1508 
	}
}

1515 
	$tfw_cfg_sg_øtio_adju°
(
li°_hód
 *
¶°
)

1517 
TfwSîvî
 *
§v
;

1519 
	`li°_f‹_óch_íåy
(
§v
, 
¶°
, 
li°
)

1520 i‡(!
§v
->
weight
)

1521 
§v
->
weight
 = 
TFW_CFG_SRV_WEIGHT_DEF
;

1523 
	}
}

1526 
	$tfw_cfg_sg_øtio_vîify
(
TfwSrvGroup
 *
sg
)

1528 
TfwSîvî
 *
§v
;

1529 
cou¡
 = 0;

1531 i‡(
sg
->
Êags
 & (
TFW_SG_F_SCHED_RATIO_DYNAMIC


1532 || 
TFW_SG_F_SCHED_RATIO_PREDICT
))

1534 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

1535 i‡(
§v
->
weight
)

1537 ++
cou¡
;

1539 i‡(
cou¡
 < 
sg
->
§v_n
) {

1540 
	`TFW_ERR_NL
("srv_group %s: static weight [%d] used "

1542 
sg
->
«me
, 
§v
->
weight
);

1543  -
EINVAL
;

1548 
	}
}

1550 
boﬁ


1551 
	$tfw_cfg›_sched_ch™ged
(
TfwCfgSrvGroup
 *
sg_cfg
)

1553 i‡(!
sg_cfg
->
‹ig_sg
)

1554  
Ál£
;

1556 i‡(
sg_cfg
->
‹ig_sg
->
sched
 !sg_cfg->
∑r£d_sg
->sched)

1557  
åue
;

1559 i‡(
sg_cfg
->
sched_Êags
 !=

1560 (
sg_cfg
->
‹ig_sg
->
Êags
 & 
TFW_SG_M_SCHED_RATIO_TYPE
))

1561  
åue
;

1564  
Ál£
;

1565 
	}
}

1568 
	$tfw_cfg›_£tup_§v_group
(
TfwCfgSrvGroup
 *
sg_cfg
)

1570 
TfwSrvGroup
 *
sg
 = 
sg_cfg
->
∑r£d_sg
;

1573 i‡(
sg_cfg
->
‹ig_sg
 &&

1574 (
sg_cfg
->
‹ig_sg
->
§v_n
 !sg_cfg->
∑r£d_sg
->srv_n))

1576 
sg_cfg
->
ªc⁄f_Êags
 |
TFW_CFG_MDF_SG_SRV
;

1579 
sg
->
Êags
 = 
sg_cfg
->
nù_Êags
 | sg_cfg->
°icky_Êags
 |

1580 
sg_cfg
->
sched_Êags
;

1588 i‡(!
	`°rˇ£cmp
(
sg
->
sched
->
«me
, "ratio")) {

1589 i‡(
	`tfw_cfg_sg_øtio_vîify
(
sg
))

1590  -
EINVAL
;

1591 i‡(
	`tfw_cfg_sg_øtio_adju°
(&
sg
->
§v_li°
))

1592  -
EINVAL
;

1595 i‡(
	`tfw_cfg›_sched_ch™ged
(
sg_cfg
))

1596 
sg_cfg
->
ªc⁄f_Êags
 |
TFW_CFG_MDF_SG_SCHED
;

1599 
	}
}

1612 
	$tfw_cfg›_föish_§v_group
(
TfwCfgS≥c
 *
cs
)

1614 
r
;

1616 i‡((
r
 = 
	`tfw_cfg›_£tup_§v_group
(
tfw_cfg_sg
)))

1617  
r
;

1619 
	`TFW_DBG
("föish srv_group: %s\n", 
tfw_cfg_sg
->
∑r£d_sg
->
«me
);

1620 
tfw_cfg_sg
 = 
tfw_cfg_sg_›ts
;

1623 
	}
}

1626 
	$tfw_cfg_h™dÀ_øtio_¥edyn_›ts
(
TfwCfgE¡ry
 *
˚
, *
¨g_Êags
)

1628 
idx
, 
vÆue
, 
Êags
 = *
¨g_Êags
;

1630 i‡(
˚
->
vÆ_n
 < 3) {

1632 
Êags
 |
TFW_PSTATS_IDX_AVG
;

1633 
d⁄e
;

1635 i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[2], "minimum")) {

1636 
idx
 = 
TFW_PSTATS_IDX_MIN
;

1637 }i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[2], "maximum")) {

1638 
idx
 = 
TFW_PSTATS_IDX_MAX
;

1639 } i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[2], "average")) {

1640 
idx
 = 
TFW_PSTATS_IDX_AVG
;

1641 } i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[2], "percentile")) {

1642 i‡(
˚
->
vÆ_n
 < 4) {

1644 
Êags
 |
TFW_PSTATS_IDX_P90
;

1645 
d⁄e
;

1647 i‡(
	`tfw_cfg_∑r£_öt
(
˚
->
vÆs
[3], &
vÆue
)) {

1648 
	`TFW_ERR_NL
("InvÆid vÆue: '%s'\n", 
˚
->
vÆs
[3]);

1649  -
EINVAL
;

1651 
idx
 = 0; idx < 
	`ARRAY_SIZE
(
tfw_p°©s_ôh
); ++idx) {

1652 i‡(!
tfw_p°©s_ôh
[
idx
])

1654 i‡(
tfw_p°©s_ôh
[
idx
] =
vÆue
)

1657 i‡(
idx
 =
	`ARRAY_SIZE
(
tfw_p°©s_ôh
)) {

1658 
	`TFW_ERR_NL
("InvÆid vÆue: '%s'\n", 
˚
->
vÆs
[3]);

1659  -
EINVAL
;

1662 
	`TFW_ERR_NL
("Unsuµ‹ãdárgumít: '%s'\n", 
˚
->
vÆs
[2]);

1663  -
EINVAL
;

1665 
Êags
 |
idx
;

1667 
d⁄e
:

1668 *
¨g_Êags
 = 
Êags
;

1670 
	}
}

1673 
	#TFW_CFG_PAST_DEF
 30

	)

1674 
	#TFW_CFG_PAST_MAX
 120

	)

1675 
	#TFW_CFG_RATE_DEF
 20

	)

1676 
	#TFW_CFG_RATE_MAX
 20

	)

1679 
	$tfw_cfg_h™dÀ_øtio_¥edi˘
(
TfwCfgE¡ry
 *
˚
,

1680 **
sch¨g
, *
¨g_Êags
)

1682 
i
, 
ªt
;

1683 c⁄° *
key
, *
vÆ
;

1684 
boﬁ
 
has_∑°
 = 
Ál£
, 
has_øã
 = fÆ£, 
has_ahód
 = false;

1685 
TfwSchªfPªdi˘
 
¨g
 = { 0 };

1687 i‡((
ªt
 = 
	`tfw_cfg_h™dÀ_øtio_¥edyn_›ts
(
˚
, 
¨g_Êags
)))

1688  
ªt
;

1690 
	`TFW_CFG_ENTRY_FOR_EACH_ATTR
(
˚
, 
i
, 
key
, 
vÆ
) {

1691 i‡(!
	`°rˇ£cmp
(
key
, "past")) {

1692 i‡(
has_∑°
) {

1693 
	`TFW_ERR_NL
("Du∂iˇãárgumít: '%s'\n", 
key
);

1694  -
EINVAL
;

1696 i‡(
	`tfw_cfg_∑r£_öt
(
vÆ
, &
¨g
.
∑°
)) {

1697 
	`TFW_ERR_NL
("InvÆid vÆue: '%s'\n", 
vÆ
);

1698  -
EINVAL
;

1700 
has_∑°
 = 
åue
;

1701 } i‡(!
	`°rˇ£cmp
(
key
, "rate")) {

1702 i‡(
has_øã
) {

1703 
	`TFW_ERR_NL
("Du∂iˇãárgumít: '%s'\n", 
key
);

1704  -
EINVAL
;

1706 i‡(
	`tfw_cfg_∑r£_öt
(
vÆ
, &
¨g
.
øã
)) {

1707 
	`TFW_ERR_NL
("InvÆid vÆue: '%s'\n", 
vÆ
);

1708  -
EINVAL
;

1710 
has_øã
 = 
åue
;

1711 } i‡(!
	`°rˇ£cmp
(
key
, "ahead")) {

1712 i‡(
has_ahód
) {

1713 
	`TFW_ERR_NL
("Du∂iˇãárgumít: '%s'\n", 
key
);

1714  -
EINVAL
;

1716 i‡(
	`tfw_cfg_∑r£_öt
(
vÆ
, &
¨g
.
ahód
)) {

1717 
	`TFW_ERR_NL
("InvÆid vÆue: '%s'\n", 
vÆ
);

1718  -
EINVAL
;

1720 
has_ahód
 = 
åue
;

1723 i‡(!
has_∑°
) {

1724 
¨g
.
∑°
 = 
TFW_CFG_PAST_DEF
;

1725 } i‡((
¨g
.
∑°
 < 1Ë|| (¨g.∑° > 
TFW_CFG_PAST_MAX
)) {

1726 
	`TFW_ERR_NL
("Out ofÑange of [1..%d]: 'past=%d'\n",

1727 
TFW_CFG_PAST_MAX
, 
¨g
.
∑°
);

1728  -
EINVAL
;

1730 i‡(!
has_øã
) {

1731 
¨g
.
øã
 = 
TFW_CFG_RATE_DEF
;

1732 } i‡((
¨g
.
øã
 < 1Ë|| (¨g.øã > 
TFW_CFG_RATE_MAX
)) {

1733 
	`TFW_ERR_NL
("Out ofÑange of [1..%d]: 'rate=%d'\n",

1734 
TFW_CFG_RATE_MAX
, 
¨g
.
øã
);

1735  -
EINVAL
;

1737 i‡(!
has_ahód
) {

1738 
¨g
.
ahód
 =árg.
∑°
 > 1 ?árg.past / 2 : 1;

1739 } i‡((
¨g
.
ahód
 < 1Ë|| (¨g.ahód >árg.
∑°
 / 2)) {

1740 
	`TFW_ERR_NL
("Out ofÑange of [1..%d]: 'ahead=%d'."

1742 
¨g
.
∑°
 / 2,árg.
ahód
,árg.past);

1743  -
EINVAL
;

1746  
	`tfw_cfg›_sg_c›y_sched_¨g
(
sch¨g
, &
¨g
);

1747 
	}
}

1750 
	$tfw_cfg_h™dÀ_øtio_dy«mic
(
TfwCfgE¡ry
 *
˚
, *
¨g_Êags
)

1752 i‡(
˚
->
©å_n
) {

1753 
	`TFW_ERR_NL
("Arguments mayÇot haveÅhe \'=\' sign\n");

1754  -
EINVAL
;

1757  
	`tfw_cfg_h™dÀ_øtio_¥edyn_›ts
(
˚
, 
¨g_Êags
);

1758 
	}
}

1761 
	$tfw_cfg_h™dÀ_øtio
(
TfwCfgE¡ry
 *
˚
, *
sch¨g
, *
sched_Êags
)

1763 
ªt
;

1764 
Êags
;

1766 i‡(
˚
->
vÆ_n
 < 2) {

1768 
Êags
 = 
TFW_SG_F_SCHED_RATIO_STATIC
;

1769 } i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[1], "static")) {

1770 
Êags
 = 
TFW_SG_F_SCHED_RATIO_STATIC
;

1771 } i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[1], "dynamic")) {

1772 
Êags
 = 
TFW_SG_F_SCHED_RATIO_DYNAMIC
;

1773 i‡((
ªt
 = 
	`tfw_cfg_h™dÀ_øtio_dy«mic
(
˚
, &
Êags
)))

1774  
ªt
;

1775 } i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[1], "predict")) {

1776 
Êags
 = 
TFW_SG_F_SCHED_RATIO_PREDICT
;

1777 i‡((
ªt
 = 
	`tfw_cfg_h™dÀ_øtio_¥edi˘
(
˚
, 
sch¨g
, &
Êags
)))

1778  
ªt
;

1780 
	`TFW_ERR_NL
("Unsuµ‹ãdárgumít: '%s'\n", 
˚
->
vÆs
[1]);

1781  -
EINVAL
;

1784 *
sched_Êags
 = 
Êags
;

1786 
	}
}

1792 
	$tfw_cfg›_sched
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
TfwScheduÀr
 **
sched_vÆ
,

1793 **
sch¨g
, *
sched_Êags
)

1795 
TfwScheduÀr
 *
sched
;

1797 i‡(!
˚
->
vÆ_n
) {

1798 
	`TFW_ERR_NL
("InvÆidÇumbî o‡¨gumíts: %zu\n", 
˚
->
vÆ_n
);

1799  -
EINVAL
;

1802 i‡(!(
sched
 = 
	`tfw_sched_lookup
(
˚
->
vÆs
[0]))) {

1803 
	`TFW_ERR_NL
("Uƒecognized scheduÀr: '%s'\n", 
˚
->
vÆs
[0]);

1804  -
EINVAL
;

1807 i‡(!
	`°rˇ£cmp
(
sched
->
«me
, "ratio"))

1808 i‡(
	`tfw_cfg_h™dÀ_øtio
(
˚
, 
sch¨g
, 
sched_Êags
))

1809  -
EINVAL
;

1811 *
sched_vÆ
 = 
sched
;

1814 
	}
}

1817 
	$tfw_cfg›_ö_sched
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1819 i‡(
	`TFW_CFGOP_HAS_DFLT
(
˚
, 
sched
)) {

1820 
tfw_cfg_sg
->
∑r£d_sg
->
sched
 = 
tfw_cfg_sg_›ts
->parsed_sg->sched;

1821 
tfw_cfg_sg
->
sched_Êags
 = 
tfw_cfg_sg_›ts
->sched_flags;

1822 
	`tfw_cfg›_sg_c›y_sched_¨g
(&
tfw_cfg_sg
->
sched_¨g
,

1823 
tfw_cfg_sg_›ts
->
sched_¨g
);

1826  
	`tfw_cfg›_sched
(
cs
, 
˚
, &
tfw_cfg_sg
->
∑r£d_sg
->
sched
,

1827 &
tfw_cfg_sg
->
sched_¨g
,

1828 &
tfw_cfg_sg
->
sched_Êags
);

1829 
	}
}

1832 
	$tfw_cfg›_out_sched
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1834 
tfw_cfg_is_£t
.
sched
 = 1;

1835  
	`tfw_cfg›_sched
(
cs
, 
˚
, &
tfw_cfg_sg_›ts
->
∑r£d_sg
->
sched
,

1836 &
tfw_cfg_sg_›ts
->
sched_¨g
,

1837 &
tfw_cfg_sg_›ts
->
sched_Êags
);

1838 
	}
}

1841 
	$tfw_cfg›_˛ónup_§v_cfg
(
TfwCfgSrvGroup
 *
sg_cfg
, 
boﬁ
 
ªÀa£_∑r£d
)

1843 i‡(
sg_cfg
->
‹ig_sg
 || 
ªÀa£_∑r£d
)

1844 
	`tfw_sg_ªÀa£
(
sg_cfg
->
∑r£d_sg
);

1845 
	`tfw_sg_put
(
sg_cfg
->
∑r£d_sg
);

1846 
	`tfw_sg_put
(
sg_cfg
->
‹ig_sg
);

1848 i‡(
sg_cfg
->
sched_¨g
)

1849 
	`k‰ì
(
sg_cfg
->
sched_¨g
);

1850 
	`li°_dñ_öô
(&
sg_cfg
->
li°
);

1852 i‡(
sg_cfg
->
hm_«me
)

1853 
	`k‰ì
(
sg_cfg
->
hm_«me
);

1854 
	`kmem_ˇche_‰ì
(
tfw_sg_cfg_ˇche
, 
sg_cfg
);

1855 
	}
}

1858 
	$tfw_cfg›_˛ónup_§v_cfgs
(
boﬁ
 
ªc⁄f_Áûed
)

1860 
TfwCfgSrvGroup
 *
sg_cfg
, *
tmp
;

1866 i‡(
tfw_cfg_sg_def
 && 
	`li°_em±y
(&tfw_cfg_sg_def->
li°
))

1867 
	`tfw_cfg›_˛ónup_§v_cfg
(
tfw_cfg_sg_def
, 
ªc⁄f_Áûed
);

1868 
tfw_cfg_sg_def
 = 
NULL
;

1870 
	`li°_f‹_óch_íåy_ß„
(
sg_cfg
, 
tmp
, &
sg_cfg_li°
, 
li°
) {

1871 
	`tfw_cfg›_˛ónup_§v_cfg
(
sg_cfg
, 
ªc⁄f_Áûed
);

1872 
	`tfw_§v_lo›_sched_rcu
();

1874 
	`INIT_LIST_HEAD
(&
sg_cfg_li°
);

1876 i‡(
tfw_cfg_sg_›ts
) {

1877 
	`tfw_cfg›_˛ónup_§v_cfg
(
tfw_cfg_sg_›ts
, 
åue
);

1878 
tfw_cfg_sg_›ts
 = 
NULL
;

1880 
tfw_cfg_sg
 = 
NULL
;

1881 
	}
}

1887 
	$__tfw_cfg›_˛ónup_§v_groups
()

1899 
	`tfw_sg_dr›_ªc⁄fig
();

1900 
	`tfw_cfg›_˛ónup_§v_cfgs
(
åue
);

1906 
	}
}

1909 
	$tfw_cfg›_˛ónup_§v_groups
(
TfwCfgS≥c
 *
cs
)

1911 
	`__tfw_cfg›_˛ónup_§v_groups
();

1912 
	}
}

1918 
	$tfw_cfg›_gø˚_time
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1920  
	`tfw_cfg›_ötvÆ
(
cs
, 
˚
, &
tfw_cfg_gø˚_time_ªc⁄fig
);

1921 
	}
}

1924 
	$tfw_sock_§v_cfg°¨t
()

1926 
∆í
 = (
TFW_CFG_SG_OPTS_NAME
) - 1;

1927 
	`INIT_LIST_HEAD
(&
sg_cfg_li°
);

1929 
tfw_cfg_sg_›ts
 = 
	`__tfw_cfg›_√w_sg_cfg
(
TFW_CFG_SG_OPTS_NAME
, 
∆í
);

1930 i‡(!
tfw_cfg_sg_›ts
)

1931  -
ENOMEM
;

1932 i‡(!(
tfw_cfg_sg_def
 = 
	`tfw_cfg›_√w_sg_cfg_def
())) {

1933 
	`tfw_cfg›_˛ónup_§v_cfg
(
tfw_cfg_sg_›ts
, 
åue
);

1934  -
ENOMEM
;

1936 
tfw_cfg_sg
 = 
tfw_cfg_sg_›ts
;

1937 
tfw_cfg_u£_°icky_£ss
 = 
Ál£
;

1938 
	`mem£t
(&
tfw_cfg_is_£t
, 0, (tfw_cfg_is_set));

1941 
	}
}

1944 
	$tfw_sock_§v_cfg˛ón
()

1952 
	`__tfw_cfg›_˛ónup_§v_groups
();

1953 
	}
}

1956 
	$tfw_sock_§v_cfgíd
()

1958 
r
;

1959 
TfwCfgSrvGroup
 *
sg_cfg
;

1962 
	`li°_f‹_óch_íåy
(
sg_cfg
, &
sg_cfg_li°
, 
li°
)

1963 i‡(
sg_cfg
->
hm_«me
 && !
	`tfw_≠m_check_hm
(sg_cfg->hm_name))

1964  -
EINVAL
;

1971 i‡(!
tfw_cfg_sg_def
)

1973 i‡(!
tfw_cfg_sg_def
->
∑r£d_sg
->
§v_n
) {

1974 
	`tfw_cfg›_˛ónup_§v_cfg
(
tfw_cfg_sg_def
, 
åue
);

1975 
tfw_cfg_sg_def
 = 
NULL
;

1979 
	`tfw_cfg›_sg_c›y_›ts
(
tfw_cfg_sg_def
->
∑r£d_sg
,

1980 
tfw_cfg_sg_›ts
->
∑r£d_sg
);

1981 
	`tfw_cfg›_sg_c›y_sched_¨g
(&
tfw_cfg_sg_def
->
sched_¨g
,

1982 
tfw_cfg_sg_›ts
->
sched_¨g
);

1983 
tfw_cfg_sg_def
->
∑r£d_sg
->
sched
 = 
tfw_cfg_sg_›ts
->parsed_sg->sched;

1984 
tfw_cfg_sg_def
->
nù_Êags
 = 
tfw_cfg_sg_›ts
->nip_flags;

1985 
tfw_cfg_sg_def
->
°icky_Êags
 = 
tfw_cfg_sg_›ts
->sticky_flags;

1986 
tfw_cfg_sg_def
->
sched_Êags
 = 
tfw_cfg_sg_›ts
->sched_flags;

1988 i‡((
r
 = 
	`tfw_cfg›_£tup_§v_group
(
tfw_cfg_sg_def
)))

1989  
r
;

1990 
tfw_cfg_sg_def
 = 
NULL
;

1993 
	}
}

1996 
	$tfw_cfg›_upd©e_§v
(
TfwSîvî
 *
‹ig_§v
, 
TfwCfgSrvGroup
 *
sg_cfg
)

1998 
TfwSîvî
 *
§v
;

1999 
r
;

2001 i‡(!(
§v
 = 
	`tfw_£rvî_lookup
(
sg_cfg
->
∑r£d_sg
, &
‹ig_§v
->
addr
)))

2002  -
EINVAL
;

2004 
	`TFW_DBG_ADDR
("Upd©ê£rvî o±i⁄s", &
§v
->
addr
);

2006 
‹ig_§v
->
weight
 = 
§v
->weight;

2008 i‡(
‹ig_§v
->
c⁄n_n
 < 
§v
->conn_n) {

2009 
r
 = 
	`tfw_sock_§v_≠≥nd_c⁄ns_n
(
‹ig_§v
,

2010 
§v
->
c⁄n_n
 - 
‹ig_§v
->conn_n);

2011 i‡(
r
)

2012  
r
;

2013 
‹ig_§v
->
c⁄n_n
 = 
§v
->conn_n;

2015 i‡(
‹ig_§v
->
c⁄n_n
 > 
§v
->conn_n) {

2022 
	`tfw_£rvî_put
(
§v
);

2025 
	}
}

2028 
	$__tfw_cfg›_upd©e_sg_§v_li°
(
TfwSrvGroup
 *
sg
, 
TfwSîvî
 *
§v
, *
d©a
)

2030 
r
 = 0;

2031 
TfwCfgSrvGroup
 *
sg_cfg
 = 
d©a
;

2034 i‡(!(
§v
->
Êags
 & 
TFW_CFG_M_ACTION
)) {

2035 i‡((
r
 = 
	`tfw_sock_§v_gø˚_shutdown_§v
(
sg
, 
§v
, 
NULL
))) {

2036 
	`TFW_ERR_NL
("graceful server shutdown failed\n");

2037  
r
;

2041 i‡(
§v
->
Êags
 & 
TFW_CFG_F_MOD
) {

2042 i‡((
r
 = 
	`tfw_cfg›_upd©e_§v
(
§v
, 
sg_cfg
))) {

2043 
	`TFW_ERR_NL
("server config update failed\n");

2044  
r
;

2047 
	`tfw_cfg›_upd©e_§v_hó…h
(
NULL
, 
§v
, 
sg_cfg
);

2050 
	`tfw_§v_ª£t_cfg_a˘i⁄s
(
§v
);

2053 
	}
}

2056 
	$tfw_cfg›_upd©e_sg_§v_li°
(
TfwCfgSrvGroup
 *
sg_cfg
)

2058 
TfwSîvî
 *
§v
, *
tmp
;

2059 
r
 = 0;

2061 
	`TFW_DBG2
("Upd©ê£rvîÜi° f‹ grou∞'%s'\n", 
sg_cfg
->
‹ig_sg
->
«me
);

2063 
r
 = 
	`__tfw_sg_f‹_óch_§v
(
sg_cfg
->
‹ig_sg
,

2064 
__tfw_cfg›_upd©e_sg_§v_li°
,

2065 
sg_cfg
);

2066 i‡(
r
)

2067  
r
;

2070 
	`li°_f‹_óch_íåy_ß„
(
§v
, 
tmp
, &
sg_cfg
->
∑r£d_sg
->
§v_li°
, 
li°
) {

2071 i‡(!
	`ã°_bô
(
TFW_CFG_B_ADD
, &
§v
->
Êags
))

2075 
	`tfw_£rvî_gë
(
§v
);

2076 
	`tfw_sg_dñ_§v
(
sg_cfg
->
∑r£d_sg
, 
§v
);

2077 
§v
->
sg
 = 
NULL
;

2078 
	`tfw_sg_add_§v
(
sg_cfg
->
‹ig_sg
, 
§v
);

2079 
	`tfw_sg_put
(
sg_cfg
->
∑r£d_sg
);

2080 
	`tfw_£rvî_put
(
§v
);

2082 i‡((
r
 = 
	`tfw_sock_§v_°¨t_§v
(
NULL
, 
§v
, 
sg_cfg
->
hm_¨g
))) {

2083 
	`TFW_ERR_NL
("cannotÉstablishÇew server connection\n");

2084  
r
;

2086 
	`tfw_§v_ª£t_cfg_a˘i⁄s
(
§v
);

2087 
	`tfw_§v_lo›_sched_rcu
();

2091 
	}
}

2099 
	$tfw_cfg›_sg_°¨t_sched
(
TfwCfgSrvGroup
 *
sg_cfg
, 
TfwSrvGroup
 *
sg
)

2101 i‡(
	`tfw_sg_°¨t_sched
(
sg
, 
sg_cfg
->
∑r£d_sg
->
sched
,

2102 
sg_cfg
->
sched_¨g
)) {

2103 
	`TFW_ERR_NL
("UnableÅoádd srv_group '%s'Åo scheduler '%s'\n",

2104 
sg
->
«me
, 
sg_cfg
->
∑r£d_sg
->
sched
->name);

2105  -
EINVAL
;

2108 
	}
}

2115 
ölöe
 

2116 
	$tfw_cfg›_upd©e_sg_hó…h
(
TfwCfgSrvGroup
 *
sg_cfg
)

2118 
	`__tfw_sg_f‹_óch_§v
(
sg_cfg
->
‹ig_sg
,

2119 
tfw_cfg›_upd©e_§v_hó…h
,

2120 
sg_cfg
);

2121 
	}
}

2124 
	$tfw_cfg›_upd©e_sg_cfg
(
TfwCfgSrvGroup
 *
sg_cfg
)

2126 
r
;

2128 
	`TFW_DBG2
("Upd©êgrou∞'%s'\n", 
sg_cfg
->
‹ig_sg
->
«me
);

2130 i‡(!(
sg_cfg
->
ªc⁄f_Êags
 &

2131 (
TFW_CFG_MDF_SG_SRV
 | 
TFW_CFG_MDF_SG_SCHED
)))

2133 
	`tfw_cfg›_sg_c›y_›ts
(
sg_cfg
->
‹ig_sg
, sg_cfg->
∑r£d_sg
);

2134 
	`tfw_cfg›_upd©e_sg_hó…h
(
sg_cfg
);

2143 
	`tfw_sg_°›_sched
(
sg_cfg
->
‹ig_sg
);

2144 
	`tfw_cfg›_sg_c›y_›ts
(
sg_cfg
->
‹ig_sg
, sg_cfg->
∑r£d_sg
);

2146 i‡(
sg_cfg
->
ªc⁄f_Êags
 & 
TFW_CFG_MDF_SG_SRV
) {

2147 i‡((
r
 = 
	`tfw_cfg›_upd©e_sg_§v_li°
(
sg_cfg
)))

2148  
r
;

2150 
	`tfw_cfg›_upd©e_sg_hó…h
(
sg_cfg
);

2152  
	`tfw_cfg›_sg_°¨t_sched
(
sg_cfg
, sg_cfg->
‹ig_sg
);

2153 
	}
}

2156 
	$tfw_cfg›_°¨t_sg_cfg
(
TfwCfgSrvGroup
 *
sg_cfg
)

2158 
r
;

2159 
TfwSrvGroup
 *
sg
 = 
sg_cfg
->
∑r£d_sg
;

2161 i‡(
sg_cfg
->
hm_«me
)

2162 
sg_cfg
->
hm_¨g
 = 
	`tfw_≠m_gë_hm
(sg_cfg->
hm_«me
);

2164 i‡(
sg_cfg
->
‹ig_sg
)

2165  
	`tfw_cfg›_upd©e_sg_cfg
(
sg_cfg
);

2167 
	`TFW_DBG2
("SetupÇew group '%s'Åo useáfterÑeconfiguration\n",

2168 
sg
->
«me
);

2169 i‡((
r
 = 
	`__tfw_sg_f‹_óch_§v
(
sg
, 
tfw_sock_§v_°¨t_§v
,

2170 
sg_cfg
->
hm_¨g
)))

2171  
r
;

2173  
	`tfw_cfg›_sg_°¨t_sched
(
sg_cfg
, 
sg
);

2174 
	}
}

2177 
	$tfw_sock_§v_°¨t
()

2179 
r
;

2180 
TfwCfgSrvGroup
 *
sg_cfg
;

2181 
TfwSrvGroup
 *
sg
;

2182 
hli°_node
 *
tmp
;

2183 
	`HLIST_HEAD
(
‹ph™_sgs
);

2185 
tfw_cfg_gø˚_time
 = 
tfw_cfg_gø˚_time_ªc⁄fig
;

2187 
	`li°_f‹_óch_íåy
(
sg_cfg
, &
sg_cfg_li°
, 
li°
) {

2188 i‡((
r
 = 
	`tfw_cfg›_°¨t_sg_cfg
(
sg_cfg
)))

2189  
r
;

2190 
	`tfw_§v_lo›_sched_rcu
();

2193 
	`tfw_sg_≠∂y_ªc⁄fig
(&
‹ph™_sgs
);

2194 
	`hli°_f‹_óch_íåy_ß„
(
sg
, 
tmp
, &
‹ph™_sgs
, 
li°
) {

2195 
	`tfw_sock_§v_gø˚_shutdown_sg
(
sg
);

2196 
	`tfw_§v_lo›_sched_rcu
();

2199 
	`tfw_hâp_£ss_u£_°icky_£ss
(
tfw_cfg_u£_°icky_£ss
);

2200 
	`tfw_cfg›_˛ónup_§v_cfgs
(
Ál£
);

2203 
	}
}

2206 
	$tfw_sock_§v_°›
()

2209 
	`tfw_sg_f‹_óch_§v_ªc⁄fig
(
tfw_sock_§v_disc⁄√˘_§v
);

2210 
	`tfw_sock_§v_gø˚_shutdown_now
();

2211 
	`tfw_sg_f‹_óch_§v
(
NULL
, 
tfw_sock_§v_disc⁄√˘_§v
);

2212 
	`tfw_sg_ªÀa£_Æl
();

2213 
	}
}

2216 
TfwCfgS≥c
 
	gtfw_§v_group_•ecs
[] = {

2218 .
«me
 = "server",

2219 .
	gdeÊt
 = 
NULL
,

2220 .
	gh™dÀr
 = 
tfw_cfg›_ö_£rvî
,

2221 .
	gÆlow_ª≥©
 = 
åue
,

2222 .
	gÆlow_ªc⁄fig
 = 
åue
,

2225 .
	g«me
 = "sched",

2226 .
	gdeÊt
 = "ratio static",

2227 .
	gh™dÀr
 = 
tfw_cfg›_ö_sched
,

2228 .
	gÆlow_n⁄e
 = 
åue
,

2229 .
	gÆlow_ª≥©
 = 
Ál£
,

2230 .
	gÆlow_ªc⁄fig
 = 
åue
,

2233 .
	g«me
 = "server_queue_size",

2234 .
	gdeÊt
 = "1000",

2235 .
	gh™dÀr
 = 
tfw_cfg›_ö_queue_size
,

2236 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2237 .
ønge
 = { 0, 
INT_MAX
 },

2239 .
	gÆlow_n⁄e
 = 
åue
,

2240 .
	gÆlow_ª≥©
 = 
Ál£
,

2241 .
	gÆlow_ªc⁄fig
 = 
åue
,

2244 .
	g«me
 = "server_forward_timeout",

2245 .
	gdeÊt
 = "60",

2246 .
	gh™dÀr
 = 
tfw_cfg›_ö_fwd_timeout
,

2247 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2248 .
ønge
 = { 0, 
INT_MAX
 },

2250 .
	gÆlow_n⁄e
 = 
åue
,

2251 .
	gÆlow_ª≥©
 = 
Ál£
,

2252 .
	gÆlow_ªc⁄fig
 = 
åue
,

2255 .
	g«me
 = "server_forward_retries",

2256 .
	gdeÊt
 = "5",

2257 .
	gh™dÀr
 = 
tfw_cfg›_ö_fwd_ªåõs
,

2258 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2259 .
ønge
 = { 0, 
INT_MAX
 },

2261 .
	gÆlow_n⁄e
 = 
åue
,

2262 .
	gÆlow_ª≥©
 = 
Ál£
,

2263 .
	gÆlow_ªc⁄fig
 = 
åue
,

2266 .
	g«me
 = "server_retry_nonidempotent",

2267 .
	gdeÊt
 = 
TFW_CFG_DFLT_VAL
,

2268 .
	gh™dÀr
 = 
tfw_cfg›_ö_ªåy_nù
,

2269 .
	gÆlow_n⁄e
 = 
åue
,

2270 .
	gÆlow_ª≥©
 = 
Ál£
,

2271 .
	gÆlow_ªc⁄fig
 = 
åue
,

2274 .
	g«me
 = "server_connect_retries",

2275 .
	gdeÊt
 = "10",

2276 .
	gh™dÀr
 = 
tfw_cfg›_ö_c⁄n_ªåõs
,

2277 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2278 .
ønge
 = { 0, 
INT_MAX
 },

2280 .
	gÆlow_n⁄e
 = 
åue
,

2281 .
	gÆlow_ª≥©
 = 
Ál£
,

2282 .
	gÆlow_ªc⁄fig
 = 
åue
,

2285 .
	g«me
 = "sticky_sessions",

2286 .
	gdeÊt
 = 
TFW_CFG_DFLT_VAL
,

2287 .
	gh™dÀr
 = 
tfw_cfg›_ö_°icky_£ss
,

2288 .
	gÆlow_n⁄e
 = 
åue
,

2289 .
	gÆlow_ª≥©
 = 
Ál£
,

2290 .
	gÆlow_ªc⁄fig
 = 
åue
,

2293 .
	g«me
 = "health",

2294 .
	gdeÊt
 = 
NULL
,

2295 .
	gh™dÀr
 = 
tfw_cfg›_ö_hó…h_m⁄ô‹
,

2296 .
	gÆlow_n⁄e
 = 
åue
,

2297 .
	gÆlow_ª≥©
 = 
Ál£
,

2298 .
	gÆlow_ªc⁄fig
 = 
åue
,

2303 
TfwCfgS≥c
 
	gtfw_sock_§v_•ecs
[] = {

2305 .
«me
 = "server",

2306 .
	gdeÊt
 = 
NULL
,

2307 .
	gh™dÀr
 = 
tfw_cfg›_out_£rvî
,

2308 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2309 .
	gÆlow_n⁄e
 = 
åue
,

2310 .
	gÆlow_ª≥©
 = 
åue
,

2311 .
	gÆlow_ªc⁄fig
 = 
åue
,

2314 .
	g«me
 = "sched",

2315 .
	gdeÊt
 = "ratio static",

2316 .
	gh™dÀr
 = 
tfw_cfg›_out_sched
,

2317 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2318 .
	gÆlow_n⁄e
 = 
åue
,

2319 .
	gÆlow_ª≥©
 = 
Ál£
,

2320 .
	gÆlow_ªc⁄fig
 = 
åue
,

2323 .
	g«me
 = "server_queue_size",

2324 .
	gdeÊt
 = "1000",

2325 .
	gh™dÀr
 = 
tfw_cfg›_out_queue_size
,

2326 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2327 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2328 .
ønge
 = { 0, 
INT_MAX
 },

2330 .
	gÆlow_n⁄e
 = 
åue
,

2331 .
	gÆlow_ª≥©
 = 
Ál£
,

2332 .
	gÆlow_ªc⁄fig
 = 
åue
,

2335 .
	g«me
 = "server_forward_timeout",

2336 .
	gdeÊt
 = "60",

2337 .
	gh™dÀr
 = 
tfw_cfg›_out_fwd_timeout
,

2338 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2339 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2340 .
ønge
 = { 0, 
INT_MAX
 },

2342 .
	gÆlow_n⁄e
 = 
åue
,

2343 .
	gÆlow_ª≥©
 = 
Ál£
,

2344 .
	gÆlow_ªc⁄fig
 = 
åue
,

2347 .
	g«me
 = "server_forward_retries",

2348 .
	gdeÊt
 = "5",

2349 .
	gh™dÀr
 = 
tfw_cfg›_out_fwd_ªåõs
,

2350 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2351 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2352 .
ønge
 = { 0, 
INT_MAX
 },

2354 .
	gÆlow_n⁄e
 = 
åue
,

2355 .
	gÆlow_ª≥©
 = 
Ál£
,

2356 .
	gÆlow_ªc⁄fig
 = 
åue
,

2359 .
	g«me
 = "server_retry_nonidempotent",

2360 .
	gdeÊt
 = 
TFW_CFG_DFLT_VAL
,

2361 .
	gh™dÀr
 = 
tfw_cfg›_out_ªåy_nù
,

2362 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2363 .
	gÆlow_n⁄e
 = 
åue
,

2364 .
	gÆlow_ª≥©
 = 
Ál£
,

2365 .
	gÆlow_ªc⁄fig
 = 
åue
,

2368 .
	g«me
 = "server_connect_retries",

2369 .
	gdeÊt
 = "10",

2370 .
	gh™dÀr
 = 
tfw_cfg›_out_c⁄n_ªåõs
,

2371 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2372 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2373 .
ønge
 = { 0, 
INT_MAX
 },

2375 .
	gÆlow_n⁄e
 = 
åue
,

2376 .
	gÆlow_ª≥©
 = 
Ál£
,

2377 .
	gÆlow_ªc⁄fig
 = 
åue
,

2380 .
	g«me
 = "sticky_sessions",

2381 .
	gdeÊt
 = 
TFW_CFG_DFLT_VAL
,

2382 .
	gh™dÀr
 = 
tfw_cfg›_out_°icky_£ss
,

2383 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2384 .
	gÆlow_n⁄e
 = 
åue
,

2385 .
	gÆlow_ª≥©
 = 
Ál£
,

2386 .
	gÆlow_ªc⁄fig
 = 
åue
,

2389 .
	g«me
 = "health",

2390 .
	gdeÊt
 = 
NULL
,

2391 .
	gh™dÀr
 = 
tfw_cfg›_out_hó…h_m⁄ô‹
,

2392 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2393 .
	gÆlow_n⁄e
 = 
åue
,

2394 .
	gÆlow_ª≥©
 = 
Ál£
,

2395 .
	gÆlow_ªc⁄fig
 = 
åue
,

2398 .
	g«me
 = "srv_group",

2399 .
	gdeÊt
 = 
NULL
,

2400 .
	gh™dÀr
 = 
tfw_cfg_h™dÀ_chûdªn
,

2401 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_§v_groups
,

2402 .
	gde°
 = 
tfw_§v_group_•ecs
,

2403 .
	g•ec_ext
 = &(
TfwCfgS≥cChûd
 ) {

2404 .
begö_hook
 = 
tfw_cfg›_begö_§v_group
,

2405 .
	gföish_hook
 = 
tfw_cfg›_föish_§v_group


2407 .
	gÆlow_n⁄e
 = 
åue
,

2408 .
	gÆlow_ª≥©
 = 
åue
,

2409 .
	gÆlow_ªc⁄fig
 = 
åue
,

2412 .
	g«me
 = "grace_shutdown_time",

2413 .
	gdeÊt
 = "0",

2414 .
	gh™dÀr
 = 
tfw_cfg›_gø˚_time
,

2415 .
	g•ec_ext
 = &(
TfwCfgS≥cI¡
) {

2416 .
ønge
 = { 0, 
INT_MAX
 },

2418 .
	gÆlow_n⁄e
 = 
åue
,

2419 .
	gÆlow_ª≥©
 = 
Ál£
,

2420 .
	gÆlow_ªc⁄fig
 = 
åue
,

2425 
TfwMod
 
	gtfw_sock_§v_mod
 = {

2426 .
«me
 = "sock_srv",

2427 .
	gcfg°¨t
 = 
tfw_sock_§v_cfg°¨t
,

2428 .
	gcfgíd
 = 
tfw_sock_§v_cfgíd
,

2429 .
	gcfg˛ón
 = 
tfw_sock_§v_cfg˛ón
,

2430 .
	g°¨t
 = 
tfw_sock_§v_°¨t
,

2431 .
	g°›
 = 
tfw_sock_§v_°›
,

2432 .
	g•ecs
 = 
tfw_sock_§v_•ecs
,

2442 
	$tfw_sock_§v_öô
()

2444 
	`BUILD_BUG_ON
(
_TFW_PSTATS_IDX_COUNT
 > 
TFW_SG_M_PSTATS_IDX
);

2445 
	`BUG_ON
(
tfw_§v_c⁄n_ˇche
);

2447 
tfw_§v_c⁄n_ˇche
 = 
	`kmem_ˇche_¸óã
("tfw_srv_conn_cache",

2448 (
TfwSrvC⁄n
), 0, 0, 
NULL
);

2449 i‡(!
tfw_§v_c⁄n_ˇche
)

2450  -
ENOMEM
;

2452 
tfw_sg_cfg_ˇche
 = 
	`kmem_ˇche_¸óã
("tfw_sg_cfg_cache",

2453 (
TfwCfgSrvGroup
), 0, 0, 
NULL
);

2454 i‡(!
tfw_sg_cfg_ˇche
)

2455  -
ENOMEM
;

2457 
	`tfw_mod_ªgi°î
(&
tfw_sock_§v_mod
);

2460 
	}
}

2463 
	$tfw_sock_§v_exô
()

2465 
	`tfw_mod_uƒegi°î
(&
tfw_sock_§v_mod
);

2466 
	`kmem_ˇche_de°roy
(
tfw_§v_c⁄n_ˇche
);

2467 
	`kmem_ˇche_de°roy
(
tfw_sg_cfg_ˇche
);

2468 
	}
}

	@ss_skb.c

26 
	~<löux/ù.h
>

27 
	~<löux/ùv6.h
>

28 
	~<√t/sock.h
>

29 
	~<√t/t˝.h
>

30 
	~<√t/x‰m.h
>

32 #i‚de‡
DBG_SS


33 #unde‡
DEBUG


35 
	~"lib/°r.h
"

36 
	~"addr.h
"

37 
	~"¥ocfs.h
"

38 
	~"ss_skb.h
"

54 
	$ss_skb_fmt_§c_addr
(c⁄° 
sk_buff
 *
skb
, *
out_buf
)

56 c⁄° 
ùhdr
 *
ih4
 = 
	`ù_hdr
(
skb
);

57 c⁄° 
ùv6hdr
 *
ih6
 = 
	`ùv6_hdr
(
skb
);

59 i‡(
ih6
->
vîsi⁄
 == 6)

60  
	`tfw_addr_fmt_v6
(&
ih6
->
ßddr
, 0, 
out_buf
);

62  
	`tfw_addr_fmt_v4
(
ih4
->
ßddr
, 0, 
out_buf
);

63 
	}
}

75 
sk_buff
 *

76 
	$ss_skb_Æloc_∑ges
(
size_t
 
Àn
)

78 
i
, 
ƒ_‰ags
 = 0;

79 
sk_buff
 *
skb
;

81 i‡(
Àn
 > 
SKB_MAX_HEADER
) {

82 
ƒ_‰ags
 = 
	`DIV_ROUND_UP
(
Àn
 - 
SKB_MAX_HEADER
, 
PAGE_SIZE
);

83 
	`BUG_ON
(
ƒ_‰ags
 > 
MAX_SKB_FRAGS
);

84 
Àn
 = 
SKB_MAX_HEADER
;

87 i‡(!(
skb
 = 
	`ss_skb_Æloc
(
Àn
)))

88  
NULL
;

90 
i
 = 0; i < 
ƒ_‰ags
; ++i) {

91 
∑ge
 *∑gê
	`Æloc_∑ge
(
GFP_ATOMIC
);

92 i‡(!
∑ge
) {

93 
	`k‰ì_skb
(
skb
);

94  
NULL
;

96 
	`skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 0, 0);

97 
	`TFW_DBG3
("CreatedÇew frag %d,%p for skb %p\n",

98 
i
, 
	`∑ge_addªss
(
∑ge
), 
skb
);

101  
skb
;

102 
	}
}

111 
	$ss_skb_Æloc_d©a
(
sk_buff
 **
skb_hód
, 
size_t
 
Àn
)

113 
i_skb
, 
ƒ_skbs
 = 
Àn
 ? 
	`DIV_ROUND_UP
÷í, 
SS_SKB_MAX_DATA_LEN
) : 1;

114 
size_t
 
n
 = 0;

115 
sk_buff
 *
skb
;

117 
i_skb
 = 0; i_skb < 
ƒ_skbs
; ++i_skb, 
Àn
 -
n
) {

118 
n
 = 
	`mö
(
Àn
, 
SS_SKB_MAX_DATA_LEN
);

119 
skb
 = 
	`ss_skb_Æloc_∑ges
(
n
);

120 i‡(!
skb
)

121  -
ENOMEM
;

122 
	`ss_skb_queue_èû
(
skb_hód
, 
skb
);

126 
	}
}

128 
ölöe
 

129 
	$ss_skb_‰ag_Àn
(c⁄° 
skb_‰ag_t
 *
‰ag
)

131  
‰ag
->
∑ge_off£t
 + føg->
size
;

132 
	}
}

165 
boﬁ


166 
	$__lookup_pg‰ag_room
(c⁄° 
sk_buff
 *
skb
, 
Àn
, 
skb_‰ag_t
 *
f_out
)

168 
i
, 
k
, 
ªf˙t
;

169 
m≠
[
MAX_SKB_FRAGS
];

170 c⁄° 
skb_‰ag_t
 *
f_ba£
, *
f_this
;

171 
p_size
, 
h_room
, 
t_room
;

172 
∑ge
 *
p_ba£
, *
p_skb_hód
 = 
	`vút_to_hód_∑ge
(
skb
->
hód
);

174 
	`bzîo_Á°
(
m≠
, (map));

176 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; i++) {

177 i‡(
m≠
[
i
])

180 
f_ba£
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

181 
p_ba£
 = 
	`compound_hód
(
	`skb_‰ag_∑ge
(
f_ba£
));

182 i‡(
p_ba£
 =
p_skb_hód
)

185 
ªf˙t
 = 
	`∑ge_cou¡
(
p_ba£
) - 1;

186 
p_size
 = 
PAGE_SIZE
 << 
	`compound_‹dî
(
p_ba£
);

188 
h_room
 = 
f_ba£
->
∑ge_off£t
;

189 
t_room
 = 
p_size
 - 
	`ss_skb_‰ag_Àn
(
f_ba£
);

190 
m≠
[
i
] = !!(
Àn
 > 
h_room
 &&Üí > 
t_room
);

192 
k
 = 
i
 + 1; 
ªf˙t
 && (k < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
); k++) {

193 i‡(
m≠
[
k
])

196 
f_this
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
k
];

197 i‡(
	`compound_hód
(
	`skb_‰ag_∑ge
(
f_this
)Ë!
p_ba£
)

200 --
ªf˙t
;

201 
m≠
[
k
] = 1;

202 i‡(
m≠
[
i
])

205 
h_room
 = 
	`mö
(h_room, 
f_this
->
∑ge_off£t
);

206 
t_room
 = 
	`mö
—_room, 
p_size
 - 
	`ss_skb_‰ag_Àn
(
f_this
));

207 
m≠
[
i
] = !!(
Àn
 > 
h_room
 &&Üí > 
t_room
);

210 i‡(!
ªf˙t
 && !
m≠
[
i
])

211 
suc˚ss
;

214 
	`TFW_INC_STAT_BH
(
ss
.
pÊ_mis£s
);

215  
Ál£
;

217 
suc˚ss
:

218 
	`BUG_ON
(
Àn
 > 
h_room
 &&Üí > 
t_room
);

219 
f_out
->
∑ge
.
p
 = 
p_ba£
;

220 
f_out
->
∑ge_off£t
 = 
Àn
 > 
h_room
 ? 
p_size
 - 
t_room
 : h_room -Üen;

221 
	`TFW_INC_STAT_BH
(
ss
.
pÊ_hôs
);

222  
åue
;

223 
	}
}

229 
ölöe
 *

230 
	$__skb_d©a_addªss
(
sk_buff
 *
skb
)

232 i‡(
skb
 =
NULL
)

233  
NULL
;

234 i‡(
	`skb_hódÀn
(
skb
))

235  
skb
->
d©a
;

236 
	`WARN_ON_ONCE
(!
	`skb_is_n⁄löór
(
skb
));

237 i‡(
	`skb_shöfo
(
skb
)->
ƒ_‰ags
)

238  
	`skb_‰ag_addªss
(&
	`skb_shöfo
(
skb
)->
‰ags
[0]);

239 
	`WARN_ON_ONCE
(
	`skb_has_‰ag_li°
(
skb
));

240  
NULL
;

241 
	}
}

248 
ölöe
 

249 
	$__ô_√xt_d©a
(
sk_buff
 *
skb
, 
i
, 
TfwSå
 *
ô
)

251 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

252 i‡(
i
 < 
si
->
ƒ_‰ags
) {

253 
ô
->
±r
 = 
	`skb_‰ag_addªss
(&
si
->
‰ags
[
i
]);

254 
ô
->
skb
 = skb;

256 
ô
->
skb
 = skb->
√xt
;

257 
ô
->
±r
 = 
	`__skb_d©a_addªss
(ô->
skb
);

259 
	}
}

268 
ölöe
 

269 
	$__skb_ö£π_a·î
(
sk_buff
 *
skb
, sk_buf‡*
nskb
)

271 
nskb
->
√xt
 = 
skb
->next;

272 
nskb
->
¥ev
 = 
skb
;

273 
nskb
->
√xt
->
¥ev
 = 
skb
->next =Çskb;

274 
	}
}

284 
	$__exãnd_pg‰ags
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, 
‰om
, 
n
)

286 
i
, 
n_shi·
, 
n_ex˚ss
 = 0;

287 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

289 
	`BUG_ON
((
n
 <= 0) || (n > 2));

290 
	`BUG_ON
(
‰om
 > 
si
->
ƒ_‰ags
);

293 i‡(
si
->
ƒ_‰ags
 + 
n
 > 
MAX_SKB_FRAGS
) {

294 
skb_‰ag_t
 *
f
;

295 
sk_buff
 *
nskb
;

296 
e_size
 = 0;

299 i‡(!
skb_hód
)

300  -
ENOMEM
;

306 
n_ex˚ss
 = 
si
->
ƒ_‰ags
 + 
n
 - 
MAX_SKB_FRAGS
;

313 
nskb
 = 
skb
->
√xt
;

314 i‡(
nskb
 !
skb_hód
 && !
	`skb_hódÀn
(nskb)

315 && (
	`skb_shöfo
(
nskb
)->
ƒ_‰ags
 <
MAX_SKB_FRAGS
 - 
n_ex˚ss
))

317 
r
 = 
	`__exãnd_pg‰ags
(
skb_hód
, 
nskb
, 0, 
n_ex˚ss
);

318 i‡(
r
)

319  
r
;

321 
nskb
 = 
	`ss_skb_Æloc
(0);

322 i‡(
nskb
 =
NULL
)

323  -
ENOMEM
;

324 
	`__skb_ö£π_a·î
(
skb
, 
nskb
);

325 
	`skb_shöfo
(
nskb
)->
ƒ_‰ags
 = 
n_ex˚ss
;

329 i‡(
‰om
 =
si
->
ƒ_‰ags
)

333 
i
 = 
n_ex˚ss
 - 1; i >= 0; --i) {

334 
f
 = &
si
->
‰ags
[
MAX_SKB_FRAGS
 - 
n
 + 
i
];

335 
	`skb_shöfo
(
nskb
)->
‰ags
[
i
] = *
f
;

336 
e_size
 +
	`skb_‰ag_size
(
f
);

338 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
e_size
);

339 
	`ss_skb_adju°_d©a_Àn
(
nskb
, 
e_size
);

343 
n_shi·
 = 
si
->
ƒ_‰ags
 - 
‰om
 - 
n_ex˚ss
;

344 
	`BUG_ON
(
n_shi·
 < 0);

345 i‡(
n_shi·
)

346 
	`memmove
(&
si
->
‰ags
[
‰om
 + 
n
],

347 &
si
->
‰ags
[
‰om
], 
n_shi·
 * (
skb_‰ag_t
));

348 
si
->
ƒ_‰ags
 +
n
 - 
n_ex˚ss
;

351 
	}
}

358 
	$__√w_pg‰ag
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, 
size
,

359 
i
, 
shi·
)

361 
off
 = 0;

362 
skb_‰ag_t
 
‰ag
;

363 
∑ge
 *∑gê
NULL
;

365 
	`BUG_ON
(
i
 > 
MAX_SKB_FRAGS
);

371 i‡(
	`__lookup_pg‰ag_room
(
skb
, 
size
, &
‰ag
)) {

372 
∑ge
 = 
	`skb_‰ag_∑ge
(&
‰ag
);

373 
off
 = 
‰ag
.
∑ge_off£t
;

374 
	`gë_∑ge
(
∑ge
);

376 
∑ge
 = 
	`Æloc_∑ge
(
GFP_ATOMIC
);

377 i‡(!
∑ge
)

378  -
ENOMEM
;

382 i‡(
	`__exãnd_pg‰ags
(
skb_hód
, 
skb
, 
i
, 
shi·
)) {

383 
	`put_∑ge
(
∑ge
);

384  -
ENOMEM
;

392 i‡(
i
 =
MAX_SKB_FRAGS
) {

393 
i
 = 0;

394 
skb
 = skb->
√xt
;

398 
	`__skb_fûl_∑ge_desc
(
skb
, 
i
, 
∑ge
, 
off
, 
size
);

399 
	`ss_skb_adju°_d©a_Àn
(
skb
, 
size
);

402 
	}
}

415 
	$__•lô_löór_d©a
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, *
p•t
,

416 
Àn
, 
TfwSå
 *
ô
)

418 
Æloc
 = 
Àn
 > 0;

419 
∑ge
 *∑gê
	`vút_to_hód_∑ge
(
skb
->
hód
);

420 
èû_Àn
 = (*)
	`skb_èû_poöãr
(
skb
Ë- 
p•t
;

421 
èû_off
 = 
p•t
 - (*)
	`∑ge_addªss
(
∑ge
);

423 
	`TFW_DBG3
("[%d]: %s: skb [%p]Öspt [%p]Üen [%d]Åail_len [%d]\n",

424 
	`smp_¥o˚ss‹_id
(), 
__func__
, 
skb
, 
p•t
, 
Àn
, 
èû_Àn
);

425 
	`BUG_ON
(!
skb
->
hód_‰ag
);

426 
	`BUG_ON
(
èû_Àn
 <= 0);

427 
	`BUG_ON
(!(
Æloc
 | 
èû_Àn
));

428 
	`BUG_ON
(-
Àn
 > 
èû_Àn
);

435 i‡(
	`u∆ikñy
((
Àn
 < 0Ë&& (
èû_Àn
 == -len))) {

436 
	`ss_skb_put
(
skb
, 
Àn
);

437 
	`__ô_√xt_d©a
(
skb
, 0, 
ô
);

467 i‡(
Æloc
) {

468 i‡(
	`__√w_pg‰ag
(
skb_hód
, 
skb
, 
Àn
, 0, 1 + !!
èû_Àn
))

469  -
EFAULT
;

471 i‡(
	`__exãnd_pg‰ags
(
skb_hód
, 
skb
, 0, 1))

472  -
EFAULT
;

479 i‡(
Àn
 < 0) {

480 
	`ss_skb_put
(
skb
, 
Àn
);

481 
èû_Àn
 +
Àn
;

482 
èû_off
 -
Àn
;

484 
skb
->
èû
 -
èû_Àn
;

485 
skb
->
d©a_Àn
 +
èû_Àn
;

488 
	`__skb_fûl_∑ge_desc
(
skb
, 
Æloc
, 
∑ge
, 
èû_off
, 
èû_Àn
);

489 
	`gë_∑ge
(
∑ge
);

492 
skb
->
èû_lock
 = 1;

498 
ô
->
±r
 = 
	`skb_‰ag_addªss
(&
	`skb_shöfo
(
skb
)->
‰ags
[0]);

499 
ô
->
skb
 = skb;

502 
	}
}

521 
	$__•lô_pg‰ag_add
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, 
i
, 
off
,

522 
Àn
, 
TfwSå
 *
ô
)

524 
èû_Àn
;

525 
sk_buff
 *
skb_d°
, *
skb_√w
;

526 
skb_‰ag_t
 *
‰ag_d°
, *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

528 
	`TFW_DBG3
("[%d]: %s: skb [%p] i [%d] off [%d]Üen [%d] fragsize [%d]\n",

529 
	`smp_¥o˚ss‹_id
(), 
__func__
,

530 
skb
, 
i
, 
off
, 
Àn
, 
	`skb_‰ag_size
(
‰ag
));

540 i‡(
	`__√w_pg‰ag
(
skb_hód
, 
skb
, 
Àn
, 
i
 + !!
off
, 1 + !!off))

541  -
EFAULT
;

544 i‡(!
off
) {

545 
ô
->
±r
 = 
	`skb_‰ag_addªss
(
‰ag
);

546 
ô
->
skb
 = skb;

561 
skb_√w
 = 
skb
->
√xt
;

564 
skb_d°
 = (
i
 < 
MAX_SKB_FRAGS
 - 2Ë? 
skb
 : 
skb_√w
;

567 
èû_Àn
 = 
	`skb_‰ag_size
(
‰ag
Ë- 
off
;

570 
	`skb_‰ag_size_sub
(
‰ag
, 
èû_Àn
);

573 
i
 = (ò+ 2Ë% 
MAX_SKB_FRAGS
;

574 
	`__skb_fûl_∑ge_desc
(
skb_d°
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

575 
‰ag
->
∑ge_off£t
 + 
off
, 
èû_Àn
);

576 
	`__skb_‰ag_ªf
(
‰ag
);

579 i‡(
skb
 !
skb_d°
) {

580 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
èû_Àn
);

581 
	`ss_skb_adju°_d©a_Àn
(
skb_d°
, 
èû_Àn
);

585 i‡(
i
 < 
MAX_SKB_FRAGS
 - 1) {

586 
‰ag_d°
 = 
‰ag
 + 1;

588 
‰ag_d°
 = &
	`skb_shöfo
(
skb_√w
)->
‰ags
[0];

589 
skb
 = 
skb_√w
;

591 
ô
->
±r
 = 
	`skb_‰ag_addªss
(
‰ag_d°
);

592 
ô
->
skb
 = skb;

595 
	}
}

605 
	$__•lô_pg‰ag_dñ
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, 
i
, 
off
,

606 
Àn
, 
TfwSå
 *
ô
)

608 
èû_Àn
;

609 
sk_buff
 *
skb_d°
;

610 
skb_‰ag_t
 *
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

611 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

613 
	`TFW_DBG3
("[%d]: %s: skb [%p] i [%d] off [%d]Üen [%d] fragsize [%d]\n",

614 
	`smp_¥o˚ss‹_id
(), 
__func__
,

615 
skb
, 
i
, 
off
, 
Àn
, 
	`skb_‰ag_size
(
‰ag
));

617 i‡(
	`u∆ikñy
(
off
 + 
Àn
 > 
	`skb_‰ag_size
(
‰ag
))) {

618 
	`TFW_WARN
("AttemptÅo deleteÅoo much\n");

619  -
EFAULT
;

623 i‡(
	`u∆ikñy
(!
off
 && 
Àn
 =
	`skb_‰ag_size
(
‰ag
))) {

624 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
Àn
);

625 
	`__skb_‰ag_uƒef
(
‰ag
);

626 i‡(
i
 + 1 < 
si
->
ƒ_‰ags
)

627 
	`memmove
(&
si
->
‰ags
[
i
], &si->frags[i + 1],

628 (
si
->
ƒ_‰ags
 - 
i
 - 1Ë* (
skb_‰ag_t
));

629 --
si
->
ƒ_‰ags
;

630 
	`__ô_√xt_d©a
(
skb
, 
i
, 
ô
);

634 i‡(
	`likñy
(!
off
)) {

635 
‰ag
->
∑ge_off£t
 +
Àn
;

636 
	`skb_‰ag_size_sub
(
‰ag
, 
Àn
);

637 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
Àn
);

638 
ô
->
±r
 = 
	`skb_‰ag_addªss
(
‰ag
);

639 
ô
->
skb
 = skb;

643 i‡(
	`likñy
(
off
 + 
Àn
 =
	`skb_‰ag_size
(
‰ag
))) {

644 
	`skb_‰ag_size_sub
(
‰ag
, 
Àn
);

645 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
Àn
);

646 
	`__ô_√xt_d©a
(
skb
, 
i
 + 1, 
ô
);

659 i‡(
	`__exãnd_pg‰ags
(
skb_hód
, 
skb
, 
i
 + 1, 1))

660  -
EFAULT
;

663 
skb_d°
 = (
i
 < 
MAX_SKB_FRAGS
 - 1Ë? 
skb
 : skb->
√xt
;

666 
èû_Àn
 = 
	`skb_‰ag_size
(
‰ag
Ë- 
off
 - 
Àn
;

669 
i
 = (ò+ 1Ë% 
MAX_SKB_FRAGS
;

670 
	`__skb_fûl_∑ge_desc
(
skb_d°
, 
i
, 
	`skb_‰ag_∑ge
(
‰ag
),

671 
‰ag
->
∑ge_off£t
 + 
off
 + 
Àn
, 
èû_Àn
);

672 
	`__skb_‰ag_ªf
(
‰ag
);

675 
	`skb_‰ag_size_sub
(
‰ag
, 
Àn
 + 
èû_Àn
);

678 i‡(
skb
 !
skb_d°
) {

679 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
èû_Àn
);

680 
	`ss_skb_adju°_d©a_Àn
(
skb_d°
, 
èû_Àn
);

682 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
Àn
);

685 
ô
->
±r
 = 
	`skb_‰ag_addªss
(&
	`skb_shöfo
(
skb_d°
)->
‰ags
[
i
]);

686 
ô
->
skb
 = 
skb_d°
;

689 
	}
}

692 
	$__•lô_pg‰ag
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, 
i
, 
off
,

693 
Àn
, 
TfwSå
 *
ô
)

695  
Àn
 > 0

696 ? 
	`__•lô_pg‰ag_add
(
skb_hód
, 
skb
, 
i
, 
off
, 
Àn
, 
ô
)

697 : 
	`__•lô_pg‰ag_dñ
(
skb_hód
, 
skb
, 
i
, 
off
, -
Àn
, 
ô
);

698 
	}
}

700 
ölöe
 

701 
	$__•lô_åy_èûroom
(
sk_buff
 *
skb
, 
Àn
, 
TfwSå
 *
ô
)

703 i‡(
Àn
 > 
	`skb_èûroom_locked
(
skb
))

704  -
ENOSPC
;

705 
ô
->
±r
 = 
	`ss_skb_put
(
skb
, 
Àn
);

706 
ô
->
skb
 = skb;

708 
	}
}

715 
	$__skb_‰agmít
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, *
p•t
,

716 
Àn
, 
TfwSå
 *
ô
)

718 
i
 = -1, 
ªt
;

719 
off£t
;

720 
d_size
;

721 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

723 
	`TFW_DBG3
("[%d]: %s:Üen=%dÖspt=%pK skb=%pK head=%pK data=%pKÅail=%pK"

725 
	`smp_¥o˚ss‹_id
(), 
__func__
, 
Àn
, 
p•t
, 
skb
, skb->
hód
,

726 
skb
->
d©a
, 
	`skb_èû_poöãr
(skb), 
	`skb_íd_poöãr
(skb),

727 
skb
->
Àn
, skb->
d©a_Àn
, skb->
åuesize
, 
si
->
ƒ_‰ags
);

728 
	`BUG_ON
(!
Àn
);

742 
d_size
 = 
	`skb_hódÀn
(
skb
);

743 
off£t
 = 
p•t
 - (*)
skb
->
d©a
;

744 i‡(
off£t
 >0 && off£à< 
d_size
) {

745 
t_size
 = 
d_size
 - 
off£t
;

746 
Àn
 = 
	`max
÷í, -
t_size
);

747 
ªt
 = 
	`__•lô_löór_d©a
(
skb_hód
, 
skb
, 
p•t
, 
Àn
, 
ô
);

748 
d⁄e
;

757 i‡(
Àn
 > 0) {

758 
off£t
 = 
	`u∆ikñy
(off£à=
d_size
) ? 0 :

759 
p•t
 - (*)
	`skb_‰ag_addªss
(&
si
->
‰ags
[0]);

760 i‡(
	`u∆ikñy
(!
off£t
)) {

761 i‡(!(
ªt
 = 
	`__•lô_åy_èûroom
(
skb
, 
Àn
, 
ô
)))

762 
d⁄e
;

763 
≠≥nd
;

768 
i
 = 0; i < 
si
->
ƒ_‰ags
; ++i) {

769 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
si
->
‰ags
[
i
];

770 
d_size
 = 
	`skb_‰ag_size
(
‰ag
);

771 
off£t
 = 
p•t
 - (*)
	`skb_‰ag_addªss
(
‰ag
);

773 i‡(
off£t
 >0 && off£à<
d_size
) {

774 
t_size
 = 
d_size
 - 
off£t
;

775 i‡(!
t_size
) {

781 i‡(
Àn
 > 0)

782 
≠≥nd
;

785 
Àn
 = 
	`max
÷í, -
t_size
);

786 
ªt
 = 
	`__•lô_pg‰ag
(
skb_hód
, 
skb
, 
i
, 
off£t
, 
Àn
, 
ô
);

787 
d⁄e
;

792  -
ENOENT
;

794 
≠≥nd
:

796 
ªt
 = 
	`__√w_pg‰ag
(
skb_hód
, 
skb
, 
Àn
, 
i
 + 1, 1);

797 
	`__ô_√xt_d©a
(
skb
, 
i
 + 1, 
ô
);

799 
d⁄e
:

800 
	`TFW_DBG3
("[%d]: %s: out:Ñes [%p], skb [%p]: head [%p] data [%p]"

803 
	`smp_¥o˚ss‹_id
(), 
__func__
, 
ô
->
±r
, 
skb
, skb->
hód
,

804 
skb
->
d©a
, 
	`skb_èû_poöãr
(skb), 
	`skb_íd_poöãr
(skb),

805 
skb
->
Àn
, skb->
d©a_Àn
, skb->
åuesize
, 
si
->
ƒ_‰ags
);

807 i‡(
ªt
 < 0)

808  
ªt
;

809 i‡((
ô
->
±r
 =
NULL
Ë|| (ô->
skb
 == NULL))

810  -
EFAULT
;

811 
ô
->
Àn
 = 
	`max
(0,Üen);

814  
	`abs
(
Àn
);

815 
	}
}

817 
ölöe
 

818 
	$skb_‰agmít
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, *
p•t
,

819 
Àn
, 
TfwSå
 *
ô
)

821 i‡(
	`u∆ikñy
(
	`abs
(
Àn
Ë> 
PAGE_SIZE
)) {

822 
	`TFW_WARN
("Aâem±Åÿadd o∏dñëêtoÿmuch d©a: %u\n", 
Àn
);

823  -
EINVAL
;

826 i‡(
	`u∆ikñy
(
	`skb_has_‰ag_li°
(
skb
))) {

827 
	`WARN_ON
(
	`skb_has_‰ag_li°
(
skb
));

828  -
EINVAL
;

831  
	`__skb_‰agmít
(
skb_hód
, 
skb
, 
p•t
, 
Àn
, 
ô
);

832 
	}
}

842 
	$ss_skb_gë_room
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
, *
p•t
,

843 
Àn
, 
TfwSå
 *
ô
)

845 
r
 = 
	`skb_‰agmít
(
skb_hód
, 
skb
, 
p•t
, 
Àn
, 
ô
);

846 i‡(
r
 =
Àn
)

848  
r
;

849 
	}
}

864 
	$ss_skb_ex∑nd_hód_èû
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
,

865 
size_t
 
hód
, size_à
èû
)

867 
‰ags
 = 0;

868 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

869 
TfwSå
 
ô
 = {};

871 i‡(!
èû
)

872 
Æloc_hód
;

873 i‡(!
si
->
ƒ_‰ags
)

874 i‡(!
	`__•lô_åy_èûroom
(
skb
, 
èû
, &
ô
))

875 
Æloc_hód
;

876 i‡(
	`__√w_pg‰ag
(
skb_hód
, 
skb
, 
èû
, 
si
->
ƒ_‰ags
, 1)) {

877 
	`T_WARN
("cannotálloc space for TLSÑecordÅag.\n");

878  -
ENOMEM
;

880 
‰ags
 = 1;

882 
Æloc_hód
:

883 i‡(
hód
) {

884 
‰ags
 +!
	`skb_hódÀn
(
skb
);

885 
	`skb_push
(
skb
, 
hód
);

888  
‰ags
;

889 
	}
}

896 
	$ss_skb_ch›_hód_èû
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
,

897 
size_t
 
hód
, size_à
åaû
)

899 
n
, 
r
, 
i
;

900 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

901 
skb_‰ag_t
 *
‰ag
;

902 
TfwSå
 
ô
;

904 
	`TFW_DBG3
("%s: head=%#lxÅrail=%#lx skb=%pK (head=%pK data=%pKÅail=%pK"

905 "Énd=%pKÜí=%u d©a_Àn=%uÇr_‰ags=%u)\n", 
__func__
,

906 
hód
, 
åaû
, 
skb
, skb->hód, skb->
d©a
, 
	`skb_èû_poöãr
(skb),

907 
	`skb_íd_poöãr
(
skb
), skb->
Àn
, skb->
d©a_Àn
, 
si
->
ƒ_‰ags
);

908 i‡(
	`WARN_ON_ONCE
(
skb
->
Àn
 <
hód
 + 
åaû
))

909  -
EINVAL
;

911 
n
 = 
	`mö_t
(, 
	`skb_hódÀn
(
skb
), 
hód
);

912 i‡(
n
) {

913 
	`__skb_puŒ
(
skb
, 
n
);

914 
hód
 -
n
;

916 
hód
) {

917 
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[0];

918 
n
 = 
	`mö_t
(, 
	`skb_‰ag_size
(
‰ag
), 
hód
);

919 i‡((
r
 = 
	`__•lô_pg‰ag_dñ
(
skb_hód
, 
skb
, 0, 0, 
n
, &
ô
)))

920  
r
;

921 
hód
 -
n
;

924 
åaû
 && 
si
->
ƒ_‰ags
) {

925 
i
 = 
si
->
ƒ_‰ags
 - 1;

926 
‰ag
 = &
	`skb_shöfo
(
skb
)->
‰ags
[
i
];

927 
n
 = 
	`mö_t
(, 
	`skb_‰ag_size
(
‰ag
), 
åaû
);

928 
r
 = 
	`__•lô_pg‰ag_dñ
(
skb_hód
, 
skb
, 
i
,

929 
	`skb_‰ag_size
(
‰ag
Ë- 
n
,Ç, &
ô
);

930 i‡(
r
)

931  
r
;

932 
åaû
 -
n
;

934 i‡(
åaû
)

935 
	`__skb_åim
(
skb
, skb->
Àn
 - 
åaû
);

938 
	}
}

945 
	$ss_skb_cutoff_d©a
(
sk_buff
 *
skb_hód
, c⁄° 
TfwSå
 *
hdr
, 
skù
,

946 
èû
)

948 
r
;

949 
TfwSå
 
ô
 = {};

950 c⁄° 
TfwSå
 *
c
, *
íd
;

952 
	`BUG_ON
(
èû
 < 0);

953 
	`BUG_ON
((
skù
 < 0Ë|| (skù >
hdr
->
Àn
));

955 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
hdr
, 
íd
) {

956 i‡(
c
->
Àn
 <
skù
) {

957 
skù
 -
c
->
Àn
;

960 
	`bzîo_Á°
(&
ô
, (
TfwSå
));

961 
r
 = 
	`skb_‰agmít
(
skb_hód
, 
c
->
skb
, (*)c->
±r
 + 
skù
,

962 
skù
 - 
c
->
Àn
, &
ô
);

963 i‡(
r
 < 0)

964  
r
;

965 
	`BUG_ON
(
r
 !
c
->
Àn
 - 
skù
);

966 
skù
 = 0;

969 
	`BUG_ON
(
ô
.
±r
 =
NULL
);

970 
	`BUG_ON
(
ô
.
skb
 =
NULL
);

973 
èû
) {

974 *
t_±r
 = 
ô
.
±r
;

975 
sk_buff
 *
t_skb
 = 
ô
.
skb
;

976 
	`bzîo_Á°
(&
ô
, (
TfwSå
));

977 
r
 = 
	`skb_‰agmít
(
skb_hód
, 
t_skb
, 
t_±r
, -
èû
, &
ô
);

978 i‡(
r
 < 0) {

979 
	`TFW_WARN
("Cannot delete hdrÅail\n");

980  
r
;

982 
	`BUG_ON
(
r
 > 
èû
);

983 
èû
 -
r
;

987 
	}
}

1009 
	$ss_skb_¥o˚ss
(
sk_buff
 *
skb
, 
off
, 
åaû
,

1010 
ss_skb_a˘‹_t
 
a˘‹
, *
objd©a
, *
chunks
,

1011 *
¥o˚s£d
)

1013 
i
, 
n
, 
r
 = 
SS_OK
;

1014 
hódÀn
 = 
	`skb_hódÀn
(
skb
);

1015 
‰ag_Àn
 = 
skb
->
Àn
 - 
hódÀn
;

1016 
_¥o˚s£d
 = 0;

1017 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

1019 i‡(
	`WARN_ON_ONCE
(
skb
->
Àn
 <
åaû
 + 
off
))

1020  -
EIO
;

1023 i‡(
	`likñy
(
off
 < 
hódÀn
)) {

1024 ++*
chunks
;

1025 
n
 = 
	`skb_hódÀn
(
skb
Ë- 
off
;

1026 i‡(
	`u∆ikñy
(
åaû
 > 
‰ag_Àn
))

1027 
n
 -
åaû
 - 
‰ag_Àn
;

1028 
r
 = 
	`a˘‹
(
objd©a
, 
skb
->
d©a
 + 
off
, 
n
, &
_¥o˚s£d
);

1029 *
¥o˚s£d
 +
_¥o˚s£d
;

1030 i‡(
r
 !
SS_POSTPONE
 || 
	`u∆ikñy
(
åaû
 >
‰ag_Àn
))

1031  
r
;

1033 
off
 -
hódÀn
;

1040 
i
 = 0; i < 
si
->
ƒ_‰ags
; ++i) {

1041 c⁄° 
skb_‰ag_t
 *
‰ag
 = &
si
->
‰ags
[
i
];

1042 
‰ag_size
 = 
	`skb_‰ag_size
(
‰ag
);

1043 *
‰ag_addr
 = 
	`skb_‰ag_addªss
(
‰ag
);

1044 i‡(
	`likñy
(
off
 < 
‰ag_size
)) {

1045 ++*
chunks
;

1046 
	`BUG_ON
(
‰ag_Àn
 < 
‰ag_size
);

1047 
‰ag_Àn
 -
‰ag_size
;

1048 
n
 = 
‰ag_size
 - 
off
;

1049 i‡(
åaû
 > 
‰ag_Àn
)

1050 
n
 -
åaû
 - 
‰ag_Àn
;

1051 
r
 = 
	`a˘‹
(
objd©a
, 
‰ag_addr
 + 
off
, 
n
, &
_¥o˚s£d
);

1052 *
¥o˚s£d
 +
_¥o˚s£d
;

1053 i‡(
r
 !
SS_POSTPONE
 || 
åaû
 >
‰ag_Àn
)

1054  
r
;

1055 
off
 = 0;

1057 
off
 -
‰ag_size
;

1061  
r
;

1062 
	}
}

1063 
EXPORT_SYMBOL
(
ss_skb_¥o˚ss
);

1074 
sk_buff
 *

1075 
	$ss_skb_•lô
(
sk_buff
 *
skb
, 
Àn
)

1077 
sk_buff
 *
buff
;

1078 
nsize
, 
asize
, 
∆í
;

1081 
	`WARN_ON_ONCE
(
skb
->
de°ru˘‹
);

1083 
nsize
 = 
	`skb_hódÀn
(
skb
Ë- 
Àn
;

1084 i‡(
nsize
 < 0)

1085 
nsize
 = 0;

1086 
asize
 = 
	`ALIGN
(
nsize
, 4);

1088 
buff
 = 
	`Æloc_skb_f˛⁄e
(
asize
 + 
MAX_TCP_HEADER
, 
GFP_ATOMIC
);

1089 i‡(
buff
 =
NULL
)

1090  
NULL
;

1092 
	`skb_ª£rve
(
buff
, 
MAX_TCP_HEADER
);

1094 
buff
->
ª£rved_èûroom
 = buff->
íd
 - buff->
èû
 - 
asize
;

1096 
∆í
 = 
skb
->
Àn
 -Üí - 
nsize
;

1097 
buff
->
åuesize
 +
∆í
;

1098 
skb
->
åuesize
 -
∆í
;

1106 
	`skb_•lô
(
skb
, 
buff
, 
Àn
);

1108  
buff
;

1109 
	}
}

1111 
ölöe
 

1112 
	$__cﬂÀs˚_‰ag
(
sk_buff
 **
skb_hód
, 
skb_‰ag_t
 *
‰ag
,

1113 c⁄° 
sk_buff
 *
‹ig_skb
)

1115 
sk_buff
 *
skb
 = 
	`ss_skb_≥ek_èû
(
skb_hód
);

1117 i‡(!
skb
 || 
	`skb_shöfo
(skb)->
ƒ_‰ags
 =
MAX_SKB_FRAGS
) {

1118 
skb
 = 
	`ss_skb_Æloc
(0);

1119 i‡(!
skb
)

1120  -
ENOMEM
;

1121 
	`ss_skb_queue_èû
(
skb_hód
, 
skb
);

1122 
skb
->
m¨k
 = 
‹ig_skb
->mark;

1125 
	`skb_shöfo
(
skb
)->
‰ags
[skb_shöfo(skb)->
ƒ_‰ags
++] = *
‰ag
;

1126 
	`ss_skb_adju°_d©a_Àn
(
skb
, 
‰ag
->
size
);

1127 
	`__skb_‰ag_ªf
(
‰ag
);

1130 
	}
}

1133 
	$ss_skb_queue_cﬂÀs˚_èû
(
sk_buff
 **
skb_hód
, c⁄° sk_buf‡*
skb
)

1135 
i
;

1136 
skb_‰ag_t
 
hód_‰ag
;

1137 
hódÀn
 = 
	`skb_hódÀn
(
skb
);

1139 i‡(
hódÀn
) {

1140 
	`BUG_ON
(!
skb
->
hód_‰ag
);

1141 
hód_‰ag
.
size
 = 
hódÀn
;

1142 
hód_‰ag
.
∑ge
.
p
 = 
	`vút_to_∑ge
(
skb
->
hód
);

1143 
hód_‰ag
.
∑ge_off£t
 = 
skb
->
d©a
 -

1144 (*)
	`∑ge_addªss
(
hód_‰ag
.
∑ge
.
p
);

1145 i‡(
	`__cﬂÀs˚_‰ag
(
skb_hód
, &
hód_‰ag
, 
skb
))

1146  -
ENOMEM
;

1149 
i
 = 0; i < 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
; i++) {

1150 i‡(
	`__cﬂÀs˚_‰ag
(
skb_hód
, &
	`skb_shöfo
(
skb
)->
‰ags
[
i
], skb))

1151  -
ENOMEM
;

1155 
	}
}

1162 
ölöe
 

1163 
	$__c›y_ù_hódî
(
sk_buff
 *
to
, c⁄° sk_buf‡*
‰om
)

1165 c⁄° 
ùhdr
 *
ù4
 = 
	`ù_hdr
(
‰om
);

1166 c⁄° 
ùv6hdr
 *
ù6
 = 
	`ùv6_hdr
(
‰om
);

1174 
	`BUG_ON
(
	`skb_hódroom
(
to
Ë< 
MAX_TCP_HEADER
);

1175 
	`skb_£t_√tw‹k_hódî
(
to
, -(
MAX_TCP_HEADER
 - 
MAX_HEADER
));

1176 i‡(
ù6
->
vîsi⁄
 == 6)

1177 
	`mem˝y_Á°
(
	`skb_√tw‹k_hódî
(
to
), 
ù6
, (*ip6));

1179 
	`mem˝y_Á°
(
	`skb_√tw‹k_hódî
(
to
), 
ù4
, (*ip4));

1180 
	}
}

1188 
	$ss_skb_öô_f‹_xmô
(
sk_buff
 *
skb
)

1190 
skb_sh¨ed_öfo
 *
shöfo
 = 
	`skb_shöfo
(
skb
);

1191 
__u8
 
pfmemÆloc
 = 
skb
->pfmemalloc;

1193 
	`WARN_ON_ONCE
(
skb
->
√xt
 || skb->
¥ev
);

1194 
	`WARN_ON_ONCE
(
skb
->
sk
);

1195 
	`WARN_ON_ONCE
(
skb
->
de°ru˘‹
);

1197 i‡(!
	`skb_å™•‹t_hódî_was_£t
(
skb
)) {

1199 
skb
->
ù_summed
 = 
CHECKSUM_PARTIAL
;

1203 
	`bzîo_Á°
(&
skb
->
skb_m°amp
, (skb->skb_mstamp));

1204 
skb
->
dev
 = 
NULL
;

1205 
	`bzîo_Á°
(
skb
->
cb
, (skb->cb));

1206 
	`skb_d°_dr›
(
skb
);

1207 #ifde‡
CONFIG_XFRM


1208 
	`£˝©h_put
(
skb
->
•
);

1210 
	`nf_ª£t
(
skb
);

1211 
skb
->
mac_Àn
 = 0;

1212 
skb
->
queue_m≠pög
 = 0;

1213 
skb
->
≥eked
 = 0;

1214 
skb
->
xmô_m‹e
 = 0;

1215 
	`bzîo_Á°
(&
skb
->
hódîs_°¨t
,

1216 
	`off£tof
(
sk_buff
, 
hódîs_íd
) -

1217 
	`off£tof
(
sk_buff
, 
hódîs_°¨t
));

1218 
skb
->
pfmemÆloc
 =Öfmemalloc;

1219 
skb
->
mac_hódî
 = (
	`ty≥of
(skb->mac_header))~0U;

1220 
skb
->
å™•‹t_hódî
 = (
	`ty≥of
(skb->transport_header))~0U;

1222 
shöfo
->
tx_Êags
 = 0;

1223 
shöfo
->
gso_size
 = 0;

1224 
shöfo
->
gso_£gs
 = 0;

1225 
shöfo
->
gso_ty≥
 = 0;

1226 
	`bzîo_Á°
(&
shöfo
->
hwt°amps
, (shinfo->hwtstamps));

1227 
shöfo
->
tskey
 = 0;

1228 
shöfo
->
ù6_‰ag_id
 = 0;

1229 
shöfo
->
de°ru˘‹_¨g
 = 
NULL
;

1231 
skb
->
ù_summed
 = 
CHECKSUM_PARTIAL
;

1232 
	}
}

1243 
	$ss_skb_uƒﬁl_¶ow
(
sk_buff
 **
skb_hód
, sk_buf‡*
skb
)

1245 
sk_buff
 *
f_skb
;

1247 i‡(
	`ss_skb_queue_cﬂÀs˚_èû
(
skb_hód
, 
skb
))

1248 
˛ónup
;

1250 
	`skb_wÆk_‰ags
(
skb
, 
f_skb
) {

1251 
f_skb
->
m¨k
 = 
skb
->mark;

1252 i‡(
	`ss_skb_queue_cﬂÀs˚_èû
(
skb_hód
, 
f_skb
))

1253 
˛ónup
;

1257 i‡(*
skb_hód
)

1258 
	`__c›y_ù_hódî
(*
skb_hód
, 
skb
);

1265 
	`c⁄sume_skb
(
skb
);

1268 
˛ónup
:

1269 
	`ss_skb_queue_purge
(
skb_hód
);

1270  -
ENOMEM
;

1271 
	}
}

1296 
	$ss_skb_uƒﬁl
(
sk_buff
 **
skb_hód
, sk_buf‡*
skb
)

1298 
sk_buff
 *
¥ev_skb
, *
f_skb
;

1300 i‡(
	`u∆ikñy
(
	`skb_˛⁄ed
(
skb
)))

1301  
	`ss_skb_uƒﬁl_¶ow
(
skb_hód
, 
skb
);

1303 
	`WARN_ON_ONCE
(
skb
->
√xt
 || skb->
¥ev
);

1304 
skb
->
√xt
 = 
	`skb_shöfo
(skb)->
‰ag_li°
;

1305 *
skb_hód
 = 
¥ev_skb
 = 
skb
;

1306 
	`skb_wÆk_‰ags
(
skb
, 
f_skb
) {

1307 i‡(
f_skb
->
nohdr
) {

1313 
f_skb
->
nohdr
 = 0;

1314 
	`©omic_sub
(1 << 
SKB_DATAREF_SHIFT
,

1315 &
	`skb_shöfo
(
f_skb
)->
d©¨ef
);

1325 
f_skb
->
m¨k
 = 
skb
->mark;

1326 
	`ss_skb_adju°_d©a_Àn
(
skb
, -
f_skb
->
Àn
);

1327 
f_skb
->
¥ev
 = 
¥ev_skb
;

1328 
¥ev_skb
 = 
f_skb
;

1330 (*
skb_hód
)->
¥ev
 = 
¥ev_skb
;

1331 
¥ev_skb
->
√xt
 = *
skb_hód
;

1332 
	`skb_shöfo
(
skb
)->
‰ag_li°
 = 
NULL
;

1335 
	}
}

1344 
	$ss_skb_dump
(
sk_buff
 *
skb
)

1346 
i
;

1347 
sk_buff
 *
f_skb
;

1348 
skb_sh¨ed_öfo
 *
si
 = 
	`skb_shöfo
(
skb
);

1350 
	`TFW_LOG_NL
("SKB (%p) DUMP:Üen=%u data_len=%uÅruesize=%u users=%u\n",

1351 
skb
, skb->
Àn
, skb->
d©a_Àn
, skb->
åuesize
,

1352 
	`ªfcou¡_ªad
(&
skb
->
u£rs
));

1353 
	`TFW_LOG_NL
(" head=%p data=%pÅail=%xÉnd=%x\n",

1354 
skb
->
hód
, skb->
d©a
, skb->
èû
, skb->
íd
);

1355 
	`TFW_LOG_NL
("Çr_frags=%u frag_list=%pÇext=%pÖrev=%p\n",

1356 
si
->
ƒ_‰ags
, 
	`skb_shöfo
(
skb
)->
‰ag_li°
,

1357 
skb
->
√xt
, skb->
¥ev
);

1358 
	`TFW_LOG_NL
(" hód d©®(%u):\n", 
	`skb_hódÀn
(
skb
));

1359 
	`¥öt_hex_dump
(
KERN_INFO
, " ", 
DUMP_PREFIX_OFFSET
, 16, 1,

1360 
skb
->
d©a
, 
	`skb_hódÀn
(skb), 
åue
);

1362 
i
 = 0; i < 
si
->
ƒ_‰ags
; ++i) {

1363 c⁄° 
skb_‰ag_t
 *
f
 = &
si
->
‰ags
[
i
];

1364 
	`TFW_LOG_NL
(" frag %d (addr=%pÖg_off=%u size=%uÖg_ref=%d):\n",

1365 
i
, 
	`skb_‰ag_addªss
(
f
), f->
∑ge_off£t
,

1366 
	`skb_‰ag_size
(
f
), 
	`∑ge_ªf_cou¡
(
	`skb_‰ag_∑ge
(f)));

1367 
	`¥öt_hex_dump
(
KERN_INFO
, " ", 
DUMP_PREFIX_OFFSET
, 16, 1,

1368 
	`skb_‰ag_addªss
(
f
), 
	`skb_‰ag_size
(f), 
åue
);

1371 
	`skb_wÆk_‰ags
(
skb
, 
f_skb
)

1372 
	`ss_skb_dump
(
f_skb
);

1373 
	}
}

1374 
EXPORT_SYMBOL
(
ss_skb_dump
);

	@ss_skb.h

22 #i‚de‡
__TFW_SS_SKB_H__


23 
	#__TFW_SS_SKB_H__


	)

25 
	~<löux/skbuff.h
>

27 
	~"°r.h
"

38 
	mSS_SHUTDOWN
 = -4,

40 
	mSS_BAD
 = -3,

42 
	mSS_DROP
 = -2,

44 
	mSS_POSTPONE
 = -1,

46 
	mSS_OK
 = 0,

49 
	tss_skb_a˘‹_t
(*
	tc⁄n
, *
	td©a
, 
	tsize_t
 
	tÀn
,

50 *
	tªad
);

55 
ölöe
 

56 
	$ss_skb_queue_èû
(
sk_buff
 **
skb_hód
, sk_buf‡*
skb
)

59 
	`WARN_ON_ONCE
(
skb
->
√xt
 || skb->
¥ev
);

60 i‡(!*
skb_hód
) {

61 *
skb_hód
 = 
skb
;

62 
skb
->
¥ev
 = skb->
√xt
 = skb;

65 
skb
->
√xt
 = *
skb_hód
;

66 
skb
->
¥ev
 = (*
skb_hód
)->prev;

67 
skb
->
√xt
->
¥ev
 = skb->prev->next = skb;

68 
	}
}

70 
ölöe
 

71 
	$ss_skb_u∆ök
(
sk_buff
 **
skb_hód
, sk_buf‡*
skb
)

73 
	`WARN_ON_ONCE
(!
skb
->
¥ev
 || !skb->
√xt
);

75 i‡(
skb
->
√xt
 == skb) {

76 *
skb_hód
 = 
NULL
;

78 
skb
->
¥ev
->
√xt
 = skb->next;

79 
skb
->
√xt
->
¥ev
 = skb->prev;

81 i‡(*
skb_hód
 =
skb
)

82 *
skb_hód
 = 
skb
->
√xt
;

84 
skb
->
√xt
 = skb->
¥ev
 = 
NULL
;

85 
	}
}

87 
ölöe
 
sk_buff
 *

88 
	$ss_skb_≥ek_èû
(
sk_buff
 **
skb_hód
)

90  *
skb_hód
 ? (*skb_hód)->
¥ev
 : 
NULL
;

91 
	}
}

98 
ölöe
 
sk_buff
 *

99 
	$ss_skb_dequeue
(
sk_buff
 **
skb_hód
)

101 
sk_buff
 *
skb
 = *
skb_hód
;

102 i‡(
skb
)

103 
	`ss_skb_u∆ök
(
skb_hód
, 
skb
);

104  
skb
;

105 
	}
}

107 
ölöe
 

108 
	$ss_skb_queue_purge
(
sk_buff
 **
skb_hód
)

110 
sk_buff
 *
skb
;

111 (
skb
 = 
	`ss_skb_dequeue
(
skb_hód
)Ë!
NULL
)

112 
	`k‰ì_skb
(
skb
);

113 
	}
}

115 
ölöe
 

116 
	$ss_skb_adju°_d©a_Àn
(
sk_buff
 *
skb
, 
dñè
)

118 
skb
->
Àn
 +
dñè
;

119 
skb
->
d©a_Àn
 +
dñè
;

120 
skb
->
åuesize
 +
dñè
;

121 
	}
}

123 
ölöe
 
skb_‰ag_t
 *

124 
	$ss_skb_‰ag_√xt
(
sk_buff
 **
skb
, c⁄° sk_buf‡*
skb_hód
, *
f
)

126 i‡(
	`skb_shöfo
(*
skb
)->
ƒ_‰ags
 > *
f
 + 1) {

127 ++*
f
;

128  &
	`skb_shöfo
(*
skb
)->
‰ags
[*
f
];

131 *
skb
 = (*skb)->
√xt
;

132 i‡(*
skb
 =
skb_hód
 || !
	`skb_shöfo
(*skb)->
ƒ_‰ags
)

133  
NULL
;

134 *
f
 = 0;

135  &
	`skb_shöfo
(*
skb
)->
‰ags
[0];

136 
	}
}

145 
ölöe
 

146 
	$ss_skb_èûroom
(c⁄° 
sk_buff
 *
skb
)

148  
skb
->
íd
 - skb->
èû
;

149 
	}
}

158 
ölöe
 *

159 
	$ss_skb_put
(
sk_buff
 *
skb
, c⁄° 
Àn
)

161 *
tmp
 = 
	`skb_èû_poöãr
(
skb
);

163 
skb
->
èû
 +
Àn
;

164 
skb
->
Àn
 +=Üen;

166 
	`WARN_ON_ONCE
(
skb
->
èû
 > skb->
íd
);

168  
tmp
;

169 
	}
}

171 
ölöe
 
sk_buff
 *

172 
	$ss_skb_Æloc
(
size_t
 
n
)

174 
sk_buff
 *
skb
 = 
	`Æloc_skb
(
MAX_TCP_HEADER
 + 
n
, 
GFP_ATOMIC
);

176 i‡(!
skb
)

177  
NULL
;

178 
	`skb_ª£rve
(
skb
, 
MAX_TCP_HEADER
);

180  
skb
;

181 
	}
}

183 
	#SS_SKB_MAX_DATA_LEN
 (
SKB_MAX_HEADER
 + 
MAX_SKB_FRAGS
 * 
PAGE_SIZE
)

	)

185 *
ss_skb_fmt_§c_addr
(c⁄° 
sk_buff
 *
skb
, *
out_buf
);

187 
ss_skb_Æloc_d©a
(
sk_buff
 **
skb_hód
, 
size_t
 
Àn
);

188 
sk_buff
 *
ss_skb_•lô
(sk_buf‡*
skb
, 
Àn
);

189 
ss_skb_gë_room
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
,

190 *
p•t
, 
Àn
, 
TfwSå
 *
ô
);

191 
ss_skb_ex∑nd_hód_èû
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
,

192 
size_t
 
hód
, size_à
èû
);

193 
ss_skb_ch›_hód_èû
(
sk_buff
 *
skb_hód
, sk_buf‡*
skb
,

194 
size_t
 
hód
, size_à
èû
);

195 
ss_skb_cutoff_d©a
(
sk_buff
 *
skb_hód
, c⁄° 
TfwSå
 *
hdr
,

196 
skù
, 
èû
);

198 
ss_skb_¥o˚ss
(
sk_buff
 *
skb
, 
off
, 
åaû
,

199 
ss_skb_a˘‹_t
 
a˘‹
, *
objd©a
, *
chunks
,

200 *
¥o˚s£d
);

202 
ss_skb_uƒﬁl
(
sk_buff
 **
skb_hód
, sk_buf‡*
skb
);

203 
ss_skb_öô_f‹_xmô
(
sk_buff
 *
skb
);

204 
ss_skb_dump
(
sk_buff
 *
skb
);

	@str.c

25 
	~<löux/bug.h
>

26 
	~<löux/kî√l.h
>

27 
	~<löux/˘y≥.h
>

28 
	~<löux/¸c32.h
>

30 
	~"lib/°r.h
"

31 
	~"hty≥.h
"

32 
	~"°r.h
"

38 
ölöe
 

39 
	$__dig_num
(
a
)

41 i‡(
a
 < 10)

43 i‡(
a
 < 100)

45 i‡(
a
 < 1000)

47 i‡(
a
 < 10000)

49 i‡(
a
 < 100000)

51 i‡(
a
 < 1000000)

53 i‡(
a
 < 10000000)

55 i‡(
a
 < 100000000)

57 i‡(
a
 < 1000000000)

59 i‡(
a
 < 10000000000)

61 i‡(
a
 < 100000000000UL)

63 i‡(
a
 < 1000000000000UL)

65 i‡(
a
 < 10000000000000UL)

67 i‡(
a
 < 100000000000000UL)

69 i‡(
a
 < 1000000000000000UL)

71 i‡(
a
 < 10000000000000000UL)

73 i‡(
a
 < 100000000000000000UL)

75 i‡(
a
 < 1000000000000000000UL)

77 i‡(
a
 < 10000000000000000000UL)

80 
	}
}

87 
size_t


88 
	$tfw_u…ﬂ
(
ai
, *
buf
, 
Àn
)

90 
size_t
 
n
 = 
	`__dig_num
(
ai
);

91 *
p
 = 
buf
 + 
n
;

93 i‡(
	`u∆ikñy
(
n
 + 1 > 
Àn
))

98 *
p
-- = "0123456789"[
ai
 % 10];

99 
ai
 /= 10;

100 } 
ai
);

102  
n
 + 1;

103 
	}
}

104 
EXPORT_SYMBOL
(
tfw_u…ﬂ
);

107 
	$tfw_°r_dñ_chunk
(
TfwSå
 *
°r
, 
id
)

109 
˙
 = 
	`TFW_STR_CHUNKN
(
°r
);

111 i‡(
	`u∆ikñy
(
	`TFW_STR_PLAIN
(
°r
)))

113 
	`BUG_ON
(
	`TFW_STR_DUP
(
°r
));

114 
	`BUG_ON
(
id
 >
˙
);

116 i‡(
	`TFW_STR_CHUNKN
(
°r
) == 2) {

118 *
°r
 = *((
TfwSå
 *)°r->
±r
 + (
id
 ^ 1));

122 
°r
->
Àn
 -
	`TFW_STR_CHUNK
(°r, 
id
)->len;

123 
	`TFW_STR_CHUNKN_SUB
(
°r
, 1);

125 
	`memmove
((
TfwSå
 *)
°r
->
±r
 + 
id
, (TfwStr *)str->ptr + id + 1,

126 (
˙
 - 
id
 - 1Ë* (
TfwSå
));

127 
	}
}

138 
TfwSå
 *

139 
	$__°r_grow_åì
(
TfwPoﬁ
 *
poﬁ
, 
TfwSå
 *
°r
, 
Êag
, 
n
)

141 i‡(
°r
->
Êags
 & 
Êag
) {

142 
l
;

143 *
p
;

145 i‡(
	`u∆ikñy
(
	`TFW_STR_CHUNKN_LIM
(
°r
))) {

146 
	`TFW_WARN
("Reaching chunks hardÜimit\n");

147  
NULL
;

150 
l
 = 
	`TFW_STR_CHUNKN
(
°r
Ë* (
TfwSå
);

151 
p
 = 
	`tfw_poﬁ_ªÆloc
(
poﬁ
, 
°r
->
±r
, 
l
,

152 
l
 + 
n
 * (
TfwSå
));

153 i‡(!
p
)

154  
NULL
;

155 
°r
->
±r
 = 
p
;

156 
	`TFW_STR_CHUNKN_ADD
(
°r
, 
n
);

159 
TfwSå
 *
a
 = 
	`tfw_poﬁ_Æloc
(
poﬁ
, (
n
 + 1) * (TfwStr));

160 i‡(!
a
)

161  
NULL
;

162 
a
[0] = *
°r
;

163 
°r
->
±r
 = 
a
;

164 
	`__TFW_STR_CHUNKN_SET
(
°r
, 
n
 + 1);

167 
°r
 = (
TfwSå
 *)°r->
±r
 + 
	`TFW_STR_CHUNKN
(°rË- 
n
;

168 
	`bzîo_Á°
(
°r
, (
TfwSå
Ë* 
n
);

170  
°r
;

171 
	}
}

176 
TfwSå
 *

177 
	$tfw_°r_add_compound
(
TfwPoﬁ
 *
poﬁ
, 
TfwSå
 *
°r
)

180 
	`BUG_ON
(
	`TFW_STR_DUP
(
°r
));

182  
	`__°r_grow_åì
(
poﬁ
, 
°r
, 
__TFW_STR_COMPOUND
, 1);

183 
	}
}

189 
TfwSå
 *

190 
	$tfw_°r_add_du∂iˇã
(
TfwPoﬁ
 *
poﬁ
, 
TfwSå
 *
°r
)

192 
TfwSå
 *
dup_°r
 = 
	`__°r_grow_åì
(
poﬁ
, 
°r
, 
TFW_STR_DUPLICATE
, 1);

195 
°r
->
Àn
 = 0;

196 
°r
->
Êags
 |
TFW_STR_DUPLICATE
;

198  
dup_°r
;

199 
	}
}

205 
	$tfw_°r˝y
(
TfwSå
 *
d°
, c⁄° TfwSå *
§c
)

207 
n1
, 
n2
, 
o1
 = 0, 
o2
 = 0, 
chunks
 = 0;

208 
mode
 = (
	`TFW_STR_PLAIN
(
§c
Ë<< 1Ë| TFW_STR_PLAIN(
d°
);

209 
TfwSå
 *
c1
, *
c2
, *
íd
;

211 
	`BUG_ON
(
	`TFW_STR_DUP
(
d°
));

212 
	`BUG_ON
(
	`TFW_STR_DUP
(
§c
));

215 i‡(
	`u∆ikñy
(
§c
->
Àn
 > 
d°
->len))

216  -
E2BIG
;

218 
mode
) {

220 
	`mem˝y_Á°
(
d°
->
±r
, 
§c
->±r, 
	`mö
(§c->
Àn
, dst->len));

223 
n1
 = 
	`TFW_STR_CHUNKN
(
§c
);

224 
íd
 = (
TfwSå
 *)
§c
->
±r
 + 
n1
;

225 
c1
 = (
TfwSå
 *)
§c
->
±r
; c1 < 
íd
; ++c1) {

226 
	`mem˝y_Á°
((*)
d°
->
±r
 + 
o2
, 
c1
->±r, c1->
Àn
);

227 
o2
 +
c1
->
Àn
;

229 
	`BUG_ON
(
o2
 !
§c
->
Àn
);

232 
c2
 = (
TfwSå
 *)
d°
->
±r
; 
o1
 < 
§c
->
Àn
; ++c2) {

234 
c2
->
Àn
 = 
	`mö
(c2->Àn, 
§c
->À¿- 
o1
);

235 
	`mem˝y_Á°
(
c2
->
±r
, (*)
§c
->±∏+ 
o1
, c2->
Àn
);

236 ++
chunks
;

237 
o1
 +
c2
->
Àn
;

241 
n1
 = 
	`TFW_STR_CHUNKN
(
§c
);

242 
n2
 = 
	`TFW_STR_CHUNKN
(
d°
);

243 
c1
 = (
TfwSå
 *)
§c
->
±r
;

244 
c2
 = (
TfwSå
 *)
d°
->
±r
;

245 
íd
 = 
c1
 + 
n1
 - 1;

247 
_n
 = 
	`mö
(
c1
->
Àn
 - 
o1
, 
c2
->À¿- 
o2
);

248 
	`mem˝y_Á°
((*)
c2
->
±r
 + 
o2
, (*)
c1
->±∏+ 
o1
,

249 
_n
);

250 i‡(
c1
 =
íd
 && 
_n
 =c1->
Àn
 - 
o1
) {

252 
c2
->
Àn
 = 
o2
 + 
_n
;

253 ++
chunks
;

256 i‡(
c1
->
Àn
 - 
o1
 =
c2
->À¿- 
o2
) {

257 ++
c1
;

258 ++
c2
;

259 ++
chunks
;

260 
o1
 = 
o2
 = 0;

262 i‡(
_n
 =
c1
->
Àn
 - 
o1
) {

263 ++
c1
;

264 
o1
 = 0;

265 
o2
 +
_n
;

268 ++
c2
;

269 ++
chunks
;

270 
o2
 = 0;

271 
o1
 +
_n
;

277 
	`__TFW_STR_CHUNKN_SET
(
d°
, 
chunks
);

278 
d°
->
Àn
 = 
§c
->len;

281 
	}
}

282 
EXPORT_SYMBOL
(
tfw_°r˝y
);

288 
TfwSå
 *

289 
	$tfw_°rdup
(
TfwPoﬁ
 *
poﬁ
, c⁄° 
TfwSå
 *
§c
)

291 
size_t
 
n
;

292 
TfwSå
 *
d°
, *
d_c
;

293 c⁄° 
TfwSå
 *
s_c
, *
íd
;

294 *
d©a
;

296 
n
 = (
	`TFW_STR_CHUNKN
(
§c
Ë+ 1Ë* (
TfwSå
Ë+ src->
Àn
;

297 
d°
 = (
TfwSå
 *)
	`tfw_poﬁ_Æloc
(
poﬁ
, 
n
);

298 i‡(!
d°
)

299  
NULL
;

301 *
d°
 = *
§c
;

302 
d°
->
±r
 = dst + 1;

303 
d©a
 = (*)(
	`TFW_STR_LAST
(
d°
) + 1);

305 
d_c
 = 
	`TFW_STR_CHUNK
(
d°
, 0);

306 
	`TFW_STR_FOR_EACH_CHUNK
(
s_c
, 
§c
, 
íd
) {

307 *
d_c
 = *
s_c
;

308 
d_c
->
±r
 = 
d©a
;

309 
	`mem˝y_Á°
(
d©a
, 
s_c
->
±r
, s_c->
Àn
);

310 
d©a
 +
s_c
->
Àn
;

311 ++
d_c
;

314  
d°
;

315 
	}
}

321 
	$tfw_°r˝y_desc
(
TfwSå
 *
d°
, TfwSå *
§c
)

323 
TfwSå
 *
c1
, *
c2
, *
íd
;

324 
§c_num
 = 
	`TFW_STR_CHUNKN
(
§c
);

325 
d°_num
 = 
	`TFW_STR_CHUNKN
(
d°
);

331 i‡(
	`u∆ikñy
(
§c_num
 !
d°_num
))

332  -
E2BIG
;

334 
c2
 = 
d°_num
 ? 
d°
->
±r
 : dst;

335 
	`TFW_STR_FOR_EACH_CHUNK
(
c1
, 
§c
, 
íd
) {

336 *
c2
 = *
c1
;

337 ++
c2
;

339 i‡(
d°_num
) {

341 
d°
->
Àn
 = 
§c
->len;

342 
d°
->
Êags
 = 
§c
->flags;

346 
	}
}

347 
EXPORT_SYMBOL
(
tfw_°r˝y_desc
);

350 
	$tfw_°rˇt
(
TfwPoﬁ
 *
poﬁ
, 
TfwSå
 *
d°
, TfwSå *
§c
)

352 
n
 = 
	`TFW_STR_CHUNKN
(
§c
);

353 
TfwSå
 *
to
, *
c
, *
íd
;

355 
	`BUG_ON
(
	`TFW_STR_DUP
(
d°
));

356 
	`BUG_ON
(
	`TFW_STR_DUP
(
§c
));

358 
to
 = 
	`__°r_grow_åì
(
poﬁ
, 
d°
, 
__TFW_STR_COMPOUND
, 
n
 ? : 1);

359 i‡(!
to
)

360  -
ENOMEM
;

362 
n
 = 0;

363 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
§c
, 
íd
) {

364 
n
 +
c
->
Àn
;

365 
to
->
±r
 = 
c
->ptr;

366 
to
->
Àn
 = 
c
->len;

367 
to
->
skb
 = 
c
->skb;

368 ++
to
;

370 
d°
->
Àn
 +
n
;

373 
	}
}

374 
EXPORT_SYMBOL
(
tfw_°rˇt
);

386 
	$__tfw_°rcmp
(c⁄° 
TfwSå
 *
s1
, c⁄° TfwSå *
s2
, 
cs
)

388 
i1
, 
i2
, 
off1
, 
off2
;

389 
n
;

390 c⁄° 
TfwSå
 *
c1
, *
c2
;

391 
	`ty≥of
(&
°∫cmp
Ë
cmp
 = 
cs
 ? (ty≥of(&°∫cmp))
memcmp_Á°


392 : 
tfw_c°ricmp
;

394 
	`BUG_ON
((
s1
->
Êags
 | 
s2
->ÊagsË& 
TFW_STR_DUPLICATE
);

395 i‡(
	`u∆ikñy
(!
s1
->
Àn
 || !
s2
->len))

396 
out
;

398 
i1
 = 
i2
 = 0;

399 
off1
 = 
off2
 = 0;

400 
n
 = 
	`mö
(
s1
->
Àn
, 
s2
->len);

401 
c1
 = 
	`TFW_STR_CHUNK
(
s1
, 0);

402 
c2
 = 
	`TFW_STR_CHUNK
(
s2
, 0);

403 
n
) {

404 
˙
 = 
	`mö
(
c1
->
Àn
 - 
off1
, 
c2
->À¿- 
off2
);

405 
r
 = (*
cmp
)((*)
c1
->
±r
 + 
off1
,

406 (*)
c2
->
±r
 + 
off2
, 
˙
);

407 i‡(
r
)

408  
r
;

410 
n
 -
˙
;

411 i‡(
˙
 =
c1
->
Àn
 - 
off1
) {

412 
off1
 = 0;

413 ++
i1
;

414 
c1
 = 
	`TFW_STR_CHUNK
(
s1
, 
i1
);

416 
off1
 +
˙
;

418 i‡(
˙
 =
c2
->
Àn
 - 
off2
) {

419 
off2
 = 0;

420 ++
i2
;

421 
c2
 = 
	`TFW_STR_CHUNK
(
s2
, 
i2
);

423 
off2
 +
˙
;

425 
	`BUG_ON
(
n
 && (!
c1
 || !
c2
));

427 
out
:

428  
s1
->
Àn
 =
s2
->len ? 0 : ()s1->len - ()s2->len;

429 
	}
}

430 
EXPORT_SYMBOL
(
__tfw_°rcmp
);

446 
ölöe
 

447 
	$__c°ricmp•n
(c⁄° *
s1
, c⁄° *
s2
, 
n
, 
°›
,

448 
cs
)

450 
c1
, 
c2
;

452 
n
) {

453 i‡(
cs
) {

454 
c1
 = *
s1
++;

455 
c2
 = *
s2
++;

458 
c1
 = 
	`TFW_LC
(*
s1
++);

459 
c2
 = 
	`TFW_LC
(*
s2
++);

461 i‡(
c1
 !
c2
)

462  (
c1
 < 
c2
) ? -1 : 1;

463 i‡(
	`u∆ikñy
(
c1
 =
°›
))

464  
INT_MAX
;

465 
n
--;

469 
	}
}

484 
	$__tfw_°rcmp•n
(c⁄° 
TfwSå
 *
s1
, c⁄° TfwSå *
s2
, 
°›
, 
cs
)

486 
i1
, 
i2
, 
off1
, 
off2
;

487 
n
;

488 c⁄° 
TfwSå
 *
c1
, *
c2
;

490 
	`BUG_ON
((
s1
->
Êags
 | 
s2
->ÊagsË& 
TFW_STR_DUPLICATE
);

491 
	`BUG_ON
(!
°›
);

492 i‡(
	`u∆ikñy
(!
s1
->
Àn
 || !
s2
->len))

493 
out
;

495 
i1
 = 
i2
 = 0;

496 
off1
 = 
off2
 = 0;

497 
n
 = 
	`mö
(
s1
->
Àn
, 
s2
->len);

498 
c1
 = 
	`TFW_STR_CHUNK
(
s1
, 0);

499 
c2
 = 
	`TFW_STR_CHUNK
(
s2
, 0);

500 
n
) {

501 
˙
 = 
	`mö
(
c1
->
Àn
 - 
off1
, 
c2
->À¿- 
off2
);

502 
r
 = 
	`__c°ricmp•n
((*)
c1
->
±r
 + 
off1
,

503 (*)
c2
->
±r
 + 
off2
,

504 
˙
, 
°›
, 
cs
);

505 i‡(
r
 =
INT_MAX
)

507 i‡(
r
)

508  
r
;

510 
n
 -
˙
;

511 i‡(
˙
 =
c1
->
Àn
 - 
off1
) {

512 
off1
 = 0;

513 ++
i1
;

514 
c1
 = 
	`TFW_STR_CHUNK
(
s1
, 
i1
);

516 
off1
 +
˙
;

518 i‡(
˙
 =
c2
->
Àn
 - 
off2
) {

519 
off2
 = 0;

520 ++
i2
;

521 
c2
 = 
	`TFW_STR_CHUNK
(
s2
, 
i2
);

523 
off2
 +
˙
;

525 
	`BUG_ON
(
n
 && (!
c1
 || !
c2
));

527 
out
:

528  
s1
->
Àn
 =
s2
->len ? 0 : ()s1->len - ()s2->len;

529 
	}
}

530 
EXPORT_SYMBOL
(
__tfw_°rcmp•n
);

551 
boﬁ


552 
	$tfw_°r_eq_c°r
(c⁄° 
TfwSå
 *
°r
, c⁄° *
c°r
, 
c°r_Àn
,

553 
tfw_°r_eq_Êags_t
 
Êags
)

555 
Àn
, 
˛í
 = 
c°r_Àn
;

556 c⁄° 
TfwSå
 *
chunk
, *
íd
;

557 
	`ty≥of
(&
°∫cmp
Ë
cmp
 = (
Êags
 & 
TFW_STR_EQ_CASEI
)

558 ? 
tfw_c°ricmp


559 : (
	`ty≥of
(&
°∫cmp
))
memcmp_Á°
;

561 
	`BUG_ON
(
°r
->
Àn
 && !°r->
±r
);

562 
	`TFW_STR_FOR_EACH_CHUNK
(
chunk
, 
°r
, 
íd
) {

563 
	`BUG_ON
(
chunk
->
Àn
 && !chunk->
±r
);

565 
Àn
 = 
	`mö
(
˛í
, ()
chunk
->len);

566 i‡(
	`cmp
(
c°r
, 
chunk
->
±r
, 
Àn
))

567  
Ál£
;

573 i‡(()
chunk
->
Àn
 > 
˛í
)

574  (
Êags
 & 
TFW_STR_EQ_PREFIX
);

576 
c°r
 +
Àn
;

577 
˛í
 -
Àn
;

580  !
˛í
;

581 
	}
}

582 
EXPORT_SYMBOL
(
tfw_°r_eq_c°r
);

593 
boﬁ


594 
	$tfw_°r_eq_c°r_pos
(c⁄° 
TfwSå
 *
°r
, c⁄° *
pos
, c⁄° *
c°r
,

595 
c°r_Àn
, 
tfw_°r_eq_Êags_t
 
Êags
)

597 
boﬁ
 
r
 = 
Ál£
;

598 
TfwSå
 
tmp
 = *
°r
;

599 c⁄° 
TfwSå
 *
c
, *
íd
;

601 
	`BUG_ON
(
	`TFW_STR_DUP
(
°r
));

602 
	`BUG_ON
(!
pos
 || !
c°r
 || !
c°r_Àn
);

604 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, &
tmp
, 
íd
) {

605 
off£t
 = 
pos
 - (*)
c
->
±r
;

607 i‡(
off£t
 >0 && (off£à< 
c
->
Àn
)) {

608 
TfwSå
 
t
 = *
c
, *
v
 = (TfwStr *)c;

610 
v
->
±r
 +
off£t
;

611 
v
->
Àn
 -
off£t
;

613 
r
 = 
	`tfw_°r_eq_c°r
(&
tmp
, 
c°r
, 
c°r_Àn
, 
Êags
);

615 *
v
 = 
t
;

616 
out
;

619 
tmp
.
Àn
 -
c
->len;

620 
tmp
.
±r
 +(
TfwSå
);

622 
	`TFW_STR_CHUNKN_SUB
(&
tmp
, 1);

624 
out
:

625  
r
;

626 
	}
}

627 
EXPORT_SYMBOL
(
tfw_°r_eq_c°r_pos
);

638 
boﬁ


639 
	$tfw_°r_eq_c°r_off
(c⁄° 
TfwSå
 *
°r
, 
ssize_t
 
off£t
, c⁄° *
c°r
,

640 
c°r_Àn
, 
tfw_°r_eq_Êags_t
 
Êags
)

642 
boﬁ
 
ªt
 = 
Ál£
;

643 
TfwSå
 
t
, 
tmp
 = *
°r
;

644 
TfwSå
 *
c
, *
íd
;

646 
	`BUG_ON
(
	`TFW_STR_DUP
(
°r
));

647 
	`BUG_ON
(!
c°r
 || !
c°r_Àn
);

649 i‡(
off£t
 < 0)

650  
Ál£
;

651 i‡(
off£t
 == 0)

652  
	`tfw_°r_eq_c°r
(
°r
, 
c°r
, 
c°r_Àn
, 
Êags
);

653 i‡(
	`u∆ikñy
(
off£t
 + 
c°r_Àn
 > 
°r
->
Àn
))

654  
Ál£
;

656 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, &
tmp
, 
íd
) {

657 i‡(
off£t
 >
c
->
Àn
) {

658 
off£t
 -
c
->
Àn
;

659 
tmp
.
Àn
 -
c
->len;

660 
tmp
.
±r
 +(
TfwSå
);

661 
	`TFW_STR_CHUNKN_SUB
(&
tmp
, 1);

664 
t
 = *
c
;

665 
c
->
±r
 +
off£t
;

666 
c
->
Àn
 -
off£t
;

668 
ªt
 = 
	`tfw_°r_eq_c°r
(&
tmp
, 
c°r
, 
c°r_Àn
, 
Êags
);

670 *
c
 = 
t
;

674  
ªt
;

675 
	}
}

676 
EXPORT_SYMBOL
(
tfw_°r_eq_c°r_off
);

698 
size_t


699 
	$tfw_°r_to_c°r
(c⁄° 
TfwSå
 *
°r
, *
out_buf
, 
buf_size
)

701 c⁄° 
TfwSå
 *
chunk
, *
íd
;

702 *
pos
 = 
out_buf
;

703 
Àn
;

705 
	`BUG_ON
(!
out_buf
 || 
buf_size
 <= 0);

707 --
buf_size
;

709 
	`TFW_STR_FOR_EACH_CHUNK
(
chunk
, 
°r
, 
íd
) {

710 
Àn
 = 
	`mö
(
buf_size
, ()
chunk
->len);

711 
	`°∫˝y
(
pos
, 
chunk
->
±r
, 
Àn
);

712 
pos
 +
Àn
;

713 
buf_size
 -
Àn
;

715 i‡(
	`u∆ikñy
(!
buf_size
))

719 *
pos
 = '\0';

721  (
pos
 - 
out_buf
);

722 
	}
}

723 
EXPORT_SYMBOL
(
tfw_°r_to_c°r
);

732 
TfwSå


733 
	$tfw_°r_√xt_°r_vÆ
(c⁄° 
TfwSå
 *
°r
)

735 
TfwSå
 
r_°r
 = { 0 }, *
chunk
, *
íd
;

736 
boﬁ
 
skù
 = 
åue
;

738 
	`BUG_ON
(
	`TFW_STR_DUP
(
°r
));

739 i‡(!
°r
 || 
	`TFW_STR_PLAIN
(str))

740  
r_°r
;

742 
íd
 = (
TfwSå
*)
°r
->
±r
 + 
	`TFW_STR_CHUNKN
(str);

743 
	`__TFW_STR_CHUNKN_SET
(&
r_°r
, 
	`TFW_STR_CHUNKN
(
°r
));

744 
r_°r
.
Àn
 = 
°r
->len;

746 
chunk
 = 
°r
->
±r
; chunk !
íd
; ++chunk) {

747 i‡(!
skù
 && (
chunk
->
Êags
 & 
TFW_STR_VALUE
))

749 i‡(!(
chunk
->
Êags
 & 
TFW_STR_VALUE
))

750 
skù
 = 
Ál£
;

751 
r_°r
.
Àn
 -
chunk
->len;

752 
	`TFW_STR_CHUNKN_SUB
(&
r_°r
, 1);

754 i‡(
	`u∆ikñy
(
chunk
 =
íd
))

755 
	`TFW_STR_INIT
(&
r_°r
);

757 
r_°r
.
±r
 = 
chunk
;

759  
r_°r
;

760 
	}
}

761 
EXPORT_SYMBOL
(
tfw_°r_√xt_°r_vÆ
);

766 
u32


767 
	$tfw_°r_¸c32_ˇlc
(c⁄° 
TfwSå
 *
°r
)

769 c⁄° 
TfwSå
 *
c
, *
íd
;

770 
u32
 
¸c
 = 0;

772 
	`BUG_ON
(
°r
->
Àn
 && !°r->
±r
);

773 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
°r
, 
íd
)

774 
¸c
 = 
	`¸c32
(¸c, 
c
->
±r
, c->
Àn
);

776  
¸c
;

777 
	}
}

778 
EXPORT_SYMBOL
(
tfw_°r_¸c32_ˇlc
);

780 #ifde‡
DEBUG


782 
	$tfw_°r_d¥öt
(c⁄° 
TfwSå
 *
°r
, c⁄° *
msg
)

784 c⁄° 
TfwSå
 *
dup
, *
dup_íd
, *
c
, *
chunk_íd
;

786 
	`TFW_DBG
("%s:áddr=%∞skb=%∞Àn=%lu fœgs=%xÉﬁí=%u:\n", 
msg
,

787 
°r
, så->
skb
, så->
Àn
, så->
Êags
, så->
eﬁí
);

788 
	`TFW_STR_FOR_EACH_DUP
(
dup
, 
°r
, 
dup_íd
) {

789 
	`TFW_DBG
(" duplicate %p,Üen=%lu, flags=%xÉolen=%u:\n",

790 
dup
, dup->
Àn
, dup->
Êags
, dup->
eﬁí
);

791 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
dup
, 
chunk_íd
)

792 
	`TFW_DBG
("Üen=%lu,Éolen=%uÖtr=%p flags=%x '%.*s'\n",

793 
c
->
Àn
, c->
eﬁí
, c->
±r
, c->
Êags
,

794 ()
c
->
Àn
, (*)c->
±r
);

796 
	}
}

	@str.h

63 #i‚de‡
__TFW_STR_H__


64 
	#__TFW_STR_H__


	)

66 
	~<löux/bug.h
>

67 
	~<löux/˘y≥.h
>

68 
	~<löux/skbuff.h
>

69 
	~<löux/°rög.h
>

71 
	~"poﬁ.h
"

91 
tfw_°r_öô_c⁄°
();

92 
size_t
 
tfw_m©ch_uri
(c⁄° *
s
, size_à
Àn
);

93 
size_t
 
tfw_m©ch_tokí
(c⁄° *
s
, size_à
Àn
);

94 
size_t
 
tfw_m©ch_qëokí
(c⁄° *
s
, size_à
Àn
);

95 
size_t
 
tfw_m©ch_n˘l
(c⁄° *
s
, size_à
Àn
);

96 
size_t
 
tfw_m©ch_˘ext_vch¨
(c⁄° *
s
, size_à
Àn
);

97 
size_t
 
tfw_m©ch_xff
(c⁄° *
s
, size_à
Àn
);

98 
size_t
 
tfw_m©ch_cookõ
(c⁄° *
s
, size_à
Àn
);

100 
tfw_öô_cu°om_uri
(c⁄° *
a
);

101 
tfw_öô_cu°om_tokí
(c⁄° *
a
);

102 
tfw_öô_cu°om_qëokí
(c⁄° *
a
);

103 
tfw_öô_cu°om_n˘l
(c⁄° *
a
);

104 
tfw_öô_cu°om_˘ext_vch¨
(c⁄° *
a
);

105 
tfw_öô_cu°om_xff
(c⁄° *
a
);

106 
tfw_öô_cu°om_cookõ
(c⁄° *
a
);

108 #ifde‡
AVX2


109 
__tfw_°πﬁowî_avx2
(*
de°
, c⁄° *
§c
,

110 
size_t
 
Àn
);

111 
__tfw_°ricmp_avx2
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
);

112 
__tfw_°ricmp_avx2_2lc
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
);

114 
ölöe
 

115 
	$tfw_c°πﬁowî
(*
de°
, c⁄° *
§c
, 
size_t
 
Àn
)

117 
	`__tfw_°πﬁowî_avx2
((*)
de°
, (c⁄° *)
§c
,

118 
Àn
);

119 
	}
}

124 
ölöe
 

125 
	$tfw_c°ricmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

127  
	`__tfw_°ricmp_avx2
(
s1
, 
s2
, 
Àn
);

128 
	}
}

136 
ölöe
 

137 
	$tfw_c°ricmp_2lc
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

139  
	`__tfw_°ricmp_avx2_2lc
(
s1
, 
s2
, 
Àn
);

140 
	}
}

143 
ölöe
 

144 
	$tfw_c°πﬁowî
(*
de°
, c⁄° *
§c
, 
size_t
 
Àn
)

146 
i
;

147 *
d
 = 
de°
;

148 c⁄° *
s
 = 
§c
;

150 
i
 = 0; i < 
Àn
; ++i)

151 
d
[
i
] = 
	`tﬁowî
(
s
[i]);

152 
	}
}

154 
ölöe
 

155 
	$tfw_c°ricmp
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

157  
	`°∫ˇ£cmp
(
s1
, 
s2
, 
Àn
);

158 
	}
}

160 
ölöe
 

161 
	$tfw_c°ricmp_2lc
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

163  
	`°∫ˇ£cmp
(
s1
, 
s2
, 
Àn
);

164 
	}
}

168 
	#TFW_ULTOA_BUF_SIZ
 20

	)

169 
size_t
 
tfw_u…ﬂ
(
ai
, *
buf
, 
Àn
);

179 
	#TFW_STR_FBITS
 8

	)

180 
	#TFW_STR_FMASK
 ((1U << 
TFW_STR_FBITS
Ë- 1)

	)

181 
	#TFW_STR_CN_SHIFT
 
TFW_STR_FBITS


	)

182 
	#__TFW_STR_CN_MAX
 (~
TFW_STR_FMASK
)

	)

184 
	#__TFW_STR_COMPOUND
 (~((1U << 
TFW_STR_FBITS
Ë- 1))

	)

189 
	#TFW_STR_DUPLICATE
 0x01

	)

191 
	#TFW_STR_COMPLETE
 0x02

	)

193 
	#TFW_STR_NAME
 0x04

	)

195 
	#TFW_STR_VALUE
 0x08

	)

197 
	#TFW_STR_HBH_HDR
 0x10

	)

199 
	#TFW_STR_ETAG_WEAK
 0x20

	)

213 *
	m±r
;

214 
sk_buff
 *
	mskb
;

215 
	mÀn
;

216 
	meﬁí
;

217 
	mÊags
;

218 } 
	tTfwSå
;

220 
	#DEFINE_TFW_STR
(
«me
, 
vÆ
Ë
TfwSå
Çamê{ (vÆ), 
NULL
, \

221 (
vÆ
Ë- 1, 0 }

	)

222 
	#TFW_STR_FROM
(
s
Ë((
TfwSå
){(*)s, 
NULL
, 
	`°æí
(s)})

	)

225 
	#PR_TFW_STR
(
s
Ë()
	`mö
(20UL, (s)->
Àn
), (*)(s)->
±r


	)

228 
	#TFW_STR_CHUNKN
(
s
Ë((s)->
Êags
 >> 
TFW_STR_CN_SHIFT
)

	)

229 
	#TFW_STR_CHUNKN_LIM
(
s
Ë((s)->
Êags
 >
__TFW_STR_CN_MAX
)

	)

230 
	#TFW_STR_CHUNKN_ADD
(
s
, 
n
Ë((s)->
Êags
 +(“Ë<< 
TFW_STR_CN_SHIFT
))

	)

231 
	#TFW_STR_CHUNKN_SUB
(
s
, 
n
Ë((s)->
Êags
 -(“Ë<< 
TFW_STR_CN_SHIFT
))

	)

232 
	#__TFW_STR_CHUNKN_SET
(
s
, 
n
Ë((s)->
Êags
 = ((s)->Êag†& 
TFW_STR_FMASK
) \

233 | ((
n
Ë<< 
TFW_STR_CN_SHIFT
))

	)

235 
	#TFW_STR_CHUNKN_INIT
(
s
Ë
	`__TFW_STR_CHUNKN_SET
(s, 2)

	)

237 
	#TFW_STR_INIT
(
s
Ë
	`mem£t
(s, 0, (
TfwSå
))

	)

239 
	#TFW_STR_EMPTY
(
s
Ë(!((s)->
Êags
 | (s)->
Àn
))

	)

240 
	#TFW_STR_PLAIN
(
s
Ë(!((s)->
Êags
 & 
__TFW_STR_COMPOUND
))

	)

241 
	#TFW_STR_DUP
(
s
Ë((s)->
Êags
 & 
TFW_STR_DUPLICATE
)

	)

244 
	#__TFW_STR_CH
(
s
, 
c
Ë((
TfwSå
 *)(s)->
±r
 + (c))

	)

245 
	#TFW_STR_CHUNK
(
s
, 
c
Ë(((s)->
Êags
 & 
__TFW_STR_COMPOUND
) \

246 ? ((
c
Ë>
	`TFW_STR_CHUNKN
(
s
) \

247 ? 
NULL
 \

248 : 
	`__TFW_STR_CH
(
s
, (
c
))) \

249 : (!(
c
Ë? 
s
 : 
NULL
))

	)

254 
	#TFW_STR_CURR
(
s
) \

256 
	`ty≥of
(
s
Ë
_tmp
 = 
	`TFW_STR_DUP
(s) \

257 ? (
TfwSå
 *)(
s
)->
±r
 + 
	`TFW_STR_CHUNKN
(s) - 1 \

258 : (
s
); \

259 (
_tmp
->
Êags
 & 
__TFW_STR_COMPOUND
) \

260 ? (
TfwSå
 *)
_tmp
->
±r
 + 
	`TFW_STR_CHUNKN
(_tmp) - 1 \

261 : (
_tmp
); \

262 })

	)

263 
	#TFW_STR_LAST
(
s
Ë
	`TFW_STR_CURR
(s)

	)

266 
	#TFW_STR_FOR_EACH_CHUNK
(
c
, 
s
, 
íd
) \

268 
	`BUG_ON
(
	`TFW_STR_DUP
(
s
)); \

269 i‡(
	`TFW_STR_PLAIN
(
s
)) { \

270 (
c
Ë(
s
); \

271 
íd
 = (
s
) + 1; \

273 (
c
Ë(
s
)->
±r
; \

274 
íd
 = (
TfwSå
 *)(
s
)->
±r
 + 
	`TFW_STR_CHUNKN
(s); \

276  ; (
c
Ë< 
íd
; ++(c))

	)

279 
	#TFW_STR_FOR_EACH_DUP
(
d
, 
s
, 
íd
) \

280 i‡(
	`TFW_STR_DUP
(
s
)) { \

281 (
íd
Ë(
TfwSå
 *)(
s
)->
±r
 + 
	`TFW_STR_CHUNKN
(s); \

282 (
d
Ë(
s
)->
±r
; \

284 (
d
Ë(
s
); \

285 (
íd
Ë(
s
) + 1; \

287  ; (
d
Ë< (
íd
); ++(d))

	)

292 
ölöe
 

293 
	$tfw_°r_updÀn
(
TfwSå
 *
s
, c⁄° *
cuº_p
)

295 
n
;

297 i‡(
s
->
Êags
 & 
__TFW_STR_COMPOUND
) {

298 
TfwSå
 *
chunk
 = (TfwSå *)
s
->
±r
 + 
	`TFW_STR_CHUNKN
(s) - 1;

300 
	`BUG_ON
(
chunk
->
Àn
);

301 
	`BUG_ON
(!
chunk
->
±r
 || 
cuº_p
 <= (*)chunk->ptr);

303 
n
 = 
cuº_p
 - (*)
chunk
->
±r
;

304 
chunk
->
Àn
 = 
n
;

306 
n
 = 
cuº_p
 - (*)
s
->
±r
;

308 
s
->
Àn
 +
n
;

309 
	}
}

314 
ölöe
 

315 
	$tfw_°r_eﬁí
(c⁄° 
TfwSå
 *
s
)

317  
s
->
eﬁí
;

318 
	}
}

323 
ölöe
 

324 
	$tfw_°r_£t_eﬁí
(
TfwSå
 *
s
, 
eﬁí
)

326 
	`BUG_ON
(
eﬁí
 > 2);

327 
s
->
eﬁí
 = ()eolen;

328 
	}
}

333 
ölöe
 

334 
	$tfw_°r_tŸÆ_Àn
(c⁄° 
TfwSå
 *
s
)

336  
s
->
Àn
 + s->
eﬁí
;

337 
	}
}

342 
ölöe
 

343 
	$tfw_°r_fixup_eﬁ
(
TfwSå
 *
°r
, 
eﬁí
)

345 
	`BUG_ON
(
eﬁí
 > 2);

346 
	`BUG_ON
(!
	`TFW_STR_PLAIN
(
°r
));

348 
°r
->
Àn
 -(°r->
eﬁí
 =Éolen);

349 i‡(
eﬁí
 == 1)

350 *(*)(
°r
->
±r
 + så->
Àn
) = 0x0a;

351 i‡(
eﬁí
 == 2)

352 *(*)(
°r
->
±r
 + så->
Àn
) = 0x0a0d;

353 
	}
}

355 
tfw_°r_dñ_chunk
(
TfwSå
 *
°r
, 
id
);

357 
TfwSå
 *
tfw_°r_add_compound
(
TfwPoﬁ
 *
poﬁ
, TfwSå *
°r
);

358 
TfwSå
 *
tfw_°r_add_du∂iˇã
(
TfwPoﬁ
 *
poﬁ
, TfwSå *
°r
);

361 
	mTFW_STR_EQ_DEFAULT
 = 0x0,

362 
	mTFW_STR_EQ_PREFIX
 = 0x1,

363 
	mTFW_STR_EQ_CASEI
 = 0x2,

364 
	mTFW_STR_EQ_PREFIX_CASEI
 = (
TFW_STR_EQ_PREFIX
 | 
TFW_STR_EQ_CASEI
),

365 } 
	ttfw_°r_eq_Êags_t
;

367 
tfw_°r˝y
(
TfwSå
 *
d°
, c⁄° TfwSå *
§c
);

368 
TfwSå
 *
tfw_°rdup
(
TfwPoﬁ
 *
poﬁ
, c⁄° TfwSå *
§c
);

369 
tfw_°r˝y_desc
(
TfwSå
 *
d°
, TfwSå *
§c
);

370 
tfw_°rˇt
(
TfwPoﬁ
 *
poﬁ
, 
TfwSå
 *
d°
, TfwSå *
§c
);

372 
__tfw_°rcmp
(c⁄° 
TfwSå
 *
s1
, c⁄° TfwSå *
s2
, 
cs
);

373 
	#tfw_°ricmp
(
s1
, 
s2
Ë
	`__tfw_°rcmp
((s1), (s2), 0)

	)

374 
	#tfw_°rcmp
(
s1
, 
s2
Ë
	`__tfw_°rcmp
((s1), (s2), 1)

	)

375 
__tfw_°rcmp•n
(c⁄° 
TfwSå
 *
s1
, c⁄° TfwSå *
s2
, 
°›
, 
cs
);

376 
	#tfw_°ricmp•n
(
s1
, 
s2
, 
°›
Ë
	`__tfw_°rcmp•n
((s1), (s2), (°›), 0)

	)

377 
	#tfw_°rcmp•n
(
s1
, 
s2
, 
°›
Ë
	`__tfw_°rcmp•n
((s1), (s2), (°›), 1)

	)

379 
boﬁ
 
tfw_°r_eq_c°r
(c⁄° 
TfwSå
 *
°r
, c⁄° *
c°r
, 
c°r_Àn
,

380 
tfw_°r_eq_Êags_t
 
Êags
);

381 
boﬁ
 
tfw_°r_eq_c°r_pos
(c⁄° 
TfwSå
 *
°r
, c⁄° *
pos
, c⁄° *
c°r
,

382 
c°r_Àn
, 
tfw_°r_eq_Êags_t
 
Êags
);

383 
boﬁ
 
tfw_°r_eq_c°r_off
(c⁄° 
TfwSå
 *
°r
, 
ssize_t
 
off£t
, c⁄° *
c°r
,

384 
c°r_Àn
, 
tfw_°r_eq_Êags_t
 
Êags
);

386 
size_t
 
tfw_°r_to_c°r
(c⁄° 
TfwSå
 *
°r
, *
out_buf
, 
buf_size
);

388 
TfwSå
 
tfw_°r_√xt_°r_vÆ
(c⁄° TfwSå *
°r
);

389 
u32
 
tfw_°r_¸c32_ˇlc
(c⁄° 
TfwSå
 *
°r
);

391 #ifde‡
DEBUG


392 
tfw_°r_d¥öt
(c⁄° 
TfwSå
 *
°r
, c⁄° *
msg
);

394 
	#tfw_°r_d¥öt
(
°r
, 
msg
)

	)

	@str_simd.c

24 #ifde‡
AVX2


25 #¥agm®
GCC
 
èrgë
("mmx", "sse4.2", "avx2")

27 #¥agm®
GCC
 
èrgë
("mmx", "sse4.2")

29 
	~<löux/bô›s.h
>

30 
	~<löux/ty≥s.h
>

31 
	~<löux/°rög.h
>

32 
	~<asm/Âu/≠i.h
>

33 
	~<x86öåö.h
>

35 
	~"hty≥.h
"

36 
	~"log.h
"

63 
__m128i
 
	mA128
;

64 
__m128i
 
	ma128
;

65 
__m128i
 
	mD128
;

66 
__m128i
 
	mCASE128
;

67 
__m128i
 
	mARF128
;

68 
__m128i
 
	mLSH128
;

69 
__m128i
 
	m_uri128
;

70 
__m128i
 
	m_tokí128
;

71 
__m128i
 
	m_qëokí128
;

72 
__m128i
 
	m_n˘l128
;

73 
__m128i
 
	m_xff128
;

74 
__m128i
 
	m_cookõ128
;

75 
__m128i
 
	mC_uri_BM128_0
;

76 
__m128i
 
	mC_uri_BM128_1
;

77 
__m128i
 
	mC_tokí_BM128_0
;

78 
__m128i
 
	mC_tokí_BM128_1
;

79 
__m128i
 
	mC_qëokí_BM128_0
;

80 
__m128i
 
	mC_qëokí_BM128_1
;

81 
__m128i
 
	mC_n˘l_BM128_0
;

82 
__m128i
 
	mC_n˘l_BM128_1
;

83 
__m128i
 
	mC_˘ext_vch¨_BM128_0
;

84 
__m128i
 
	mC_˘ext_vch¨_BM128_1
;

85 
__m128i
 
	mC_xff_BM128_0
;

86 
__m128i
 
	mC_xff_BM128_1
;

87 
__m128i
 
	mC_cookõ_BM128_0
;

88 
__m128i
 
	mC_cookõ_BM128_1
;

89 
__m128i
 
	mZERO128
;

90 
__m128i
 
	mSP128
;

91 
__m128i
 
	mHTAB128
;

92 
__m128i
 
	mDEL128
;

93 
__m128i
 
	mASCII128
;

94 #ifde‡
AVX2


95 
__m256i
 
	mA256
;

96 
__m256i
 
	ma256
;

97 
__m256i
 
	mD256
;

98 
__m256i
 
	mCASE256
;

99 
__m256i
 
	mARF256
;

100 
__m256i
 
	mLSH256
;

101 
__m256i
 
	m_uri256
;

102 
__m256i
 
	m_tokí256
;

103 
__m256i
 
	m_qëokí256
;

104 
__m256i
 
	m_n˘l256
;

105 
__m256i
 
	m_xff256
;

106 
__m256i
 
	m_cookõ256
;

107 
__m256i
 
	mC_uri_BM256_0
;

108 
__m256i
 
	mC_uri_BM256_1
;

109 
__m256i
 
	mC_tokí_BM256_0
;

110 
__m256i
 
	mC_tokí_BM256_1
;

111 
__m256i
 
	mC_qëokí_BM256_0
;

112 
__m256i
 
	mC_qëokí_BM256_1
;

113 
__m256i
 
	mC_n˘l_BM256_0
;

114 
__m256i
 
	mC_n˘l_BM256_1
;

115 
__m256i
 
	mC_˘ext_vch¨_BM256_0
;

116 
__m256i
 
	mC_˘ext_vch¨_BM256_1
;

117 
__m256i
 
	mC_xff_BM256_0
;

118 
__m256i
 
	mC_xff_BM256_1
;

119 
__m256i
 
	mC_cookõ_BM256_0
;

120 
__m256i
 
	mC_cookõ_BM256_1
;

121 
__m256i
 
	mZERO256
;

122 
__m256i
 
	mSP256
;

123 
__m256i
 
	mHTAB256
;

124 
__m256i
 
	mDEL256
;

125 
__m256i
 
	mASCII256
;

127 } 
__C
 
____ˇchñöe_Æig√d
 
	g__ªad_mo°ly
;

129 #i‡
deföed
(
DEBUG
) && (DEBUG >= 3)

130 
	#D
(
n
Ë()
d
[n]

	)

132 
	$tfw_dbg_v¥öt16
(c⁄° *
¥efix
, c⁄° 
__m128i
 *
v
)

134 *
d
 = (*)
v
;

136 
	`__T_DBG3
("%s: %.2x %.2x %.2x %.2x %.2x %.2x %.2x %.2x"

138 
¥efix
, 
	`D
(0), D(1), D(2), D(3), D(4), D(5), D(6), D(7),

139 
	`D
(8), D(9), D(10), D(11), D(12), D(13), D(14), D(15));

140 
	}
}

143 
	$tfw_dbg_v¥öt32
(c⁄° *
¥efix
, c⁄° 
__m256i
 *
v
)

145 *
d
 = (*)
v
;

147 
	`__T_DBG3
("%s: %.2x %.2x %.2x %.2x %.2x %.2x %.2x %.2x"

151 
¥efix
, 
	`D
(0), D(1), D(2), D(3), D(4), D(5), D(6), D(7),

152 
	`D
(8), D(9), D(10), D(11), D(12), D(13), D(14), D(15),

153 
	`D
(16), D(17), D(18), D(19), D(20), D(21), D(22), D(23),

154 
	`D
(24), D(25), D(26), D(27), D(28), D(29), D(30), D(31));

155 
	}
}

157 
	#tfw_dbg_v¥öt16
(...)

	)

158 
	#tfw_dbg_v¥öt32
(...)

	)

162 
__öô_cu°om_a
(c⁄° *
cfg_a
, *
a
,

163 
__m128i
 *
bm128_0
, __m128ò*
bm128_1


164 #ifde‡
AVX2


165 , 
__m256i
 *
bm256_0
, __m256ò*
bm256_1


169 
	ga0
[32] = {}, 
	ga1
[32];

170 
	gi
;

172 
mem˝y
(
a
, 
cfg_a
, 256);

175 
	gi
 = 0; i < 256; ++i) {

176 i‡(!
	ga
[
i
])

178 
	ga0
[(
i
 & 0xf) + 16 * !!(i & 0x80)] |= 1 << ((i & 0x70) >> 4);

181 
mem˝y
(
a1
, &
a0
[16], 16);

182 
mem˝y
(&
a1
[16], &
a0
[16], 16);

183 
mem˝y
(&
a0
[16],á0, 16);

185 *
	gbm128_0
 = 
_mm_lddqu_si128
((*)
a0
);

186 *
	gbm128_1
 = 
_mm_lddqu_si128
((*)
a1
);

187 
tfw_dbg_v¥öt16
("lﬂd cu°omáÕhabë/0", 
bm128_0
);

188 
tfw_dbg_v¥öt16
("lﬂd cu°omáÕhabë/1", 
bm128_1
);

189 #ifde‡
AVX2


190 *
	gbm256_0
 = 
_mm256_lddqu_si256
((*)
a0
);

191 *
	gbm256_1
 = 
_mm256_lddqu_si256
((*)
a1
);

192 
tfw_dbg_v¥öt32
("lﬂd cu°omáÕhabë/0", 
bm256_0
);

193 
tfw_dbg_v¥öt32
("lﬂd cu°omáÕhabë/1", 
bm256_1
);

198 
	$tfw_°r_öô_c⁄°
()

200 
__C
.
A128
 = 
	`_mm_£t1_ïi8
('A' - 0x80);

201 
__C
.
a128
 = 
	`_mm_£t1_ïi8
('a' - 0x80);

202 
__C
.
D128
 = 
	`_mm_£t1_ïi8
('Z' - 'A' + 1 - 0x80);

203 
__C
.
CASE128
 = 
	`_mm_£t1_ïi8
(0x20);

204 
__C
.
ARF128
 = 
	`_mm_£å_ïi8
(

207 
__C
.
LSH128
 = 
	`_mm_£t1_ïi8
(0xf);

212 
__C
.
_uri128
 = 
	`_mm_£å_ïi8
(

219 
__C
.
_tokí128
 = 
	`_mm_£å_ïi8
(

225 
__C
.
_qëokí128
 = 
	`_mm_£å_ïi8
(

235 
__C
.
_n˘l128
 = 
	`_mm_£å_ïi8
(

244 
__C
.
_xff128
 = 
	`_mm_£å_ïi8
(

250 
__C
.
_cookõ128
 = 
	`_mm_£å_ïi8
(

255 
__C
.
ZERO128
 = 
	`_mm_£t1_ïi8
(0 - 0x80);

257 
__C
.
SP128
 = 
	`_mm_£t1_ïi8
(' ' - 0x80);

258 
__C
.
HTAB128
 = 
	`_mm_£t1_ïi8
('\t');

259 
__C
.
DEL128
 = 
	`_mm_£t1_ïi8
(0x7f);

260 
__C
.
ASCII128
 = 
	`_mm_£t1_ïi8
(0x80);

262 #ifde‡
AVX2


263 
__C
.
A256
 = 
	`_mm256_£t1_ïi8
('A' - 0x80);

264 
__C
.
a256
 = 
	`_mm256_£t1_ïi8
('a' - 0x80);

265 
__C
.
D256
 = 
	`_mm256_£t1_ïi8
('Z' - 'A' + 1 - 0x80);

266 
__C
.
CASE256
 = 
	`_mm256_£t1_ïi8
(0x20);

267 
__C
.
ARF256
 = 
	`_mm256_£å_ïi8
(

272 
__C
.
LSH256
 = 
	`_mm256_£t1_ïi8
(0xf);

273 
__C
.
_uri256
 = 
	`_mm256_£å_ïi8
(

278 
__C
.
_tokí256
 = 
	`_mm256_£å_ïi8
(

283 
__C
.
_qëokí256
 = 
	`_mm256_£å_ïi8
(

288 
__C
.
_n˘l256
 = 
	`_mm256_£å_ïi8
(

293 
__C
.
_xff256
 = 
	`_mm256_£å_ïi8
(

298 
__C
.
_cookõ256
 = 
	`_mm256_£å_ïi8
(

303 
__C
.
ZERO256
 = 
	`_mm256_£t1_ïi8
(0xff - 0x80 + 1);

304 
__C
.
SP256
 = 
	`_mm256_£t1_ïi8
(' ' - 0x80);

305 
__C
.
HTAB256
 = 
	`_mm256_£t1_ïi8
('\t');

306 
__C
.
DEL256
 = 
	`_mm256_£t1_ïi8
(0x7f);

307 
__C
.
ASCII256
 = 
	`_mm256_£t1_ïi8
(0x80);

309 
	}
}

310 
EXPORT_SYMBOL
(
tfw_°r_öô_c⁄°
);

313 
boﬁ
 
	gcu°om_uri_íabÀd
 = 
Ál£
;

314 
boﬁ
 
	gcu°om_tokí_íabÀd
 = 
Ál£
;

315 
boﬁ
 
	gcu°om_qëokí_íabÀd
 = 
Ál£
;

316 
boﬁ
 
	gcu°om_n˘l_íabÀd
 = 
Ál£
;

317 
boﬁ
 
	gcu°om_˘ext_vch¨_íabÀd
 = 
Ál£
;

318 
boﬁ
 
	gcu°om_xff_íabÀd
 = 
Ál£
;

319 
boﬁ
 
	gcu°om_cookõ_íabÀd
 = 
Ál£
;

320 
	gcu°om_uri
[256] 
	g____ˇchñöe_Æig√d
;

321 
	gcu°om_tokí
[256] 
	g____ˇchñöe_Æig√d
;

322 
	gcu°om_qëokí
[256] 
	g____ˇchñöe_Æig√d
;

323 
	gcu°om_n˘l
[256] 
	g____ˇchñöe_Æig√d
;

324 
	gcu°om_˘ext_vch¨
[256] 
	g____ˇchñöe_Æig√d
;

325 
	gcu°om_xff
[256] 
	g____ˇchñöe_Æig√d
;

326 
	gcu°om_cookõ
[256] 
	g____ˇchñöe_Æig√d
;

336 c⁄° 
	guri
[] 
	g____ˇchñöe_Æig√d
 = {

359 c⁄° 
	gtokí
[] 
	g____ˇchñöe_Æig√d
 = {

382 c⁄° 
	gqëokí
[] 
	g____ˇchñöe_Æig√d
 = {

405 c⁄° 
	gn˘l
[] 
	g____ˇchñöe_Æig√d
 = {

427 c⁄° 
	g˘ext_vch¨
[] 
	g____ˇchñöe_Æig√d
 = {

450 c⁄° 
	gxff
[] 
	g____ˇchñöe_Æig√d
 = {

481 c⁄° 
	gcookõ
[] 
	g____ˇchñöe_Æig√d
 = {

501 
	$__tz˙t
(
x
)

503 #ifde‡
AVX2


504 
r
;

506 
asm
 volatile ("tzcnt %1, %0\n"

507 : "Ù"(
r
)

508 : "r"(
x
));

510  
r
;

512  
x
 ? 
	`__ffs
(x) : 64;

514 
	}
}

517 
	$__tz˙t32
(
x
)

519 #ifde‡
AVX2


520 
r
;

522 
asm
 volatile ("tzcnt %1, %0\n"

523 : "Ù"(
r
)

524 : "r"(
x
));

526  
r
;

528  
x
 ? 
	`__ffs
(0xffffffff00000000UL | x) : 32;

530 
	}
}

532 #ifde‡
AVX2


534 
ölöe
 

535 
	$__°πﬁowî_avx2_8
(*
de°
, c⁄° *
§c
)

537 c⁄° 
__m64
 
_A
 = (__m64)0xc1c1c1c1c1c1c1c1UL;

538 c⁄° 
__m64
 
_D
 = (__m64)0x9a9a9a9a9a9a9a9aUL;

539 c⁄° 
CASE
 = 0x2020202020202020UL;

541 vﬁ©ûê
__m64
 
v
, 
sub
;

542 vﬁ©ûê
cmp_r
;

544 
v
 = *(
__m64
 *)
§c
;

546 
sub
 = 
	`_mm_sub_pi8
(
v
, 
_A
);

547 
cmp_r
 = ()
	`_mm_cmpgt_pi8
(
_D
, 
sub
);

549 *(*)
de°
 = ()
v
 | (
cmp_r
 & 
CASE
);

550 
	}
}

552 
ölöe
 

553 
	$__°πﬁowî_avx2_16
(*
de°
, c⁄° *
§c
)

555 
__m128i
 
v
 = 
	`_mm_lddqu_si128
((*)
§c
);

557 
__m128i
 
sub
 = 
	`_mm_sub_ïi8
(
v
, 
__C
.
A128
);

558 
__m128i
 
cmp_r
 = 
	`_mm_cmpgt_ïi8
(
__C
.
D128
, 
sub
);

559 
__m128i
 
lc
 = 
	`_mm_™d_si128
(
cmp_r
, 
__C
.
CASE128
);

560 
__m128i
 
r
 = 
	`_mm_‹_si128
(
v
, 
lc
);

562 
	`_mm_°‹eu_si128
((
__m128i
 *)
de°
, 
r
);

563 
	}
}

565 
ölöe
 

566 
	$__°πﬁowî_avx2_32
(*
de°
, c⁄° *
§c
)

568 
__m256i
 
v
 = 
	`_mm256_lddqu_si256
((*)
§c
);

570 
__m256i
 
sub
 = 
	`_mm256_sub_ïi8
(
v
, 
__C
.
A256
);

571 
__m256i
 
cmp_r
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub
);

572 
__m256i
 
lc
 = 
	`_mm256_™d_si256
(
cmp_r
, 
__C
.
CASE256
);

573 
__m256i
 
r
 = 
	`_mm256_‹_si256
(
v
, 
lc
);

575 
	`_mm256_°‹eu_si256
((
__m256i
 *)
de°
, 
r
);

576 
	}
}

578 
ölöe
 

579 
	$__°πﬁowî_avx2_64
(*
de°
, c⁄° *
§c
)

581 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
§c
);

582 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)(
§c
 + 32));

584 
__m256i
 
sub0
 = 
	`_mm256_sub_ïi8
(
v0
, 
__C
.
A256
);

585 
__m256i
 
sub1
 = 
	`_mm256_sub_ïi8
(
v1
, 
__C
.
A256
);

586 
__m256i
 
cmp_r0
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub0
);

587 
__m256i
 
cmp_r1
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub1
);

588 
__m256i
 
lc0
 = 
	`_mm256_™d_si256
(
cmp_r0
, 
__C
.
CASE256
);

589 
__m256i
 
lc1
 = 
	`_mm256_™d_si256
(
cmp_r1
, 
__C
.
CASE256
);

590 
__m256i
 
r0
 = 
	`_mm256_‹_si256
(
v0
, 
lc0
);

591 
__m256i
 
r1
 = 
	`_mm256_‹_si256
(
v1
, 
lc1
);

593 
	`_mm256_°‹eu_si256
((
__m256i
 *)
de°
, 
r0
);

594 
	`_mm256_°‹eu_si256
((
__m256i
 *)(
de°
 + 32), 
r1
);

595 
	}
}

597 
ölöe
 

598 
	$__°πﬁowî_avx2_128
(*
de°
, c⁄° *
§c
)

600 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
§c
);

601 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)(
§c
 + 32));

602 
__m256i
 
v2
 = 
	`_mm256_lddqu_si256
((*)(
§c
 + 64));

603 
__m256i
 
v3
 = 
	`_mm256_lddqu_si256
((*)(
§c
 + 96));

605 
__m256i
 
sub0
 = 
	`_mm256_sub_ïi8
(
v0
, 
__C
.
A256
);

606 
__m256i
 
sub1
 = 
	`_mm256_sub_ïi8
(
v1
, 
__C
.
A256
);

607 
__m256i
 
sub2
 = 
	`_mm256_sub_ïi8
(
v2
, 
__C
.
A256
);

608 
__m256i
 
sub3
 = 
	`_mm256_sub_ïi8
(
v3
, 
__C
.
A256
);

610 
__m256i
 
cmp_r0
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub0
);

611 
__m256i
 
cmp_r1
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub1
);

612 
__m256i
 
cmp_r2
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub2
);

613 
__m256i
 
cmp_r3
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub3
);

615 
__m256i
 
lc0
 = 
	`_mm256_™d_si256
(
cmp_r0
, 
__C
.
CASE256
);

616 
__m256i
 
lc1
 = 
	`_mm256_™d_si256
(
cmp_r1
, 
__C
.
CASE256
);

617 
__m256i
 
lc2
 = 
	`_mm256_™d_si256
(
cmp_r2
, 
__C
.
CASE256
);

618 
__m256i
 
lc3
 = 
	`_mm256_™d_si256
(
cmp_r3
, 
__C
.
CASE256
);

620 
__m256i
 
r0
 = 
	`_mm256_‹_si256
(
v0
, 
lc0
);

621 
__m256i
 
r1
 = 
	`_mm256_‹_si256
(
v1
, 
lc1
);

622 
__m256i
 
r2
 = 
	`_mm256_‹_si256
(
v2
, 
lc2
);

623 
__m256i
 
r3
 = 
	`_mm256_‹_si256
(
v3
, 
lc3
);

625 
	`_mm256_°‹eu_si256
((
__m256i
 *)
de°
, 
r0
);

626 
	`_mm256_°‹eu_si256
((
__m256i
 *)(
de°
 + 32), 
r1
);

627 
	`_mm256_°‹eu_si256
((
__m256i
 *)(
de°
 + 64), 
r2
);

628 
	`_mm256_°‹eu_si256
((
__m256i
 *)(
de°
 + 96), 
r3
);

629 
	}
}

632 
	$__tfw_°πﬁowî_avx2
(*
de°
, c⁄° *
§c
, 
size_t
 
Àn
)

634 
i
 = 0;

637 
¥o˚ss_èû
:

638 
Àn
) {

642 
de°
[7] = 
__tfw_l˘
[
§c
[7]];

644 
de°
[6] = 
__tfw_l˘
[
§c
[6]];

646 
de°
[5] = 
__tfw_l˘
[
§c
[5]];

648 
de°
[4] = 
__tfw_l˘
[
§c
[4]];

650 
de°
[3] = 
__tfw_l˘
[
§c
[3]];

652 
de°
[2] = 
__tfw_l˘
[
§c
[2]];

654 
de°
[1] = 
__tfw_l˘
[
§c
[1]];

656 
de°
[0] = 
__tfw_l˘
[
§c
[0]];

660  ; 
	`u∆ikñy
(
i
 + 128 <
Àn
); i += 128)

661 
	`__°πﬁowî_avx2_128
(
de°
 + 
i
, 
§c
 + i);

662 i‡(
	`u∆ikñy
(
i
 + 64 <
Àn
)) {

663 
	`__°πﬁowî_avx2_64
(
de°
 + 
i
, 
§c
 + i);

664 
i
 += 64;

666 i‡(
	`u∆ikñy
(
i
 + 32 <
Àn
)) {

667 
	`__°πﬁowî_avx2_32
(
de°
 + 
i
, 
§c
 + i);

668 
i
 += 32;

670 i‡(
	`u∆ikñy
(
i
 + 16 <
Àn
)) {

671 
	`__°πﬁowî_avx2_16
(
de°
 + 
i
, 
§c
 + i);

672 
i
 += 16;

674 i‡(
	`u∆ikñy
(
i
 + 8 <
Àn
)) {

675 
	`__°πﬁowî_avx2_8
(
de°
 + 
i
, 
§c
 + i);

676 
i
 += 8;

679 
Àn
 -
i
;

680 
de°
 +
i
;

681 
§c
 +
i
;

682 
¥o˚ss_èû
;

683 
	}
}

684 
EXPORT_SYMBOL
(
__tfw_°πﬁowî_avx2
);

686 
ölöe
 

687 
	$__°ricmp_avx2_x‹_32
(c⁄° *
s0
, c⁄° *
s1
)

689 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
s0
);

690 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)
s1
);

692 
__m256i
 
x‹
 = 
	`_mm256_x‹_si256
(
v0
, 
v1
);

693 
__m256i
 
vl0
 = 
	`_mm256_‹_si256
(
v0
, 
__C
.
CASE256
);

694 
__m256i
 
lc
 = 
	`_mm256_cm≥q_ïi8
(
x‹
, 
__C
.
CASE256
);

695 
__m256i
 
sub
 = 
	`_mm256_sub_ïi8
(
vl0
, 
__C
.
a256
);

696 
__m256i
 
cmp_r
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub
);

697 
__m256i
 
good
 = 
	`_mm256_™d_si256
(
lc
, 
cmp_r
);

698 
__m256i
 
good_x‹
 = 
	`_mm256_™d_si256
(
good
, 
__C
.
CASE256
);

699 
__m256i
 
m©ch
 = 
	`_mm256_x‹_si256
(
good_x‹
, 
x‹
);

700 
m©ch
 = 
	`_mm256_cm≥q_ïi8
(m©ch, 
	`_mm256_£tzîo_si256
());

702  ~
	`_mm256_movemask_ïi8
(
m©ch
);

703 
	}
}

705 
ölöe
 

706 
	$__°ricmp_avx2_x‹_64
(c⁄° *
s0
, c⁄° *
s1
)

708 
__m256i
 
v00
 = 
	`_mm256_lddqu_si256
((*)
s0
);

709 
__m256i
 
v01
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 32));

710 
__m256i
 
v10
 = 
	`_mm256_lddqu_si256
((*)
s1
);

711 
__m256i
 
v11
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 32));

713 
__m256i
 
x‹0
 = 
	`_mm256_x‹_si256
(
v00
, 
v10
);

714 
__m256i
 
x‹1
 = 
	`_mm256_x‹_si256
(
v01
, 
v11
);

716 
__m256i
 
vl00
 = 
	`_mm256_‹_si256
(
v00
, 
__C
.
CASE256
);

717 
__m256i
 
vl01
 = 
	`_mm256_‹_si256
(
v01
, 
__C
.
CASE256
);

719 
__m256i
 
lc0
 = 
	`_mm256_cm≥q_ïi8
(
x‹0
, 
__C
.
CASE256
);

720 
__m256i
 
lc1
 = 
	`_mm256_cm≥q_ïi8
(
x‹1
, 
__C
.
CASE256
);

722 
__m256i
 
sub0
 = 
	`_mm256_sub_ïi8
(
vl00
, 
__C
.
a256
);

723 
__m256i
 
sub1
 = 
	`_mm256_sub_ïi8
(
vl01
, 
__C
.
a256
);

725 
__m256i
 
cmp_r0
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub0
);

726 
__m256i
 
cmp_r1
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub1
);

728 
__m256i
 
good0
 = 
	`_mm256_™d_si256
(
lc0
, 
cmp_r0
);

729 
__m256i
 
good1
 = 
	`_mm256_™d_si256
(
lc1
, 
cmp_r1
);

731 
__m256i
 
good_x‹0
 = 
	`_mm256_™d_si256
(
good0
, 
__C
.
CASE256
);

732 
__m256i
 
good_x‹1
 = 
	`_mm256_™d_si256
(
good1
, 
__C
.
CASE256
);

734 
__m256i
 
m©ch0
 = 
	`_mm256_x‹_si256
(
good_x‹0
, 
x‹0
);

735 
__m256i
 
m©ch1
 = 
	`_mm256_x‹_si256
(
good_x‹1
, 
x‹1
);

737 
m©ch0
 = 
	`_mm256_cm≥q_ïi8
(m©ch0, 
	`_mm256_£tzîo_si256
());

738 
m©ch1
 = 
	`_mm256_cm≥q_ïi8
(m©ch1, 
	`_mm256_£tzîo_si256
());

740  ~(
	`_mm256_movemask_ïi8
(
m©ch0
Ë& _mm256_movemask_ïi8(
m©ch1
));

741 
	}
}

743 
ölöe
 

744 
	$__°ricmp_avx2_x‹_128
(c⁄° *
s0
, c⁄° *
s1
)

746 
__m256i
 
v00
 = 
	`_mm256_lddqu_si256
((*)
s0
);

747 
__m256i
 
v01
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 32));

748 
__m256i
 
v02
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 64));

749 
__m256i
 
v03
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 96));

750 
__m256i
 
v10
 = 
	`_mm256_lddqu_si256
((*)
s1
);

751 
__m256i
 
v11
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 32));

752 
__m256i
 
v12
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 64));

753 
__m256i
 
v13
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 96));

755 
__m256i
 
x‹0
 = 
	`_mm256_x‹_si256
(
v00
, 
v10
);

756 
__m256i
 
x‹1
 = 
	`_mm256_x‹_si256
(
v01
, 
v11
);

757 
__m256i
 
x‹2
 = 
	`_mm256_x‹_si256
(
v02
, 
v12
);

758 
__m256i
 
x‹3
 = 
	`_mm256_x‹_si256
(
v03
, 
v13
);

760 
__m256i
 
vl00
 = 
	`_mm256_‹_si256
(
v00
, 
__C
.
CASE256
);

761 
__m256i
 
vl01
 = 
	`_mm256_‹_si256
(
v01
, 
__C
.
CASE256
);

762 
__m256i
 
vl02
 = 
	`_mm256_‹_si256
(
v02
, 
__C
.
CASE256
);

763 
__m256i
 
vl03
 = 
	`_mm256_‹_si256
(
v03
, 
__C
.
CASE256
);

765 
__m256i
 
lc0
 = 
	`_mm256_cm≥q_ïi8
(
x‹0
, 
__C
.
CASE256
);

766 
__m256i
 
lc1
 = 
	`_mm256_cm≥q_ïi8
(
x‹1
, 
__C
.
CASE256
);

767 
__m256i
 
lc2
 = 
	`_mm256_cm≥q_ïi8
(
x‹2
, 
__C
.
CASE256
);

768 
__m256i
 
lc3
 = 
	`_mm256_cm≥q_ïi8
(
x‹3
, 
__C
.
CASE256
);

770 
__m256i
 
sub0
 = 
	`_mm256_sub_ïi8
(
vl00
, 
__C
.
a256
);

771 
__m256i
 
sub1
 = 
	`_mm256_sub_ïi8
(
vl01
, 
__C
.
a256
);

772 
__m256i
 
sub2
 = 
	`_mm256_sub_ïi8
(
vl02
, 
__C
.
a256
);

773 
__m256i
 
sub3
 = 
	`_mm256_sub_ïi8
(
vl03
, 
__C
.
a256
);

775 
__m256i
 
cmp_r0
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub0
);

776 
__m256i
 
cmp_r1
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub1
);

777 
__m256i
 
cmp_r2
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub2
);

778 
__m256i
 
cmp_r3
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub3
);

780 
__m256i
 
good0
 = 
	`_mm256_™d_si256
(
lc0
, 
cmp_r0
);

781 
__m256i
 
good1
 = 
	`_mm256_™d_si256
(
lc1
, 
cmp_r1
);

782 
__m256i
 
good2
 = 
	`_mm256_™d_si256
(
lc2
, 
cmp_r2
);

783 
__m256i
 
good3
 = 
	`_mm256_™d_si256
(
lc3
, 
cmp_r3
);

785 
__m256i
 
good_x‹0
 = 
	`_mm256_™d_si256
(
good0
, 
__C
.
CASE256
);

786 
__m256i
 
good_x‹1
 = 
	`_mm256_™d_si256
(
good1
, 
__C
.
CASE256
);

787 
__m256i
 
good_x‹2
 = 
	`_mm256_™d_si256
(
good2
, 
__C
.
CASE256
);

788 
__m256i
 
good_x‹3
 = 
	`_mm256_™d_si256
(
good3
, 
__C
.
CASE256
);

790 
__m256i
 
m©ch0
 = 
	`_mm256_x‹_si256
(
good_x‹0
, 
x‹0
);

791 
__m256i
 
m©ch1
 = 
	`_mm256_x‹_si256
(
good_x‹1
, 
x‹1
);

792 
__m256i
 
m©ch2
 = 
	`_mm256_x‹_si256
(
good_x‹2
, 
x‹2
);

793 
__m256i
 
m©ch3
 = 
	`_mm256_x‹_si256
(
good_x‹3
, 
x‹3
);

795 
m©ch0
 = 
	`_mm256_cm≥q_ïi8
(m©ch0, 
	`_mm256_£tzîo_si256
());

796 
m©ch1
 = 
	`_mm256_cm≥q_ïi8
(m©ch1, 
	`_mm256_£tzîo_si256
());

797 
m©ch2
 = 
	`_mm256_cm≥q_ïi8
(m©ch2, 
	`_mm256_£tzîo_si256
());

798 
m©ch3
 = 
	`_mm256_cm≥q_ïi8
(m©ch3, 
	`_mm256_£tzîo_si256
());

800  ~(
	`_mm256_movemask_ïi8
(
m©ch0
Ë& _mm256_movemask_ïi8(
m©ch1
)

801 & 
	`_mm256_movemask_ïi8
(
m©ch2
Ë& _mm256_movemask_ïi8(
m©ch3
));

802 
	}
}

804 
ölöe
 

805 
	$__°ricmp_avx2_x‹_èû
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

807 
__m128i
 
x‹
, 
vl0
, 
lc
, 
sub
, 
cmp_r
, 
good
, 
m©ch
;

808 
__m128d
 
v0
, 
v1
;

811 i‡(
Àn
 >= 16) {

812 
r
;

814 
__m128i
 
v0
 = 
	`_mm_lddqu_si128
((*)
s1
);

815 
__m128i
 
v1
 = 
	`_mm_lddqu_si128
((*)
s2
);

816 
x‹
 = 
	`_mm_x‹_si128
(
v0
, 
v1
);

817 
vl0
 = 
	`_mm_‹_si128
(
v0
, 
__C
.
CASE128
);

818 
lc
 = 
	`_mm_cm≥q_ïi8
(
x‹
, 
__C
.
CASE128
);

819 
sub
 = 
	`_mm_sub_ïi8
(
vl0
, 
__C
.
a128
);

820 
cmp_r
 = 
	`_mm_cmpgt_ïi8
(
__C
.
D128
, 
sub
);

821 
good
 = 
	`_mm_™d_si128
(
lc
, 
cmp_r
);

822 
good
 = 
	`_mm_™d_si128
(good, 
__C
.
CASE128
);

823 
m©ch
 = 
	`_mm_x‹_si128
(
good
, 
x‹
);

824 
m©ch
 = 
	`_mm_cm≥q_ïi8
(m©ch, 
	`_mm_£tzîo_si128
());

825 
r
 = 
	`_mm_movemask_ïi8
(
m©ch
) ^ 0xffff;

826 i‡(
Àn
 =16 || 
r
)

827  
r
;

828 
s1
 +
Àn
 - 16;

829 
s2
 +
Àn
 - 16;

830 
Àn
 = 16;

834 
v0
 = 
	`_mm_lﬂdh_pd
(v0, (*)
s1
);

835 
v1
 = 
	`_mm_lﬂdh_pd
(v1, (*)
s2
);

836 
v0
 = 
	`_mm_lﬂdl_pd
(v0, (*)(
s1
 + 
Àn
 - 8));

837 
v1
 = 
	`_mm_lﬂdl_pd
(v1, (*)(
s2
 + 
Àn
 - 8));

839 
x‹
 = 
	`_mm_x‹_si128
((
__m128i
)
v0
, (__m128i)
v1
);

840 
vl0
 = 
	`_mm_‹_si128
((
__m128i
)
v0
, 
__C
.
CASE128
);

841 
lc
 = 
	`_mm_cm≥q_ïi8
(
x‹
, 
__C
.
CASE128
);

842 
sub
 = 
	`_mm_sub_ïi8
(
vl0
, 
__C
.
a128
);

843 
cmp_r
 = 
	`_mm_cmpgt_ïi8
(
__C
.
D128
, 
sub
);

844 
good
 = 
	`_mm_™d_si128
(
lc
, 
cmp_r
);

845 
good
 = 
	`_mm_™d_si128
(good, 
__C
.
CASE128
);

846 
m©ch
 = 
	`_mm_x‹_si128
(
good
, 
x‹
);

847 
m©ch
 = 
	`_mm_cm≥q_ïi8
(m©ch, 
	`_mm_£tzîo_si128
());

849  
	`_mm_movemask_ïi8
(
m©ch
) ^ 0xffff;

850 
	}
}

853 
	$__tfw_°ricmp_avx2
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

855 
i
 = 0, 
c
 = 0;

862 
Àn
) {

866 
c
 |
__tfw_l˘
[
s1
[7]] ^ __tfw_l˘[
s2
[7]];

868 
c
 |
__tfw_l˘
[
s1
[6]] ^ __tfw_l˘[
s2
[6]];

870 
c
 |
__tfw_l˘
[
s1
[5]] ^ __tfw_l˘[
s2
[5]];

872 
c
 |
__tfw_l˘
[
s1
[4]] ^ __tfw_l˘[
s2
[4]];

874 
c
 |
__tfw_l˘
[
s1
[3]] ^ __tfw_l˘[
s2
[3]];

876 
c
 |
__tfw_l˘
[
s1
[2]] ^ __tfw_l˘[
s2
[2]];

878 
c
 |
__tfw_l˘
[
s1
[1]] ^ __tfw_l˘[
s2
[1]];

880 
c
 |
__tfw_l˘
[
s1
[0]] ^ __tfw_l˘[
s2
[0]];

881  
c
;

884 i‡(
	`likñy
(
Àn
 < 32))

885  
	`__°ricmp_avx2_x‹_èû
(
s1
, 
s2
, 
Àn
);

887  ; 
	`u∆ikñy
(
i
 + 128 <
Àn
); i += 128)

888 i‡(
	`__°ricmp_avx2_x‹_128
(
s1
 + 
i
, 
s2
 + i))

890 i‡(
	`u∆ikñy
(
i
 + 64 <
Àn
)) {

891 i‡(
	`__°ricmp_avx2_x‹_64
(
s1
 + 
i
, 
s2
 + i))

893 
i
 += 64;

895 i‡(
	`u∆ikñy
(
i
 + 32 <
Àn
)) {

896 i‡(
	`__°ricmp_avx2_x‹_32
(
s1
 + 
i
, 
s2
 + i))

898 
i
 += 32;

900 i‡(
i
 =
Àn
)

902 
Àn
 -
i
;

903 i‡(
Àn
 < 8) {

904 
i
 -8 - 
Àn
;

905 
Àn
 = 8;

908  
	`__°ricmp_avx2_x‹_èû
(
s1
 + 
i
, 
s2
 + i, 
c
);

909 
	}
}

910 
EXPORT_SYMBOL
(
__tfw_°ricmp_avx2
);

912 
ölöe
 

913 
	$__°ricmp_avx2_2lc_32
(c⁄° *
s0
, c⁄° *
s1
)

915 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
s0
);

916 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)
s1
);

918 
__m256i
 
sub
 = 
	`_mm256_sub_ïi8
(
v0
, 
__C
.
A256
);

919 
__m256i
 
cmp_r
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub
);

920 
__m256i
 
lc
 = 
	`_mm256_™d_si256
(
cmp_r
, 
__C
.
CASE256
);

921 
__m256i
 
vl
 = 
	`_mm256_‹_si256
(
v0
, 
lc
);

923 
__m256i
 
eq
 = 
	`_mm256_cm≥q_ïi8
(
vl
, 
v1
);

925  ~
	`_mm256_movemask_ïi8
(
eq
);

926 
	}
}

928 
ölöe
 

929 
	$__°ricmp_avx2_2lc_64
(c⁄° *
s0
, c⁄° *
s1
)

931 
__m256i
 
v00
 = 
	`_mm256_lddqu_si256
((*)
s0
);

932 
__m256i
 
v01
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 32));

933 
__m256i
 
v10
 = 
	`_mm256_lddqu_si256
((*)
s1
);

934 
__m256i
 
v11
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 32));

936 
__m256i
 
sub00
 = 
	`_mm256_sub_ïi8
(
v00
, 
__C
.
A256
);

937 
__m256i
 
sub01
 = 
	`_mm256_sub_ïi8
(
v01
, 
__C
.
A256
);

938 
__m256i
 
cmp_r00
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub00
);

939 
__m256i
 
cmp_r01
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub01
);

941 
__m256i
 
lc00
 = 
	`_mm256_™d_si256
(
cmp_r00
, 
__C
.
CASE256
);

942 
__m256i
 
lc01
 = 
	`_mm256_™d_si256
(
cmp_r01
, 
__C
.
CASE256
);

944 
__m256i
 
vl00
 = 
	`_mm256_‹_si256
(
v00
, 
lc00
);

945 
__m256i
 
vl01
 = 
	`_mm256_‹_si256
(
v01
, 
lc01
);

947 
__m256i
 
eq0
 = 
	`_mm256_cm≥q_ïi8
(
vl00
, 
v10
);

948 
__m256i
 
eq1
 = 
	`_mm256_cm≥q_ïi8
(
vl01
, 
v11
);

950  ~(
	`_mm256_movemask_ïi8
(
eq0
Ë& _mm256_movemask_ïi8(
eq1
));

951 
	}
}

953 
ölöe
 

954 
	$__°ricmp_avx2_2lc_128
(c⁄° *
s0
, c⁄° *
s1
)

956 
__m256i
 
v00
 = 
	`_mm256_lddqu_si256
((*)
s0
);

957 
__m256i
 
v01
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 32));

958 
__m256i
 
v02
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 64));

959 
__m256i
 
v03
 = 
	`_mm256_lddqu_si256
((*)(
s0
 + 96));

960 
__m256i
 
v10
 = 
	`_mm256_lddqu_si256
((*)
s1
);

961 
__m256i
 
v11
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 32));

962 
__m256i
 
v12
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 64));

963 
__m256i
 
v13
 = 
	`_mm256_lddqu_si256
((*)(
s1
 + 96));

965 
__m256i
 
sub00
 = 
	`_mm256_sub_ïi8
(
v00
, 
__C
.
A256
);

966 
__m256i
 
sub01
 = 
	`_mm256_sub_ïi8
(
v01
, 
__C
.
A256
);

967 
__m256i
 
sub02
 = 
	`_mm256_sub_ïi8
(
v02
, 
__C
.
A256
);

968 
__m256i
 
sub03
 = 
	`_mm256_sub_ïi8
(
v03
, 
__C
.
A256
);

970 
__m256i
 
cmp_r00
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub00
);

971 
__m256i
 
cmp_r01
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub01
);

972 
__m256i
 
cmp_r02
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub02
);

973 
__m256i
 
cmp_r03
 = 
	`_mm256_cmpgt_ïi8
(
__C
.
D256
, 
sub03
);

975 
__m256i
 
lc00
 = 
	`_mm256_™d_si256
(
cmp_r00
, 
__C
.
CASE256
);

976 
__m256i
 
lc01
 = 
	`_mm256_™d_si256
(
cmp_r01
, 
__C
.
CASE256
);

977 
__m256i
 
lc02
 = 
	`_mm256_™d_si256
(
cmp_r02
, 
__C
.
CASE256
);

978 
__m256i
 
lc03
 = 
	`_mm256_™d_si256
(
cmp_r03
, 
__C
.
CASE256
);

980 
__m256i
 
vl00
 = 
	`_mm256_‹_si256
(
v00
, 
lc00
);

981 
__m256i
 
vl01
 = 
	`_mm256_‹_si256
(
v01
, 
lc01
);

982 
__m256i
 
vl02
 = 
	`_mm256_‹_si256
(
v02
, 
lc02
);

983 
__m256i
 
vl03
 = 
	`_mm256_‹_si256
(
v03
, 
lc03
);

985 
__m256i
 
eq0
 = 
	`_mm256_cm≥q_ïi8
(
vl00
, 
v10
);

986 
__m256i
 
eq1
 = 
	`_mm256_cm≥q_ïi8
(
vl01
, 
v11
);

987 
__m256i
 
eq2
 = 
	`_mm256_cm≥q_ïi8
(
vl02
, 
v12
);

988 
__m256i
 
eq3
 = 
	`_mm256_cm≥q_ïi8
(
vl03
, 
v13
);

990  ~(
	`_mm256_movemask_ïi8
(
eq0
Ë& _mm256_movemask_ïi8(
eq1
)

991 & 
	`_mm256_movemask_ïi8
(
eq2
Ë& _mm256_movemask_ïi8(
eq3
));

992 
	}
}

994 
ölöe
 

995 
	$__°ricmp_avx2_2lc_èû
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

997 
__m128i
 
sub
, 
cmp_r
, 
lc
, 
vl
, 
eq
;

998 
__m128d
 
v0
, 
v1
;

1001 i‡(
Àn
 >= 16) {

1002 
r
;

1003 
__m128i
 
v0
 = 
	`_mm_lddqu_si128
((*)
s1
);

1004 
__m128i
 
v1
 = 
	`_mm_lddqu_si128
((*)
s2
);

1005 
sub
 = 
	`_mm_sub_ïi8
(
v0
, 
__C
.
A128
);

1006 
cmp_r
 = 
	`_mm_cmpgt_ïi8
(
__C
.
D128
, 
sub
);

1007 
lc
 = 
	`_mm_™d_si128
(
cmp_r
, 
__C
.
CASE128
);

1008 
vl
 = 
	`_mm_‹_si128
(
v0
, 
lc
);

1009 
eq
 = 
	`_mm_cm≥q_ïi8
(
vl
, 
v1
);

1010 
r
 = 
	`_mm_movemask_ïi8
(
eq
) ^ 0xffff;

1011 i‡(
Àn
 =16 || 
r
)

1012  
r
;

1013 
s1
 +
Àn
 - 16;

1014 
s2
 +
Àn
 - 16;

1015 
Àn
 = 16;

1019 
v0
 = 
	`_mm_lﬂdh_pd
(v0, (*)
s1
);

1020 
v1
 = 
	`_mm_lﬂdh_pd
(v1, (*)
s2
);

1021 
v0
 = 
	`_mm_lﬂdl_pd
(v0, (*)(
s1
 + 
Àn
 - 8));

1022 
v1
 = 
	`_mm_lﬂdl_pd
(v1, (*)(
s2
 + 
Àn
 - 8));

1024 
sub
 = 
	`_mm_sub_ïi8
((
__m128i
)
v0
, 
__C
.
A128
);

1025 
cmp_r
 = 
	`_mm_cmpgt_ïi8
(
__C
.
D128
, (
__m128i
)
sub
);

1026 
lc
 = 
	`_mm_™d_si128
(
cmp_r
, 
__C
.
CASE128
);

1027 
vl
 = 
	`_mm_‹_si128
((
__m128i
)
v0
, 
lc
);

1028 
eq
 = 
	`_mm_cm≥q_ïi8
(
vl
, (
__m128i
)
v1
);

1030  
	`_mm_movemask_ïi8
(
eq
) ^ 0xffff;

1031 
	}
}

1034 
	$__tfw_°ricmp_avx2_2lc
(c⁄° *
s1
, c⁄° *
s2
, 
size_t
 
Àn
)

1036 
i
 = 0, 
c
 = 0;

1038 
Àn
) {

1042 
c
 |
__tfw_l˘
[
s1
[7]] ^ 
s2
[7];

1044 
c
 |
__tfw_l˘
[
s1
[6]] ^ 
s2
[6];

1046 
c
 |
__tfw_l˘
[
s1
[5]] ^ 
s2
[5];

1048 
c
 |
__tfw_l˘
[
s1
[4]] ^ 
s2
[4];

1050 
c
 |
__tfw_l˘
[
s1
[3]] ^ 
s2
[3];

1052 
c
 |
__tfw_l˘
[
s1
[2]] ^ 
s2
[2];

1054 
c
 |
__tfw_l˘
[
s1
[1]] ^ 
s2
[1];

1056 
c
 |
__tfw_l˘
[
s1
[0]] ^ 
s2
[0];

1057  
c
;

1060 i‡(
	`likñy
(
Àn
 < 32))

1061  
	`__°ricmp_avx2_2lc_èû
(
s1
, 
s2
, 
Àn
);

1063  ; 
	`u∆ikñy
(
i
 + 128 <
Àn
); i += 128)

1064 i‡(
	`__°ricmp_avx2_2lc_128
(
s1
 + 
i
, 
s2
 + i))

1066 i‡(
	`u∆ikñy
(
i
 + 64 <
Àn
)) {

1067 i‡(
	`__°ricmp_avx2_2lc_64
(
s1
 + 
i
, 
s2
 + i))

1069 
i
 += 64;

1071 i‡(
	`u∆ikñy
(
i
 + 32 <
Àn
)) {

1072 i‡(
	`__°ricmp_avx2_2lc_32
(
s1
 + 
i
, 
s2
 + i))

1074 
i
 += 32;

1076 i‡(
i
 =
Àn
)

1078 
Àn
 -
i
;

1079 i‡(
Àn
 < 8) {

1080 
i
 -8 - 
Àn
;

1081 
Àn
 = 8;

1084  
	`__°ricmp_avx2_2lc_èû
(
s1
 + 
i
, 
s2
 + i, 
Àn
);

1085 
	}
}

1086 
EXPORT_SYMBOL
(
__tfw_°ricmp_avx2_2lc
);

1088 
ölöe
 
size_t


1089 
	$__tfw_°r•n_avx2_32
(c⁄° *
°r
, 
__m256i
 
sm
)

1091 
r
;

1093 
__m256i
 
v
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1098 
__m256i
 
acbm
 = 
	`_mm256_shufÊe_ïi8
(
sm
, 
v
);

1100 
__m256i
 
¨ows
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v
, 4));

1102 
__m256i
 
¨bôs
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
¨ows
);

1107 
__m256i
 
sbôs
 = 
	`_mm256_™d_si256
(
¨bôs
, 
acbm
);

1113 
v
 = 
	`_mm256_cm≥q_ïi8
(
sbôs
, 
	`_mm256_£tzîo_si256
());

1114 
r
 = 
	`_mm256_movemask_ïi8
(
v
);

1116  
	`__tz˙t32
(
r
);

1117 
	}
}

1119 
ölöe
 
size_t


1120 
	$__tfw_°r•n_avx2_64
(c⁄° *
°r
, 
__m256i
 
sm
)

1122 
r0
, 
r1
;

1124 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1125 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 32));

1127 
__m256i
 
acbm0
 = 
	`_mm256_shufÊe_ïi8
(
sm
, 
v0
);

1128 
__m256i
 
acbm1
 = 
	`_mm256_shufÊe_ïi8
(
sm
, 
v1
);

1130 
__m256i
 
¨ows0
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v0
, 4));

1131 
__m256i
 
¨ows1
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v1
, 4));

1133 
__m256i
 
¨bôs0
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
¨ows0
);

1134 
__m256i
 
¨bôs1
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
¨ows1
);

1136 
__m256i
 
sbôs0
 = 
	`_mm256_™d_si256
(
¨bôs0
, 
acbm0
);

1137 
__m256i
 
sbôs1
 = 
	`_mm256_™d_si256
(
¨bôs1
, 
acbm1
);

1139 
v0
 = 
	`_mm256_cm≥q_ïi8
(
sbôs0
, 
	`_mm256_£tzîo_si256
());

1140 
v1
 = 
	`_mm256_cm≥q_ïi8
(
sbôs1
, 
	`_mm256_£tzîo_si256
());

1142 
r0
 = 
	`_mm256_movemask_ïi8
(
v0
);

1143 
r1
 = 
	`_mm256_movemask_ïi8
(
v1
);

1145  
	`__tz˙t
(
r0
 ^ (
r1
 << 32));

1146 
	}
}

1148 
ölöe
 
size_t


1149 
	$__tfw_°r•n_avx2_128
(c⁄° *
°r
, 
__m256i
 
sm
)

1151 
r0
, 
r1
;

1153 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1154 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 32));

1155 
__m256i
 
v2
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 64));

1156 
__m256i
 
v3
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 96));

1158 
__m256i
 
acbm0
 = 
	`_mm256_shufÊe_ïi8
(
sm
, 
v0
);

1159 
__m256i
 
acbm1
 = 
	`_mm256_shufÊe_ïi8
(
sm
, 
v1
);

1160 
__m256i
 
acbm2
 = 
	`_mm256_shufÊe_ïi8
(
sm
, 
v2
);

1161 
__m256i
 
acbm3
 = 
	`_mm256_shufÊe_ïi8
(
sm
, 
v3
);

1163 
__m256i
 
¨ows0
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v0
, 4));

1164 
__m256i
 
¨ows1
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v1
, 4));

1165 
__m256i
 
¨ows2
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v2
, 4));

1166 
__m256i
 
¨ows3
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v3
, 4));

1168 
__m256i
 
¨bôs0
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
¨ows0
);

1169 
__m256i
 
¨bôs1
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
¨ows1
);

1170 
__m256i
 
¨bôs2
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
¨ows2
);

1171 
__m256i
 
¨bôs3
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
¨ows3
);

1173 
__m256i
 
sbôs0
 = 
	`_mm256_™d_si256
(
¨bôs0
, 
acbm0
);

1174 
__m256i
 
sbôs1
 = 
	`_mm256_™d_si256
(
¨bôs1
, 
acbm1
);

1175 
__m256i
 
sbôs2
 = 
	`_mm256_™d_si256
(
¨bôs2
, 
acbm2
);

1176 
__m256i
 
sbôs3
 = 
	`_mm256_™d_si256
(
¨bôs3
, 
acbm3
);

1178 
v0
 = 
	`_mm256_cm≥q_ïi8
(
sbôs0
, 
	`_mm256_£tzîo_si256
());

1179 
v1
 = 
	`_mm256_cm≥q_ïi8
(
sbôs1
, 
	`_mm256_£tzîo_si256
());

1180 
v2
 = 
	`_mm256_cm≥q_ïi8
(
sbôs2
, 
	`_mm256_£tzîo_si256
());

1181 
v3
 = 
	`_mm256_cm≥q_ïi8
(
sbôs3
, 
	`_mm256_£tzîo_si256
());

1183 
r0
 = 
	`_mm256_movemask_ïi8
(
v1
);

1184 
r1
 = 
	`_mm256_movemask_ïi8
(
v3
);

1185 
r0
 = (r0 << 32Ë| 
	`_mm256_movemask_ïi8
(
v0
);

1186 
r1
 = (r1 << 32Ë| 
	`_mm256_movemask_ïi8
(
v2
);

1187 
r0
 = 
	`__tz˙t
(r0);

1188 
r1
 = 
	`__tz˙t
(r1);

1190  
r0
 < 64 ?Ñ0 : 64 + 
r1
;

1191 
	}
}

1193 
ölöe
 
size_t


1194 
	$__tfw_m©ch_˘ext_vch¨32
(c⁄° *
°r
)

1196 
r
;

1198 
__m256i
 
v
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1200 
__m256i
 
sub
 = 
	`_mm256_sub_ïi8
(
v
, 
__C
.
ZERO256
);

1201 
__m256i
 
x
 = 
	`_mm256_cm≥q_ïi8
(
v
, 
__C
.
DEL256
);

1202 
x
 |
	`_mm256_cmpgt_ïi8
(
__C
.
SP256
, 
sub
);

1203 
x
 ^
	`_mm256_cm≥q_ïi8
(
v
, 
__C
.
HTAB256
);

1204 
r
 = 
	`_mm256_movemask_ïi8
(
x
);

1206  
	`__tz˙t32
(
r
);

1207 
	}
}

1209 
ölöe
 
size_t


1210 
	$__tfw_m©ch_˘ext_vch¨64
(c⁄° *
°r
)

1212 
r0
, 
r1
;

1214 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1215 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 32));

1217 
__m256i
 
sub0
 = 
	`_mm256_sub_ïi8
(
v0
, 
__C
.
ZERO256
);

1218 
__m256i
 
sub1
 = 
	`_mm256_sub_ïi8
(
v1
, 
__C
.
ZERO256
);

1220 
__m256i
 
x0
 = 
	`_mm256_cm≥q_ïi8
(
v0
, 
__C
.
DEL256
);

1221 
__m256i
 
x1
 = 
	`_mm256_cm≥q_ïi8
(
v1
, 
__C
.
DEL256
);

1223 
x0
 |
	`_mm256_cmpgt_ïi8
(
__C
.
SP256
, 
sub0
);

1224 
x1
 |
	`_mm256_cmpgt_ïi8
(
__C
.
SP256
, 
sub1
);

1226 
x0
 ^
	`_mm256_cm≥q_ïi8
(
v0
, 
__C
.
HTAB256
);

1227 
x1
 ^
	`_mm256_cm≥q_ïi8
(
v1
, 
__C
.
HTAB256
);

1229 
r0
 = 
	`_mm256_movemask_ïi8
(
x0
);

1230 
r1
 = 
	`_mm256_movemask_ïi8
(
x1
);

1232  
	`__tz˙t
(
r0
 | (
r1
 << 32));

1233 
	}
}

1235 
ölöe
 
size_t


1236 
	$__tfw_m©ch_˘ext_vch¨128
(c⁄° *
°r
)

1238 
r0
, 
r1
;

1240 
__m256i
 
v0
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1241 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 32));

1242 
__m256i
 
v2
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 64));

1243 
__m256i
 
v3
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 96));

1245 
__m256i
 
sub0
 = 
	`_mm256_sub_ïi8
(
v0
, 
__C
.
ZERO256
);

1246 
__m256i
 
sub1
 = 
	`_mm256_sub_ïi8
(
v1
, 
__C
.
ZERO256
);

1247 
__m256i
 
sub2
 = 
	`_mm256_sub_ïi8
(
v2
, 
__C
.
ZERO256
);

1248 
__m256i
 
sub3
 = 
	`_mm256_sub_ïi8
(
v3
, 
__C
.
ZERO256
);

1250 
__m256i
 
x0
 = 
	`_mm256_cm≥q_ïi8
(
v0
, 
__C
.
DEL256
);

1251 
__m256i
 
x1
 = 
	`_mm256_cm≥q_ïi8
(
v1
, 
__C
.
DEL256
);

1252 
__m256i
 
x2
 = 
	`_mm256_cm≥q_ïi8
(
v2
, 
__C
.
DEL256
);

1253 
__m256i
 
x3
 = 
	`_mm256_cm≥q_ïi8
(
v3
, 
__C
.
DEL256
);

1255 
x0
 |
	`_mm256_cmpgt_ïi8
(
__C
.
SP256
, 
sub0
);

1256 
x1
 |
	`_mm256_cmpgt_ïi8
(
__C
.
SP256
, 
sub1
);

1257 
x2
 |
	`_mm256_cmpgt_ïi8
(
__C
.
SP256
, 
sub2
);

1258 
x3
 |
	`_mm256_cmpgt_ïi8
(
__C
.
SP256
, 
sub3
);

1260 
x0
 ^
	`_mm256_cm≥q_ïi8
(
v0
, 
__C
.
HTAB256
);

1261 
x1
 ^
	`_mm256_cm≥q_ïi8
(
v1
, 
__C
.
HTAB256
);

1262 
x2
 ^
	`_mm256_cm≥q_ïi8
(
v2
, 
__C
.
HTAB256
);

1263 
x3
 ^
	`_mm256_cm≥q_ïi8
(
v3
, 
__C
.
HTAB256
);

1265 
r0
 = 
	`_mm256_movemask_ïi8
(
x1
);

1266 
r1
 = 
	`_mm256_movemask_ïi8
(
x3
);

1267 
r0
 = (r0 << 32Ë| 
	`_mm256_movemask_ïi8
(
x0
);

1268 
r1
 = (r1 << 32Ë| 
	`_mm256_movemask_ïi8
(
x2
);

1269 
r0
 = 
	`__tz˙t
(r0);

1270 
r1
 = 
	`__tz˙t
(r1);

1272  
r0
 < 64 ?Ñ0 : 64 + 
r1
;

1273 
	}
}

1275 
ölöe
 
size_t


1276 
	$__tfw_m©ch_cu°om32
(c⁄° *
°r
, 
__m256i
 *
bm256_0
, __m256ò*
bm256_1
)

1278 
ªs
;

1280 
__m256i
 
v1
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1281 
__m256i
 
v2
 = 
v1
 ^ 
__C
.
ASCII256
;

1283 
__m256i
 
c1
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_0
, 
v1
);

1284 
__m256i
 
c2
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_1
, 
v2
);

1286 
__m256i
 
r
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v1
, 4));

1288 
__m256i
 
¸
 = 
c2
 | 
c1
;

1290 
__m256i
 
r2
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
r
);

1292 
__m256i
 
m
 = 
	`_mm256_™d_si256
(
r2
, 
¸
);

1294 
v1
 = 
	`_mm256_cm≥q_ïi8
(
m
, 
	`_mm256_£tzîo_si256
());

1295 
ªs
 = 
	`_mm256_movemask_ïi8
(
v1
);

1297  
	`__tz˙t32
(
ªs
);

1298 
	}
}

1300 
ölöe
 
size_t


1301 
	$__tfw_m©ch_cu°om64
(c⁄° *
°r
, 
__m256i
 *
bm256_0
, __m256ò*
bm256_1
)

1303 
ªs0
, 
ªs1
;

1305 
__m256i
 
v10
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1306 
__m256i
 
v11
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 32));

1308 
__m256i
 
v20
 = 
v10
 ^ 
__C
.
ASCII256
;

1309 
__m256i
 
v21
 = 
v11
 ^ 
__C
.
ASCII256
;

1311 
__m256i
 
c10
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_0
, 
v10
);

1312 
__m256i
 
c11
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_0
, 
v11
);

1313 
__m256i
 
c20
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_1
, 
v20
);

1314 
__m256i
 
c21
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_1
, 
v21
);

1316 
__m256i
 
r10
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v10
, 4));

1317 
__m256i
 
r11
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v11
, 4));

1319 
__m256i
 
¸0
 = 
c20
 | 
c10
;

1320 
__m256i
 
¸1
 = 
c21
 | 
c11
;

1322 
__m256i
 
r20
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
r10
);

1323 
__m256i
 
r21
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
r11
);

1325 
__m256i
 
m0
 = 
	`_mm256_™d_si256
(
r20
, 
¸0
);

1326 
__m256i
 
m1
 = 
	`_mm256_™d_si256
(
r21
, 
¸1
);

1328 
v10
 = 
	`_mm256_cm≥q_ïi8
(
m0
, 
	`_mm256_£tzîo_si256
());

1329 
v11
 = 
	`_mm256_cm≥q_ïi8
(
m1
, 
	`_mm256_£tzîo_si256
());

1331 
ªs0
 = 
	`_mm256_movemask_ïi8
(
v10
);

1332 
ªs1
 = 
	`_mm256_movemask_ïi8
(
v11
);

1334  
	`__tz˙t
(
ªs0
 ^ (
ªs1
 << 32));

1335 
	}
}

1337 
ölöe
 
size_t


1338 
	$__tfw_m©ch_cu°om128
(c⁄° *
°r
, 
__m256i
 *
bm256_0
, __m256ò*
bm256_1
)

1340 
ªs0
, 
ªs1
;

1342 
__m256i
 
v10
 = 
	`_mm256_lddqu_si256
((*)
°r
);

1343 
__m256i
 
v11
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 32));

1344 
__m256i
 
v12
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 64));

1345 
__m256i
 
v13
 = 
	`_mm256_lddqu_si256
((*)(
°r
 + 96));

1347 
__m256i
 
v20
 = 
v10
 ^ 
__C
.
ASCII256
;

1348 
__m256i
 
v21
 = 
v11
 ^ 
__C
.
ASCII256
;

1349 
__m256i
 
v22
 = 
v12
 ^ 
__C
.
ASCII256
;

1350 
__m256i
 
v23
 = 
v13
 ^ 
__C
.
ASCII256
;

1352 
__m256i
 
c10
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_0
, 
v10
);

1353 
__m256i
 
c11
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_0
, 
v11
);

1354 
__m256i
 
c12
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_0
, 
v12
);

1355 
__m256i
 
c13
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_0
, 
v13
);

1357 
__m256i
 
c20
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_1
, 
v20
);

1358 
__m256i
 
c21
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_1
, 
v21
);

1359 
__m256i
 
c22
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_1
, 
v22
);

1360 
__m256i
 
c23
 = 
	`_mm256_shufÊe_ïi8
(*
bm256_1
, 
v23
);

1362 
__m256i
 
r10
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v10
, 4));

1363 
__m256i
 
r11
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v11
, 4));

1364 
__m256i
 
r12
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v12
, 4));

1365 
__m256i
 
r13
 = 
	`_mm256_™d_si256
(
__C
.
LSH256
, 
	`_mm256_§li_ïi16
(
v13
, 4));

1367 
__m256i
 
¸0
 = 
c20
 | 
c10
;

1368 
__m256i
 
¸1
 = 
c21
 | 
c11
;

1369 
__m256i
 
¸2
 = 
c22
 | 
c12
;

1370 
__m256i
 
¸3
 = 
c23
 | 
c13
;

1372 
__m256i
 
r20
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
r10
);

1373 
__m256i
 
r21
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
r11
);

1374 
__m256i
 
r22
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
r12
);

1375 
__m256i
 
r23
 = 
	`_mm256_shufÊe_ïi8
(
__C
.
ARF256
, 
r13
);

1377 
__m256i
 
m0
 = 
	`_mm256_™d_si256
(
r20
, 
¸0
);

1378 
__m256i
 
m1
 = 
	`_mm256_™d_si256
(
r21
, 
¸1
);

1379 
__m256i
 
m2
 = 
	`_mm256_™d_si256
(
r22
, 
¸2
);

1380 
__m256i
 
m3
 = 
	`_mm256_™d_si256
(
r23
, 
¸3
);

1382 
v10
 = 
	`_mm256_cm≥q_ïi8
(
m0
, 
	`_mm256_£tzîo_si256
());

1383 
v11
 = 
	`_mm256_cm≥q_ïi8
(
m1
, 
	`_mm256_£tzîo_si256
());

1384 
v12
 = 
	`_mm256_cm≥q_ïi8
(
m2
, 
	`_mm256_£tzîo_si256
());

1385 
v13
 = 
	`_mm256_cm≥q_ïi8
(
m3
, 
	`_mm256_£tzîo_si256
());

1387 
ªs0
 = 
	`_mm256_movemask_ïi8
(
v11
);

1388 
ªs1
 = 
	`_mm256_movemask_ïi8
(
v13
);

1389 
ªs0
 = (ªs0 << 32Ë| 
	`_mm256_movemask_ïi8
(
v10
);

1390 
ªs1
 = (ªs1 << 32Ë| 
	`_mm256_movemask_ïi8
(
v12
);

1391 
ªs0
 = 
	`__tz˙t
(res0);

1392 
ªs1
 = 
	`__tz˙t
(res1);

1394  
ªs0
 < 64 ?Ñes0 : 64 + 
ªs1
;

1395 
	}
}

1399 
ölöe
 
size_t


1400 
	$__tfw_°r•n_s£_16
(c⁄° *
°r
, 
__m128i
 
sm
)

1402 
r
;

1404 
__m128i
 
v
 = 
	`_mm_lddqu_si128
((*)
°r
);

1405 
__m128i
 
acbm
 = 
	`_mm_shufÊe_ïi8
(
sm
, 
v
);

1406 
__m128i
 
¨ows
 = 
	`_mm_™d_si128
(
__C
.
LSH128
, 
	`_mm_§li_ïi16
(
v
, 4));

1407 
__m128i
 
¨bôs
 = 
	`_mm_shufÊe_ïi8
(
__C
.
ARF128
, 
¨ows
);

1408 
__m128i
 
sbôs
 = 
	`_mm_™d_si128
(
¨bôs
, 
acbm
);

1409 
v
 = 
	`_mm_cm≥q_ïi8
(
sbôs
, 
	`_mm_£tzîo_si128
());

1410 
r
 = 0xffffffffffff0000UL | 
	`_mm_movemask_ïi8
(
v
);

1412  
	`__tz˙t
(
r
);

1413 
	}
}

1415 
size_t


1416 
__tfw_°r•n_simd
(c⁄° *
°r
, 
size_t
 
Àn
, c⁄° *
tbl
,

1417 
__m128i
 
sm128


1418 #ifde‡
AVX2


1419 , 
__m256i
 
sm256


1423 *
	gs
 = (*)
°r
;

1424 c⁄° *
	gíd
 = 
s
 + 
Àn
;

1425 
	gc0
 = 0, 
	gc1
 = 0, 
	gc2
 = 0, 
	gc3
 = 0;

1426 
size_t
 
	gn
;

1432 i‡(
likñy
(
Àn
 <= 4)) {

1433 
Àn
) {

1437 
c3
 = 
tbl
[
s
[3]];

1439 
c2
 = 
tbl
[
s
[2]];

1441 
c1
 = 
tbl
[
s
[1]];

1443 
c0
 = 
tbl
[
s
[0]];

1445  (
	gc0
 & 
	gc1
Ë=0 ? 
c0
 : 2 + (
c2
 ? c2 + 
c3
 : 0);

1447 #ifde‡
AVX2


1449  ; 
u∆ikñy
(
s
 + 128 <
íd
); 
	gs
 += 128) {

1450 
n
 = 
__tfw_°r•n_avx2_128
(
s
, 
sm256
);

1451 i‡(
	gn
 < 128)

1452  
	gs
 - (*)
	g°r
 + 
	gn
;

1454 i‡(
u∆ikñy
(
s
 + 64 <
íd
)) {

1455 
n
 = 
__tfw_°r•n_avx2_64
(
s
, 
sm256
);

1456 i‡(
	gn
 < 64)

1457  
	gs
 - (*)
	g°r
 + 
	gn
;

1458 
	gs
 += 64;

1460 i‡(
u∆ikñy
(
s
 + 32 <
íd
)) {

1461 
n
 = 
__tfw_°r•n_avx2_32
(
s
, 
sm256
);

1462 i‡(
	gn
 < 32)

1463  
	gs
 - (*)
	g°r
 + 
	gn
;

1464 
	gs
 += 32;

1467  ; 
u∆ikñy
(
s
 + 16 <
íd
); 
	gs
 += 16) {

1468 
n
 = 
__tfw_°r•n_s£_16
(
s
, 
sm128
);

1469 i‡(
	gn
 < 16)

1470  
	gs
 - (*)
	g°r
 + 
	gn
;

1473 
	gs
 + 4 <
íd
) {

1474 
c0
 = 
tbl
[
s
[0]];

1475 
	gc1
 = 
tbl
[
s
[1]];

1476 
	gc2
 = 
tbl
[
s
[2]];

1477 
	gc3
 = 
tbl
[
s
[3]];

1478 i‡(!(
	gc0
 & 
	gc1
 & 
	gc2
 & 
	gc3
)) {

1479 
	gn
 = 
s
 - (*)
°r
;

1480  !(
	gc0
 & 
	gc1
Ë? 
	gn
 + c0 : 
n
 + 2 + (
c2
 ? c2 + 
c3
 : 0);

1482 
	gs
 += 4;

1484 
	gc0
 = 
c1
 = 
c2
 = 0;

1485 
	gíd
 - 
	gs
) {

1487 
c2
 = 
tbl
[
s
[2]];

1489 
c1
 = 
tbl
[
s
[1]];

1491 
c0
 = 
tbl
[
s
[0]];

1494 
	gn
 = 
s
 - (*)
°r
;

1495  !(
	gc0
 & 
	gc1
Ë? 
	gn
 + c0 : 
n
 + 2 + 
c2
;

1498 
ölöe
 
size_t


1499 
	$__tfw_m©ch_˘ext_vch¨16
(c⁄° *
°r
)

1501 
r
;

1503 
__m128i
 
v
 = 
	`_mm_lddqu_si128
((*)
°r
);

1505 
__m128i
 
sub
 = 
	`_mm_sub_ïi8
(
v
, 
__C
.
ZERO128
);

1506 
__m128i
 
x
 = 
	`_mm_cm≥q_ïi8
(
v
, 
__C
.
DEL128
);

1507 
x
 |
	`_mm_cmpgt_ïi8
(
__C
.
SP128
, 
sub
);

1508 
x
 ^
	`_mm_cm≥q_ïi8
(
v
, 
__C
.
HTAB128
);

1509 
r
 = 0xffff0000 | 
	`_mm_movemask_ïi8
(
x
);

1511  
	`__tz˙t32
(
r
);

1512 
	}
}

1514 
size_t


1515 
	$__tfw_m©ch_˘ext_vch¨
(c⁄° *
°r
, 
size_t
 
Àn
)

1517 *
s
 = (*)
°r
;

1518 c⁄° *
íd
 = 
s
 + 
Àn
;

1519 
c0
 = 0, 
c1
 = 0, 
c2
 = 0, 
c3
 = 0;

1520 
size_t
 
n
;

1526 i‡(
	`likñy
(
Àn
 <= 4)) {

1527 
Àn
) {

1531 
c3
 = 
˘ext_vch¨
[
s
[3]];

1533 
c2
 = 
˘ext_vch¨
[
s
[2]];

1535 
c1
 = 
˘ext_vch¨
[
s
[1]];

1537 
c0
 = 
˘ext_vch¨
[
s
[0]];

1539  (
c0
 & 
c1
Ë=0 ? c0 : 2 + (
c2
 ? c2 + 
c3
 : 0);

1541 #ifde‡
AVX2


1543  ; 
	`u∆ikñy
(
s
 + 128 <
íd
); s += 128) {

1544 
n
 = 
	`__tfw_m©ch_˘ext_vch¨128
(
s
);

1545 i‡(
n
 < 128)

1546  
s
 - (*)
°r
 + 
n
;

1548 i‡(
	`u∆ikñy
(
s
 + 64 <
íd
)) {

1549 
n
 = 
	`__tfw_m©ch_˘ext_vch¨64
(
s
);

1550 i‡(
n
 < 64)

1551  
s
 - (*)
°r
 + 
n
;

1552 
s
 += 64;

1554 i‡(
	`u∆ikñy
(
s
 + 32 <
íd
)) {

1555 
n
 = 
	`__tfw_m©ch_˘ext_vch¨32
(
s
);

1556 i‡(
n
 < 32)

1557  
s
 - (*)
°r
 + 
n
;

1558 
s
 += 32;

1561  ; 
	`u∆ikñy
(
s
 + 16 <
íd
); s += 16) {

1562 
n
 = 
	`__tfw_m©ch_˘ext_vch¨16
(
s
);

1563 i‡(
n
 < 16)

1564  
s
 - (*)
°r
 + 
n
;

1567 
s
 + 4 <
íd
) {

1568 
c0
 = 
˘ext_vch¨
[
s
[0]];

1569 
c1
 = 
˘ext_vch¨
[
s
[1]];

1570 
c2
 = 
˘ext_vch¨
[
s
[2]];

1571 
c3
 = 
˘ext_vch¨
[
s
[3]];

1572 i‡(!(
c0
 & 
c1
 & 
c2
 & 
c3
)) {

1573 
n
 = 
s
 - (*)
°r
;

1574  !(
c0
 & 
c1
Ë? 
n
 + c0 :Ç + 2 + (
c2
 ? c2 + 
c3
 : 0);

1576 
s
 += 4;

1578 
c0
 = 
c1
 = 
c2
 = 0;

1579 
íd
 - 
s
) {

1581 
c2
 = 
˘ext_vch¨
[
s
[2]];

1583 
c1
 = 
˘ext_vch¨
[
s
[1]];

1585 
c0
 = 
˘ext_vch¨
[
s
[0]];

1588 
n
 = 
s
 - (*)
°r
;

1589  !(
c0
 & 
c1
Ë? 
n
 + c0 :Ç + 2 + 
c2
;

1590 
	}
}

1592 
size_t


1593 
	$__tfw_m©ch_cu°om16
(c⁄° *
°r
, 
__m128i
 *
bm128_0
, __m128ò*
bm128_1
)

1595 
ªs
;

1597 
__m128i
 
v1
 = 
	`_mm_lddqu_si128
((*)
°r
);

1598 
__m128i
 
v2
 = 
v1
 ^ 
__C
.
ASCII128
;

1600 
__m128i
 
c1
 = 
	`_mm_shufÊe_ïi8
(*
bm128_0
, 
v1
);

1601 
__m128i
 
c2
 = 
	`_mm_shufÊe_ïi8
(*
bm128_1
, 
v2
);

1603 
__m128i
 
r
 = 
	`_mm_™d_si128
(
__C
.
LSH128
, 
	`_mm_§li_ïi16
(
v1
, 4));

1605 
__m128i
 
¸
 = 
c2
 | 
c1
;

1607 
__m128i
 
r2
 = 
	`_mm_shufÊe_ïi8
(
__C
.
ARF128
, 
r
);

1609 
__m128i
 
m
 = 
	`_mm_™d_si128
(
r2
, 
¸
);

1611 
v1
 = 
	`_mm_cm≥q_ïi8
(
m
, 
	`_mm_£tzîo_si128
());

1612 
ªs
 = 0xffffffffffff0000UL | 
	`_mm_movemask_ïi8
(
v1
);

1614  
	`__tz˙t
(
ªs
);

1615 
	}
}

1621 
size_t


1622 
__tfw_m©ch_cu°om
(c⁄° *
°r
, 
size_t
 
Àn
, c⁄° *
a
,

1623 
__m128i
 *
bm128_0
, __m128ò*
bm128_1


1624 #ifde‡
AVX2


1625 , 
__m256i
 *
bm256_0
, __m256ò*
bm256_1


1629 *
	gs
 = (*)
°r
;

1630 c⁄° *
	gíd
 = 
s
 + 
Àn
;

1631 
	gc0
 = 0, 
	gc1
 = 0, 
	gc2
 = 0, 
	gc3
 = 0;

1632 
size_t
 
	gn
;

1638 i‡(
likñy
(
Àn
 <= 4)) {

1639 
Àn
) {

1643 
c3
 = 
a
[
s
[3]];

1645 
c2
 = 
a
[
s
[2]];

1647 
c1
 = 
a
[
s
[1]];

1649 
c0
 = 
a
[
s
[0]];

1651  (
	gc0
 & 
	gc1
Ë=0 ? 
c0
 : 2 + (
c2
 ? c2 + 
c3
 : 0);

1653 #ifde‡
AVX2


1655  ; 
u∆ikñy
(
s
 + 128 <
íd
); 
	gs
 += 128) {

1656 
n
 = 
__tfw_m©ch_cu°om128
(
s
, 
bm256_0
, 
bm256_1
);

1657 i‡(
	gn
 < 128)

1658  
	gs
 - (*)
	g°r
 + 
	gn
;

1660 i‡(
u∆ikñy
(
s
 + 64 <
íd
)) {

1661 
n
 = 
__tfw_m©ch_cu°om64
(
s
, 
bm256_0
, 
bm256_1
);

1662 i‡(
	gn
 < 64)

1663  
	gs
 - (*)
	g°r
 + 
	gn
;

1664 
	gs
 += 64;

1666 i‡(
u∆ikñy
(
s
 + 32 <
íd
)) {

1667 
n
 = 
__tfw_m©ch_cu°om32
(
s
, 
bm256_0
, 
bm256_1
);

1668 i‡(
	gn
 < 32)

1669  
	gs
 - (*)
	g°r
 + 
	gn
;

1670 
	gs
 += 32;

1673  ; 
u∆ikñy
(
s
 + 16 <
íd
); 
	gs
 += 16) {

1674 
n
 = 
__tfw_m©ch_cu°om16
(
s
, 
bm128_0
, 
bm128_1
);

1675 i‡(
	gn
 < 16)

1676  
	gs
 - (*)
	g°r
 + 
	gn
;

1679 
	gs
 + 4 <
íd
) {

1680 
c0
 = 
a
[
s
[0]];

1681 
	gc1
 = 
a
[
s
[1]];

1682 
	gc2
 = 
a
[
s
[2]];

1683 
	gc3
 = 
a
[
s
[3]];

1684 i‡(!(
	gc0
 & 
	gc1
 & 
	gc2
 & 
	gc3
)) {

1685 
	gn
 = 
s
 - (*)
°r
;

1686  !(
	gc0
 & 
	gc1
Ë? 
	gn
 + c0 : 
n
 + 2 + (
c2
 ? c2 + 
c3
 : 0);

1688 
	gs
 += 4;

1690 
	gc0
 = 
c1
 = 
c2
 = 0;

1691 
	gíd
 - 
	gs
) {

1693 
c2
 = 
a
[
s
[2]];

1695 
c1
 = 
a
[
s
[1]];

1697 
c0
 = 
a
[
s
[0]];

1700 
	gn
 = 
s
 - (*)
°r
;

1701  !(
	gc0
 & 
	gc1
Ë? 
	gn
 + c0 : 
n
 + 2 + 
c2
;

1704 
size_t


1705 
	$tfw_m©ch_˘ext_vch¨
(c⁄° *
°r
, 
size_t
 
Àn
)

1707 
size_t
 
r
;

1709 i‡(
cu°om_cookõ_íabÀd
)

1710 #ifde‡
AVX2


1711 
r
 = 
	`__tfw_m©ch_cu°om
(
°r
, 
Àn
, 
cu°om_˘ext_vch¨
,

1712 &
__C
.
C_˘ext_vch¨_BM128_0
,

1713 &
__C
.
C_˘ext_vch¨_BM128_1
,

1714 &
__C
.
C_˘ext_vch¨_BM256_0
,

1715 &
__C
.
C_˘ext_vch¨_BM256_1
);

1717 
r
 = 
	`__tfw_m©ch_cu°om
(
°r
, 
Àn
, 
cu°om_˘ext_vch¨
,

1718 &
__C
.
C_˘ext_vch¨_BM128_0
,

1719 &
__C
.
C_˘ext_vch¨_BM128_1
);

1722 
r
 = 
	`__tfw_m©ch_˘ext_vch¨
(
°r
, 
Àn
);

1724 
	`TFW_DBG3
("%s: så[0]=%#xÜí=%luÑ=%lu\n", 
__func__
, 
°r
[0], 
Àn
, 
r
);

1726  
r
;

1727 
	}
}

1728 
EXPORT_SYMBOL
(
tfw_m©ch_˘ext_vch¨
);

1730 #ifde‡
AVX2


1731 
	#TFW_MATCH
(
a_«me
) \

1732 
size_t
 
tfw_m©ch_
##
	`a_«me
(c⁄° *
°r
, size_à
Àn
) \

1734 
size_t
 
r
; \

1735 i‡(
cu°om_
##
a_«me
##
_íabÀd
) \

1736 
r
 = 
	`__tfw_m©ch_cu°om
(
°r
, 
Àn
, 
cu°om_
##
a_«me
, \

1737 &
__C
.
C_
##
a_«me
##
_BM128_0
, \

1738 &
__C
.
C_
##
a_«me
##
_BM128_1
, \

1739 &
__C
.
C_
##
a_«me
##
_BM256_0
, \

1740 &
__C
.
C_
##
a_«me
##
_BM256_1
); \

1742 
r
 = 
	`__tfw_°r•n_simd
(
°r
, 
Àn
, 
a_«me
, 
__C
.
_
##a_name##128,\

1743 
__C
.
_
##
a_«me
##256);\

1744 
	`TFW_DBG3
("%s: str[0]=%#xÜen=%luÑ=%lu cust=%d\n", \

1745 
__func__
, 
°r
[0], 
Àn
, 
r
, 
cu°om_
##
a_«me
##
_íabÀd
); \

1746  
r
; \

1748 
	`EXPORT_SYMBOL
(
tfw_m©ch_
##
a_«me
);

	)

1750 
	#TFW_INIT_CUSTOM_A
(
a_«me
) \

1751 
tfw_öô_cu°om_
##
	`a_«me
(c⁄° *
a
) \

1753 
cu°om_
##
a_«me
##
_íabÀd
 = !!
a
; \

1754 i‡(!!
a
) \

1755 
	`__öô_cu°om_a
(
a
, 
cu°om_
##
a_«me
, \

1756 &
__C
.
C_
##
a_«me
##
_BM128_0
, \

1757 &
__C
.
C_
##
a_«me
##
_BM128_1
, \

1758 &
__C
.
C_
##
a_«me
##
_BM256_0
, \

1759 &
__C
.
C_
##
a_«me
##
_BM256_1
); \

1761 
	`EXPORT_SYMBOL
(
tfw_öô_cu°om_
##
a_«me
);

	)

1765 
	#TFW_MATCH
(
a_«me
) \

1766 
size_t
 
tfw_m©ch_
##
	`a_«me
(c⁄° *
°r
, size_à
Àn
) \

1768 
size_t
 
r
; \

1769 i‡(
cu°om_
##
a_«me
##
_íabÀd
) \

1770 
r
 = 
	`__tfw_m©ch_cu°om
(
°r
, 
Àn
, 
cu°om_
##
a_«me
, \

1771 &
__C
.
C_
##
a_«me
##
_BM128_0
, \

1772 &
__C
.
C_
##
a_«me
##
_BM128_1
); \

1774 
r
 = 
	`__tfw_°r•n_simd
(
°r
, 
Àn
, 
a_«me
, 
__C
.
_
##a_name##128);\

1775 
	`TFW_DBG3
("%s: str[0]=%#xÜen=%luÑ=%lu cust=%d\n", \

1776 
__func__
, 
°r
[0], 
Àn
, 
r
, 
cu°om_
##
a_«me
##
_íabÀd
); \

1777  
r
; \

1779 
	`EXPORT_SYMBOL
(
tfw_m©ch_
##
a_«me
);

	)

1781 
	#TFW_INIT_CUSTOM_A
(
a_«me
) \

1782 
tfw_öô_cu°om_
##
	`a_«me
(c⁄° *
a
) \

1784 
cu°om_
##
a_«me
##
_íabÀd
 = !!
a
; \

1785 i‡(!!
a
) \

1786 
	`__öô_cu°om_a
(
a
, 
cu°om_
##
a_«me
, \

1787 &
__C
.
C_
##
a_«me
##
_BM128_0
, \

1788 &
__C
.
C_
##
a_«me
##
_BM128_1
); \

1790 
	`EXPORT_SYMBOL
(
tfw_öô_cu°om_
##
a_«me
);

	)

1794 
TFW_MATCH
(
uri
);

1795 
TFW_MATCH
(
tokí
);

1796 
TFW_MATCH
(
qëokí
);

1797 
TFW_MATCH
(
n˘l
);

1798 
TFW_MATCH
(
xff
);

1799 
TFW_MATCH
(
cookõ
);

1801 
TFW_INIT_CUSTOM_A
(
uri
);

1802 
TFW_INIT_CUSTOM_A
(
tokí
);

1803 
TFW_INIT_CUSTOM_A
(
qëokí
);

1804 
TFW_INIT_CUSTOM_A
(
n˘l
);

1805 
TFW_INIT_CUSTOM_A
(
˘ext_vch¨
);

1806 
TFW_INIT_CUSTOM_A
(
xff
);

1807 
TFW_INIT_CUSTOM_A
(
cookõ
);

	@stress.c

24 
	~"ãm≥°a_fw.h
"

25 
	~"hâp_limôs.h
"

26 
	~"°ªss.h
"

29 
LIST_HEAD
(
°ªss_h™dÀrs
);

30 
DEFINE_RWLOCK
(
tfw_°ªss_lock
);

33 
	$tfw_°ªss_accou¡_§v
( )

35 
TfwSåess
 *
s
;

37 
	`ªad_lock
(&
tfw_°ªss_lock
);

38 
	`li°_f‹_óch_íåy
(
s
, &
°ªss_h™dÀrs
, 
°_li°
) {

39 i‡(
s
->
ty≥
 & 
TfwSåess_Srv
)

40 i‡(
s
->
	`accou¡_§v
())

41 
	`tfw_˛assify_shrök
();

43 
	`ªad_u∆ock
(&
tfw_°ªss_lock
);

44 
	}
}

47 
	$tfw_°ªss_accou¡_sys
()

49 
TfwSåess
 *
s
;

51 
	`ªad_lock
(&
tfw_°ªss_lock
);

52 
	`li°_f‹_óch_íåy
(
s
, &
°ªss_h™dÀrs
, 
°_li°
) {

53 i‡(
s
->
ty≥
 & 
TfwSåess_Sys
)

54 i‡(
s
->
	`accou¡_sys
())

55 
	`tfw_˛assify_shrök
();

57 
	`ªad_u∆ock
(&
tfw_°ªss_lock
);

58 
	}
}

61 
	$tfw_°ªss_ªgi°î
(
TfwSåess
 *
mod
)

63 
	`wrôe_lock
(&
tfw_°ªss_lock
);

64 
	`li°_add
(&
mod
->
°_li°
, &
°ªss_h™dÀrs
);

65 
	`wrôe_u∆ock
(&
tfw_°ªss_lock
);

68 
	}
}

71 
	$tfw_°ªss_uƒegi°î
(
TfwSåess
 *
mod
)

73 
TfwSåess
 *
s
, *
tmp
;

75 
	`wrôe_lock
(&
tfw_°ªss_lock
);

76 
	`li°_f‹_óch_íåy_ß„
(
s
, 
tmp
, &
°ªss_h™dÀrs
, 
°_li°
) {

77 i‡(
s
 =
mod
) {

78 
	`li°_dñ
(&
s
->
°_li°
);

82 
	`wrôe_u∆ock
(&
tfw_°ªss_lock
);

83 
	}
}

	@stress.h

21 #i‚de‡
__TFW_STRESS__


22 
	#__TFW_STRESS__


	)

24 
	~<löux/li°.h
>

26 
	~"ãm≥°a_fw.h
"

29 
	mTfwSåess_Sys
 = 1,

30 
	mTfwSåess_Srv
 = 2,

31 } 
	tTfwSåessTy≥
;

35 
li°_hód
 
	m°_li°
;

37 
TfwSåessTy≥
 
	mty≥
;

48 
boﬁ
 (*
accou¡_§v
)();

53 
boﬁ
 (*
accou¡_sys
)();

55 } 
	tTfwSåess
;

57 
tfw_°ªss_accou¡_§v
();

58 
tfw_°ªss_accou¡_sys
();

60 
tfw_°ªss_ªgi°î
(
TfwSåess
 *
mod
);

61 
tfw_°ªss_uƒegi°î
(
TfwSåess
 *
mod
);

	@sync_socket.h

21 #i‚de‡
__SS_SOCK_H__


22 
	#__SS_SOCK_H__


	)

24 
	~<√t/sock.h
>

25 
	~<√t/t˝.h
>

26 
	~<löux/skbuff.h
>

28 
	~"addr.h
"

29 
	~"ss_skb.h
"

32 
	sss_¥Ÿo_t
 {

33 c⁄° 
ss_hooks
 *
	mhooks
;

34 
sock
 *
	mli°íî
;

35 
	mty≥
;

36 } 
	tSsPrŸo
;

45 
	m__Fœg_Bôs
 = 0x10,

53 
	mC⁄n_St›
 = 0x1 << 
__Fœg_Bôs
,

57 
	sss_hooks
 {

59 (*
	mc⁄√˘i⁄_√w
)(
sock
 *
	msk
);

69 (*
	mc⁄√˘i⁄_dr›
)(
sock
 *
	msk
);

76 (*
	mc⁄√˘i⁄_îr‹
)(
sock
 *
	msk
);

79 (*
	mc⁄√˘i⁄_ªcv
)(*
	mc⁄n
, 
sk_buff
 *
	mskb
,

80 
	moff
);

81 } 
	tSsHooks
;

90 
	mrb_wq_sz
;

91 
	mbacklog_sz
;

92 } 
	tSsSèt
;

94 
ölöe
 

95 
	$ss_sock_hﬁd
(
sock
 *
sk
)

97 
	`sock_hﬁd
(
sk
);

98 
	}
}

100 
ölöe
 

101 
	$ss_sock_put
(
sock
 *
sk
)

103 
	`sock_put
(
sk
);

104 
	}
}

106 
ölöe
 
boﬁ


107 
	$ss_sock_live
(
sock
 *
sk
)

109  
sk
->
sk_°©e
 =
TCP_ESTABLISHED
;

110 
	}
}

113 
	#SS_F_SYNC
 0x01

	)

115 
	#SS_F_KEEP_SKB
 0x02

	)

117 
	#SS_F_CONN_CLOSE
 0x04

	)

119 
	#SS_F_ENCRYPT
 0x08

	)

122 
	#SS_SKB_TYPE2F
(
t
Ë((()—)Ë<< 8)

	)

123 
	#SS_SKB_F2TYPE
(
f
Ë((fË>> 8)

	)

125 
ss_hooks_ªgi°î
(
SsHooks
* 
hooks
);

126 
ss_hooks_uƒegi°î
(
SsHooks
* 
hooks
);

128 
ss_¥Ÿo_öô
(
SsPrŸo
 *
¥Ÿo
, c⁄° 
SsHooks
 *
hooks
, 
ty≥
);

129 
ss_¥Ÿo_öhîô
(c⁄° 
SsPrŸo
 *
∑ª¡
, SsPrŸÿ*
chûd
, 
chûd_ty≥
);

130 
ss_£t_ˇŒbacks
(
sock
 *
sk
);

131 
ss_£t_li°í
(
sock
 *
sk
);

132 
ss_£nd
(
sock
 *
sk
, 
sk_buff
 **
skb_hód
, 
Êags
);

133 
ss_˛o£
(
sock
 *
sk
, 
Êags
);

134 
ss_sock_¸óã
(
Ámûy
, 
ty≥
, 
¥Ÿocﬁ
, 
sock
 **
ªs
);

135 
ss_ªÀa£
(
sock
 *
sk
);

136 
ss_c⁄√˘
(
sock
 *
sk
, 
sockaddr
 *
addr
, 
addæí
, 
Êags
);

137 
ss_böd
(
sock
 *
sk
, 
sockaddr
 *
addr
, 
addæí
);

138 
ss_li°í
(
sock
 *
sk
, 
backlog
);

139 
ss_gë≥î«me
(
sock
 *
sk
, 
TfwAddr
 *
addr
);

140 
ss_waô_√wc⁄n
();

141 
ss_synchr⁄ize
();

142 
ss_°¨t
();

143 
ss_°›
();

144 
boﬁ
 
ss_a˘ive
();

145 
ss_gë_°©
(
SsSèt
 *
°©
);

147 
	#SS_CALL
(
f
, ...) \

148 (
sk
->
sk_u£r_d©a
 && ((
SsPrŸo
 *)(sk)->sk_u£r_d©a)->
hooks
->
f
 \

149 ? ((
SsPrŸo
 *)(
sk
)->
sk_u£r_d©a
)->
hooks
->
	`f
(
__VA_ARGS__
) \

150 : 0)

	)

152 
	#SS_CONN_TYPE
(
sk
) \

153 (((
SsPrŸo
 *)(
sk
)->
sk_u£r_d©a
)->
ty≥
)

	)

	@t/bomber.c

22 
	~<löux/‰ìzî.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/kthªad.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/waô.h
>

27 
	~<löux/vmÆloc.h
>

28 
	~<√t/öë_sock.h
>

30 
	~"addr.h
"

31 
	~"c⁄√˘i⁄.h
"

32 
	~"hâp_msg.h
"

33 
	~"log.h
"

34 
	~"sync_sockë.h
"

35 
	~"fuzzî.h
"

37 
	g¡hªads
 = 2;

38 
	gnôîs
 = 2;

39 
	gnc⁄ns
 = 2;

40 
	gnmesßges
 = 2;

41 
	gvîbo£
 = 0;

42 *
	g£rvî
 = "127.0.0.1:80";

44 
moduÀ_∑øm_«med
(
t
, 
¡hªads
, , 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
);

45 
moduÀ_∑øm_«med
(
i
, 
nôîs
, , 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
);

46 
moduÀ_∑øm_«med
(
c
, 
nc⁄ns
, , 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
);

47 
moduÀ_∑øm_«med
(
m
, 
nmesßges
, , 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
);

48 
moduÀ_∑øm_«med
(
v
, 
vîbo£
, , 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
);

49 
moduÀ_∑øm_«med
(
s
, 
£rvî
, 
ch¨p
, 0);

51 
MODULE_PARM_DESC
(
t
, "Number ofÅhreads (setÅhisÅoÅheÇumber of CPU cores)");

52 
MODULE_PARM_DESC
(
i
, "Number ofÅhread iterations");

53 
MODULE_PARM_DESC
(
c
, "Number of connections");

54 
MODULE_PARM_DESC
(
m
, "Number of messagesÖer connection");

55 
MODULE_PARM_DESC
(
v
, "VerbosityÜevel");

56 
MODULE_PARM_DESC
(
s
, "Server hostáddressánd optionalÖortÇunber");

58 
MODULE_AUTHOR
("Tempesta Technologies, Inc");

59 
MODULE_DESCRIPTION
("Tempesta Boomber");

60 
MODULE_VERSION
("0.2.3");

61 
MODULE_LICENSE
("GPL");

63 #ifde‡
TFW_BANNER


64 #unde‡
TFW_BANNER


66 
	#TFW_BANNER
 "[tfw_bombî] "

	)

68 
	#BUF_SIZE
 (20 * 1024 * 1024)

	)

69 
	#DEAD_TRIES
 
HZ


	)

72 
	mTFW_BMB_SK_INACTIVE
,

73 
	mTFW_BMB_SK_ACTIVE


76 
	gtfw_bmb_èsk_t
;

82 
SsPrŸo
 
	m¥Ÿo
;

83 
sock
 *
	msk
;

84 
tfw_bmb_èsk_t
 *
	mèsk
;

85 } 
	tTfwBmbC⁄n
;

97 
	stfw_bmb_èsk_t
 {

98 
èsk_°ru˘
 *
	mèsk_°ru˘
;

99 
TfwBmbC⁄n
 *
	mc⁄n
;

100 
©omic_t
 
	mc⁄n_com∂
;

101 
©omic_t
 
	mc⁄n_îr‹
;

102 
waô_queue_hód_t
 
	mc⁄n_wq
;

103 
TfwFuzzC⁄ãxt
 
	m˘x
;

104 
	mbuf
[
BUF_SIZE
];

105 } 
	tTfwBmbTask
;

107 
DECLARE_WAIT_QUEUE_HEAD
(
bmb_èsk_wq
);

109 
©omic_t
 
	gbmb_thªads
 = 
ATOMIC_INIT
(0);

110 
©omic_t
 
	gbmb_c⁄n_©ãm±
 = 
ATOMIC_INIT
(0);

111 
©omic_t
 
	gbmb_c⁄n_com∂
 = 
ATOMIC_INIT
(0);

112 
©omic_t
 
	gbmb_c⁄n_îr‹
 = 
ATOMIC_INIT
(0);

113 
©omic_t
 
	gbmb_c⁄n_dr›
 = 
ATOMIC_INIT
(0);

114 
©omic_t
 
	gbmb_ªque°_£nd
 = 
ATOMIC_INIT
(0);

116 
TfwAddr
 
	gbmb_£rvî_addªss
;

117 
SsHooks
 
	gbmb_hooks
;

118 
TfwBmbTask
 *
	gbmb_èsks
;

120 
ölöe
 

121 
	$__check_c⁄n
(
TfwBmbC⁄n
 *
c⁄n
)

123 
	`BUG_ON
(
c⁄n
->
¥Ÿo
.
li°íî
);

124 
	`BUG_ON
(
c⁄n
->
¥Ÿo
.
hooks
 !&
bmb_hooks
);

125 
	`BUG_ON
(!
c⁄n
->
sk
);

126 
	`BUG_ON
(!
c⁄n
->
èsk
);

127 
	}
}

130 
	$tfw_bmb_c⁄n_com∂
(
sock
 *
sk
)

132 
TfwBmbC⁄n
 *
c⁄n
 = 
sk
->
sk_u£r_d©a
;

134 
	`BUG_ON
(!
c⁄n
);

135 
c⁄n
->
¥Ÿo
.
ty≥
 = 
TFW_BMB_SK_ACTIVE
;

136 
	`__check_c⁄n
(
c⁄n
);

138 
	`©omic_öc
(&
c⁄n
->
èsk
->
c⁄n_com∂
);

139 
	`wake_up
(&
c⁄n
->
èsk
->
c⁄n_wq
);

142 
	}
}

145 
	$tfw_bmb_c⁄n_dr›
(
sock
 *
sk
)

147 
TfwBmbC⁄n
 *
c⁄n
 = 
sk
->
sk_u£r_d©a
;

149 
	`BUG_ON
(!
c⁄n
);

150 
	`__check_c⁄n
(
c⁄n
);

152 
	`©omic_öc
(&
bmb_c⁄n_dr›
);

153 
	`©omic_öc
(&
c⁄n
->
èsk
->
c⁄n_îr‹
);

155 
	`tfw_c⁄√˘i⁄_u∆ök_‰om_sk
(
sk
);

156 
c⁄n
->
¥Ÿo
.
ty≥
 = 
TFW_BMB_SK_INACTIVE
;

158 
	`wake_up
(&
c⁄n
->
èsk
->
c⁄n_wq
);

159 
	}
}

162 
	$tfw_bmb_¥öt_msg
(*
msg_d©a
, *
d©a
, 
size_t
 
Àn
,

163 *
ªad
)

165 
	`¥ötk
(
KERN_INFO
 "%.*s\n", ()
Àn
, 
d©a
);

166 *
ªad
 = 
Àn
;

169 
	}
}

172 
	$tfw_bmb_c⁄n_ªcv
(*
cd©a
, 
sk_buff
 *
skb
, 
off
)

174 i‡(
vîbo£
) {

175 
∑r£d
 = 0, 
chunks
 = 0;

177 
	`TFW_LOG
("ServerÑesponse:\n------------------------------\n");

179 
	`ss_skb_¥o˚ss
(
skb
, 0, 0, 
tfw_bmb_¥öt_msg
, 
NULL
, &
chunks
,

180 &
∑r£d
);

182 
	`¥ötk
(
KERN_INFO
 "\n------------------------------\n");

185 
	`__k‰ì_skb
(
skb
);

186  
TFW_PASS
;

187 
	}
}

189 
SsHooks
 
	gbmb_hooks
 = {

190 .
c⁄√˘i⁄_√w
 = 
tfw_bmb_c⁄n_com∂
,

191 .
	gc⁄√˘i⁄_dr›
 = 
tfw_bmb_c⁄n_dr›
,

192 .
	gc⁄√˘i⁄_îr‹
 = 
tfw_bmb_c⁄n_dr›
,

193 .
	gc⁄√˘i⁄_ªcv
 = 
tfw_bmb_c⁄n_ªcv
,

197 
	$tfw_bmb_c⁄√˘
(
TfwBmbTask
 *
èsk
, 
TfwBmbC⁄n
 *
c⁄n
)

199 
ªt
;

200 
sock
 *
sk
;

202 
ªt
 = 
	`ss_sock_¸óã
(
bmb_£rvî_addªss
.
ß
.
ß_Ámûy
, 
SOCK_STREAM
,

203 
IPPROTO_TCP
, &
sk
);

204 i‡(
ªt
) {

205 
	`TFW_ERR
("U«bÀÅÿ¸óã kî√»sockë (%d)\n", 
ªt
);

206  
ªt
;

209 
	`ss_¥Ÿo_öô
(&
c⁄n
->
¥Ÿo
, &
bmb_hooks
, 
TFW_BMB_SK_INACTIVE
);

210 
sk
->
sk_u£r_d©a
 = &
c⁄n
->
¥Ÿo
;

211 
	`ss_£t_ˇŒbacks
(
sk
);

212 
c⁄n
->
sk
 = sk;

213 
c⁄n
->
èsk
 =Åask;

215 
ªt
 = 
	`ss_c⁄√˘
(
sk
, &
bmb_£rvî_addªss
.
ß
,

216 
	`tfw_addr_ß_Àn
(&
bmb_£rvî_addªss
), 0);

217 i‡(
ªt
) {

218 
	`TFW_ERR
("C⁄√˘Éº‹ o¿£rvî sockë sk %∞(%d)\n", 
sk
, 
ªt
);

219 
	`ss_˛o£
(
sk
, 0);

220 
c⁄n
->
sk
 = 
NULL
;

221  
ªt
;

225 
	}
}

228 
	$tfw_bmb_ªÀa£_sockës
(
TfwBmbTask
 *
èsk
)

230 
i
;

232 
i
 = 0; i < 
nc⁄ns
; i++) {

233 i‡(
èsk
->
c⁄n
[
i
].
¥Ÿo
.
ty≥
 =
TFW_BMB_SK_INACTIVE
)

236 i‡(
	`ss_˛o£
(
èsk
->
c⁄n
[
i
].
sk
, 
SS_F_SYNC
))

237 
	`TFW_WARN
("C™nŸ clo£ %dth sockë\n", 
i
);

239 
	}
}

242 
	$tfw_bmb_msg_£nd
(
TfwBmbTask
 *
èsk
, 
˙
)

244 
fz_åõs
 = 0, 
r
;

245 
TfwSå
 
msg
;

246 
TfwMsgIãr
 
ô
;

247 
TfwHâpMsg
 
hmªq
;

250 i‡(++
fz_åõs
 > 10) {

251 
	`TFW_ERR
("Too many fuzzerÅriesÅo generateÑequest\n");

255 
r
 = 
	`fuzz_gí
(&
èsk
->
˘x
,Åask->
buf
, &èsk->buf[
BUF_SIZE
], 0, 1,

256 
FUZZ_REQ
);

257 i‡(
r
 < 0) {

258 
	`TFW_ERR
("C™nŸ gíî©êHTTPÑeque°,Ñ=%d\n", 
r
);

261 i‡(
r
 =
FUZZ_END
)

262 
	`fuzz_öô
(&
èsk
->
˘x
, 
åue
);

263 } 
r
 !
FUZZ_VALID
);

265 
msg
.
±r
 = 
èsk
->
buf
;

266 
msg
.
skb
 = 
NULL
;

267 
msg
.
Àn
 = 
	`°æí
(msg.
±r
);

268 
msg
.
Êags
 = 0;

269 
	`BUG_ON
(
msg
.
Àn
 > 
BUF_SIZE
);

271 
	`mem£t
(&
hmªq
, 0, (hmreq));

272 
hmªq
.
msg
.
skb_hód
 = 
NULL
;

274 i‡(!
	`tfw_hâp_msg_£tup
(&
hmªq
, &
ô
, 
msg
.
Àn
)) {

275 
	`TFW_WARN
("Cannot create HTTPÑequest.\n");

279 i‡(
vîbo£
)

280 
	`TFW_LOG
("SendÑequest:\n"

284 
èsk
->
buf
);

286 
	`tfw_msg_wrôe
(&
ô
, &
msg
);

287 
	`ss_£nd
(
èsk
->
c⁄n
[
˙
].
sk
, &
hmªq
.
msg
.
skb_hód
, 
åue
);

289 
	`©omic_öc
(&
bmb_ªque°_£nd
);

290 
	}
}

293 
	$do_£nd_w‹k
(
TfwBmbTask
 *
èsk
, 
to_£nd
)

295 
c
, 
£¡
 = 0, 
dód_åy
 = 0;

298 
¥ev_£¡
 = 
£¡
;

299 
c
 = 0; c < 
nc⁄ns
; ++c) {

300 i‡(
èsk
->
c⁄n
[
c
].
¥Ÿo
.
ty≥
 =
TFW_BMB_SK_INACTIVE
)

302 
	`tfw_bmb_msg_£nd
(
èsk
, 
c
);

303 i‡(++
£¡
 =
to_£nd
)

305 
dód_åy
 = 0;

307 i‡(
¥ev_£¡
 =
£¡
) {

308 i‡(++
dód_åy
 =
DEAD_TRIES
) {

309 
	`TFW_WARN
("Dód sockës, síà%d\n", 
£¡
);

312 
	`scheduÀ
();

316 
	}
}

319 
	$tfw_bmb_w‹kî
(*
d©a
)

321 
©ãm±
, 
i
, 
c
;

322 
time_max
;

323 
TfwBmbTask
 *
èsk
 = 
d©a
;

325 
	`fuzz_öô
(&
èsk
->
˘x
, 
åue
);

327 
i
 = 0; i < 
nôîs
; i++) {

328 
©ãm±
 = 0;

329 
	`©omic_£t
(&
èsk
->
c⁄n_com∂
, 0);

330 
	`©omic_£t
(&
èsk
->
c⁄n_îr‹
, 0);

331 
	`öô_waôqueue_hód
(&
èsk
->
c⁄n_wq
);

333 
c
 = 0; c < 
nc⁄ns
; c++)

334 i‡(!
	`tfw_bmb_c⁄√˘
(
èsk
,Åask->
c⁄n
 + 
c
))

335 ++
©ãm±
;

337 
	`£t_‰ìzabÀ
();

338 
time_max
 = 
jiffõs
 + 60 * 
HZ
;

340 
	#COND
(Ë(
	`©omic_ªad
(&
èsk
->
c⁄n_com∂
) > 0 || \

341 
	`©omic_ªad
(&
èsk
->
c⁄n_îr‹
Ë=
©ãm±
)

	)

342 
	`waô_evít_‰ìzabÀ_timeout
(
èsk
->
c⁄n_wq
, 
	`COND
(), 
HZ
);

343 #unde‡
COND


344 i‡(
	`©omic_ªad
(&
èsk
->
c⁄n_com∂
) > 0)

346 i‡(
	`©omic_ªad
(&
èsk
->
c⁄n_îr‹
Ë=
©ãm±
)

347 
ªÀa£_sockës
;

348 i‡(
jiffõs
 > 
time_max
) {

349 
	`TFW_ERR
("workerÉxceeded maximum waitÅime\n");

350 
ªÀa£_sockës
;

352 } !
	`kthªad_should_°›
());

354 
	`do_£nd_w‹k
(
èsk
, 
nc⁄ns
 * 
nmesßges
);

356 
ªÀa£_sockës
:

357 
	`©omic_add
(
©ãm±
, &
bmb_c⁄n_©ãm±
);

358 
	`©omic_add
(
	`©omic_ªad
(&
èsk
->
c⁄n_com∂
), &
bmb_c⁄n_com∂
);

359 
	`©omic_add
(
	`©omic_ªad
(&
èsk
->
c⁄n_îr‹
), &
bmb_c⁄n_îr‹
);

361 
	`tfw_bmb_ªÀa£_sockës
(
èsk
);

363 
c
 = 0; c < 
nc⁄ns
; c++) {

364 
åõs
 = 0;

365 
èsk
->
c⁄n
[
c
].
¥Ÿo
.
ty≥
 =
TFW_BMB_SK_ACTIVE
) {

366 
	`scheduÀ
();

367 i‡(++
åõs
 =
DEAD_TRIES
) {

368 
	`loˇl_bh_dißbÀ
();

369 
	`ss_˛o£
(
èsk
->
c⁄n
[
c
].
sk
, 0);

370 
	`loˇl_bh_íabÀ
();

385 
èsk
->
èsk_°ru˘
 = 
NULL
;

386 
	`©omic_dec
(&
bmb_thªads
);

387 
	`wake_up
(&
bmb_èsk_wq
);

390 
	}
}

393 
	$tfw_bmb_°›_thªads
()

395 
i
;

397 
i
 = 0; i < 
¡hªads
; i++) {

398 i‡(
bmb_èsks
[
i
].
èsk_°ru˘
) {

400 
	`kthªad_°›
(
bmb_èsks
[
i
].
èsk_°ru˘
);

401 
bmb_èsks
[
i
].
èsk_°ru˘
 = 
NULL
;

402 
	`©omic_dec
(&
bmb_thªads
);

405 
	}
}

411 
	$tfw_bmb_ªp‹t
(
ts_°¨t
)

414 
	#R
(...Ë
	`¥_öfo
(
TFW_BANNER
 
__VA_ARGS__
)

	)

415 
	`R
("BOMBER SUMMARY:");

416 
	`R
("ÅŸÆ c⁄√˘i⁄s: %d\n", 
nc⁄ns
 * 
nôîs
 * 
¡hªads
);

417 
	`R
("áâem±ed c⁄√˘i⁄s: %d\n", 
	`©omic_ªad
(&
bmb_c⁄n_©ãm±
));

418 
	`R
(" com∂ëed c⁄√˘i⁄s: %d\n", 
	`©omic_ªad
(&
bmb_c⁄n_com∂
));

419 
	`R
("Éº‹ c⁄√˘i⁄s: %d\n", 
	`©omic_ªad
(&
bmb_c⁄n_îr‹
));

420 
	`R
(" dr›≥d c⁄√˘i⁄s: %d\n", 
	`©omic_ªad
(&
bmb_c⁄n_dr›
));

421 
	`R
("ÅŸÆÑeque°s: %d\n", 
	`©omic_ªad
(&
bmb_ªque°_£nd
));

422 
	`R
("ÅŸÆÅime: %ldms\n", 
jiffõs
 - 
ts_°¨t
);

423 #unde‡
R


424 
	}
}

427 
	$tfw_bmb_Æloc
()

429 
i
;

430 *
p
;

432 
p
 = 
	`vzÆloc
(
¡hªads
 * ((
TfwBmbTask
)

433 + 
nc⁄ns
 * (
TfwBmbC⁄n
)));

434 i‡(!
p
)

435  -
ENOMEM
;

437 
bmb_èsks
 = (
TfwBmbTask
 *)
p
;

438 
p
 +
¡hªads
 * (
TfwBmbTask
);

439 
i
 = 0; i < 
¡hªads
; i++) {

440 
bmb_èsks
[
i
].
c⁄n
 = (
TfwBmbC⁄n
 *)
p
;

441 
p
 +
nc⁄ns
 * (
TfwBmbC⁄n
);

445 
	}
}

448 
	$tfw_bmb_‰ì
()

450 i‡(
bmb_èsks
) {

451 
	`v‰ì
(
bmb_èsks
);

452 
bmb_èsks
 = 
NULL
;

454 
	}
}

456 
__öô


457 
	$tfw_bmb_öô
()

459 
i
;

460 vﬁ©ûê
ts_°¨t
;

461 
èsk_°ru˘
 *
èsk
;

462 
r
 = 0;

464 i‡(
	`tfw_addr_±⁄
(&
	`TFW_STR_FROM
(
£rvî
), &
bmb_£rvî_addªss
)) {

465 
	`TFW_ERR
("U«bÀÅÿ∑r£ sîvî'†addªss: %s", 
£rvî
);

466  -
EINVAL
;

468 
	`TFW_LOG
("Sèπed bombî moduÀ, sîvî'†addªs†i†%s\n", 
£rvî
);

470 i‡(
	`tfw_bmb_Æloc
())

471  -
ENOMEM
;

473 
ts_°¨t
 = 
jiffõs
;

475 
i
 = 0; i < 
¡hªads
; i++) {

476 
èsk
 = 
	`kthªad_¸óã
(
tfw_bmb_w‹kî
, 
bmb_èsks
 + 
i
, "bomber");

477 i‡(
	`IS_ERR_OR_NULL
(
èsk
)) {

478 
	`TFW_ERR
("UnableÅo create worker\n");

479 
r
 = -
EINVAL
;

480 
	`tfw_bmb_°›_thªads
();

481 
out
;

483 
bmb_èsks
[
i
].
èsk_°ru˘
 = 
èsk
;

484 
	`©omic_öc
(&
bmb_thªads
);

486 
i
 = 0; i < 
¡hªads
; i++)

487 
	`wake_up_¥o˚ss
(
bmb_èsks
[
i
].
èsk_°ru˘
);

489 
	`waô_evít_öãºu±ibÀ
(
bmb_èsk_wq
, !
	`©omic_ªad
(&
bmb_thªads
));

491 
	`tfw_bmb_ªp‹t
(
ts_°¨t
);

492 
out
:

493 
	`tfw_bmb_‰ì
();

495  
r
;

496 
	}
}

499 
	$tfw_bmb_exô
()

501 i‡(!
bmb_èsks
)

504 
	`tfw_bmb_°›_thªads
();

505 
	`tfw_bmb_‰ì
();

506 
	}
}

508 
moduÀ_öô
(
tfw_bmb_öô
);

509 
moduÀ_exô
(
tfw_bmb_exô
);

	@t/fuzzer.c

22 
	~<löux/kî√l.h
>

23 
	~<löux/moduÀ.h
>

24 
	~<löux/°rög.h
>

25 
	~<löux/¶ab.h
>

27 
	~"fuzzî.h
"

28 
	~"log.h
"

30 
MODULE_AUTHOR
("Tempesta Technologies, Inc");

31 
MODULE_DESCRIPTION
("Tempesta HTTP fuzzer");

32 
MODULE_VERSION
("0.1.3");

33 
MODULE_LICENSE
("GPL");

35 
	#FUZZ_MSG_F_INVAL
 
FUZZ_INVALID


	)

36 
	#FUZZ_MSG_F_EMPTY_BODY
 0x10

	)

37 
	#FUZZ_MSG_F_SHIFT
 8

	)

44 *
	msvÆ
;

45 
	mÊags
;

46 } 
	tFuzzMsg
;

48 
	#FUZZ_MSG_INVAL
(
m
Ë((m).
Êags
 & 
FUZZ_MSG_F_INVAL
)

	)

50 
FuzzMsg
 
	g•a˚s
[] = {

53 
FuzzMsg
 
	gmëhods
[] = {

56 
FuzzMsg
 
	guri_∑th_°¨t
[] = {

59 
FuzzMsg
 
	guri_fûe
[] = {

62 
FuzzMsg
 
	gvîsi⁄s
[] = {

63 {"1.0"}, {"1.1"}, {"0.9", 
FUZZ_MSG_F_INVAL
}

65 
	#FUZZ_FLD_F_STATUS_100
 (0x0001 << 
FUZZ_MSG_F_SHIFT
)

	)

66 
	#FUZZ_FLD_F_STATUS_204
 (0x0002 << 
FUZZ_MSG_F_SHIFT
)

	)

67 
	#FUZZ_FLD_F_STATUS_304
 (0x0004 << 
FUZZ_MSG_F_SHIFT
)

	)

68 
FuzzMsg
 
	gª•_code
[] = {

69 {"100 C⁄töue", 
FUZZ_FLD_F_STATUS_100
 | 
FUZZ_MSG_F_EMPTY_BODY
},

71 {"204 NÿC⁄ã¡", 
FUZZ_FLD_F_STATUS_204
 | 
FUZZ_MSG_F_EMPTY_BODY
},

73 {"304 NŸ Modifõd", 
FUZZ_FLD_F_STATUS_304
 | 
FUZZ_MSG_F_EMPTY_BODY
},

77 
FuzzMsg
 
	gc⁄n_vÆ
[] = {

80 
FuzzMsg
 
	gua_vÆ
[] = {

83 
FuzzMsg
 
	gho°_vÆ
[] = {

87 
FuzzMsg
 
	gc⁄ã¡_ty≥
[] = {

90 
FuzzMsg
 
	gc⁄ã¡_Àn
[] = {

91 {"10000"}, {"0"}, {"-42", 
FUZZ_MSG_F_INVAL
},

94 
	#FUZZ_FLD_F_CHUNKED
 (0x0001 << 
FUZZ_MSG_F_SHIFT
)

	)

95 
	#FUZZ_FLD_F_CHUNKED_LAST
 (0x0002 << 
FUZZ_MSG_F_SHIFT
)

	)

96 
FuzzMsg
 
	gå™s„r_ícodög
[] = {

97 {"chunked", 
FUZZ_FLD_F_CHUNKED
},

100 
FuzzMsg
 
	gac˚±
[] = {

104 
FuzzMsg
 
	gac˚±_œnguage
[] = {

107 
FuzzMsg
 
	gac˚±_ícodög
[] = {

111 
FuzzMsg
 
	gac˚±_ønges
[] = {

114 
FuzzMsg
 
	gcookõ
[] = {

117 
FuzzMsg
 
	g£t_cookõ
[] = {

120 
FuzzMsg
 
	gëag
[] = {

123 
FuzzMsg
 
	g£rvî
[] = {

126 
FuzzMsg
 
	gˇche_c⁄åﬁ
[] = {

131 
FuzzMsg
 
	gexpúes
[] = {

133 {"Tue, 999 J™ 2012 15:02:53 GMT", 
FUZZ_MSG_F_INVAL
}

143 (*
	tÊd_func_t
)(
	tTfwFuzzC⁄ãxt
 *
	t˘x
,

144 
	tty≥
, 
	tÊd
, 
	tvÆ
);

152 
	$Êd_å™s„r_ícodög
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, 
Êd
, 
vÆ
)

154 
Êd_d©a_Êags
;

156 
	`BUG_ON
(
Êd
 !
TRANSFER_ENCODING
);

157 
	`BUG_ON
(
vÆ
 >(
å™s„r_ícodög
Ë/ (
FuzzMsg
));

159 
Êd_d©a_Êags
 = 
å™s„r_ícodög
[
vÆ
].
Êags
;

165 i‡(
ty≥
 =
FUZZ_RESP
) {

166 i‡(
˘x
->
Êd_Êags
[
RESP_CODE
]

167 & (
FUZZ_FLD_F_STATUS_100
 | 
FUZZ_FLD_F_STATUS_204
))

168  
Êd_d©a_Êags
 | 
FUZZ_INVALID
;

175 i‡(
˘x
->
Êd_Êags
[
TRANSFER_ENCODING
] & 
FUZZ_FLD_F_CHUNKED
) {

176 i‡(
Êd_d©a_Êags
 & 
FUZZ_FLD_F_CHUNKED
)

177  
Êd_d©a_Êags
 | 
FUZZ_INVALID
;

178 
˘x
->
Êd_Êags
[
TRANSFER_ENCODING
] &~
FUZZ_FLD_F_CHUNKED_LAST
;

179 } i‡(
Êd_d©a_Êags
 & 
FUZZ_FLD_F_CHUNKED
) {

180 
Êd_d©a_Êags
 |
FUZZ_FLD_F_CHUNKED_LAST
;

183  
Êd_d©a_Êags
 | 
FUZZ_VALID
;

184 
	}
}

193 
	$Êd_expúes
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, 
Êd
, 
vÆ
)

195 
	`BUG_ON
(
ty≥
 !
FUZZ_RESP
);

196 
	`BUG_ON
(
Êd
 !
EXPIRES
);

197 
	`BUG_ON
(
vÆ
 >(
expúes
Ë/ (
FuzzMsg
));

199  
FUZZ_VALID
;

200 
	}
}

208 *
	mkey
;

209 
FuzzMsg
 *
	mvÆs
;

210 
Êd_func_t
 
	mfunc
;

211 } 
	gÊd_d©a
[
N_FIELDS
] = {

212 [0 ... 
N_FIELDS
-1] = { 0 },

213 [
SPACES
] = { 
NULL
, 
•a˚s
 },

214 [
METHOD
] = { 
NULL
, 
mëhods
 },

215 [
HTTP_VER
] = { 
NULL
, 
vîsi⁄s
 },

216 [
RESP_CODE
] = { 
NULL
, 
ª•_code
 },

217 [
URI_PATH_START
] = { 
NULL
, 
uri_∑th_°¨t
 },

218 [
URI_FILE
] = { 
NULL
, 
uri_fûe
 },

219 [
CONNECTION
] = { "C⁄√˘i⁄:", 
c⁄n_vÆ
 },

220 [
USER_AGENT
] = { "U£r-Agít:", 
ua_vÆ
 },

221 [
HOST
] = { "Ho°:", 
ho°_vÆ
 },

222 [
X_FORWARDED_FOR
] = { "X-F‹w¨ded-F‹:", 
ho°_vÆ
 },

223 [
CONTENT_TYPE
] = { "C⁄ã¡-Ty≥:", 
c⁄ã¡_ty≥
 },

224 [
CONTENT_LENGTH
] = { "C⁄ã¡-Lígth:", 
c⁄ã¡_Àn
 },

225 [
TRANSFER_ENCODING
] = { "Tøns„r-Encodög:", 
å™s„r_ícodög
,

226 
Êd_å™s„r_ícodög
 },

227 [
ACCEPT
] = { "Ac˚±:", 
ac˚±
 },

228 [
ACCEPT_LANGUAGE
] = { "Ac˚±-L™guage:", 
ac˚±_œnguage
 },

229 [
ACCEPT_ENCODING
] = { "Ac˚±-Encodög:", 
ac˚±_ícodög
 },

230 [
ACCEPT_RANGES
] = { "Ac˚±-R™ges:", 
ac˚±_ønges
 },

231 [
COOKIE
] = { "Cookõ:", 
cookõ
 },

232 [
SET_COOKIE
] = { "Së-Cookõ:", 
£t_cookõ
 },

233 [
ETAG
] = { "ETag:", 
ëag
 },

234 [
SERVER
] = { "Sîvî:", 
£rvî
 },

235 [
CACHE_CONTROL
] = { "Cache-C⁄åﬁ:", 
ˇche_c⁄åﬁ
 },

236 [
EXPIRES
] = { "Expúes:", 
expúes
, 
Êd_expúes
 },

239 
	#A_URI
 "ABCDEFGHIJKLMNOPQRSTUVWXYZ" \

240 "abcdefghijklmn›qr°uvwxyz0123456789-._~:/?#[]@!$&'()*+,;="

	)

241 
	#A_URI_INVAL
 " <>`^{}\"\n\t\x03\x07\x1F"

	)

242 
	#A_UA
 "ABCDEFGHIJKLMNOPQRSTUVWXYZ" \

244 "-._~:/?#[]@!$&'()*+,;<>`^{}\""

	)

245 
	#A_UA_INVAL
 "\n\t\x03\x07\x1F"

	)

246 
	#A_HOST
 "ABCDEFGHIJKLMNOPQRSTUVWXYZ" \

247 "abcdefghijklmn›qr°uvwxyz0123456789-."

	)

249 
	#A_BODY
 "GHIJKLMNOPQRSTUVWXYZghijklmnopqrstuvwxyz.,-_;: \n\t" \

250 "\x03\x07\x1F\x8F\xFF"

	)

251 
	#A_HOST_INVAL
 
A_URI_INVAL


	)

252 
	#A_X_FF
 
A_HOST


	)

253 
	#A_X_FF_INVAL
 
A_URI_INVAL


	)

254 
	#INVALID_FIELD_PERIOD
 5

	)

255 
	#DUPLICATES_PERIOD
 10

	)

256 
	#MAX_DUPLICATES
 9

	)

257 
	#INVALID_BODY_PERIOD
 5

	)

269 
	msize
;

270 
	movî
;

271 *
	ma_vÆ
;

272 *
	ma_övÆ
;

273 
	msöguœr
;

274 
	mdissù©i⁄
;

275 
	mmax_vÆ_Àn
;

276 } 
	ggí_ve˘‹
[
N_FIELDS
] = {

278 {(
•a˚s
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL},

280 {(
mëhods
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL},

282 {(
vîsi⁄s
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL},

284 {(
ª•_code
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL},

286 {(
uri_∑th_°¨t
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL},

288 {(
uri_fûe
Ë/ (
FuzzMsg
), 2, 
A_URI
, 
A_URI_INVAL
},

290 {(
c⁄n_vÆ
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 0},

292 {(
ua_vÆ
Ë/ (
FuzzMsg
), 2, 
A_UA
, 
A_UA_INVAL
, 1, 1},

294 {(
ho°_vÆ
Ë/ (
FuzzMsg
), 2, 
A_HOST
, 
A_HOST_INVAL
, 1, 1},

296 {(
ho°_vÆ
Ë/ (
FuzzMsg
), 2, 
A_X_FF
, 
A_X_FF_INVAL
, 0, 1},

298 {(
c⁄ã¡_ty≥
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 1, 1},

300 {(
c⁄ã¡_Àn
Ë/ (
FuzzMsg
), 2, "0123456789", 
A_URI
, 1, 1,

301 
MAX_CONTENT_LENGTH_LEN
},

303 {(
å™s„r_ícodög
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 0},

305 {(
ac˚±
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

307 {(
ac˚±_œnguage
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

309 {(
ac˚±_ícodög
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

311 {(
ac˚±_ønges
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

313 {(
cookõ
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 1, 1},

315 {(
£t_cookõ
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

317 {(
ëag
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

319 {(
£rvî
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

321 {(
ˇche_c⁄åﬁ
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

323 {(
expúes
Ë/ (
FuzzMsg
), 0, 
NULL
, NULL, 0, 1},

325 {2, 0, 
NULL
, NULL},

327 {2, 0, 
NULL
, NULL},

329 {3, 0, 
NULL
, NULL},

333 
	$gí_ve˘‹_move
(
TfwFuzzC⁄ãxt
 *
˘x
, 
i
)

335 
max
;

337 i‡(
i
 =
N_FIELDS
)

338  
FUZZ_END
;

340 
max
 = 
gí_ve˘‹
[
i
].
size
 + gí_ve˘‹[i].
ovî
 - 1;

342 
˘x
->
i
[i]++;

343 i‡(
˘x
->
i
[i] > 
max
) {

344 
˘x
->
i
[i] = 0;

345 i‡(
	`gí_ve˘‹_move
(
˘x
, 
i
 + 1Ë=
FUZZ_END
)

346  
FUZZ_END
;

348 } 
˘x
->
is_⁄ly_vÆid
 && 
Êd_d©a
[
i
].
vÆs


349 && 
˘x
->
i
[i] < 
gí_ve˘‹
[i].
size


350 && 
	`FUZZ_MSG_INVAL
(
Êd_d©a
[
i
].
vÆs
[
˘x
->i[i]]));

352  
FUZZ_VALID
;

353 
	}
}

356 
	$addch
(**
p
, *
íd
, 
ch
)

358 i‡(!
ch
)

361 if(*
p
 + 1 > 
íd
)

364 *(*
p
)++ = 
ch
;

365 
	}
}

368 
	$add_°rög
(**
p
, *
íd
, c⁄° *
°r
)

370 ; *
°r
 != '\0'; str++)

371 
	`addch
(
p
, 
íd
, *
°r
);

372 
	}
}

375 
	$add_ønd_°rög
(**
p
, *
íd
, 
n
, c⁄° *
£ed
)

377 
i
, 
Àn
;

378 
idxvÆ
;

380 
	`BUG_ON
(!
£ed
);

382 
Àn
 = 
	`°æí
(
£ed
);

383 
i
 = 0; i < 
n
; ++i) {

384 
idxvÆ
 = (
i
 + 333Ë^ 
£ed
[ò% 
Àn
];

385 
	`addch
(
p
, 
íd
, 
£ed
[
idxvÆ
 % 
Àn
]);

387 
	}
}

390 
	$__add_fõld
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, **
p
, *
íd
, 
t
, 
n
)

392 
	`BUG_ON
(
t
 < 0);

393 
	`BUG_ON
(
t
 >
TRANSFER_ENCODING_NUM
);

395 
	`BUG_ON
(!
Êd_d©a
[
t
].
vÆs
);

397 i‡(
n
 < 
gí_ve˘‹
[
t
].
size
) {

398 
r
;

399 
FuzzMsg
 
fmsg
 = 
Êd_d©a
[
t
].
vÆs
[
n
];

401 
	`add_°rög
(
p
, 
íd
, 
fmsg
.
svÆ
);

403 i‡(
Êd_d©a
[
t
].
func
)

404 
r
 = 
Êd_d©a
[
t
].
	`func
(
˘x
, 
ty≥
,Å, 
n
);

406 
r
 = 
fmsg
.
Êags
;

408 i‡(
r
 & 
FUZZ_MSG_F_INVAL
) {

409 
	`TFW_DBG
("generate invalid field %d for header %d\n",

410 
n
, 
t
);

411 
r
 |
FUZZ_INVALID
;

414 
˘x
->
Êd_Êags
[
t
] |
r
;

416  
r
;

418 *
v
 = *
p
;

419 
Àn
 = 
n
 * 256;

420 
r
;

422 i‡(
n
 % 
INVALID_FIELD_PERIOD
 || 
˘x
->
is_⁄ly_vÆid
) {

423 i‡(
gí_ve˘‹
[
t
].
max_vÆ_Àn
)

424 
Àn
 = 
gí_ve˘‹
[
t
].
max_vÆ_Àn
;

425 
	`add_ønd_°rög
(
p
, 
íd
, 
Àn
, 
gí_ve˘‹
[
t
].
a_vÆ
);

426 
r
 = 
FUZZ_VALID
;

428 
	`add_ønd_°rög
(
p
, 
íd
, 
Àn
, 
gí_ve˘‹
[
t
].
a_övÆ
);

429 
r
 = 
FUZZ_INVALID
;

432 i‡(
t
 =
CONTENT_LENGTH
 && 
r
 =
FUZZ_VALID
) {

433 
	`°∫˝y
(
˘x
->
c⁄ã¡_Àngth
, 
v
, 
Àn
);

434 
˘x
->
c⁄ã¡_Àngth
[
Àn
] = '\0';

436 
˘x
->
c⁄ã¡_Àngth
[0] = '\0';

439 i‡(
r
 =
FUZZ_INVALID
)

440 
	`TFW_DBG
("generate invalidÑandom field for header %d\n",

441 
t
);

443  
r
;

445 
	}
}

448 
	$add_fõld
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, **
p
, *
íd
, 
t
)

450  
	`__add_fõld
(
˘x
, 
ty≥
, 
p
, 
íd
, 
t
, ctx->
i
[t]);

451 
	}
}

454 
	$__add_hódî
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, **
p
, *
íd
, 
t
, 
n
)

456 
v
 = 0, 
i
;

458 
	`BUG_ON
(
t
 < 0);

459 
	`BUG_ON
(
t
 >
TRANSFER_ENCODING_NUM
);

461 
	`BUG_ON
(!
Êd_d©a
[
t
].
key
);

463 
	`add_°rög
(
p
, 
íd
, 
Êd_d©a
[
t
].
key
);

464 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, 
p
, 
íd
, 
SPACES
);

465 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, 
p
, 
íd
, 
t
);

466 
i
 = 0; i < 
n
; ++i) {

467 
	`addch
(
p
, 
íd
, ',');

468 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, 
p
, 
íd
, 
SPACES
);

469 
v
 |
	`__add_fõld
(
˘x
, 
ty≥
, 
p
, 
íd
, 
t
, (
i
 * 256) %

470 (
gí_ve˘‹
[
t
].
size
 + gí_ve˘‹[t].
ovî
));

473 
	`add_°rög
(
p
, 
íd
, "\r\n");

475 i‡(
v
 & 
FUZZ_INVALID
)

476 
	`TFW_DBG
("gíî©êövÆid hódî %d\n", 
t
);

478 
˘x
->
hdr_Êags
 |1 << 
t
;

480  
v
;

481 
	}
}

484 
	$__add_hódî_ønd
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
,

485 **
p
, *
íd
, 
t
, 
n
)

487 
ønd
 = 0;

490  (++
ønd
Ë% 2 ? 
	`__add_hódî
(
˘x
, 
ty≥
, 
p
, 
íd
, 
t
, 
n
Ë: 
FUZZ_VALID
;

491 
	}
}

494 
	$add_hódî
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, **
p
, *
íd
, 
t
)

496  
	`__add_hódî
(
˘x
, 
ty≥
, 
p
, 
íd
, 
t
, 0);

497 
	}
}

500 
	$add_body
(
TfwFuzzC⁄ãxt
 *
˘x
, **
p
, *
íd
, 
ty≥
)

502 
size_t
 
Àn
 = 0, 
i
, 
j
;

503 *
Àn_°r
;

504 
îr
, 
ªt
 = 
FUZZ_VALID
;

506 
i
 = 
˘x
->i[
CONTENT_LENGTH
];

507 
Àn_°r
 = (
i
 < 
gí_ve˘‹
[
CONTENT_LENGTH
].
size
)

508 ? (
c⁄ã¡_Àn
[
i
].
Êags
 & 
FUZZ_MSG_F_INVAL
)

511 : 
c⁄ã¡_Àn
[
i
].
svÆ


512 : 
˘x
->
c⁄ã¡_Àngth
;

514 
îr
 = 
	`k°πoul
(
Àn_°r
, 10, &
Àn
);

515 i‡(
îr
) {

516 
	`TFW_ERR
("error %d on getting contentÜength from \"%s\""

517 "(%lu)\n", 
îr
, 
Àn_°r
, 
i
);

518  
FUZZ_INVALID
;

521 i‡(!(
˘x
->
Êd_Êags
[
TRANSFER_ENCODING
] & 
FUZZ_FLD_F_CHUNKED
)) {

522 i‡(!
˘x
->
is_⁄ly_vÆid
 && 
Àn
 && !(
i
 % 
INVALID_BODY_PERIOD
)) {

523 
Àn
 /= 2;

524 
ªt
 = 
FUZZ_INVALID
;

525 
	`TFW_DBG
("1/2 invÆid body %lu\n", 
Àn
);

528 
	`add_ønd_°rög
(
p
, 
íd
, 
Àn
, 
A_BODY
);

531 
chunks
 = 
˘x
->
i
[
BODY_CHUNKS_NUM
] + 1;

532 
size_t
 
chÀn
, 
ªm
, 
°ï
;

534 
	`BUG_ON
(
chunks
 <= 0);

536 i‡(
Àn
 > 0) {

537 
chÀn
 = 
Àn
 / 
chunks
;

538 
ªm
 = 
Àn
 % 
chunks
;

539 
j
 = 0; j < 
chunks
; j++) {

540 
buf
[256];

542 
°ï
 = 
chÀn
;

543 i‡(
ªm
) {

544 
°ï
 +
ªm
;

545 
ªm
 = 0;

548 
	`¢¥ötf
(
buf
, (buf), "%zx", 
°ï
);

550 
	`add_°rög
(
p
, 
íd
, 
buf
);

551 
	`add_°rög
(
p
, 
íd
, "\r\n");

553 i‡(!
˘x
->
is_⁄ly_vÆid
 && 
°ï


554 && !(
i
 % 
INVALID_BODY_PERIOD
))

556 
°ï
 /= 2;

557 
ªt
 = 
FUZZ_INVALID
;

558 
	`TFW_DBG
("1/2 invalid chunked body %lu,"

559 " chunk†%d\n", 
Àn
, 
chunks
);

562 
	`add_ønd_°rög
(
p
, 
íd
, 
°ï
, 
A_BODY
);

563 
	`add_°rög
(
p
, 
íd
, "\r\n");

567 
	`add_°rög
(
p
, 
íd
, "0\r\n\r\n");

570  
ªt
;

571 
	}
}

574 
	$__add_du∂iˇãs
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
,

575 **
p
, *
íd
, 
t
, 
n
)

577 
i
, 
tmp
 = 0;

578 
v
 = 
FUZZ_VALID
;

580 i‡(
˘x
->
cuº_du∂iˇãs
++ % 
DUPLICATES_PERIOD
)

581  
FUZZ_VALID
;

583 i‡(
˘x
->
is_⁄ly_vÆid
 && 
gí_ve˘‹
[
t
].
söguœr
)

584  
FUZZ_VALID
;

586 
i
 = 0; i < 
˘x
->
cuº_du∂iˇãs
 % 
MAX_DUPLICATES
; ++i) {

587 i‡(
gí_ve˘‹
[
t
].
dissù©i⁄
) {

588 
tmp
 = 
˘x
->
i
[
t
];

589 
˘x
->
i
[
t
] = (˘x->i[t] + iË% 
gí_ve˘‹
[t].
size
;

592 
v
 |
	`__add_hódî
(
˘x
, 
ty≥
, 
p
, 
íd
, 
t
, 
n
);

594 i‡(
gí_ve˘‹
[
t
].
dissù©i⁄
)

595 
˘x
->
i
[
t
] = 
tmp
;

598 i‡(
gí_ve˘‹
[
t
].
söguœr
 && 
i
 > 0) {

599 
	`TFW_DBG
("gíî©êdu∂iˇã f‹ söguœ∏hódî %d\n", 
t
);

600  
FUZZ_INVALID
;

603  
v
;

604 
	}
}

607 
	$add_du∂iˇãs
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, **
p
, *
íd
, 
t
)

609  
	`__add_du∂iˇãs
(
˘x
, 
ty≥
, 
p
, 
íd
, 
t
, 0);

610 
	}
}

616 
boﬁ


617 
	$fuzz_hdrs_com∑tibÀ
(
TfwFuzzC⁄ãxt
 *
˘x
, 
ty≥
, 
v
)

630 i‡(
ty≥
 & 
FUZZ_RESP
) {

631 i‡((
˘x
->
Êd_Êags
[
RESP_CODE
]

632 & (
FUZZ_FLD_F_STATUS_100


633 | 
FUZZ_FLD_F_STATUS_204


634 | 
FUZZ_FLD_F_STATUS_304
))

635 && !(
v
 & 
FUZZ_MSG_F_EMPTY_BODY
))

637  
Ál£
;

639 i‡((
˘x
->
Êd_Êags
[
RESP_CODE
]

640 & (
FUZZ_FLD_F_STATUS_100


641 | 
FUZZ_FLD_F_STATUS_204
))

642 && (
˘x
->
hdr_Êags
 & (1 << 
CONTENT_LENGTH
)))

644  
Ál£
;

652 i‡(
˘x
->
hdr_Êags
 & (1 << 
TRANSFER_ENCODING
)) {

653 
ã_Êags
 = 
˘x
->
Êd_Êags
[
TRANSFER_ENCODING
];

654 i‡(
˘x
->
hdr_Êags
 & (1 << 
CONTENT_LENGTH
))

655  
Ál£
;

656 i‡(
ã_Êags
 & 
FUZZ_FLD_F_CHUNKED
) {

657 i‡(!(
ã_Êags
 & 
FUZZ_FLD_F_CHUNKED_LAST
))

658  
Ál£
;

659 } i‡(
ty≥
 =
FUZZ_REQ
) {

660  
Ál£
;

664  
åue
;

665 
	}
}

668 
	$fuzz_öô
(
TfwFuzzC⁄ãxt
 *
˘x
, 
boﬁ
 
is_⁄ly_vÆid
)

671 
	`BUILD_BUG_ON
((
˘x
->
hdr_Êags
Ë> 
N_FIELDS
);

673 
	`mem£t
(
˘x
->
i
, 0, (ctx->i));

674 
˘x
->
is_⁄ly_vÆid
 = is_only_valid;

675 
˘x
->
cuº_du∂iˇãs
 = 0;

676 
	}
}

677 
EXPORT_SYMBOL
(
fuzz_öô
);

688 
	$fuzz_gí
(
TfwFuzzC⁄ãxt
 *
˘x
, *
°r
, *
íd
, 
fõld_t
 
°¨t
,

689 
move
, 
ty≥
)

691 
i
, 
n
, 
ªt
 = 
FUZZ_VALID
;

692 
v
 = 0;

694 
˘x
->
hdr_Êags
 = 0;

695 
	`mem£t
(
˘x
->
Êd_Êags
, 0, (ctx->fld_flags));

697 i‡(
°r
 =
NULL
)

698  -
EINVAL
;

700 i‡(
ty≥
 =
FUZZ_REQ
) {

701 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
METHOD
);

702 
	`addch
(&
°r
, 
íd
, ' ');

704 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
URI_PATH_START
);

705 
	`addch
(&
°r
, 
íd
, '/');

706 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
HOST
);

707 
i
 = 0; i < 
˘x
->i[
URI_PATH_DEPTH
] + 1; ++i) {

708 
	`addch
(&
°r
, 
íd
, '/');

709 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
URI_FILE
);

711 
	`addch
(&
°r
, 
íd
, ' ');

714 
	`add_°rög
(&
°r
, 
íd
, "HTTP/");

715 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
HTTP_VER
);

717 i‡(
ty≥
 =
FUZZ_RESP
) {

718 
	`addch
(&
°r
, 
íd
, ' ');

719 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
SPACES
);

720 
v
 |
	`add_fõld
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
RESP_CODE
);

723 
	`add_°rög
(&
°r
, 
íd
, "\r\n");

725 i‡(
ty≥
 =
FUZZ_REQ
) {

726 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
HOST
);

727 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
HOST
);

729 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT
);

730 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT
);

732 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT_LANGUAGE
);

733 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT_LANGUAGE
);

735 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT_ENCODING
);

736 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT_ENCODING
);

738 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
COOKIE
);

739 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
COOKIE
);

741 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
X_FORWARDED_FOR
);

742 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
X_FORWARDED_FOR
);

744 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
USER_AGENT
);

745 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
USER_AGENT
);

747 i‡(
ty≥
 =
FUZZ_RESP
) {

748 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT_RANGES
);

749 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ACCEPT_RANGES
);

751 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
SET_COOKIE
);

752 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
SET_COOKIE
);

754 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ETAG
);

755 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
ETAG
);

757 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
SERVER
);

758 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
SERVER
);

760 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
EXPIRES
);

761 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
EXPIRES
);

764 
n
 = 
˘x
->
i
[
TRANSFER_ENCODING_NUM
];

765 
v
 |
	`__add_hódî_ønd
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
TRANSFER_ENCODING
, 
n
);

766 
v
 |
	`__add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
TRANSFER_ENCODING
, 
n
);

768 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CONNECTION
);

769 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CONNECTION
);

771 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CONTENT_TYPE
);

772 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CONTENT_TYPE
);

774 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CONTENT_LENGTH
);

775 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CONTENT_LENGTH
);

777 
v
 |
	`add_hódî
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CACHE_CONTROL
);

778 
v
 |
	`add_du∂iˇãs
(
˘x
, 
ty≥
, &
°r
, 
íd
, 
CACHE_CONTROL
);

780 
	`add_°rög
(&
°r
, 
íd
, "\r\n");

786 i‡(!(
v
 & 
FUZZ_MSG_F_EMPTY_BODY
Ë|| (v & 
FUZZ_MSG_F_INVAL
))

787 
v
 |
	`add_body
(
˘x
, &
°r
, 
íd
, 
ty≥
);

789 i‡(
°r
 < 
íd
) {

790 *
°r
 = '\0';

792 
v
 |
FUZZ_INVALID
;

793 *(
íd
 - 1) = '\0';

796 i‡(!(
v
 & 
FUZZ_INVALID
Ë&& !
	`fuzz_hdrs_com∑tibÀ
(
˘x
, 
ty≥
, v))

797 
v
 |
FUZZ_INVALID
;

799 
i
 = 0; i < 
move
; i++) {

800 
ªt
 = 
	`gí_ve˘‹_move
(
˘x
, 
°¨t
);

801 i‡(
ªt
 =
FUZZ_END
)

805 i‡(
v
 & 
FUZZ_INVALID
)

806  
FUZZ_INVALID
;

807  
ªt
;

808 
	}
}

809 
EXPORT_SYMBOL
(
fuzz_gí
);

	@t/fuzzer.h

20 #i‚de‡
__TFW_FUZZER_H__


21 
	#__TFW_FUZZER_H__


	)

23 
	#MAX_CONTENT_LENGTH_LEN
 8

	)

26 
	mFUZZ_VALID
,

27 
	mFUZZ_INVALID
,

28 
	mFUZZ_END


32 
	mFUZZ_REQ
,

33 
	mFUZZ_RESP


37 
	mSPACES
,

38 
	mMETHOD
,

39 
	mHTTP_VER
,

40 
	mRESP_CODE
,

41 
	mURI_PATH_START
,

42 
	mURI_FILE
,

43 
	mCONNECTION
,

44 
	mUSER_AGENT
,

45 
	mHOST
,

46 
	mX_FORWARDED_FOR
,

47 
	mCONTENT_TYPE
,

48 
	mCONTENT_LENGTH
,

49 
	mTRANSFER_ENCODING
,

50 
	mACCEPT
,

51 
	mACCEPT_LANGUAGE
,

52 
	mACCEPT_ENCODING
,

53 
	mACCEPT_RANGES
,

54 
	mCOOKIE
,

55 
	mSET_COOKIE
,

56 
	mETAG
,

57 
	mSERVER
,

58 
	mCACHE_CONTROL
,

59 
	mEXPIRES
,

60 
	mTRANSFER_ENCODING_NUM
,

61 
	mURI_PATH_DEPTH
,

62 
	mBODY_CHUNKS_NUM
,

63 
	mN_FIELDS
,

64 } 
	tfõld_t
;

71 
	mi
[
N_FIELDS
];

72 
boﬁ
 
	mis_⁄ly_vÆid
;

73 
	mc⁄ã¡_Àngth
[
MAX_CONTENT_LENGTH_LEN
 + 1];

74 
	mcuº_du∂iˇãs
;

75 
	mhdr_Êags
;

76 
	mÊd_Êags
[
N_FIELDS
];

77 } 
	tTfwFuzzC⁄ãxt
;

79 
fuzz_öô
(
TfwFuzzC⁄ãxt
 *
c⁄ãxt
, 
boﬁ
 
is_⁄ly_vÆid
);

81 
fuzz_gí
(
TfwFuzzC⁄ãxt
 *
c⁄ãxt
, *
°r
, *
íd
, 
fõld_t
 
°¨t
,

82 
move
, 
ty≥
);

	@t/sync_sockets/client.cc

20 
	~<¨∑/öë.h
>

21 
	~<√töë/ö.h
>

22 
	~<√töë/t˝.h
>

23 
	~<sys/ªsour˚.h
>

24 
	~<sys/sockë.h
>

25 
	~<sys/time.h
>

26 
	~<sys/ty≥s.h
>

27 
	~<uni°d.h
>

29 
	~<io°ªam
>

30 
	~<thªad
>

32 c⁄° 
size_t
 
	gTHR_N
 = 16;

33 c⁄° 
size_t
 
	gCONNECTIONS
 = 64;

34 c⁄° 
size_t
 
	gMESSAGES
 = 4096;

35 
	gmsg
[
MSG_SZ
];

36 
	gPORT
 = 5000;

37 
sockaddr_ö
 
	gßddr
 = {};

40 
	$run_t˝_lﬂd
()

42 
sd
[
CONNECTIONS
] = { 0 };

44 
size_t
 
i
 = 0; i < 
CONNECTIONS
; ++i) {

45 
sd
[
i
] = 
	`sockë
(
PF_INET
, 
SOCK_STREAM
, 0);

46 i‡(
sd
[
i
] < 0) {

47 
sd
[
i
] = 0;

48 
°d
::
˚º
 << "ˇn'à¸óã sockë #" << 
i
 << std::
ídl
;

52 c⁄° 
o
 = 1;

53 i‡(
	`£tsock›t
(
sd
[
i
], 
IPPROTO_TCP
, 
TCP_NODELAY
, &
o
, (o)))

54 
°d
::
˚º
 << "ˇn'à£àTCP_NODELAY o¿sockë #" << 
i


55 << 
°d
::
ídl
;

57 i‡(
	`c⁄√˘
(
sd
[
i
], (
sockaddr
 *)&
ßddr
, (saddr))) {

58 
°d
::
˚º
 << "ˇn'àc⁄√˘ o¿sockë #" << 
i


59 << 
°d
::
ídl
;

60 
	`˛o£
(
sd
[
i
]);

61 
sd
[
i
] = 0;

65 
size_t
 
i
 = 0; i < 
CONNECTIONS
; ++i) {

66 i‡(!
sd
[
i
])

68 
size_t
 
m
 = 0; m < 
MESSAGES
; ++m)

69 i‡(
	`£nd
(
sd
[
i
], 
msg
, (msg), 0) != (msg)) {

70 
°d
::
˚º
 << "can't send on socket #"

71 << 
i
 << 
°d
::
ídl
;

72 
	`˛o£
(
sd
[
i
]);

73 
sd
[
i
] = 0;

77 
size_t
 
i
 = 0; i < 
CONNECTIONS
; ++i)

78 i‡(
sd
[
i
])

79 
	`˛o£
(
sd
[
i
]);

80 
	}
}

83 
	$maö
(
¨gc
, *
¨gv
[])

85 i‡(
¨gc
 < 2) {

86 
°d
::
˚º
 << "PÀa£ s≥cify sîvîáddªss" << std::
ídl
;

90 
æimô
 
æim
;

91 i‡(
	`gëæimô
(
RLIMIT_NOFILE
, &
æim
)) {

92 
°d
::
˚º
 << "gëæimô(ËÁûed" << std::
ídl
;

94 i‡(
æim
.
æim_cur
 < 
THR_N
 * 
CONNECTIONS


95 || 
æim
.
æim_max
 < 
THR_N
 * 
CONNECTIONS
)

97 
°d
::
˚º
 << "pleaseádjustÜimit of open filesÅo "

98 << 
THR_N
 * 
CONNECTIONS
 << 
°d
::
ídl
;

103 
ßddr
.
sö_Ámûy
 = 
AF_INET
;

104 
ßddr
.
sö_p‹t
 = 
	`ht⁄s
(
PORT
);

105 i‡(
	`öë_±⁄
(
AF_INET
, 
¨gv
[1], &
ßddr
.
sö_addr
.
s_addr
) <= 0) {

106 
°d
::
˚º
 << "Badáddªss: " << 
¨gv
[1] << std::
ídl
;

111 
size_t
 
i
 = 0; i < 
MSG_SZ
; ++i)

112 
msg
[
i
] = i;

114 
°d
::
thªad
 
thr
[
THR_N
];

115 
size_t
 
i
 = 0; i < 
THR_N
; ++i)

116 
thr
[
i
] = 
°d
::
thªad
{ 
run_t˝_lﬂd
 };

117 
size_t
 
i
 = 0; i < 
THR_N
; ++i)

118 
thr
[
i
].
	`joö
();

121 
	}
}

	@t/sync_sockets/kernel/kserver.c

22 
	~<löux/dñay.h
>

23 
	~<löux/‰ìzî.h
>

24 
	~<löux/ö.h
>

25 
	~<löux/jiffõs.h
>

26 
	~<löux/kî√l.h
>

27 
	~<löux/kthªad.h
>

28 
	~<löux/moduÀ.h
>

29 
	~<löux/√t.h
>

30 
	~<löux/uac˚ss.h
>

31 
	~<√t/öë_sock.h
>

32 
	~<√t/t˝.h
>

34 
	#MAX_CONN
 (1000 * 1000)

	)

35 
	#PORT
 5000

	)

36 
	#READ_SZ
 (
MSG_SZ
 * ())

	)

39 
w‹k_°ru˘
 
	mw‹k
;

40 
sockë
 *
	msk
;

41 } 
	tSockëW‹k
;

43 
k£rvî_ac˚±_w‹kî
(
w‹k_°ru˘
 *);

44 
k£rvî_ªad_w‹kî
(
w‹k_°ru˘
 *);

46 
sockë
 *
	gli°í_sock
;

47 
w‹kqueue_°ru˘
 *
	gk£rvî_wq
;

48 
kmem_ˇche
 *
	gsw_ˇche
;

51 
	gœ°_ts
 = 0;

52 
	gµs_cuº
 = 0, 
	gµs_max
 = 0;

53 
DEFINE_SPINLOCK
(
°©_lock
);

55 
	g°›
 = 0;

56 
©omic_t
 
	gw‹ks
 = 
ATOMIC_INIT
(0);

57 
	gmsg_buf
[
MSG_SZ
];

58 
	gg_cou¡î
;

60 
©omic_t
 
	gc⁄n_i
 = 
ATOMIC_INIT
(0);

61 
sockë
 *
	gc⁄n
[
MAX_CONN
] = { 
NULL
 };

63 
MODULE_LICENSE
("GPL");

66 
	$°©_upd©e
(
evíts
)

68 
	`•ö_lock
(&
°©_lock
);

69 i‡(
œ°_ts
 =
jiffõs
 / 
HZ
) {

70 
µs_cuº
 +
evíts
;

73 i‡(
µs_cuº
 > 
µs_max
)

74 
µs_max
 = 
µs_cuº
;

75 
µs_cuº
 = 
evíts
;

76 
œ°_ts
 = 
jiffõs
 / 
HZ
;

78 
	`•ö_u∆ock
(&
°©_lock
);

79 
	}
}

82 
	$°©_¥öt
()

84 
	`¥ötk
(
KERN_ERR
 "BestÑps: %lu\n",

85 (
µs_cuº
 > 
µs_max
 ?Öps_cuº :Öps_maxË/ 
READ_SZ
);

86 
	}
}

89 
	$k£rvî_do_sockë_ªad
(
sockë
 *
sock
)

91 
r
, 
cou¡
 = 0;

93 
msghdr
 
msg
 = {

94 .
msg_Êags
 = 
MSG_DONTWAIT
 | 
MSG_NOSIGNAL


96 
kvec
 
iov
 = { 
msg_buf
, 
READ_SZ
 };

98 
r
 = 
	`kî√l_ªcvmsg
(
sock
, &
msg
, &
iov
, 1, 
READ_SZ
,

99 
msg
.
msg_Êags
);

100 i‡(
r
 >= 0) {

102 
i
;

103 
i
 = 0; i < 
r
 / 4; ++i)

104 
g_cou¡î
 +
msg_buf
[
i
];

105 
cou¡
 +
r
;

106 } i‡(
r
 !-
EAGAIN
)

107 
	`¥ötk
(
KERN_ERR
 "îr‹ (%dË⁄ sockë %p\n", 
r
, 
sock
);

108 } 
r
 > 0);

110 
	`°©_upd©e
(
cou¡
);

111 
	}
}

114 
	$k£rvî_ªad_w‹kî
(
w‹k_°ru˘
 *
w‹k
)

116 
SockëW‹k
 *
sw
 = (SockëW‹k *)
w‹k
;

118 
	`BUG_ON
(!
sw
->
sk
);

120 
	`k£rvî_do_sockë_ªad
(
sw
->
sk
);

122 
	`kmem_ˇche_‰ì
(
sw_ˇche
, 
sw
);

123 
	`©omic_dec
(&
w‹ks
);

124 
	}
}

127 
	$k£rvî_ªad_d©a_ªady
(
sock
 *
sk
)

129 
SockëW‹k
 *
sw
;

131 
	`©omic_öc
(&
w‹ks
);

132 i‡(
°›
) {

133 
	`©omic_dec
(&
w‹ks
);

134 
out
;

137 
sw
 = 
	`kmem_ˇche_Æloc
(
sw_ˇche
, 
GFP_ATOMIC
);

138 i‡(!
sw
) {

139 
	`¥ötk
(
KERN_ERR
 "Can'tállocateÑead work\n");

140 
	`©omic_dec
(&
w‹ks
);

141 
out
;

143 
	`INIT_WORK
(&
sw
->
w‹k
, 
k£rvî_ªad_w‹kî
);

144 
sw
->
sk
 = sk->
sk_sockë
;

146 
	`BUG_ON
(!
sk
->
sk_sockë
->
›s
);

148 
	`ªad_lock
(&
sk
->
sk_ˇŒback_lock
);

150 
	`queue_w‹k
(
k£rvî_wq
, &
sw
->
w‹k
);

152 
	`ªad_u∆ock
(&
sk
->
sk_ˇŒback_lock
);

154 
out
:

156 
	}
}

159 
	$k£rvî_°©e_ch™ge
(
sock
 *
sk
)

161 
	`ªad_lock
(&
sk
->
sk_ˇŒback_lock
);

163 
sk
->
sk_°©e
) {

164 
TCP_CLOSE
:

165 
	`°©_upd©e
(
READ_SZ
);

170 
	`ªad_u∆ock
(&
sk
->
sk_ˇŒback_lock
);

171 
	}
}

174 
	$k£rvî_ac˚±
(
sockë
 *
sock
)

176 
sockë
 *
√w_sock
 = 
NULL
;

177 
ci
, 
r
 = 1;

179 i‡(
°›
)

180 
out
;

182 
r
 = 
	`sock_¸óã_lôe
(
sock
->
sk
->
sk_Ámûy
, sock->sk->
sk_ty≥
,

183 
sock
->
sk
->
sk_¥Ÿocﬁ
, &
√w_sock
);

184 i‡(
r
)

185 
out
;

187 
√w_sock
->
ty≥
 = 
sock
->type;

188 
√w_sock
->
›s
 = 
sock
->ops;

189 
r
 = 
sock
->
›s
->
	`ac˚±
(sock, 
√w_sock
, 
O_NONBLOCK
);

190 i‡(
r
 < 0)

191 
îr
;

193 
	`wrôe_lock_bh
(&
√w_sock
->
sk
->
sk_ˇŒback_lock
);

194 
√w_sock
->
sk
->
sk_°©e_ch™ge
 = 
k£rvî_°©e_ch™ge
;

195 
	`wrôe_u∆ock_bh
(&
√w_sock
->
sk
->
sk_ˇŒback_lock
);

198 
ci
 = 
	`©omic_öc_ªtu∫
(&
c⁄n_i
);

199 i‡(
ci
 < 
MAX_CONN
) {

200 
c⁄n
[
ci
] = 
√w_sock
;

202 
	`¥ötk
(
KERN_ERR
 "Too many connections!\n");

206 
	`k£rvî_do_sockë_ªad
(
√w_sock
);

209 
îr
:

210 i‡(
√w_sock
)

211 
	`sock_ªÀa£
(
√w_sock
);

212 
out
:

213  
r
;

214 
	}
}

217 
	$k£rvî_ac˚±_w‹kî
(
w‹k_°ru˘
 *
w‹k
)

219 
SockëW‹k
 *
sw
 = (SockëW‹k *)
w‹k
;

221 
	`BUG_ON
(
sw
->
sk
 !
li°í_sock
);

223 !
	`k£rvî_ac˚±
(
sw
->
sk
)) {

224 
	`°©_upd©e
(
READ_SZ
);

225 
	`c⁄d_ªsched
();

228 
	`kmem_ˇche_‰ì
(
sw_ˇche
, 
sw
);

229 
	`©omic_dec
(&
w‹ks
);

230 
	}
}

233 
	$k£rvî_li°í_d©a_ªady
(
sock
 *
sk
)

235 
SockëW‹k
 *
sw
;

237 
	`©omic_öc
(&
w‹ks
);

239 
sw
 = 
	`kmem_ˇche_Æloc
(
sw_ˇche
, 
GFP_ATOMIC
);

240 i‡(!
sw
) {

241 
	`¥ötk
(
KERN_ERR
 "Can'tállocateáccept work\n");

242 
	`©omic_dec
(&
w‹ks
);

245 
	`INIT_WORK
(&
sw
->
w‹k
, 
k£rvî_ac˚±_w‹kî
);

246 
sw
->
sk
 = 
li°í_sock
;

248 
	`ªad_lock
(&
sk
->
sk_ˇŒback_lock
);

250 i‡(
sk
->
sk_°©e
 =
TCP_LISTEN
) {

251 
	`queue_w‹k
(
k£rvî_wq
, &
sw
->
w‹k
);

253 
	`kmem_ˇche_‰ì
(
sw_ˇche
, 
sw
);

254 
	`©omic_dec
(&
w‹ks
);

257 
	`ªad_u∆ock
(&
sk
->
sk_ˇŒback_lock
);

258 
	}
}

261 
k£rvî_d©a_ªady
(
sock
 *
sk
, 
byãs
 
__©åibuã__
((
unu£d
)))

263 i‡(!
	gsk
->
	gsk_sockë
)

271 i‡(
	gsk
->
	gsk_sockë
 =
li°í_sock
)

272 
k£rvî_li°í_d©a_ªady
(
sk
);

279 
k£rvî_ªad_d©a_ªady
(
sk
);

282 
__öô


283 
	$k£rvî_öô
()

285 
r
 = -
ENOMEM
;

286 
sockaddr_ö
 
ßddr
;

288 
sw_ˇche
 = 
	`kmem_ˇche_¸óã
("k£rvî_w‹k_ˇche", (
SockëW‹k
),

289 0, 0, 
NULL
);

290 i‡(!
sw_ˇche
) {

291 
	`¥ötk
(
KERN_ERR
 "Can't createÑead work cache\n");

292  
r
;

295 
k£rvî_wq
 = 
	`¸óã_sögÀthªad_w‹kqueue
("kserverd");

296 i‡(!
k£rvî_wq
) {

297 
	`¥ötk
(
KERN_ERR
 "Can't create workqueue\n");

298 
îr
;

301 
r
 = 
	`sock_¸óã_kîn
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
, &
li°í_sock
);

302 i‡(
r
) {

303 
	`¥ötk
(
KERN_ERR
 "Can'tÜistening socket\n");

304 
îr_sock
;

307 
	`öë_sk
(
li°í_sock
->
sk
)->
‰ìböd
 = 1;

308 
li°í_sock
->
sk
->
sk_ªu£
 = 1;

310 
	`wrôe_lock_bh
(&
li°í_sock
->
sk
->
sk_ˇŒback_lock
);

311 
li°í_sock
->
sk
->
sk_d©a_ªady
 = 
k£rvî_d©a_ªady
;

312 
	`wrôe_u∆ock_bh
(&
li°í_sock
->
sk
->
sk_ˇŒback_lock
);

314 
	`mem£t
(&
ßddr
, 0, (saddr));

315 
ßddr
.
sö_Ámûy
 = 
AF_INET
;

316 
ßddr
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_ANY
);

317 
ßddr
.
sö_p‹t
 = 
	`ht⁄s
(
PORT
);

319 
r
 = 
li°í_sock
->
›s
->
	`böd
÷i°í_sock, (
sockaddr
 *)&
ßddr
,

320 (
ßddr
));

321 i‡(
r
) {

322 
	`¥ötk
(
KERN_ERR
 "Can't bindÜistening socket\n");

323 
îr_ˇŒ
;

326 
r
 = 
li°í_sock
->
›s
->
	`li°í
(listen_sock, 1000);

327 i‡(
r
) {

328 
	`¥ötk
(
KERN_ERR
 "Can'tÜisten on socket\n");

329 
îr_ˇŒ
;

333 
îr_ˇŒ
:

334 
	`sock_ªÀa£
(
li°í_sock
);

335 
îr_sock
:

336 
	`de°roy_w‹kqueue
(
k£rvî_wq
);

337 
îr
:

338 
	`kmem_ˇche_de°roy
(
sw_ˇche
);

339  
r
;

340 
	}
}

342 
__exô


343 
	$k£rvî_exô
()

345 
ci
;

347 
°›
 = 1;

349 
	`sock_ªÀa£
(
li°í_sock
);

350 
ci
 = 0; cò< 
	`©omic_ªad
(&
c⁄n_i
); ++ci)

351 i‡(
c⁄n
[
ci
])

352 
	`sock_ªÀa£
(
c⁄n
[
ci
]);

354 
	`©omic_ªad
(&
w‹ks
))

355 
	`scheduÀ
();

357 
	`°©_¥öt
();

359 
	`de°roy_w‹kqueue
(
k£rvî_wq
);

360 
	`kmem_ˇche_de°roy
(
sw_ˇche
);

361 
	}
}

363 
moduÀ_öô
(
k£rvî_öô
);

364 
moduÀ_exô
(
k£rvî_exô
);

	@t/sync_sockets/kernel/sync_kclient.c

21 
	~<löux/kî√l.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/kthªad.h
>

24 
	~<löux/time.h
>

25 
	~<löux/waô.h
>

26 
	~<löux/‰ìzî.h
>

27 
	~<√t/öë_sock.h
>

29 
	~"addr.h
"

30 
	~"log.h
"

31 
	~"sync_sockë.h
"

49 #ifde‡
SS_BANNER


50 #unde‡
SS_BANNER


52 
	#SS_BANNER
 "[k˛õ¡] "

	)

54 
	#KCLIENT_NTHREADS
 (16)

	)

55 
	#KCLIENT_NCONNECTS
 (64)

	)

56 
	#KCLIENT_WAIT_INTVL
 (2Ë

	)

57 
	#KCLIENT_WAIT_MAX
 (1 * 60Ë

	)

60 
	#KCLIENT_CONNECT_STARTED
 (0x0001)

	)

61 
	#KCLIENT_CONNECT_ESTABLISHED
 (0x0002)

	)

62 
	#KCLIENT_CONNECT_CLOSED
 (0x0004)

	)

63 
	#KCLIENT_CONNECT_ERROR
 (0x0100)

	)

65 
	sk˛õ¡_desc
 {

66 
SsPrŸo
 
	m¥Ÿo
;

67 
sock
 *
	msk
;

68 
uöt32_t
 
	mÊags
;

69 } 
	tk˛õ¡_desc_t
;

77 
k˛õ¡_desc_t
 
	gk˛õ¡_desc
[
KCLIENT_NTHREADS
][
KCLIENT_NCONNECTS
];

78 
èsk_°ru˘
 *
	gk˛õ¡_c⁄√˘_èsk
[
KCLIENT_NTHREADS
];

79 
DECLARE_WAIT_QUEUE_HEAD
(
k˛õ¡_c⁄√˘_wq
);

80 
©omic_t
 
	gk˛õ¡_¡hªads
;

82 
èsk_°ru˘
 *
	gk˛õ¡_föish_èsk
;

83 
DECLARE_WAIT_QUEUE_HEAD
(
k˛õ¡_föish_wq
);

85 
©omic_t
 
	gk˛õ¡_c⁄√˘_«âem±
;

86 
©omic_t
 
	gk˛õ¡_c⁄√˘_ncom∂ëe
;

87 
©omic_t
 
	gk˛õ¡_c⁄√˘_n˛o£
;

88 
©omic_t
 
	gk˛õ¡_c⁄√˘_√º‹
;

90 *
	g£rvî
 = "127.0.0.1:5000";

91 
TfwAddr
 
	gk˛õ¡_£rvî_addªss
;

92 
SsHooks
 
	gk˛õ¡_hooks
;

94 
moduÀ_∑øm
(
£rvî
, 
ch¨p
, 0);

95 
MODULE_PARM_DESC
(
£rvî
, "Server hostáddressánd optionalÖortÇunber");

96 
MODULE_LICENSE
("GPL");

99 
	$k˛õ¡_c⁄√˘
(
descidx
)

101 
ªt
;

102 
sock
 *
sk
;

103 
k˛õ¡_desc_t
 *
desc
 = *(
k˛õ¡_desc
 + 
descidx
 / 
KCLIENT_NCONNECTS
)

104 + 
descidx
 % 
KCLIENT_NCONNECTS
;

106 
ªt
 = 
	`ss_sock_¸óã
(
k˛õ¡_£rvî_addªss
.
ß
.
ß_Ámûy
,

107 
SOCK_STREAM
, 
IPPROTO_TCP
, &
sk
);

108 i‡(
ªt
) {

109 
	`SS_DBG
("U«bÀÅÿ¸óã kî√»sockë (%d)\n", 
ªt
);

110 
desc
->
Êags
 |
KCLIENT_CONNECT_ERROR
;

111 
	`©omic_öc
(&
k˛õ¡_c⁄√˘_√º‹
);

112  
ªt
;

114 
	`ss_¥Ÿo_öô
(&
desc
->
¥Ÿo
, &
k˛õ¡_hooks
, 
descidx
);

115 
sk
->
sk_u£r_d©a
 = &
desc
->
¥Ÿo
;

116 
	`ss_£t_ˇŒbacks
(
sk
);

117 
ªt
 = 
	`ss_c⁄√˘
(
sk
, &
k˛õ¡_£rvî_addªss
.
ß
,

118 
	`tfw_addr_ß_Àn
(&
k˛õ¡_£rvî_addªss
), 0);

119 i‡(
ªt
) {

120 
	`SS_DBG
("C⁄√˘Éº‹ o¿£rvî sockë sk %∞(%d)\n", 
sk
, 
ªt
);

121 
	`ss_ªÀa£
(
sk
);

122 
desc
->
Êags
 |
KCLIENT_CONNECT_ERROR
;

123 
	`©omic_öc
(&
k˛õ¡_c⁄√˘_√º‹
);

124  
ªt
;

126 
desc
->
sk
 = sk;

127 
desc
->
Êags
 |
KCLIENT_CONNECT_STARTED
;

128 
	`©omic_öc
(&
k˛õ¡_c⁄√˘_«âem±
);

130 
	}
}

133 
	$k˛õ¡_c⁄√˘_com∂ëe
(
sock
 *
sk
)

135 
descidx
;

136 
k˛õ¡_desc_t
 *
desc
;

137 
SsPrŸo
 *
¥Ÿo
 = 
sk
->
sk_u£r_d©a
;

139 
	`BUG_ON
(
¥Ÿo
 =
NULL
);

141 
descidx
 = 
¥Ÿo
->
ty≥
;

142 
desc
 = *(
k˛õ¡_desc
 + 
descidx
 / 
KCLIENT_NCONNECTS
)

143 + 
descidx
 % 
KCLIENT_NCONNECTS
;

144 
	`BUG_ON
(
desc
->
¥Ÿo
.
ty≥
 !
descidx
);

145 
	`BUG_ON
(
desc
->
¥Ÿo
.
li°íî
 !
NULL
);

146 
	`BUG_ON
(
desc
->
¥Ÿo
.
hooks
 !&
k˛õ¡_hooks
);

147 
	`BUG_ON
(
desc
->
sk
 && (desc->sk != sk));

149 
desc
->
Êags
 |
KCLIENT_CONNECT_ESTABLISHED
;

150 
	`©omic_öc
(&
k˛õ¡_c⁄√˘_ncom∂ëe
);

151 
	`wake_up
(&
k˛õ¡_föish_wq
);

153 
	}
}

156 
	$k˛õ¡_c⁄√˘i⁄_˛o£
(
sock
 *
sk
)

158 
descidx
;

159 
k˛õ¡_desc_t
 *
desc
;

160 
SsPrŸo
 *
¥Ÿo
 = 
sk
->
sk_u£r_d©a
;

162 
	`BUG_ON
(
¥Ÿo
 =
NULL
);

164 
descidx
 = 
¥Ÿo
->
ty≥
;

165 
desc
 = *(
k˛õ¡_desc
 + 
descidx
 / 
KCLIENT_NCONNECTS
)

166 + 
descidx
 % 
KCLIENT_NCONNECTS
;

167 
	`BUG_ON
(
desc
->
¥Ÿo
.
ty≥
 !
descidx
);

168 
	`BUG_ON
(
desc
->
¥Ÿo
.
li°íî
 !
NULL
);

169 
	`BUG_ON
(
desc
->
¥Ÿo
.
hooks
 !&
k˛õ¡_hooks
);

170 
	`BUG_ON
(
desc
->
sk
 && (desc->sk != sk));

172 
desc
->
sk
 = 
NULL
;

173 
desc
->
Êags
 |
KCLIENT_CONNECT_CLOSED
;

174 
	`©omic_öc
(&
k˛õ¡_c⁄√˘_n˛o£
);

175 
	`wake_up
(&
k˛õ¡_föish_wq
);

177 
	}
}

180 
	$k˛õ¡_c⁄√˘i⁄_îr‹
(
sock
 *
sk
)

182 
descidx
;

183 
k˛õ¡_desc_t
 *
desc
;

184 
SsPrŸo
 *
¥Ÿo
 = 
sk
->
sk_u£r_d©a
;

186 
	`BUG_ON
(
¥Ÿo
 =
NULL
);

188 
descidx
 = 
¥Ÿo
->
ty≥
;

189 
desc
 = *(
k˛õ¡_desc
 + 
descidx
 / 
KCLIENT_NCONNECTS
)

190 + 
descidx
 % 
KCLIENT_NCONNECTS
;

191 
	`BUG_ON
(
desc
->
¥Ÿo
.
ty≥
 !
descidx
);

192 
	`BUG_ON
(
desc
->
¥Ÿo
.
li°íî
 !
NULL
);

193 
	`BUG_ON
(
desc
->
¥Ÿo
.
hooks
 !&
k˛õ¡_hooks
);

194 
	`BUG_ON
(
desc
->
sk
 && (desc->sk != sk));

196 
desc
->
sk
 = 
NULL
;

197 
desc
->
Êags
 |
KCLIENT_CONNECT_ERROR
;

198 
	`©omic_öc
(&
k˛õ¡_c⁄√˘_√º‹
);

199 
	`wake_up
(&
k˛õ¡_föish_wq
);

201 
	}
}

203 
SsHooks
 
	gk˛õ¡_hooks
 = {

204 .
c⁄√˘i⁄_√w
 = 
k˛õ¡_c⁄√˘_com∂ëe
,

205 .
	gc⁄√˘i⁄_dr›
 = 
k˛õ¡_c⁄√˘i⁄_˛o£
,

206 .
	gc⁄√˘i⁄_îr‹
 = 
k˛õ¡_c⁄√˘i⁄_îr‹
,

210 
	$k˛õ¡_ªp‹t
()

212 
	`SS_ERR
("Initiated %d connects\n",

213 
KCLIENT_NTHREADS
 * 
KCLIENT_NCONNECTS
);

214 
	`SS_ERR
("OfÅhose %d connects initiated successfully\n",

215 
	`©omic_ªad
(&
k˛õ¡_c⁄√˘_«âem±
));

216 
	`SS_ERR
("OfÅhose %d connections wereÉstablished successfully\n",

217 
	`©omic_ªad
(&
k˛õ¡_c⁄√˘_ncom∂ëe
));

218 
	`SS_ERR
("and %d connections completed withÉrror\n",

219 
	`©omic_ªad
(&
k˛õ¡_c⁄√˘_√º‹
));

220 
	}
}

223 
	$k˛õ¡_ªÀa£_sockës
()

225 
i
, 
k
;

227 
i
 = 0; i < 
KCLIENT_NTHREADS
; i++) {

228 
k
 = 0; k < 
KCLIENT_NCONNECTS
; k++) {

229 i‡(
k˛õ¡_desc
[
i
][
k
].
sk
) {

230 
	`ss_ªÀa£
(
k˛õ¡_desc
[
i
][
k
].
sk
);

231 
k˛õ¡_desc
[
i
][
k
].
sk
 = 
NULL
;

235 
	}
}

238 
	$k˛õ¡_thªad_föish
(*
d©a
)

240 
«âem±
 = 
	`©omic_ªad
(&
k˛õ¡_c⁄√˘_«âem±
);

241 
uöt64_t
 
time_max
 = (uöt64_t)
	`gë_£c⁄ds
(Ë+ 
KCLIENT_WAIT_MAX
;

243 
	`£t_‰ìzabÀ
();

245 
timeout
 = 
KCLIENT_WAIT_INTVL
;

246 
√º‹
 = 
	`©omic_ªad
(&
k˛õ¡_c⁄√˘_√º‹
);

247 
ncom∂ëe
 = 
	`©omic_ªad
(&
k˛õ¡_c⁄√˘_ncom∂ëe
);

249 i‡(
ncom∂ëe
 + 
√º‹
 =
«âem±
) {

252 
	`waô_evít_‰ìzabÀ_timeout
(
k˛õ¡_föish_wq
,

253 
	`kthªad_should_°›
(),

254 
timeout
);

255 i‡((
uöt64_t
)
	`gë_£c⁄ds
(Ë> 
time_max
) {

256 
	`SS_ERR
("%sÉxceeded maximum waitÅime of %d seconds\n",

257 "k˛õ¡_thªad_föish", 
KCLIENT_WAIT_MAX
);

260 } !
	`kthªad_should_°›
());

262 
	`k˛õ¡_ªÀa£_sockës
();

263 
k˛õ¡_föish_èsk
 = 
NULL
;

265 
	}
}

268 
	$k˛õ¡_thªad_c⁄√˘
(*
d©a
)

270 
i
, 
nc⁄√˘s
 = 0;

271 
thªadn
 = ()()
d©a
;

272 
descidx
 = 
thªadn
 * 
KCLIENT_NCONNECTS
;

274 
	`SS_DBG
("c⁄√˘_thªad_%02d sèπed\n", 
thªadn
);

275 
i
 = 0; i < 
KCLIENT_NCONNECTS
; i++) {

276 i‡(
	`k˛õ¡_c⁄√˘
(
descidx
 + 
i
) == 0) {

277 
nc⁄√˘s
++;

280 
k˛õ¡_c⁄√˘_èsk
[
thªadn
] = 
NULL
;

281 
	`©omic_dec
(&
k˛õ¡_¡hªads
);

282 
	`wake_up
(&
k˛õ¡_c⁄√˘_wq
);

283 
	`SS_DBG
("Thread %d has initiated %d connects out of %d\n",

284 
thªadn
, 
nc⁄√˘s
, 
KCLIENT_NCONNECTS
);

286 
	}
}

289 
	$k˛õ¡_°›_thªads
()

291 
i
;

293 
i
 = 0; i < 
KCLIENT_NTHREADS
; i++) {

294 i‡(
k˛õ¡_c⁄√˘_èsk
[
i
]) {

295 
	`kthªad_°›
(
k˛õ¡_c⁄√˘_èsk
[
i
]);

296 
k˛õ¡_c⁄√˘_èsk
[
i
] = 
NULL
;

299 i‡(
k˛õ¡_föish_èsk
) {

300 
	`kthªad_°›
(
k˛õ¡_föish_èsk
);

301 
k˛õ¡_föish_èsk
 = 
NULL
;

303 
	`k˛õ¡_ªÀa£_sockës
();

304 
	}
}

306 
__öô


307 
	$k˛õ¡_öô
()

309 
i
, 
ªt
 = 0;

310 
èsk_°ru˘
 *
èsk
;

312 i‡(
	`tfw_addr_±⁄
(
£rvî
, &
k˛õ¡_£rvî_addªss
)) {

313 
	`SS_ERR
("U«bÀÅÿ∑r£ sîvî'†addªss: %s", 
£rvî
);

314  -
EINVAL
;

316 
	`SS_ERR
("Sèπed k˛õ¡ moduÀ, sîvî'†addªs†i†%s\n", 
£rvî
);

318 
èsk
 = 
	`kthªad_¸óã
(
k˛õ¡_thªad_föish
, 0,

320 i‡(
	`IS_ERR_OR_NULL
(
èsk
)) {

321 
ªt
 = 
	`PTR_ERR
(
èsk
);

322 
	`SS_ERR
("UnableÅo createÅhread: %s (%d)\n",

323 "k˛õ¡_föish_èsk", 
ªt
);

324  
ªt
;

326 
k˛õ¡_föish_èsk
 = 
èsk
;

328 
i
 = 0; i < 
KCLIENT_NTHREADS
; i++) {

329 
èsk
 = 
	`kthªad_¸óã
(
k˛õ¡_thªad_c⁄√˘
, (*)()
i
,

330 "k˛õ¡_thªad_c⁄√˘_%02d", 
i
);

331 i‡(
	`IS_ERR_OR_NULL
(
èsk
)) {

332 
ªt
 = 
	`PTR_ERR
(
èsk
);

333 
	`SS_ERR
("UnableÅo createáÅhread: %s%02d (%d)\n",

334 "k˛õ¡_thªad_c⁄√˘", 
i
, 
ªt
);

337 
k˛õ¡_c⁄√˘_èsk
[
i
] = 
èsk
;

339 i‡(
ªt
) {

340 
	`k˛õ¡_°›_thªads
();

342 
	`©omic_£t
(&
k˛õ¡_¡hªads
, 
KCLIENT_NTHREADS
);

343 
i
 = 0; i < 
KCLIENT_NTHREADS
; i++) {

344 
	`wake_up_¥o˚ss
(
k˛õ¡_c⁄√˘_èsk
[
i
]);

346 
	`SS_ERR
("Started %dÅhreadsÅo initiate %d connectsÉach\n",

347 
KCLIENT_NTHREADS
, 
KCLIENT_NCONNECTS
);

348 
	`waô_evít_öãºu±ibÀ
(
k˛õ¡_c⁄√˘_wq
,

349 
	`©omic_ªad
(&
k˛õ¡_¡hªads
) == 0);

350 
	`wake_up_¥o˚ss
(
k˛õ¡_föish_èsk
);

352  
ªt
;

353 
	}
}

356 
	$k˛õ¡_exô
()

358 
	`k˛õ¡_°›_thªads
();

359 
	`k˛õ¡_ªp‹t
();

360 
	}
}

362 
moduÀ_öô
(
k˛õ¡_öô
);

363 
moduÀ_exô
(
k˛õ¡_exô
);

	@t/sync_sockets/kernel/sync_kserver.c

25 
	~<löux/ö.h
>

26 
	~<löux/jiffõs.h
>

27 
	~<löux/kî√l.h
>

28 
	~<löux/moduÀ.h
>

29 
	~<√t/öë_sock.h
>

31 
	~"sync_sockë.h
"

33 
	#MAX_CONN
 (1000 * 1000)

	)

34 
	#PORT
 5000

	)

35 
	#READ_SZ
 (
MSG_SZ
 * ())

	)

39 
SsPrŸo
 
	m¥Ÿo
;

40 } 
	tMyPrŸo
;

42 
MyPrŸo
 
	gmy_¥Ÿo
;

45 
	gœ°_ts
 = 0;

46 
	gµs_cuº
 = 0, 
	gµs_max
 = 0;

48 
	gg_cou¡î
;

50 
©omic_t
 
	gc⁄n_i
 = 
ATOMIC_INIT
(0);

51 
sock
 *
	gc⁄n
[
MAX_CONN
] = { 
NULL
 };

53 
MODULE_LICENSE
("GPL");

56 
	$°©_upd©e
(
evíts
)

59 i‡(
œ°_ts
 =
jiffõs
 / 
HZ
) {

60 
µs_cuº
 +
evíts
;

63 i‡(
µs_cuº
 > 
µs_max
)

64 
µs_max
 = 
µs_cuº
;

65 
µs_cuº
 = 
evíts
;

66 
œ°_ts
 = 
jiffõs
 / 
HZ
;

68 
	}
}

71 
	$°©_¥öt
()

73 
	`¥ötk
(
KERN_ERR
 "BestÑps: %lu\n",

74 (
µs_cuº
 > 
µs_max
 ?Öps_cuº :Öps_maxË/ 
READ_SZ
);

75 
	}
}

81 
	$k£rvî_ªad
(
sock
 *
sk
, *
d©a
, 
size_t
 
Àn
)

83 
i
;

84 
i
 = 0; i < 
Àn
 / 4; ++i)

85 
g_cou¡î
 +
d©a
[
i
];

87 
	`°©_upd©e
(
Àn
);

90 
	}
}

93 
	$k£rvî_c⁄√˘i⁄_√w
(
sock
 *
sk
)

95 
ci
;

97 
	`BUG_ON
(!
sk
->
sk_u£r_d©a
);

102 
ci
 = 
	`©omic_öc_ªtu∫
(&
c⁄n_i
);

103 i‡(
ci
 < 
MAX_CONN
) {

104 
c⁄n
[
ci
] = 
sk
;

106 
	`¥ötk
(
KERN_ERR
 "Too many connections!\n");

109 
	`°©_upd©e
(
READ_SZ
);

112 
	}
}

115 
	$k£rvî_c⁄√˘i⁄_dr›
(
sock
 *
sk
)

117 
	`°©_upd©e
(
READ_SZ
);

120 
	}
}

122 
SsHooks
 
	gssockë_hooks
 = {

123 .
c⁄√˘i⁄_√w
 = 
k£rvî_c⁄√˘i⁄_√w
,

124 .
	gc⁄√˘i⁄_dr›
 = 
k£rvî_c⁄√˘i⁄_dr›
,

125 .
	gc⁄√˘i⁄_ªcv
 = 
k£rvî_ªad
,

128 
__öô


129 
	$k£rvî_öô
()

131 
r
;

132 
sock
 *
lsk
;

133 
sockaddr_ö
 
ßddr
;

135 
r
 = 
	`ss_sock_¸óã
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
, &
lsk
);

136 i‡(
r
) {

137 
	`¥ötk
(
KERN_ERR
 "Can'tÜistening socket\n");

138 
îr_¸óã
;

141 
	`öë_sk
(
lsk
)->
‰ìböd
 = 1;

142 
lsk
->
sk_ªu£
 = 1;

145 
	`ss_¥Ÿo_öô
((
SsPrŸo
 *)&
my_¥Ÿo
, &
ssockë_hooks
, 0);

146 
lsk
->
sk_u£r_d©a
 = (
SsPrŸo
 *)&
my_¥Ÿo
;

147 
	`ss_£t_li°í
(
lsk
);

149 
	`mem£t
(&
ßddr
, 0, (saddr));

150 
ßddr
.
sö_Ámûy
 = 
AF_INET
;

151 
ßddr
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_ANY
);

152 
ßddr
.
sö_p‹t
 = 
	`ht⁄s
(
PORT
);

154 
r
 = 
	`ss_böd
(
lsk
, (
sockaddr
 *)&
ßddr
, (saddr));

155 i‡(
r
) {

156 
	`¥ötk
(
KERN_ERR
 "Can't bindÜistening socket\n");

157 
îr_ˇŒ
;

160 
r
 = 
	`ss_li°í
(
lsk
, 1000);

161 i‡(
r
) {

162 
	`¥ötk
(
KERN_ERR
 "Can'tÜisten on socket\n");

163 
îr_ˇŒ
;

167 
îr_ˇŒ
:

168 
	`ss_ªÀa£
(
lsk
);

169 
îr_¸óã
:

170  
r
;

171 
	}
}

173 
__exô


174 
	$k£rvî_exô
()

176 
ci
;

178 
	`ss_ªÀa£
(
my_¥Ÿo
.
¥Ÿo
.
li°íî
);

180 
ci
 = 0; cò< 
	`©omic_ªad
(&
c⁄n_i
); ++ci)

181 i‡(
c⁄n
[
ci
])

182 
	`ss_˛o£_sync
(
c⁄n
[
ci
], 
åue
);

190 
	`°©_¥öt
();

191 
	}
}

193 
moduÀ_öô
(
k£rvî_öô
);

194 
moduÀ_exô
(
k£rvî_exô
);

	@t/sync_sockets/server.cc

21 
	~<as£π.h
>

22 
	~<¨∑/öë.h
>

23 
	~<f˙é.h
>

24 
	~<√töë/ö.h
>

25 
	~<√töë/t˝.h
>

26 
	~<sig«l.h
>

27 
	~<°dlib.h
>

28 
	~<sys/ïﬁl.h
>

29 
	~<sys/ªsour˚.h
>

30 
	~<sys/sockë.h
>

31 
	~<sys/time.h
>

32 
	~<sys/ty≥s.h
>

33 
	~<time.h
>

34 
	~<uni°d.h
>

36 
	~<io°ªam
>

38 c⁄° 
size_t
 
	gMAX_CONNECTIONS
 = 1000 * 1000;

39 c⁄° 
	gREAD_SZ
 = 
MSG_SZ
 * ();

44 ˛as†
	cReque°sSèti°ics
 {

45 
	mpublic
:

46 
	$Reque°sSèti°ics
()

47 : 
	`œ°_ts_
(
	`time
(
NULL
)),

48 
	`cuº_
(0),

49 
	$max_
(0)

53 
	$upd©e
(
evíts
)

55 
time_t
 
t
 = 
	`time
(
NULL
);

56 i‡(
œ°_ts_
 =
t
) {

57 
cuº_
 +
evíts
;

60 i‡(
cuº_
 > 
max_
)

61 
max_
 = 
cuº_
;

62 
cuº_
 = 
evíts
;

63 
œ°_ts_
 = 
t
;

65 
	}
}

68 
	$¥öt
()

70 
°d
::
cout
 << "Be°Ñps: " << (°d::
	`max
(
max_
, 
cuº_
Ë/ 
READ_SZ
)

71 << 
°d
::
ídl
;

72 
	}
}

74 
	g¥iv©e
:

75 
time_t
 
œ°_ts_
;

76 
	gcuº_
;

77 
	gmax_
;

80 
	gPORT
 = 5000;

81 
	gmsg
[
MSG_SZ
];

82 
	gg_cou¡î
 = 0;

83 
Reque°sSèti°ics
 
	g°©
;

86 
	$sig_h™dÀr
(
sig_num
)

88 
°d
::
cout
 << "ª˚ived sig«»" << 
sig_num
 << std::
ídl
;

89 
	`exô
(0);

90 
	}
}

93 
	$£t_sig_h™dÀrs
()

95 
siga˘i⁄
 
ß
;

97 
	`sigem±y£t
 (&
ß
.
ß_mask
);

98 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGHUP
);

99 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGINT
);

100 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGQUIT
);

101 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGPIPE
);

102 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGTERM
);

103 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGUSR1
);

104 
	`sigadd£t
(&
ß
.
ß_mask
, 
SIGUSR2
);

106 
ß
.
ß_h™dÀr
 = 
sig_h™dÀr
;

107 
ß
.
ß_Êags
 = 
SA_RESTART
;

109 
	`siga˘i⁄
(
SIGHUP
, &
ß
, 
NULL
);

110 
	`siga˘i⁄
(
SIGINT
, &
ß
, 
NULL
);

111 
	`siga˘i⁄
(
SIGQUIT
, &
ß
, 
NULL
);

112 
	`siga˘i⁄
(
SIGPIPE
, &
ß
, 
NULL
);

113 
	`siga˘i⁄
(
SIGTERM
, &
ß
, 
NULL
);

114 
	`siga˘i⁄
(
SIGUSR1
, &
ß
, 
NULL
);

115 
	`siga˘i⁄
(
SIGUSR2
, &
ß
, 
NULL
);

116 
	}
}

119 
	$¥öt_°©i°ics
()

121 
°©
.
	`¥öt
();

122 
	}
}

125 
	$sd_add_to_ïﬁl
(
efd
, 
sd
)

127 
ïﬁl_evít
 
ev
 = {};

128 
ev
.
evíts
 = 
EPOLLIN
;

129 
ev
.
d©a
.
fd
 = 
sd
;

130 i‡(
	`ïﬁl_˘l
(
efd
, 
EPOLL_CTL_ADD
, 
sd
, &
ev
) < 0) {

131 
°d
::
˚º
 << "ˇn'àadd sockë " << 
sd
 << "ÅoÉpoll"

132 << 
°d
::
ídl
;

136 
	}
}

139 
	$£t_n⁄block
(
sd
, c⁄° *
desc
)

141 
Êags
 = 
	`f˙é
(
sd
, 
F_GETFL
, 0);

142 i‡(!(
Êags
 & 
O_NONBLOCK
))

143 if(
	`f˙é
(
sd
, 
F_SETFL
, 
Êags
 | 
O_NONBLOCK
) < 0) {

144 
°d
::
˚º
 << "ˇn'àmakê" << 
desc


145 << " sockëÇ⁄blockög" << 
°d
::
ídl
;

146 
	`exô
(1);

148 
	}
}

151 
	$w‹k_lo›
(
li°í_sd
, 
wd
)

153 
ïﬁl_evít
 
ev
[64];

154 
n
 = 
	`ïﬁl_waô
(
wd
, 
ev
, 64, -1);

155 i‡(
n
 < 1) {

156 
°d
::
˚º
 << "ïﬁ»waô faûed" << std::
ídl
;

157 
	`exô
(1);

160 
i
 = 0; i < 
n
; ++i) {

161 i‡(
ev
[
i
].
d©a
.
fd
 =
li°í_sd
) {

164 
sd
 = 
	`ac˚±
(
li°í_sd
, 
NULL
, NULL);

165 i‡(
sd
 < 1) {

166 i‡(
î∫o
 =
EAGAIN
)

168 
°d
::
˚º
 << "can'tácceptá socket"

169 << 
°d
::
ídl
;

170 
	`exô
(1);

173 
	`£t_n⁄block
(
sd
, "work");

175 i‡(
	`sd_add_to_ïﬁl
(
wd
, 
sd
))

176 
	`exô
(1);

178 
°©
.
	`upd©e
(
READ_SZ
);

183 
	`as£π
(
ev
[
i
].
evíts
 & 
EPOLLIN
);

185 
cou¡
 = 0, 
r
;

187 
r
 = 
	`ªcv
(
ev
[
i
].
d©a
.
fd
, 
msg
, 
READ_SZ
, 0);

188 i‡(!
r
) {

189 
	`ïﬁl_˘l
(
wd
, 
EPOLL_CTL_DEL
,

190 
ev
[
i
].
d©a
.
fd
, 
NULL
);

191 
	`˛o£
(
ev
[
i
].
d©a
.
fd
);

192 
cou¡
 = 
READ_SZ
;

194 i‡(
r
 < 0 && 
î∫o
 !
EAGAIN
) {

195 
°d
::
˚º
 << "failedÅoÑead on"

196 << " sockë " << 
ev
[
i
].
d©a
.
fd


197 << " (ªt=" << 
r
 << ")"

198 << 
°d
::
ídl
;

199 
	`exô
(1);

203 i‡(
r
 > 0) {

204 
j
 = 0; j < 
r
 / 4; ++j)

205 
g_cou¡î
 +
msg
[
j
];

206 
cou¡
 +
r
;

208 } 
r
 > 0);

210 
°©
.
	`upd©e
(
cou¡
);

213 
	}
}

216 
	$maö
(
¨gc
, *
¨gv
[])

218 
æimô
 
æim
;

219 i‡(
	`gëæimô
(
RLIMIT_NOFILE
, &
æim
)) {

220 
°d
::
˚º
 << "gëæimô(ËÁûed" << std::
ídl
;

222 i‡(
æim
.
æim_cur
 < 
MAX_CONNECTIONS


223 || 
æim
.
æim_max
 < 
MAX_CONNECTIONS
)

225 
°d
::
˚º
 << "pleaseádjustÜimit of open filesÅo "

226 << 
MAX_CONNECTIONS
 << 
°d
::
ídl
;

227 
	`exô
(1);

231 
	`£t_sig_h™dÀrs
();

232 
	`©exô
(
¥öt_°©i°ics
);

234 
li°í_sd
 = 
	`sockë
(
PF_INET
, 
SOCK_STREAM
, 0);

235 i‡(
li°í_sd
 < 0) {

236 
°d
::
˚º
 << "ˇn'à¸óãÜi°íög sockë" << std::
ídl
;

237 
	`exô
(1);

240 c⁄° 
⁄
 = 1;

241 i‡(
	`£tsock›t
(
li°í_sd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
⁄
,

242 (
⁄
)) < 0)

244 
°d
::
˚º
 << "can't setÑeuseaddr forÜistenong socket"

245 << 
°d
::
ídl
;

246 
	`exô
(1);

249 
sockaddr_ö
 
ßddr
 = {};

250 
ßddr
.
sö_Ámûy
 = 
AF_INET
;

251 
ßddr
.
sö_addr
.
s_addr
 = 
INADDR_ANY
;

252 
ßddr
.
sö_p‹t
 = 
	`ht⁄s
(
PORT
);

253 i‡(
	`böd
(
li°í_sd
, (c⁄° 
sockaddr
 *)&
ßddr
, (saddr))) {

254 
°d
::
˚º
 << "ˇn'àbödÜi°íög sockë " << std::
ídl
;

255 
	`exô
(1);

262 i‡(
	`li°í
(
li°í_sd
, 1000)) {

263 
°d
::
˚º
 << "ˇn'àli°í o¿sockë" << std::
ídl
;

264 
	`exô
(1);

267 
	`£t_n⁄block
(
li°í_sd
, "listen");

269 
wd
 = 
	`ïﬁl_¸óã
(1000);

270 i‡(
wd
 < 0) {

271 
°d
::
˚º
 << "ˇn'à¸óãÉpﬁl" << std::
ídl
;

272 
	`exô
(1);

275 i‡(
	`sd_add_to_ïﬁl
(
wd
, 
li°í_sd
))

276 
	`exô
(1);

279 
	`w‹k_lo›
(
li°í_sd
, 
wd
);

282 
	}
}

	@t/unit/helpers.c

34 
	~"hâp_msg.h
"

36 
TfwC⁄n
 
	gc⁄n_ªq
, 
	gc⁄n_ª•
;

38 
TfwHâpReq
 *

39 
	$ã°_ªq_Æloc
(
size_t
 
d©a_Àn
)

41 
ªt
;

42 
TfwMsgIãr
 
ô
;

43 
TfwHâpMsg
 *
hmªq
;

49 
hmªq
 = 
	`__tfw_hâp_msg_Æloc
(
C⁄n_HâpC t
, 
åue
);

50 
	`BUG_ON
(!
hmªq
);

52 
ªt
 = 
	`tfw_hâp_msg_£tup
(
hmªq
, &
ô
, 
d©a_Àn
);

53 
	`BUG_ON
(
ªt
);

55 
	`mem£t
(&
c⁄n_ªq
, 0, (
TfwC⁄n
));

56 
	`tfw_c⁄√˘i⁄_öô
(&
c⁄n_ªq
);

57 
c⁄n_ªq
.
¥Ÿo
.
ty≥
 = 
C⁄n_HâpC t
;

58 
hmªq
->
c⁄n
 = &
c⁄n_ªq
;

60  (
TfwHâpReq
 *)
hmªq
;

61 
	}
}

64 
	$ã°_ªq_‰ì
(
TfwHâpReq
 *
ªq
)

68 
	`BUG_ON
(!
ªq
);

70 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ªq
);

71 
	}
}

73 
TfwHâpRe•
 *

74 
	$ã°_ª•_Æloc
(
size_t
 
d©a_Àn
)

76 
ªt
;

77 
TfwMsgIãr
 
ô
;

78 
TfwHâpMsg
 *
hmª•
;

80 
hmª•
 = 
	`__tfw_hâp_msg_Æloc
(
C⁄n_HâpSrv
, 
åue
);

81 
	`BUG_ON
(!
hmª•
);

83 
ªt
 = 
	`tfw_hâp_msg_£tup
(
hmª•
, &
ô
, 
d©a_Àn
);

84 
	`BUG_ON
(
ªt
);

86 
	`mem£t
(&
c⁄n_ª•
, 0, (
TfwC⁄n
));

87 
	`tfw_c⁄√˘i⁄_öô
(&
c⁄n_ªq
);

88 
c⁄n_ª•
.
¥Ÿo
.
ty≥
 = 
C⁄n_HâpSrv
;

89 
hmª•
->
c⁄n
 = &
c⁄n_ª•
;

91  (
TfwHâpRe•
 *)
hmª•
;

92 
	}
}

95 
	$ã°_ª•_‰ì
(
TfwHâpRe•
 *
ª•
)

97 
	`BUG_ON
(!
ª•
);

98 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
ª•
);

99 
	}
}

	@t/unit/helpers.h

20 #i‚de‡
__TFW_TEST_HELPER_H__


21 
	#__TFW_TEST_HELPER_H__


	)

25 
TfwHâpReq
 *
ã°_ªq_Æloc
(
size_t
 
d©a_Àn
);

26 
ã°_ªq_‰ì
(
TfwHâpReq
 *
ªq
);

27 
TfwHâpRe•
 *
ã°_ª•_Æloc
(
size_t
 
d©a_Àn
);

28 
ã°_ª•_‰ì
(
TfwHâpRe•
 *
ªq
);

	@t/unit/kallsyms_helper.c

20 
	~<löux/°rög.h
>

21 
	~<löux/kÆlsyms.h
>

22 
	~<löux/moduÀ.h
>

24 
	~"kÆlsyms_hñ≥r.h
"

27 
	maddr
;

28 c⁄° *
	m«me
;

29 } 
	tSymd©a
;

32 
	$gë_sym
(*
d©a
, c⁄° *
«mebuf
, 
moduÀ
 *
ow√r
,

33 
addr
)

35 
Symd©a
 *
symd©a
 = 
d©a
;

37 i‡(
	`°rcmp
(
«mebuf
, 
symd©a
->
«me
))

40 
symd©a
->
addr
 =áddr;

42 
	}
}

45 
	$gë_sym_±r
(c⁄° *
«me
)

47 
Symd©a
 
symd©a
 = { .
addr
 = 0, .
«me
 =Çame };

49 
	`muãx_lock
(&
moduÀ_muãx
);

50 
	`kÆlsyms_⁄_óch_symbﬁ
(
gë_sym
, &
symd©a
);

51 
	`muãx_u∆ock
(&
moduÀ_muãx
);

53  (*)
symd©a
.
addr
;

54 
	}
}

	@t/unit/kallsyms_helper.h

21 #i‚de‡
__TFW_KALLSYMS_HELPER_H__


22 
	#__TFW_KALLSYMS_HELPER_H__


	)

24 *
gë_sym_±r
(c⁄° *
«me
);

	@t/unit/main.c

21 
	~<löux/moduÀ.h
>

23 
	~"ãm≥°a_fw.h
"

24 
	~"ã°.h
"

26 
MODULE_AUTHOR
(
TFW_AUTHOR
);

27 
MODULE_DESCRIPTION
("Tempesta FWÅests");

28 
MODULE_VERSION
("0.1.0");

29 
MODULE_LICENSE
("GPL");

31 
__öô


32 
	$tfw_ã°_öô
()

34 
Áû_cou¡
 = 0;

36 
	`¥ötk
("tfw_test: start\n");

37 
Áû_cou¡
 = 
	`ã°_run_Æl
();

39 
	`¥ötk
("tfw_test: finish - ");

40 i‡(
Áû_cou¡
)

41 
	`¥ötk
(
KERN_CONT
 "Áûed %dás£πi⁄s\n", 
Áû_cou¡
);

43 
	`¥ötk
(
KERN_CONT
 "allÖassed\n");

46 
	}
}

49 
	$tfw_ã°_exô
()

51 
	}
}

53 
moduÀ_öô
(
tfw_ã°_öô
);

54 
moduÀ_exô
(
tfw_ã°_exô
);

	@t/unit/sched_helper.c

21 
	~<löux/ty≥s.h
>

22 
	~<asm/Âu/≠i.h
>

24 #unde‡
tfw_sock_§v_öô


25 
	#tfw_sock_§v_öô
 
ã°_sock_§v_c⁄n_öô


	)

26 #unde‡
tfw_sock_§v_exô


27 
	#tfw_sock_§v_exô
 
ã°_sock_§v_exô


	)

28 #unde‡
tfw_§v_c⁄n_ªÀa£


29 
	#tfw_§v_c⁄n_ªÀa£
 
ã°_§v_c⁄n_ªÀa£


	)

30 #unde‡
tfw_sock_§v_mod


31 
	#tfw_sock_§v_mod
 
ã°_sock_§v_mod


	)

32 
	~"sock_§v.c
"

34 
	~"kÆlsyms_hñ≥r.h
"

35 
	~"£rvî.h
"

36 
	~"sched_hñ≥r.h
"

37 
	~"ã°.h
"

40 
	$ã°_•ec_˛ónup
(
TfwCfgS≥c
 
•ecs
[])

42 
TfwCfgS≥c
 *
•ec
;

44 
	`TFW_CFG_FOR_EACH_SPEC
(
•ec
, 
•ecs
) {

45 
boﬁ
 
ˇŒed
 = 
•ec
->
__ˇŒed_cfg
 | s≥c->
__ˇŒed_evî
;

46 i‡(
ˇŒed
 && 
•ec
->
˛ónup
) {

47 
	`TFW_DBG2
("%s: '%s'\n", 
__func__
, 
•ec
->
«me
);

48 
•ec
->
	`˛ónup
(spec);

50 
•ec
->
__ˇŒed_cfg
 = 
Ál£
;

51 
•ec
->
__ˇŒed_evî
 = 
Ál£
;

53 
	}
}

55 
TfwSrvGroup
 *

56 
	$ã°_¸óã_sg
(c⁄° *
«me
)

58 
TfwSrvGroup
 *
sg
;

60 
	`kî√l_Âu_íd
();

62 
sg
 = 
	`tfw_sg_√w
(
«me
, 
	`°æí
“ame), 
GFP_ATOMIC
);

63 
	`BUG_ON
(!
sg
);

65 
sg
->
max_qsize
 = 100;

67 
	`kî√l_Âu_begö
();

69  
sg
;

70 
	}
}

73 
	$ã°_°¨t_sg
(
TfwSrvGroup
 *
sg
, c⁄° *
sched_«me
, 
Êags
)

75 
r
;

76 
TfwScheduÀr
 *
sched
;

78 
	`kî√l_Âu_íd
();

80 
sg
->
Êags
 = flags;

81 
r
 = 
	`tfw_sg_add_ªc⁄fig
(
sg
);

82 
	`BUG_ON
(
r
);

84 i‡(!
	`°rcmp
(
sched_«me
, "ratio"))

85 
	`tfw_cfg_sg_øtio_adju°
(&
sg
->
§v_li°
);

87 
sched
 = 
	`tfw_sched_lookup
(
sched_«me
);

88 
	`BUG_ON
(!
sched
);

89 
r
 = 
	`tfw_sg_°¨t_sched
(
sg
, 
sched
, 
NULL
);

90 
	`BUG_ON
(
r
);

92 
	`kî√l_Âu_begö
();

93 
	}
}

99 
	$ã°_sg_ªÀa£_Æl_ªc⁄fig
()

101 
i
 = 0;

102 
TfwSrvGroup
 *
sg
 = 
NULL
;

103 
hli°_node
 *
tmp
;

104 
rw_£m≠h‹e
 *
sg_£m
 = 
	`gë_sym_±r
("sg_sem");

105 
hli°_hód
 *
sg_hash_ªc⁄fig
 = 
	`gë_sym_±r
("sg_hash_reconfig");

107 
size_t
 
TFW_SG_HBITS
 = 10;

109 i‡(!
sg_£m
 || !
sg_hash_ªc⁄fig
) {

110 
	`¥_w¨n
("%s: cannotÑesolveÇecessary symbols:"

112 
__func__
, 
sg_£m
, 
sg_hash_ªc⁄fig
);

116 
	`down_wrôe
(
sg_£m
);

119  ; !
sg
 && 
i
 < (1 << 
TFW_SG_HBITS
); i++) {

120 
	`hli°_f‹_óch_íåy_ß„
(
sg
, 
tmp
, &
sg_hash_ªc⁄fig
[
i
],

121 
li°_ªc⁄fig
)

123 
TfwSîvî
 *
§v
, *
§v_tmp
;

125 
	`tfw_sg_°›_sched
(
sg
);

126 
	`li°_f‹_óch_íåy_ß„
(
§v
, 
§v_tmp
,

127 &
sg
->
§v_li°
, 
li°
)

129 
	`__tfw_sg_dñ_§v
(
sg
, 
§v
, 
Ál£
);

130 
	`tfw_§v_lo›_sched_rcu
();

132 
	`hash_dñ
(&
sg
->
li°_ªc⁄fig
);

134 i‡(
sg
 && !
	`©omic64_dec_ªtu∫
(&sg->
ªf˙t
))

135 
	`tfw_sg_de°roy
(
sg
);

138 
	`__hash_öô
(
sg_hash_ªc⁄fig
, 1 << 
TFW_SG_HBITS
);

140 
	`up_wrôe
(
sg_£m
);

141 
	}
}

144 
	$ã°_sg_ªÀa£_Æl
()

146 
	`kî√l_Âu_íd
();

148 
	`tfw_sg_ªÀa£_Æl
();

149 
	`ã°_sg_ªÀa£_Æl_ªc⁄fig
();

151 
	`kî√l_Âu_begö
();

152 
	}
}

154 
TfwSîvî
 *

155 
	$ã°_¸óã_§v
(c⁄° *
ö_addr
, 
TfwSrvGroup
 *
sg
)

157 
TfwAddr
 
addr
;

158 
TfwSîvî
 *
§v
;

161 
r
 = 
	`tfw_addr_±⁄
(&
	`TFW_STR_FROM
(
ö_addr
), &
addr
);

162 
	`BUG_ON
(
r
);

165 
§v
 = 
	`tfw_£rvî_¸óã
(&
addr
);

166 
	`BUG_ON
(!
§v
);

168 
	`tfw_sg_add_§v
(
sg
, 
§v
);

170  
§v
;

171 
	}
}

173 
TfwSrvC⁄n
 *

174 
	$ã°_¸óã_§v_c⁄n
(
TfwSîvî
 *
§v
)

176 
sock
 
__ã°_sock
 = {

177 .
sk_°©e
 = 
TCP_ESTABLISHED
,

179 
TfwSrvC⁄n
 *
§v_c⁄n
;

181 
	`kî√l_Âu_íd
();

183 i‡(!
tfw_§v_c⁄n_ˇche
)

184 
	`tfw_sock_§v_öô
();

185 
§v_c⁄n
 = 
	`tfw_§v_c⁄n_Æloc
();

186 
	`BUG_ON
(!
§v_c⁄n
);

188 
	`tfw_c⁄√˘i⁄_lök_≥î
((
TfwC⁄n
 *)
§v_c⁄n
, (
TfwPìr
 *)
§v
);

189 
§v_c⁄n
->
sk
 = &
__ã°_sock
;

191 
	`tfw_c⁄√˘i⁄_ªvive
((
TfwC⁄n
 *)
§v_c⁄n
);

193 
§v
->
c⁄n_n
++;

195 
	`kî√l_Âu_begö
();

197  
§v_c⁄n
;

198 
	}
}

201 
	$ã°_c⁄n_ªÀa£_Æl
(
TfwSrvGroup
 *
sg
)

203 
TfwSîvî
 *
§v
;

204 
TfwC⁄n
 *
c⁄n
, *
tmp
;

206 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

207 
	`li°_f‹_óch_íåy_ß„
(
c⁄n
, 
tmp
, &
§v
->
c⁄n_li°
, 
li°
) {

208 
c⁄n
->
sk
 = 
NULL
;

209 
	`tfw_c⁄√˘i⁄_u∆ök_‰om_≥î
(
c⁄n
);

210 
	`tfw_c⁄√˘i⁄_live
(
c⁄n
))

211 
	`tfw_c⁄√˘i⁄_put
(
c⁄n
);

212 
	`tfw_§v_c⁄n_‰ì
((
TfwSrvC⁄n
 *)
c⁄n
);

215 
	}
}

221 
	$ã°_sched_sg_em±y_sg
(
Te°SchedHñ≥r
 *
sched_hñ≥r
)

223 
size_t
 
i
;

224 
TfwSrvGroup
 *
sg
;

226 
	`BUG_ON
(!
sched_hñ≥r
);

227 
	`BUG_ON
(!
sched_hñ≥r
->
sched
);

228 
	`BUG_ON
(!
sched_hñ≥r
->
c⁄n_ty≥s
);

229 
	`BUG_ON
(!
sched_hñ≥r
->
gë_sched_¨g
);

230 
	`BUG_ON
(!
sched_hñ≥r
->
‰ì_sched_¨g
);

232 
sg
 = 
	`ã°_¸óã_sg
("test");

233 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r
->
sched
, sched_hñ≥r->
Êags
);

235 
i
 = 0; i < 
sched_hñ≥r
->
c⁄n_ty≥s
; ++i) {

236 
TfwMsg
 *
msg
 = 
sched_hñ≥r
->
	`gë_sched_¨g
(
i
);

237 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, sg);

239 
	`EXPECT_NULL
(
§v_c⁄n
);

240 
sched_hñ≥r
->
	`‰ì_sched_¨g
(
msg
);

243 
	`ã°_sg_ªÀa£_Æl
();

244 
	}
}

251 
	$ã°_sched_sg_⁄e_§v_zîo_c⁄n
(
Te°SchedHñ≥r
 *
sched_hñ≥r
)

253 
size_t
 
i
;

254 
TfwSrvGroup
 *
sg
;

256 
	`BUG_ON
(!
sched_hñ≥r
);

257 
	`BUG_ON
(!
sched_hñ≥r
->
sched
);

258 
	`BUG_ON
(!
sched_hñ≥r
->
c⁄n_ty≥s
);

259 
	`BUG_ON
(!
sched_hñ≥r
->
gë_sched_¨g
);

260 
	`BUG_ON
(!
sched_hñ≥r
->
‰ì_sched_¨g
);

262 
sg
 = 
	`ã°_¸óã_sg
("test");

263 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

264 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r
->
sched
, sched_hñ≥r->
Êags
);

266 
i
 = 0; i < 
sched_hñ≥r
->
c⁄n_ty≥s
; ++i) {

267 
TfwMsg
 *
msg
 = 
sched_hñ≥r
->
	`gë_sched_¨g
(
i
);

268 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, sg);

270 
	`EXPECT_NULL
(
§v_c⁄n
);

271 
sched_hñ≥r
->
	`‰ì_sched_¨g
(
msg
);

274 
	`ã°_sg_ªÀa£_Æl
();

275 
	}
}

283 
	$ã°_sched_sg_max_§v_zîo_c⁄n
(
Te°SchedHñ≥r
 *
sched_hñ≥r
)

285 
size_t
 
i
, 
j
;

286 
TfwSrvGroup
 *
sg
;

288 
	`BUG_ON
(!
sched_hñ≥r
);

289 
	`BUG_ON
(!
sched_hñ≥r
->
sched
);

290 
	`BUG_ON
(!
sched_hñ≥r
->
c⁄n_ty≥s
);

291 
	`BUG_ON
(!
sched_hñ≥r
->
gë_sched_¨g
);

292 
	`BUG_ON
(!
sched_hñ≥r
->
‰ì_sched_¨g
);

294 
sg
 = 
	`ã°_¸óã_sg
("test");

296 
j
 = 0; j < 
TFW_TEST_SG_MAX_SRV_N
; ++j)

297 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

298 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r
->
sched
, sched_hñ≥r->
Êags
);

300 
i
 = 0; i < 
sched_hñ≥r
->
c⁄n_ty≥s
; ++i) {

301 
TfwMsg
 *
msg
 = 
sched_hñ≥r
->
	`gë_sched_¨g
(
i
);

303 
j
 = 0; j < 
sg
->
§v_n
; ++j) {

304 
TfwSrvC⁄n
 *
§v_c⁄n
 =

305 
sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, sg);

307 
	`EXPECT_NULL
(
§v_c⁄n
);

312 
	`kî√l_Âu_íd
();

313 
	`scheduÀ
();

314 
	`kî√l_Âu_begö
();

316 
sched_hñ≥r
->
	`‰ì_sched_¨g
(
msg
);

319 
	`ã°_sg_ªÀa£_Æl
();

320 
	}
}

327 
	$ã°_sched_§v_⁄e_§v_zîo_c⁄n
(
Te°SchedHñ≥r
 *
sched_hñ≥r
)

329 
size_t
 
i
;

330 
TfwSrvGroup
 *
sg
;

331 
TfwSîvî
 *
§v
;

333 
	`BUG_ON
(!
sched_hñ≥r
);

334 
	`BUG_ON
(!
sched_hñ≥r
->
sched
);

335 
	`BUG_ON
(!
sched_hñ≥r
->
c⁄n_ty≥s
);

336 
	`BUG_ON
(!
sched_hñ≥r
->
gë_sched_¨g
);

337 
	`BUG_ON
(!
sched_hñ≥r
->
‰ì_sched_¨g
);

339 
sg
 = 
	`ã°_¸óã_sg
("test");

340 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

341 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r
->
sched
, sched_hñ≥r->
Êags
);

343 
i
 = 0; i < 
sched_hñ≥r
->
c⁄n_ty≥s
; ++i) {

344 
TfwMsg
 *
msg
 = 
sched_hñ≥r
->
	`gë_sched_¨g
(
i
);

345 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, 
§v
);

347 
	`EXPECT_NULL
(
§v_c⁄n
);

348 
sched_hñ≥r
->
	`‰ì_sched_¨g
(
msg
);

351 
	`ã°_sg_ªÀa£_Æl
();

352 
	}
}

359 
	$ã°_sched_§v_max_§v_zîo_c⁄n
(
Te°SchedHñ≥r
 *
sched_hñ≥r
)

361 
size_t
 
i
, 
j
;

362 
TfwSrvGroup
 *
sg
;

364 
	`BUG_ON
(!
sched_hñ≥r
);

365 
	`BUG_ON
(!
sched_hñ≥r
->
sched
);

366 
	`BUG_ON
(!
sched_hñ≥r
->
c⁄n_ty≥s
);

367 
	`BUG_ON
(!
sched_hñ≥r
->
gë_sched_¨g
);

368 
	`BUG_ON
(!
sched_hñ≥r
->
‰ì_sched_¨g
);

370 
sg
 = 
	`ã°_¸óã_sg
("test");

372 
j
 = 0; j < 
TFW_TEST_SG_MAX_SRV_N
; ++j)

373 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

374 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r
->
sched
, sched_hñ≥r->
Êags
);

376 
i
 = 0; i < 
sched_hñ≥r
->
c⁄n_ty≥s
; ++i) {

377 
TfwMsg
 *
msg
 = 
sched_hñ≥r
->
	`gë_sched_¨g
(
i
);

378 
TfwSîvî
 *
§v
;

380 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

381 
TfwSrvC⁄n
 *
§v_c⁄n
 =

382 
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, 
§v
);

384 
	`EXPECT_NULL
(
§v_c⁄n
);

389 
	`kî√l_Âu_íd
();

390 
	`scheduÀ
();

391 
	`kî√l_Âu_begö
();

393 
sched_hñ≥r
->
	`‰ì_sched_¨g
(
msg
);

396 
	`ã°_sg_ªÀa£_Æl
();

397 
	}
}

404 
	$ã°_sched_§v_ofÊöe_§v
(
Te°SchedHñ≥r
 *
sched_hñ≥r
)

406 
size_t
 
i
;

407 
size_t
 
ofÊöe_num
 = 3;

408 
TfwSîvî
 *
ofÊöe_§v
 = 
NULL
;

409 
TfwSrvGroup
 *
sg
;

410 
TfwSîvî
 *
§v
;

411 
TfwSrvC⁄n
 *
§v_c⁄n
;

413 
	`BUG_ON
(!
sched_hñ≥r
);

414 
	`BUG_ON
(!
sched_hñ≥r
->
sched
);

415 
	`BUG_ON
(!
sched_hñ≥r
->
c⁄n_ty≥s
);

416 
	`BUG_ON
(!
sched_hñ≥r
->
gë_sched_¨g
);

417 
	`BUG_ON
(!
sched_hñ≥r
->
‰ì_sched_¨g
);

418 
	`BUG_ON
(
ofÊöe_num
 >
TFW_TEST_SG_MAX_SRV_N
);

420 
sg
 = 
	`ã°_¸óã_sg
("test");

422 
i
 = 0; i < 
TFW_TEST_SG_MAX_SRV_N
; ++i) {

423 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

424 
§v_c⁄n
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

426 i‡(
i
 =
ofÊöe_num
)

427 
ofÊöe_§v
 = 
§v
;

429 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

430 i‡(
§v
 =
ofÊöe_§v
) {

431 
	`li°_f‹_óch_íåy
(
§v_c⁄n
, &
§v
->
c⁄n_li°
, 
li°
)

432 
	`©omic_£t
(&
§v_c⁄n
->
ªf˙t
, 0);

436 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r
->
sched
, sched_hñ≥r->
Êags
);

438 
i
 = 0; i < 
sched_hñ≥r
->
c⁄n_ty≥s
; ++i) {

439 
TfwMsg
 *
msg
 = 
sched_hñ≥r
->
	`gë_sched_¨g
(
i
);

441 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

442 
§v_c⁄n
 = 
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, 
§v
);

444 i‡(
§v
 =
ofÊöe_§v
)

445 
	`EXPECT_NULL
(
§v_c⁄n
);

447 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

452 
	`kî√l_Âu_íd
();

453 
	`scheduÀ
();

454 
	`kî√l_Âu_begö
();

456 
sched_hñ≥r
->
	`‰ì_sched_¨g
(
msg
);

459 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

460 
	`ã°_sg_ªÀa£_Æl
();

461 
	}
}

	@t/unit/sched_helper.h

22 #i‚de‡
__TFW_SCHED_HELPER_H__


23 
	#__TFW_SCHED_HELPER_H__


	)

25 
	~"addr.h
"

26 
	~"cfg.h
"

27 
	~"c⁄√˘i⁄.h
"

29 
	#TFW_TEST_SG_MAX_SRV_N
 64

	)

30 
	#TFW_TEST_SRV_MAX_CONN_N
 64

	)

31 
	#TFW_TEST_SG_MAX_CONN_N
 \

32 (
TFW_TEST_SG_MAX_SRV_N
 * 
TFW_TEST_SRV_MAX_CONN_N
)

	)

34 
tfw_£rvî_öô
();

35 
tfw_sched_øtio_öô
();

36 
sched_hñ≥r_öô
();

38 
ã°_•ec_˛ónup
(
TfwCfgS≥c
 
•ecs
[]);

39 
TfwSrvGroup
 *
ã°_¸óã_sg
(c⁄° *
«me
);

40 
ã°_°¨t_sg
(
TfwSrvGroup
 *
sg
, c⁄° *
sched_«me
, 
Êags
);

41 
ã°_sg_ªÀa£_Æl
();

43 
TfwSîvî
 *
ã°_¸óã_§v
(c⁄° *
ö_addr
, 
TfwSrvGroup
 *
sg
);

44 
TfwSrvC⁄n
 *
ã°_¸óã_§v_c⁄n
(
TfwSîvî
 *
§v
);

46 
ã°_c⁄n_ªÀa£_Æl
(
TfwSrvGroup
 *
sg
);

48 
	sTe°SchedHñ≥r
 {

49 c⁄° *
	msched
;

50 
size_t
 
	mc⁄n_ty≥s
;

51 
	mÊags
;

52 
	mTfwMsg
 *(*
	mgë_sched_¨g
)(
size_t
 
	mc⁄n_ty≥
);

53 (*
	m‰ì_sched_¨g
)(
	mTfwMsg
 *);

56 
ã°_sched_§v_ofÊöe_§v
(
Te°SchedHñ≥r
 *
sched_hñ≥r
);

	@t/unit/test.c

21 
	~<löux/ty≥s.h
>

22 
	~<asm/Âu/≠i.h
>

23 
	~<löux/moduÀ.h
>

24 
	~"ã°.h
"

26 #unde‡
tfw_≠m_°©s


27 
	#tfw_≠m_°©s
 
ã°_tfw_≠m_°©s


	)

29 
	~"≠m.c
"

31 
	gã°_Áû_cou¡î
;

32 
ã°_fixtuª_‚_t
 
	gã°_£tup_‚
;

33 
ã°_fixtuª_‚_t
 
	gã°_ã¨down_‚
;

58 
	$ã°_ªgi°î_Áûuª
()

60 ++
ã°_Áû_cou¡î
;

61 
	}
}

64 
	$ã°_£t_£tup_‚
(
ã°_fixtuª_‚_t
 
‚
)

66 
	`BUG_ON
(
‚
 && 
ã°_£tup_‚
);

67 
ã°_£tup_‚
 = 
‚
;

68 
	}
}

71 
	$ã°_£t_ã¨down_‚
(
ã°_fixtuª_‚_t
 
‚
)

73 
	`BUG_ON
(
‚
 && 
ã°_ã¨down_‚
);

74 
ã°_ã¨down_‚
 = 
‚
;

75 
	}
}

78 
	$ã°_ˇŒ_£tup_‚
()

80 i‡(
ã°_£tup_‚
)

81 
	`ã°_£tup_‚
();

82 
	}
}

85 
	$ã°_ˇŒ_ã¨down_‚
()

87 i‡(
ã°_ã¨down_‚
)

88 
	`ã°_ã¨down_‚
();

89 
	}
}

91 
TEST_SUITE
(
cfg
);

92 
TEST_SUITE
(
tfw_°r
);

93 
TEST_SUITE
(
mem_Á°
);

94 
TEST_SUITE
(
hâp_∑r£r
);

95 
TEST_SUITE
(
hâp_°icky
);

96 
TEST_SUITE
(
hâp_m©ch
);

97 
TEST_SUITE
(
hâp_msg
);

98 
TEST_SUITE
(
hash
);

99 
TEST_SUITE
(
addr
);

100 
TEST_SUITE
(
sched_øtio
);

101 
TEST_SUITE
(
sched_hash
);

102 
TEST_SUITE
(
hâp_tbl
);

103 
TEST_SUITE
(
wq
);

104 
TEST_SUITE
(
és
);

107 
	$ã°_run_Æl
()

109 
ã°_Áû_cou¡î
 = 0;

112 
	`TEST_SUITE_RUN
(
cfg
);

113 
	`TEST_SUITE_RUN
(
wq
);

116 
	`TEST_SUITE_RUN
(
és
);

118 
	`kî√l_Âu_begö
();

119 
	`tfw_°r_öô_c⁄°
();

125 
	`TEST_SUITE_RUN
(
tfw_°r
);

126 
	`TEST_SUITE_RUN
(
mem_Á°
);

127 
	`TEST_SUITE_RUN
(
hâp_∑r£r
);

128 
	`TEST_SUITE_RUN
(
hâp_m©ch
);

129 
	`TEST_SUITE_RUN
(
hâp_msg
);

130 
	`TEST_SUITE_RUN
(
hâp_°icky
);

131 
	`TEST_SUITE_RUN
(
hash
);

132 
	`TEST_SUITE_RUN
(
addr
);

133 
	`TEST_SUITE_RUN
(
sched_øtio
);

134 
	`TEST_SUITE_RUN
(
sched_hash
);

135 
	`TEST_SUITE_RUN
(
hâp_tbl
);

137 
	`kî√l_Âu_íd
();

139  
ã°_Áû_cou¡î
;

140 
	}
}

	@t/unit/test.h

28 #i‚de‡
__TFW_TEST_H__


29 
	#__TFW_TEST_H__


	)

31 
	~<löux/kî√l.h
>

32 
	~<löux/°rög.h
>

34 
ã°_run_Æl
();

35 
ã°_ªgi°î_Áûuª
();

37 (*
	tã°_fixtuª_‚_t
)();

39 
	`ã°_£t_£tup_‚
(
ã°_fixtuª_‚_t
 
‚
);

40 
	`ã°_£t_ã¨down_‚
(
ã°_fixtuª_‚_t
 
‚
);

41 
	`ã°_ˇŒ_£tup_‚
();

42 
	`ã°_ˇŒ_ã¨down_‚
();

44 
	#TEST_BANNER
 "tfw_ã°: "

	)

46 
	#TEST_LOG
(...Ë
	`¥ötk
(
KERN_INFO
 
TEST_BANNER
 
__VA_ARGS__
)

	)

47 
	#TEST_LOG_LF
(...) \

49 
	`TEST_LOG
(
__VA_ARGS__
); \

50 
	`¥ötk
(
KERN_CONT
 "\n"); \

51 
	}
} 0)

	)

53 
	#TEST_ERR
(...Ë
	`¥ötk
(
KERN_ERR
 
TEST_BANNER
 
__VA_ARGS__
)

	)

54 
	#TEST_ERR_LF
(...) \

56 
	`TEST_ERR
(
__VA_ARGS__
); \

57 
	`¥ötk
(
KERN_CONT
 "\n"); \

58 } 0)

	)

60 #i‡
deföed
(
DEBUG
) && (DEBUG >= 1)

61 
	#TEST_DBG
(...Ë
	`¥_debug
(
TEST_BANNER
 " " 
__VA_ARGS__
)

	)

63 
	#TEST_DBG
(...)

	)

66 #i‡
deföed
(
DEBUG
) && (DEBUG >= 2)

67 
	#TEST_DBG2
(...Ë
	`¥_debug
(
TEST_BANNER
 " " 
__VA_ARGS__
)

	)

69 
	#TEST_DBG2
(...)

	)

72 #i‡
deföed
(
DEBUG
) && (DEBUG >= 3)

73 
	#TEST_DBG3
(...Ë
	`¥_debug
(
TEST_BANNER
 " " 
__VA_ARGS__
)

	)

75 
	#TEST_DBG3
(...)

	)

82 
	#TEST
(
unô
, 
as£πi⁄
) \

83 
	`__©åibuã__
((
unu£d
)Ë
ã°__
 ##
unô
 ##
__
 ##
	`as£πi⁄
()

	)

85 
	#TEST_SUITE
(
«me
Ë
ã°_suôe__
##
	`«me
()

	)

86 
	#TEST_SETUP
(
‚
Ë
	`ã°_£t_£tup_‚
(‚)

	)

87 
	#TEST_TEARDOWN
(
‚
Ë
	`ã°_£t_ã¨down_‚
(‚)

	)

89 
	#TEST_RUN
(
unô
, 
as£πi⁄
) \

91 
	`TEST_LOG_LF
("TEST_RUN(%s, %s)", #unit, #assertion); \

92 
	`ã°_ˇŒ_£tup_‚
(); \

93 
ã°__
 ##
unô
 ##
__
 ##
	`as£πi⁄
(); \

94 
	`ã°_ˇŒ_ã¨down_‚
(); \

95 } 0)

	)

97 
	#TEST_SUITE_RUN
(
«me
) \

99 
	`TEST_LOG_LF
("TEST_SUITE_RUN(%s)", #name); \

100 
ã°_suôe__
##
	`«me
(); \

101 
	`ã°_£t_£tup_‚
(
NULL
); \

102 
	`ã°_£t_ã¨down_‚
(
NULL
); \

103 } 0)

	)

105 
	#TEST_FAIL
(...) \

107 
	`TEST_ERR_LF
("%s:%d:Éº‹: ", 
__FILE__
, 
__LINE__
); \

108 
	`TEST_ERR_LF
("FAIL:"); \

109 
	`TEST_ERR_LF
(" %s()", 
__func__
); \

110 
	`TEST_ERR_LF
(" " 
__VA_ARGS__
); \

111 
	`ã°_ªgi°î_Áûuª
(); \

112 } 0)

	)

114 
	#__EXPECT_COND
(
«me
, 
ex¥
, 
c⁄d_ex¥
) \

116 
	`ty≥of
(
ex¥
Ë
_vÆ
 = (expr); \

117 i‡(
c⁄d_ex¥
) \

119 
	`TEST_FAIL
("%s(%sË=> %#lx", 
«me
, #ex¥, ()
_vÆ
); \

120 } 0)

	)

122 
	#__EXPECT_CMP
(
«me
, 
ex¥1
, 
ex¥2
, 
cmp_ex¥
) \

124 
	`ty≥of
(
ex¥1
Ë
_vÆ1
 = (expr1); \

125 
	`ty≥of
(
ex¥2
Ë
_vÆ2
 = (expr2); \

126 i‡(
cmp_ex¥
) \

128 
	`TEST_FAIL
("%s(%s, %sË=> (%#lx, %#lx)", 
«me
, #expr1, #expr2, \

129 ()
_vÆ1
, ()
_vÆ2
); \

130 } 0)

	)

132 
	#EXPECT_ZERO
(
ex¥
) \

133 
	`__EXPECT_COND
("EXPECT_ZERO", (
ex¥
), 
_vÆ
 =0)

	)

135 
	#EXPECT_EQ
(
ex¥1
, 
ex¥2
) \

136 
	`__EXPECT_CMP
("EXPECT_EQ", (
ex¥1
), (
ex¥2
), 
_vÆ1
 =
_vÆ2
)

	)

138 
	#EXPECT_NE
(
ex¥1
, 
ex¥2
) \

139 
	`__EXPECT_CMP
("EXPECT_NE", (
ex¥1
), (
ex¥2
), 
_vÆ1
 !
_vÆ2
)

	)

141 
	#EXPECT_LT
(
ex¥1
, 
ex¥2
) \

142 
	`__EXPECT_CMP
("EXPECT_LT", (
ex¥1
), (
ex¥2
), 
_vÆ1
 < 
_vÆ2
)

	)

144 
	#EXPECT_LE
(
ex¥1
, 
ex¥2
) \

145 
	`__EXPECT_CMP
("EXPECT_LE", (
ex¥1
), (
ex¥2
), 
_vÆ1
 <
_vÆ2
)

	)

147 
	#EXPECT_GT
(
ex¥1
, 
ex¥2
) \

148 
	`__EXPECT_CMP
("EXPECT_GT", (
ex¥1
), (
ex¥2
), 
_vÆ1
 > 
_vÆ2
)

	)

150 
	#EXPECT_GE
(
ex¥1
, 
ex¥2
) \

151 
	`__EXPECT_CMP
("EXPECT_GE", (
ex¥1
), (
ex¥2
), 
_vÆ1
 >
vÆ2
)

	)

153 
	#EXPECT_TRUE
(
ex¥
) \

154 
	`__EXPECT_COND
("EXPECT_TRUE", (
ex¥
), 
_vÆ
)

	)

156 
	#EXPECT_FALSE
(
ex¥
) \

157 
	`__EXPECT_COND
("EXPECT_FALSE", (
ex¥
), !
_vÆ
)

	)

159 
	#EXPECT_NULL
(
ex¥
) \

160 
	`__EXPECT_COND
("EXPECT_NULL", (
ex¥
), 
_vÆ
 =
NULL
)

	)

162 
	#EXPECT_NOT_NULL
(
ex¥
) \

163 
	`__EXPECT_COND
("EXPECT_NOT_NULL", (
ex¥
), 
_vÆ
 !
NULL
)

	)

165 
	#EXPECT_OK
(
ex¥
) \

166 
	`__EXPECT_COND
("EXPECT_OK", (
ex¥
), 
_vÆ
 =0)

	)

168 
	#EXPECT_ERROR
(
ex¥
) \

169 
	`__EXPECT_COND
("EXPECT_ERROR", (
ex¥
), 
_vÆ
 !0)

	)

171 
	#EXPECT_STR_EQ
(
°r1
, 
°r2
) \

173 c⁄° *
_s1
 = (
°r1
); \

174 c⁄° *
_s2
 = (
°r2
); \

175 i‡(!
_s1
 || !
_s2
) \

176 
	`TEST_FAIL
("EXPECT_STR_EQ(%s, %s) => NULLÖtr: (%p, %p)\n", \

177 #°r1, #°r2, 
_s1
, 
_s2
); \

178 i‡(
	`°rcmp
(
_s1
, 
_s2
)) \

179 
	`TEST_FAIL
("EXPECT_STR_EQ(%s, %s) => NEQ:\n str1: %s\n str2: %s\n", \

180 #°r1, #°r2, 
_s1
, 
_s2
); \

181 } 0)

	)

	@t/unit/test_addr.c

22 
	~"addr.h
"

23 
	~"ã°.h
"

26 
	$TEST
(
tfw_addr_¡›
, 
f‹m©s_ùv4_addrs
)

28 
TfwAddr
 
a1
 = {

29 .
v4
.
sö_Ámûy
 = 
AF_INET
,

30 .
v4
.
sö_addr
.
s_addr
 = 
INADDR_ANY
,

31 .
v4
.
sö_p‹t
 = 0,

33 
TfwAddr
 
a2
 = {

34 .
v4
.
sö_Ámûy
 = 
AF_INET
,

35 .
v4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_LOOPBACK
),

36 .
v4
.
sö_p‹t
 = 
	`ht⁄s
(8001),

38 
TfwAddr
 
a3
 = {

39 .
v4
.
sö_Ámûy
 = 
AF_INET
,

40 .
v4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(0x0764FF0A),

41 .
v4
.
sö_p‹t
 = 
	`ht⁄s
(65535),

44 
s1
[
TFW_ADDR_STR_BUF_SIZE
];

45 
s2
[
TFW_ADDR_STR_BUF_SIZE
];

46 
s3
[
TFW_ADDR_STR_BUF_SIZE
];

47 
size_t
 
l1
, 
l2
, 
l3
;

49 
	`mem£t
(
s1
, 0xAA, (s1));

50 
	`mem£t
(
s2
, 0xAA, (s2));

51 
	`mem£t
(
s3
, 0xAA, (s3));

53 
l1
 = 
	`tfw_addr_¡›
(&
a1
, 
s1
, (s1));

54 
l2
 = 
	`tfw_addr_¡›
(&
a2
, 
s2
, (s2));

55 
l3
 = 
	`tfw_addr_¡›
(&
a3
, 
s3
, (s3));

57 
	`EXPECT_EQ
(0, 
	`memcmp
("0.0.0.0", 
s1
, ++
l1
));

58 
	`EXPECT_EQ
(0, 
	`memcmp
("127.0.0.1:8001", 
s2
, ++
l2
));

59 
	`EXPECT_EQ
(0, 
	`memcmp
("7.100.255.10:65535", 
s3
, ++
l3
));

60 
	}
}

62 
	$TEST
(
tfw_addr_¡›
, 
f‹m©s_ùv6_addrs
)

64 
TfwAddr
 
a0
 = {

65 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

66 .
v6
.
sö6_addr
 = 
IN6ADDR_ANY_INIT
,

67 .
v6
.
sö6_p‹t
 = 0,

69 
TfwAddr
 
a1
 = {

70 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

71 .
v6
.
sö6_addr
 = 
IN6ADDR_LOOPBACK_INIT
,

72 .
v6
.
sö6_p‹t
 = 0,

74 
TfwAddr
 
a2
 = {

75 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

76 .
v6
.
sö6_addr
 = 
IN6ADDR_SITELOCAL_ALLROUTERS_INIT
,

77 .
v6
.
sö6_p‹t
 = 
	`ht⁄s
(2718),

79 
TfwAddr
 
a3
 = {

80 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

81 .
v6
.
sö6_addr
 = { { { 0x00,0x12,0x34,0x56,0x00,0x00,0xBC,0xDE,

83 .
v6
.
sö6_p‹t
 = 
	`ht⁄s
(65535),

87 c⁄° *
e0
 = "::0";

88 c⁄° *
e1
 = "::1";

89 c⁄° *
e2
 = "[ff05::2]:2718";

90 c⁄° *
e3
 = "[12:3456::bcde:f001:0:0:607]:65535";

92 
s0
[
TFW_ADDR_STR_BUF_SIZE
];

93 
s1
[
TFW_ADDR_STR_BUF_SIZE
];

94 
s2
[
TFW_ADDR_STR_BUF_SIZE
];

95 
s3
[
TFW_ADDR_STR_BUF_SIZE
];

96 
size_t
 
l0
, 
l1
, 
l2
, 
l3
;

98 
	`mem£t
(
s0
, 0xAA, (s0));

99 
	`mem£t
(
s1
, 0xAA, (s1));

100 
	`mem£t
(
s2
, 0xAA, (s2));

101 
	`mem£t
(
s3
, 0xAA, (s3));

103 
l0
 = 
	`tfw_addr_¡›
(&
a0
, 
s0
, (s0));

104 
l1
 = 
	`tfw_addr_¡›
(&
a1
, 
s1
, (s1));

105 
l2
 = 
	`tfw_addr_¡›
(&
a2
, 
s2
, (s2));

106 
l3
 = 
	`tfw_addr_¡›
(&
a3
, 
s3
, (s3));

108 
	`EXPECT_EQ
(0, 
	`memcmp
(
e0
, 
s0
, ++
l0
));

109 
	`EXPECT_EQ
(0, 
	`memcmp
(
e1
, 
s1
, ++
l1
));

110 
	`EXPECT_EQ
(0, 
	`memcmp
(
e2
, 
s2
, ++
l2
));

111 
	`EXPECT_EQ
(0, 
	`memcmp
(
e3
, 
s3
, ++
l3
));

112 
	}
}

114 
	$TEST
(
tfw_addr_¡›
, 
omôs_p‹t_80
)

116 
TfwAddr
 
a1
 = {

117 .
v4
.
sö_Ámûy
 = 
AF_INET
,

118 .
v4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_LOOPBACK
),

119 .
v4
.
sö_p‹t
 = 
	`ht⁄s
(80),

121 
TfwAddr
 
a2
 = {

122 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

123 .
v6
.
sö6_addr
 = 
IN6ADDR_LOOPBACK_INIT
,

124 .
v6
.
sö6_p‹t
 = 
	`ht⁄s
(80),

127 c⁄° *
e1
 = "127.0.0.1";

128 c⁄° *
e2
 = "::1";

130 
s1
[
TFW_ADDR_STR_BUF_SIZE
];

131 
s2
[
TFW_ADDR_STR_BUF_SIZE
];

132 
size_t
 
l1
, 
l2
;

134 
	`mem£t
(
s1
, 0xAA, (s1));

135 
	`mem£t
(
s2
, 0xAA, (s2));

137 
l1
 = 
	`tfw_addr_¡›
(&
a1
, 
s1
, (s1));

138 
l2
 = 
	`tfw_addr_¡›
(&
a2
, 
s2
, (s2));

140 
	`EXPECT_EQ
(0, 
	`memcmp
(
e1
, 
s1
, ++
l1
));

141 
	`EXPECT_EQ
(0, 
	`memcmp
(
e2
, 
s2
, ++
l2
));

142 
	}
}

144 
	$TEST
(
tfw_addr_±⁄
, 
ªcognizes_v4_™d_v6_addrs
)

146 
	`DEFINE_TFW_STR
(
s1
, "127.0.0.1");

147 
	`DEFINE_TFW_STR
(
s2
, "127.0.0.1:8081");

148 
	`DEFINE_TFW_STR
(
s3
, "1111::2:a:B");

149 
	`DEFINE_TFW_STR
(
s4
, "[::1]:1234");

150 
	`DEFINE_TFW_STR
(
s5
, "[::0]:5678");

152 
TfwAddr
 
e1
 = {

153 .
v4
.
sö_Ámûy
 = 
AF_INET
,

154 .
v4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_LOOPBACK
),

155 .
v4
.
sö_p‹t
 = 
	`ht⁄s
(80)

157 
TfwAddr
 
e2
 = {

158 .
v4
.
sö_Ámûy
 = 
AF_INET
,

159 .
v4
.
sö_addr
.
s_addr
 = 
	`ht⁄l
(
INADDR_LOOPBACK
),

160 .
v4
.
sö_p‹t
 = 
	`ht⁄s
(8081)

162 
TfwAddr
 
e3
 = {

163 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

164 .
v6
.
sö6_addr
 = { { {

167 .
v6
.
sö6_p‹t
 = 
	`ht⁄s
(80)

169 
TfwAddr
 
e4
 = {

170 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

171 .
v6
.
sö6_addr
 = 
IN6ADDR_LOOPBACK_INIT
,

172 .
v6
.
sö6_p‹t
 = 
	`ht⁄s
(1234)

174 
TfwAddr
 
e5
 = {

175 .
v6
.
sö6_Ámûy
 = 
AF_INET6
,

176 .
v6
.
sö6_addr
 = 
IN6ADDR_ANY_INIT
,

177 .
v6
.
sö6_p‹t
 = 
	`ht⁄s
(5678)

180 
TfwAddr
 
a1
, 
a2
, 
a3
, 
a4
, 
a5
;

181 
r1
, 
r2
, 
r3
, 
r4
, 
r5
;

183 
r1
 = 
	`tfw_addr_±⁄
(&
s1
, &
a1
);

184 
r2
 = 
	`tfw_addr_±⁄
(&
s2
, &
a2
);

185 
r3
 = 
	`tfw_addr_±⁄
(&
s3
, &
a3
);

186 
r4
 = 
	`tfw_addr_±⁄
(&
s4
, &
a4
);

187 
r5
 = 
	`tfw_addr_±⁄
(&
s5
, &
a5
);

189 
	`EXPECT_OK
(
r1
);

190 
	`EXPECT_OK
(
r2
);

191 
	`EXPECT_OK
(
r3
);

192 
	`EXPECT_OK
(
r4
);

193 
	`EXPECT_OK
(
r5
);

194 
	`EXPECT_TRUE
(
	`tfw_addr_eq
(&
a1
, &
e1
));

195 
	`EXPECT_TRUE
(
	`tfw_addr_eq
(&
a2
, &
e2
));

196 
	`EXPECT_TRUE
(
	`tfw_addr_eq
(&
a3
, &
e3
));

197 
	`EXPECT_TRUE
(
	`tfw_addr_eq
(&
a4
, &
e4
));

198 
	`EXPECT_TRUE
(
	`tfw_addr_eq
(&
a5
, &
e5
));

199 
	}
}

201 
	$TEST_SUITE
(
addr
)

203 
	`TEST_RUN
(
tfw_addr_¡›
, 
f‹m©s_ùv4_addrs
);

204 
	`TEST_RUN
(
tfw_addr_¡›
, 
f‹m©s_ùv6_addrs
);

205 
	`TEST_RUN
(
tfw_addr_¡›
, 
omôs_p‹t_80
);

206 
	`TEST_RUN
(
tfw_addr_±⁄
, 
ªcognizes_v4_™d_v6_addrs
);

207 
	}
}

	@t/unit/test_cfg.c

21 
	~<löux/bug.h
>

23 
	~"cfg.h
"

24 
	~"ã°.h
"

25 #ifde‡
EXPORT_SYMBOL


26 #unde‡
EXPORT_SYMBOL


27 
	#EXPORT_SYMBOL
(
func
)

	)

29 
	~"cfg.c
"

31 #unde‡
moduÀ_öô


32 #unde‡
moduÀ_exô


33 
	#moduÀ_öô
(
‚
)

	)

34 
	#moduÀ_exô
(
‚
)

	)

35 
	#tfw_öô
(
¨g
Ë
__maybe_unu£d
 
	`__tfw_öô
◊rg)

	)

36 
	~"../../maö.c
"

51 
LIST_HEAD
(
ã°_tfw_mods
);

52 
TfwMod
 
	gã°_dummy_mod
 = { .
«me
 = "test_dummy_mod" };

55 
	$do_∑r£_cfg
(c⁄° *
cfg_ãxt
, 
TfwCfgS≥c
 
•ecs
[])

57 
ªt
;

59 
	`BUG_ON
(!
	`li°_em±y
(&
ã°_tfw_mods
));

60 
ã°_dummy_mod
.
•ecs
 = specs;

61 
	`li°_add
(&
ã°_dummy_mod
.
li°
, &
ã°_tfw_mods
);

63 i‡((
ªt
 = 
	`tfw_cfg_∑r£_mods
(
cfg_ãxt
, &
ã°_tfw_mods
)))

64  
ªt
;

65 i‡((
ªt
 = 
	`tfw_mods_cfgíd
(&
ã°_tfw_mods
)))

66  
ªt
;

67  
	`tfw_mods_°¨t
(&
ã°_tfw_mods
);

68 
	}
}

71 
	$do_˛ónup_cfg
()

73 
	`BUG_ON
(
	`li°_em±y
(&
ã°_tfw_mods
));

74 
	`tfw_°›
(&
ã°_tfw_mods
);

75 
	`li°_dñ
(&
ã°_dummy_mod
.
li°
);

76 
	}
}

79 
	$∑r£_cfg
(c⁄° *
cfg_ãxt
, 
TfwCfgS≥c
 
•ecs
[])

81 
r
 = 
	`do_∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

82 
	`do_˛ónup_cfg
();

83  
r
;

84 
	}
}

93 
	$cb_ö¸_˘r
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

95 *
cou¡î
 = 
cs
->
de°
;

96 ++(*
cou¡î
);

98 
	}
}

101 
	$cb_de¸_˘r
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

103 *
cou¡î
 = 
cs
->
de°
;

104 --(*
cou¡î
);

106 
	}
}

109 
	$cb_ö¸_˘r_îr
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

111 *
cou¡î
 = 
cs
->
de°
;

112 ++(*
cou¡î
);

114 
	}
}

122 
	$˛ónup_ö¸_˘r
(
TfwCfgS≥c
 *
cs
)

124 *
cou¡î
 = 
cs
->
•ec_ext
;

125 ++(*
cou¡î
);

126 
	}
}

134 
	$TEST
(
cfg_∑r£r
, 
övokes_•ecifõd_h™dÀr
)

136 
˘r
 = 0;

138 
TfwCfgS≥c
 
•ecs
[] = {

139 { "foo", 
NULL
, 
cb_ö¸_˘r
, &
˘r
 },

143 
	`∑r£_cfg
("foo;", 
•ecs
);

144 
	`EXPECT_EQ
(
˘r
, 1);

145 
	}
}

147 
	$TEST
(
cfg_∑r£r
, 
Ælows_ª≥©ög_íåõs
)

149 
˘r1
 = 0;

150 
˘r2
 = 0;

152 
TfwCfgS≥c
 
•ecs
[] = {

153 { "ö¸1", 
NULL
, 
cb_ö¸_˘r
, &
˘r1
, .
Ælow_ª≥©
 = 
åue
 },

154 { "ö¸2", 
NULL
, 
cb_ö¸_˘r
, &
˘r2
, .
Ælow_ª≥©
 = 
åue
 },

155 { "de¸1", 
NULL
, 
cb_de¸_˘r
, &
˘r1
, .
Ælow_ª≥©
 = 
åue
 },

156 { "de¸2", 
NULL
, 
cb_de¸_˘r
, &
˘r2
, .
Ælow_ª≥©
 = 
åue
 },

159 c⁄° *
cfg_ãxt
 =

165 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

167 
	`EXPECT_OK
(
r
);

168 
	`EXPECT_EQ
(
˘r1
, 1);

169 
	`EXPECT_EQ
(
˘r2
, -1);

170 
	}
}

172 
	$TEST
(
cfg_∑r£r
, 
Ælows_›ti⁄Æ_íåõs
)

174 
r
;

175 
cou¡î
 = 0;

177 
TfwCfgS≥c
 
•ecs_›t
[] = {

178 { "ö¸1", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î
 },

179 { "ö¸2", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î
, .
Ælow_n⁄e
 = 
åue
 },

180 { "ö¸3", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î
 },

183 
TfwCfgS≥c
 
•ecs_no›t
[] = {

184 { "ö¸1", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î
 },

185 { "ö¸2", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î
 },

186 { "ö¸3", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î
 },

189 c⁄° *
cfg_ãxt
 = "incr1; incr3;";

191 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs_›t
);

192 
	`EXPECT_OK
(
r
);

193 
	`EXPECT_EQ
(
cou¡î
, 2);

195 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs_no›t
);

196 
	`EXPECT_ERROR
(
r
);

197 
	}
}

200 *
	g›ts_cfg_ãxt
 =

207 
	$cb_›ti⁄1
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

209 
boﬁ
 *
is_ˇŒed
 = 
cs
->
de°
;

210 (*
is_ˇŒed
Ë
åue
;

212 
	`EXPECT_STR_EQ
(
e
->
«me
, "option1");

214 
	`EXPECT_EQ
(
e
->
vÆ_n
, 0);

215 
	`EXPECT_NULL
(
e
->
vÆs
[0]);

217 
	`EXPECT_EQ
(
e
->
©å_n
, 0);

218 
	`EXPECT_NULL
(
e
->
©ås
[0].
key
);

219 
	`EXPECT_NULL
(
e
->
©ås
[0].
vÆ
);

222 
	}
}

225 
	$cb_›ti⁄2
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

227 
boﬁ
 *
is_ˇŒed
 = 
cs
->
de°
;

228 (*
is_ˇŒed
Ë
åue
;

230 
	`EXPECT_STR_EQ
(
e
->
«me
, "option2");

232 
	`EXPECT_EQ
(
e
->
vÆ_n
, 1);

233 
	`EXPECT_STR_EQ
(
e
->
vÆs
[0], "value");

235 
	`EXPECT_EQ
(
e
->
©å_n
, 0);

236 
	`EXPECT_NULL
(
e
->
©ås
[0].
key
);

237 
	`EXPECT_NULL
(
e
->
©ås
[0].
vÆ
);

240 
	}
}

243 
	$cb_›ti⁄3
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

245 
boﬁ
 *
is_ˇŒed
 = 
cs
->
de°
;

246 (*
is_ˇŒed
Ë
åue
;

248 
	`EXPECT_STR_EQ
(
e
->
«me
, "option3");

250 
	`EXPECT_EQ
(
e
->
vÆ_n
, 0);

251 
	`EXPECT_NULL
(
e
->
vÆs
[0]);

253 
	`EXPECT_EQ
(
e
->
©å_n
, 1);

254 
	`EXPECT_STR_EQ
(
e
->
©ås
[0].
key
, "attr");

255 
	`EXPECT_STR_EQ
(
e
->
©ås
[0].
vÆ
, "val");

258 
	}
}

261 
	$cb_›ti⁄4
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

263 
boﬁ
 *
is_ˇŒed
 = 
cs
->
de°
;

264 (*
is_ˇŒed
Ë
åue
;

266 
	`EXPECT_STR_EQ
(
e
->
«me
, "option4");

268 
	`EXPECT_EQ
(
e
->
vÆ_n
, 3);

269 
	`EXPECT_STR_EQ
(
e
->
vÆs
[0], "foo");

270 
	`EXPECT_STR_EQ
(
e
->
vÆs
[1], "bar");

271 
	`EXPECT_STR_EQ
(
e
->
vÆs
[2], "baz");

272 
	`EXPECT_NULL
(
e
->
vÆs
[3]);

274 
	`EXPECT_EQ
(
e
->
©å_n
, 2);

275 
	`EXPECT_STR_EQ
(
e
->
©ås
[0].
key
, "attr1");

276 
	`EXPECT_STR_EQ
(
e
->
©ås
[0].
vÆ
, "val1");

277 
	`EXPECT_STR_EQ
(
e
->
©ås
[1].
key
, "attr2");

278 
	`EXPECT_STR_EQ
(
e
->
©ås
[1].
vÆ
, "val2");

279 
	`EXPECT_NULL
(
e
->
©ås
[2].
key
);

280 
	`EXPECT_NULL
(
e
->
©ås
[2].
vÆ
);

283 
	}
}

285 
	$TEST
(
cfg_∑r£r
, 
puts_∑r£d_vÆs_to_íåy
)

287 
boﬁ
 
›ti⁄1_is_checked
 = 
Ál£
;

288 
boﬁ
 
›ti⁄2_is_checked
 = 
Ál£
;

289 
boﬁ
 
›ti⁄3_is_checked
 = 
Ál£
;

290 
boﬁ
 
›ti⁄4_is_checked
 = 
Ál£
;

292 
TfwCfgS≥c
 
•ecs
[] = {

293 { "›ti⁄1", 
NULL
, 
cb_›ti⁄1
, &
›ti⁄1_is_checked
 },

294 { "›ti⁄2", 
NULL
, 
cb_›ti⁄2
, &
›ti⁄2_is_checked
 },

295 { "›ti⁄3", 
NULL
, 
cb_›ti⁄3
, &
›ti⁄3_is_checked
 },

296 { "›ti⁄4", 
NULL
, 
cb_›ti⁄4
, &
›ti⁄4_is_checked
 },

300 
r
 = 
	`∑r£_cfg
(
›ts_cfg_ãxt
, 
•ecs
);

302 
	`EXPECT_OK
(
r
);

303 
	`EXPECT_TRUE
(
›ti⁄1_is_checked
);

304 
	`EXPECT_TRUE
(
›ti⁄2_is_checked
);

305 
	`EXPECT_TRUE
(
›ti⁄3_is_checked
);

306 
	`EXPECT_TRUE
(
›ti⁄4_is_checked
);

307 
	}
}

310 
	$cb_cm¡ws
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

312 *
cou¡î
 = 
cs
->
de°
;

313 ++(*
cou¡î
);

315 
	`EXPECT_STR_EQ
(
e
->
«me
, "cmntws");

316 
	`EXPECT_EQ
(
e
->
vÆ_n
, 3);

317 
	`EXPECT_STR_EQ
(
e
->
vÆs
[0], "foo");

318 
	`EXPECT_STR_EQ
(
e
->
vÆs
[1], "bar");

319 
	`EXPECT_STR_EQ
(
e
->
vÆs
[2], "baz");

322 
	}
}

324 
	$TEST
(
cfg_∑r£r
, 
óts_commíts_™d_whôe•a˚
)

326 
˘r
 = 0;

327 
TfwCfgS≥c
 
•ecs
[] = {

328 { "cm¡ws", 
NULL
, 
cb_cm¡ws
, &
˘r
, .
Ælow_ª≥©
 = 
åue
 },

331 c⁄° *
cfg_ãxt
 =

338 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

339 
	`EXPECT_OK
(
r
);

340 
	`EXPECT_EQ
(
˘r
, 2);

341 
	}
}

344 
	$cb_qtd°r
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

346 *
cou¡î
 = 
cs
->
de°
;

347 ++(*
cou¡î
);

349 
	`EXPECT_EQ
(
e
->
vÆ_n
, 1);

350 
	`EXPECT_STR_EQ
(
e
->
«me
, "qtdstr");

351 
	`EXPECT_STR_EQ
(
e
->
vÆs
[0], " foo \t\r\n bar \"#\" baz \\");

354 
	}
}

356 
	$TEST
(
cfg_∑r£r
, 
h™dÀs_quŸed_°rögs
)

358 
˘r
 = 0;

359 
TfwCfgS≥c
 
•ecs
[] = {

360 { "qtd°r", 
NULL
, 
cb_qtd°r
, &
˘r
, .
Ælow_ª≥©
 = 
åue
 },

363 c⁄° *
cfg_ãxt
 =

369 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

370 
	`EXPECT_OK
(
r
);

371 
	`EXPECT_EQ
(
˘r
, 2);

372 
	}
}

375 
	$cb_esˇ≥d
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

377 *
cou¡î
 = 
cs
->
de°
;

378 ++(*
cou¡î
);

380 
	`EXPECT_EQ
(
e
->
vÆ_n
, 1);

381 
	`EXPECT_STR_EQ
(
e
->
«me
, "escaped");

382 
	`EXPECT_STR_EQ
(
e
->
vÆs
[0], " \r\n#\";\\");

385 
	}
}

387 
	$TEST
(
cfg_∑r£r
, 
h™dÀs_esˇ≥d_•ecül_ch¨a˘îs
)

389 
˘r
 = 0;

391 
TfwCfgS≥c
 
•ecs
[] = {

392 { "esˇ≥d", 
NULL
, 
cb_esˇ≥d
, &
˘r
 },

398 
r
 = 
	`∑r£_cfg
("esˇ≥d \\ \\\r\\\n\\#\\\"\\;\\\\;", 
•ecs
);

399 
	`EXPECT_OK
(
r
);

400 
	`EXPECT_EQ
(
˘r
, 1);

401 
	}
}

404 
	$cb_deÊt_u£d
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

406 *
cou¡î
 = 
cs
->
de°
;

407 ++(*
cou¡î
);

409 
	`EXPECT_STR_EQ
(
e
->
«me
, "deflt_used");

411 
	`EXPECT_EQ
(
e
->
vÆ_n
, 2);

412 
	`EXPECT_STR_EQ
(
e
->
vÆs
[0], "val1");

413 
	`EXPECT_STR_EQ
(
e
->
vÆs
[1], "val2");

415 
	`EXPECT_EQ
(
e
->
©å_n
, 2);

416 
	`EXPECT_STR_EQ
(
e
->
©ås
[0].
key
, "k1");

417 
	`EXPECT_STR_EQ
(
e
->
©ås
[0].
vÆ
, "v1");

418 
	`EXPECT_STR_EQ
(
e
->
©ås
[1].
key
, "k2");

419 
	`EXPECT_STR_EQ
(
e
->
©ås
[1].
vÆ
, "v2");

422 
	}
}

425 
	$cb_deÊt_unu£d
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
e
)

427 *
cou¡î
 = 
cs
->
de°
;

428 ++(*
cou¡î
);

430 
	`EXPECT_EQ
(
e
->
vÆ_n
, 1);

431 
	`EXPECT_STR_EQ
(
e
->
«me
, "deflt_unused");

432 
	`EXPECT_STR_EQ
(
e
->
vÆs
[0], "the value from cfg_text");

435 
	}
}

437 
	$TEST
(
cfg_∑r£r
, 
simuœãs_deÁu…_vÆues
)

439 
˘rs
[3] = { 0 };

441 
TfwCfgS≥c
 
•ecs
[] = {

444 
cb_deÊt_u£d
,

445 &
˘rs
[0]

449 
cb_deÊt_unu£d
,

450 &
˘rs
[1]

454 
NULL
,

455 
cb_ö¸_˘r
,

456 &
˘rs
[2],

457 .
Ælow_n⁄e
 = 
åue


461 c⁄° *
cfg_ãxt
 = "deflt_unused \"the value from cfg_text\";";

463 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

464 
	`EXPECT_OK
(
r
);

465 
	`EXPECT_EQ
(
˘rs
[0], 1);

466 
	`EXPECT_EQ
(
˘rs
[1], 1);

467 
	`EXPECT_EQ
(
˘rs
[2], 0);

468 
	}
}

470 
	$TEST
(
cfg_∑r£r
, 
övokes_˛ónup_ˇŒback
)

472 
ˇŒ_˘rs
[5] = { 0 };

473 
˛ónup_˘rs
[5] = { 0 };

474 
r
;

476 
TfwCfgS≥c
 
•ecs
[] = {

478 "sögÀ", 
NULL
,

479 
cb_ö¸_˘r
,

480 &
ˇŒ_˘rs
[0],

481 &
˛ónup_˘rs
[0],

482 .
˛ónup
 = 
˛ónup_ö¸_˘r


485 "ª≥©", 
NULL
,

486 
cb_ö¸_˘r
,

487 &
ˇŒ_˘rs
[1],

488 &
˛ónup_˘rs
[1],

489 .
˛ónup
 = 
˛ónup_ö¸_˘r
,

490 .
Ælow_ª≥©
 = 
åue


494 
cb_ö¸_˘r
,

495 &
ˇŒ_˘rs
[2],

496 &
˛ónup_˘rs
[2],

497 .
˛ónup
 = 
˛ónup_ö¸_˘r


500 "n⁄e", 
NULL
,

501 
cb_ö¸_˘r
,

502 &
ˇŒ_˘rs
[3],

503 &
˛ónup_˘rs
[3],

504 .
˛ónup
 = 
˛ónup_ö¸_˘r
,

505 .
Ælow_n⁄e
 = 
åue


508 "îr", 
NULL
,

509 
cb_ö¸_˘r_îr
,

510 &
ˇŒ_˘rs
[4],

511 &
˛ónup_˘rs
[4],

512 .
˛ónup
 = 
˛ónup_ö¸_˘r
,

513 .
Ælow_n⁄e
 = 
åue


519 
r
 = 
	`∑r£_cfg
("sögÀ;Ñïót;Ñïót;Ñïót;", 
•ecs
);

520 
	`EXPECT_OK
(
r
);

521 
	`EXPECT_EQ
(
ˇŒ_˘rs
[0], 1);

522 
	`EXPECT_EQ
(
ˇŒ_˘rs
[1], 3);

523 
	`EXPECT_EQ
(
ˇŒ_˘rs
[2], 1);

524 
	`EXPECT_EQ
(
ˇŒ_˘rs
[3], 0);

525 
	`EXPECT_EQ
(
ˇŒ_˘rs
[4], 0);

526 
	`EXPECT_EQ
(
˛ónup_˘rs
[0], 1);

527 
	`EXPECT_EQ
(
˛ónup_˘rs
[1], 1);

528 
	`EXPECT_EQ
(
˛ónup_˘rs
[2], 1);

529 
	`EXPECT_EQ
(
˛ónup_˘rs
[3], 0);

530 
	`EXPECT_EQ
(
˛ónup_˘rs
[4], 0);

536 
	`mem£t
(
ˇŒ_˘rs
, 0, (call_ctrs));

537 
	`mem£t
(
˛ónup_˘rs
, 0, (
ˇŒ_˘rs
));

538 
r
 = 
	`∑r£_cfg
("sögÀ;Ñïót;Ñïót;Éº;Ñïót;", 
•ecs
);

539 
	`EXPECT_ERROR
(
r
);

540 
	`EXPECT_EQ
(
ˇŒ_˘rs
[0], 1);

541 
	`EXPECT_EQ
(
ˇŒ_˘rs
[1], 2);

542 
	`EXPECT_EQ
(
ˇŒ_˘rs
[2], 0);

543 
	`EXPECT_EQ
(
ˇŒ_˘rs
[3], 0);

544 
	`EXPECT_EQ
(
ˇŒ_˘rs
[4], 1);

545 
	`EXPECT_EQ
(
˛ónup_˘rs
[0], 1);

546 
	`EXPECT_EQ
(
˛ónup_˘rs
[1], 1);

547 
	`EXPECT_EQ
(
˛ónup_˘rs
[2], 0);

548 
	`EXPECT_EQ
(
˛ónup_˘rs
[3], 0);

549 
	`EXPECT_EQ
(
˛ónup_˘rs
[4], 1);

550 
	}
}

558 
	$TEST
(
tfw_cfg_£t_boﬁ
, 
åóts_novÆ_as_åue_Êag
)

562 
Êag1_cfgãxt
 = 42;

563 
Êag2_n⁄e
 = 42;

564 
Êag3_def_åue
 = 42;

565 
Êag4_def_Ál£
 = 42;

567 
TfwCfgS≥c
 
•ecs
[] = {

569 "Êag1", 
NULL
,

570 
tfw_cfg_£t_boﬁ
,

571 &
Êag1_cfgãxt


574 "Êag2", 
NULL
,

575 
tfw_cfg_£t_boﬁ
,

576 &
Êag2_n⁄e
,

577 .
Ælow_n⁄e
 = 
åue


581 
tfw_cfg_£t_boﬁ
,

582 &
Êag3_def_åue


586 
tfw_cfg_£t_boﬁ
,

587 &
Êag4_def_Ál£


592 
r
 = 
	`∑r£_cfg
("Êag1;", 
•ecs
);

594 
	`EXPECT_OK
(
r
);

595 
	`EXPECT_EQ
(
Êag1_cfgãxt
, 
åue
);

596 
	`EXPECT_EQ
(
Êag2_n⁄e
, 42);

597 
	`EXPECT_EQ
(
Êag3_def_åue
, 
åue
);

598 
	`EXPECT_EQ
(
Êag4_def_Ál£
, 
Ál£
);

600 
	`BUILD_BUG_ON
((Ë!(
boﬁ
));

601 
	}
}

603 
	$TEST
(
tfw_cfg_£t_boﬁ
, 
ªcognizes_åuthy_Álsy_vÆues
)

605 
r
;

606 
boﬁ
 
b1
, 
b2
, 
b3
, 
b4
, 
b5
, 
b6
, 
b7
, 
b8
, 
b9
, 
b10
, 
b11
, 
b12
;

608 c⁄° *
cfg_ãxt
 =

622 
TfwCfgS≥c
 
•ecs
[] = {

623 { "›ti⁄1", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b1
 },

624 { "›ti⁄2", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b2
 },

625 { "›ti⁄3", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b3
 },

626 { "›ti⁄4", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b4
 },

627 { "›ti⁄5", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b5
 },

628 { "›ti⁄6", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b6
 },

629 { "›ti⁄7", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b7
 },

630 { "›ti⁄8", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b8
 },

631 { "›ti⁄9", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b9
 },

632 { "›ti⁄10", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b10
 },

633 { "›ti⁄11", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b11
 },

634 { "›ti⁄12", 
NULL
, 
tfw_cfg_£t_boﬁ
, &
b12
 },

638 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

640 
	`EXPECT_OK
(
r
);

641 
	`EXPECT_TRUE
(
b1
);

642 
	`EXPECT_TRUE
(
b3
);

643 
	`EXPECT_TRUE
(
b5
);

644 
	`EXPECT_TRUE
(
b7
);

645 
	`EXPECT_TRUE
(
b9
);

646 
	`EXPECT_TRUE
(
b11
);

647 
	`EXPECT_FALSE
(
b2
);

648 
	`EXPECT_FALSE
(
b4
);

649 
	`EXPECT_FALSE
(
b6
);

650 
	`EXPECT_FALSE
(
b8
);

651 
	`EXPECT_FALSE
(
b10
);

652 
	`EXPECT_FALSE
(
b12
);

653 
	}
}

655 
	$TEST
(
tfw_cfg_£t_öt
, 
£ts_de°_vÆue
)

657 
vÆ
 = 0;

658 
TfwCfgS≥c
 
•ecs
[] = {

659 { "vÆ", 
NULL
, 
tfw_cfg_£t_öt
, &
vÆ
 },

663 
	`∑r£_cfg
("vÆ 42;", 
•ecs
);

665 
	`EXPECT_EQ
(
vÆ
, 42);

666 
	}
}

668 
	$TEST
(
tfw_cfg_£t_öt
, 
ªcognizes_dec_hex_bö_ba£s
)

670 
r
, 
dec1
, 
dec2
, 
dec3
, 
dec4
, 
hex1
, 
hex2
, 
hex3
, 
hex4
, 
bö1
, 
bö2
, 
bö3
;

672 c⁄° *
cfg_ãxt
 =

685 
TfwCfgS≥c
 
•ecs
[] = {

686 { "dec1", 
NULL
, 
tfw_cfg_£t_öt
, &
dec1
 },

687 { "dec2", 
NULL
, 
tfw_cfg_£t_öt
, &
dec2
 },

688 { "dec3", 
NULL
, 
tfw_cfg_£t_öt
, &
dec3
 },

689 { "dec4", 
NULL
, 
tfw_cfg_£t_öt
, &
dec4
 },

690 { "hex1", 
NULL
, 
tfw_cfg_£t_öt
, &
hex1
 },

691 { "hex2", 
NULL
, 
tfw_cfg_£t_öt
, &
hex2
 },

692 { "hex3", 
NULL
, 
tfw_cfg_£t_öt
, &
hex3
 },

693 { "hex4", 
NULL
, 
tfw_cfg_£t_öt
, &
hex4
 },

694 { "bö1", 
NULL
, 
tfw_cfg_£t_öt
, &
bö1
 },

695 { "bö2", 
NULL
, 
tfw_cfg_£t_öt
, &
bö2
 },

696 { "bö3", 
NULL
, 
tfw_cfg_£t_öt
, &
bö3
 },

700 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

702 
	`EXPECT_OK
(
r
);

703 
	`EXPECT_EQ
(
dec1
, 0);

704 
	`EXPECT_EQ
(
dec2
, 1234567890);

705 
	`EXPECT_EQ
(
dec3
, -1234567890);

706 
	`EXPECT_EQ
(
dec4
, 24);

707 
	`EXPECT_EQ
(
hex1
, 0x0);

708 
	`EXPECT_EQ
(
hex2
, 0xDEAD);

709 
	`EXPECT_EQ
(
hex3
, 0x00123);

710 
	`EXPECT_EQ
(
hex4
, 0x01a);

711 
	`EXPECT_EQ
(
bö1
, 0);

712 
	`EXPECT_EQ
(
bö2
, 0x3D);

713 
	`EXPECT_EQ
(
bö3
, 0x4);

714 
	}
}

716 
	$TEST
(
tfw_cfg_£t_öt
, 
checks_ext_ª°ri˘i⁄s
)

718 
r
, 
vÆ
;

719 
TfwCfgS≥c
 
•ecs
[] = {

721 "vÆ", 
NULL
,

722 
tfw_cfg_£t_öt
,

723 &
vÆ
,

724 &(
TfwCfgS≥cI¡
) {

725 .
mu…ùÀ_of
 = 2,

726 .
ønge
 = { 10, 20 }

734 
r
 = 
	`∑r£_cfg
("vÆ -16;", 
•ecs
);

735 
	`EXPECT_ERROR
(
r
);

737 
r
 = 
	`∑r£_cfg
("vÆ 0;", 
•ecs
);

738 
	`EXPECT_ERROR
(
r
);

740 
r
 = 
	`∑r£_cfg
("vÆ 2;", 
•ecs
);

741 
	`EXPECT_ERROR
(
r
);

743 
r
 = 
	`∑r£_cfg
("vÆ 9;", 
•ecs
);

744 
	`EXPECT_ERROR
(
r
);

746 
r
 = 
	`∑r£_cfg
("vÆ 10;", 
•ecs
);

747 
	`EXPECT_OK
(
r
);

748 
	`EXPECT_EQ
(
vÆ
, 10);

750 
r
 = 
	`∑r£_cfg
("vÆ 15;", 
•ecs
);

751 
	`EXPECT_ERROR
(
r
);

753 
r
 = 
	`∑r£_cfg
("vÆ 16;", 
•ecs
);

754 
	`EXPECT_OK
(
r
);

755 
	`EXPECT_EQ
(
vÆ
, 16);

757 
r
 = 
	`∑r£_cfg
("vÆ 20;", 
•ecs
);

758 
	`EXPECT_OK
(
r
);

759 
	`EXPECT_EQ
(
vÆ
, 20);

761 
r
 = 
	`∑r£_cfg
("vÆ 21;", 
•ecs
);

762 
	`EXPECT_ERROR
(
r
);

764 
r
 = 
	`∑r£_cfg
("vÆ 65536;", 
•ecs
);

765 
	`EXPECT_ERROR
(
r
);

766 
	}
}

768 
	$TEST
(
tfw_cfg_£t_öt
, 
m≠s_íum_keyw‹ds
)

770 
r
, 
vÆ
;

771 
TfwCfgEnum
 
vÆ_m≠pögs
[] = {

776 
TfwCfgS≥c
 
•ecs
[] = {

778 "vÆ", 
NULL
,

779 
tfw_cfg_£t_öt
,

780 &
vÆ
,

781 &(
TfwCfgS≥cI¡
) {

782 .
íums
 = 
vÆ_m≠pögs


788 
r
 = 
	`∑r£_cfg
("vÆ 222;", 
•ecs
);

789 
	`EXPECT_OK
(
r
);

790 
	`EXPECT_EQ
(
vÆ
, 222);

792 
r
 = 
	`∑r£_cfg
("vÆ off;", 
•ecs
);

793 
	`EXPECT_OK
(
r
);

794 
	`EXPECT_EQ
(
vÆ
, -1);

796 
r
 = 
	`∑r£_cfg
("vÆáuto;", 
•ecs
);

797 
	`EXPECT_OK
(
r
);

798 
	`EXPECT_EQ
(
vÆ
, 42);

800 
r
 = 
	`∑r£_cfg
("vÆ -1;", 
•ecs
);

801 
	`EXPECT_OK
(
r
);

802 
	`EXPECT_EQ
(
vÆ
, -1);

803 
	}
}

805 
	$TEST
(
tfw_cfg_öãrvÆ
, 
tfw_cfg_∑r£_ötvl
)

807 
r
;

808 
i0
, 
i1
;

810 
i0
 = 
i1
 = 0;

811 
r
 = 
	`tfw_cfg_∑r£_ötvl
("30", &
i0
, &
i1
);

812 
	`EXPECT_OK
(
r
);

813 
	`EXPECT_TRUE
(
i0
 =30 && 
i1
 == 0);

815 
i0
 = 
i1
 = 0;

816 
r
 = 
	`tfw_cfg_∑r£_ötvl
("0x30-1000", &
i0
, &
i1
);

817 
	`EXPECT_OK
(
r
);

818 
	`EXPECT_TRUE
(
i0
 =0x30 && 
i1
 == 1000);

820 
i0
 = 
i1
 = 0;

821 
r
 = 
	`tfw_cfg_∑r£_ötvl
("0x0", &
i0
, &
i1
);

822 
	`EXPECT_OK
(
r
);

823 
	`EXPECT_TRUE
(
i0
 =0 && 
i1
 == 0);

825 
i0
 = 
i1
 = 0;

826 
r
 = 
	`tfw_cfg_∑r£_ötvl
("0", &
i0
, &
i1
);

827 
	`EXPECT_OK
(
r
);

828 
	`EXPECT_TRUE
(
i0
 =0 && 
i1
 == 0);

830 
i0
 = 
i1
 = 0;

831 
r
 = 
	`tfw_cfg_∑r£_ötvl
("0-0x0", &
i0
, &
i1
);

832 
	`EXPECT_ERROR
(
r
);

834 
i0
 = 
i1
 = 0;

835 
r
 = 
	`tfw_cfg_∑r£_ötvl
("1-0", &
i0
, &
i1
);

836 
	`EXPECT_ERROR
(
r
);

838 
i0
 = 
i1
 = 0;

839 
r
 = 
	`tfw_cfg_∑r£_ötvl
("7-", &
i0
, &
i1
);

840 
	`EXPECT_ERROR
(
r
);

842 
i0
 = 
i1
 = 0;

843 
r
 = 
	`tfw_cfg_∑r£_ötvl
("70--88", &
i0
, &
i1
);

844 
	`EXPECT_ERROR
(
r
);

845 
	}
}

847 
	$TEST
(
tfw_cfg_£t_°r
, 
£ts_de°_°r
)

849 
r
;

850 c⁄° *
°r1
 = 
NULL
;

851 c⁄° *
°r2
 = 
NULL
;

852 c⁄° *
°r3
 = 
NULL
;

853 c⁄° *
°r4
 = 
NULL
;

854 
TfwCfgS≥c
 
•ecs
[] = {

855 { "°r1", 
NULL
, 
tfw_cfg_£t_°r
, &
°r1
 },

856 { "°r2", 
NULL
, 
tfw_cfg_£t_°r
, &
°r2
 },

857 { "°r3", 
NULL
, 
tfw_cfg_£t_°r
, &
°r3
 },

858 { "°r4", 
NULL
, 
tfw_cfg_£t_°r
, &
°r4
 },

861 c⁄° *
cfg_ãxt
 =

867 
r
 = 
	`do_∑r£_cfg
(
cfg_ãxt
, 
•ecs
);

868 
	`EXPECT_OK
(
r
);

870 
	`EXPECT_NOT_NULL
(
°r1
);

871 
	`EXPECT_NOT_NULL
(
°r2
);

872 
	`EXPECT_NOT_NULL
(
°r3
);

873 
	`EXPECT_NOT_NULL
(
°r4
);

874 
	`EXPECT_STR_EQ
(
°r1
, "foo");

875 
	`EXPECT_STR_EQ
(
°r2
, "foo bar baz");

876 
	`EXPECT_STR_EQ
(
°r3
, "foo bar baz");

877 
	`EXPECT_STR_EQ
(
°r4
, "");

879 
	`do_˛ónup_cfg
();

880 
	}
}

882 
	$TEST
(
tfw_cfg_£t_°r
, 
£ts_de°_°r_em±y_°rög
)

884 
r
;

885 c⁄° *
°r
 = 
NULL
;

886 
TfwCfgS≥c
 
•ecs
[] = {

887 { "°r", 
NULL
, 
tfw_cfg_£t_°r
, &
°r
 },

891 
r
 = 
	`do_∑r£_cfg
("°r;", 
•ecs
);

892 
	`EXPECT_ERROR
(
r
);

893 
	`do_˛ónup_cfg
();

895 
r
 = 
	`do_∑r£_cfg
("°∏;", 
•ecs
);

896 
	`EXPECT_ERROR
(
r
);

897 
	`do_˛ónup_cfg
();

899 
r
 = 
	`do_∑r£_cfg
("°∏\"\";", 
•ecs
);

900 
	`EXPECT_OK
(
r
);

901 
	`EXPECT_STR_EQ
(
°r
, "");

902 
	`do_˛ónup_cfg
();

903 
	}
}

905 
	$TEST
(
tfw_cfg_£t_°r
, 
checks_°æí
)

907 
r
;

908 c⁄° *
°r
 = 
NULL
;

909 
TfwCfgS≥c
 
•ecs
[] = {

911 "°r", 
NULL
,

912 
tfw_cfg_£t_°r
,

913 &
°r
,

914 &(
TfwCfgS≥cSå
) {

915 .
Àn_ønge
 = { 2, 8 }

921 
r
 = 
	`do_∑r£_cfg
("°∏1;", 
•ecs
);

922 
	`EXPECT_ERROR
(
r
);

923 
	`do_˛ónup_cfg
();

925 
r
 = 
	`do_∑r£_cfg
("°∏12;", 
•ecs
);

926 
	`EXPECT_OK
(
r
);

927 
	`EXPECT_STR_EQ
(
°r
, "12");

928 
	`do_˛ónup_cfg
();

930 
r
 = 
	`do_∑r£_cfg
("°∏123;", 
•ecs
);

931 
	`EXPECT_OK
(
r
);

932 
	`EXPECT_STR_EQ
(
°r
, "123");

933 
	`do_˛ónup_cfg
();

935 
r
 = 
	`do_∑r£_cfg
("°∏\"12345\";", 
•ecs
);

936 
	`EXPECT_OK
(
r
);

937 
	`EXPECT_STR_EQ
(
°r
, "12345");

938 
	`do_˛ónup_cfg
();

940 
r
 = 
	`do_∑r£_cfg
("°∏12345678;", 
•ecs
);

941 
	`EXPECT_OK
(
r
);

942 
	`EXPECT_STR_EQ
(
°r
, "12345678");

943 
	`do_˛ónup_cfg
();

945 
r
 = 
	`do_∑r£_cfg
("°∏123456789;", 
•ecs
);

946 
	`EXPECT_ERROR
(
r
);

947 
	`do_˛ónup_cfg
();

948 
	}
}

950 
	$TEST
(
tfw_cfg_£t_°r
, 
checks_ch¨a˘î_£t
)

952 
r
;

953 c⁄° *
°r
 = 
NULL
;

954 
TfwCfgS≥c
 
•ecs
[] = {

956 "hex", 
NULL
,

957 
tfw_cfg_£t_°r
,

958 &
°r
,

959 &(
TfwCfgS≥cSå
) {

960 .
c£t
 = "1234567890abcdefABCDEF"

966 
r
 = 
	`do_∑r£_cfg
("hex \"\";", 
•ecs
);

967 
	`EXPECT_OK
(
r
);

968 
	`EXPECT_STR_EQ
(
°r
, "");

969 
	`do_˛ónup_cfg
();

971 
r
 = 
	`do_∑r£_cfg
("hexá;", 
•ecs
);

972 
	`EXPECT_OK
(
r
);

973 
	`EXPECT_STR_EQ
(
°r
, "a");

974 
	`do_˛ónup_cfg
();

976 
r
 = 
	`do_∑r£_cfg
("hex 412dfBA;", 
•ecs
);

977 
	`EXPECT_OK
(
r
);

978 
	`EXPECT_STR_EQ
(
°r
, "412dfBA");

979 
	`do_˛ónup_cfg
();

981 
r
 = 
	`do_∑r£_cfg
("hex 4z2;", 
•ecs
);

982 
	`EXPECT_ERROR
(
r
);

983 
	`do_˛ónup_cfg
();

985 
r
 = 
	`do_∑r£_cfg
("hexábc!;", 
•ecs
);

986 
	`EXPECT_ERROR
(
r
);

987 
	`do_˛ónup_cfg
();

989 
r
 = 
	`do_∑r£_cfg
("hex -42;", 
•ecs
);

990 
	`EXPECT_ERROR
(
r
);

991 
	`do_˛ónup_cfg
();

992 
	}
}

994 
	$TEST
(
tfw_cfg_h™dÀ_chûdªn
, 
∑r£s_√°ed_íåõs_ªcursivñy
)

996 
cou¡î1
 = 0;

997 
cou¡î2
 = 0;

998 
cou¡î3
 = 0;

1000 
TfwCfgS≥c
 
£˘i⁄1_•ecs
[] = {

1001 { "ö¸", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î1
, .
Ælow_ª≥©
 = 
åue
 },

1002 { "de¸", 
NULL
, 
cb_de¸_˘r
, &
cou¡î1
, .
Ælow_ª≥©
 = 
åue
 },

1005 
TfwCfgS≥c
 
£˘i⁄2_•ecs
[] = {

1006 { "ö¸", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î2
, .
Ælow_ª≥©
 = 
åue
 },

1007 { "de¸", 
NULL
, 
cb_de¸_˘r
, &
cou¡î2
, .
Ælow_ª≥©
 = 
åue
 },

1010 
TfwCfgS≥c
 
roŸ_•ecs
[] = {

1011 { "£˘i⁄1", 
NULL
, 
tfw_cfg_h™dÀ_chûdªn
, 
£˘i⁄1_•ecs
,

1012 .
˛ónup
 = 
tfw_cfg_˛ónup_chûdªn
 },

1013 { "£˘i⁄2", 
NULL
, 
tfw_cfg_h™dÀ_chûdªn
, 
£˘i⁄2_•ecs
,

1014 .
˛ónup
 = 
tfw_cfg_˛ónup_chûdªn
 },

1015 { "ö¸", 
NULL
, 
cb_ö¸_˘r
, &
cou¡î3
, .
Ælow_ª≥©
 = 
åue
 },

1016 { "de¸", 
NULL
, 
cb_de¸_˘r
, &
cou¡î3
, .
Ælow_ª≥©
 = 
åue
 },

1020 c⁄° *
cfg_ãxt
 =

1039 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
roŸ_•ecs
);

1041 
	`EXPECT_OK
(
r
);

1042 
	`EXPECT_EQ
(
cou¡î1
, 1);

1043 
	`EXPECT_EQ
(
cou¡î2
, 2);

1044 
	`EXPECT_EQ
(
cou¡î3
, 3);

1045 
	}
}

1047 
	$TEST
(
tfw_cfg_h™dÀ_chûdªn
, 
¥›ag©es_˛ónup_to_√°ed_•ecs
)

1049 
ˇŒ_˘r
 = 0;

1050 
˛ónup_˘r
 = 0;

1052 
TfwCfgS≥c
 
√°ed_•ecs
[] = {

1054 "íåy", 
NULL
,

1055 
cb_ö¸_˘r
,

1056 &
ˇŒ_˘r
,

1057 &
˛ónup_˘r
,

1058 .
˛ónup
 = 
˛ónup_ö¸_˘r
,

1059 .
Ælow_ª≥©
 = 
åue
,

1060 .
Ælow_n⁄e
 = 
åue


1064 
TfwCfgS≥c
 
roŸ_•ecs
[] = {

1066 "£˘i⁄", 
NULL
,

1067 
tfw_cfg_h™dÀ_chûdªn
,

1068 
√°ed_•ecs
,

1069 .
Ælow_ª≥©
 = 
åue
,

1070 .
˛ónup
 = 
tfw_cfg_˛ónup_chûdªn


1074 c⁄° *
cfg_ãxt
 =

1087 
r
 = 
	`∑r£_cfg
(
cfg_ãxt
, 
roŸ_•ecs
);

1089 
	`EXPECT_OK
(
r
);

1090 
	`EXPECT_EQ
(
ˇŒ_˘r
, 5);

1091 
	`EXPECT_EQ
(
˛ónup_˘r
, 1);

1092 
	}
}

1094 
	$TEST_SUITE
(
cfg
)

1096 
	`TEST_RUN
(
cfg_∑r£r
, 
övokes_•ecifõd_h™dÀr
);

1097 
	`TEST_RUN
(
cfg_∑r£r
, 
Ælows_ª≥©ög_íåõs
);

1098 
	`TEST_RUN
(
cfg_∑r£r
, 
Ælows_›ti⁄Æ_íåõs
);

1099 
	`TEST_RUN
(
cfg_∑r£r
, 
puts_∑r£d_vÆs_to_íåy
);

1100 
	`TEST_RUN
(
cfg_∑r£r
, 
óts_commíts_™d_whôe•a˚
);

1101 
	`TEST_RUN
(
cfg_∑r£r
, 
h™dÀs_quŸed_°rögs
);

1102 
	`TEST_RUN
(
cfg_∑r£r
, 
h™dÀs_esˇ≥d_•ecül_ch¨a˘îs
);

1103 
	`TEST_RUN
(
cfg_∑r£r
, 
simuœãs_deÁu…_vÆues
);

1104 
	`TEST_RUN
(
cfg_∑r£r
, 
övokes_˛ónup_ˇŒback
);

1106 
	`TEST_RUN
(
tfw_cfg_£t_boﬁ
, 
åóts_novÆ_as_åue_Êag
);

1107 
	`TEST_RUN
(
tfw_cfg_£t_boﬁ
, 
ªcognizes_åuthy_Álsy_vÆues
);

1108 
	`TEST_RUN
(
tfw_cfg_£t_öt
, 
£ts_de°_vÆue
);

1109 
	`TEST_RUN
(
tfw_cfg_£t_öt
, 
ªcognizes_dec_hex_bö_ba£s
);

1110 
	`TEST_RUN
(
tfw_cfg_£t_öt
, 
checks_ext_ª°ri˘i⁄s
);

1111 
	`TEST_RUN
(
tfw_cfg_£t_öt
, 
m≠s_íum_keyw‹ds
);

1112 
	`TEST_RUN
(
tfw_cfg_öãrvÆ
, 
tfw_cfg_∑r£_ötvl
);

1113 
	`TEST_RUN
(
tfw_cfg_£t_°r
, 
£ts_de°_°r
);

1114 
	`TEST_RUN
(
tfw_cfg_£t_°r
, 
£ts_de°_°r_em±y_°rög
);

1115 
	`TEST_RUN
(
tfw_cfg_£t_°r
, 
checks_°æí
);

1116 
	`TEST_RUN
(
tfw_cfg_£t_°r
, 
checks_ch¨a˘î_£t
);

1117 
	`TEST_RUN
(
tfw_cfg_h™dÀ_chûdªn
, 
∑r£s_√°ed_íåõs_ªcursivñy
);

1118 
	`TEST_RUN
(
tfw_cfg_h™dÀ_chûdªn
, 
¥›ag©es_˛ónup_to_√°ed_•ecs
);

1119 
	}
}

	@t/unit/test_hash.c

22 
	~<löux/bug.h
>

24 
	~"°r.h
"

25 
	~"ã°.h
"

27 
tfw_hash_°r
(c⁄° 
TfwSå
 *
°r
);

31 
	$TEST
(
tfw_hash_°r
, 
ˇlcs_diff_hash_f‹_diff_°r
)

37 
TfwSå
 
s1
 = { .
Àn
 = 10, .
±r
 = (*)"foobarbaz1" };

38 
TfwSå
 
s2
 = { .
Àn
 = 10, .
±r
 = (*)"Foobarbaz1" };

39 
TfwSå
 
s3
 = { .
Àn
 = 10, .
±r
 = (*)"foobarbaz2" };

40 
TfwSå
 
s4
 = { .
Àn
 = 9, .
±r
 = (*)"foobarbaz" };

41 
TfwSå
 
s5
 = { .
Àn
 = 11, .
±r
 = (*)"foobarbaz11" };

42 
TfwSå
 
s6
 = { .
Àn
 = 0, .
±r
 = (*)"" };

44 
h
[] = {

45 
	`tfw_hash_°r
(&
s1
),

46 
	`tfw_hash_°r
(&
s2
),

47 
	`tfw_hash_°r
(&
s3
),

48 
	`tfw_hash_°r
(&
s4
),

49 
	`tfw_hash_°r
(&
s5
),

50 
	`tfw_hash_°r
(&
s6
),

53 
i
, 
j
;

54 
i
 = 0; i < 
	`ARRAY_SIZE
(
h
); ++i) {

55 
j
 = 0; j < 
	`ARRAY_SIZE
(
h
); ++j) {

56 i‡(
i
 !
j
 && 
h
[i] == h[j])

57 
	`TEST_FAIL
("Equal hashes: h[%d] => %#lx, "

58 "[%d] => %#lx", 
i
, 
h
[i], 
j
, h[j]);

61 
	}
}

63 
	$TEST
(
tfw_hash_°r
, 
ˇlcs_ßme_hash_f‹_diff_chunks_n
)

65 
h1
, 
h2
, 
h3
;

67 
TfwSå
 
s1
 = { .
Àn
 = 17, .
±r
 = (*)"Host:Éxample.com" };

69 
TfwSå
 
s2c1
 = { .
Àn
 = 14, .
±r
 = (*)"Host:Éxample." };

70 
TfwSå
 
s2c2
 = { .
Àn
 = 3, .
±r
 = (*)"com" };

71 
TfwSå
 
s2chunks
[] = { 
s2c1
, 
s2c2
 };

72 
TfwSå
 
s2
 = {

73 .
Àn
 = 14 + 3,

74 .
±r
 = 
s2chunks


77 
TfwSå
 
s3c1
 = { .
Àn
 = 1, .
±r
 = (*)"H" };

78 
TfwSå
 
s3c2
 = { .
Àn
 = 0, .
±r
 = (*)"" };

79 
TfwSå
 
s3c3
 = { .
Àn
 = 3, .
±r
 = (*)"ost" };

80 
TfwSå
 
s3c4
 = { .
Àn
 = 1, .
±r
 = (*)":" };

81 
TfwSå
 
s3c5
 = { .
Àn
 = 12, .
±r
 = (*)"Éxample.com" };

82 
TfwSå
 
s3c6
 = { .
Àn
 = 0, .
±r
 = 
NULL
 };

83 
TfwSå
 
s3chunks
[] = { 
s3c1
, 
s3c2
, 
s3c3
, 
s3c4
, 
s3c5
, 
s3c6
 };

84 
TfwSå
 
s3
 = {

85 .
Àn
 = 1 + 0 + 3 + 1 + 12 + 0,

86 .
±r
 = 
s3chunks


89 
	`TFW_STR_CHUNKN_INIT
(&
s2
);

90 
	`__TFW_STR_CHUNKN_SET
(&
s3
, 6);

92 
h1
 = 
	`tfw_hash_°r
(&
s1
);

93 
h2
 = 
	`tfw_hash_°r
(&
s2
);

94 
h3
 = 
	`tfw_hash_°r
(&
s3
);

96 
	`EXPECT_EQ
(
h1
, 
h2
);

97 
	`EXPECT_EQ
(
h1
, 
h3
);

98 
	`EXPECT_EQ
(
h2
, 
h1
);

99 
	`EXPECT_EQ
(
h2
, 
h3
);

100 
	`EXPECT_EQ
(
h3
, 
h1
);

101 
	`EXPECT_EQ
(
h3
, 
h2
);

102 
	}
}

104 
	$TEST
(
tfw_hash_°r
, 
hashes_Æl_ch¨s
)

106 
i
;

107 
h1
, 
h2
;

108 
buf1
[256] = { 0 };

109 
buf2
[256] = { 0 };

110 
TfwSå
 
s1
 = { .
Àn
 = 0, .
±r
 = 
buf1
 };

111 
TfwSå
 
s2
 = { .
Àn
 = 0, .
±r
 = 
buf2
 };

115 
i
 = 0; i < 255; ++i) {

116 
s1
.
Àn
 = 
s2
.À¿(
i
 + 1);

117 
buf1
[
i
] = 'a';

118 
buf2
[
i
] = 'b';

120 
h1
 = 
	`tfw_hash_°r
(&
s1
);

121 
h2
 = 
	`tfw_hash_°r
(&
s2
);

122 i‡(
h1
 =
h2
)

123 
	`TEST_FAIL
("Equal hashes (%#lx) for different strings:\n"

126 
h1
,

127 
	`PR_TFW_STR
(&
s1
), s1.
Àn
,

128 
	`PR_TFW_STR
(&
s2
), s2.
Àn
);

130 
buf2
[
i
] = 'a';

131 
h2
 = 
	`tfw_hash_°r
(&
s2
);

132 i‡(
h1
 !
h2
)

133 
	`TEST_FAIL
("Different hashes forÉqual strings:\n"

136 
h1
, 
	`PR_TFW_STR
(&
s1
), s1.
Àn
,

137 
h2
, 
	`PR_TFW_STR
(&
s2
), s2.
Àn
);

139 
	}
}

141 
	$TEST
(
tfw_hash_°r
, 
d€¢t_ªad_behöd_íd_of_buf
)

143 
buf
[256] = { 0 };

144 
TfwSå
 
s
 = {

145 .
Àn
 = 0,

146 .
±r
 = 
buf


149 
h1
, 
h2
;

150 
i
;

152 
i
 = 0; i < 255; ++i) {

153 
s
.
Àn
 = 
i
;

155 
buf
[
i
] = 'x';

156 
h1
 = 
	`tfw_hash_°r
(&
s
);

158 
	`mem£t
(&
buf
[
i
 + 1], i, ((buf) - i - 1));

159 
h2
 = 
	`tfw_hash_°r
(&
s
);

161 
	`EXPECT_EQ
(
h1
, 
h2
);

163 
	}
}

165 
	$TEST
(
tfw_hash_°r
, 
di°ribuãs_Æl_öput_a¸oss_hash_bôs
)

167 
buf
[31];

168 
TfwSå
 
°r
 = {

169 .
±r
 = 
buf
,

170 .
Àn
 = (
buf
)

173 
h1
, 
h2
;

174 
i
;

176 
	`mem£t
(
buf
, 'a', (buf));

177 
h1
 = 
	`tfw_hash_°r
(&
°r
);

186 
i
 = 0; i < (
buf
) / 2; ++i) {

187 
buf
[
i
] = buf[i + 8] = 'b';

188 
h2
 = 
	`tfw_hash_°r
(&
°r
);

189 
buf
[
i
] = buf[i + 8] = 'a';

191 
	`EXPECT_NE
(
h1
 & 0x00000000000000FF, 
h2
 & 0x00000000000000FF);

192 
	`EXPECT_NE
(
h1
 & 0x000000000000FF00, 
h2
 & 0x000000000000FF00);

193 
	`EXPECT_NE
(
h1
 & 0x0000000000FF0000, 
h2
 & 0x0000000000FF0000);

194 
	`EXPECT_NE
(
h1
 & 0x00000000FF000000, 
h2
 & 0x00000000FF000000);

195 
	`EXPECT_NE
(
h1
 & 0x000000FF00000000, 
h2
 & 0x000000FF00000000);

196 
	`EXPECT_NE
(
h1
 & 0x0000FF0000000000, 
h2
 & 0x0000FF0000000000);

197 
	`EXPECT_NE
(
h1
 & 0x00FF000000000000, 
h2
 & 0x00FF000000000000);

198 
	`EXPECT_NE
(
h1
 & 0xFF00000000000000, 
h2
 & 0xFF00000000000000);

200 
	}
}

202 
	$TEST_SUITE
(
hash
)

204 
	`TEST_RUN
(
tfw_hash_°r
, 
ˇlcs_diff_hash_f‹_diff_°r
);

205 
	`TEST_RUN
(
tfw_hash_°r
, 
ˇlcs_ßme_hash_f‹_diff_chunks_n
);

206 
	`TEST_RUN
(
tfw_hash_°r
, 
hashes_Æl_ch¨s
);

207 
	`TEST_RUN
(
tfw_hash_°r
, 
d€¢t_ªad_behöd_íd_of_buf
);

208 
	`TEST_RUN
(
tfw_hash_°r
, 
di°ribuãs_Æl_öput_a¸oss_hash_bôs
);

209 
	}
}

	@t/unit/test_http_match.c

21 
	~<löux/˘y≥.h
>

23 
	~"hâp_m©ch.h
"

24 
	~"hâp_msg.h
"

26 
	~"ã°.h
"

27 
	~"hñ≥rs.h
"

28 
	~"tfw_°r_hñ≥r.h
"

31 
	mã°_id
;

32 
TfwHâpM©chRuÀ
 
	mruÀ
;

33 } 
	tM©chE¡ry
;

35 
TfwHâpTabÀ
 *
	gã°_èbÀ
;

36 
TfwHâpChaö
 *
	gã°_chaö
;

37 
TfwHâpReq
 *
	gã°_ªq
;

45 
	#TFW_HTTP_MATCH_CONT_SIZE
(
c⁄èöî_°ru˘_«me
, 
¨g_Àn
) \

46 ((
c⁄èöî_°ru˘_«me
Ë- (
TfwHâpM©chRuÀ
) \

47 + 
	`TFW_HTTP_MATCH_RULE_SIZE
(
¨g_Àn
))

	)

53 
	#ã°_ruÀ_c⁄èöî_√w
(
chaö
, 
c⁄èöî
, 
membî
, 
ty≥
, 
¨g_Àn
)\

55 
size_t
 
_s
 = (
ty≥
 =
TFW_HTTP_MATCH_A_STR
) \

56 ? 
	`TFW_HTTP_MATCH_CONT_SIZE
(
c⁄èöî
, 
¨g_Àn
) \

57 : (
c⁄èöî
); \

58 
c⁄èöî
 *
_c
 = 
	`tfw_poﬁ_Æloc
((
chaö
)->
poﬁ
, 
_s
); \

59 i‡(!
_c
) { \

60 
	`TFW_ERR
("Can'tállocate memory fromÖool\n"); \

62 
li°_hód
 *
hód
 = (
ty≥
 =
TFW_HTTP_MATCH_A_NUM
) \

63 ? &(
chaö
)->
m¨k_li°
 \

64 : &(
chaö
)->
m©ch_li°
; \

65 
	`mem£t
(
_c
, 0, 
_s
); \

66 
	`INIT_LIST_HEAD
(&
_c
->
membî
.
li°
); \

67 
	`li°_add_èû
(&
_c
->
membî
.
li°
, 
hód
); \

69 
_c
; \

70 })

	)

76 
	#ã°_ruÀ_c⁄èöî_m©ch_ªq
(
ªq
, 
ml°
, 
c⁄èöî
, 
membî
) \

78 
c⁄èöî
 *
_c
 = 
NULL
; \

79 
TfwHâpM©chRuÀ
 *
_r
 = 
	`tfw_hâp_m©ch_ªq
((
ªq
), (
ml°
)); \

80 i‡(
_r
) \

81 
_c
 = 
	`c⁄èöî_of
(
_r
, 
c⁄èöî
, 
membî
); \

82 
_c
; \

83 })

	)

86 
	$hâp_m©ch_suôe_£tup
()

88 
ã°_ªq
 = 
	`ã°_ªq_Æloc
(1);

90 
ã°_èbÀ
 = 
	`tfw_poﬁ_√w
(
TfwHâpTabÀ
, 
TFW_POOL_ZERO
);

91 
	`BUG_ON
(!
ã°_èbÀ
);

92 
	`INIT_LIST_HEAD
(&
ã°_èbÀ
->
hód
);

94 
ã°_chaö
 = 
	`tfw_hâp_chaö_add
(
NULL
, 
ã°_èbÀ
);

95 
	`BUG_ON
(!
ã°_chaö
);

96 
	}
}

99 
	$hâp_m©ch_suôe_ã¨down
()

101 
	`ã°_ªq_‰ì
(
ã°_ªq
);

102 
ã°_ªq
 = 
NULL
;

104 
	`tfw_hâp_èbÀ_‰ì
(
ã°_èbÀ
);

105 
ã°_èbÀ
 = 
NULL
;

106 
	}
}

109 
	$ã°_chaö_add_ruÀ_°r
(
ã°_id
, 
tfw_hâp_m©ch_Êd_t
 
fõld
, c⁄° *
ö_¨g
)

111 
M©chE¡ry
 *
e
;

112 
tfw_hâp_m©ch_›_t
 
›
;

113 
size_t
 
Àn
, 
¨g_size
;

114 c⁄° *
¨g
;

116 
Àn
 = 
	`°æí
(
ö_¨g
);

117 
	`BUG_ON
(
fõld
 =
TFW_HTTP_MATCH_F_WILDCARD
);

118 
	`BUG_ON
(
ö_¨g
[0] ='*' && 
Àn
 == 1);

119 
¨g
 = 
	`tfw_hâp_¨g_adju°
(
ö_¨g
, 
Àn
, &
¨g_size
, &
›
);

121 
e
 = 
	`ã°_ruÀ_c⁄èöî_√w
(
ã°_chaö
, 
M©chE¡ry
, 
ruÀ
,

122 
TFW_HTTP_MATCH_A_STR
, 
¨g_size
);

123 
	`tfw_hâp_ruÀ_öô
(&
e
->
ruÀ
, 
fõld
, 
›
, 
TFW_HTTP_MATCH_A_STR
,

124 
¨g
, 
¨g_size
 - 1);

126 
e
->
ruÀ
.
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_CHAIN
;

127 
e
->
ã°_id
 =Åest_id;

128 
	`k‰ì
(
¨g
);

129 
	}
}

132 
	$ã°_chaö_m©ch
()

134 
M©chE¡ry
 *
e
;

136 
e
 = 
	`ã°_ruÀ_c⁄èöî_m©ch_ªq
(
ã°_ªq
, &
ã°_chaö
->
m©ch_li°
,

137 
M©chE¡ry
, 
ruÀ
);

138 i‡(
e
)

139  
e
->
ã°_id
;

142 
	}
}

145 
	$£t_tfw_°r
(
TfwSå
 *
°r
, c⁄° *
c°r
)

147 
°r
->
±r
 = (*)
c°r
;

148 
°r
->
Àn
 = 
	`°æí
(
c°r
);

149 
	}
}

151 
	$TEST
(
tfw_hâp_m©ch_ªq
, 
ªtu∫s_fú°_m©chög_ruÀ
)

153 c⁄° 
TfwHâpM©chRuÀ
 *
m©ch
;

154 
TfwHâpM©chRuÀ
 *
r1
, *
r2
, *
r3
;

156 
r1
 = 
	`tfw_hâp_ruÀ_√w
(
ã°_chaö
, 
TFW_HTTP_MATCH_A_METHOD
, 0);

157 
r2
 = 
	`tfw_hâp_ruÀ_√w
(
ã°_chaö
, 
TFW_HTTP_MATCH_A_METHOD
, 0);

158 
r3
 = 
	`tfw_hâp_ruÀ_√w
(
ã°_chaö
, 
TFW_HTTP_MATCH_A_METHOD
, 0);

160 
r1
->
a˘
.
ty≥
 = 
r2
->a˘.ty≥ = 
r3
->a˘.ty≥ = 
TFW_HTTP_MATCH_ACT_CHAIN
;

161 
r1
->
fõld
 = 
r2
->fõld = 
r3
->fõld = 
TFW_HTTP_MATCH_F_METHOD
;

162 
r1
->
›
 = 
r2
->› = 
r3
->› = 
TFW_HTTP_MATCH_O_EQ
;

163 
r1
->
¨g
.
ty≥
 = 
r2
->¨g.ty≥ = 
r3
->¨g.ty≥ = 
TFW_HTTP_MATCH_A_METHOD
;

164 
r1
->
¨g
.
mëhod
 = 
TFW_HTTP_METH_POST
;

165 
r2
->
¨g
.
mëhod
 = 
TFW_HTTP_METH_GET
;

166 
r3
->
¨g
.
mëhod
 = 
TFW_HTTP_METH_GET
;

168 
ã°_ªq
->
mëhod
 = 
TFW_HTTP_METH_GET
;

170 
m©ch
 = 
	`tfw_hâp_m©ch_ªq
(
ã°_ªq
, &
ã°_chaö
->
m©ch_li°
);

172 
	`EXPECT_EQ
(
r2
, 
m©ch
);

173 
	}
}

175 
	$TEST
(
hâp_m©ch
, 
uri_¥efix
)

177 
m©ch_id
;

179 
	`ã°_chaö_add_ruÀ_°r
(1, 
TFW_HTTP_MATCH_F_URI
, "/foo/bar/baz*");

180 
	`ã°_chaö_add_ruÀ_°r
(2, 
TFW_HTTP_MATCH_F_URI
, "/foo/ba*");

181 
	`ã°_chaö_add_ruÀ_°r
(3, 
TFW_HTTP_MATCH_F_URI
, "/*");

183 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/foo/bar/baz.html");

184 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

185 
	`EXPECT_EQ
(1, 
m©ch_id
);

187 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/foo/bar/");

188 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

189 
	`EXPECT_EQ
(2, 
m©ch_id
);

191 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/baz");

192 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

193 
	`EXPECT_EQ
(3, 
m©ch_id
);

195 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "../foo");

196 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

197 
	`EXPECT_EQ
(-1, 
m©ch_id
);

198 
	}
}

200 
	$TEST
(
hâp_m©ch
, 
uri_suffix
)

202 
m©ch_id
;

204 
	`ã°_chaö_add_ruÀ_°r
(1, 
TFW_HTTP_MATCH_F_URI
, "*.jpg");

205 
	`ã°_chaö_add_ruÀ_°r
(2, 
TFW_HTTP_MATCH_F_URI
, "*/people.html");

206 
	`ã°_chaö_add_ruÀ_°r
(3, 
TFW_HTTP_MATCH_F_URI
, "*/bar/folks.html");

208 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/foo/bar/picture.jpg");

209 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

210 
	`EXPECT_EQ
(1, 
m©ch_id
);

212 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/foo/bar/people.html");

213 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

214 
	`EXPECT_EQ
(2, 
m©ch_id
);

216 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/foo/bar/folks.html");

217 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

218 
	`EXPECT_EQ
(3, 
m©ch_id
);

220 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "../foo");

221 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

222 
	`EXPECT_EQ
(-1, 
m©ch_id
);

224 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/foo/bar/picture.png");

225 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

226 
	`EXPECT_EQ
(-1, 
m©ch_id
);

227 
	}
}

229 
	$TEST
(
hâp_m©ch
, 
uri_wc_esˇ≥d
)

231 
m©ch_id
;

233 
	`ã°_chaö_add_ruÀ_°r
(1, 
TFW_HTTP_MATCH_F_URI
, "\\*/foo/bar");

234 
	`ã°_chaö_add_ruÀ_°r
(2, 
TFW_HTTP_MATCH_F_URI
, "/foo/\\*people*");

235 
	`ã°_chaö_add_ruÀ_°r
(3, 
TFW_HTTP_MATCH_F_URI
, "*/foo\\*/bar\\*/index.html\\*");

237 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "*/foo/bar");

238 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

239 
	`EXPECT_EQ
(1, 
m©ch_id
);

241 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/foo/*people.html");

242 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

243 
	`EXPECT_EQ
(2, 
m©ch_id
);

245 
	`£t_tfw_°r
(&
ã°_ªq
->
uri_∑th
, "/root/foo*/bar*/index.html*");

246 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

247 
	`EXPECT_EQ
(3, 
m©ch_id
);

248 
	}
}

250 
	$TEST
(
hâp_m©ch
, 
ho°_eq
)

252 
m©ch_id
;

254 
	`ã°_chaö_add_ruÀ_°r
(1, 
TFW_HTTP_MATCH_F_HOST
, "www.natsys-lab.com");

255 
	`ã°_chaö_add_ruÀ_°r
(2, 
TFW_HTTP_MATCH_F_HOST
, "natsys-lab");

256 
	`ã°_chaö_add_ruÀ_°r
(3, 
TFW_HTTP_MATCH_F_HOST
, "NATSYS-LAB.COM");

257 
	`£t_tfw_°r
(&
ã°_ªq
->
ho°
, "natsys-lab.com");

258 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

259 
	`EXPECT_EQ
(3, 
m©ch_id
);

260 
	}
}

262 
	$TEST
(
hâp_m©ch
, 
hódîs_eq
)

264 
m©ch_id
;

266 
	`ã°_chaö_add_ruÀ_°r
(1, 
TFW_HTTP_MATCH_F_HDR_RAW
,

268 
	`ã°_chaö_add_ruÀ_°r
(2, 
TFW_HTTP_MATCH_F_HDR_RAW
,

270 
	`ã°_chaö_add_ruÀ_°r
(3, 
TFW_HTTP_MATCH_F_HDR_RAW
,

273 
	`£t_tfw_°r
(&
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_CONNECTION
],

275 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

276 
	`EXPECT_EQ
(3, 
m©ch_id
);

278 
	`£t_tfw_°r
(&
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_CONNECTION
],

280 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

281 
	`EXPECT_EQ
(2, 
m©ch_id
);

282 
	}
}

284 
	$TEST
(
hâp_m©ch
, 
hdr_ho°_¥efix
)

286 
	`¸óã_°r_poﬁ
();

289 
m©ch_id
;

292 
	`TFW_STR2
(
hdr1
, "Host: ", "example.com");

293 
	`TFW_STR2
(
hdr2
, "Host: ", "Host:ÉXample.COM");

294 
	`TFW_STR2
(
hdr3
, "Host: ", "www");

295 
	`TFW_STR2
(
hdr4
, "Host: ", "WWW.EXAMPLE.COM:8081");

297 
	`ã°_chaö_add_ruÀ_°r
(1, 
TFW_HTTP_MATCH_F_HDR_CONN
,

299 
	`ã°_chaö_add_ruÀ_°r
(2, 
TFW_HTTP_MATCH_F_HDR_HOST
, "ex*");

300 
	`ã°_chaö_add_ruÀ_°r
(3, 
TFW_HTTP_MATCH_F_HDR_HOST
,

303 
	`£t_tfw_°r
(&
ã°_ªq
->
ho°
, "example.com");

304 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

305 
	`EXPECT_EQ
(-1, 
m©ch_id
);

307 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr1
;

308 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

309 
	`EXPECT_EQ
(2, 
m©ch_id
);

311 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr2
;

312 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

313 
	`EXPECT_EQ
(-1, 
m©ch_id
);

315 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr3
;

316 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

317 
	`EXPECT_EQ
(-1, 
m©ch_id
);

319 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr4
;

320 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

321 
	`EXPECT_EQ
(3, 
m©ch_id
);

324 
	`‰ì_Æl_°r
();

325 
	}
}

327 
	$TEST
(
hâp_m©ch
, 
hdr_ho°_suffix
)

329 
	`¸óã_°r_poﬁ
();

332 
m©ch_id
;

335 
	`TFW_STR2
(
hdr1
, "Host: ", "example.biz");

336 
	`TFW_STR2
(
hdr2
, "Host: ", "example.com");

337 
	`TFW_STR2
(
hdr3
, "Host: ", "example.ru");

338 
	`TFW_STR2
(
hdr4
, "Host: ", "eXample.COM");

339 
	`TFW_STR2
(
hdr5
, "Host: ", "www");

340 
	`TFW_STR2
(
hdr6
, "Host: ", "TEST.FOLKS.COM");

342 
	`ã°_chaö_add_ruÀ_°r
(1, 
TFW_HTTP_MATCH_F_HDR_CONN
,

344 
	`ã°_chaö_add_ruÀ_°r
(2, 
TFW_HTTP_MATCH_F_HDR_HOST
, "*.ru");

345 
	`ã°_chaö_add_ruÀ_°r
(3, 
TFW_HTTP_MATCH_F_HDR_HOST
, "*.biz");

346 
	`ã°_chaö_add_ruÀ_°r
(4, 
TFW_HTTP_MATCH_F_HDR_HOST
, "*.folks.com");

347 
	`ã°_chaö_add_ruÀ_°r
(5, 
TFW_HTTP_MATCH_F_HDR_HOST
, "*.com");

349 
	`£t_tfw_°r
(&
ã°_ªq
->
ho°
, "example.com");

350 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

351 
	`EXPECT_EQ
(-1, 
m©ch_id
);

353 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr1
;

354 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

355 
	`EXPECT_EQ
(3, 
m©ch_id
);

357 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr2
;

358 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

359 
	`EXPECT_EQ
(5, 
m©ch_id
);

361 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr3
;

362 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

363 
	`EXPECT_EQ
(2, 
m©ch_id
);

365 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr4
;

366 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

367 
	`EXPECT_EQ
(5, 
m©ch_id
);

369 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr5
;

370 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

371 
	`EXPECT_EQ
(-1, 
m©ch_id
);

373 
ã°_ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr6
;

374 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

375 
	`EXPECT_EQ
(4, 
m©ch_id
);

378 
	`‰ì_Æl_°r
();

379 
	}
}

381 
	$TEST
(
hâp_m©ch
, 
mëhod_eq
)

383 
m©ch_id
;

384 
M©chE¡ry
 *
e1
, *
e2
;

386 
e1
 = 
	`ã°_ruÀ_c⁄èöî_√w
(
ã°_chaö
, 
M©chE¡ry
, 
ruÀ
,

387 
TFW_HTTP_MATCH_A_METHOD
, 0);

388 
e1
->
ã°_id
 = 42,

389 
e1
->
ruÀ
.
fõld
 = 
TFW_HTTP_MATCH_F_METHOD
;

390 
e1
->
ruÀ
.
›
 = 
TFW_HTTP_MATCH_O_EQ
;

391 
e1
->
ruÀ
.
¨g
.
ty≥
 = 
TFW_HTTP_MATCH_A_METHOD
;

392 
e1
->
ruÀ
.
¨g
.
mëhod
 = 
TFW_HTTP_METH_POST
;

393 
e1
->
ruÀ
.
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_CHAIN
;

395 
e2
 = 
	`ã°_ruÀ_c⁄èöî_√w
(
ã°_chaö
, 
M©chE¡ry
, 
ruÀ
,

396 
TFW_HTTP_MATCH_A_METHOD
, 0);

397 
e2
->
ã°_id
 = 43,

398 
e2
->
ruÀ
.
fõld
 = 
TFW_HTTP_MATCH_F_METHOD
;

399 
e2
->
ruÀ
.
›
 = 
TFW_HTTP_MATCH_O_EQ
;

400 
e2
->
ruÀ
.
¨g
.
ty≥
 = 
TFW_HTTP_MATCH_A_METHOD
;

401 
e2
->
ruÀ
.
¨g
.
mëhod
 = 
TFW_HTTP_METH_GET
;

402 
e2
->
ruÀ
.
a˘
.
ty≥
 = 
TFW_HTTP_MATCH_ACT_CHAIN
;

404 
ã°_ªq
->
mëhod
 = 
TFW_HTTP_METH_HEAD
;

405 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

406 
	`EXPECT_EQ
(-1, 
m©ch_id
);

408 
ã°_ªq
->
mëhod
 = 
TFW_HTTP_METH_GET
;

409 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

410 
	`EXPECT_EQ
(43, 
m©ch_id
);

412 
ã°_ªq
->
mëhod
 = 
TFW_HTTP_METH_POST
;

413 
m©ch_id
 = 
	`ã°_chaö_m©ch
();

414 
	`EXPECT_EQ
(42, 
m©ch_id
);

415 
	}
}

417 
	$TEST_SUITE
(
hâp_m©ch
)

419 
	`TEST_SETUP
(
hâp_m©ch_suôe_£tup
);

420 
	`TEST_TEARDOWN
(
hâp_m©ch_suôe_ã¨down
);

422 
	`TEST_RUN
(
tfw_hâp_m©ch_ªq
, 
ªtu∫s_fú°_m©chög_ruÀ
);

423 
	`TEST_RUN
(
hâp_m©ch
, 
uri_¥efix
);

424 
	`TEST_RUN
(
hâp_m©ch
, 
uri_suffix
);

425 
	`TEST_RUN
(
hâp_m©ch
, 
uri_wc_esˇ≥d
);

426 
	`TEST_RUN
(
hâp_m©ch
, 
ho°_eq
);

427 
	`TEST_RUN
(
hâp_m©ch
, 
hódîs_eq
);

428 
	`TEST_RUN
(
hâp_m©ch
, 
hdr_ho°_¥efix
);

429 
	`TEST_RUN
(
hâp_m©ch
, 
hdr_ho°_suffix
);

430 
	`TEST_RUN
(
hâp_m©ch
, 
mëhod_eq
);

431 
	}
}

	@t/unit/test_http_msg.c

22 
	~"ã°.h
"

23 
	~"hâp_msg.h
"

25 
	$TEST
(
hâp_msg
, 
hdr_ö_¨øy
)

27 
size_t
 
i
;

28 
	#TfwSå_°rög
(
v
Ë{ (v), 
NULL
, (vË- 1, 0 }

	)

29 c⁄° 
TfwSå
 
hdrs
[] = {

30 
	`TfwSå_°rög
("age:"),

31 
	`TfwSå_°rög
("authorization:"),

32 
	`TfwSå_°rög
("cache-control:"),

33 
	`TfwSå_°rög
("connection:"),

34 
	`TfwSå_°rög
("content-length:"),

35 
	`TfwSå_°rög
("content-type:"),

36 
	`TfwSå_°rög
("cookie:"),

37 
	`TfwSå_°rög
("date:"),

38 
	`TfwSå_°rög
("etag:"),

39 
	`TfwSå_°rög
("expires:"),

40 
	`TfwSå_°rög
("from:"),

41 
	`TfwSå_°rög
("host:"),

42 
	`TfwSå_°rög
("if-unmodified-since:"),

43 
	`TfwSå_°rög
("last-modified:"),

44 
	`TfwSå_°rög
("location:"),

45 
	`TfwSå_°rög
("pragma:"),

46 
	`TfwSå_°rög
("proxy-authorization:"),

47 
	`TfwSå_°rög
("referer:"),

48 
	`TfwSå_°rög
("server:"),

49 
	`TfwSå_°rög
("transfer-encoding:"),

50 
	`TfwSå_°rög
("user-agent:"),

51 
	`TfwSå_°rög
("vary:"),

52 
	`TfwSå_°rög
("x-forwarded-for:"),

54 c⁄° 
TfwSå
 
o_hdrs
[] = {

55 
	`TfwSå_°rög
("keep-alive:"),

56 
	`TfwSå_°rög
("max-forwards:"),

57 
	`TfwSå_°rög
("content-location:"),

59 
	#S_PART_01
 "ˇche-c⁄åﬁ:Ço-ˇche"

	)

60 
	#S_PART_02
 "ˇche-c⁄åﬁ:Ço-°‹e"

	)

61 
TfwSå
 
dup_hdr
 = {

62 .
±r
 = (
TfwSå
 []){

63 
	`TfwSå_°rög
(
S_PART_01
),

64 
	`TfwSå_°rög
(
S_PART_01
),

66 .
Àn
 = 
	`SLEN
(
S_PART_01
 
S_PART_02
),

67 .
Êags
 = (2 << 
TFW_STR_CN_SHIFT
Ë| 
TFW_STR_DUPLICATE
,

69 #unde‡
TfwSå_°rög


70 #unde‡
S_PART_01


71 #unde‡
S_PART_02


73 
i
 = 0; i < 
	`ARRAY_SIZE
(
hdrs
); ++i) {

74 c⁄° 
TfwSå
 *
h
 = &
hdrs
[
i
];

76 
	`EXPECT_NOT_NULL
(
	`tfw_hâp_msg_föd_hdr
(
h
, 
hdrs
));

78 
i
 = 0; i < 
	`ARRAY_SIZE
(
o_hdrs
); ++i) {

79 c⁄° 
TfwSå
 *
h
 = &
o_hdrs
[
i
];

81 
	`EXPECT_NULL
(
	`tfw_hâp_msg_föd_hdr
(
h
, 
hdrs
));

85 
	`EXPECT_NOT_NULL
(
	`tfw_hâp_msg_föd_hdr
(&
dup_hdr
, 
hdrs
));

86 
	}
}

88 
	$TEST_SUITE
(
hâp_msg
)

90 
	`TEST_RUN
(
hâp_msg
, 
hdr_ö_¨øy
);

91 
	}
}

	@t/unit/test_http_parser.c

21 
	~<löux/ty≥s.h
>

22 
	~<asm/Âu/≠i.h
>

23 
	~<löux/vmÆloc.h
>

25 
	~"hâp_msg.h
"

27 
	~"ã°.h
"

28 
	~"hñ≥rs.h
"

29 
	~"fuzzî.h
"

31 
TfwHâpReq
 *
	gªq
, *
	gßm∂e_ªq
;

32 
TfwHâpRe•
 *
	gª•
;

34 
	#SAMPLE_REQ_STR
 "GET / HTTP/1.1\r\nHo°:Éxam∂e.com\r\n\r\n"

	)

37 
	$•lô_™d_∑r£_n
(*
°r
, 
ty≥
, 
size_t
 
Àn
, size_à
chunks
)

39 
size_t
 
chÀn
 = 
Àn
 / 
chunks
, 
ªm
 =Üí % chunks, 
pos
 = 0, 
°ï
;

40 
r
 = 0;

41 
∑r£d
;

43 
pos
 < 
Àn
) {

44 
°ï
 = 
chÀn
;

45 i‡(
ªm
) {

46 
°ï
 +
ªm
;

47 
ªm
 = 0;

50 
	`TEST_DBG3
("split:Üen=%zuÖos=%zu, chunks=%zu step=%zu\n",

51 
Àn
, 
pos
, 
chunks
, 
°ï
);

52 i‡(
ty≥
 =
FUZZ_REQ
)

53 
r
 = 
	`tfw_hâp_∑r£_ªq
(
ªq
, 
°r
 + 
pos
, 
°ï
, &
∑r£d
);

55 
r
 = 
	`tfw_hâp_∑r£_ª•
(
ª•
, 
°r
 + 
pos
, 
°ï
, &
∑r£d
);

57 
pos
 +
°ï
;

59 i‡(
r
 !
TFW_POSTPONE
)

60  
r
;

63  
r
;

64 
	}
}

71 
	$£t_ßm∂e_ªq
(*
°r
)

73 
size_t
 
Àn
 = 
	`°æí
(
°r
);

74 
r
;

75 
∑r£d
;

77 i‡(
ßm∂e_ªq
)

78 
	`ã°_ªq_‰ì
(
ßm∂e_ªq
);

79 
ßm∂e_ªq
 = 
	`ã°_ªq_Æloc
(
Àn
);

81 
r
 = 
	`tfw_hâp_∑r£_ªq
(
ßm∂e_ªq
, 
°r
, 
Àn
, &
∑r£d
);

83  
r
;

84 
	}
}

113 
	gchunks
 = 1;

116 
	$do_•lô_™d_∑r£
(*
°r
, 
ty≥
)

118 
r
;

119 
size_t
 
Àn
;

121 
	`BUG_ON
(!
°r
);

123 i‡(
chunks
 == 1)

124 
Àn
 = 
	`°æí
(
°r
);

126 i‡(
ty≥
 =
FUZZ_REQ
) {

127 i‡(
ªq
)

128 
	`ã°_ªq_‰ì
(
ªq
);

130 
ªq
 = 
	`ã°_ªq_Æloc
(
Àn
);

132 i‡(
ty≥
 =
FUZZ_RESP
) {

133 i‡(
ª•
)

134 
	`ã°_ª•_‰ì
(
ª•
);

136 
ª•
 = 
	`ã°_ª•_Æloc
(
Àn
);

137 
	`tfw_hâp_msg_∑ú
(
ª•
, 
ßm∂e_ªq
);

140 
	`BUG
();

143 
r
 = 
	`•lô_™d_∑r£_n
(
°r
, 
ty≥
, 
Àn
, 
chunks
);

149 i‡(++
chunks
 > 
Àn
)

152  
r
;

153 
	}
}

155 
	#TRY_PARSE_EXPECT_PASS
(
°r
, 
ty≥
) \

157 
_îr
 = 
	`do_•lô_™d_∑r£
(
°r
, 
ty≥
); \

158 i‡(
_îr
 =
TFW_BLOCK
 || _î∏=
TFW_POSTPONE
) \

159 
	`TEST_FAIL
("can'tÖarse %s (code=%d):\n%s", \

160 (
ty≥
 =
FUZZ_REQ
 ? "request" : \

162 
_îr
, (
°r
)); \

163 
_îr
 =
TFW_PASS
; \

164 })

	)

166 
	#TRY_PARSE_EXPECT_BLOCK
(
°r
, 
ty≥
) \

168 
_îr
 = 
	`do_•lô_™d_∑r£
(
°r
, 
ty≥
); \

169 i‡(
_îr
 =
TFW_PASS
) \

170 
	`TEST_FAIL
("%s isÇot blockedásÉxpected:\n%s", \

171 (
ty≥
 =
FUZZ_REQ
 ? "request" : \

173 (
°r
)); \

174 
_îr
 =
TFW_BLOCK
 || _î∏=
TFW_POSTPONE
; \

175 })

	)

177 
	#FOR_REQ
(
°r
) \

178 
	`TEST_LOG
("==ªque°: [%s]\n", 
°r
); \

179 
chunks
 = 1; \

180 
	`TRY_PARSE_EXPECT_PASS
(
°r
, 
FUZZ_REQ
))

	)

182 
	#EXPECT_BLOCK_REQ
(
°r
) \

184 
	`TEST_LOG
("==ªque°: [%s]\n", 
°r
); \

185 
chunks
 = 1; \

186 
	`TRY_PARSE_EXPECT_BLOCK
(
°r
, 
FUZZ_REQ
)); \

187 } 0)

	)

189 
	#FOR_RESP
(
°r
) \

190 
	`TEST_LOG
("==ª•⁄£: [%s]\n", 
°r
); \

191 
chunks
 = 1; \

192 
	`TRY_PARSE_EXPECT_PASS
(
°r
, 
FUZZ_RESP
))

	)

194 
	#EXPECT_BLOCK_RESP
(
°r
) \

196 
	`TEST_LOG
("==ª•⁄£: [%s]\n", 
°r
); \

197 
chunks
 = 1; \

198 
	`TRY_PARSE_EXPECT_BLOCK
(
°r
, 
FUZZ_RESP
)); \

199 } 0)

	)

201 
	$TEST
(
hâp_∑r£r
, 
Àadög_eﬁ
)

203 
	`FOR_REQ
("GET / HTTP/1.1\r\nHost: foo.com\r\n\r\n");

204 
	`FOR_REQ
("\r\nGET / HTTP/1.1\r\nHost: foo.com\r\n\r\n");

205 
	`FOR_REQ
("\nGET / HTTP/1.1\r\nHost: foo.com\r\n\r\n");

206 
	`FOR_REQ
("\n\n\nGET / HTTP/1.1\r\nHost: foo.com\r\n\r\n");

208 
	`FOR_RESP
("HTTP/1.1 200 OK\r\n"

213 
	`FOR_RESP
("\n"

219 
	`FOR_RESP
("\r\n"

225 
	`FOR_RESP
("\n\n\n"

230 
	}
}

232 
	$TEST
(
hâp_∑r£r
, 
∑r£s_ªq_mëhod
)

234 
	`FOR_REQ
("COPY /filename HTTP/1.1\r\n\r\n") {

235 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_COPY
);

238 
	`FOR_REQ
("DELETE /filename HTTP/1.1\r\n\r\n") {

239 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_DELETE
);

242 
	`FOR_REQ
("GET / HTTP/1.1\r\n\r\n") {

243 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_GET
);

246 
	`FOR_REQ
("HEAD /? HTTP/1.1\r\n\r\n") {

247 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_HEAD
);

250 
	`FOR_REQ
("LOCK /filename HTTP/1.1\r\n\r\n") {

251 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_LOCK
);

254 
	`FOR_REQ
("MKCOL /filename HTTP/1.1\r\n\r\n") {

255 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_MKCOL
);

258 
	`FOR_REQ
("MOVE /filename HTTP/1.1\r\n\r\n") {

259 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_MOVE
);

262 
	`FOR_REQ
("OPTIONS /filename HTTP/1.1\r\n\r\n") {

263 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_OPTIONS
);

266 
	`FOR_REQ
("PATCH /filename HTTP/1.1\r\n\r\n") {

267 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_PATCH
);

270 
	`FOR_REQ
("POST /a?p=1 HTTP/1.1\r\n\r\n") {

271 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_POST
);

274 
	`FOR_REQ
("PROPFIND /filename HTTP/1.1\r\n\r\n") {

275 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_PROPFIND
);

278 
	`FOR_REQ
("PROPPATCH /filename HTTP/1.1\r\n\r\n") {

279 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_PROPPATCH
);

282 
	`FOR_REQ
("PUT /filename HTTP/1.1\r\n\r\n") {

283 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_PUT
);

286 
	`FOR_REQ
("TRACE /filename HTTP/1.1\r\n\r\n") {

287 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_TRACE
);

290 
	`FOR_REQ
("UNLOCK /filename HTTP/1.1\r\n\r\n") {

291 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_UNLOCK
);

295 
	`FOR_REQ
("PURGE /filename HTTP/1.1\r\n\r\n") {

296 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
TFW_HTTP_METH_PURGE
);

300 
	`FOR_REQ
("ACL /filename HTTP/1.1\r\n\r\n") {

301 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

303 
	`FOR_REQ
("BASELINE-CONTROL /filename HTTP/1.1\r\n\r\n") {

304 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

306 
	`FOR_REQ
("BIND /filename HTTP/1.1\r\n\r\n") {

307 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

309 
	`FOR_REQ
("CHECKIN /filename HTTP/1.1\r\n\r\n") {

310 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

312 
	`FOR_REQ
("CHECKOUT /filename HTTP/1.1\r\n\r\n") {

313 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

315 
	`FOR_REQ
("CONNECT /filename HTTP/1.1\r\n\r\n") {

316 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

318 
	`FOR_REQ
("LABEL /filename HTTP/1.1\r\n\r\n") {

319 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

321 
	`FOR_REQ
("LINK /filename HTTP/1.1\r\n\r\n") {

322 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

324 
	`FOR_REQ
("MERGE /filename HTTP/1.1\r\n\r\n") {

325 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

327 
	`FOR_REQ
("MKACTIVITY /filename HTTP/1.1\r\n\r\n") {

328 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

330 
	`FOR_REQ
("MKCALENDAR /filename HTTP/1.1\r\n\r\n") {

331 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

333 
	`FOR_REQ
("MKREDIRECTREF /filename HTTP/1.1\r\n\r\n") {

334 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

336 
	`FOR_REQ
("MKWORKSPACE /filename HTTP/1.1\r\n\r\n") {

337 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

339 
	`FOR_REQ
("ORDERPATCH /filename HTTP/1.1\r\n\r\n") {

340 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

342 
	`FOR_REQ
("PRI /filename HTTP/1.1\r\n\r\n") {

343 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

345 
	`FOR_REQ
("REBIND /filename HTTP/1.1\r\n\r\n") {

346 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

348 
	`FOR_REQ
("REPORT /filename HTTP/1.1\r\n\r\n") {

349 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

351 
	`FOR_REQ
("SEARCH /filename HTTP/1.1\r\n\r\n") {

352 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

354 
	`FOR_REQ
("UNBIND /filename HTTP/1.1\r\n\r\n") {

355 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

357 
	`FOR_REQ
("UNCHECKOUT /filename HTTP/1.1\r\n\r\n") {

358 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

360 
	`FOR_REQ
("UNLINK /filename HTTP/1.1\r\n\r\n") {

361 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

363 
	`FOR_REQ
("UPDATE /filename HTTP/1.1\r\n\r\n") {

364 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

366 
	`FOR_REQ
("UPDATEREDIRECTREF /filename HTTP/1.1\r\n\r\n") {

367 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

369 
	`FOR_REQ
("VERSION-CONTROL /filename HTTP/1.1\r\n\r\n") {

370 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

374 
	`FOR_REQ
("UNKNOWN /filename HTTP/1.1\r\n\r\n") {

375 
	`EXPECT_EQ
(
ªq
->
mëhod
, 
_TFW_HTTP_METH_UNKNOWN
);

377 
	}
}

379 
	#EXPECT_TFWSTR_EQ
(
tfw_°r
, 
c°r
) \

380 
	`EXPECT_EQ
(
åue
, 
	`tfw_°r_eq_c°r
(
tfw_°r
, 
c°r
, 
	`°æí
(c°r), 0))

	)

382 
	$TEST
(
hâp_∑r£r
, 
∑r£s_ªq_uri
)

386 
	`FOR_REQ
("GET / HTTP/1.1\r\n\r\n") {

387 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "/");

390 
	`FOR_REQ
("GET /? HTTP/1.1\r\n\r\n") {

391 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "/?");

394 
	`FOR_REQ
("GET /foo/b_a_r/baz.html HTTP/1.1\r\n\r\n") {

395 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "/foo/b_a_r/baz.html");

398 
	`FOR_REQ
("GET /a/b/c/dir/ HTTP/1.1\r\n\r\n") {

399 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "/a/b/c/dir/");

402 
	`FOR_REQ
("GET /a/b/c/dir/?foo=1&bar=2#abcd HTTP/1.1\r\n\r\n") {

403 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
,

410 
	`FOR_REQ
("GET http://natsys-lab.com/ HTTP/1.1\r\n\r\n") {

411 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
ho°
, "natsys-lab.com");

412 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "/");

415 
	`FOR_REQ
("GET http://natsys-lab.com HTTP/1.1\r\n\r\n") {

416 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
ho°
, "natsys-lab.com");

417 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "");

420 
	`FOR_REQ
("GET http://natsys-lab.com:8080/ HTTP/1.1\r\n\r\n") {

421 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
ho°
, "natsys-lab.com");

422 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "/");

425 
	`FOR_REQ
("GET http://natsys-lab.com:8080 HTTP/1.1\r\n\r\n") {

426 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
ho°
, "natsys-lab.com");

427 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "");

430 
	`FOR_REQ
("GET http://natsys-lab.com/foo/ HTTP/1.1\r\n\r\n") {

431 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
ho°
, "natsys-lab.com");

432 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
, "/foo/");

435 
	`FOR_REQ
("GET http://natsys-lab.com:8080/cgi-bin/show.pl?entry=tempesta"

438 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
ho°
, "natsys-lab.com");

439 
	`EXPECT_TFWSTR_EQ
(&
ªq
->
uri_∑th
,

443 
	`EXPECT_BLOCK_REQ
("GET \x7f HTTP/1.1\r\n"

447 
	`EXPECT_BLOCK_REQ
("GET /\x03uri HTTP/1.1\r\n"

450 
	}
}

453 
	$TEST
(
hâp_∑r£r
, 
m™gÀd_mesßges
)

455 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

460 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

465 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

473 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

485 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

492 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

501 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

510 
	`EXPECT_BLOCK_RESP
("HTTP/1.0 200 OK\r\n"

514 
	`EXPECT_BLOCK_RESP
("HTTP/1.0 200 OK\r\n"

522 
	`EXPECT_BLOCK_RESP
("HTTP/1.0 200 OK\r\n"

537 
	`EXPECT_BLOCK_RESP
("HTTP/1.0 200 OK\r\n"

547 
	`EXPECT_BLOCK_RESP
("HTTP/1.0 200 OK\r\n"

556 
	}
}

561 
	$TEST
(
hâp_∑r£r
, 
Æphabës
)

563 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

571 
	`FOR_REQ
("GET /foo HTTP/1.1\r\n"

589 
	`FOR_RESP
("HTTP/1.1 200 OK\r\n"

603 
	}
}

605 
	$TEST
(
hâp_∑r£r
, 
fûls_hdr_tbl_f‹_ªq
)

607 
TfwHâpHdrTbl
 *
ht
;

608 
TfwSå
 *
h_ac˚±
, *
h_xch
, *
h_dummy4
, *
h_dummy9
, *
h_cc
, *
h_¥agma
,

609 *
h_auth
;

610 
TfwSå
 
h_ho°
, 
h_c⁄√˘i⁄
, 
h_c⁄ây≥
, 
h_xff
, 
h_u£r_agít
, 
h_cookõ
,

611 
h_ã
;

614 c⁄° *
s_ho°
 = "localhost";

615 c⁄° *
s_c⁄√˘i⁄
 = "Keep-Alive";

616 c⁄° *
s_xff
 = "127.0.0.1,Éxample.com";

617 c⁄° *
s_˘
 = "text/html; charset=iso-8859-1";

618 c⁄° *
s_u£r_agít
 = "Wget/1.13.4 (linux-gnu)";

619 c⁄° *
s_cookõ
 = "session=42;Åheme=dark";

621 c⁄° *
s_ac˚±
 = "Accept: */*";

622 c⁄° *
s_xch
 = "X-Custom-Hdr: custom header values";

623 c⁄° *
s_dummy9
 = "Dummy9: 9";

624 c⁄° *
s_dummy4
 = "Dummy4: 4";

625 c⁄° *
s_cc
 = "Cache-Control: max-age=1,Ço-store, min-fresh=30";

626 c⁄° *
s_ã
 = "compress, gzip, chunked";

628 c⁄° *
s_¥agma
 = "Pragma:Ço-cache, fooo ";

629 c⁄° *
s_auth
 = "Authorization: "

632 
	`FOR_REQ
("GET /foo HTTP/1.1\r\n"

661 
ht
 = 
ªq
->
h_tbl
;

664 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_HOST
],

665 
TFW_HTTP_HDR_HOST
, &
h_ho°
);

666 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_CONNECTION
],

667 
TFW_HTTP_HDR_CONNECTION
,

668 &
h_c⁄√˘i⁄
);

669 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_CONTENT_TYPE
],

670 
TFW_HTTP_HDR_CONTENT_TYPE
,

671 &
h_c⁄ây≥
);

672 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_X_FORWARDED_FOR
],

673 
TFW_HTTP_HDR_X_FORWARDED_FOR
, &
h_xff
);

674 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_USER_AGENT
],

675 
TFW_HTTP_HDR_USER_AGENT
,

676 &
h_u£r_agít
);

677 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_TRANSFER_ENCODING
],

678 
TFW_HTTP_HDR_TRANSFER_ENCODING
, &
h_ã
);

679 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_COOKIE
],

680 
TFW_HTTP_HDR_COOKIE
, &
h_cookõ
);

683 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 15);

685 
h_ac˚±
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 0];

686 
h_xch
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 1];

687 
h_dummy4
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 6];

688 
h_dummy9
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 11];

689 
h_cc
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 12];

690 
h_¥agma
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 13];

691 
h_auth
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 14];

693 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_ho°
, 
s_ho°
,

694 
	`°æí
(
s_ho°
), 0));

695 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_c⁄√˘i⁄
, 
s_c⁄√˘i⁄
,

696 
	`°æí
(
s_c⁄√˘i⁄
), 0));

697 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_c⁄ây≥
, 
s_˘
,

698 
	`°æí
(
s_˘
), 0));

699 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_xff
, 
s_xff
,

700 
	`°æí
(
s_xff
), 0));

701 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_u£r_agít
, 
s_u£r_agít
,

702 
	`°æí
(
s_u£r_agít
), 0));

703 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_ã
, 
s_ã
,

704 
	`°æí
(
s_ã
), 0));

705 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_cookõ
, 
s_cookõ
,

706 
	`°æí
(
s_cookõ
), 0));

708 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_ac˚±
, 
s_ac˚±
,

709 
	`°æí
(
s_ac˚±
), 0));

710 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_xch
, 
s_xch
,

711 
	`°æí
(
s_xch
), 0));

712 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_dummy4
, 
s_dummy4
,

713 
	`°æí
(
s_dummy4
), 0));

714 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_dummy9
, 
s_dummy9
,

715 
	`°æí
(
s_dummy9
), 0));

716 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_cc
, 
s_cc
,

717 
	`°æí
(
s_cc
), 0));

718 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_¥agma
, 
s_¥agma
,

719 
	`°æí
(
s_¥agma
), 0));

720 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_auth
, 
s_auth
,

721 
	`°æí
(
s_auth
), 0));

723 
	`EXPECT_TRUE
(
ªq
->
mëhod
 = 
TFW_HTTP_METH_GET
);

724 
	`EXPECT_TRUE
(
ªq
->
c⁄ã¡_Àngth
 == 0);

725 
	`EXPECT_TRUE
(
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_NO_STORE
);

726 
	`EXPECT_TRUE
(
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MIN_FRESH
);

727 
	`EXPECT_TRUE
(
ªq
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MAX_AGE
);

728 
	`EXPECT_TRUE
(
ªq
->
ˇche_˘l
.
mö_‰esh
 == 30);

729 
	`EXPECT_TRUE
(
ªq
->
ˇche_˘l
.
max_age
 == 1);

730 
	`EXPECT_TRUE
(
ht
->
tbl
[
TFW_HTTP_HDR_HOST
].
eﬁí
 == 2);

732 
	}
}

734 
	$TEST
(
hâp_∑r£r
, 
fûls_hdr_tbl_f‹_ª•
)

736 
TfwHâpHdrTbl
 *
ht
;

737 
TfwSå
 *
h_dummy4
, *
h_dummy9
, *
h_cc
, *
h_age
, *
h_d©e
, *
h_exp
;

738 
TfwSå
 
h_c⁄√˘i⁄
, 
h_c⁄ây≥
, 
h_§v
, 
h_ã
, 
h_ka
;

741 c⁄° *
s_c⁄√˘i⁄
 = "Keep-Alive";

742 c⁄° *
s_˘
 = "text/html; charset=iso-8859-1";

743 c⁄° *
s_§v
 = "Apache/2.4.6 (CentOS) OpenSSL/1.0.1e-fips"

746 c⁄° *
s_dummy9
 = "Dummy9: 9";

747 c⁄° *
s_dummy4
 = "Dummy4: 4";

748 c⁄° *
s_cc
 = "Cache-Control: "

750 c⁄° *
s_ã
 = "compress, gzip, chunked";

751 c⁄° *
s_exp
 = "Expires: Tue, 31 Jan 2012 15:02:53 GMT";

752 c⁄° *
s_ka
 = "timeout=600, max=65526";

754 c⁄° *
s_age
 = "Age: 12 ";

755 c⁄° *
s_d©e
 = "Date: Sun, 9 Sep 2001 01:46:40 GMT\t";

757 
	`FOR_RESP
("HTTP/1.1 200 OK\r\n"

784 
ht
 = 
ª•
->
h_tbl
;

786 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
ª•
->
s_löe
, "HTTP/1.1 200 OK",

787 
	`°æí
("HTTP/1.1 200 OK"), 0));

790 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_CONNECTION
],

791 
TFW_HTTP_HDR_CONNECTION
,

792 &
h_c⁄√˘i⁄
);

793 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_CONTENT_TYPE
],

794 
TFW_HTTP_HDR_CONTENT_TYPE
,

795 &
h_c⁄ây≥
);

796 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_SERVER
],

797 
TFW_HTTP_HDR_SERVER
, &
h_§v
);

798 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_TRANSFER_ENCODING
],

799 
TFW_HTTP_HDR_TRANSFER_ENCODING
, &
h_ã
);

800 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_KEEP_ALIVE
],

801 
TFW_HTTP_HDR_KEEP_ALIVE
, &
h_ka
);

807 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 14);

809 
h_dummy4
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 4];

810 
h_cc
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 9];

811 
h_dummy9
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 10];

812 
h_exp
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 11];

813 
h_age
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 12];

814 
h_d©e
 = &
ht
->
tbl
[
TFW_HTTP_HDR_RAW
 + 13];

816 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_c⁄√˘i⁄
, 
s_c⁄√˘i⁄
,

817 
	`°æí
(
s_c⁄√˘i⁄
), 0));

818 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_c⁄ây≥
, 
s_˘
,

819 
	`°æí
(
s_˘
), 0));

820 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_§v
, 
s_§v
,

821 
	`°æí
(
s_§v
), 0));

822 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_ã
, 
s_ã
,

823 
	`°æí
(
s_ã
), 0));

824 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_ka
, 
s_ka
,

825 
	`°æí
(
s_ka
), 0));

827 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_dummy4
, 
s_dummy4
,

828 
	`°æí
(
s_dummy4
), 0));

829 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_cc
, 
s_cc
,

830 
	`°æí
(
s_cc
), 0));

831 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_dummy9
, 
s_dummy9
,

832 
	`°æí
(
s_dummy9
), 0));

833 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_exp
, 
s_exp
,

834 
	`°æí
(
s_exp
), 0));

835 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_age
, 
s_age
,

836 
	`°æí
(
s_age
), 0));

837 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
h_d©e
, 
s_d©e
,

838 
	`°æí
(
s_d©e
), 0));

840 
	`EXPECT_TRUE
(
ª•
->
°©us
 == 200);

841 
	`EXPECT_TRUE
(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_PRIVATE
);

842 
	`EXPECT_TRUE
(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_NO_CACHE
);

843 
	`EXPECT_TRUE
(
ª•
->
ˇche_˘l
.
Êags
 & 
TFW_HTTP_CC_MAX_AGE
);

844 
	`EXPECT_TRUE
(
ª•
->
ˇche_˘l
.
max_age
 == 5);

845 
	`EXPECT_TRUE
(
ª•
->
kìp_Æive
 == 600);

850 
	`EXPECT_TRUE
(
ª•
->
d©e
 == 1000000000);

851 
	`EXPECT_TRUE
(
h_dummy9
->
eﬁí
 == 2);

853 
	}
}

855 
	$TEST
(
hâp_∑r£r
, 
su•icious_x_f‹w¨ded_f‹
)

857 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

862 c⁄° 
TfwSå
 *
h
 = &
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_X_FORWARDED_FOR
];

863 
	`EXPECT_GT
(
h
->
Àn
, 0);

866 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

870 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

874 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

877 
	}
}

879 
	$TEST
(
hâp_∑r£r
, 
∑r£s_c⁄√˘i⁄_vÆue
)

881 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

885 
	`EXPECT_EQ
(
ªq
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
,

886 
TFW_HTTP_F_CONN_KA
);

889 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

893 
	`EXPECT_EQ
(
ªq
->
Êags
 & 
__TFW_HTTP_MSG_M_CONN_MASK
,

894 
TFW_HTTP_F_CONN_CLOSE
);

896 
	}
}

898 
	$TEST
(
hâp_∑r£r
, 
c⁄ã¡_Àngth
)

900 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

905 
	`EXPECT_BLOCK_RESP
("HTTP/1.0 200 OK\r\n"

910 
	`EXPECT_BLOCK_RESP
("HTTP/1.0 200 OK\r\n"

915 
	}
}

917 
	$TEST
(
hâp_∑r£r
, 
eﬁ_¸lf
)

919 
	`FOR_REQ
("\rGET / HTTP/1.1\r\n"

923 
	`FOR_REQ
("POST / HTTP/1.1\n"

930 
TfwHâpHdrTbl
 *
ht
 = 
ªq
->
h_tbl
;

932 
	`EXPECT_TRUE
(
ªq
->
¸lf
.
Àn
 == 1);

933 
	`EXPECT_TRUE
(
ªq
->
body
.
Àn
 == 5);

934 
	`EXPECT_TRUE
(
ht
->
tbl
[
TFW_HTTP_HDR_HOST
].
eﬁí
 == 1);

935 
	`EXPECT_TRUE
(
ht
->
tbl
[
TFW_HTTP_HDR_CONTENT_LENGTH
].
eﬁí
 == 1);

942 
	`FOR_REQ
("GET / HTTP/1.1\n"

949 
	`EXPECT_TRUE
(
ªq
->
¸lf
.
Àn
 == 2);

950 
	`EXPECT_TRUE
(
ªq
->
body
.
Àn
 == 6);

953 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\r\n"

956 
	`EXPECT_BLOCK_REQ
("GET\r/ HTTP/1.1\r\n"

959 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

962 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

965 
	}
}

973 
	$TEST
(
hâp_∑r£r
, 
¸lf_åaûî
)

975 
id
;

976 
	`DEFINE_TFW_STR
(
s_cu°om
, "Custom-Hdr:");

982 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

993 
id
 = 
	`tfw_hâp_msg_hdr_lookup
((
TfwHâpMsg
 *)
ªq
, &
s_cu°om
);

995 
	`EXPECT_TRUE
(
id
 =
TFW_HTTP_HDR_RAW
);

996 
	`EXPECT_TRUE
(
ªq
->
body
.
Àn
 == 12);

997 
	`EXPECT_TRUE
(
ªq
->
¸lf
.
Àn
 == 1);

1000 
	`FOR_RESP
("HTTP/1.1 200 OK\r\n"

1011 
id
 = 
	`tfw_hâp_msg_hdr_lookup
((
TfwHâpMsg
 *)
ª•
, &
s_cu°om
);

1013 
	`EXPECT_TRUE
(
id
 =
TFW_HTTP_HDR_RAW
);

1014 
	`EXPECT_TRUE
(
ª•
->
body
.
Àn
 == 13);

1015 
	`EXPECT_TRUE
(
ª•
->
¸lf
.
Àn
 == 1);

1017 
	}
}

1019 
	$TEST
(
hâp_∑r£r
, 
ows
)

1021 
	`FOR_REQ
("GET /a.html HTTP/1.1\r\n"

1028 
	`FOR_RESP
("HTTP/1.1 200 OK\r\n"

1034 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1038 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1042 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1046 
	`EXPECT_BLOCK_REQ
("GET /\tHTTP/1.1\r\n"

1050 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1 \r\n"

1054 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\t\r\n"

1058 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r \n"

1062 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1065 
	}
}

1067 
	$TEST
(
hâp_∑r£r
, 
fﬁdög
)

1069 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1075 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1080 
	}
}

1082 
	$TEST
(
hâp_∑r£r
, 
ac˚±
)

1084 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1088 
	`EXPECT_TRUE
(
ªq
->
Êags
 & 
TFW_HTTP_F_ACCEPT_HTML
);

1091 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1095 
	`EXPECT_TRUE
(
ªq
->
Êags
 & 
TFW_HTTP_F_ACCEPT_HTML
);

1098 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1102 
	`EXPECT_TRUE
(
ªq
->
Êags
 & 
TFW_HTTP_F_ACCEPT_HTML
);

1105 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1110 
	`EXPECT_TRUE
(
ªq
->
Êags
 & 
TFW_HTTP_F_ACCEPT_HTML
);

1113 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1117 
	`EXPECT_FALSE
(
ªq
->
Êags
 & 
TFW_HTTP_F_ACCEPT_HTML
);

1120 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1124 
	`EXPECT_TRUE
(
ªq
->
Êags
 & 
TFW_HTTP_F_ACCEPT_HTML
);

1126 
	}
}

1128 
	$TEST
(
hâp_∑r£r
, 
em±y_ho°
)

1130 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1135 
	`FOR_REQ
("GET / HTTP/1.1\n"

1138 
	}
}

1140 
	$TEST
(
hâp_∑r£r
, 
chunked
)

1142 
TfwHâpHdrTbl
 *
ht
;

1143 
TfwSå
 
h_c⁄√˘i⁄
;

1145 
	`FOR_REQ
("POST / HTTP/1.1\r\n"

1159 
ht
 = 
ªq
->
h_tbl
;

1161 
	`EXPECT_TRUE
(
ªq
->
body
.
Àn
 == 46);

1163 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_CONNECTION
],

1164 
TFW_HTTP_HDR_CONNECTION
,

1165 &
h_c⁄√˘i⁄
);

1166 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_c⁄√˘i⁄
, "close",

1170 
	`FOR_RESP
("HTTP/1.1 200 OK\r\n"

1179 
ht
 = 
ª•
->
h_tbl
;

1181 
	`EXPECT_TRUE
(
ª•
->
body
.
Àn
 == 17);

1183 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_CONNECTION
],

1184 
TFW_HTTP_HDR_CONNECTION
,

1185 &
h_c⁄√˘i⁄
);

1186 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_c⁄√˘i⁄
, "keep-alive",

1190 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1203 
	}
}

1205 
	$TEST
(
hâp_∑r£r
, 
chunk_size
)

1207 
	`EXPECT_BLOCK_REQ
("POST / HTTP/1.1\r\n"

1216 
	`EXPECT_BLOCK_REQ
("POST / HTTP/1.1\r\n"

1225 
	`EXPECT_BLOCK_REQ
("POST / HTTP/1.1\r\n"

1234 
	`FOR_REQ
("POST / HTTP/1.1\r\n"

1242 
	}
}

1244 
	$TEST
(
hâp_∑r£r
, 
cookõ
)

1246 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1251 
TfwSå
 *
cookõ
 = &
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_COOKIE
];

1253 
	`EXPECT_TRUE
(
	`TFW_STR_CHUNKN
(
cookõ
) >= 4);

1256 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1261 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1266 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1271 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1281 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1285 
	}
}

1287 
	$TEST
(
hâp_∑r£r
, 
ëag
)

1289 
	#RESP_ETAG_START
 \

1296 "Sîvî: A∑che/1.3.3.7 (UnixË(Red-H©/Löux)\r\n"

	)

1298 
	#RESP_ETAG_END
 \

1302 "0123456789"

	)

1304 
	#ETAG_VALUE
 "3f80f-1b6-3e1cb03b"

	)

1305 
	#ETAG_H
 "ETag: \""

	)

1306 
	#ETAG_TAIL
 "\" \r\n"

	)

1307 
	#ETAG
 
ETAG_H
 
ETAG_VALUE
 
ETAG_TAIL


	)

1308 
	#ETAG_H_WEAK
 "ETag: W/\""

	)

1309 
	#ETAG_WEAK
 
ETAG_H_WEAK
 
ETAG_VALUE
 
ETAG_TAIL


	)

1311 
	`FOR_RESP
(
RESP_ETAG_START


1312 
ETAG


1313 
RESP_ETAG_END
)

1315 
TfwSå
 
h_ëag
, 
s_ëag
;

1316 
	`DEFINE_TFW_STR
(
exp_ëag
, 
ETAG_VALUE
 "\"");

1318 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ª•
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_ETAG
],

1319 
TFW_HTTP_HDR_ETAG
,

1320 &
h_ëag
);

1321 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&
h_ëag
);

1322 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag
, '"'), 0);

1323 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1324 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1325 & 
TFW_STR_ETAG_WEAK
);

1328 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1329 
	`EXPECT_TRUE
(
	`TFW_STR_EMPTY
(&
s_ëag
));

1332 
	`FOR_RESP
(
RESP_ETAG_START


1333 
ETAG_WEAK


1334 
RESP_ETAG_END
)

1336 
TfwSå
 
h_ëag
, 
s_ëag
;

1337 
	`DEFINE_TFW_STR
(
exp_ëag
, 
ETAG_VALUE
 "\"");

1339 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ª•
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_ETAG
],

1340 
TFW_HTTP_HDR_ETAG
,

1341 &
h_ëag
);

1342 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&
h_ëag
);

1343 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag
, '"'), 0);

1344 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1345 
	`EXPECT_TRUE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1346 & 
TFW_STR_ETAG_WEAK
);

1349 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1350 
	`EXPECT_TRUE
(
	`TFW_STR_EMPTY
(&
s_ëag
));

1353 
	`FOR_RESP
(
RESP_ETAG_START


1355 
RESP_ETAG_END
)

1357 
TfwSå
 
h_ëag
, 
s_ëag
;

1358 
	`DEFINE_TFW_STR
(
exp_ëag
, "\"");

1360 
	`tfw_hâp_msg_§vhdr_vÆ
(&
ª•
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_ETAG
],

1361 
TFW_HTTP_HDR_ETAG
,

1362 &
h_ëag
);

1363 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&
h_ëag
);

1364 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag
, '"'), 0);

1365 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1366 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1367 & 
TFW_STR_ETAG_WEAK
);

1370 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1371 
	`EXPECT_TRUE
(
	`TFW_STR_EMPTY
(&
s_ëag
));

1374 
	`EXPECT_BLOCK_RESP
(
RESP_ETAG_START


1377 
RESP_ETAG_END
);

1379 
	`EXPECT_BLOCK_RESP
(
RESP_ETAG_START


1381 
RESP_ETAG_END
);

1383 
	`EXPECT_BLOCK_RESP
(
RESP_ETAG_START


1385 
RESP_ETAG_END
);

1387 
	`EXPECT_BLOCK_RESP
(
RESP_ETAG_START


1389 
RESP_ETAG_END
);

1392 
	`EXPECT_BLOCK_RESP
(
RESP_ETAG_START


1394 
RESP_ETAG_END
);

1396 
	`EXPECT_BLOCK_RESP
(
RESP_ETAG_START


1398 
RESP_ETAG_END
);

1400 #unde‡
RESP_ETAG_START


1401 #unde‡
RESP_ETAG_END


1402 #unde‡
ETAG


1403 #unde‡
ETAG_WEAK


1404 #unde‡
ETAG_H


1405 #unde‡
ETAG_H_WEAK


1406 #unde‡
ETAG_TAIL


1407 #unde‡
ETAG_VALUE


1408 
	}
}

1410 
	$TEST
(
hâp_∑r£r
, 
if_n⁄e_m©ch
)

1412 
	#ETAG_1
 "3f80f-1b6-3e1cb03b"

	)

1413 
	#ETAG_2
 "dhjkshfkjSDFDS"

	)

1414 
	#ETAG_3
 "3f80f"

	)

1416 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1417 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\" \r\n"

1420 
TfwSå
 
h_öm
 = 
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_IF_NONE_MATCH
];

1421 
TfwSå
 
s_ëag
;

1422 
	`DEFINE_TFW_STR
(
exp_ëag
, 
ETAG_1
 "\"");

1424 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&
h_öm
);

1425 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag
, '"'), 0);

1426 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1427 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1428 & 
TFW_STR_ETAG_WEAK
);

1431 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1432 
	`EXPECT_TRUE
(
	`TFW_STR_EMPTY
(&
s_ëag
));

1434 
	`EXPECT_FALSE
(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_ETAG_ANY
);

1437 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1441 
TfwSå
 
h_öm
 = 
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_IF_NONE_MATCH
];

1442 
TfwSå
 
s_ëag
;

1443 
	`DEFINE_TFW_STR
(
exp_ëag
, "\"");

1445 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&
h_öm
);

1446 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag
, '"'), 0);

1447 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1448 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1449 & 
TFW_STR_ETAG_WEAK
);

1452 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1453 
	`EXPECT_TRUE
(
	`TFW_STR_EMPTY
(&
s_ëag
));

1455 
	`EXPECT_FALSE
(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_ETAG_ANY
);

1458 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1459 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\", \"" 
ETAG_2
 "\" \r\n"

1462 
TfwSå
 
h_öm
 = 
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_IF_NONE_MATCH
];

1463 
TfwSå
 
s_ëag
;

1464 
	`DEFINE_TFW_STR
(
exp_ëag_1
, 
ETAG_1
 "\"");

1465 
	`DEFINE_TFW_STR
(
exp_ëag_2
, 
ETAG_2
 "\"");

1467 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&
h_öm
);

1468 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag_1
, '"'), 0);

1469 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1470 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1471 & 
TFW_STR_ETAG_WEAK
);

1474 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1475 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag_2
, '"'), 0);

1476 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1477 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1478 & 
TFW_STR_ETAG_WEAK
);

1481 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1482 
	`EXPECT_TRUE
(
	`TFW_STR_EMPTY
(&
s_ëag
));

1484 
	`EXPECT_FALSE
(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_ETAG_ANY
);

1487 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1488 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\", W/\"" 
ETAG_2
 "\", \"" 
ETAG_3
 "\" \r\n"

1491 
TfwSå
 
h_öm
 = 
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_IF_NONE_MATCH
];

1492 
TfwSå
 
s_ëag
;

1493 
	`DEFINE_TFW_STR
(
exp_ëag_1
, 
ETAG_1
 "\"");

1494 
	`DEFINE_TFW_STR
(
exp_ëag_2
, 
ETAG_2
 "\"");

1495 
	`DEFINE_TFW_STR
(
exp_ëag_3
, 
ETAG_3
 "\"");

1497 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&
h_öm
);

1498 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag_1
, '"'), 0);

1499 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1500 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1501 & 
TFW_STR_ETAG_WEAK
);

1504 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1505 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag_2
, '"'), 0);

1506 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1507 
	`EXPECT_TRUE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1508 & 
TFW_STR_ETAG_WEAK
);

1511 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1512 
	`EXPECT_EQ
(
	`tfw_°rcmp•n
(&
s_ëag
, &
exp_ëag_3
, '"'), 0);

1513 i‡(!
	`TFW_STR_EMPTY
(&
s_ëag
)) {

1514 
	`EXPECT_FALSE
((
	`TFW_STR_CHUNK
(&
s_ëag
, 0))->
Êags


1515 & 
TFW_STR_ETAG_WEAK
);

1518 
s_ëag
 = 
	`tfw_°r_√xt_°r_vÆ
(&s_etag);

1519 
	`EXPECT_TRUE
(
	`TFW_STR_EMPTY
(&
s_ëag
));

1521 
	`EXPECT_FALSE
(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_ETAG_ANY
);

1524 
	`FOR_REQ
("GET / HTTP/1.1\r\n"

1528 
	`EXPECT_TRUE
(
ªq
->
c⁄d
.
Êags
 & 
TFW_HTTP_COND_ETAG_ANY
);

1532 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1536 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1537 "If-N⁄e-M©ch: " 
ETAG_1
 "\r\n"

1540 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1541 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\r\n"

1544 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1545 "If-N⁄e-M©ch: " 
ETAG_1
 "\"\r\n"

1548 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1549 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\"\r\n"

1550 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\"\r\n"

1553 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1554 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\", \r\n"

1557 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1558 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\" \"" 
ETAG_2
 "\" \r\n"

1561 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1562 "If-N⁄e-M©ch: \"" 
ETAG_1
 "\", * \r\n"

1564 
	`EXPECT_BLOCK_REQ
("GET / HTTP/1.1\r\n"

1565 "If-N⁄e-M©ch: *, \"" 
ETAG_1
 "\" \r\n"

1568 #unde‡
ETAG_1


1569 #unde‡
ETAG_2


1570 #unde‡
ETAG_3


1571 
	}
}

1573 
	$TEST
(
hâp_∑r£r
, 
ª„ªr
)

1575 
TfwHâpHdrTbl
 *
ht
;

1576 
TfwSå
 
h_ª„ªr
;

1578 c⁄° *
s_ª„ªr1
 =

1581 c⁄° *
s_ª„ªr2
 =

1583 c⁄° *
s_ª„ªr3
 =

1587 
	`FOR_REQ
("GET /foo HTTP/1.1\r\n"

1592 
ht
 = 
ªq
->
h_tbl
;

1593 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_REFERER
],

1594 
TFW_HTTP_HDR_REFERER
,

1595 &
h_ª„ªr
);

1596 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_ª„ªr
, 
s_ª„ªr1
,

1597 
	`°æí
(
s_ª„ªr1
), 0));

1600 
	`FOR_REQ
("GET /foo HTTP/1.1\r\n"

1604 
ht
 = 
ªq
->
h_tbl
;

1605 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_REFERER
],

1606 
TFW_HTTP_HDR_REFERER
,

1607 &
h_ª„ªr
);

1608 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_ª„ªr
, 
s_ª„ªr2
,

1609 
	`°æí
(
s_ª„ªr2
), 0));

1612 
	`FOR_REQ
("GET /foo HTTP/1.1\r\n"

1617 
ht
 = 
ªq
->
h_tbl
;

1618 
	`tfw_hâp_msg_˛¡hdr_vÆ
(&
ht
->
tbl
[
TFW_HTTP_HDR_REFERER
],

1619 
TFW_HTTP_HDR_REFERER
,

1620 &
h_ª„ªr
);

1621 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
h_ª„ªr
, 
s_ª„ªr3
,

1622 
	`°æí
(
s_ª„ªr3
), 0));

1624 
	}
}

1626 
	$TEST
(
hâp_∑r£r
, 
ªq_h›_by_h›
)

1628 
TfwHâpHdrTbl
 *
ht
;

1629 
TfwSå
 *
fõld
;

1630 
id
;

1631 
	#REQ_HBH_START
 \

1643 "Kìp-Alive:Åimeout=600, max=65526\r\n"

	)

1645 
	#REQ_HBH_END
 \

1661 

	)

1663 
	`FOR_REQ
(
REQ_HBH_START


1664 
REQ_HBH_END
)

1666 
ht
 = 
ªq
->
h_tbl
;

1668 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 17);

1670 
id
 = 0; id < 
ht
->
off
; ++id) {

1671 
fõld
 = &
ht
->
tbl
[
id
];

1672 
	`EXPECT_FALSE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1677 
	`FOR_REQ
(
REQ_HBH_START


1679 
REQ_HBH_END
)

1681 
ht
 = 
ªq
->
h_tbl
;

1683 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 17);

1685 
id
 = 0; id < 
ht
->
off
; ++id) {

1686 
fõld
 = &
ht
->
tbl
[
id
];

1687 
id
) {

1688 
TFW_HTTP_HDR_CONNECTION
:

1689 
TFW_HTTP_HDR_KEEP_ALIVE
:

1690 
	`EXPECT_TRUE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1693 
	`EXPECT_FALSE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1700 
	`FOR_REQ
(
REQ_HBH_START


1702 
REQ_HBH_END
)

1704 
ht
 = 
ªq
->
h_tbl
;

1706 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 17);

1708 
id
 = 0; id < 
ht
->
off
; ++id) {

1709 
fõld
 = &
ht
->
tbl
[
id
];

1710 
id
) {

1711 
TFW_HTTP_HDR_CONNECTION
:

1712 
TFW_HTTP_HDR_KEEP_ALIVE
:

1713 
TFW_HTTP_HDR_RAW
 + 4:

1714 
TFW_HTTP_HDR_RAW
 + 12:

1715 
	`EXPECT_TRUE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1718 
	`EXPECT_FALSE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1725 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1727 
REQ_HBH_END
);

1728 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1730 
REQ_HBH_END
);

1731 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1733 
REQ_HBH_END
);

1734 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1736 
REQ_HBH_END
);

1737 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1739 
REQ_HBH_END
);

1740 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1742 
REQ_HBH_END
);

1743 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1745 
REQ_HBH_END
);

1746 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1748 
REQ_HBH_END
);

1749 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1751 
REQ_HBH_END
);

1754 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1756 
REQ_HBH_END
);

1757 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1759 
REQ_HBH_END
);

1760 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1762 
REQ_HBH_END
);

1765 
	`EXPECT_BLOCK_REQ
(
REQ_HBH_START


1768 
REQ_HBH_END
);

1770 #unde‡
REQ_HBH_START


1771 #unde‡
REQ_HBH_END


1772 
	}
}

1774 
	$TEST
(
hâp_∑r£r
, 
ª•_h›_by_h›
)

1776 
TfwHâpHdrTbl
 *
ht
;

1777 
TfwSå
 *
fõld
;

1778 
id
;

1779 
	#RESP_HBH_START
 \

1787 "Dummy5: 5\r\n"

	)

1789 
	#RESP_HBH_END
 \

1806 "012"

	)

1809 
	`FOR_RESP
(
RESP_HBH_START


1810 
RESP_HBH_END
)

1812 
ht
 = 
ª•
->
h_tbl
;

1814 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 16);

1816 
id
 = 0; id < 
ht
->
off
; ++id) {

1817 
fõld
 = &
ht
->
tbl
[
id
];

1818 
id
) {

1819 
TFW_HTTP_HDR_SERVER
:

1820 
	`EXPECT_TRUE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1823 
	`EXPECT_FALSE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1830 
	`FOR_RESP
(
RESP_HBH_START


1832 
RESP_HBH_END
)

1834 
ht
 = 
ª•
->
h_tbl
;

1836 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 16);

1838 
id
 = 0; id < 
ht
->
off
; ++id) {

1839 
fõld
 = &
ht
->
tbl
[
id
];

1840 
id
) {

1841 
TFW_HTTP_HDR_SERVER
:

1842 
TFW_HTTP_HDR_CONNECTION
:

1843 
TFW_HTTP_HDR_KEEP_ALIVE
:

1844 
	`EXPECT_TRUE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1847 
	`EXPECT_FALSE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1854 
	`FOR_RESP
(
RESP_HBH_START


1856 
RESP_HBH_END
)

1858 
ht
 = 
ª•
->
h_tbl
;

1860 
	`EXPECT_EQ
(
ht
->
off
, 
TFW_HTTP_HDR_RAW
 + 16);

1862 
id
 = 0; id < 
ht
->
off
; ++id) {

1863 
fõld
 = &
ht
->
tbl
[
id
];

1864 
id
) {

1865 
TFW_HTTP_HDR_SERVER
:

1866 
TFW_HTTP_HDR_CONNECTION
:

1867 
TFW_HTTP_HDR_KEEP_ALIVE
:

1868 
TFW_HTTP_HDR_RAW
 + 3:

1869 
TFW_HTTP_HDR_RAW
 + 9:

1870 
	`EXPECT_TRUE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1873 
	`EXPECT_FALSE
(
fõld
->
Êags
 & 
TFW_STR_HBH_HDR
);

1880 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1882 
RESP_HBH_END
);

1883 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1885 
RESP_HBH_END
);

1886 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1888 
RESP_HBH_END
);

1889 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1891 
RESP_HBH_END
);

1892 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1894 
RESP_HBH_END
);

1895 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1897 
RESP_HBH_END
);

1898 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1900 
RESP_HBH_END
);

1901 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1903 
RESP_HBH_END
);

1904 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1906 
RESP_HBH_END
);

1909 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1911 
RESP_HBH_END
);

1912 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1914 
RESP_HBH_END
);

1915 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1917 
RESP_HBH_END
);

1918 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1920 
RESP_HBH_END
);

1921 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1923 
RESP_HBH_END
);

1924 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1926 
RESP_HBH_END
);

1929 
	`EXPECT_BLOCK_RESP
(
RESP_HBH_START


1932 
RESP_HBH_END
);

1934 #unde‡
RESP_HBH_START


1935 #unde‡
RESP_HBH_END


1936 
	}
}

1938 
	#N
 6

1939 
	#MOVE
 1

1940 

	)

1941 
	$TEST
(
hâp_∑r£r
, 
fuzzî
)

1943 
size_t
 
Àn
 = 10 * 1024 * 1024;

1944 *
°r
;

1945 
fõld
, 
i
, 
ªt
;

1946 
TfwFuzzC⁄ãxt
 
c⁄ãxt
;

1948 
	`kî√l_Âu_íd
();

1949 
°r
 = 
	`vmÆloc
(
Àn
);

1950 
	`kî√l_Âu_begö
();

1952 
	`fuzz_öô
(&
c⁄ãxt
, 
Ál£
);

1954 
fõld
 = 
SPACES
; fõld < 
N_FIELDS
; field++) {

1955 
i
 = 0; i < 
N
; i++) {

1956 
	`TEST_DBG3
("°¨àfõld: %dÑeque°: %d\n", 
fõld
, 
i
);

1957 
ªt
 = 
	`fuzz_gí
(&
c⁄ãxt
, 
°r
, så + 
Àn
, 
fõld
, 
MOVE
,

1958 
FUZZ_REQ
);

1959 
ªt
) {

1960 
FUZZ_VALID
:

1961 
chunks
 = 1;

1962 
	`TRY_PARSE_EXPECT_PASS
(
°r
, 
FUZZ_REQ
);

1964 
FUZZ_INVALID
:

1965 
chunks
 = 1;

1966 
	`TRY_PARSE_EXPECT_BLOCK
(
°r
, 
FUZZ_REQ
);

1968 
FUZZ_END
:

1970 
ª•
;

1974 
ª•
:

1975 
	`fuzz_öô
(&
c⁄ãxt
, 
Ál£
);

1977 
fõld
 = 
SPACES
; fõld < 
N_FIELDS
; field++) {

1978 
i
 = 0; i < 
N
; i++) {

1979 
	`TEST_DBG3
("°¨àfõld: %dÑe•⁄£: %d\n", 
fõld
, 
i
);

1980 
ªt
 = 
	`fuzz_gí
(&
c⁄ãxt
, 
°r
, så + 
Àn
, 
fõld
, 
MOVE
,

1981 
FUZZ_RESP
);

1982 
ªt
) {

1983 
FUZZ_VALID
:

1984 
chunks
 = 1;

1985 
	`TRY_PARSE_EXPECT_PASS
(
°r
, 
FUZZ_RESP
);

1987 
FUZZ_INVALID
:

1988 
chunks
 = 1;

1989 
	`TRY_PARSE_EXPECT_BLOCK
(
°r
, 
FUZZ_RESP
);

1991 
FUZZ_END
:

1993 
íd
;

1997 
íd
:

1998 
	`kî√l_Âu_íd
();

1999 
	`v‰ì
(
°r
);

2000 
	`kî√l_Âu_begö
();

2001 
	}
}

2003 
	$TEST_SUITE
(
hâp_∑r£r
)

2005 
r
;

2007 i‡((
r
 = 
	`£t_ßm∂e_ªq
(
SAMPLE_REQ_STR
))) {

2008 
	`TEST_FAIL
("can'tÖarse sampleÑequest (code=%d):\n%s",

2009 
r
, 
SAMPLE_REQ_STR
);

2013 
	`TEST_RUN
(
hâp_∑r£r
, 
Àadög_eﬁ
);

2014 
	`TEST_RUN
(
hâp_∑r£r
, 
∑r£s_ªq_mëhod
);

2015 
	`TEST_RUN
(
hâp_∑r£r
, 
∑r£s_ªq_uri
);

2016 
	`TEST_RUN
(
hâp_∑r£r
, 
m™gÀd_mesßges
);

2017 
	`TEST_RUN
(
hâp_∑r£r
, 
Æphabës
);

2018 
	`TEST_RUN
(
hâp_∑r£r
, 
fûls_hdr_tbl_f‹_ªq
);

2019 
	`TEST_RUN
(
hâp_∑r£r
, 
fûls_hdr_tbl_f‹_ª•
);

2020 
	`TEST_RUN
(
hâp_∑r£r
, 
su•icious_x_f‹w¨ded_f‹
);

2021 
	`TEST_RUN
(
hâp_∑r£r
, 
∑r£s_c⁄√˘i⁄_vÆue
);

2022 
	`TEST_RUN
(
hâp_∑r£r
, 
c⁄ã¡_Àngth
);

2023 
	`TEST_RUN
(
hâp_∑r£r
, 
eﬁ_¸lf
);

2024 
	`TEST_RUN
(
hâp_∑r£r
, 
¸lf_åaûî
);

2025 
	`TEST_RUN
(
hâp_∑r£r
, 
ows
);

2026 
	`TEST_RUN
(
hâp_∑r£r
, 
fﬁdög
);

2027 
	`TEST_RUN
(
hâp_∑r£r
, 
ac˚±
);

2028 
	`TEST_RUN
(
hâp_∑r£r
, 
em±y_ho°
);

2029 
	`TEST_RUN
(
hâp_∑r£r
, 
chunked
);

2030 
	`TEST_RUN
(
hâp_∑r£r
, 
chunk_size
);

2031 
	`TEST_RUN
(
hâp_∑r£r
, 
cookõ
);

2032 
	`TEST_RUN
(
hâp_∑r£r
, 
ëag
);

2033 
	`TEST_RUN
(
hâp_∑r£r
, 
if_n⁄e_m©ch
);

2034 
	`TEST_RUN
(
hâp_∑r£r
, 
ª„ªr
);

2035 
	`TEST_RUN
(
hâp_∑r£r
, 
ªq_h›_by_h›
);

2036 
	`TEST_RUN
(
hâp_∑r£r
, 
ª•_h›_by_h›
);

2037 
	`TEST_RUN
(
hâp_∑r£r
, 
fuzzî
);

2038 
	}
}

	@t/unit/test_http_sticky.c

21 
	~<löux/ty≥s.h
>

22 
	~<asm/Âu/≠i.h
>

24 
	~<löux/moduÀ.h
>

25 #unde‡
EXPORT_SYMBOL


26 
	#EXPORT_SYMBOL
(...)

	)

28 #ifde‡
__ªad_mo°ly


29 #unde‡
__ªad_mo°ly


30 
	#__ªad_mo°ly


	)

33 #ifde‡
__öô


34 #unde‡
__öô


35 
	#__öô


	)

38 #i‡!
deföed
(
DBG_SS
Ë|| !deföed(
DBG_TLS
)

39 #unde‡
DEBUG


41 
	~"hâp_msg.c
"

42 
	~"msg.c
"

43 
	~"hâp_£ss.c
"

45 
	~"fûãr.c
"

46 
	~"sock.c
"

47 
	~"£rvî.c
"

48 
	~"sock_§v.c
"

49 
	~"˛õ¡.c
"

50 
	~"hâp_limôs.c
"

51 
	~"és.c
"

54 
	#tfw_˛i_c⁄n_£nd
 
divît_tfw_˛i_c⁄n_£nd


	)

55 
	~"sock_˛¡.c
"

56 #unde‡
tfw_˛i_c⁄n_£nd


59 
	#tfw_hâp_ª•_buûd_îr‹
 
divît_tfw_hâp_ª•_buûd_îr‹


	)

64 
	~"hâp.c
"

65 #unde‡
tfw_hâp_ª•_buûd_îr‹


67 
	~"hash.c
"

68 
	~"addr.c
"

69 
	~"ss_skb.c
"

70 
	~"sched.c
"

71 
	~"gfsm.c
"

72 
	~"ˇche.c
"

73 
	~"hâp_∑r£r.c
"

74 
	~"°r.c
"

75 
	~"w‹k_queue.c
"

76 
	~"¥ocfs.c
"

79 
	#tfw_c⁄√˘i⁄_£nd
 
divît_tfw_c⁄√˘i⁄_£nd


	)

80 
	~"c⁄√˘i⁄.c
"

81 #unde‡
tfw_c⁄√˘i⁄_£nd


83 
	~"vho°.h
"

84 
	~"ã°.h
"

85 
	~"hñ≥rs.h
"

86 
	~"tfw_°r_hñ≥r.h
"

88 
	#COOKIE_NAME
 "QWERTY_123"

	)

91 
	mtfw_c⁄√˘i⁄_£nd_was_ˇŒed
;

92 
	m£í_£t_cookõ_hódî
;

93 
	m£í_cookõ
;

94 
	mhâp_°©us
;

96 
TfwHâpReq
 *
	mªq
;

97 
TfwHâpRe•
 *
	mª•
;

98 
TfwC⁄n
 
	mc⁄n_ªq
;

99 
TfwC⁄n
 
	mc⁄n_ª•
;

100 
TfwClõ¡
 
	m˛õ¡
;

101 
sock
 
	msock
;

102 } 
	gmock
;

110 
TfwSå
 *

111 
	$tfw_hâp_fõld_øw
(
TfwHâpMsg
 *
hm
, c⁄° *
fõld_«me
, 
size_t
 
Àn
)

113 
i
;

115 
i
 = 
TFW_HTTP_HDR_RAW
; i < 
hm
->
h_tbl
->
off
; i++) {

116 
TfwSå
 *
hdr_fõld
 = &
hm
->
h_tbl
->
tbl
[
i
];

117 i‡(
	`tfw_°r_eq_c°r
(
hdr_fõld
, 
fõld_«me
, 
Àn
,

118 
TFW_STR_EQ_PREFIX
 | 
TFW_STR_EQ_CASEI
))

119  
hdr_fõld
;

122  
NULL
;

123 
	}
}

126 
	$tfw_hâp_fõld_vÆue
(
TfwHâpMsg
 *
hm
, c⁄° 
TfwSå
 *
fõld_«me
, TfwSå *
vÆue
)

128 *
buf
, *
±r
;

129 
size_t
 
Àn
;

130 
TfwSå
 *
hdr_fõld
;

132 
hdr_fõld
 = 
	`tfw_hâp_fõld_øw
(
hm
, 
fõld_«me
->
±r
, fõld_«me->
Àn
);

133 i‡(
hdr_fõld
 =
NULL
) {

140 
Àn
 = 
hdr_fõld
->len + 1;

141 i‡((
buf
 = 
	`tfw_poﬁ_Æloc
(
hm
->
poﬁ
, 
Àn
)Ë=
NULL
) {

142  -
ENOMEM
;

144 
Àn
 = 
	`tfw_°r_to_c°r
(
hdr_fõld
, 
buf
,Üen);

145 
±r
 = 
	`°rim
(
buf
 + 
fõld_«me
->
Àn
);

146 
vÆue
->
±r
 =Ötr;

147 
vÆue
->
Àn
 =Üí - (
±r
 - 
buf
);

150 
	}
}

154 
	$tfw_c⁄√˘i⁄_£nd
(
TfwC⁄n
 *
c⁄n
, 
TfwMsg
 *
msg
)

156 
sk_buff
 *
skb
;

157 
∑r£d
 = 0, 
chunks
 = 0;

158 c⁄° 
	`DEFINE_TFW_STR
(
s_£t_cookõ
, "Set-Cookie:");

159 
	`DEFINE_TFW_STR
(
hdr_vÆue
, 
NULL
);

161 
	`BUG_ON
(!
msg
);

162 
	`BUG_ON
(!
msg
->
skb_hód
);

163 
	`BUG_ON
(!
c⁄n
);

165 
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
 += 1;

167 
skb
 = 
msg
->
skb_hód
;

169 
	`ss_skb_¥o˚ss
(
skb
, 0, 0, 
tfw_hâp_∑r£_ª•
, 
mock
.
ª•
,

170 &
chunks
, &
∑r£d
);

171 
skb
 = skb->
√xt
;

172 } 
skb
 !
msg
->
skb_hód
);

174 
mock
.
hâp_°©us
 = mock.
ª•
->
°©us
;

176 
mock
.
£í_£t_cookõ_hódî
 =

177 
	`tfw_hâp_fõld_vÆue
((
TfwHâpMsg
 *)
mock
.
ª•
,

178 &
s_£t_cookõ
, &
hdr_vÆue
) > 0;

180 i‡(!
mock
.
£í_£t_cookõ_hódî
)

184 
	`BUG_ON
(!
	`TFW_STR_PLAIN
(&
hdr_vÆue
));

187 
mock
.
£í_cookõ
 =

188 
	`°∫°r
(
hdr_vÆue
.
±r
, 
COOKIE_NAME
, hdr_vÆue.
Àn
Ë!
NULL
;

191 
	}
}

194 
	$tfw_˛i_c⁄n_£nd
(
TfwCliC⁄n
 *
˛i_c⁄n
, 
TfwMsg
 *
msg
)

196  
	`tfw_c⁄√˘i⁄_£nd
((
TfwC⁄n
 *)
˛i_c⁄n
, 
msg
);

197 
	}
}

201 
	$tfw_hâp_ª•_buûd_îr‹
(
TfwHâpReq
 *
ªq
)

203 ()
ªq
;

204 
	}
}

209 
	$hâp_°icky_suôe_£tup
()

211 
sk_buff
 *
skb
;

212 
TfwCliC⁄n
 *
˛i_c⁄n
;

214 
	`BUG_ON
(
mock
.
ªq
);

215 
	`BUG_ON
(
mock
.
ª•
);

217 
	`mem£t
(&
mock
, 0, (mock));

219 
mock
.
ªq
 = (
TfwHâpReq
 *)
	`__tfw_hâp_msg_Æloc
(
C⁄n_C t
, 
åue
);

220 
mock
.
ª•
 = 
	`tfw_hâp_msg_Æloc_ª•
(mock.
ªq
);

222 
	`BUG_ON
(!
mock
.
ªq
);

223 
	`BUG_ON
(!
mock
.
ª•
);

225 
skb
 = 
	`Æloc_skb
(
PAGE_SIZE
, 
GFP_ATOMIC
);

226 
	`BUG_ON
(!
skb
);

227 
	`skb_ª£rve
(
skb
, 
MAX_TCP_HEADER
);

228 
	`ss_skb_queue_èû
(&
mock
.
ªq
->
msg
.
skb_hód
, 
skb
);

230 
skb
 = 
	`Æloc_skb
(
PAGE_SIZE
, 
GFP_ATOMIC
);

231 
	`BUG_ON
(!
skb
);

232 
	`skb_ª£rve
(
skb
, 
MAX_TCP_HEADER
);

233 
	`ss_skb_queue_èû
(&
mock
.
ª•
->
msg
.
skb_hód
, 
skb
);

235 
	`tfw_c⁄√˘i⁄_öô
(&
mock
.
c⁄n_ªq
);

236 
	`tfw_c⁄√˘i⁄_öô
(&
mock
.
c⁄n_ª•
);

238 
˛i_c⁄n
 = (
TfwCliC⁄n
 *)&
mock
.
c⁄n_ªq
;

239 
	`INIT_LIST_HEAD
(&
˛i_c⁄n
->
£q_queue
);

240 
	`•ö_lock_öô
(&
˛i_c⁄n
->
£q_qlock
);

241 
	`•ö_lock_öô
(&
˛i_c⁄n
->
ªt_qlock
);

243 
	`tfw_c⁄√˘i⁄_ªvive
(&
mock
.
c⁄n_ªq
);

244 
mock
.
c⁄n_ªq
.
≥î
 = (
TfwPìr
 *)&mock.
˛õ¡
;

245 
mock
.
˛õ¡
.
addr
.
v4
.
sö_Ámûy
 = 
AF_INET
,

246 
mock
.
˛õ¡
.
addr
.
v4
.
sö_addr
.
s_addr
 = 
INADDR_ANY
,

247 
mock
.
˛õ¡
.
addr
.
v4
.
sö_p‹t
 = 0,

248 
mock
.
sock
.
sk_Ámûy
 = 
AF_INET
;

249 
mock
.
c⁄n_ªq
.
sk
 = &mock.
sock
;

251 
mock
.
ªq
->
c⁄n
 = &mock.
c⁄n_ªq
;

252 
mock
.
ª•
->
c⁄n
 = &mock.
c⁄n_ª•
;

253 
mock
.
ªq
->
vho°
 = 
	`tfw_vho°_√w
(
TFW_VH_DFT_NAME
);

255 
	`tfw_hâp_ªq_add_£q_queue
(
mock
.
ªq
);

256 
mock
.
ªq
->
ª•
 = mock.resp;

257 
	}
}

260 
	$hâp_°icky_suôe_ã¨down
()

262 i‡(
mock
.
ªq
) {

263 
	`tfw_c⁄√˘i⁄_put
(
mock
.
ªq
->
c⁄n
);

264 
	`INIT_LIST_HEAD
(&
mock
.
ªq
->
msg
.
£q_li°
);

265 
	`INIT_LIST_HEAD
(&
mock
.
ªq
->
fwd_li°
);

266 
	`INIT_LIST_HEAD
(&
mock
.
ªq
->
nù_li°
);

268 i‡(
mock
.
ªq
->
£ss
 && mock.ªq->£ss->
°_c⁄n
.
§v_c⁄n
)

269 
mock
.
ªq
->
£ss
->
°_c⁄n
.
§v_c⁄n
 = 
NULL
;

270 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
mock
.
ªq
);

272 
	`tfw_hâp_msg_‰ì
((
TfwHâpMsg
 *)
mock
.
ª•
);

274 
	`mem£t
(&
mock
, 0, (mock));

275 
	}
}

277 
	$TEST
(
hâp_°icky
, 
£ndög_302_wôhout_¥ï¨ög
)

279 
StickyVÆ
 
sv
 = {};

280 
TfwC⁄n
 *
c
 = 
mock
.
ªq
->
c⁄n
;

283 
	`EXPECT_EQ
(
	`tfw_hâp_°icky_£nd_ªdúe˘
(
mock
.
ªq
, &
sv
),

284 
TFW_HTTP_SESS_REDIRECT_SENT
);

286 
	`EXPECT_TRUE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

288 
	`tfw_c⁄√˘i⁄_put
(
c
);

289 
mock
.
ªq
 = 
NULL
;

290 
	}
}

292 
	$TEST
(
hâp_°icky
, 
£ndög_302
)

294 
	`¸óã_°r_poﬁ
();

297 
StickyVÆ
 
sv
 = { .
ts
 = 1 };

298 
TfwC⁄n
 *
c
 = 
mock
.
ªq
->
c⁄n
;

304 
	`TFW_STR2
(
hdr1
, "Host: ", "localhost");

306 
mock
.
ªq
->
h_tbl
->
tbl
[
TFW_HTTP_HDR_HOST
] = *
hdr1
;

308 
	`EXPECT_EQ
(
	`__°icky_ˇlc
(
mock
.
ªq
, &
sv
), 0);

309 
	`EXPECT_EQ
(
	`tfw_hâp_°icky_£nd_ªdúe˘
(
mock
.
ªq
, &
sv
),

310 
TFW_HTTP_SESS_REDIRECT_SENT
);

312 
	`EXPECT_TRUE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

313 
	`EXPECT_TRUE
(
mock
.
£í_£t_cookõ_hódî
);

314 
	`EXPECT_TRUE
(
mock
.
£í_cookõ
);

315 
	`EXPECT_EQ
(
mock
.
hâp_°©us
, 302);

317 
	`tfw_c⁄√˘i⁄_put
(
c
);

318 
mock
.
ªq
 = 
NULL
;

321 
	`‰ì_Æl_°r
();

322 
	}
}

324 
	$TEST
(
hâp_°icky
, 
£ndög_502
)

326 
StickyVÆ
 
sv
 = { .
ts
 = 1 };

327 
TfwC⁄n
 *
c
 = 
mock
.
ªq
->
c⁄n
;

329 
	`EXPECT_EQ
(
	`__°icky_ˇlc
(
mock
.
ªq
, &
sv
), 0);

330 
	`tfw_hâp_£nd_ª•
(
mock
.
ªq
, 502, "sticky calculation");

333 
	`EXPECT_TRUE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

334 
	`EXPECT_FALSE
(
mock
.
£í_£t_cookõ_hódî
);

335 
	`EXPECT_FALSE
(
mock
.
£í_cookõ
);

336 
	`EXPECT_EQ
(
mock
.
hâp_°©us
, 502);

338 
	`tfw_c⁄√˘i⁄_put
(
c
);

339 
mock
.
ªq
 = 
NULL
;

340 
	}
}

343 
	$≠≥nd_°rög_to_msg
(
TfwHâpMsg
 *
hm
, c⁄° *
s
)

345 
sk_buff
 *
skb
;

346 *
±r
;

347 
size_t
 
Àn
;

349 
	`BUG_ON
(!
s
);

350 
Àn
 = 
	`°æí
(
s
);

352 
skb
 = 
hm
->
msg
.
skb_hód
;

353 
	`BUG_ON
(!
skb
);

355 
±r
 = 
	`skb_put
(
skb
, 
Àn
);

356 
	`BUG_ON
(!
±r
);

357 
	`mem˝y
(
±r
, 
s
, 
Àn
);

358 
	}
}

361 
	$hâp_∑r£_hñ≥r
(
TfwHâpMsg
 *
hm
, 
ss_skb_a˘‹_t
 
a˘‹
)

363 
sk_buff
 *
skb
;

364 
∑r£d
 = 0, 
chunks
 = 0;

366 
skb
 = 
hm
->
msg
.
skb_hód
;

367 
	`BUG_ON
(!
skb
);

369 
r
 = 
	`ss_skb_¥o˚ss
(
skb
, 0, 0, 
a˘‹
, 
hm
, &
chunks
, &
∑r£d
);

370 
r
) {

371 
TFW_POSTPONE
:

372 i‡(
skb
->
√xt
 =
hm
->
msg
.
skb_hód
)

374 
skb
 = skb->
√xt
;

377 
TFW_PASS
:

385 
	}
}

388 
	$hâp_∑r£_ªq_hñ≥r
()

390  
	`hâp_∑r£_hñ≥r
((
TfwHâpMsg
 *)
mock
.
ªq
, 
tfw_hâp_∑r£_ªq
);

391 
	}
}

394 
	$hâp_∑r£_ª•_hñ≥r
()

397 
	`mem£t
(&
mock
.
ª•
->
∑r£r
, 0, (mock.resp->parser));

398 
	`tfw_hâp_öô_∑r£r_ª•
(
mock
.
ª•
);

399 
mock
.
ª•
->
h_tbl
->
off
 = 
TFW_HTTP_HDR_RAW
;

400 
	`mem£t
(
mock
.
ª•
->
h_tbl
->
tbl
, 0, 
	`__HHTBL_SZ
(1Ë* (
TfwSå
));

401 
	`TFW_STR_INIT
(&
mock
.
ª•
->
¸lf
);

402 
	`TFW_STR_INIT
(&
mock
.
ª•
->
body
);

403 
	`TFW_STR_INIT
(&
mock
.
ª•
->
s_löe
);

405  
	`hâp_∑r£_hñ≥r
((
TfwHâpMsg
 *)
mock
.
ª•
, 
tfw_hâp_∑r£_ª•
);

406 
	}
}

408 
	$TEST
(
hâp_°icky
, 
°icky_gë_ab£¡
)

410 
TfwSå
 
vÆue
 = {};

411 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\nHost:Üocalhost\r\n"

414 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ªq
, 
s_ªq
);

415 
	`EXPECT_EQ
(
	`hâp_∑r£_ªq_hñ≥r
(), 0);

418 
	`EXPECT_EQ
(
	`tfw_hâp_°icky_gë
(
mock
.
ªq
, &
vÆue
), 0);

419 
	}
}

422 
	$ã°_°icky_¥e£¡_hñ≥r
(c⁄° *
s_ªq
)

424 
TfwSå
 
vÆue
 = {};

426 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ªq
, 
s_ªq
);

427 
	`EXPECT_EQ
(
	`hâp_∑r£_ªq_hñ≥r
(), 0);

429 
	`EXPECT_EQ
(
	`tfw_hâp_°icky_gë
(
mock
.
ªq
, &
vÆue
), 1);

431 
	`EXPECT_TRUE
(
vÆue
.
Àn
 == 5);

432 
	`EXPECT_TRUE
(
vÆue
.
±r
 && 
	`memcmp
(value.ptr, "67890", 5) == 0);

433 
	}
}

435 
	$TEST
(
hâp_°icky
, 
°icky_gë_¥e£¡_begö
)

437 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\nContent-Length: 0\r\n"

438 "Cookõ: " 
COOKIE_NAME
 "=67890; __utmz=12345; "

441 
	`ã°_°icky_¥e£¡_hñ≥r
(
s_ªq
);

442 
	}
}

444 
	$TEST
(
hâp_°icky
, 
°icky_gë_¥e£¡_middÀ
)

446 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\nContent-Length: 0\r\n"

447 "Cookõ: __utmz=12345; " 
COOKIE_NAME
 "=67890; "

450 
	`ã°_°icky_¥e£¡_hñ≥r
(
s_ªq
);

451 
	}
}

453 
	$TEST
(
hâp_°icky
, 
°icky_gë_¥e£¡_íd
)

455 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\nContent-Length: 0\r\n"

457 
COOKIE_NAME
 "=67890\r\n\r\n";

459 
	`ã°_°icky_¥e£¡_hñ≥r
(
s_ªq
);

460 
	}
}

463 
	$TEST
(
hâp_°icky
, 
ªq_no_cookõ
)

465 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\nHost:Üocalhost\r\n\r\n";

466 c⁄° *
s_ª•
 = "HTTP/1.0 200 OK\r\nContent-Length: 0\r\n\r\n";

468 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ªq
, 
s_ªq
);

469 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ª•
, 
s_ª•
);

470 
	`EXPECT_EQ
(
	`hâp_∑r£_ªq_hñ≥r
(), 0);

471 
	`EXPECT_EQ
(
	`hâp_∑r£_ª•_hñ≥r
(), 0);

473 
	`EXPECT_EQ
(
	`tfw_hâp_£ss_obèö
(
mock
.
ªq
), 
TFW_HTTP_SESS_SUCCESS
);

474 
	`EXPECT_EQ
(
	`tfw_hâp_£ss_ª•_¥o˚ss
(
mock
.
ª•
), 0);

477 
	`EXPECT_FALSE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

480 
	`EXPECT_EQ
(
	`hâp_∑r£_ª•_hñ≥r
(), 0);

481 
	`tfw_c⁄√˘i⁄_£nd
(&
mock
.
c⁄n_ªq
, &mock.
ª•
->
msg
);

483 
	`EXPECT_TRUE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

484 
	`EXPECT_TRUE
(
mock
.
£í_£t_cookõ_hódî
);

485 
	`EXPECT_TRUE
(
mock
.
£í_cookõ
);

486 
	}
}

489 
	$TEST
(
hâp_°icky
, 
ªq_have_cookõ
)

491 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\n"

493 "Cookõ: " 
COOKIE_NAME


506 c⁄° *
s_ª•
 = "HTTP/1.0 200 OK\r\nContent-Length: 0\r\n\r\n";

508 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ªq
, 
s_ªq
);

509 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ª•
, 
s_ª•
);

510 
	`EXPECT_EQ
(
	`hâp_∑r£_ªq_hñ≥r
(), 0);

511 
	`EXPECT_EQ
(
	`hâp_∑r£_ª•_hñ≥r
(), 0);

513 
	`EXPECT_EQ
(
	`tfw_hâp_£ss_obèö
(
mock
.
ªq
), 
TFW_HTTP_SESS_SUCCESS
);

514 
	`EXPECT_EQ
(
	`tfw_hâp_£ss_ª•_¥o˚ss
(
mock
.
ª•
), 0);

517 
	`EXPECT_FALSE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

520 
	`EXPECT_EQ
(
	`hâp_∑r£_ª•_hñ≥r
(), 0);

521 
	`tfw_c⁄√˘i⁄_£nd
(&
mock
.
c⁄n_ªq
, &mock.
ª•
->
msg
);

524 
	`EXPECT_FALSE
(
mock
.
£í_£t_cookõ_hódî
);

525 
	`EXPECT_FALSE
(
mock
.
£í_cookõ
);

526 
	}
}

529 
	$TEST
(
hâp_°icky
, 
ªq_no_cookõ_íf‹˚
)

531 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\nHost:Üocalhost\r\n\r\n";

532 
TfwC⁄n
 *
c
 = 
mock
.
ªq
->
c⁄n
;

534 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ªq
, 
s_ªq
);

535 
	`EXPECT_EQ
(
	`hâp_∑r£_ªq_hñ≥r
(), 0);

536 
	`EXPECT_EQ
(
	`tfw_hâp_£ss_obèö
(
mock
.
ªq
), 
TFW_HTTP_SESS_REDIRECT_SENT
);

541 
	`EXPECT_TRUE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

542 
	`EXPECT_TRUE
(
mock
.
£í_£t_cookõ_hódî
);

543 
	`EXPECT_TRUE
(
mock
.
£í_cookõ
);

545 
	`tfw_c⁄√˘i⁄_put
(
c
);

546 
mock
.
ªq
 = 
NULL
;

547 
	}
}

550 
	$TEST
(
hâp_°icky
, 
ªq_have_cookõ_íf‹˚
)

552 c⁄° *
s_ªq
 = "GET / HTTP/1.0\r\n"

554 "Cookõ: " 
COOKIE_NAME


567 c⁄° *
s_ª•
 = "HTTP/1.0 200 OK\r\nContent-Length: 0\r\n\r\n";

569 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ªq
, 
s_ªq
);

570 
	`≠≥nd_°rög_to_msg
((
TfwHâpMsg
 *)
mock
.
ª•
, 
s_ª•
);

571 
	`EXPECT_EQ
(
	`hâp_∑r£_ªq_hñ≥r
(), 0);

572 
	`EXPECT_EQ
(
	`hâp_∑r£_ª•_hñ≥r
(), 0);

574 
	`EXPECT_EQ
(
	`tfw_hâp_£ss_obèö
(
mock
.
ªq
), 
TFW_HTTP_SESS_SUCCESS
);

575 
	`EXPECT_EQ
(
	`tfw_hâp_£ss_ª•_¥o˚ss
(
mock
.
ª•
), 0);

578 
	`EXPECT_FALSE
(
mock
.
tfw_c⁄√˘i⁄_£nd_was_ˇŒed
);

581 
	`EXPECT_EQ
(
	`hâp_∑r£_ª•_hñ≥r
(), 0);

582 
	`tfw_c⁄√˘i⁄_£nd
(&
mock
.
c⁄n_ªq
, &mock.
ª•
->
msg
);

585 
	`EXPECT_FALSE
(
mock
.
£í_£t_cookõ_hódî
);

586 
	`EXPECT_FALSE
(
mock
.
£í_cookõ
);

587 
	}
}

589 
	$TEST_SUITE
(
hâp_°icky
)

591 
TfwCfgE¡ry
 
˚_°icky
 = {

592 .
«me
 = "sticky",

593 .
vÆ_n
 = 1,

594 .
vÆs
 = { "enforce" },

595 .
©å_n
 = 1,

596 .
©ås
 = { { .
key
 = "«me", .
vÆ
 = 
COOKIE_NAME
 } },

597 .
have_chûdªn
 = 
Ál£


599 
TfwCfgE¡ry
 
˚_£¸ë
 = {

600 .
«me
 = "sticky_secret",

601 .
vÆ_n
 = 1,

602 .
vÆs
 = { "top_secret" },

605 
	`kî√l_Âu_íd
();

607 
	`TEST_SETUP
(
hâp_°icky_suôe_£tup
);

608 
	`TEST_TEARDOWN
(
hâp_°icky_suôe_ã¨down
);

610 
	`tfw_hâp_£ss_öô
();

613 
˚_°icky
.
vÆ_n
 = 0;

614 
	`tfw_cfg›_°icky
(&
tfw_hâp_£ss_mod
.
•ecs
[0], &
˚_°icky
);

615 
	`tfw_cfg›_°icky_£¸ë
(&
tfw_hâp_£ss_mod
.
•ecs
[1], &
˚_£¸ë
);

616 
	`tfw_hâp_£ss_cfgíd
();

618 
	`tfw_hâp_£ss_°¨t
();

620 
	`kî√l_Âu_begö
();

622 
	`TEST_RUN
(
hâp_°icky
, 
£ndög_302_wôhout_¥ï¨ög
);

623 
	`TEST_RUN
(
hâp_°icky
, 
£ndög_302
);

624 
	`TEST_RUN
(
hâp_°icky
, 
£ndög_502
);

625 
	`TEST_RUN
(
hâp_°icky
, 
°icky_gë_ab£¡
);

626 
	`TEST_RUN
(
hâp_°icky
, 
°icky_gë_¥e£¡_begö
);

627 
	`TEST_RUN
(
hâp_°icky
, 
°icky_gë_¥e£¡_middÀ
);

628 
	`TEST_RUN
(
hâp_°icky
, 
°icky_gë_¥e£¡_íd
);

629 
	`TEST_RUN
(
hâp_°icky
, 
ªq_no_cookõ
);

630 
	`TEST_RUN
(
hâp_°icky
, 
ªq_have_cookõ
);

633 
˚_°icky
.
vÆ_n
 = 1;

634 
	`tfw_cfg›_°icky
(&
tfw_hâp_£ss_mod
.
•ecs
[0], &
˚_°icky
);

635 
	`TEST_RUN
(
hâp_°icky
, 
ªq_no_cookõ_íf‹˚
);

636 
	`TEST_RUN
(
hâp_°icky
, 
ªq_have_cookõ_íf‹˚
);

638 
	`kî√l_Âu_íd
();

641 
	`tfw_cfg›_˛ónup_°icky
(&
tfw_hâp_£ss_mod
.
•ecs
[0]);

642 
	`tfw_hâp_£ss_°›
();

643 
	`tfw_hâp_£ss_exô
();

645 
	`kî√l_Âu_begö
();

646 
	}
}

	@t/unit/test_http_tbl.c

20 
	~<löux/ty≥s.h
>

21 
	~<asm/Âu/≠i.h
>

23 #unde‡
tfw_sock_§v_öô


24 
	#tfw_sock_§v_öô
 
ã°_hâp_sock_§v_c⁄n_öô


	)

25 #unde‡
tfw_sock_§v_exô


26 
	#tfw_sock_§v_exô
 
ã°_hâp_sock_§v_exô


	)

27 #unde‡
tfw_§v_c⁄n_ªÀa£


28 
	#tfw_§v_c⁄n_ªÀa£
 
ã°_hâp_§v_c⁄n_ªÀa£


	)

29 #unde‡
tfw_sock_§v_mod


30 
	#tfw_sock_§v_mod
 
ã°_hâp_sock_§v_mod


	)

32 
	~"sock_§v.c
"

33 
	~"vho°.c
"

34 
	~"hâp_tbl.c
"

36 
	~"cfg.h
"

37 
	~"hâp_msg.h
"

38 
	~"hñ≥rs.h
"

39 
	~"sched_hñ≥r.h
"

40 
	~"ã°.h
"

43 
	$∑r£_cfg
(c⁄° *
cfg_ãxt
)

45 
li°_hód
 
mod_li°
;

46 
TfwMod
 
vho°_mod
, 
tbl_mod
;

47 
r
;

49 
	`kî√l_Âu_íd
();

51 
	`INIT_LIST_HEAD
(&
mod_li°
);

53 
vho°_mod
 = *
	`tfw_mod_föd
("vhost");

54 
	`INIT_LIST_HEAD
(&
vho°_mod
.
li°
);

55 
	`li°_add
(&
vho°_mod
.
li°
, &
mod_li°
);

57 
tbl_mod
 = *
	`tfw_mod_föd
("http_tbl");

58 
	`INIT_LIST_HEAD
(&
tbl_mod
.
li°
);

59 
	`li°_add
(&
tbl_mod
.
li°
, &
mod_li°
);

68 
r
 = 
	`tfw_vho°_cfg°¨t
();

69 
r
 |
	`tfw_hâp_tbl_cfg°¨t
();

70 
r
 |
	`tfw_cfg_∑r£_mods
(
cfg_ãxt
, &
mod_li°
);

71 
r
 |
	`tfw_vho°_cfgíd
();

72 
r
 |
	`tfw_vho°_°¨t
();

73 
r
 |
	`tfw_hâp_tbl_°¨t
();

75 
	`kî√l_Âu_begö
();

77  
r
;

78 
	}
}

81 
	$˛ónup_cfg
()

83 
TfwMod
 
tbl_mod
, 
vho°_mod
;

85 
	`kî√l_Âu_íd
();

87 
tbl_mod
 = *
	`tfw_mod_föd
("http_tbl");

88 
	`ã°_•ec_˛ónup
(
tbl_mod
.
•ecs
);

89 
vho°_mod
 = *
	`tfw_mod_föd
("vhost");

90 
	`ã°_•ec_˛ónup
(
vho°_mod
.
•ecs
);

92 
	`kî√l_Âu_begö
();

93 
	}
}

96 
	$ã°_ªq
(*
ªq_°r
, 
TfwSrvC⁄n
 *
ex≥˘_c⁄n
)

98 
boﬁ
 
block
 = 
Ál£
;

99 
∑r£d
;

100 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
NULL
;

101 
TfwHâpReq
 *
ªq
 = 
	`ã°_ªq_Æloc
(
ªq_°r
? 
	`°æí
(req_str): 1);

103 i‡(
ªq_°r
) {

104 
ªq_°r_c›y
[
PAGE_SIZE
];

105 c⁄° 
size_t
 
ªq_°r_Àn
 = 
	`°æí
(
ªq_°r
);

107 
	`BUG_ON
(
ªq_°r_Àn
 + 1 > (
ªq_°r_c›y
));

108 
	`°r˝y
(
ªq_°r_c›y
, 
ªq_°r
);

109 
	`tfw_hâp_∑r£_ªq
(
ªq
, 
ªq_°r_c›y
, 
ªq_°r_Àn
, &
∑r£d
);

112 
ªq
->
vho°
 = 
	`tfw_hâp_tbl_vho°
((
TfwMsg
 *Ïeq, &
block
);

113 i‡(
ªq
->
vho°
) {

114 
	`EXPECT_FALSE
(
block
);

115 
§v_c⁄n
 = 
	`tfw_vho°_gë_§v_c⁄n
((
TfwMsg
 *)
ªq
);

117 
	`EXPECT_EQ
(
§v_c⁄n
, 
ex≥˘_c⁄n
);

119 
	`ã°_ªq_‰ì
(
ªq
);

120 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

121 
	}
}

123 
	$TEST
(
hâp_tbl
, 
⁄e_wûdˇrd_ruÀ
)

125 
TfwSrvGroup
 *
sg
;

126 
TfwSîvî
 *
§v
;

127 
TfwSrvC⁄n
 *
ex≥˘_c⁄n
;

129 
sg
 = 
	`ã°_¸óã_sg
("default");

130 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

131 
ex≥˘_c⁄n
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

132 
	`ã°_°¨t_sg
(
sg
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

134 i‡(
	`∑r£_cfg
("vhost default {\nproxy_pass default;\n}\n\
_chain {\n -> default;\n}\n")) {

136 
	`TEST_FAIL
("can'tÖarseÑules\n");

139 
	`ã°_ªq
(
NULL
, 
ex≥˘_c⁄n
);

141 
	`˛ónup_cfg
();

142 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

143 
	`ã°_sg_ªÀa£_Æl
();

144 
	}
}

146 
	$TEST
(
hâp_tbl
, 
some_ruÀs
)

148 
TfwSîvî
 *
§v
;

149 
TfwSrvGroup
 *
sg1
, *
sg2
, *
sg3
, *
sg4
, *
sg5
, *
sg6
, *
sg7
, *
sg8
,

150 *
sg9
, *
sg10
;

151 
TfwSrvC⁄n
 *
ex≥˘_c⁄n1
, *
ex≥˘_c⁄n2
, *
ex≥˘_c⁄n3
, *
ex≥˘_c⁄n4
,

152 *
ex≥˘_c⁄n5
, *
ex≥˘_c⁄n6
, *
ex≥˘_c⁄n7
, *
ex≥˘_c⁄n8
,

153 *
ex≥˘_c⁄n9
, *
ex≥˘_c⁄n10
;

155 
sg1
 = 
	`ã°_¸óã_sg
("sg1");

156 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg1
);

157 
ex≥˘_c⁄n1
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

158 
	`ã°_°¨t_sg
(
sg1
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

160 
sg2
 = 
	`ã°_¸óã_sg
("sg2");

161 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg2
);

162 
ex≥˘_c⁄n2
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

163 
	`ã°_°¨t_sg
(
sg2
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

165 
sg3
 = 
	`ã°_¸óã_sg
("sg3");

166 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg3
);

167 
ex≥˘_c⁄n3
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

168 
	`ã°_°¨t_sg
(
sg3
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

170 
sg4
 = 
	`ã°_¸óã_sg
("sg4");

171 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg4
);

172 
ex≥˘_c⁄n4
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

173 
	`ã°_°¨t_sg
(
sg4
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

175 
sg5
 = 
	`ã°_¸óã_sg
("sg5");

176 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg5
);

177 
ex≥˘_c⁄n5
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

178 
	`ã°_°¨t_sg
(
sg5
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

180 
sg6
 = 
	`ã°_¸óã_sg
("sg6");

181 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg6
);

182 
ex≥˘_c⁄n6
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

183 
	`ã°_°¨t_sg
(
sg6
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

185 
sg7
 = 
	`ã°_¸óã_sg
("sg7");

186 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg7
);

187 
ex≥˘_c⁄n7
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

188 
	`ã°_°¨t_sg
(
sg7
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

190 
sg8
 = 
	`ã°_¸óã_sg
("sg8");

191 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg8
);

192 
ex≥˘_c⁄n8
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

193 
	`ã°_°¨t_sg
(
sg8
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

195 
sg9
 = 
	`ã°_¸óã_sg
("sg9");

196 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg9
);

197 
ex≥˘_c⁄n9
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

198 
	`ã°_°¨t_sg
(
sg9
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

200 
sg10
 = 
	`ã°_¸óã_sg
("sg10");

201 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg10
);

202 
ex≥˘_c⁄n10
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

203 
	`ã°_°¨t_sg
(
sg10
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

205 i‡(
	`∑r£_cfg
("vhost vh1 {\nproxy_pass sg1;\n}\n\
 vh2 {\nproxy_pass sg2;\n}\n\
 vh3 {\nproxy_pass sg3;\n}\n\
 vh4 {\nproxy_pass sg4;\n}\n\
 vh5 {\nproxy_pass sg5;\n}\n\
 vh6 {\nproxy_pass sg6;\n}\n\
 vh7 {\nproxy_pass sg7;\n}\n\
 vh8 {\nproxy_pass sg8;\n}\n\
 vh9 {\nproxy_pass sg9;\n}\n\
 vh10 {\nproxy_pass sg10;\n}\n\
_chain {\nuri == /foo -> vh1;\n\
 == /foo/bar* -> vh2;\n\
 ==Çatsys-lab.com -> vh3;\n\
 ==Çatsys-lab* -> vh4;\n\
_host == google.com -> vh5;\n\
_host == google* -> vh6;\n\
_conn == close -> vh7;\n\
_conn == Keep* -> vh8;\n\
_raw == User-Agent:Bot -> vh9;\n\
_raw == X-Forwarded-For* -> vh10;\n}\n")) {

225 
	`TEST_FAIL
("can'tÖarseÑules\n");

228 
	`ã°_ªq
("GET hâp://«tsys-œb.com/foÿHTTP/1.1\r\n\r\n", 
ex≥˘_c⁄n1
);

229 
	`ã°_ªq
("GET hâp://«tsys-œb.com/foo/b¨/ HTTP/1.1\r\n\r\n", 
ex≥˘_c⁄n2
);

230 
	`ã°_ªq
("GET hâp://«tsys-œb.com/foo/baz/ HTTP/1.1\r\n\r\n", 
ex≥˘_c⁄n3
);

231 
	`ã°_ªq
("GET hâp://«tsys-œb2.com/foo/baz/ HTTP/1.1\r\n\r\n", 
ex≥˘_c⁄n4
);

232 
	`ã°_ªq
("GET hâp://googÀ.com/foo/baz/ HTTP/1.1\r\nHo°: googÀ.com\r\n\r\n", 
ex≥˘_c⁄n5
);

233 
	`ã°_ªq
("GET hâp://googÀ.com/foo/baz/ HTTP/1.1\r\nHo°: googÀ2.com\r\n\r\n", 
ex≥˘_c⁄n6
);

234 
	`ã°_ªq
("GET hâp://googÀ.com/foo/baz/ HTTP/1.1\r\nC⁄√˘i⁄: clo£\r\n\r\n", 
ex≥˘_c⁄n7
);

235 
	`ã°_ªq
("GET hâp://googÀ.com/foo/baz/ HTTP/1.1\r\nC⁄√˘i⁄: Kìp-Alive\r\n\r\n", 
ex≥˘_c⁄n8
);

236 
	`ã°_ªq
("GET hâp://googÀ.com/foo/baz/ HTTP/1.1\r\nU£r-Agít:BŸ\r\n\r\n", 
ex≥˘_c⁄n9
);

237 
	`ã°_ªq
("GET hâp://googÀ.com/foo/baz/ HTTP/1.1\r\nX-F‹w¨ded-F‹: 127.0.0.1\r\n\r\n", 
ex≥˘_c⁄n10
);

238 
	`ã°_ªq
("GET hâp://googÀ.com/foo/baz/ HTTP/1.1\r\n\r\n", 
NULL
);

240 
	`˛ónup_cfg
();

241 
	`ã°_c⁄n_ªÀa£_Æl
(
sg1
);

242 
	`ã°_c⁄n_ªÀa£_Æl
(
sg2
);

243 
	`ã°_c⁄n_ªÀa£_Æl
(
sg3
);

244 
	`ã°_c⁄n_ªÀa£_Æl
(
sg4
);

245 
	`ã°_c⁄n_ªÀa£_Æl
(
sg5
);

246 
	`ã°_c⁄n_ªÀa£_Æl
(
sg6
);

247 
	`ã°_c⁄n_ªÀa£_Æl
(
sg7
);

248 
	`ã°_c⁄n_ªÀa£_Æl
(
sg8
);

249 
	`ã°_c⁄n_ªÀa£_Æl
(
sg9
);

250 
	`ã°_c⁄n_ªÀa£_Æl
(
sg10
);

251 
	`ã°_sg_ªÀa£_Æl
();

252 
	}
}

255 *
	mruÀ_°r
;

256 *
	mgood_ªq_°r
;

257 *
	mbad_ªq_°r
;

258 } 
	tTe°Ca£
;

260 
Te°Ca£
 
	gã°_ˇ£s
[] = {

262 .
ruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nuri == /foo -> default;\n}\n",

264 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\n\r\n",

265 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/foo2 HTTP/1.1\r\n\r\n",

268 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nuri == /foo* -> default;\n}\n",

270 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo2 HTTP/1.1\r\n\r\n",

271 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/bar HTTP/1.1\r\n\r\n",

274 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhost ==Çatsys-lab.com -> default;\n}\n",

276 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\n\r\n",

277 .
	gbad_ªq_°r
 = "GET http://natsys-lab2.com/foo HTTP/1.1\r\n\r\n",

280 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhost ==Çatsys-lab* -> default;\n}\n",

282 .
	ggood_ªq_°r
 = "GET http://natsys-lab2.com/foo HTTP/1.1\r\n\r\n",

283 .
	gbad_ªq_°r
 = "GET http://google.com/foo HTTP/1.1\r\n\r\n",

286 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhdr_host ==Çatsys-lab.com -> default;\n}\n",

288 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nHost:Çatsys-lab.com\r\n\r\n",

289 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nHost:Çatsys-lab2.com\r\n\r\n",

292 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhdr_host ==Çatsys-lab* -> default;\n}\n",

294 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nHost:Çatsys-lab2.com\r\n\r\n",

295 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nHost: google.com\r\n\r\n",

298 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhdr_conn == Keep-Alive -> default;\n}\n",

300 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nConnection: Keep-Alive\r\n\r\n",

301 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nConnection: close\r\n\r\n",

304 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhdr_conn == Keep* -> default;\n}\n",

306 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nConnection: Keep-Alive\r\n\r\n",

307 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nConnection: close\r\n\r\n",

310 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhdr_raw == User-Agent:Bot -> default;\n}\n",

312 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nUser-Agent:Bot\r\n\r\n",

313 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nUser-Agent:Tot\r\n\r\n",

316 .
	gruÀ_°r
 = "vhost default {\nproxy_pass default;\n}\n\
_chain {\nhdr_raw == User-Agent* -> default;\n}\n",

318 .
	ggood_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nUser-Agent: Bot\r\n\r\n",

319 .
	gbad_ªq_°r
 = "GET http://natsys-lab.com/foo HTTP/1.1\r\nConnection: close\r\n\r\n",

323 
size_t
 
	gã°_ˇ£s_size
 = 
ARRAY_SIZE
(
ã°_ˇ£s
);

325 
	$TEST
(
hâp_tbl
, 
⁄e_ruÀ
)

327 
i
;

329 
i
 = 0; i < 
ã°_ˇ£s_size
; ++i)

331 
TfwSrvGroup
 *
sg
;

332 
TfwSîvî
 *
§v
;

333 
TfwSrvC⁄n
 *
ex≥˘_c⁄n
;

335 
sg
 = 
	`ã°_¸óã_sg
("default");

336 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

337 
ex≥˘_c⁄n
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

338 
	`ã°_°¨t_sg
(
sg
, "øtio", 
TFW_SG_F_SCHED_RATIO_STATIC
);

340 i‡(
	`∑r£_cfg
(
ã°_ˇ£s
[
i
].
ruÀ_°r
)) {

341 
	`TEST_FAIL
("can'tÖarseÑules\n");

344 
	`ã°_ªq
(
ã°_ˇ£s
[
i
].
good_ªq_°r
, 
ex≥˘_c⁄n
);

345 
	`ã°_ªq
(
ã°_ˇ£s
[
i
].
bad_ªq_°r
, 
NULL
);

347 
	`˛ónup_cfg
();

348 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

349 
	`ã°_sg_ªÀa£_Æl
();

351 
	}
}

353 
	$TEST_SUITE
(
hâp_tbl
)

355 
TfwScheduÀr
 *
s
;

357 
	`kî√l_Âu_íd
();

359 
s
 = 
	`tfw_sched_lookup
("ratio");

360 i‡(!
s
)

361 
	`tfw_sched_øtio_öô
();

362 
	`tfw_vho°_öô
();

363 
	`tfw_hâp_tbl_öô
();

364 
	`tfw_£rvî_öô
();

366 
	`kî√l_Âu_begö
();

368 
	`TEST_RUN
(
hâp_tbl
, 
⁄e_wûdˇrd_ruÀ
);

369 
	`TEST_RUN
(
hâp_tbl
, 
some_ruÀs
);

370 
	`TEST_RUN
(
hâp_tbl
, 
⁄e_ruÀ
);

371 
	}
}

	@t/unit/test_mem_fast.c

20 
	~<löux/bug.h
>

21 
	~<löux/˘y≥.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/°rög.h
>

24 
	~<löux/skbuff.h
>

26 
	~"lib/°r.h
"

27 
	~"ã°.h
"

29 
	ga
[512], 
	gb
[512];

32 
run_ã°s_£t
((*
ã°_‚
)(
size_t
 
off
, size_à
n
))

34 
	`ã°_‚
(0, 0);

35 
	`ã°_‚
(0, 1);

36 
	`ã°_‚
(1, 0);

37 
	`ã°_‚
(1, 1);

38 
	`ã°_‚
(1, 2);

39 
	`ã°_‚
(2, 2);

40 
	`ã°_‚
(0, 2);

41 
	`ã°_‚
(3, 3);

42 
	`ã°_‚
(3, 4);

43 
	`ã°_‚
(1, 4);

44 
	`ã°_‚
(3, 5);

45 
	`ã°_‚
(1, 5);

46 
	`ã°_‚
(3, 7);

47 
	`ã°_‚
(1, 7);

48 
	`ã°_‚
(1, 8);

49 
	`ã°_‚
(0, 8);

50 
	`ã°_‚
(3, 8);

51 
	`ã°_‚
(0, 9);

52 
	`ã°_‚
(3, 11);

53 
	`ã°_‚
(2, 13);

54 
	`ã°_‚
(0, 16);

55 
	`ã°_‚
(2, 16);

56 
	`ã°_‚
(3, 17);

57 
	`ã°_‚
(7, 19);

58 
	`ã°_‚
(16, 30);

59 
	`ã°_‚
(0, 32);

60 
	`ã°_‚
(1, 32);

61 
	`ã°_‚
(11, 32);

62 
	`ã°_‚
(16, 32);

63 
	`ã°_‚
(8, 37);

64 
	`ã°_‚
(16, 48);

65 
	`ã°_‚
(29, 49);

66 
	`ã°_‚
(17, 50);

67 
	`ã°_‚
(1, 63);

68 
	`ã°_‚
(0, 64);

69 
	`ã°_‚
(4, 64);

70 
	`ã°_‚
(47, 64);

71 
	`ã°_‚
(41, 65);

72 
	`ã°_‚
(50, 79);

73 
	`ã°_‚
(7, 100);

74 
	`ã°_‚
(29, 127);

75 
	`ã°_‚
(7, 128);

76 
	`ã°_‚
(8, 250);

77 
	`ã°_‚
(11, 383);

78 
	}
}

81 
	$__mem˝y_ã°
(
size_t
 
off
, size_à
n
)

83 
i
;

85 
	`mem£t
((*)
a
, 0, (a));

86 
i
 = 0; i < (
b
); ++i)

87 
b
[
i
] = (i & 0xff) ? : 0xa;

89 
	`mem˝y_Á°
((*)&
a
[
off
], (*)&
b
[off], 
n
);

91 
i
 = 0; i < (
a
); ++i)

92 
	`EXPECT_FALSE
((
i
 >
off
 && i < of‡+ 
n


93 && 
a
[
i
] != ((i & 0xff) ? : 0xa))

94 || ((
i
 < 
off
 || i >of‡+ 
n
Ë&& 
a
[i]));

95 
	}
}

98 
	$__memcmp_ã°
(
size_t
 
off
, size_à
n
)

100 
i
, 
r0
, 
r1
;

102 
i
 = 0; i < (
a
); ++i) {

103 
a
[
i
] = (i & 0xff) ? : 0xa;

104 
b
[
i
] = (i & 0xff) ? : 0xa;

108 
r0
 = 
	`memcmp_Á°
((c⁄° *)&
a
[
off
], (c⁄° *)&
b
[off], 
n
);

109 
r1
 = !!
	`memcmp
((c⁄° *)&
a
[
off
], (c⁄° *)&
b
[off], 
n
);

110 
	`EXPECT_EQ
(
r0
, 
r1
);

113 ++
a
[
off
 + 
n
++];

114 
n
 +
off
 ? : 1;

115 
r0
 = 
	`memcmp_Á°
((c⁄° *)&
a
[
off
], (c⁄° *)&
b
[off], 
n
);

116 
r1
 = !!
	`memcmp
((c⁄° *)&
a
[
off
], (c⁄° *)&
b
[off], 
n
);

117 
	`EXPECT_EQ
(
r0
, 
r1
);

118 
	}
}

121 
	$__bzîo_ã°
(
size_t
 
off
, size_à
n
)

123 
i
;

125 
i
 = 0; i < (
a
); ++i)

126 
a
[
i
] = (i & 0xff) ? : 0xa;

128 
	`bzîo_Á°
((*)&
a
[
off
], 
n
);

130 
i
 = 0; i < (
a
); ++i)

131 
	`EXPECT_FALSE
((
i
 >
off
 && i < of‡+ 
n
 && 
a
[i])

132 || ((
i
 < 
off
 || i >of‡+ 
n
)

133 && 
a
[
i
] != ((i & 0xff) ? : 0xa)));

134 
	}
}

136 
	$TEST
(
mem˝y
, 
mem˝y_Á°
)

138 
	`run_ã°s_£t
(
__mem˝y_ã°
);

139 
	}
}

141 
	$TEST
(
memcmp
, 
memcmp_Á°
)

143 
	`run_ã°s_£t
(
__memcmp_ã°
);

144 
	}
}

146 
	$TEST
(
mem£t
, 
bzîo_Á°
)

148 
	`run_ã°s_£t
(
__bzîo_ã°
);

149 
	}
}

151 
	$TEST_SUITE
(
mem_Á°
)

153 
	`TEST_RUN
(
mem˝y
, 
mem˝y_Á°
);

154 
	`TEST_RUN
(
memcmp
, 
memcmp_Á°
);

155 
	`TEST_RUN
(
mem£t
, 
bzîo_Á°
);

156 
	}
}

	@t/unit/test_sched_hash.c

21 
	~<löux/ty≥s.h
>

22 
	~<asm/Âu/≠i.h
>

24 #unde‡
tfw_sock_§v_öô


25 
	#tfw_sock_§v_öô
 
ã°_hash_sock_§v_c⁄n_öô


	)

26 #unde‡
tfw_sock_§v_exô


27 
	#tfw_sock_§v_exô
 
ã°_hash_sock_§v_exô


	)

28 #unde‡
tfw_§v_c⁄n_ªÀa£


29 
	#tfw_§v_c⁄n_ªÀa£
 
ã°_hash_§v_c⁄n_ªÀa£


	)

30 #unde‡
tfw_sock_§v_mod


31 
	#tfw_sock_§v_mod
 
ã°_hash_sock_§v_mod


	)

33 
	~"sock_§v.c
"

34 
	~"hâp_sched_hash.c
"

36 
	~"hñ≥rs.h
"

37 
	~"hâp_msg.h
"

38 
	~"sched_hñ≥r.h
"

39 
	~"ã°.h
"

41 *
	gªq_°rs
[] = {

48 
TfwMsg
 *
sched_hash_gë_¨g
(
size_t
 
c⁄n_ty≥
);

49 
sched_hash_‰ì_¨g
(
TfwMsg
 *
msg
);

51 
Te°SchedHñ≥r
 
	gsched_hñ≥r_hash
 = {

52 .
sched
 = "hash",

53 .
	gc⁄n_ty≥s
 = 
ARRAY_SIZE
(
ªq_°rs
),

54 .
	ggë_sched_¨g
 = &
sched_hash_gë_¨g
,

55 .
	g‰ì_sched_¨g
 = &
sched_hash_‰ì_¨g
,

59 
	$sched_hash_‰ì_¨g
(
TfwMsg
 *
msg
)

61 
	`ã°_ªq_‰ì
((
TfwHâpReq
 *)
msg
);

62 
	}
}

64 
TfwMsg
 *

65 
	$sched_hash_gë_¨g
(
size_t
 
c⁄n_ty≥
)

67 
TfwHâpReq
 *
ªq
 = 
NULL
;

68 
∑r£d
;

70 
	`BUG_ON
(
c⁄n_ty≥
 >
sched_hñ≥r_hash
.
c⁄n_ty≥s
);

72 
ªq
 = 
	`ã°_ªq_Æloc
(
	`°æí
(
ªq_°rs
[
c⁄n_ty≥
]));

73 
	`tfw_hâp_∑r£_ªq
(
ªq
, (*)
ªq_°rs
[
c⁄n_ty≥
],

74 
	`°æí
(
ªq_°rs
[
c⁄n_ty≥
]), &
∑r£d
);

76  (
TfwMsg
 *Ë
ªq
;

77 
	}
}

79 
	$TEST
(
tfw_sched_hash
, 
sched_sg_⁄e_§v_max_c⁄n
)

81 
size_t
 
i
, 
j
;

83 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

84 
TfwSîvî
 *
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

86 
i
 = 0; i < 
TFW_TEST_SRV_MAX_CONN_N
; ++i)

87 
	`ã°_¸óã_§v_c⁄n
(
§v
);

88 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_hash
.
sched
, 0);

91 
i
 = 0; i < 
sched_hñ≥r_hash
.
c⁄n_ty≥s
; ++i) {

92 
TfwMsg
 *
msg
 = 
sched_hñ≥r_hash
.
	`gë_sched_¨g
(
i
);

93 
TfwSrvC⁄n
 *
exp_c⁄n
 = 
NULL
;

95 
j
 = 0; j < 
§v
->
c⁄n_n
; ++j) {

96 
TfwSrvC⁄n
 *
§v_c⁄n
 =

97 
sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, sg);

98 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

99 i‡(!
§v_c⁄n
) {

100 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

101 
îr
;

104 i‡(!
exp_c⁄n
)

105 
exp_c⁄n
 = 
§v_c⁄n
;

107 
	`EXPECT_EQ
(
§v_c⁄n
, 
exp_c⁄n
);

109 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

114 
	`kî√l_Âu_íd
();

115 
	`scheduÀ
();

116 
	`kî√l_Âu_begö
();

118 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

120 
îr
:

121 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

122 
	`ã°_sg_ªÀa£_Æl
();

123 
	}
}

125 
	$TEST
(
tfw_sched_hash
, 
sched_sg_max_§v_max_c⁄n
)

127 
i
, 
j
;

129 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

131 
i
 = 0; i < 
TFW_TEST_SG_MAX_SRV_N
; ++i) {

132 
TfwSîvî
 *
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

134 
j
 = 0; j < 
TFW_TEST_SRV_MAX_CONN_N
; ++j)

135 
	`ã°_¸óã_§v_c⁄n
(
§v
);

137 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_hash
.
sched
, 0);

140 
i
 = 0; i < 
sched_hñ≥r_hash
.
c⁄n_ty≥s
; ++i) {

141 
TfwMsg
 *
msg
 = 
sched_hñ≥r_hash
.
	`gë_sched_¨g
(
i
);

142 
TfwSrvC⁄n
 *
exp_c⁄n
 = 
NULL
;

144 
j
 = 0; j < 
TFW_TEST_SG_MAX_CONN_N
; ++j) {

145 
TfwSrvC⁄n
 *
§v_c⁄n
 =

146 
sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, sg);

147 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

148 i‡(!
§v_c⁄n
) {

149 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

150 
îr
;

153 i‡(!
exp_c⁄n
)

154 
exp_c⁄n
 = 
§v_c⁄n
;

156 
	`EXPECT_EQ
(
§v_c⁄n
, 
exp_c⁄n
);

158 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

163 
	`kî√l_Âu_íd
();

164 
	`scheduÀ
();

165 
	`kî√l_Âu_begö
();

167 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

169 
îr
:

170 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

171 
	`ã°_sg_ªÀa£_Æl
();

172 
	}
}

174 
	$TEST
(
tfw_sched_hash
, 
sched_§v_⁄e_§v_max_c⁄n
)

176 
size_t
 
i
, 
j
;

178 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

179 
TfwSîvî
 *
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

181 
i
 = 0; i < 
TFW_TEST_SRV_MAX_CONN_N
; ++i)

182 
	`ã°_¸óã_§v_c⁄n
(
§v
);

183 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_hash
.
sched
, 0);

186 
i
 = 0; i < 
sched_hñ≥r_hash
.
c⁄n_ty≥s
; ++i) {

187 
TfwMsg
 *
msg
 = 
sched_hñ≥r_hash
.
	`gë_sched_¨g
(
i
);

188 
TfwSrvC⁄n
 *
exp_c⁄n
 = 
NULL
;

190 
j
 = 0; j < 
§v
->
c⁄n_n
; ++j) {

191 
TfwSrvC⁄n
 *
§v_c⁄n
 =

192 
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, 
§v
);

194 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

195 i‡(!
§v_c⁄n
) {

196 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

197 
îr
;

199 
	`EXPECT_EQ
((
TfwSîvî
 *)
§v_c⁄n
->
≥î
, 
§v
);

201 i‡(!
exp_c⁄n
)

202 
exp_c⁄n
 = 
§v_c⁄n
;

204 
	`EXPECT_EQ
(
§v_c⁄n
, 
exp_c⁄n
);

206 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

211 
	`kî√l_Âu_íd
();

212 
	`scheduÀ
();

213 
	`kî√l_Âu_begö
();

215 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

217 
îr
:

218 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

219 
	`ã°_sg_ªÀa£_Æl
();

220 
	}
}

222 
	$TEST
(
tfw_sched_hash
, 
sched_§v_max_§v_max_c⁄n
)

224 
size_t
 
i
, 
j
;

226 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

228 
i
 = 0; i < 
TFW_TEST_SG_MAX_SRV_N
; ++i) {

229 
TfwSîvî
 *
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

231 
j
 = 0; j < 
TFW_TEST_SRV_MAX_CONN_N
; ++j)

232 
	`ã°_¸óã_§v_c⁄n
(
§v
);

234 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_hash
.
sched
, 0);

237 
i
 = 0; i < 
sched_hñ≥r_hash
.
c⁄n_ty≥s
; ++i) {

238 
TfwMsg
 *
msg
 = 
sched_hñ≥r_hash
.
	`gë_sched_¨g
(
i
);

239 
TfwSîvî
 *
§v
;

241 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

242 
TfwSrvC⁄n
 *
exp_c⁄n
 = 
NULL
;

244 
j
 = 0; j < 
TFW_TEST_SG_MAX_CONN_N
; ++j) {

245 
TfwSrvC⁄n
 *
§v_c⁄n
 =

246 
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, 
§v
);

248 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

249 i‡(!
§v_c⁄n
) {

250 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

251 
îr
;

253 
	`EXPECT_EQ
((
TfwSîvî
 *)
§v_c⁄n
->
≥î
, 
§v
);

255 i‡(!
exp_c⁄n
)

256 
exp_c⁄n
 = 
§v_c⁄n
;

258 
	`EXPECT_EQ
(
§v_c⁄n
, 
exp_c⁄n
);

260 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

266 
	`kî√l_Âu_íd
();

267 
	`scheduÀ
();

268 
	`kî√l_Âu_begö
();

271 
sched_hñ≥r_hash
.
	`‰ì_sched_¨g
(
msg
);

273 
îr
:

274 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

275 
	`ã°_sg_ªÀa£_Æl
();

276 
	}
}

278 
	$TEST
(
tfw_sched_hash
, 
sched_§v_ofÊöe_§v
)

280 
	`ã°_sched_§v_ofÊöe_§v
(&
sched_hñ≥r_hash
);

281 
	}
}

283 
	$TEST_SUITE
(
sched_hash
)

285 
	`kî√l_Âu_íd
();

287 
	`tfw_sched_hash_öô
();

288 
	`tfw_£rvî_öô
();

290 
	`kî√l_Âu_begö
();

292 
	`TEST_RUN
(
tfw_sched_hash
, 
sched_sg_⁄e_§v_max_c⁄n
);

293 
	`TEST_RUN
(
tfw_sched_hash
, 
sched_sg_max_§v_max_c⁄n
);

295 
	`TEST_RUN
(
tfw_sched_hash
, 
sched_§v_⁄e_§v_max_c⁄n
);

296 
	`TEST_RUN
(
tfw_sched_hash
, 
sched_§v_max_§v_max_c⁄n
);

297 
	`TEST_RUN
(
tfw_sched_hash
, 
sched_§v_ofÊöe_§v
);

298 
	}
}

	@t/unit/test_sched_ratio.c

21 
	~<löux/ty≥s.h
>

22 
	~<asm/Âu/≠i.h
>

24 #unde‡
tfw_sock_§v_öô


25 
	#tfw_sock_§v_öô
 
ã°_øtio_sock_§v_c⁄n_öô


	)

26 #unde‡
tfw_sock_§v_exô


27 
	#tfw_sock_§v_exô
 
ã°_øtio_sock_§v_exô


	)

28 #unde‡
tfw_§v_c⁄n_ªÀa£


29 
	#tfw_§v_c⁄n_ªÀa£
 
ã°_øtio_§v_c⁄n_ªÀa£


	)

30 #unde‡
tfw_sock_§v_mod


31 
	#tfw_sock_§v_mod
 
ã°_øtio_sock_§v_mod


	)

33 
	~"sock_§v.c
"

34 
	~"hâp_sched_øtio.c
"

36 
	~"hñ≥rs.h
"

37 
	~"sched_hñ≥r.h
"

38 
	~"£rvî.h
"

39 
	~"ã°.h
"

41 
TfwMsg
 *
sched_øtio_gë_¨g
(
size_t
 
c⁄n_ty≥
);

42 
sched_øtio_‰ì_¨g
(
TfwMsg
 *
msg
);

44 
Te°SchedHñ≥r
 
	gsched_hñ≥r_øtio
 = {

45 .
sched
 = "ratio",

46 .
	gÊags
 = 
TFW_SG_F_SCHED_RATIO_STATIC
,

47 .
	gc⁄n_ty≥s
 = 1,

48 .
	ggë_sched_¨g
 = &
sched_øtio_gë_¨g
,

49 .
	g‰ì_sched_¨g
 = &
sched_øtio_‰ì_¨g
,

52 
TfwMsg
 *

53 
	$sched_øtio_gë_¨g
(
size_t
 
c⁄n_ty≥
)

55 *
°r
 = "GET / HTTP/1.1\r\nHost:Üocalhost\r\n\r\n";

56 
TfwHâpReq
 *
ªq
 = 
NULL
;

57 
∑r£d
;

59 
	`BUG_ON
(
c⁄n_ty≥
 >
sched_hñ≥r_øtio
.
c⁄n_ty≥s
);

61 
ªq
 = 
	`ã°_ªq_Æloc
(
	`°æí
(
°r
));

62 
	`tfw_hâp_∑r£_ªq
(
ªq
, 
°r
, 
	`°æí
(°r), &
∑r£d
);

64  (
TfwMsg
 *)
ªq
;

65 
	}
}

68 
	$sched_øtio_‰ì_¨g
(
TfwMsg
 *
msg
)

70 
	`ã°_ªq_‰ì
((
TfwHâpReq
 *)
msg
);

71 
	}
}

73 
	$TEST
(
tfw_sched_øtio
, 
sched_sg_⁄e_§v_max_c⁄n
)

75 
size_t
 
i
, 
j
;

76 
c⁄n_acc
 = 0, 
c⁄n_acc_check
 = 0;

78 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

79 
TfwSîvî
 *
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

80 
TfwSrvC⁄n
 *
§v_c⁄n
;

82 
i
 = 0; i < 
TFW_TEST_SRV_MAX_CONN_N
; ++i) {

83 
§v_c⁄n
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

84 
c⁄n_acc
 ^()
§v_c⁄n
;

86 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_øtio
.
sched
, sched_hñ≥r_øtio.
Êags
);

92 
i
 = 0; i < 
sched_hñ≥r_øtio
.
c⁄n_ty≥s
; ++i) {

93 
TfwMsg
 *
msg
 = 
sched_hñ≥r_øtio
.
	`gë_sched_¨g
(
i
);

94 
c⁄n_acc_check
 = 0;

96 
j
 = 0; j < 
§v
->
c⁄n_n
; ++j) {

97 
§v_c⁄n
 = 
sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, sg);

98 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

99 i‡(!
§v_c⁄n
) {

100 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

101 
îr
;

104 
c⁄n_acc_check
 ^()
§v_c⁄n
;

105 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

110 
	`kî√l_Âu_íd
();

111 
	`scheduÀ
();

112 
	`kî√l_Âu_begö
();

115 
	`EXPECT_EQ
(
c⁄n_acc
, 
c⁄n_acc_check
);

116 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

118 
îr
:

119 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

120 
	`ã°_sg_ªÀa£_Æl
();

121 
	}
}

123 
	$TEST
(
tfw_sched_øtio
, 
sched_sg_max_§v_max_c⁄n
)

125 
i
, 
j
;

126 
c⁄n_acc
 = 0, 
c⁄n_acc_check
 = 0;

128 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

129 
TfwSîvî
 *
§v
;

130 
TfwSrvC⁄n
 *
§v_c⁄n
;

132 
i
 = 0; i < 
TFW_TEST_SG_MAX_SRV_N
; ++i) {

133 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

135 
j
 = 0; j < 
TFW_TEST_SRV_MAX_CONN_N
; ++j) {

136 
§v_c⁄n
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

137 
c⁄n_acc
 ^()
§v_c⁄n
;

140 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_øtio
.
sched
, sched_hñ≥r_øtio.
Êags
);

146 
i
 = 0; i < 
sched_hñ≥r_øtio
.
c⁄n_ty≥s
; ++i) {

147 
TfwMsg
 *
msg
 = 
sched_hñ≥r_øtio
.
	`gë_sched_¨g
(
i
);

148 
c⁄n_acc_check
 = 0;

150 
j
 = 0; j < 
TFW_TEST_SG_MAX_CONN_N
; ++j) {

151 
§v_c⁄n
 = 
sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, sg);

152 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

153 i‡(!
§v_c⁄n
) {

154 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

155 
îr
;

158 
c⁄n_acc_check
 ^()
§v_c⁄n
;

159 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

162 
	`EXPECT_EQ
(
c⁄n_acc
, 
c⁄n_acc_check
);

163 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

165 
îr
:

166 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

167 
	`ã°_sg_ªÀa£_Æl
();

168 
	}
}

170 
	$TEST
(
tfw_sched_øtio
, 
sched_§v_⁄e_§v_max_c⁄n
)

172 
size_t
 
i
, 
j
;

173 
c⁄n_acc
 = 0, 
c⁄n_acc_check
 = 0;

175 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

176 
TfwSîvî
 *
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

177 
TfwSrvC⁄n
 *
§v_c⁄n
;

179 
i
 = 0; i < 
TFW_TEST_SRV_MAX_CONN_N
; ++i) {

180 
§v_c⁄n
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

181 
c⁄n_acc
 ^()
§v_c⁄n
;

183 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_øtio
.
sched
, sched_hñ≥r_øtio.
Êags
);

189 
i
 = 0; i < 
sched_hñ≥r_øtio
.
c⁄n_ty≥s
; ++i) {

190 
TfwMsg
 *
msg
 = 
sched_hñ≥r_øtio
.
	`gë_sched_¨g
(
i
);

191 
c⁄n_acc_check
 = 0;

193 
j
 = 0; j < 
§v
->
c⁄n_n
; ++j) {

194 
§v_c⁄n
 = 
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, 
§v
);

195 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

196 i‡(!
§v_c⁄n
) {

197 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

198 
îr
;

200 
	`EXPECT_EQ
((
TfwSîvî
 *)
§v_c⁄n
->
≥î
, 
§v
);

202 
c⁄n_acc_check
 ^()
§v_c⁄n
;

203 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

209 
	`kî√l_Âu_íd
();

210 
	`scheduÀ
();

211 
	`kî√l_Âu_begö
();

214 
	`EXPECT_EQ
(
c⁄n_acc
, 
c⁄n_acc_check
);

215 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

217 
îr
:

218 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

219 
	`ã°_sg_ªÀa£_Æl
();

220 
	}
}

222 
	$TEST
(
tfw_sched_øtio
, 
sched_§v_max_§v_max_c⁄n
)

224 
size_t
 
i
, 
j
;

225 
c⁄n_acc_check
 = 0;

227 
TfwSîvî
 *
§v
;

228 
c⁄n_acc
;

229 } 
§v_acc
[
TFW_TEST_SG_MAX_SRV_N
] = {{ 0 }};

230 
TfwSîvî
 *
§v
;

231 
TfwSrvC⁄n
 *
§v_c⁄n
;

233 
TfwSrvGroup
 *
sg
 = 
	`ã°_¸óã_sg
("test");

235 
i
 = 0; i < 
TFW_TEST_SG_MAX_SRV_N
; ++i) {

236 
§v
 = 
	`ã°_¸óã_§v
("127.0.0.1", 
sg
);

237 
§v_acc
[
i
].
§v
 = srv;

239 
j
 = 0; j < 
TFW_TEST_SRV_MAX_CONN_N
; ++j) {

240 
§v_c⁄n
 = 
	`ã°_¸óã_§v_c⁄n
(
§v
);

241 
§v_acc
[
i
].
c⁄n_acc
 ^()
§v_c⁄n
;

244 
	`ã°_°¨t_sg
(
sg
, 
sched_hñ≥r_øtio
.
sched
, sched_hñ≥r_øtio.
Êags
);

250 
i
 = 0; i < 
sched_hñ≥r_øtio
.
c⁄n_ty≥s
; ++i) {

251 
TfwMsg
 *
msg
 = 
sched_hñ≥r_øtio
.
	`gë_sched_¨g
(
i
);

253 
	`li°_f‹_óch_íåy
(
§v
, &
sg
->
§v_li°
, 
li°
) {

254 
size_t
 
k
 = 0;

255 
c⁄n_acc_check
 = 0;

257 
j
 = 0; j < 
§v
->
c⁄n_n
; ++j) {

258 
§v_c⁄n
 = 
sg
->
sched
->
	`sched_§v_c⁄n
(
msg
, 
§v
);

259 
	`EXPECT_NOT_NULL
(
§v_c⁄n
);

260 i‡(!
§v_c⁄n
) {

261 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

262 
îr
;

264 
	`EXPECT_EQ
((
TfwSîvî
 *)
§v_c⁄n
->
≥î
, 
§v
);

266 
c⁄n_acc_check
 ^()
§v_c⁄n
;

267 
	`tfw_§v_c⁄n_put
(
§v_c⁄n
);

273 
	`kî√l_Âu_íd
();

274 
	`scheduÀ
();

275 
	`kî√l_Âu_begö
();

278 
k
 = 0; k < 
§v
->
c⁄n_n
; ++k) {

279 i‡(
§v_acc
[
k
].
§v
 == srv)

280 
	`EXPECT_EQ
(
§v_acc
[
k
].
c⁄n_acc
,

281 
c⁄n_acc_check
);

284 
sched_hñ≥r_øtio
.
	`‰ì_sched_¨g
(
msg
);

286 
îr
:

287 
	`ã°_c⁄n_ªÀa£_Æl
(
sg
);

288 
	`ã°_sg_ªÀa£_Æl
();

289 
	}
}

291 
	$TEST
(
tfw_sched_øtio
, 
sched_§v_ofÊöe_§v
)

293 
	`ã°_sched_§v_ofÊöe_§v
(&
sched_hñ≥r_øtio
);

294 
	}
}

296 
	$TEST_SUITE
(
sched_øtio
)

298 
	`kî√l_Âu_íd
();

300 
	`tfw_£rvî_öô
();

301 
	`tfw_sched_øtio_öô
();

303 
	`kî√l_Âu_begö
();

308 
	`TEST_RUN
(
tfw_sched_øtio
, 
sched_sg_⁄e_§v_max_c⁄n
);

309 
	`TEST_RUN
(
tfw_sched_øtio
, 
sched_sg_max_§v_max_c⁄n
);

311 
	`TEST_RUN
(
tfw_sched_øtio
, 
sched_§v_⁄e_§v_max_c⁄n
);

312 
	`TEST_RUN
(
tfw_sched_øtio
, 
sched_§v_max_§v_max_c⁄n
);

313 
	`TEST_RUN
(
tfw_sched_øtio
, 
sched_§v_ofÊöe_§v
);

314 
	}
}

	@t/unit/test_tfw_str.c

21 
	~<löux/bug.h
>

22 
	~<löux/˘y≥.h
>

23 
	~<löux/kî√l.h
>

24 
	~<löux/°rög.h
>

26 
	~"hty≥.h
"

27 
	~"°r.h
"

28 
	~"ã°.h
"

29 
	~"tfw_°r_hñ≥r.h
"

31 
	$TEST
(
c°r
, 
tﬁowî
)

33 
	`EXPECT_TRUE
(
	`TFW_LC
('A'Ë=
	`tﬁowî
('A'));

34 
	`EXPECT_TRUE
(
	`TFW_LC
('Z'Ë=
	`tﬁowî
('Z'));

35 
	`EXPECT_TRUE
(
	`TFW_LC
('a'Ë=
	`tﬁowî
('a'));

36 
	`EXPECT_TRUE
(
	`TFW_LC
('z'Ë=
	`tﬁowî
('z'));

37 
	`EXPECT_TRUE
(
	`TFW_LC
('0'Ë=
	`tﬁowî
('0'));

38 
	`EXPECT_TRUE
(
	`TFW_LC
('9'Ë=
	`tﬁowî
('9'));

39 
	`EXPECT_TRUE
(
	`TFW_LC
('/'Ë=
	`tﬁowî
('/'));

40 
	`EXPECT_TRUE
(
	`TFW_LC
('@'Ë=
	`tﬁowî
('@'));

41 
	`EXPECT_TRUE
(
	`TFW_LC
('['Ë=
	`tﬁowî
('['));

42 
	`EXPECT_TRUE
(
	`TFW_LC
('`'Ë=
	`tﬁowî
('`'));

43 
	`EXPECT_TRUE
(
	`TFW_LC
('{'Ë=
	`tﬁowî
('{'));

44 
	`EXPECT_TRUE
(
	`TFW_LC
('\r'Ë=
	`tﬁowî
('\r'));

45 
	`EXPECT_TRUE
(
	`TFW_LC
(0Ë=
	`tﬁowî
(0));

46 
	`EXPECT_TRUE
(
	`TFW_LC
(127Ë=
	`tﬁowî
(127));

48 
	`EXPECT_TRUE
(
	`TFW_LC
(200Ë!
	`tﬁowî
(200));

49 
	`EXPECT_TRUE
(
	`TFW_LC
(255Ë=
	`tﬁowî
(255));

50 
	}
}

52 
	#ACCEPT_URI
 "ABCDEFGHIJKLMNOPQRSTUVWXYZ" \

54 "!#$%&'*+-._();:@=,/?[]~0123456789"

	)

56 
	#__ã°_m©ch
(
s
) \

58 
	`EXPECT_TRUE
(
	`tfw_m©ch_uri
(
s
, (sË- 1Ë=
	`°r•n
(s, 
ACCEPT_URI
)); \

59 } 0)

	)

61 
	$TEST
(
c°r
, 
simd_m©ch
)

63 
	`__ã°_m©ch
("");

64 
	`__ã°_m©ch
(" ");

65 
	`__ã°_m©ch
("^");

66 
	`__ã°_m©ch
("a");

67 
	`__ã°_m©ch
("ab");

68 
	`__ã°_m©ch
("{a");

69 
	`__ã°_m©ch
("abc");

70 
	`__ã°_m©ch
("a}b");

71 
	`__ã°_m©ch
("abcd");

72 
	`__ã°_m©ch
("abc}");

73 
	`__ã°_m©ch
("abcde");

74 
	`__ã°_m©ch
("\"abce");

75 
	`__ã°_m©ch
("heLLo_24!");

76 
	`__ã°_m©ch
("0123456789ab{c}def");

77 
	`__ã°_m©ch
("!#$%&'*+-._();^abcde");

78 
	`__ã°_m©ch
("0123456789abcdefghIjkl|\\Pmdsfdfew34////");

79 
	`__ã°_m©ch
("0123456789abcdefghIjkl|\xfcPmdsfdfew34////");

80 
	`__ã°_m©ch
("0123456789abcdefghIjkl@?Pmdsfdfew34//^//");

81 
	`__ã°_m©ch
("0123456789_0123456789_0123456789_0123456789_|abcdef");

82 
	`__ã°_m©ch
("0123456789_0123456789_^0123456789_0123456789_abcdef");

83 
	`__ã°_m©ch
("0123456789_0123456789_0123456789_0123456789_abcdef^");

84 
	`__ã°_m©ch
("mozilla!5.0_(windows_nt_6.1!_wow64)_applewebkit!535.11_"

86 
	`__ã°_m©ch
("mozilla!5.0_(windows_nt_6.1!_wow64)_applewebkit!535.^11_"

88 
	`__ã°_m©ch
("mozilla!5.0_(windows_nt_6.1!_wow64)_applewebkit!535.11_"

90 
	`__ã°_m©ch
("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

94 
	`__ã°_m©ch
("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

99 
	`__ã°_m©ch
("aaaaaaaaaaaa^aaaaaaaaaaaaaaaaaaa"

104 
	`__ã°_m©ch
("aaaaaaaaaaaa^aaaaaaaaaaaaaaaaaaa"

109 
	}
}

112 
	$__ã°_˘ext_vch¨
(c⁄° *
°r
, 
size_t
 
Àn
)

114 
n
;

116 
n
 = 0;Ç < 
Àn
; ++n) {

117 
c
 = 
°r
[
n
];

118 i‡(
c
 < '\t' || (c > '\t' && c < ' ') || c == 0x7f)

121 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
°r
, 
Àn
Ë=
n
);

122 
	}
}

124 
	$TEST
(
c°r
, 
simd_m©ch_˘ext_vch¨
)

126 
	#N
 300

	)

127 
	#P
 23

	)

129 
i
;

130 
buf
[
N
] = {[0 ... N - 1] = 0xff };

132 
	`BUILD_BUG_ON
(
N
 < 
P
 + 257 || P < 1);

135 
i
 = 0; i <= 0xff; ++i)

136 i‡(
i
 == 9 || (i >= 0x20 && i != 0x7f))

137 
buf
[
P
 + 
i
] = i;

138 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
, 
N
) == N);

140 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
 + 
P
 - 1, 4) == 4);

141 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
 + 
P
 - 1, 15) == 15);

142 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
 + 
P
 - 1, 29) == 29);

145 
buf
[
P
 + 0x7f] = 0x7f;

146 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
, 
N
Ë=
P
 + 0x7f);

147 
buf
[
P
 + 0x1f] = 0x1f;

148 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
, 
N
Ë=
P
 + 0x1f);

149 
buf
[
P
 + 0xa] = 0xa;

150 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
, 
N
Ë=
P
 + 0xa);

151 
buf
[
P
 + 8] = 8;

152 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
, 
N
Ë=
P
 + 8);

153 
buf
[
P
 + 0] = 0;

154 
	`EXPECT_TRUE
(
	`tfw_m©ch_˘ext_vch¨
(
buf
, 
N
Ë=
P
);

155 #unde‡
P


156 #unde‡
N


158 
	#__S
(
s
Ës, (sË- 1

	)

159 
	`__ã°_˘ext_vch¨
(
	`__S
(""));

160 
	`__ã°_˘ext_vch¨
(
	`__S
(" "));

161 
	`__ã°_˘ext_vch¨
(
	`__S
("\x08"));

162 
	`__ã°_˘ext_vch¨
(
	`__S
("a\x00z"));

163 
	`__ã°_˘ext_vch¨
(
	`__S
(" \tx\rz"));

164 
	`__ã°_˘ext_vch¨
(
	`__S
("\t !?@_`~>^Aa\x80\xff\x81\xfe\x00\xa\x1f\x1e"));

165 
	`__ã°_˘ext_vch¨
(
	`__S
("\t !?@_`~>^A}a\x80\xff\x81"

167 
	`__ã°_˘ext_vch¨
(
	`__S
("\t !?@_`~>^A}a\x80\xff\x81"

169 
	`__ã°_˘ext_vch¨
(
	`__S
("123456789_123456789_123456789_123456789_"

171 
	`__ã°_˘ext_vch¨
(
	`__S
("123456789_123456789_123456789_123456789_"

174 
	`__ã°_˘ext_vch¨
(
	`__S
("123456789_123456789_123456789_123456789_"

178 
	`__ã°_˘ext_vch¨
(
	`__S
("123456789_123456789_123456789_123456789_"

183 #unde‡
__S


184 
	}
}

186 
	$TEST
(
c°r
, 
simd_m©ch_cu°om
)

188 
i
;

189 
a
[256] = {};

191 
i
 = 0; i < 256; ++i) {

192 i‡(
i
 == 0x21

193 || (0x23 <
i
 && i <= 0x3B)

194 || 
i
 == 0x3D

195 || (0x3‡<
i
 && i <= 0x5a)

196 || (0x61 <
i
 && i <= 0x7A)

197 || 
i
 == 0x5b || i == 0x5d || i == 0x5f

198 || 
i
 == 0x7E || i == 0x98)

199 
a
[
i
] = 1;

207 
	`tfw_öô_cu°om_xff
(
a
);

209 
	#__ã°_cu°om
(
s
) \

211 
i
 = 0; i < (
s
) - 1; ++i) \

212 i‡(!
a
[()(
s
)[
i
]]) \

214 
	`EXPECT_TRUE
(
	`tfw_m©ch_xff
((
s
), (sË- 1Ë=
i
); \

215 } 0)

	)

217 
	`__ã°_cu°om
("");

218 
	`__ã°_cu°om
(" ");

219 
	`__ã°_cu°om
("^");

220 
	`__ã°_cu°om
("a");

221 
	`__ã°_cu°om
("ab");

222 
	`__ã°_cu°om
("{a");

223 
	`__ã°_cu°om
("abc");

224 
	`__ã°_cu°om
("a}b");

225 
	`__ã°_cu°om
("abcd");

226 
	`__ã°_cu°om
("abc}\x98");

227 
	`__ã°_cu°om
("abcde");

228 
	`__ã°_cu°om
("\"abce");

229 
	`__ã°_cu°om
("heLLo_24!");

230 
	`__ã°_cu°om
("heL\x98o_24!");

231 
	`__ã°_cu°om
("0123456789ab{c}def");

232 
	`__ã°_cu°om
("!#$%&'*+-._();^abcde");

233 
	`__ã°_cu°om
("0123456789abcdefghIjkl|\\Pmdsfdfew34////");

234 
	`__ã°_cu°om
("0123456789abcdefghIjkl|\xfcPmdsfdfew34////");

235 
	`__ã°_cu°om
("0123456789abcdefghIjkl@?Pmdsfdfew34//^//");

236 
	`__ã°_cu°om
("0123456789_0123456789_0123456789_0123456789_|abcdef");

237 
	`__ã°_cu°om
("0123456789_0123456789_^0123456789_0123456789_abcdef");

238 
	`__ã°_cu°om
("0123456789_0123456789_0123456789_0123456789_abcdef^");

239 
	`__ã°_cu°om
("mozilla!5.0_(windows_nt_6.1!_wow64)_applewebkit"

242 
	`__ã°_cu°om
("mozilla!5.0_(windows_nt_6.1!_wow64)_applewebkit!"

245 
	`__ã°_cu°om
("mozilla!5.0_(windows_nt_6.1!_wow64)_applewebkit!"

248 
	`__ã°_cu°om
("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

252 
	`__ã°_cu°om
("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

257 
	`__ã°_cu°om
("aaaaaaaaaaaa^aaaaaaaaaaaaaaaaaaa"

262 
	`__ã°_cu°om
("aaaaaaaaaaaa^aaaaaaaaaaaaaaaaaaa"

267 
	`__ã°_cu°om
("aaaaaaaaaaaa^aaaaaaaaaaaaaaaaaaa"

273 
	`tfw_öô_cu°om_xff
(
NULL
);

274 #unde‡
__ã°_cu°om


275 
	}
}

277 
ölöe
 *

278 
	$c_°πﬁowî
(*
de°
, c⁄° *
§c
, 
size_t
 
Àn
)

280 
i
;

282 
i
 = 0; i < 
Àn
; ++i)

283 
de°
[
i
] = 
	`tﬁowî
(
§c
[i]);

285  
de°
;

286 
	}
}

288 
	#__ã°_tﬁowî
(
s
) \

290 
size_t
 
n
 = (
s
) - 1; \

291 *
d°1
, *
d°2
; \

292 
d°1
 = 
	`kmÆloc
(
n
 * 2, 
GFP_ATOMIC
); \

293 
	`BUG_ON
(!
d°1
); \

294 
d°2
 = 
d°1
 + 
n
; \

295 
	`tfw_c°πﬁowî
(
d°1
, 
s
, 
n
); \

296 
	`c_°πﬁowî
(
d°2
, 
s
, 
n
); \

297 
	`EXPECT_TRUE
(!
	`°∫cmp
(
d°1
, 
d°2
, 
n
)); \

298 } 0)

	)

300 
	$TEST
(
c°r
, 
simd_°πﬁowî
)

302 
	`__ã°_tﬁowî
("");

303 
	`__ã°_tﬁowî
(" ");

304 
	`__ã°_tﬁowî
("a");

305 
	`__ã°_tﬁowî
("A");

306 
	`__ã°_tﬁowî
("ab");

307 
	`__ã°_tﬁowî
("AB");

308 
	`__ã°_tﬁowî
("/!");

309 
	`__ã°_tﬁowî
("{a");

310 
	`__ã°_tﬁowî
("abc");

311 
	`__ã°_tﬁowî
("ABC");

312 
	`__ã°_tﬁowî
("a}b");

313 
	`__ã°_tﬁowî
("abcd");

314 
	`__ã°_tﬁowî
("ABCD");

315 
	`__ã°_tﬁowî
("ABCd");

316 
	`__ã°_tﬁowî
("abc}");

317 
	`__ã°_tﬁowî
("abcde");

318 
	`__ã°_tﬁowî
("ABCDE");

319 
	`__ã°_tﬁowî
("AbCdE");

320 
	`__ã°_tﬁowî
("\"abce");

321 
	`__ã°_tﬁowî
("AbCdEm");

322 
	`__ã°_tﬁowî
("AbCdE\xfemN");

323 
	`__ã°_tﬁowî
("heLLo_24!");

324 
	`__ã°_tﬁowî
("!#$%&'*+-._();^abcDe");

325 
	`__ã°_tﬁowî
("0123456789abcDefghIjkl|@?\\PmdSfdfew34//^//");

326 
	`__ã°_tﬁowî
("0123456789_0123456789_0123456789_0123456789_abcdef^");

327 
	`__ã°_tﬁowî
("MOZILLa!5.0_(wIndOws_nt_6.1!_WOW64)_APPLEwebkit!535.11_"

329 
	`__ã°_tﬁowî
("aaAAAAAAAAAAAAaaaaaAAAAAAAAaaaaa"

331 
	`__ã°_tﬁowî
("aaAAAAAAAAAAAAaaaaaAAAAAAAAaaaaa"

333 
	`__ã°_tﬁowî
("aaAAAAAAAAAAAAaaaaaAAAAAAAAaaaaa"

336 
	`__ã°_tﬁowî
("aaAAAAAAAAAAAAaaaaaAAAAAAAAaaaaa"

339 
	`__ã°_tﬁowî
("aaAAAAAAAAAAAAaaaaaAAAAAAAAaaaaa"

344 
	}
}

346 
	#__ã°_°rcmp
(
s1
, 
s2
) \

348 
size_t
 
n
 = 
	`mö
((
s1
), (
s2
)) - 1; \

349 
	`EXPECT_TRUE
(!
	`tfw_c°ricmp
(
s1
, 
s2
, 
n
Ë=!
	`°∫ˇ£cmp
(s1, s2,Ç)); \

350 
	`EXPECT_TRUE
(!
	`tfw_c°ricmp_2lc
(
s1
, 
s2
, 
n
Ë=!
	`°∫ˇ£cmp
(s1, s2,Ç)); \

351 } 0)

	)

353 
	$TEST
(
c°r
, 
simd_°ricmp
)

356 
	`__ã°_°rcmp
("", "");

357 
	`__ã°_°rcmp
("", "a");

358 
	`__ã°_°rcmp
("/!", "");

359 
	`__ã°_°rcmp
("/!", "abc");

360 
	`__ã°_°rcmp
("ABC", "abc");

361 
	`__ã°_°rcmp
("ABC ", "abc@");

362 
	`__ã°_°rcmp
("ABC@", "abc`");

363 
	`__ã°_°rcmp
("ABCR", "abc2");

364 
	`__ã°_°rcmp
("ABC[", "abc{");

365 
	`__ã°_°rcmp
("ABC{", "abc[");

366 
	`__ã°_°rcmp
("AbCdE", "abcde");

367 
	`__ã°_°rcmp
("AbCdE\xf0m", "abcde");

368 
	`__ã°_°rcmp
("AbCdE", "axcde");

369 
	`__ã°_°rcmp
("/img/arrow-up.png", "/img/arrow-up.png");

370 
	`__ã°_°rcmp
("0123456789abcdefghijklmno", "0123456789abcdefghijklmno");

371 
	`__ã°_°rcmp
("0123456789abcdefghijkLmno", "0123456789abcdefghijkLmn0");

372 
	`__ã°_°rcmp
("0123456789_0123456789_0123456789_zxfghert", "012345678");

373 
	`__ã°_°rcmp
("0123456789_0123456789_0123456789_zxfghert", "0_zxfghrt");

374 
	`__ã°_°rcmp
("0123456789_0123456789_0123456789_zX",

376 
	`__ã°_°rcmp
("0123456789_0123456789_0123456789_z;",

378 
	`__ã°_°rcmp
("0123456789_0123456789_0123456789_zXfGhERT",

380 
	`__ã°_°rcmp
("0123456789_0123456789_0123456789_zXfGhERT",

382 
	`__ã°_°rcmp
("MOZILLA!5.0_(windows_nt_6.1!_wow64)_applewebkit!535.11_"

386 
	`__ã°_°rcmp
("mozilla!5.0_(windows_nt_6.1!_wow64)_applewebkit!535.11_"

391 
	`__ã°_°rcmp
("mozilla@5.0_(windows_nt_6.1!_wow64)_applewebkit!535.11_"

395 
	`__ã°_°rcmp
("aaaaaaaaaaaa^aaaaaaaaaaaaaaaaaaa"

405 
	`__ã°_°rcmp
("aaaaaaaaAAAAAAAAAAAAAAAAAAAAAAAA"

416 
	}
}

418 
	$TEST
(
c°r
, 
u…ﬂ
)

420 
buf
[
TFW_ULTOA_BUF_SIZ
 + 1] = {0};

422 
	`EXPECT_TRUE
(
	`tfw_u…ﬂ
(0, 
buf
, 
TFW_ULTOA_BUF_SIZ
) == 1);

423 
	`EXPECT_ZERO
(
	`tfw_c°ricmp
(
buf
, "0", 2));

425 
	`mem£t
(
buf
, 0, 
TFW_ULTOA_BUF_SIZ
 + 1);

426 
	`EXPECT_TRUE
(
	`tfw_u…ﬂ
(5, 
buf
, 
TFW_ULTOA_BUF_SIZ
) == 1);

427 
	`EXPECT_ZERO
(
	`tfw_c°ricmp
(
buf
, "5", 2));

429 
	`mem£t
(
buf
, 0, 
TFW_ULTOA_BUF_SIZ
 + 1);

430 
	`EXPECT_TRUE
(
	`tfw_u…ﬂ
(58743, 
buf
, 
TFW_ULTOA_BUF_SIZ
) == 5);

431 
	`EXPECT_ZERO
(
	`tfw_c°ricmp
(
buf
, "58743", 6));

433 
	`mem£t
(
buf
, 0, 
TFW_ULTOA_BUF_SIZ
 + 1);

434 
	`EXPECT_TRUE
(
	`tfw_u…ﬂ
(0xØbbccff, 
buf
, 
TFW_ULTOA_BUF_SIZ
) == 10);

435 
	`EXPECT_ZERO
(
	`tfw_c°ricmp
(
buf
, "2864434431", 11));

437 
	`mem£t
(
buf
, 0, 
TFW_ULTOA_BUF_SIZ
 + 1);

438 
	`EXPECT_TRUE
(
	`tfw_u…ﬂ
(18446744073709551615UL,

439 
buf
, 
TFW_ULTOA_BUF_SIZ
) == 20);

440 
	`EXPECT_ZERO
(
	`tfw_c°ricmp
(
buf
, "18446744073709551615", 21));

442 
	`EXPECT_ZERO
(
	`tfw_u…ﬂ
(589, 
buf
, 2));

443 
	}
}

445 
	$TEST
(
tfw_°r˝y
, 
zîo_§c
)

447 
TfwSå
 
s1
 = {

448 .
Àn
 = 0,

449 .
±r
 = 
NULL


451 
TfwSå
 
s2
 = {

452 .
Àn
 = 3,

453 .
±r
 = "abc"

457 
	`EXPECT_ZERO
(
	`tfw_°r˝y
(&
s2
, &
s1
));

458 
	`EXPECT_ZERO
(
s2
.
Àn
);

459 
	}
}

461 
	$TEST
(
tfw_°r˝y
, 
zîo_d°
)

463 
TfwSå
 
s1
 = {

464 .
Àn
 = 0,

465 .
±r
 = 
NULL


467 
TfwSå
 
s2
 = {

468 .
Àn
 = 3,

469 .
±r
 = "abc"

473 
	`EXPECT_ZERO
(!
	`tfw_°r˝y
(&
s1
, &
s2
));

474 
	}
}

476 
	$TEST
(
tfw_°r˝y
, 
bŸh_∂aö
)

478 
buf1
[4] = { 0 }, 
buf2
[4] = "abc";

479 
TfwSå
 
s1
 = {

480 .
Àn
 = 4,

481 .
±r
 = 
buf1


483 
TfwSå
 
s2
 = {

484 .
Àn
 = 4,

485 .
±r
 = 
buf2


488 
	`EXPECT_ZERO
(
	`tfw_°r˝y
(&
s1
, &
s2
));

489 
	`EXPECT_STR_EQ
(
s1
.
±r
, "abc");

490 
	}
}

492 
	$TEST
(
tfw_°r˝y
, 
§c_compound
)

494 
buf1
[32] = { 0 };

495 
TfwSå
 
s1
 = {

496 .
Àn
 = 32,

497 .
±r
 = 
buf1


499 
	`TFW_STR
(
s2
, "abcdefghijklmnop");

501 
	`EXPECT_ZERO
(
	`tfw_°r˝y
(&
s1
, 
s2
));

502 
	`EXPECT_STR_EQ
(
s1
.
±r
, "abcdefghijklmnop");

503 
	}
}

505 
	$TEST
(
tfw_°r˝y
, 
d°_compound
)

507 
buf
[32] = { [0 ... 30] = 'a', 0 };

508 
TfwSå
 
s2
 = {

509 .
Àn
 = ("abcdefghijklmnop") - 1,

510 .
±r
 = "abcdefghijklmnop"

512 
	`TFW_STR
(
s1
, 
buf
);

514 
	`EXPECT_ZERO
(
	`tfw_°r˝y
(
s1
, &
s2
));

515 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s1
, "abcdefghijklmnop",

517 
	}
}

519 
	$TEST
(
tfw_°r˝y
, 
bŸh_compound
)

521 
buf
[32] = { [0 ... 30] = 'a', 0 };

522 
	`TFW_STR
(
s1
, 
buf
);

523 
TfwSå
 
s2
 = {

524 .
±r
 = (
TfwSå
 []){

525 { .
±r
 = "ab", .
Àn
 = 2 },

526 { .
±r
 = "cde", .
Àn
 = 3 },

527 { .
±r
 = "f", .
Àn
 = 1 },

528 { .
±r
 = "g", .
Àn
 = 1 },

529 { .
±r
 = "h", .
Àn
 = 1 },

530 { .
±r
 = "ijklmno", .
Àn
 = 7 },

531 { .
±r
 = "p", .
Àn
 = 1 }

533 .
Àn
 = ("abcdefghijklmnop") - 1,

534 .
Êags
 = 7 << 
TFW_STR_CN_SHIFT


537 
	`EXPECT_ZERO
(
	`tfw_°r˝y
(
s1
, &
s2
));

538 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s1
, "abcdefghijklmnop",

540 
	}
}

542 
	$TEST
(
tfw_°r˝y_desc
, 
bŸh_∂aö
)

544 
TfwSå
 
s1
 = {};

545 
TfwSå
 
s2
 = {

546 .
Àn
 = ("abcdefghijklmnop") - 1,

547 .
±r
 = "abcdefghijklmnop"

550 
	`EXPECT_OK
(
	`tfw_°r˝y_desc
(&
s1
, &
s2
));

551 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
s1
, "abcdefghijklmnop",

553 
	}
}

555 
	$TEST
(
tfw_°r˝y_desc
, 
bŸh_compound
)

557 
buf
[15] = "pqrstuvwxyz123";

558 
	`TFW_STR
(
s1
, 
buf
);

559 
	`TFW_STR
(
s2
, "abcdefghijklno");

561 
	`EXPECT_OK
(
	`tfw_°r˝y_desc
(
s1
, 
s2
));

562 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s1
, "abcdefghijklno",

564 
	}
}

566 
	$TEST
(
tfw_°r˝y_desc
, 
∂aö_compound
)

568 
TfwSå
 
s1
 = {};

569 
	`TFW_STR
(
s2
, "abcdefg");

571 
	`EXPECT_ERROR
(
	`tfw_°r˝y_desc
(&
s1
, 
s2
));

572 
	}
}

574 
	$TEST
(
tfw_°rˇt
, 
∂aö
)

576 
chunks
;

577 
	`TFW_STR
(
s1
, "abcdefghijklmnop");

578 
TfwSå
 
s2
 = {

579 .
Àn
 = ("0123456789") - 1,

580 .
±r
 = "0123456789"

583 
chunks
 = 
	`TFW_STR_CHUNKN
(
s1
);

585 
	`EXPECT_ZERO
(
	`tfw_°rˇt
(
°r_poﬁ
, 
s1
, &
s2
));

586 
	`EXPECT_TRUE
(
	`TFW_STR_CHUNKN
(
s1
Ë=
chunks
 + 1);

587 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s1
, "abcdefghijklmnop0123456789",

590 
	}
}

592 
	$TEST
(
tfw_°rˇt
, 
compound
)

594 
chunks1
, 
chunks2
;

595 
	`TFW_STR
(
s1
, "abcdefghijklmnop");

596 
	`TFW_STR
(
s2
, "0123456789");

598 
chunks1
 = 
	`TFW_STR_CHUNKN
(
s1
);

599 
chunks2
 = 
	`TFW_STR_CHUNKN
(
s2
);

601 
	`EXPECT_ZERO
(
	`tfw_°rˇt
(
°r_poﬁ
, 
s1
, 
s2
));

602 
	`EXPECT_TRUE
(
	`TFW_STR_CHUNKN
(
s1
Ë=
chunks1
 + 
chunks2
);

603 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s1
, "abcdefghijklmnop0123456789",

606 
	}
}

608 
	$TEST
(
tfw_°rdup
, 
∂aö
)

610 c⁄° *
c°r
 = "abcdefghijklmnop";

611 
TfwSå
 *
c›y
;

612 
TfwSå
 *
s
 = 
	`make_∂aö_°r
(
c°r
);

614 
c›y
 = 
	`tfw_°rdup
(
°r_poﬁ
, 
s
);

616 
	`EXPECT_EQ
(
	`TFW_STR_CHUNKN
(
c›y
), 0);

617 
	`EXPECT_EQ
(
	`tfw_°rcmp
(
s
, 
c›y
), 0);

618 
	}
}

620 
	$TEST
(
tfw_°rdup
, 
compound
)

622 
	`TFW_STR2
(
s
, "abcdef", "ghijklmnop");

623 
TfwSå
 *
c›y
, *
íd
, *
c
, *
c_c›y
;

625 
c›y
 = 
	`tfw_°rdup
(
°r_poﬁ
, 
s
);

627 
	`EXPECT_EQ
(
	`TFW_STR_CHUNKN
(
s
), TFW_STR_CHUNKN(
c›y
));

628 i‡(
	`TFW_STR_CHUNKN
(
s
Ë!TFW_STR_CHUNKN(
c›y
))

632 
c
 = 
s
->
±r
;

633 
c_c›y
 = 
c›y
->
±r
;

634 
íd
 = (
TfwSå
 *)
s
->
±r
 + 
	`TFW_STR_CHUNKN
(s);

635  ; 
c
 < 
íd
; ++c, ++
c_c›y
)

636 
	`EXPECT_EQ
(
	`tfw_°rcmp
(
c
, 
c_c›y
), 0);

637 
	}
}

640 
	$TEST
(
tfw_°ricmp
, 
ªtu∫s_åue_⁄ly_f‹_equÆ_tfw_°rs
)

642 
	`TFW_STR
(
s1
, "abcdefghijklmnopqrst");

643 
	`TFW_STR
(
s2
, "ABcDefGHIJKLmnopqrst");

644 
	`TFW_STR
(
s3
, "abcdefghi");

645 
	`TFW_STR
(
s4
, "abcdefghijklmnopqrst_the_tail");

647 
	`EXPECT_TRUE
(
	`tfw_°ricmp
(
s1
, 
s2
) == 0);

648 
	`EXPECT_FALSE
(
	`tfw_°ricmp
(
s1
, 
s3
) == 0);

649 
	`EXPECT_TRUE
(
	`tfw_°ricmp•n
(
s1
, 
s3
, 'f') == 0);

650 
	`EXPECT_FALSE
(
	`tfw_°ricmp
(
s1
, 
s4
) == 0);

651 
	`EXPECT_TRUE
(
	`tfw_°ricmp•n
(
s1
, 
s4
, 't') == 0);

652 
	}
}

654 
	$TEST
(
tfw_°ricmp
, 
h™dÀs_∂aö_™d_compound_°rs
)

656 
TfwSå
 
s1
 = {

657 .
Àn
 = ("abcdefghijklmnopqrst") - 1,

658 .
±r
 = "abcdefghijklmnopqrst"

660 
	`TFW_STR
(
s2
, "abcdefghijklmnopqrst");

661 
	`TFW_STR
(
s3
, "abcdefghi");

662 
	`TFW_STR
(
s4
, "abcdefghijklmnopqrst_the_tail");

664 
	`EXPECT_TRUE
(
	`tfw_°ricmp
(&
s1
, 
s2
) == 0);

665 
	`EXPECT_FALSE
(
	`tfw_°ricmp
(&
s1
, 
s3
) == 0);

666 
	`EXPECT_TRUE
(
	`tfw_°ricmp•n
(&
s1
, 
s3
, 'f') == 0);

667 
	`EXPECT_FALSE
(
	`tfw_°ricmp•n
(&
s1
, 
s3
, 'z') == 0);

668 
	`EXPECT_FALSE
(
	`tfw_°ricmp
(&
s1
, 
s4
) == 0);

669 
	`EXPECT_TRUE
(
	`tfw_°ricmp•n
(&
s1
, 
s4
, 't') == 0);

670 
	}
}

672 
	$TEST
(
tfw_°ricmp
, 
h™dÀs_em±y_°rs
)

674 
TfwSå
 
s1
 = {

675 .
Àn
 = 0,

676 .
±r
 = "garbage"

678 
TfwSå
 
s2
 = {

679 .
Àn
 = 0,

680 .
±r
 = "trash"

682 
	`TFW_STR
(
s3
, "abcdefghijklmnopqrst");

684 
	`EXPECT_TRUE
(
	`tfw_°ricmp
(&
s1
, &
s2
) == 0);

685 
	`EXPECT_TRUE
(
	`tfw_°ricmp•n
(&
s1
, &
s2
, 'a') == 0);

686 
	`EXPECT_FALSE
(
	`tfw_°ricmp
(&
s1
, 
s3
) == 0);

687 
	`EXPECT_FALSE
(
	`tfw_°ricmp•n
(&
s1
, 
s3
, 'a') == 0);

688 
	}
}

690 
	$TEST
(
tfw_°ricmp
, 
h™dÀs_dif„ª¡_size_°rs
)

692 
TfwSå
 
s1
 = {

693 .
±r
 = (
TfwSå
 []){

694 { .
±r
 = "ab", .
Àn
 = ("ab") - 1 },

695 { .
±r
 = "cdefghijklmnopqrst",

696 .
Àn
 = ("cdefghijklmnopqrst") - 1 }

698 .
Àn
 = ("abcdefghijklmnopqrst") - 1,

699 .
Êags
 = 2 << 
TFW_STR_CN_SHIFT


701 
TfwSå
 
s2
 = {

702 .
±r
 = (
TfwSå
 []){

703 { .
±r
 = "abcdefg", .
Àn
 = ("abcdefg") - 1 },

704 { .
±r
 = "hi", .
Àn
 = ("hi") - 1 },

705 { .
±r
 = "jklmnopqrst",

706 .
Àn
 = ("jklmnopqrst") - 1 }

708 .
Àn
 = ("abcdefghijklmnopqrst") - 1,

709 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


712 
	`EXPECT_ZERO
(
	`tfw_°ricmp
(&
s1
, &
s2
));

713 
	`EXPECT_ZERO
(
	`tfw_°ricmp•n
(&
s1
, &
s2
, 'r'));

714 
	}
}

717 
	$TEST
(
tfw_°rcmp
, 
ªtu∫s_åue_⁄ly_f‹_equÆ_tfw_°rs
)

719 
	`TFW_STR
(
s1
, "abcdefghijklmnopqrst");

720 
	`TFW_STR
(
s2
, "ABcDefGHIJKLmnopqrst");

721 
	`TFW_STR
(
s3
, "abcdefghi");

722 
	`TFW_STR
(
s4
, "abcdefghijklmnopqrst_the_tail");

724 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(
s1
, 
s2
) == 0);

725 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(
s1
, 
s3
) == 0);

726 
	`EXPECT_TRUE
(
	`tfw_°rcmp•n
(
s1
, 
s3
, 'f') == 0);

727 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(
s1
, 
s4
) == 0);

728 
	`EXPECT_TRUE
(
	`tfw_°rcmp•n
(
s1
, 
s4
, 't') == 0);

729 
	}
}

731 
	$TEST
(
tfw_°rcmp
, 
h™dÀs_∂aö_™d_compound_°rs
)

733 
TfwSå
 
s1
 = {

734 .
Àn
 = ("abcdefghijklmnopqrst") - 1,

735 .
±r
 = "abcdefghijklmnopqrst"

737 
	`TFW_STR
(
s2
, "abcdefghijklmnopqrst");

738 
	`TFW_STR
(
s3
, "abcdefghi");

739 
	`TFW_STR
(
s4
, "abcdefghijklmnopqrst_the_tail");

740 
	`TFW_STR
(
s5
, "abCDEFGhijklmnopqrst");

742 
	`EXPECT_TRUE
(
	`tfw_°rcmp
(&
s1
, 
s2
) == 0);

743 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(&
s1
, 
s3
) == 0);

744 
	`EXPECT_TRUE
(
	`tfw_°rcmp•n
(&
s1
, 
s3
, 'f') == 0);

745 
	`EXPECT_FALSE
(
	`tfw_°rcmp•n
(&
s1
, 
s3
, 'z') == 0);

746 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(&
s1
, 
s4
) == 0);

747 
	`EXPECT_TRUE
(
	`tfw_°rcmp•n
(&
s1
, 
s4
, 't') == 0);

748 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(&
s1
, 
s5
) == 0);

749 
	}
}

751 
	$TEST
(
tfw_°rcmp
, 
h™dÀs_em±y_°rs
)

753 
TfwSå
 
s1
 = {

754 .
Àn
 = 0,

755 .
±r
 = "garbage"

757 
TfwSå
 
s2
 = {

758 .
Àn
 = 0,

759 .
±r
 = "trash"

761 
	`TFW_STR
(
s3
, "abcdefghijklmnopqrst");

763 
	`EXPECT_TRUE
(
	`tfw_°rcmp
(&
s1
, &
s2
) == 0);

764 
	`EXPECT_TRUE
(
	`tfw_°rcmp•n
(&
s1
, &
s2
, 'a') == 0);

765 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(&
s1
, 
s3
) == 0);

766 
	`EXPECT_FALSE
(
	`tfw_°rcmp•n
(&
s1
, 
s3
, 'a') == 0);

767 
	}
}

769 
	$TEST
(
tfw_°rcmp
, 
h™dÀs_dif„ª¡_size_°rs
)

771 
TfwSå
 
s1
 = {

772 .
±r
 = (
TfwSå
 []){

773 { .
±r
 = "ab", .
Àn
 = ("ab") - 1 },

774 { .
±r
 = "cdefghijklmnopqrst",

775 .
Àn
 = ("cdefghijklmnopqrst") - 1 }

777 .
Àn
 = ("abcdefghijklmnopqrst") - 1,

778 .
Êags
 = 2 << 
TFW_STR_CN_SHIFT


780 
TfwSå
 
s2
 = {

781 .
±r
 = (
TfwSå
 []){

782 { .
±r
 = "abcdefg", .
Àn
 = ("abcdefg") - 1 },

783 { .
±r
 = "hi", .
Àn
 = ("hi") - 1 },

784 { .
±r
 = "jklmnopqrst",

785 .
Àn
 = ("jklmnopqrst") - 1 }

787 .
Àn
 = ("abcdefghijklmnopqrst") - 1,

788 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


790 
TfwSå
 
s3
 = {

791 .
±r
 = (
TfwSå
 []){

792 { .
±r
 = "abcDefg", .
Àn
 = ("abcDefg") - 1 },

793 { .
±r
 = "hi", .
Àn
 = ("hi") - 1 },

794 { .
±r
 = "jklmNopQRst",

795 .
Àn
 = ("jklmNopQRst") - 1 }

797 .
Àn
 = ("abcdefghijklmnopqrst") - 1,

798 .
Êags
 = 3 << 
TFW_STR_CN_SHIFT


801 
	`EXPECT_ZERO
(
	`tfw_°rcmp
(&
s1
, &
s2
));

802 
	`EXPECT_ZERO
(
	`tfw_°rcmp•n
(&
s1
, &
s2
, 'r'));

803 
	`EXPECT_FALSE
(
	`tfw_°rcmp
(&
s1
, &
s3
) == 0);

804 
	}
}

806 
	$TEST
(
tfw_°r_eq_c°r
, 
ªtu∫s_åue_⁄ly_f‹_equÆ_°rs
)

808 c⁄° *
c°r
 = "foo123 barbaz";

809 
Àn
 = 
	`°æí
(
c°r
);

811 
	`TFW_STR
(
m©ch
, "foo123 barbaz");

812 
	`TFW_STR
(
diff1
, "aoo123 barbaz");

813 
	`TFW_STR
(
diff2
, "foo123 barbaa");

814 
	`TFW_STR
(
diff3
, "Foo123 barbaz");

815 
	`TFW_STR
(
¸›
, "foo123 barba");

816 
	`TFW_STR
(
exåa
, "foo123 barbazz");

818 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
m©ch
, 
c°r
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

819 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
diff1
, 
c°r
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

820 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
diff2
, 
c°r
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

821 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
diff3
, 
c°r
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

822 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
¸›
, 
c°r
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

823 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
exåa
, 
c°r
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

824 
	}
}

826 
	$TEST
(
tfw_°r_eq_c°r
, 
h™dÀs_∂aö_°r
)

828 c⁄° *
c°r1
 = "foo";

829 c⁄° *
c°r2
 = "bar baz";

830 
size_t
 
Àn1
 = 
	`°æí
(
c°r1
);

831 
size_t
 
Àn2
 = 
	`°æí
(
c°r2
);

832 
TfwSå
 *
s1
 = 
	`make_∂aö_°r
(
c°r1
);

833 
TfwSå
 *
s2
 = 
	`make_∂aö_°r
(
c°r2
);

835 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s1
, 
c°r1
, 
Àn1
, 
TFW_STR_EQ_DEFAULT
));

836 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s2
, 
c°r2
, 
Àn2
, 
TFW_STR_EQ_DEFAULT
));

837 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
s1
, 
c°r2
, 
Àn2
, 
TFW_STR_EQ_DEFAULT
));

838 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
s2
, 
c°r1
, 
Àn1
, 
TFW_STR_EQ_DEFAULT
));

839 
	}
}

841 
	$TEST
(
tfw_°r_eq_c°r
, 
h™dÀs_u¡îmö©ed_°rs
)

843 c⁄° *
c°r
 = "foobarbaz [SOME GARBAGE]";

844 
c°r_Àn
 = 9;

845 
TfwSå
 
s
 = {

846 .
Àn
 = 
c°r_Àn
,

847 .
±r
 = (*)"foobarbaz [ANOTHER GARBAGE]"

849 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
s
, 
c°r
, 
c°r_Àn
, 
TFW_STR_EQ_DEFAULT
));

850 
	}
}

852 
	$TEST
(
tfw_°r_eq_c°r
, 
h™dÀs_em±y_°rs
)

854 
TfwSå
 
s1
 = {

855 .
Àn
 = 0,

856 .
±r
 = (*)"garbage"

858 
TfwSå
 
s2
 = {

859 .
Àn
 = 0,

860 .
±r
 = 
NULL


862 
TfwSå
 
chunks
[] = { 
s1
, 
s2
 };

863 
TfwSå
 
s3
 = {

864 .
Àn
 = 0,

865 .
±r
 = &
chunks


867 
TfwSå
 
s_√
 = {

868 .
Àn
 = 3,

869 .
±r
 = (*)"foo"

871 c⁄° *
c°r
 = "";

872 c⁄° *
c°r_√
 = "bar";

873 
size_t
 
Àn
 = 
	`°æí
(
c°r_√
);

875 
	`TFW_STR_CHUNKN_INIT
(&
s3
);

877 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
s1
, 
c°r
, 0, 
TFW_STR_EQ_DEFAULT
));

878 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
s2
, 
c°r
, 0, 
TFW_STR_EQ_DEFAULT
));

879 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(&
s3
, 
c°r
, 0, 
TFW_STR_EQ_DEFAULT
));

880 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(&
s_√
, 
c°r
, 0, 
TFW_STR_EQ_DEFAULT
));

881 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(&
s1
, 
c°r_√
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

882 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(&
s2
, 
c°r_√
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

883 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(&
s3
, 
c°r_√
, 
Àn
, 
TFW_STR_EQ_DEFAULT
));

884 
	}
}

886 
	$TEST
(
tfw_°r_eq_c°r
, 
suµ‹ts_ˇ£i
)

888 
	`TFW_STR
(
s
, "FooBarBaz 123");

889 c⁄° *
c°r1
 = "FooBarBaz 123";

890 c⁄° *
c°r2
 = "fooBarBaz 123";

891 c⁄° *
c°r3
 = "FooBarBaZ 123";

892 
size_t
 
Àn1
 = 
	`°æí
(
c°r1
);

893 
size_t
 
Àn2
 = 
	`°æí
(
c°r2
);

894 
size_t
 
Àn3
 = 
	`°æí
(
c°r3
);

896 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
c°r1
, 
Àn1
, 
TFW_STR_EQ_CASEI
));

897 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
c°r2
, 
Àn2
, 
TFW_STR_EQ_CASEI
));

898 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
c°r3
, 
Àn3
, 
TFW_STR_EQ_CASEI
));

899 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
s
, 
c°r2
, 
Àn2
, 
TFW_STR_EQ_DEFAULT
));

900 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
s
, 
c°r3
, 
Àn3
, 
TFW_STR_EQ_DEFAULT
));

901 
	}
}

903 
	$TEST
(
tfw_°r_eq_c°r
, 
suµ‹ts_¥efix
)

905 
	`TFW_STR
(
s
, "/foo/bar/baz.test");

906 c⁄° *
p1
 = "/foo/bar/baz.test";

907 c⁄° *
p2
 = "/foo/bar/baz.tes";

908 c⁄° *
p3
 = "/foo/bar/baz";

909 c⁄° *
p4
 = "/foo/bar/";

910 c⁄° *
p5
 = "/foo";

911 c⁄° *
p6
 = "/";

912 c⁄° *
p7
 = "";

913 c⁄° *
exåa
 = "/foo/bar/baz.test1";

914 c⁄° *
p1_ci
 = "/foo/bar/baz.tesT";

915 c⁄° *
p5_ci
 = "/Foo";

917 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p1
, 
	`°æí
’1), 
TFW_STR_EQ_PREFIX
));

918 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p2
, 
	`°æí
’2), 
TFW_STR_EQ_PREFIX
));

919 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p3
, 
	`°æí
’3), 
TFW_STR_EQ_PREFIX
));

920 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p4
, 
	`°æí
’4), 
TFW_STR_EQ_PREFIX
));

921 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p5
, 
	`°æí
’5), 
TFW_STR_EQ_PREFIX
));

922 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p6
, 
	`°æí
’6), 
TFW_STR_EQ_PREFIX
));

923 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p7
, 
	`°æí
’7), 
TFW_STR_EQ_PREFIX
));

925 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
s
, 
exåa
, 
	`°æí
(extra),

926 
TFW_STR_EQ_PREFIX
));

927 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
s
, 
p1_ci
, 
	`°æí
(p1_ci),

928 
TFW_STR_EQ_PREFIX
));

929 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r
(
s
, 
p5_ci
, 
	`°æí
(p5_ci),

930 
TFW_STR_EQ_PREFIX
));

932 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p1_ci
, 
	`°æí
(p1_ci),

933 
TFW_STR_EQ_PREFIX_CASEI
));

934 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r
(
s
, 
p5_ci
, 
	`°æí
(p5_ci),

935 
TFW_STR_EQ_PREFIX_CASEI
));

936 
	}
}

938 
	$TEST
(
tfw_°r_eq_c°r_off
, 
suµ‹ts_suffix
)

940 
	`TFW_STR
(
s
, "/foo/bar/baz.test");

941 c⁄° *
p1
 = "/foo/bar/baz.test";

942 c⁄° *
p2
 = "foo/bar/baz.test";

943 c⁄° *
p3
 = "bar/baz.test";

944 c⁄° *
p4
 = "/baz.test";

945 c⁄° *
p5
 = ".test";

946 c⁄° *
f1
 = "/bar/foo/baz.test";

947 c⁄° *
f2
 = "/foo/bar/";

948 c⁄° *
exåa
 = "/bar/foo/baz.test100";

949 c⁄° *
i1
 = "/foo/bar/baz.tesT";

950 c⁄° *
i2
 = ".TeSt";

952 
	#X_EXPECT_TRUE
(
s
, 
p
, 
Êags
) \

954 
∂í
 = 
	`°æí
(
p
); \

955 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r_off
(
s
, s->
Àn
 - 
∂í
, 
p
,ÖÀn, 
Êags
)); \

956 } 0)

	)

957 
	#X_EXPECT_FALSE
(
s
, 
p
, 
Êags
) \

959 
∂í
 = 
	`°æí
(
p
); \

960 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_off
(
s
, s->
Àn
 - 
∂í
, 
p
,ÖÀn, 
Êags
)); \

961 } 0)

	)

963 
	`X_EXPECT_TRUE
(
s
, 
p1
, 
TFW_STR_EQ_DEFAULT
);

964 
	`X_EXPECT_TRUE
(
s
, 
p2
, 
TFW_STR_EQ_DEFAULT
);

965 
	`X_EXPECT_TRUE
(
s
, 
p3
, 
TFW_STR_EQ_DEFAULT
);

966 
	`X_EXPECT_TRUE
(
s
, 
p4
, 
TFW_STR_EQ_DEFAULT
);

967 
	`X_EXPECT_TRUE
(
s
, 
p5
, 
TFW_STR_EQ_DEFAULT
);

969 
	`X_EXPECT_FALSE
(
s
, 
f1
, 
TFW_STR_EQ_DEFAULT
);

970 
	`X_EXPECT_FALSE
(
s
, 
f2
, 
TFW_STR_EQ_DEFAULT
);

972 
	`X_EXPECT_FALSE
(
s
, 
exåa
, 
TFW_STR_EQ_DEFAULT
);

973 
	`X_EXPECT_FALSE
(
s
, 
i1
, 
TFW_STR_EQ_DEFAULT
);

974 
	`X_EXPECT_FALSE
(
s
, 
i2
, 
TFW_STR_EQ_DEFAULT
);

976 
	`X_EXPECT_TRUE
(
s
, 
i1
, 
TFW_STR_EQ_DEFAULT
 | 
TFW_STR_EQ_CASEI
);

977 
	`X_EXPECT_TRUE
(
s
, 
i2
, 
TFW_STR_EQ_DEFAULT
 | 
TFW_STR_EQ_CASEI
);

979 #unde‡
X_EXPECT_TRUE


980 #unde‡
X_EXPECT_FALSE


981 
	}
}

983 c⁄° *
	gfox°r
 = "The quick brown fox jumps overÅheÜazy dog";

985 
	$TEST
(
tfw_°r_eq_c°r_pos
, 
∂aö
)

987 
TfwSå
 *
fox
 = 
	`make_∂aö_°r
(
fox°r
), *
c
, *
íd
;

988 
i
, 
off£t
 = 0, 
foxÀn
 = 
fox
->
Àn
;

990 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
fox
, 
íd
) {

991 
i
 = 0; i < 
c
->
Àn
; i++) {

992 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r_pos
(
fox
,

993 
c
->
±r
 + 
i
,

994 
fox°r
 + 
off£t
,

995 
foxÀn
 - 
off£t
,

996 
TFW_STR_EQ_CASEI
));

997 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_pos
(
fox
,

998 
c
->
±r
 + 
i
,

1001 
TFW_STR_EQ_CASEI
));

1002 ++
off£t
;

1006 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_pos
(
fox
,

1008 
fox°r
,

1009 
foxÀn
,

1010 
TFW_STR_EQ_CASEI
));

1011 
	}
}

1013 
	$TEST
(
tfw_°r_eq_c°r_off
, 
∂aö
)

1015 
TfwSå
 *
fox
 = 
	`make_∂aö_°r
(
fox°r
);

1016 
off£t
 = 0, 
foxÀn
 = 
fox
->
Àn
;

1018 
off£t
 = 0; off£à< 
fox
->
Àn
; ++offset) {

1019 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r_off
(
fox
, 
off£t
,

1020 
fox°r
 + 
off£t
,

1021 
foxÀn
 - 
off£t
,

1022 
TFW_STR_EQ_CASEI
));

1023 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_off
(
fox
, 
off£t
,

1025 
TFW_STR_EQ_CASEI
));

1028 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r_off
(
fox
, 0,

1029 
fox°r
, 
foxÀn
, 
TFW_STR_EQ_CASEI
));

1031 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_off
(
fox
, 
foxÀn
 + 1,

1032 
fox°r
, 
foxÀn
, 
TFW_STR_EQ_CASEI
));

1033 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_off
(
fox
, -1,

1034 
fox°r
, 
foxÀn
, 
TFW_STR_EQ_CASEI
));

1036 
	}
}

1038 
	$TEST
(
tfw_°r_eq_c°r_pos
, 
compound
)

1040 
TfwSå
 *
fox
 = 
	`make_compound_°r
(
fox°r
), *
c
, *
íd
;

1041 
i
, 
off£t
 = 0, 
foxÀn
 = 
fox
->
Àn
;

1043 
	`TFW_STR_FOR_EACH_CHUNK
(
c
, 
fox
, 
íd
) {

1044 
i
 = 0; i < 
c
->
Àn
; i++) {

1045 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r_pos
(
fox
,

1046 
c
->
±r
 + 
i
,

1047 
fox°r
 + 
off£t
,

1048 
foxÀn
 - 
off£t
,

1049 
TFW_STR_EQ_CASEI
));

1050 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_pos
(
fox
,

1051 
c
->
±r
 + 
i
,

1054 
TFW_STR_EQ_CASEI
));

1055 ++
off£t
;

1059 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_pos
(
fox
,

1061 
fox°r
,

1062 
foxÀn
,

1063 
TFW_STR_EQ_CASEI
));

1064 
	}
}

1066 
	$TEST
(
tfw_°r_eq_c°r_off
, 
compound
)

1068 
TfwSå
 *
fox
 = 
	`make_compound_°r
(
fox°r
);

1069 
off£t
 = 0, 
foxÀn
 = 
fox
->
Àn
;

1071 
off£t
 = 0; off£à< 
fox
->
Àn
; ++offset) {

1072 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r_off
(
fox
, 
off£t
,

1073 
fox°r
 + 
off£t
,

1074 
foxÀn
 - 
off£t
,

1075 
TFW_STR_EQ_CASEI
));

1076 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_off
(
fox
, 
off£t
,

1078 
TFW_STR_EQ_CASEI
));

1081 
	`EXPECT_TRUE
(
	`tfw_°r_eq_c°r_off
(
fox
, 0,

1082 
fox°r
, 
foxÀn
, 
TFW_STR_EQ_CASEI
));

1084 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_off
(
fox
, 
foxÀn
 + 1,

1085 
fox°r
, 
foxÀn
, 
TFW_STR_EQ_CASEI
));

1086 
	`EXPECT_FALSE
(
	`tfw_°r_eq_c°r_off
(
fox
, -1,

1087 
fox°r
, 
foxÀn
, 
TFW_STR_EQ_CASEI
));

1089 
	}
}

1091 
	$TEST
(
tfw_°r_¸c32
, 
∂aö_compound
)

1093 
TfwSå
 *
°r_∂n
 = 
	`make_∂aö_°r
(
fox°r
);

1094 
TfwSå
 *
°r_cm≤d
 = 
	`make_compound_°r
(
fox°r
);

1095 
u32
 
¸c_∂n
, 
¸c_cm≤d
;

1097 
¸c_∂n
 = 
	`tfw_°r_¸c32_ˇlc
(
°r_∂n
);

1098 
¸c_cm≤d
 = 
	`tfw_°r_¸c32_ˇlc
(
°r_cm≤d
);

1100 
	`EXPECT_EQ
(
¸c_∂n
, 
¸c_cm≤d
);

1101 
	}
}

1103 
	$TEST_SUITE
(
tfw_°r
)

1105 
	`TEST_SETUP
(
¸óã_°r_poﬁ
);

1106 
	`TEST_TEARDOWN
(
‰ì_Æl_°r
);

1108 
	`TEST_RUN
(
c°r
, 
tﬁowî
);

1109 
	`TEST_RUN
(
c°r
, 
simd_m©ch
);

1110 
	`TEST_RUN
(
c°r
, 
simd_m©ch_˘ext_vch¨
);

1111 
	`TEST_RUN
(
c°r
, 
simd_m©ch_cu°om
);

1112 
	`TEST_RUN
(
c°r
, 
simd_°πﬁowî
);

1113 
	`TEST_RUN
(
c°r
, 
simd_°ricmp
);

1115 
	`TEST_RUN
(
c°r
, 
u…ﬂ
);

1117 
	`TEST_RUN
(
tfw_°r˝y
, 
zîo_§c
);

1118 
	`TEST_RUN
(
tfw_°r˝y
, 
zîo_d°
);

1119 
	`TEST_RUN
(
tfw_°r˝y
, 
bŸh_∂aö
);

1120 
	`TEST_RUN
(
tfw_°r˝y
, 
§c_compound
);

1121 
	`TEST_RUN
(
tfw_°r˝y
, 
d°_compound
);

1122 
	`TEST_RUN
(
tfw_°r˝y
, 
bŸh_compound
);

1124 
	`TEST_RUN
(
tfw_°r˝y_desc
, 
bŸh_∂aö
);

1125 
	`TEST_RUN
(
tfw_°r˝y_desc
, 
bŸh_compound
);

1126 
	`TEST_RUN
(
tfw_°r˝y_desc
, 
∂aö_compound
);

1128 
	`TEST_RUN
(
tfw_°rˇt
, 
∂aö
);

1129 
	`TEST_RUN
(
tfw_°rˇt
, 
compound
);

1131 
	`TEST_RUN
(
tfw_°rdup
, 
∂aö
);

1132 
	`TEST_RUN
(
tfw_°rdup
, 
compound
);

1134 
	`TEST_RUN
(
tfw_°ricmp
, 
ªtu∫s_åue_⁄ly_f‹_equÆ_tfw_°rs
);

1135 
	`TEST_RUN
(
tfw_°ricmp
, 
h™dÀs_∂aö_™d_compound_°rs
);

1136 
	`TEST_RUN
(
tfw_°ricmp
, 
h™dÀs_em±y_°rs
);

1137 
	`TEST_RUN
(
tfw_°ricmp
, 
h™dÀs_dif„ª¡_size_°rs
);

1139 
	`TEST_RUN
(
tfw_°rcmp
, 
ªtu∫s_åue_⁄ly_f‹_equÆ_tfw_°rs
);

1140 
	`TEST_RUN
(
tfw_°rcmp
, 
h™dÀs_∂aö_™d_compound_°rs
);

1141 
	`TEST_RUN
(
tfw_°rcmp
, 
h™dÀs_em±y_°rs
);

1142 
	`TEST_RUN
(
tfw_°rcmp
, 
h™dÀs_dif„ª¡_size_°rs
);

1144 
	`TEST_RUN
(
tfw_°r_eq_c°r
, 
ªtu∫s_åue_⁄ly_f‹_equÆ_°rs
);

1145 
	`TEST_RUN
(
tfw_°r_eq_c°r
, 
h™dÀs_∂aö_°r
);

1146 
	`TEST_RUN
(
tfw_°r_eq_c°r
, 
h™dÀs_u¡îmö©ed_°rs
);

1147 
	`TEST_RUN
(
tfw_°r_eq_c°r
, 
h™dÀs_em±y_°rs
);

1148 
	`TEST_RUN
(
tfw_°r_eq_c°r
, 
suµ‹ts_ˇ£i
);

1149 
	`TEST_RUN
(
tfw_°r_eq_c°r
, 
suµ‹ts_¥efix
);

1150 
	`TEST_RUN
(
tfw_°r_eq_c°r_off
, 
suµ‹ts_suffix
);

1152 
	`TEST_RUN
(
tfw_°r_eq_c°r_pos
, 
∂aö
);

1153 
	`TEST_RUN
(
tfw_°r_eq_c°r_off
, 
∂aö
);

1154 
	`TEST_RUN
(
tfw_°r_eq_c°r_pos
, 
compound
);

1155 
	`TEST_RUN
(
tfw_°r_eq_c°r_off
, 
compound
);

1157 
	`TEST_RUN
(
tfw_°r_¸c32
, 
∂aö_compound
);

1158 
	}
}

	@t/unit/test_tls.c

20 
	~<löux/ty≥s.h
>

21 
	~<asm/Âu/≠i.h
>

22 
	~<löux/bug.h
>

23 
	~<löux/kî√l.h
>

25 
	~"kÆlsyms_hñ≥r.h
"

26 
	~"ã°.h
"

27 
	~"âls.h
"

29 
	#DEFINE_TLS_TEST
(
«me
) \

30 
	`TEST
(
és
, 
«me
) \

32 
vîbo£
 = 1; \

33 (*
t‚
)(Ë
	`gë_sym_±r
("ttls_" #name "_self_test"); \

34 i‡(!
t‚
) { \

35 
	`TEST_FAIL
("Cannot findÅtls selfÅest for %s", #name); \

38 
	`kî√l_Âu_begö
(); \

39 
	`EXPECT_ZERO
(
	`t‚
(
vîbo£
)); \

40 
	`kî√l_Âu_íd
(); \

41 }

	)

43 
DEFINE_TLS_TEST
(
e˝
);

44 
DEFINE_TLS_TEST
(
mpi
);

45 
DEFINE_TLS_TEST
(
rß
);

47 
	$TEST_SUITE
(
és
)

49 
	`TEST_RUN
(
és
, 
e˝
);

50 
	`TEST_RUN
(
és
, 
mpi
);

51 
	`TEST_RUN
(
és
, 
rß
);

52 
	}
}

	@t/unit/test_wq.c

20 
	~<löux/ty≥s.h
>

21 
	~<asm/Âu/≠i.h
>

22 
	~<löux/bug.h
>

23 
	~<löux/˘y≥.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/kthªad.h
>

26 
	~<löux/vmÆloc.h
>

28 
	~"ã°.h
"

29 
	~"w‹k_queue.h
"

31 
	#QSZ
 2048

	)

32 
	#N
 
QSZ
 * 100

	)

33 
	#JOB_N
 10

	)

35 c⁄° 
	gX_EMPTY
 = 0;

36 c⁄° 
	gX_MISSED
 = 255;

37 c⁄° 
	gX_DONE
 = 100;

39 
TfwRBQueue
 *
	gwq
;

42 
èsk_°ru˘
 *
	mèsk
;

43 
	m±r
[
N
];

44 } 
	tTfwTe°Produ˚r
;

47 
size_t
 
	m¥ods_n
;

48 
TfwTe°Produ˚r
 
	m¥ods
[0];

49 } 
	tTfwTe°Produ˚rs
;

52 
èsk_°ru˘
 *
	mèsk
;

53 } 
	tTfwTe°C⁄sumî
;

56 
size_t
 
	mc⁄s_n
;

57 
TfwTe°C⁄sumî
 
	mc⁄s
[0];

58 } 
	tTfwTe°C⁄sumîs
;

61 *
	mw‹k
;

62 
	m_
[3];

63 } 
	tTfwTe°W‹k
;

65 
©omic_t
 
	ga˘ive_¥ods
;

66 
©omic_t
 
	ga˘ive_c⁄s
;

69 
	$tfw_ã°_wq_suôe_£tup
()

71 
r
;

73 
wq
 = 
	`kzÆloc
((
TfwRBQueue
), 
GFP_KERNEL
);

74 
	`BUG_ON
(!
wq
);

75 
r
 = 
	`tfw_wq_öô
(
wq
, 
	`˝u_to_node
(
	`smp_¥o˚ss‹_id
()));

76 
	`BUG_ON
(
r
);

77 
	}
}

80 
	$tfw_ã°_wq_suôe_ã¨down
()

82 
	`tfw_wq_de°roy
(
wq
);

83 
	`k‰ì
(
wq
);

84 
	}
}

87 
	$tfw_ã°_wq_w‹k_¥od
(*
d©a
)

89 
TfwTe°Produ˚r
 *
¥od_d©a
 = (TfwTe°Produ˚∏*)
d©a
;

90 
size_t
 
w‹k
 = 0;

92 
	`TFW_WQ_CHECKSZ
(
TfwTe°W‹k
);

94 
w‹k
 < 
N
){

95 
TfwTe°W‹k
 
wq_ôem
 = { &
¥od_d©a
->
±r
[
w‹k
] };

97 
¥od_d©a
->
±r
[
w‹k
] = 
X_MISSED
;

98 
	`__tfw_wq_push
(
wq
, &
wq_ôem
))

99 
	`scheduÀ
();

100 ++
w‹k
;

102 
	`scheduÀ
();

104 
	`©omic_dec
(&
a˘ive_¥ods
);

107 
	}
}

110 
	$tfw_ã°_wq_w‹k_c⁄s
(*
d©a
)

112 
	`©omic_ªad
(&
a˘ive_¥ods
Ë|| 
	`tfw_wq_size
(
wq
)) {

113 
TfwTe°W‹k
 
wq_ôem
;

115 
	`scheduÀ
();

116 i‡(
	`tfw_wq_p›
(
wq
, &
wq_ôem
))

119 
	`EXPECT_EQ
(*
wq_ôem
.
w‹k
, 
X_MISSED
);

120 *
wq_ôem
.
w‹k
 = 
X_DONE
;

122 
	`©omic_dec
(&
a˘ive_c⁄s
);

125 
	}
}

127 
èsk_°ru˘
 *

128 
tfw_thªad_¸óã
((*
thªad‚
)(*
d©a
), *data,

129 
˝u
, c⁄° *
«mefmt
)

131 
èsk_°ru˘
 *
p
;

133 
p
 = 
	`kthªad_¸óã_⁄_node
(
thªad‚
, 
d©a
, 
	`˝u_to_node
(
˝u
), 
«mefmt
,

134 
˝u
);

135 i‡(
	`IS_ERR
(
p
))

136  
p
;

137 
	`kthªad_böd
(
p
, 
˝u
);

138  
p
;

139 
	}
}

142 
	$tfw_ã°_˛ónup_¥ods
(
TfwTe°Produ˚rs
 *
¥ods
)

144 
size_t
 
i
 = 0;

146  ; 
i
 < 
¥ods
->
¥ods_n
; ++i) {

147 
TfwTe°Produ˚r
 *
¥od
 = &
¥ods
->¥ods[
i
];

148 i‡(
¥od
->
èsk
)

149 
	`kthªad_°›
(
¥od
->
èsk
);

151 
	`©omic_£t
(&
a˘ive_¥ods
, 0);

152 
	`v‰ì
(
¥ods
);

153 
	}
}

155 
TfwTe°Produ˚rs
*

156 
	$tfw_ã°_•awn_¥ods
(
size_t
 
n
)

158 
TfwTe°Produ˚rs
 *
¥ods
;

159 
size_t
 
size
, 
i
;

160 
˝u
 = -1;

162 
size
 = (
TfwTe°Produ˚rs
Ë+ 
n
 * (
TfwTe°Produ˚r
);

163 i‡(!(
¥ods
 = 
	`vmÆloc
(
size
)))

164  
NULL
;

165 
	`mem£t
(
¥ods
, 0, 
size
);

166 
¥ods
->
¥ods_n
 = 
n
;

169 
i
 = 0; i < 
n
; ++i) {

170 
TfwTe°Produ˚r
 *
¥od
 = &
¥ods
->¥ods[
i
];

173 
˝u
 = 
	`˝umask_√xt
(˝u, 
˝u_⁄löe_mask
);

174 i‡(
˝u
 >
ƒ_˝u_ids
)

175 
˝u
 = -1;

176 } 
˝u
 == -1);

178 
¥od
->
èsk
 = 
	`tfw_thªad_¸óã
(
tfw_ã°_wq_w‹k_¥od
,

179 
¥od
, 
˝u
, "TfwTestWqProd");

180 i‡(
	`IS_ERR_OR_NULL
(
¥od
->
èsk
))

181 
îr
;

183 
	`©omic_add
(
n
, &
a˘ive_¥ods
);

185  
¥ods
;

186 
îr
:

187 
	`tfw_ã°_˛ónup_¥ods
(
¥ods
);

188  
NULL
;

189 
	}
}

192 
	$tfw_ã°_˛ónup_c⁄s
(
TfwTe°C⁄sumîs
 *
c⁄s
)

194 
size_t
 
i
 = 0;

196  ; 
i
 < 
c⁄s
->
c⁄s_n
; ++i) {

197 
TfwTe°C⁄sumî
 *
c⁄
 = &
c⁄s
->c⁄s[
i
];

198 i‡(
c⁄
->
èsk
)

199 
	`kthªad_°›
(
c⁄
->
èsk
);

201 
	`©omic_£t
(&
a˘ive_c⁄s
, 0);

202 
	`v‰ì
(
c⁄s
);

203 
	}
}

205 
TfwTe°C⁄sumîs
*

206 
	$tfw_ã°_•awn_c⁄s
(
size_t
 
n
)

208 
size_t
 
˝u_n
 = 
	`num_⁄löe_˝us
();

209 
TfwTe°C⁄sumîs
 *
c⁄s
;

210 
˝u
 = -1;

211 
size_t
 
size
, 
i
;

213 
size
 = (
TfwTe°C⁄sumîs
Ë+ 
n
 * (
TfwTe°C⁄sumî
);

214 i‡(!(
c⁄s
 = 
	`vmÆloc
(
˝u_n
 * 
size
)))

215  
NULL
;

216 
	`mem£t
(
c⁄s
, 0, 
˝u_n
 * 
size
);

217 
c⁄s
->
c⁄s_n
 = 
n
;

220 
i
 = 0; i < 
n
; ++i) {

221 
TfwTe°C⁄sumî
 *
c⁄
 = &
c⁄s
->c⁄s[
i
];

224 
˝u
 = 
	`˝umask_√xt
(˝u, 
˝u_⁄löe_mask
);

225 i‡(
˝u
 >
ƒ_˝u_ids
)

226 
˝u
 = -1;

227 } 
˝u
 == -1);

229 
c⁄
->
èsk
 = 
	`tfw_thªad_¸óã
(
tfw_ã°_wq_w‹k_c⁄s
,

230 
c⁄
, 
˝u
, "TfwTestWqCons");

231 i‡(
	`IS_ERR_OR_NULL
(
c⁄
->
èsk
))

232 
îr
;

234 
	`©omic_add
(
n
, &
a˘ive_c⁄s
);

236  
c⁄s
;

237 
îr
:

238 
	`tfw_ã°_˛ónup_c⁄s
(
c⁄s
);

239  
NULL
;

240 
	}
}

243 
	$tfw_ã°_as£π_¥ods
(
TfwTe°Produ˚rs
 *
¥ods
)

245 
size_t
 
i
 = 0, 
j
 = 0;

247  ; 
i
 < 
¥ods
->
¥ods_n
; ++i)

248  ; 
j
 < 
N
; ++j)

249 
	`EXPECT_EQ
(
¥ods
->¥ods[
i
].
±r
[
j
], 
X_DONE
);

250 
	}
}

253 
	$tfw_ã°_wq_run
(
TfwTe°Produ˚rs
 *
¥ods
, 
TfwTe°C⁄sumîs
 *
c⁄s
)

255 
size_t
 
i
;

257 
i
 = 0; i < 
¥ods
->
¥ods_n
; ++i)

258 
	`wake_up_¥o˚ss
(
¥ods
->¥ods[
i
].
èsk
);

260 
	`tfw_wq_size
(
wq
Ë< 
QSZ
)

261 
	`scheduÀ
();

262 
i
 = 0; i < 
c⁄s
->
c⁄s_n
; ++i)

263 
	`wake_up_¥o˚ss
(
c⁄s
->c⁄s[
i
].
èsk
);

264 
	`©omic_ªad
(&
a˘ive_c⁄s
))

265 
	`scheduÀ
();

267 
	`tfw_ã°_as£π_¥ods
(
¥ods
);

268 
	}
}

271 
	$tfw_ã°_wq_ã°
(
size_t
 
¥od_n
, size_à
c⁄_n
)

273 
TfwTe°Produ˚rs
 *
¥ods
;

274 
TfwTe°C⁄sumîs
 *
c⁄s
;

276 i‡(!(
¥ods
 = 
	`tfw_ã°_•awn_¥ods
(
¥od_n
))) {

277 
	`TEST_FAIL
("Cannot initializeÖroducersÅhreads\n");

280 i‡(!(
c⁄s
 = 
	`tfw_ã°_•awn_c⁄s
(
c⁄_n
))) {

281 
	`TEST_FAIL
("Cannot initialize consumersÅhreads\n");

282 
	`tfw_ã°_˛ónup_¥ods
(
¥ods
);

286 
	`tfw_ã°_wq_run
(
¥ods
, 
c⁄s
);

288 
	`v‰ì
(
c⁄s
);

289 
	`v‰ì
(
¥ods
);

290 
	}
}

292 
	$TEST
(
wq
, 
⁄e_¥od_⁄e_c⁄
)

294 
	`tfw_ã°_wq_ã°
(1, 1);

295 
	}
}

297 
	$TEST
(
wq
, 
m™y_¥od_⁄e_c⁄
)

299 
	`tfw_ã°_wq_ã°
(
JOB_N
 * 
	`num_⁄löe_˝us
(), 1);

300 
	}
}

302 
	$TEST_SUITE
(
wq
)

304 
	`TEST_SETUP
(
tfw_ã°_wq_suôe_£tup
);

305 
	`TEST_TEARDOWN
(
tfw_ã°_wq_suôe_ã¨down
);

308 
	`TEST_RUN
(
wq
, 
⁄e_¥od_⁄e_c⁄
);

309 
	`TEST_RUN
(
wq
, 
m™y_¥od_⁄e_c⁄
);

310 
	}
}

	@t/unit/tfw_str_helper.c

21 
	~<löux/bug.h
>

22 
	~<löux/kî√l.h
>

23 
	~<löux/°rög.h
>

25 
	~"lib/°r.h
"

26 
	~"tfw_°r_hñ≥r.h
"

28 
TfwPoﬁ
 *
	g°r_poﬁ
;

31 
	$¸óã_°r_poﬁ
()

33 
	`BUG_ON
(
°r_poﬁ
);

34 
°r_poﬁ
 = 
	`__tfw_poﬁ_√w
(1);

35 
	`BUG_ON
(!
°r_poﬁ
);

36 
	}
}

39 
	$‰ì_Æl_°r
()

41 
	`tfw_poﬁ_de°roy
(
°r_poﬁ
);

42 
°r_poﬁ
 = 
NULL
;

43 
	}
}

45 
TfwSå
 *

46 
	$Æloc_°r
()

48 
TfwSå
 *
s
;

50 
s
 = 
	`tfw_poﬁ_Æloc
(
°r_poﬁ
, (*s));

51 
	`BUG_ON
(!
s
);

52 
	`TFW_STR_INIT
(
s
);

54  
s
;

55 
	}
}

57 
TfwSå
 *

58 
	$make_∂aö_°r
(c⁄° *
d©a
)

60 
TfwSå
 *
s
 = 
	`Æloc_°r
();

62 
s
->
Àn
 = 
	`°æí
(
d©a
);

63 
s
->
±r
 = (*)
d©a
;

65  
s
;

66 
	}
}

68 
TfwSå
 *

69 
	$make_compound_°r
(c⁄° *
d©a
)

71 
TfwSå
 *
°r
, *
chunk
;

72 
size_t
 
chunk_Àn
 = 1;

73 
size_t
 
tŸÆ_Àn
 = 
	`°æí
(
d©a
);

75 
°r
 = 
	`Æloc_°r
();

76 
°r
->
Àn
 = 
	`mö
(
tŸÆ_Àn
, 
chunk_Àn
);

77 
°r
->
±r
 = (*)
d©a
;

79 
tŸÆ_Àn
 -
°r
->
Àn
;ÅŸÆ_À¿> 0;ÅŸÆ_À¿-
chunk
->len) {

80 
chunk
 = 
	`tfw_°r_add_compound
(
°r_poﬁ
, 
°r
);

81 i‡(!
chunk
)

82  
NULL
;

83 
chunk
->
Àn
 = 
	`mö
(
tŸÆ_Àn
, ++
chunk_Àn
 % 8);

84 
chunk
->
±r
 = (*)(
d©a
 + 
°r
->
Àn
);

85 
°r
->
Àn
 +
chunk
->len;

88  
°r
;

89 
	}
}

91 
TfwSå
 *

92 
	$make_compound_°r2
(c⁄° *
d©a1
, c⁄° *
d©a2
)

94 
TfwSå
 *
°r
, *
chunk
;

96 
°r
 = 
	`Æloc_°r
();

97 
°r
->
Àn
 = 
	`°æí
(
d©a1
);

98 
°r
->
±r
 = (*)
d©a1
;

100 
chunk
 = 
	`tfw_°r_add_compound
(
°r_poﬁ
, 
°r
);

101 i‡(!
chunk
)

102  
NULL
;

104 
chunk
->
Àn
 = 
	`°æí
(
d©a2
);

105 
chunk
->
±r
 = (*)
d©a2
;

106 
°r
->
Àn
 = 
	`°æí
(
d©a1
Ë+ såÀn(
d©a2
);

108  
°r
;

109 
	}
}

	@t/unit/tfw_str_helper.h

20 
	~"°r.h
"

22 
TfwPoﬁ
 *
°r_poﬁ
;

24 
¸óã_°r_poﬁ
();

25 
‰ì_Æl_°r
();

27 
TfwSå
 *
make_∂aö_°r
(c⁄° *
d©a
);

28 
TfwSå
 *
make_compound_°r
(c⁄° *
d©a
);

29 
TfwSå
 *
make_compound_°r2
(c⁄° *
d©a1
, c⁄° *
d©a2
);

31 
	#TFW_STR
(
«me
, 
lôîÆ
Ë
TfwSå
 *«mê
	`make_compound_°r
÷ôîÆ)

	)

32 
	#TFW_STR2
(
«me
, 
lôîÆ1
, 
lôîÆ2
Ë
TfwSå
 *«mê
	`make_compound_°r2
÷ôîÆ1,ÜôîÆ2)

	)

	@t/unit/user_space/alb.c

23 
	~<°dio.h
>

24 
	~<°rög.h
>

26 
	~<löux/kî√l.h
>

27 
	~<löux/•ölock.h
>

38 
	møtio
;

39 
	mcuº_øtio
;

40 
	m__∑ddög
[14];

41 } 
	tR©ioSrv
 
	t____ˇchñöe_Æig√d_ö_smp
;

58 
•ölock_t
 
	mlock
;

59 
	m§v_n
;

60 
	mcuº
;

61 
	mri
;

62 
	mrsum
;

63 
	mrsum_‹ig
;

64 
	mª¨m
;

65 } 
	tR©ioSched
;

67 
	#MAX_SRV
 16

	)

68 
	g§v_˙t
[
MAX_SRV
];

69 
R©ioSrv
 
	g§vs
[
MAX_SRV
] 
	g____ˇchñöe_Æig√d_ö_smp
;

70 
R©ioSched
 
rs
 
	g____ˇchñöe_Æig√d_ö_smp
;

78 c⁄° 
	gøtios0
[] = { 1 };

79 c⁄° 
	gøtios1
[] = { 2, 1, 1 };

80 c⁄° 
	gøtios2
[] = { 3, 1, 1 };

82 c⁄° 
	gøtios3
[] = { 38, 9, 5, 4, 3, 3, 1 };

83 c⁄° 
	gøtios4
[] = { 100, 80, 60, 50, 45, 30 };

84 c⁄° 
	gøtios5
[] = { 760, 190, 110, 90, 70, 60, 20 };

85 c⁄° 
	gøtios6
[] = { 105, 104, 103, 102, 101, 100, 1 };

90 c⁄° 
	gøtios7
[] = { 1010, 1000, 20, 3, 2, 1, 1, 1 };

96 c⁄° 
	gøtios8
[] = { 5, 4, 3, 2, 1 };

97 c⁄° 
	gøtios9
[] = { 5000, 4000, 3000, 2000, 1000 };

99 c⁄° 
	gøtios10
[] = { 1, 1, 1, 1 };

100 c⁄° 
	gøtios11
[] = { 4, 4, 4 };

102 c⁄° 
	gøtios12
[] = { 10, 10, 10, 1, 1 };

108 
	$öô_sched
(c⁄° *
øtios
, 
n
)

110 
i
;

112 
	`BUG_ON
(
n
 > 
MAX_SRV
);

114 
	`mem£t
(
§vs
, 0, (srvs));

115 
	`mem£t
(&
rs
, 0, (rs));

117 
i
 = 0; i < 
n
; ++i) {

118 
§vs
[
i
].
øtio
 = srvs[i].
cuº_øtio
 = 
øtios
[i];

119 
rs
.
rsum
 +
øtios
[
i
];

121 
	`•ö_lock_öô
(&
rs
.
lock
);

122 
rs
.
§v_n
 = 
n
;

123 
rs
.
ri
 = 1;

124 
rs
.
rsum_‹ig
 =Ñs.
rsum
;

125 
rs
.
ª¨m
 = 
n
;

126 
	}
}

148 
ölöe
 
boﬁ


149 
	$is_§v_tu∫
(
i
)

151 
hód_sum2
, 
èû_sum2
;

154 i‡(!
i
)

155  
åue
;

157 
hód_sum2
 = (
§vs
[0].
cuº_øtio
 + srvs[
i
 - 1].curr_ratio) * i;

158 
èû_sum2
 = (
§vs
[
i
].
cuº_øtio


159 + (
§vs
[
rs
.
§v_n
 - 1].
cuº_øtio


160 ? : 
§vs
[
rs
.
§v_n
 - 1].
øtio
))

161 * (
rs
.
§v_n
 - 
i
);

162  
èû_sum2
 * 
rs
.
ri
 > 
hód_sum2
;

163 
	}
}

174 
	$sched
()

176 
s
;

179 
	`•ö_lock
(&
rs
.
lock
);

180 
ªåy
:

181 
s
 = 
rs
.
cuº
;

183 i‡(!
§vs
[
s
].
cuº_øtio
) {

185 i‡(
rs
.
ª¨m
 !
s
) {

193 ++
rs
.
cuº
;

194 i‡(
rs
.
cuº
 =rs.
§v_n
) {

195 
rs
.
cuº
 = 0;

196 
rs
.
ri
 = 1;

198 
ªåy
;

200 
§vs
[
s
].
cuº_øtio
 = srvs[s].
øtio
;

201 ++
rs
.
ª¨m
;

205 i‡(
	`likñy
(
	`is_§v_tu∫
(
s
))) {

206 --
§vs
[
s
].
cuº_øtio
;

207 i‡(
	`u∆ikñy
(!--
rs
.
rsum
)) {

212 
rs
.
cuº
 = 0;

213 
rs
.
ri
 = 1;

214 
rs
.
rsum
 =Ñs.
rsum_‹ig
;

215 
rs
.
ª¨m
 = 0;

217 i‡(
	`u∆ikñy
(++
rs
.
cuº
 =rs.
§v_n
)) {

223 
	`BUG_ON
(
rs
.
ª¨m
 !rs.
§v_n
);

224 
rs
.
cuº
 = 0;

225 
rs
.
ri
 = 1;

227 
	`•ö_u∆ock
(&
rs
.
lock
);

228  
s
;

234 
rs
.
cuº
 = 0;

235 ++
rs
.
ri
;

236 
ªåy
;

237 
	}
}

241 
åa˚
(
s
, 
n
 
__©åibuã__
((
unu£d
)))

243 #ifde‡
TRACE


244 
	gi
;

246 
¥ötf
("srv=%u,Ñs: srv_n=%u curr=%uÑi=%uÑsum=%u/%uÑearm=%u\n",

247 
s
, 
rs
.
§v_n
,Ñs.
cuº
,Ñs.
ri
,Ñs.
rsum
,Ñs.
rsum_‹ig
,Ñs.
ª¨m
);

248 
¥ötf
("servers: ");

249 
	gi
 = 0; i < 
	gn
; ++i)

250 
¥ötf
("%u/%u ", 
§vs
[
i
].
øtio
, srvs[i].
cuº_øtio
);

251 
¥ötf
("\n");

253 
¥ötf
("%u ", 
s
);

255 
fÊush
(
°dout
);

259 
	#TEST_REQ_N
 100

	)

261 
	#TEST
(
øtio
) \

263 
i
, 
n
 = 
	`ARRAY_SIZE
(
øtio
); \

264 
	`mem£t
(
§v_˙t
, 0, (srv_cnt)); \

265 
	`öô_sched
(
øtio
, 
n
); \

266 
i
 = 0; i < 
TEST_REQ_N
; ++i) { \

267 
s
 = 
	`sched
(); \

268 
§v_˙t
[
s
]++; \

269 
	`åa˚
(
s
, 
n
); \

271 
	`¥ötf
("\n"); \

272 
i
 = 0; i < 
MAX_SRV
; ++i) { \

273 i‡(
i
 < 
n
) \

274 
	`¥ötf
("srv[%d] (ratio = %d):\t%d\n", \

275 
i
, 
øtio
[i], 
§v_˙t
[i]); \

277 
	`BUG_ON
(
§v_˙t
[
i
]); \

279 
	`¥ötf
("\n"); \

280 
	`fÊush
(
°dout
); \

281 } 0)

	)

284 
	$maö
(
¨gc
, *
¨gv
[])

286 
	`¥ötf
("Te° f‹ schedulög %uÑeque°s\n", 
TEST_REQ_N
);

288 
	`TEST
(
øtios0
);

289 
	`TEST
(
øtios1
);

290 
	`TEST
(
øtios2
);

291 
	`TEST
(
øtios3
);

292 
	`TEST
(
øtios4
);

293 
	`TEST
(
øtios5
);

294 
	`TEST
(
øtios6
);

295 
	`TEST
(
øtios7
);

296 
	`TEST
(
øtios8
);

297 
	`TEST
(
øtios9
);

298 
	`TEST
(
øtios10
);

299 
	`TEST
(
øtios11
);

300 
	`TEST
(
øtios12
);

303 
	}
}

	@t/unit/user_space/percentiles.c

43 
	~<°dio.h
>

44 
	~<°dlib.h
>

45 
	~<°rög.h
>

47 
	~<löux/©omic.h
>

48 
	~<löux/kî√l.h
>

50 
	#mö
(
a
,
b
Ë((◊Ë< (b)Ë? (aË: (b))

	)

51 
	#SET
(
s
Ë{
	`ARRAY_SIZE
(s), s}

	)

58 
size_t
 
	mÀn
;

59 *
	m£t
;

60 } 
	g£ts
[] = {

62 
SET
((([]){1, 2, 3, 4, 5, 6, 7, 8, 9, 10})),

67 
SET
((([]){1, 2, 3, 3, 3, 3, 4, 4, 5, 1001, 1002, 1010})),

69 
SET
((([]){1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14,

85 
	môh
;

86 
	mvÆ
;

87 } 
	tPî˚¡ûõ
;

93 
	$basic_≥r˚¡ûõ
(c⁄° *
£t
, 
size_t
 
Àn
, 
Pî˚¡ûõ
 *
p˙ts
,

94 
size_t
 
≈
)

96 
i
;

98 
i
 = 0; i < 
≈
; ++i) {

100 
n
 = 
Àn
 * 
p˙ts
[
i
].
ôh
 / 100;

101 
p˙ts
[
i
].
vÆ
 = 
n
 ? 
£t
[n - 1] : 0;

103 
	}
}

124 
	#TFW_STATS_RANGES
 4

	)

125 
	#TFW_STATS_RLAST
 (
TFW_STATS_RANGES
 - 1)

	)

126 
	#TFW_STATS_BCKTS_ORDER
 4

	)

127 
	#TFW_STATS_BCKTS
 (1 << 
TFW_STATS_BCKTS_ORDER
)

	)

129 
	#TFW_STATS_RSPAN
(
‹dî
Ë((
TFW_STATS_BCKTS
 - 1Ë<< (‹dî))

	)

130 
	#TFW_STATS_RSPAN_UL
(
‹dî
Ë((
TFW_STATS_BCKTS
 - 1ULË<< (‹dî))

	)

133 
	m‹dî
;

134 
	mbegö
;

135 
	míd
;

136 } 
	tTfwP˙tCé
;

139 
TfwP˙tCé
 
	m˘l
[
TFW_STATS_RANGES
];

140 
	mtŸ_˙t
;

141 
	m__∑ddög
[
TFW_STATS_RLAST
];

142 
	m˙t
[
TFW_STATS_RANGES
][
TFW_STATS_BCKTS
];

143 } 
	tTfwP˙tR™ges
 
	t__©åibuã__
((
	tÆig√d
(
	tL1_CACHE_BYTES
)));

145 
ölöe
 *

146 
	$__∫g
(
TfwP˙tCé
 *
pc
, *
˙t
, 
r_time
)

148 i‡(
r_time
 <
pc
->
begö
)

149  &
˙t
[0];

150  &
˙t
[(
r_time
 - 
pc
->
begö
 + ((1 <<Öc->
‹dî
) - 1)) >>Öc->order];

151 
	}
}

154 
	$__ønge_grow_right
(
TfwP˙tR™ges
 *
∫g
, 
TfwP˙tCé
 *
pc
, 
r
)

156 
i
;

158 ++
pc
->
‹dî
;

159 
pc
->
íd
 =Öc->
begö
 + 
	`TFW_STATS_RSPAN
’c->
‹dî
);;

161 
	`¥ötf
(" --ÉxtendÑight bound ofÑange %dÅo begin=%u order=%u"

162 "Énd=%u\n", 
r
, 
pc
->
begö
,Öc->
‹dî
,Öc->
íd
);

165 
i
 = 0; i < 
TFW_STATS_BCKTS
 / 2; ++i)

166 
∫g
->
˙t
[
r
][
i
] =Ñng->cnt[r][2 * i] +Ñng->cnt[r][2 * i + 1];

167 
	}
}

170 
	$__ønge_shrök_À·
(
TfwP˙tR™ges
 *
∫g
, 
TfwP˙tCé
 *
pc
, 
r
)

172 
i
;

173 
˙t_fuŒ
, 
˙t_hÆf
;

175 --
pc
->
‹dî
;

176 
pc
->
begö
 =Öc->
íd
 - 
	`TFW_STATS_RSPAN
’c->
‹dî
);

178 
	`¥ötf
(" -- shrinkÜeft bound ofÑange %dÅo begin=%u order=%u"

179 "Énd=%u\n", 
r
, 
pc
->
begö
,Öc->
‹dî
,Öc->
íd
);

185 
i
 = 1; i < 
TFW_STATS_BCKTS
 / 2; ++i)

186 
∫g
->
˙t
[
r
][0] +∫g->˙t[r][
i
];

187 
˙t_fuŒ
 = 
∫g
->
˙t
[
r
][
TFW_STATS_BCKTS
 / 2];

188 
˙t_hÆf
 = 
˙t_fuŒ
 / 2;

189 
∫g
->
˙t
[
r
][0] +
˙t_hÆf
;

190 
∫g
->
˙t
[
r
][1] = 
˙t_fuŒ
 - 
˙t_hÆf
;

191 
i
 = 1; i < 
TFW_STATS_BCKTS
 / 2; ++i) {

192 
˙t_fuŒ
 = 
∫g
->
˙t
[
r
][
TFW_STATS_BCKTS
 / 2 + 
i
];

193 
˙t_hÆf
 = 
˙t_fuŒ
 / 2;

194 
∫g
->
˙t
[
r
][
i
 * 2] = 
˙t_hÆf
;

195 
∫g
->
˙t
[
r
][
i
 * 2 + 1] = 
˙t_fuŒ
 - 
˙t_hÆf
;

197 
	}
}

203 
	$tfw_°©s_exãnd
(
TfwP˙tR™ges
 *
∫g
, 
r_time
)

205 
i
, 
b
;

206 
TfwP˙tCé
 *
pc
 = &
∫g
->
˘l
[
TFW_STATS_RLAST
];

207 
sum
, 
∑πs
, 
unôs
, 
shi·
, 
‹dî
 = 
pc
->order;

210 ++
‹dî
;

211 
pc
->
íd
 =Öc->
begö
 + 
	`TFW_STATS_RSPAN_UL
(
‹dî
);

212 } 
pc
->
íd
 < 
r_time
);

214 
shi·
 = 
	`mö
(
‹dî
 - 
pc
->‹dî, 
TFW_STATS_BCKTS_ORDER
);

215 
unôs
 = 1 << 
shi·
;

216 
∑πs
 = 
TFW_STATS_BCKTS
 >> 
shi·
;

218 
pc
->
‹dî
 = order;

220 
	`¥ötf
(" --ÉxtendÜastÑangeÅo begin=%u order=%uÉnd=%u\n",

221 
pc
->
begö
,Öc->
‹dî
,Öc->
íd
);

227 
i
 = 0; i < 
∑πs
; ++i) {

228 
unôs
) {

230 
∫g
->
˙t
[
TFW_STATS_RLAST
][
i
] =

231 
∫g
->
˙t
[
TFW_STATS_RLAST
][2 * 
i
]

232 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][2 * 
i
 + 1];

235 
∫g
->
˙t
[
TFW_STATS_RLAST
][
i
] =

236 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
]

237 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
 + 1]

238 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
 + 2]

239 + 
∫g
->
˙t
[
TFW_STATS_RLAST
][4 * 
i
 + 3];

242 
sum
 = 0;

243 
b
 = 
i
 * 
unôs
; b < (i + 1) * units; ++b)

244 
sum
 +
∫g
->
˙t
[
TFW_STATS_RLAST
][
b
];

245 
∫g
->
˙t
[
TFW_STATS_RLAST
][
i
] = 
sum
;

249 
	`mem£t
(&
∫g
->
˙t
[
TFW_STATS_RLAST
][
∑πs
], 0,

250 (
∫g
->
˙t
[0][0]Ë* (
TFW_STATS_BCKTS
 - 
∑πs
));

251 
	}
}

264 
	$tfw_°©s_adju°
(
TfwP˙tR™ges
 *
∫g
, 
r
)

266 
i
;

267 
TfwP˙tCé
 *
pc
, *
¥ïc
;

268 
¥íd
, 
˙t
 = 0, 
sum
 = 0, 
max
 = 0, 
i_max
 = 0;

270 
	`BUG_ON
(
r
 == 0);

272 
i
 = 0; i < 
TFW_STATS_BCKTS
; ++i) {

273 i‡(
∫g
->
˙t
[
r
][
i
]) {

274 
sum
 +
∫g
->
˙t
[
r
][
i
];

275 ++
˙t
;

277 i‡(
max
 < 
∫g
->
˙t
[
r
][
i
]) {

278 
max
 = 
∫g
->
˙t
[
r
][
i
];

279 
i_max
 = 
i
;

282 
	`BUG_ON
(!
˙t
);

285 i‡(
	`likñy
(
max
 <
sum
 * 2 / 
˙t
))

288 
	`¥ötf
(" --Ñange %d has outlier %lu (avg=%luÅotal=%lu)át"

289 " buckë %lu\n", 
r
, 
max
, 
sum
 / 
˙t
, sum, 
i_max
);

300 
pc
 = &
∫g
->
˘l
[
r
];

301 
¥ïc
 = &
∫g
->
˘l
[
r
 - 1];

302 
¥íd
 = 
¥ïc
->
begö
 + 
	`TFW_STATS_RSPAN_UL
’ªpc->
‹dî
 + 1);

304 i‡((
i_max
 =0Ë&& (
¥íd
 < 
pc
->
begö
)) {

305 
	`__ønge_grow_right
(
∫g
, 
¥ïc
, 
r
 - 1);

307 
˙t
 = 
max
 / (
TFW_STATS_BCKTS
 / 2 + 1);

308 
∫g
->
˙t
[
r
][0] -˙à* (
TFW_STATS_BCKTS
 / 2);

309 
i
 = 
TFW_STATS_BCKTS
 / 2; i < TFW_STATS_BCKTS; ++i)

310 
∫g
->
˙t
[
r
 - 1][
i
] = cnt;

318 i‡(
	`likñy
(
pc
->
‹dî
))

319 
	`__ønge_shrök_À·
(
∫g
, 
pc
, 
r
);

320 
	}
}

327 
	$tfw_°©s_upd
(
TfwP˙tR™ges
 *
∫g
, 
r_time
)

329 
TfwP˙tCé
 *
pc3
, *
pc2
 = &
∫g
->
˘l
[2];

332 i‡(
r_time
 <
pc2
->
íd
) {

333 
TfwP˙tCé
 *
pc0
, *
pc1
 = &
∫g
->
˘l
[1];

335 i‡(
r_time
 > 
pc1
->
íd
) {

336 ++(*
	`__∫g
(
pc2
, 
∫g
->
˙t
[2], 
r_time
));

337 
	`tfw_°©s_adju°
(
∫g
, 2);

338 
tŸÆs
;

341 
pc0
 = &
∫g
->
˘l
[0];

342 
	`BUG_ON
(
pc0
->
begö
 != 1);

343 i‡(
r_time
 > 
pc0
->
íd
) {

344 ++(*
	`__∫g
(
pc1
, 
∫g
->
˙t
[1], 
r_time
));

345 
	`tfw_°©s_adju°
(
∫g
, 1);

346 
tŸÆs
;

349 ++(*
	`__∫g
(
pc0
, 
∫g
->
˙t
[0], 
r_time
));

350 
tŸÆs
;

353 
pc3
 = &
∫g
->
˘l
[3];

354 i‡(
	`u∆ikñy
(
r_time
 > 
pc3
->
íd
))

355 
	`tfw_°©s_exãnd
(
∫g
, 
r_time
);

356 ++(*
	`__∫g
(
pc3
, 
∫g
->
˙t
[3], 
r_time
));

357 
	`tfw_°©s_adju°
(
∫g
, 3);

359 
tŸÆs
:

360 ++
∫g
->
tŸ_˙t
;

363 
	}
}

370 
	$tfw_°©s_ˇlc
(
TfwP˙tR™ges
 *
∫g
, 
Pî˚¡ûõ
 *
p˙ts
, 
size_t
 
≈
, 
boﬁ
 
˛ór
)

372 
i
, 
r
, 
b
, 
p
 = 0;

373 
˙t
, 
tŸ_˙t
 = 
∫g
->tot_cnt;

374 
pvÆ
[
≈
];

376 i‡(
	`u∆ikñy
(!
tŸ_˙t
))

380 
i
 = 0; i < 
≈
; ++i) {

381 
pvÆ
[
i
] = 
tŸ_˙t
 * 
p˙ts
[i].
ôh
 / 100;

382 i‡(!
pvÆ
[
i
])

383 
p˙ts
[
p
++].
vÆ
 = 0;

386 
˙t
 = 0, 
r
 = 0;Ñ < 
TFW_STATS_RANGES
; ++r)

387 
b
 = 0; b < 
TFW_STATS_BCKTS
; ++b) {

388 
˙t
 +
∫g
->˙t[
r
][
b
];

389  ; 
p
 < 
≈
 && 
pvÆ
[p] <
˙t
; ++p) {

390 
p˙ts
[
p
].
ôh
 = 
˙t
 * 100 / 
tŸ_˙t
;

391 
p˙ts
[
p
].
vÆ
 = 
∫g
->
˘l
[
r
].
begö


392 + (
b
 << 
∫g
->
˘l
[
r
].
‹dî
);

394 i‡(
˛ór
)

395 
∫g
->
˙t
[
r
][
b
] = 0;

398 
	`BUG_ON
 (
p
 < 
≈
);

399 i‡(
˛ór
)

400 
∫g
->
tŸ_˙t
 = 0;

401 
	}
}

407 
TfwP˙tR™ges
 
	g∫g
 = {

408 .
˘l
 = { {0, 1, 16},

416 
	$tfw_≥r˚¡ûõ
(c⁄° *
£t
, 
size_t
 
Àn
, 
Pî˚¡ûõ
 *
p˙ts
,

417 
size_t
 
≈
)

419 
i
;

422 
i
 = 0; i < 
Àn
; ++i)

423 
	`tfw_°©s_upd
(&
∫g
, 
£t
[
i
]);

430 
	`tfw_°©s_ˇlc
(&
∫g
, 
p˙ts
, 
≈
, 
åue
);

431 
	}
}

434 
	$maö
(
¨gc
, *
¨gv
[])

436 
i
, 
j
;

438 
	`¥ötf
("Format: <percentilieÇumber> -> <value>\n\n");

440 
i
 = 0; i < 
	`ARRAY_SIZE
(
£ts
); ++i) {

441 
Pî˚¡ûõ
 
µªv
[6], 
≤ext
[6];

442 
Pî˚¡ûõ
 
p0
[6] = { {1}, {50}, {75}, {90}, {95}, {99} };

443 
Pî˚¡ûõ
 
p1
[6] = { {1}, {50}, {75}, {90}, {95}, {99} };

452 
	`mem˝y
(
µªv
, 
p1
, (p1));

455 
	`basic_≥r˚¡ûõ
(
£ts
[
i
].
£t
, sës[i].
Àn
, 
p0
, 
	`ARRAY_SIZE
(p0));

456 
	`¥ötf
("base:\t1->%u\t50->%u\t75->%u\t90->%u\t95->%u\t99->%u\n",

457 
p0
[0].
vÆ
,Ö0[1].val,Ö0[2].val,Ö0[3].val,Ö0[4].val,

458 
p0
[5].
vÆ
);

461 
	`tfw_≥r˚¡ûõ
(
£ts
[
i
].
£t
, sës[i].
Àn
, 
p1
, 
	`ARRAY_SIZE
(p1));

462 
	`¥ötf
("tfw:\t%d->%u\t%d->%u\t%d->%u\t%d->%u\t%d->%u\t%d->%u\n",

463 
p1
[0].
ôh
,Ö1[0].
vÆ
,Ö1[1].ith,Ö1[1].val,

464 
p1
[2].
ôh
,Ö1[2].
vÆ
,Ö1[3].ith,Ö1[3].val,

465 
p1
[4].
ôh
,Ö1[4].
vÆ
,Ö1[5].ith,Ö1[5].val);

477 
j
 = 0; j < 
	`ARRAY_SIZE
(
p1
); ++j) {

478 i‡(
	`u∆ikñy
(!
p1
[
j
].
ôh
)) {

479 
≤ext
[
j
].
ôh
 = 
µªv
[j].ith;

480 
≤ext
[
j
].
vÆ
 = 
µªv
[j].val;

483 i‡(
	`u∆ikñy
(!
µªv
[
j
].
ôh
)) {

484 
≤ext
[
j
].
ôh
 = 
p1
[j].ith;

485 
≤ext
[
j
].
vÆ
 = 
p1
[j].val;

488 
≤ext
[
j
].
ôh
 = (
p1
[j].ôh + 
µªv
[j].ith) / 2;

489 i‡(
	`u∆ikñy
(!
p1
[
j
].
vÆ
)) {

490 
≤ext
[
j
].
vÆ
 = 
µªv
[j].val;

492 i‡(
	`u∆ikñy
(!
µªv
[
j
].
vÆ
)) {

493 
≤ext
[
j
].
vÆ
 = 
p1
[j].val;

496 
≤ext
[
j
].
vÆ
 = 
p1
[j].vÆ * 2 - 
µªv
[j].val;

499 
	`¥ötf
("trend:\t%d->%d\t%d->%d\t%d->%d\t%d->%d\t%d->%d\t%d->%d"

501 
≤ext
[0].
ôh
,Ö√xt[0].
vÆ
,Önext[1].ith,Önext[1].val,

502 
≤ext
[2].
ôh
,Ö√xt[2].
vÆ
,Önext[3].ith,Önext[3].val,

503 
≤ext
[4].
ôh
,Ö√xt[4].
vÆ
,Önext[5].ith,Önext[5].val);

507 
	}
}

	@t/unit/user_space/slr.cc

23 
	~<as£π.h
>

25 
	~<io°ªam
>

27 
	gãm∂©e
<
˛ass
 
	gT
, c⁄° 
	gwsz
>

28 ˛as†
	cSLR
 {

31 c⁄° 
	mMUL
 = 1000;

33 
	mn
;

34 
T
 
	mx_avg
, 
	my_avg
;

35 
T
 
	mxy_avg
;

36 
T
 
	mx_avg_y_avg
;

37 
T
 
	mx_sq_avg
;

38 
T
 
	mx_avg_sq
;

39 
T
 
	ma
, 
	mb
;

41 
T
 
	mx
;

42 
T
 
	my
;

43 } 
	gwö
[
wsz
];

45 
	gpublic
:

46 
	$SLR
()

47 : 
	`n
(0), 
	`x_avg
(0), 
	`y_avg
(0), 
	`xy_avg
(0), 
	`x_avg_y_avg
(0),

48 
	`x_sq_avg
(0), 
	`x_avg_sq
(0), 
	`a
(0), 
	`b
(0), 
wö
{0
	}
}

52 
	$¶r_upd
(
x
, 
y
)

54 
ni
, 
sz
;

56 
y
 *
MUL
;

57 
x
 *
MUL
;

58 
ni
 = 
n
 % 
wsz
;

60 i‡(
n
 < 
wsz
) {

61 
sz
 = 
ni
 + 1;

62 
x_avg
 = (x_avg * 
n
 + 
x
Ë/ 
sz
;

63 
y_avg
 = (y_avg * 
n
 + 
y
Ë/ 
sz
;

64 
xy_avg
 = (xy_avg * 
n
 + 
y
 * 
x
Ë/ 
sz
;

65 
x_avg_y_avg
 = 
x_avg
 * 
y_avg
;

66 
x_sq_avg
 = (x_sq_avg * 
n
 + 
x
 * xË/ 
sz
;

67 
x_avg_sq
 = 
x_avg
 * x_avg;

71 
sz
 = 
wsz
;

72 
x_avg
 = x_avg - (
wö
[
ni
].
x
 - xË/ 
sz
;

73 
y_avg
 = y_avg - (
wö
[
ni
].
y
 - yË/ 
sz
;

74 
xy_avg
 = xy_avg - (
wö
[
ni
].
x
 * wö[ni].
y
 - y * xË/ 
sz
;

75 
x_avg_y_avg
 = 
x_avg
 * 
y_avg
;

76 
x_sq_avg
 = x_sq_avg - (
wö
[
ni
].
x
 * win[ni].x - x * x)

77 / 
sz
;

78 
x_avg_sq
 = 
x_avg
 * x_avg;

81 
wö
[
ni
].
x
 = x;

82 
wö
[
ni
].
y
 = y;

83 
n
++;

85 i‡(
x_sq_avg
 =
x_avg_sq
) {

87 
a
 = 0;

88 
b
 = 
x_avg
 ? 
y_avg
 / x_avg : 1;

90 
b
 = (
xy_avg
 - 
x_avg_y_avg
Ë/ (
x_sq_avg
 - 
x_avg_sq
);

91 
a
 = (
y_avg
 - 
b
 * 
x_avg
Ë/ 
MUL
;

93 #ifde‡
DEBUG


94 
°d
::
cout
 << "-- x_avg=" << 
x_avg
 << " y_avg=" << 
y_avg


95 << " xy_avg=" << 
xy_avg


96 << " x_avg_y_avg=" << 
x_avg_y_avg


97 << " x_sq_avg=" << 
x_sq_avg


98 << " x_avg_sq=" << 
x_avg_sq
 << 
°d
::
ídl
;

99 
°d
::
cout
 << "-- wö: " << 
wö
[0].
x
 << "," << wö[0].
y


100 << " " << 
wö
[1].
x
 << "," << wö[1].
y


101 << " " << 
wö
[2].
x
 << "," << wö[2].
y


102 << " " << 
wö
[3].
x
 << "," << wö[3].
y


103 << " " << 
wö
[4].
x
 << "," << wö[4].
y
 << 
°d
::
ídl
;

104 
°d
::
cout
 << "--á=" << 
a
 << " b=" << 
b
 << std::
ídl
;

106 
	}
}

108 
T


109 
	$¶r_¥edi˘
(
x
)

111  
a
 + 
b
 * 
x
;

112 
	}
}

115 
	$add_d©a
(
x
, 
y
)

117 
°d
::
cout
 << "-> x=" << 
x
 << " y=" << 
y
 << std::
ídl
;

118 
	`¶r_upd
(
x
, 
y
);

119 
	}
}

122 
	$¥edi˘
(
x
)

124 
°d
::
cout
 << "->Öªdi˘ f‹ " << 
x
 << " is "

125 << 
	`¶r_¥edi˘
(
x
Ë<< 
°d
::
ídl
;

126 
	}
}

129 
	gãm∂©e
<
˛ass
 
	gT
, c⁄° 
	gwsz
>

131 
	$ã°
()

133 
SLR
<
T
, 
wsz
> 
¶r
;

135 
¶r
.
	`add_d©a
(1, 3);

136 
¶r
.
	`add_d©a
(2, 5);

137 
¶r
.
	`add_d©a
(3, 11);

138 
¶r
.
	`add_d©a
(4, 2);

139 
¶r
.
	`add_d©a
(5, 7);

140 
¶r
.
	`add_d©a
(6, 0);

141 
¶r
.
	`add_d©a
(7, 1);

142 
¶r
.
	`add_d©a
(8, 100);

143 
¶r
.
	`add_d©a
(11, 9);

144 
¶r
.
	`add_d©a
(9, 2);

145 
¶r
.
	`add_d©a
(12, 6);

146 
¶r
.
	`add_d©a
(13, 8);

148 
¶r
.
	`¥edi˘
(15);

149 
	}
}

154 
	gãm∂©e
<
˛ass
 
	gT
, c⁄° 
	gwsz
>

156 
	$ã°_vîifõd
()

158 
SLR
<
T
, 
wsz
> 
¶r
;

160 
¶r
.
	`add_d©a
(1, 1);

161 
¶r
.
	`add_d©a
(2, 1);

162 
¶r
.
	`add_d©a
(3, 1);

163 
¶r
.
	`add_d©a
(4, 1);

164 
¶r
.
	`add_d©a
(5, 1);

165 
¶r
.
	`add_d©a
(6, 1);

166 
¶r
.
	`add_d©a
(7, 1);

167 
¶r
.
	`add_d©a
(8, 1);

168 
¶r
.
	`add_d©a
(9, 1);

169 
¶r
.
	`add_d©a
(10, 1);

170 
¶r
.
	`add_d©a
(11, 1);

171 
¶r
.
	`add_d©a
(12, 1);

172 
¶r
.
	`add_d©a
(13, 1);

174 
¶r
.
	`¥edi˘
(15);

175 
	}
}

178 
	$maö
(
¨gc
, *
¨gv
[])

180 
°d
::
cout
 << "TEST f‹ doubÀ" << std::
ídl
;

181 
ã°
<, 5>();

183 
°d
::
cout
 << "TEST f‹Ü⁄g" << std::
ídl
;

184 
ã°
<, 5>();

186 
°d
::
cout
 << "VîifõdÅe° f‹Ü⁄g,Åhêªsu… should bê'1'" << std::
ídl
;

187 
ã°_vîifõd
<, 8>();

191 
°d
::
cout
 << std::
ídl
;

192 
°d
::
cout
 << "I≈uàlöêf‹m©:" << std::
ídl
;

193 
°d
::
cout
 << std::
ídl
;

194 
°d
::
cout
 << " cuº_x cuº_yÖªdi˘i⁄_x" << std::
ídl
;

195 
°d
::
cout
 << std::
ídl
;

196 
°d
::
cout
 << ", whîê¥edi˘i⁄_x > cuº_x i†thêtime" << std::
ídl
;

197 
°d
::
cout
 << "which wê√edÖªdi˘ y f‹." << std::
ídl
;

198 
°d
::
cout
 << std::
ídl
;

199 
°d
::
cout
 << "> ";

201 
x
, 
y
, 
¥ed_x
;

202 
SLR
<, 5> 
¶r
;

203 
°d
::
cö
 >> 
x
 >> 
y
 >> 
¥ed_x
) {

204 
¶r
.
	`¶r_upd
(
x
, 
y
);

205 
°d
::
cout
 << "(x=" << 
x
 << " y=" << 
y


206 << "Ë√xày f‹ x=" << 
¥ed_x


207 << " i†" << 
¶r
.
	`¶r_¥edi˘
(
¥ed_x
Ë<< 
°d
::
ídl
;

208 
°d
::
cout
 << "\n> ";

212 
	}
}

	@tempesta_fw.h

21 #i‚de‡
__TEMPESTA_FW_H__


22 
	#__TEMPESTA_FW_H__


	)

24 
	~<löux/ö6.h
>

25 
	~<löux/moduÀ.h
>

26 
	~<löux/rw£m.h
>

27 
	~<löux/ãm≥°a.h
>

28 
	~<löux/ty≥s.h
>

29 
	~<√t/sock.h
>

31 
	~"lib/log.h
"

32 
	~"cfg.h
"

34 
	#TFW_AUTHOR
 "Tem≥°®Technﬁogõs, Inc"

	)

35 
	#TFW_NAME
 "Tem≥°®FW"

	)

36 
	#TFW_VERSION
 "0.6.0"

	)

38 
	#DEF_MAX_PORTS
 8

	)

83 
li°_hód
 
	mli°
;

84 c⁄° *
	m«me
;

85 (*
	mcfg°¨t
)();

86 (*
	mcfgíd
)();

87 (*
	mcfg˛ón
)();

88 (*
	m°¨t
)();

89 (*
	m°›
)();

90 
TfwCfgS≥c
 *
	m•ecs
;

91 } 
	tTfwMod
;

93 
	#MOD_FOR_EACH
(
pos
, 
hód
) \

94 
	`li°_f‹_óch_íåy
(
pos
, 
hód
, 
li°
)

	)

96 
	#MOD_FOR_EACH_REVERSE
(
pos
, 
hód
) \

97 
	`li°_f‹_óch_íåy_ªvî£
(
pos
, 
hód
, 
li°
)

	)

99 
tfw_mod_ªgi°î
(
TfwMod
 *
mod
);

100 
tfw_mod_uƒegi°î
(
TfwMod
 *
mod
);

101 
TfwMod
 *
tfw_mod_föd
(c⁄° *
«me
);

103 
boﬁ
 
tfw_run°©e_is_ªc⁄fig
();

113 
ölöe
 

114 
	$tfw_§v_lo›_sched_rcu
()

116 
	`c⁄d_ªsched_rcu_qs
();

117 
	`rcu_b¨rõr_bh
();

118 
	}
}

	@tls.c

22 
	~"cfg.h
"

23 
	~"c⁄√˘i⁄.h
"

24 
	~"˛õ¡.h
"

25 
	~"msg.h
"

26 
	~"¥ocfs.h
"

27 
	~"és.h
"

30 
âls_c⁄fig
 
	mcfg
;

31 
âls_x509_¸t
 
	m¸t
;

32 
âls_pk_c⁄ãxt
 
	mkey
;

33 
	m¸t_pg_addr
;

34 
	m¸t_pg_‹dî
;

35 } 
	gtfw_és
;

43 
	$tfw_és_ch›_skb_ªc
(
TlsCtx
 *
és
, 
sk_buff
 *
skb
, 
off
,

44 
TfwFsmD©a
 *
d©a
)

46 
size_t
 
¥ﬁog
 = 
	`âls_∑ylﬂd_off
(&
és
->
x‰m
);

48 
óãn_skb
:

49 i‡(
	`likñy
(
skb
->
Àn
 > 
¥ﬁog
)) {

50 
off
 +
¥ﬁog
;

52 
sk_buff
 *
√xt
 = 
skb
->next;

53 i‡(
	`WARN_ON_ONCE
(!
√xt
))

54  -
EIO
;

55 
¥ﬁog
 -
skb
->
Àn
;

56 
off
 = 0;

57 
	`__k‰ì_skb
(
skb
);

58 
skb
 = 
√xt
;

59 
óãn_skb
;

61 
és
->
io_ö
.
skb_li°
 = 
NULL
;

63 
d©a
->
skb
 = skb;

64 
d©a
->
off
 = off;

65 
d©a
->
åaû
 = 
	`âls_x‰m_ègÀn
(&
és
->
x‰m
);

68 
	}
}

71 
	$tfw_és_msg_¥o˚ss
(*
c⁄n
, 
TfwFsmD©a
 *
d©a
)

73 
r
, 
∑r£d
 = 0;

74 
sk_buff
 *
nskb
 = 
NULL
, *
skb
 = 
d©a
->skb;

75 
off
 = 
d©a
->off;

76 
TfwC⁄n
 *
c
 = 
c⁄n
;

77 
TlsCtx
 *
és
 = 
	`tfw_és_c⁄ãxt
(
c
);

78 
sk_buff
 *
msg_skb
;

79 
TfwFsmD©a
 
d©a_up
 = {};

81 
	`BUG_ON
(
off
 >
skb
->
Àn
);

88 
	`•ö_lock
(&
és
->
lock
);

89 
√xt_msg
:

90 
	`ss_skb_queue_èû
(&
és
->
io_ö
.
skb_li°
, 
skb
);

91 
msg_skb
 = 
és
->
io_ö
.
skb_li°
;

92 
r
 = 
	`ss_skb_¥o˚ss
(
skb
, 
off
, 0, 
âls_ªcv
, 
és
, &és->
io_ö
.
chunks
,

93 &
∑r£d
);

94 
r
) {

96 
	`T_WARN
("Unrecognized TLSÑeceiveÑeturn code %d, dropÖacket\n",

97 
r
);

98 
T_DROP
:

99 
	`•ö_u∆ock
(&
és
->
lock
);

100 
	`__k‰ì_skb
(
skb
);

101  
r
;

102 
T_POSTPONE
:

110 
	`•ö_u∆ock
(&
és
->
lock
);

111  
TFW_PASS
;

112 
T_OK
:

117 
	`T_DBG3
("%s:Ö¨£d=%d skb->Àn=%u\n", 
__func__
,

118 
∑r£d
, 
skb
->
Àn
);

140 i‡(
∑r£d
 < 
skb
->
Àn
) {

141 
nskb
 = 
	`ss_skb_•lô
(
skb
, 
∑r£d
);

142 i‡(
	`u∆ikñy
(!
nskb
)) {

143 
	`•ö_u∆ock
(&
és
->
lock
);

144 
	`TFW_INC_STAT_BH
(
˛¡
.
msgs_Ÿhîr
);

145  
T_DROP
;

150 i‡((
r
 = 
	`tfw_és_ch›_skb_ªc
(
és
, 
msg_skb
, 
off
, &
d©a_up
)))

151 
out_îr
;

152 
r
 = 
	`tfw_gfsm_move
(&
c
->
°©e
, 
TFW_TLS_FSM_DATA_READY
, &
d©a_up
);

153 i‡(
r
 =
TFW_BLOCK
) {

154 
	`•ö_u∆ock
(&
és
->
lock
);

155 
	`k‰ì_skb
(
nskb
);

156  
r
;

159 i‡(
nskb
) {

160 
skb
 = 
nskb
;

161 
nskb
 = 
NULL
;

162 
∑r£d
 = 
off
 = 0;

163 
√xt_msg
;

166 
out_îr
:

167 
	`•ö_u∆ock
(&
és
->
lock
);

169  
r
;

170 
	}
}

176 
	$tfw_és_t˝_add_ovîhód
(
sock
 *
sk
, 
ovîhód
)

178 
sk
->
sk_wmem_queued
 +
ovîhód
;

179 
	`sk_mem_ch¨ge
(
sk
, 
ovîhód
);

180 
	`t˝_sk
(
sk
)->
wrôe_£q
 +
ovîhód
;

181 
	}
}

190 
	$tfw_és_t˝_¥›ag©e_d£q
(
sock
 *
sk
, 
sk_buff
 *
skb
)

192 
sk_buff
 *
√xt
;

193 
t˝_skb_cb
 *
tcb_√xt
, *
tcb
 = 
	`TCP_SKB_CB
(
skb
);

195 i‡(
	`t˝_skb_is_œ°
(
sk
, 
skb
))

198 
√xt
 = 
	`t˝_wrôe_queue_√xt
(
sk
, 
skb
);

199 
tcb_√xt
 = 
	`TCP_SKB_CB
(
√xt
);

200 
	`WARN_ON_ONCE
((
tcb_√xt
->
£q
 ||Åcb_√xt->
íd_£q
)

201 && 
tcb_√xt
->
£q
 + 
√xt
->
Àn
 !tcb_√xt->
íd_£q
);

203 
tcb_√xt
->
£q
 = 
tcb
->
íd_£q
;

204 
tcb_√xt
->
íd_£q
 =Åcb_√xt->
£q
 + 
√xt
->
Àn
;

205 
	}
}

218 
	$tfw_és_í¸y±
(
sock
 *
sk
, 
sk_buff
 *
skb
, 
limô
)

224 
	#AUTO_SEGS_N
 8

	)

226 
r
 = -
ENOMEM
;

227 
hód_sz
, 
èg_sz
, 
Àn
, 
‰ags
;

228 
ty≥
;

229 
sk_buff
 *
√xt
 = 
skb
, *
skb_èû
 = skb;

230 
t˝_skb_cb
 *
tcb
 = 
	`TCP_SKB_CB
(
skb
);

231 
TlsCtx
 *
és
 = 
	`tfw_és_c⁄ãxt
(
sk
->
sk_u£r_d©a
);

232 
TlsIOCtx
 *
io
 = &
és
->
io_out
;

233 
TlsX‰m
 *
x‰m
 = &
és
->xfrm;

234 
sg_èbÀ
 
sgt
 = {

235 .
√¡s
 = 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 + !!
	`skb_hódÀn
(skb),

237 
sˇâîli°
 
sg
[
AUTO_SEGS_N
];

239 
	`T_DBG3
("%s: sk=%pK(snd_una=%u snd_nxt=%uÜimit=%u)"

241 " seq=%u:%u)\n", 
__func__
,

242 
sk
, 
	`t˝_sk
(sk)->
¢d_u«
,Å˝_sk(sk)->
¢d_nxt
, 
limô
,

243 
skb
, skb->
Àn
, skb->
d©a_Àn
, 
	`ãm≥°a_és_skb_ty≥
(skb),

244 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
, 
	`skb_hódÀn
(skb),

245 
tcb
->
£q
,Åcb->
íd_£q
);

246 
	`BUG_ON
(!
	`âls_x‰m_ªady
(
és
));

247 
	`WARN_ON_ONCE
(
skb
->
Àn
 > 
TLS_MAX_PAYLOAD_SIZE
);

248 
	`WARN_ON_ONCE
(
tcb
->
£q
 + 
skb
->
Àn
 !tcb->
íd_£q
);

250 
hód_sz
 = 
	`âls_∑ylﬂd_off
(
x‰m
);

251 
èg_sz
 = 
	`âls_x‰m_ègÀn
(
x‰m
);

252 
Àn
 = 
hód_sz
 + 
skb
->À¿+ 
èg_sz
;

253 
ty≥
 = 
	`ãm≥°a_és_skb_ty≥
(
skb
);

254 i‡(!
ty≥
) {

255 
	`T_WARN
("%s: bad skbÅy≥ %u\n", 
__func__
, 
ty≥
);

256  -
EINVAL
;

260 
tcb
->
íd_£q
 +
hód_sz
;

263 !
	`t˝_skb_is_œ°
(
sk
, 
skb_èû
)) {

264 
√xt
 = 
	`t˝_wrôe_queue_√xt
(
sk
, 
skb_èû
);

265 
tcb
 = 
	`TCP_SKB_CB
(
√xt
);

267 
	`T_DBG3
("next skb (%pK) in write queue:Üen=%u frags=%u/%u"

269 
√xt
,Çext->
Àn
, 
	`skb_shöfo
“ext)->
ƒ_‰ags
,

270 !!
	`skb_hódÀn
(
√xt
), 
	`ãm≥°a_és_skb_ty≥
(next),

271 
tcb
->
£q
,Åcb->
íd_£q
);

273 i‡(
Àn
 + 
√xt
->À¿> 
limô
)

276 i‡(
ty≥
 !
	`ãm≥°a_és_skb_ty≥
(
√xt
))

280 
tcb
->
£q
 +
hód_sz
;

281 
tcb
->
íd_£q
 +
hód_sz
;

283 
Àn
 +
√xt
->len;

284 
sgt
.
√¡s
 +
	`skb_shöfo
(
√xt
)->
ƒ_‰ags
 + !!
	`skb_hódÀn
(next);

285 
skb_èû
 = 
√xt
;

293 
√xt
 = 
skb_èû
->next;

294 i‡(
skb_èû
 =
skb
) {

295 
r
 = 
	`ss_skb_ex∑nd_hód_èû
(
skb
->
√xt
, skb, 
hód_sz
, 
èg_sz
);

296 i‡(
r
 < 0)

297 
out
;

299 
r
 = 
	`ss_skb_ex∑nd_hód_èû
(
NULL
, 
skb
, 
hód_sz
, 0);

300 i‡(
r
 < 0)

301 
out
;

302 
sgt
.
√¡s
 +
r
;

304 
r
 = 
	`ss_skb_ex∑nd_hód_èû
(
skb_èû
->
√xt
, skb_tail, 0,

305 
èg_sz
);

306 i‡(
r
 < 0)

307 
out
;

309 
sgt
.
√¡s
 +
r
;

316 i‡(
	`likñy
(
skb_èû
->
√xt
 ==Çext)) {

317 
	`TCP_SKB_CB
(
skb_èû
)->
íd_£q
 +
èg_sz
;

319 
	`WARN_ON_ONCE
(
skb_èû
->
√xt
->
Àn
 !
èg_sz
);

320 
	`tfw_és_t˝_¥›ag©e_d£q
(
sk
, 
skb_èû
);

321 
skb_èû
 = skb_èû->
√xt
;

332 
	`tfw_és_t˝_¥›ag©e_d£q
(
sk
, 
skb_èû
);

334 
	`tfw_és_t˝_add_ovîhód
(
sk
, 
hód_sz
 + 
èg_sz
);

336 i‡(
	`likñy
(
sgt
.
√¡s
 <
AUTO_SEGS_N
)) {

337 
sgt
.
sgl
 = 
sg
;

339 
sgt
.
sgl
 = 
	`kmÆloc
((
sˇâîli°
Ë* sgt.
√¡s
,

340 
GFP_ATOMIC
);

341 i‡(!
sgt
.
sgl
) {

342 
	`T_WARN
("cannotálloc TLSÉncryption scatterÜist.\n");

343  -
ENOMEM
;

346 
	`sg_öô_èbÀ
(
sgt
.
sgl
, sgt.
√¡s
);

348 
√xt
 = 
skb
, 
‰ags
 = 0; ; ) {

353 
r
 = 
	`skb_to_sgvec
(
√xt
, 
sgt
.
sgl
 + 
‰ags
, 0,Çext->
Àn
);

355 
	`T_DBG3
("skb_to_sgvec (%u segs) from skb %pK"

357 
sgt
.
√¡s
, 
√xt
,Çext->
Àn
,

358 
	`skb_shöfo
(
√xt
)->
ƒ_‰ags
 + !!
	`skb_hódÀn
(next),

359 
‰ags
, 
r
);

361 i‡(
r
 <= 0)

362 
out
;

363 
‰ags
 +
r
;

364 
	`ãm≥°a_és_skb_˛ór
(
√xt
);

365 i‡(
√xt
 =
skb_èû
)

367 i‡(
	`WARN_ON_ONCE
(
‰ags
 >
sgt
.
√¡s
))

369 
√xt
 = 
	`t˝_wrôe_queue_√xt
(
sk
,Çext);

370 
	`sg_unm¨k_íd
(&
sgt
.
sgl
[
‰ags
 - 1]);

372 
	`WARN_ON_ONCE
(
sgt
.
√¡s
 !
‰ags
);

374 
	`•ö_lock
(&
és
->
lock
);

377 
io
->
msgÀn
 = 
Àn
 - 
TLS_HEADER_SIZE
;

378 
io
->
msgty≥
 = 
ty≥
;

379 i‡(!(
r
 = 
	`âls_í¸y±
(
és
, &
sgt
)))

380 
	`âls_Ød2hdriv
(
x‰m
, 
skb
->
d©a
);

382 
	`•ö_u∆ock
(&
és
->
lock
);

384 
out
:

385 i‡(
	`u∆ikñy
(
sgt
.
√¡s
 > 
AUTO_SEGS_N
))

386 
	`k‰ì
(
sgt
.
sgl
);

388  
r
;

389 #unde‡
AUTO_SEGS_N


390 
	}
}

397 
	$tfw_és_£nd
(
TlsCtx
 *
és
, 
sg_èbÀ
 *
sgt
, 
boﬁ
 
˛o£
)

399 
r
, 
Êags
 = 0;

400 
TfwTlsC⁄n
 *
c⁄n
 = 
	`c⁄èöî_of
(
és
, TfwTlsConn,Åls);

401 
TlsIOCtx
 *
io
 = &
és
->
io_out
;

402 
TfwMsgIãr
 
ô
;

403 
TfwSå
 
°r
 = {};

416 
°r
.
±r
 = 
io
->
hdr
;

417 
°r
.
Àn
 = 
TLS_HEADER_SIZE
 + 
io
->
h¶í
;

418 
	`T_DBG
("TLS %lu bytes +%u segments (%u bytes,Üast msgtype %#x)"

420 
°r
.
Àn
, 
sgt
 ? sgt->
√¡s
 : 0, 
io
->
msgÀn
, io->
msgty≥
, 
c⁄n
,

421 
c⁄n
->
˛i_c⁄n
.
sk
->
sk_wrôe_xmô
, 
	`âls_x‰m_ªady
(
és
));

423 i‡((
r
 = 
	`tfw_msg_ôî_£tup
(&
ô
, &
io
->
skb_li°
, 
°r
.
Àn
)))

424  
r
;

425 i‡((
r
 = 
	`tfw_msg_wrôe
(&
ô
, &
°r
)))

426  
r
;

428 
	`WARN_ON_ONCE
(
ô
.
skb
->
√xt
 !
io
->
skb_li°


429 || 
ô
.
skb
->
¥ev
 !
io
->
skb_li°
);

430 i‡(
sgt
) {

431 
f
, 
i
 = ++
ô
.
‰ag
;

432 
sk_buff
 *
skb
 = 
ô
.skb;

433 
sˇâîli°
 *
sg
;

435 
	`f‹_óch_sg
(
sgt
->
sgl
, 
sg
, sgt->
√¡s
, 
f
) {

436 i‡(
i
 >
MAX_SKB_FRAGS
) {

437 i‡(!(
skb
 = 
	`ss_skb_Æloc
(0)))

438  -
ENOMEM
;

439 
	`ss_skb_queue_èû
(&
io
->
skb_li°
, 
skb
);

440 
i
 = 0;

442 
	`skb_fûl_∑ge_desc
(
skb
, 
i
++, 
	`sg_∑ge
(
sg
), sg->
off£t
,

443 
sg
->
Àngth
);

444 
	`ss_skb_adju°_d©a_Àn
(
skb
, 
sg
->
Àngth
);

445 
	`T_DBG3
("fill skb frag %d by %pK,len=%u,flags=%lx in"

446 " skb=%pK,Àn=%u\n", 
i
 - 1,

447 
	`sg_vút
(
sg
), sg->
Àngth
, sg->
∑ge_lök
 & 0x3,

448 
skb
, skb->
Àn
);

452 i‡(
˛o£
)

453 
Êags
 |
SS_F_CONN_CLOSE
;

454 i‡(
	`âls_x‰m_ªady
(
és
))

455 
Êags
 |
SS_F_ENCRYPT
;

457  
	`ss_£nd
(
c⁄n
->
˛i_c⁄n
.
sk
, &
io
->
skb_li°
, 
Êags
);

458 
	}
}

461 
	$tfw_és_c⁄n_dt‹
(*
c
)

463 
TlsCtx
 *
és
 = 
	`tfw_és_c⁄ãxt
(
c
);

465 
	`âls_˘x_˛ór
(
és
);

466 
	`tfw_˛i_c⁄n_ªÀa£
((
TfwCliC⁄n
 *)
c
);

467 
	}
}

470 
	$tfw_és_c⁄n_öô
(
TfwC⁄n
 *
c
)

472 
r
;

473 
TlsCtx
 *
és
 = 
	`tfw_és_c⁄ãxt
(
c
);

475 i‡((
r
 = 
	`âls_˘x_öô
(
és
, &
tfw_és
.
cfg
))) {

476 
	`TFW_ERR
("TLS (%pKË£tu∞Áûed (%x)\n", 
és
, -
r
);

477  -
EINVAL
;

480 i‡(
	`tfw_c⁄n_hook_ˇŒ
(
TFW_FSM_HTTP
, 
c
, 
c⁄n_öô
))

481  -
EINVAL
;

483 
	`tfw_gfsm_°©e_öô
(&
c
->
°©e
, c, 
TFW_TLS_FSM_INIT
);

485 
c
->
de°ru˘‹
 = 
tfw_és_c⁄n_dt‹
;

488 
	}
}

491 
	$tfw_és_c⁄n_˛o£
(
TfwC⁄n
 *
c
, 
boﬁ
 
sync
)

493 
r
;

494 
TlsCtx
 *
és
 = 
	`tfw_és_c⁄ãxt
(
c
);

496 
	`•ö_lock
(&
és
->
lock
);

497 
r
 = 
	`âls_˛o£_nŸify
(
és
);

498 
	`•ö_u∆ock
(&
és
->
lock
);

507 i‡(
r
 && 
sync
) {

508 
	`TFW_WARN_ADDR
("Close TCP socket w/o sendingálertÅoÅheÖeer",

509 &
c
->
≥î
->
addr
);

510 
r
 = 
	`ss_˛o£
(
c
->
sk
, 
SS_F_SYNC
);

513  
r
;

514 
	}
}

517 
	$tfw_és_c⁄n_dr›
(
TfwC⁄n
 *
c
)

519 
	`tfw_c⁄n_hook_ˇŒ
(
TFW_FSM_HTTP
, 
c
, 
c⁄n_dr›
);

520 
	}
}

528 
	$tfw_és_c⁄n_£nd
(
TfwC⁄n
 *
c
, 
TfwMsg
 *
msg
)

530 
r
;

531 
TlsCtx
 *
és
 = 
	`tfw_és_c⁄ãxt
(
c
);

532 
TlsIOCtx
 *
io
 = &
és
->
io_out
;

538 
io
->
msgty≥
 = 
TTLS_MSG_APPLICATION_DATA
;

539 
	`T_DBG
("TLS %lu bytes (%u bytes,Åype %#x)"

541 
msg
->
Àn
, 
io
->
msgÀn
 + 
TLS_HEADER_SIZE
, io->
msgty≥
, 
c
,

542 
c
->
sk
->
sk_wrôe_xmô
, 
	`âls_x‰m_ªady
(
és
));

544 i‡(
	`âls_x‰m_ªady
(
és
))

545 
msg
->
ss_Êags
 |
	`SS_SKB_TYPE2F
(
io
->
msgty≥
Ë| 
SS_F_ENCRYPT
;

547 
r
 = 
	`ss_£nd
(
c
->
sk
, &
msg
->
skb_hód
, msg->
ss_Êags
 & ~
SS_F_CONN_CLOSE
);

548 i‡(
r
)

549  
r
;

555 i‡(
msg
->
ss_Êags
 & 
SS_F_CONN_CLOSE
) {

556 
	`•ö_lock
(&
és
->
lock
);

557 
r
 = 
	`âls_˛o£_nŸify
(
és
);

558 
	`•ö_u∆ock
(&
és
->
lock
);

561  
r
;

562 
	}
}

564 
TfwC⁄nHooks
 
	gés_c⁄n_hooks
 = {

565 .
c⁄n_öô
 = 
tfw_és_c⁄n_öô
,

566 .
	gc⁄n_˛o£
 = 
tfw_és_c⁄n_˛o£
,

567 .
	gc⁄n_dr›
 = 
tfw_és_c⁄n_dr›
,

568 .
	gc⁄n_£nd
 = 
tfw_és_c⁄n_£nd
,

577 
	$tfw_és_do_öô
()

579 
r
;

581 
	`âls_c⁄fig_öô
(&
tfw_és
.
cfg
);

583 
r
 = 
	`âls_c⁄fig_deÁu…s
(&
tfw_és
.
cfg
, 
TTLS_IS_SERVER
);

584 i‡(
r
) {

585 
	`TFW_ERR_NL
("TLS: c™'à£àc⁄fig deÁu…†(%x)\n", -
r
);

586  -
EINVAL
;

595 
	}
}

598 
	$tfw_és_do_˛ónup
()

600 
	`âls_x509_¸t_‰ì
(&
tfw_és
.
¸t
);

601 
	`âls_pk_‰ì
(&
tfw_és
.
key
);

602 
	`âls_c⁄fig_‰ì
(&
tfw_és
.
cfg
);

603 
	}
}

611 
	#TFW_TLS_CFG_F_DISABLED
 0U

	)

612 
	#TFW_TLS_CFG_F_REQUIRED
 1U

	)

613 
	#TFW_TLS_CFG_F_CERT
 2U

	)

614 
	#TFW_TLS_CFG_F_CKEY
 4U

	)

615 
	#TFW_TLS_CFG_M_ALL
 (
TFW_TLS_CFG_F_CERT
 | 
TFW_TLS_CFG_F_CKEY
)

	)

617 
	gtfw_és_cgf
 = 
TFW_TLS_CFG_F_DISABLED
;

620 
	$tfw_és_cfg_ªquúe
()

622 
tfw_és_cgf
 |
TFW_TLS_CFG_F_REQUIRED
;

623 
	}
}

626 
	$tfw_és_°¨t
()

628 
r
;

630 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

633 
	`âls_c⁄f_ˇ_chaö
(&
tfw_és
.
cfg
,Åfw_és.
¸t
.
√xt
, 
NULL
);

634 
r
 = 
	`âls_c⁄f_own_˚π
(&
tfw_és
.
cfg
, &tfw_és.
¸t
, &tfw_és.
key
);

635 i‡(
r
) {

636 
	`TFW_ERR_NL
("TLS: c™'à£àow¿˚πifiˇã (%x)\n", -
r
);

637  -
EINVAL
;

641 
	}
}

647 
	$tfw_cfg›_és_˚πifiˇã
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

649 
r
;

650 *
¸t_d©a
;

651 
size_t
 
¸t_size
;

653 
	`âls_x509_¸t_öô
(&
tfw_és
.
¸t
);

655 i‡(
˚
->
©å_n
) {

656 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

657 
cs
->
«me
);

658  -
EINVAL
;

660 i‡(
˚
->
vÆ_n
 != 1) {

661 
	`TFW_ERR_NL
("%s: InvalidÇumber ofárguments: %d\n",

662 
cs
->
«me
, ()
˚
->
vÆ_n
);

663  -
EINVAL
;

666 
¸t_d©a
 = 
	`tfw_cfg_ªad_fûe
((c⁄° *)
˚
->
vÆs
[0], &
¸t_size
);

667 i‡(!
¸t_d©a
) {

668 
	`TFW_ERR_NL
("%s: Can'tÑead certificate file '%s'\n",

669 
˚
->
«me
, (c⁄° *)˚->
vÆs
[0]);

670  -
EINVAL
;

673 
r
 = 
	`âls_x509_¸t_∑r£
(&
tfw_és
.
¸t
, (*)
¸t_d©a
,

674 
¸t_size
);

675 i‡(
r
) {

676 
	`TFW_ERR_NL
("%s: Invalid certificate specified (%x)\n",

677 
cs
->
«me
, -
r
);

678 
	`‰ì_∑ges
(()
¸t_d©a
, 
	`gë_‹dî
(
¸t_size
));

679  -
EINVAL
;

681 
tfw_és
.
¸t_pg_addr
 = ()
¸t_d©a
;

682 
tfw_és
.
¸t_pg_‹dî
 = 
	`gë_‹dî
(
¸t_size
);

683 
tfw_és_cgf
 |
TFW_TLS_CFG_F_CERT
;

686 
	}
}

689 
	$tfw_cfg›_˛ónup_és_˚πifiˇã
(
TfwCfgS≥c
 *
cs
)

691 
	`âls_x509_¸t_‰ì
(&
tfw_és
.
¸t
);

692 
	`‰ì_∑ges
(
tfw_és
.
¸t_pg_addr
,Åfw_és.
¸t_pg_‹dî
);

693 
tfw_és_cgf
 &~
TFW_TLS_CFG_F_CERT
;

694 
	}
}

700 
	$tfw_cfg›_és_˚πifiˇã_key
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

702 
r
;

703 *
key_d©a
;

704 
size_t
 
key_size
;

706 
	`âls_pk_öô
(&
tfw_és
.
key
);

708 i‡(
˚
->
©å_n
) {

709 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

710 
cs
->
«me
);

711  -
EINVAL
;

713 i‡(
˚
->
vÆ_n
 != 1) {

714 
	`TFW_ERR_NL
("%s: InvalidÇumber ofárguments: %d\n",

715 
cs
->
«me
, ()
˚
->
vÆ_n
);

716  -
EINVAL
;

719 
key_d©a
 = 
	`tfw_cfg_ªad_fûe
((c⁄° *)
˚
->
vÆs
[0], &
key_size
);

720 i‡(!
key_d©a
) {

721 
	`TFW_ERR_NL
("%s: Can'tÑead certificate file '%s'\n",

722 
˚
->
«me
, (c⁄° *)˚->
vÆs
[0]);

723  -
EINVAL
;

726 
r
 = 
	`âls_pk_∑r£_key
(&
tfw_és
.
key
, (*)
key_d©a
,

727 
key_size
);

729 
	`‰ì_∑ges
(()
key_d©a
, 
	`gë_‹dî
(
key_size
));

730 i‡(
r
) {

731 
	`TFW_ERR_NL
("%s: InvalidÖrivate key specified (%x)\n",

732 
cs
->
«me
, -
r
);

733  -
EINVAL
;

735 
tfw_és_cgf
 |
TFW_TLS_CFG_F_CKEY
;

738 
	}
}

741 
	$tfw_cfg›_˛ónup_és_˚πifiˇã_key
(
TfwCfgS≥c
 *
cs
)

743 
	`âls_pk_‰ì
(&
tfw_és
.
key
);

744 
tfw_és_cgf
 &~
TFW_TLS_CFG_F_CKEY
;

745 
	}
}

748 
	$tfw_és_cfgíd
()

750 i‡(!(
tfw_és_cgf
 & 
TFW_TLS_CFG_F_REQUIRED
)) {

751 i‡(
tfw_és_cgf
)

752 
	`TFW_WARN_NL
("TLS:Ço HTTPSÜistener,"

756 i‡(!(
tfw_és_cgf
 & 
TFW_TLS_CFG_F_CERT
)) {

757 
	`TFW_ERR_NL
("TLS:Ölease specifyá certificate with"

759  -
EINVAL
;

761 i‡(!(
tfw_és_cgf
 & 
TFW_TLS_CFG_F_CKEY
)) {

762 
	`TFW_ERR_NL
("TLS:Ölease specifyá certificate key with"

764  -
EINVAL
;

768 
	}
}

770 
TfwCfgS≥c
 
	gtfw_és_•ecs
[] = {

772 .
«me
 = "tls_certificate",

773 .
	gdeÊt
 = 
NULL
,

774 .
	gh™dÀr
 = 
tfw_cfg›_és_˚πifiˇã
,

775 .
	gÆlow_n⁄e
 = 
åue
,

776 .
	gÆlow_ª≥©
 = 
Ál£
,

777 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_és_˚πifiˇã
,

780 .
	g«me
 = "tls_certificate_key",

781 .
	gdeÊt
 = 
NULL
,

782 .
	gh™dÀr
 = 
tfw_cfg›_és_˚πifiˇã_key
,

783 .
	gÆlow_n⁄e
 = 
åue
,

784 .
	gÆlow_ª≥©
 = 
Ál£
,

785 .
	g˛ónup
 = 
tfw_cfg›_˛ónup_és_˚πifiˇã_key
,

790 
TfwMod
 
	gtfw_és_mod
 = {

791 .
«me
 = "tls",

792 .
	gcfgíd
 = 
tfw_és_cfgíd
,

793 .
	g°¨t
 = 
tfw_és_°¨t
,

794 .
	g•ecs
 = 
tfw_és_•ecs
,

802 
__öô


803 
	$tfw_és_öô
()

805 
r
;

807 
r
 = 
	`tfw_és_do_öô
();

808 i‡(
r
)

809  -
EINVAL
;

811 
	`âls_ªgi°î_bio
(
tfw_és_£nd
);

813 
r
 = 
	`tfw_gfsm_ªgi°î_fsm
(
TFW_FSM_TLS
, 
tfw_és_msg_¥o˚ss
);

814 i‡(
r
) {

815 
	`tfw_és_do_˛ónup
();

816  -
EINVAL
;

819 
	`tfw_c⁄√˘i⁄_hooks_ªgi°î
(&
és_c⁄n_hooks
, 
TFW_FSM_TLS
);

820 
	`tfw_mod_ªgi°î
(&
tfw_és_mod
);

823 
	}
}

826 
	$tfw_és_exô
()

828 
	`tfw_mod_uƒegi°î
(&
tfw_és_mod
);

829 
	`tfw_c⁄√˘i⁄_hooks_uƒegi°î
(
TFW_FSM_TLS
);

830 
	`tfw_gfsm_uƒegi°î_fsm
(
TFW_FSM_TLS
);

831 
	`tfw_és_do_˛ónup
();

832 
	}
}

	@tls.h

20 #i‚de‡
__TFW_TLS_H__


21 
	#__TFW_TLS_H__


	)

23 
	~"gfsm.h
"

24 
	~"âls.h
"

26 
	#TFW_FSM_TLS
 
TFW_FSM_HTTPS


	)

31 
	#TFW_GFSM_TLS_STATE
(
s
Ë((
TFW_FSM_TLS
 << 
TFW_GFSM_FSM_SHIFT
Ë| (s))

	)

34 
	mTFW_TLS_FSM_INIT
 = 
TFW_GFSM_TLS_STATE
(0),

36 
	mTFW_TLS_FSM_DATA_READY
 = 
TFW_GFSM_TLS_STATE
(1),

38 
	mTFW_TLS_FSM_DONE
 = 
TFW_GFSM_TLS_STATE
(
TFW_GFSM_STATE_LAST
)

41 
tfw_és_cfg_ªquúe
();

42 
tfw_és_í¸y±
(
sock
 *
sk
, 
sk_buff
 *
skb
, 
limô
);

	@vhost.c

20 
	~"ãm≥°a_fw.h
"

21 
	~"hâp.h
"

22 
	~"hâp_m©ch.h
"

23 
	~"hâp_msg.h
"

24 
	~"vho°.h
"

25 
	~"°r.h
"

26 
	~"hâp_limôs.h
"

39 
li°_hód
 
	mhód
;

40 
TfwVho°
 *
	mvho°_dÊt
;

41 
boﬁ
 
	mex∂_dÊt
;

42 } 
	tTfwVho°Li°
;

45 c⁄° 
TfwCfgEnum
 
	gtfw_m©ch_íum
[] = {

46 { "*", 
TFW_HTTP_MATCH_O_WILDCARD
 },

47 { "eq", 
TFW_HTTP_MATCH_O_EQ
 },

48 { "¥efix", 
TFW_HTTP_MATCH_O_PREFIX
 },

49 { "suffix", 
TFW_HTTP_MATCH_O_SUFFIX
 },

54 c⁄° 
TfwCfgEnum
 
	gtfw_mëhod_íum
[] = {

55 { "*", 
UINT_MAX
 },

56 { "COPY", 1 << 
TFW_HTTP_METH_COPY
 },

57 { "DELETE", 1 << 
TFW_HTTP_METH_DELETE
 },

58 { "GET", 1 << 
TFW_HTTP_METH_GET
 },

59 { "HEAD", 1 << 
TFW_HTTP_METH_HEAD
 },

60 { "LOCK", 1 << 
TFW_HTTP_METH_LOCK
 },

61 { "MKCOL", 1 << 
TFW_HTTP_METH_MKCOL
 },

62 { "MOVE", 1 << 
TFW_HTTP_METH_MOVE
 },

63 { "OPTIONS", 1 << 
TFW_HTTP_METH_OPTIONS
 },

64 { "PATCH", 1 << 
TFW_HTTP_METH_PATCH
 },

65 { "POST", 1 << 
TFW_HTTP_METH_POST
 },

66 { "PROPFIND", 1 << 
TFW_HTTP_METH_PROPFIND
 },

67 { "PROPPATCH", 1 << 
TFW_HTTP_METH_PROPPATCH
 },

68 { "PUT", 1 << 
TFW_HTTP_METH_PUT
 },

69 { "TRACE", 1 << 
TFW_HTTP_METH_TRACE
 },

70 { "UNLOCK", 1 << 
TFW_HTTP_METH_UNLOCK
, },

71 { "PURGE", 1 << 
TFW_HTTP_METH_PURGE
 },

72 { "unknown", 1 << 
_TFW_HTTP_METH_UNKNOWN
 },

81 
	#TFW_CAPOLICY_ARRAY_SZ
 (64)

	)

89 
	#TFW_NIPDEF_ARRAY_SZ
 (64)

	)

92 
	#TFW_USRHDRS_ARRAY_SZ
 (64)

	)

98 
	#TFW_LOCATION_ARRAY_SZ
 (64)

	)

106 
	#TFW_CAPUACL_ARRAY_SZ
 (32)

	)

108 
TfwAddr
 
	gtfw_ˇpua˛_dÊt
[
TFW_CAPUACL_ARRAY_SZ
];

117 c⁄° 
	gs_hdr_vü_dÊt
[] =

118 "ãm≥°a_fw" " (" 
TFW_NAME
 " " 
TFW_VERSION
 ")";

125 
boﬁ


126 
	$__tfw_m©ch_wûdˇrd
(
tfw_m©ch_t
 
›
, c⁄° *
c°r
, 
size_t
 
Àn
, 
TfwSå
 *
¨g
)

128  ((
›
 =
TFW_HTTP_MATCH_O_WILDCARD
)

129 && (
Àn
 =1Ë&& (*
c°r
 == '*'));

130 
	}
}

132 
boﬁ


133 
	$__tfw_m©ch_suffix
(
tfw_m©ch_t
 
›
, c⁄° *
c°r
, 
size_t
 
Àn
, 
TfwSå
 *
¨g
)

135 
tfw_°r_eq_Êags_t
 
Êags
 = 
TFW_STR_EQ_DEFAULT
 | 
TFW_STR_EQ_CASEI
;

136  
	`tfw_°r_eq_c°r_off
(
¨g
,árg->
Àn
 -Üí, 
c°r
,Üí, 
Êags
);

137 
	}
}

139 
boﬁ


140 
	$__tfw_m©ch_eq
(
tfw_m©ch_t
 
›
, c⁄° *
c°r
, 
size_t
 
Àn
, 
TfwSå
 *
¨g
)

142 
tfw_°r_eq_Êags_t
 
Êags
 = 
TFW_STR_EQ_DEFAULT
 | 
TFW_STR_EQ_CASEI
;

143  
	`tfw_°r_eq_c°r
(
¨g
, 
c°r
, 
Àn
, 
Êags
);

144 
	}
}

146 
boﬁ


147 
	$__tfw_m©ch_¥efix
(
tfw_m©ch_t
 
›
, c⁄° *
c°r
, 
size_t
 
Àn
, 
TfwSå
 *
¨g
)

149 
tfw_°r_eq_Êags_t
 
Êags
 = 
TFW_STR_EQ_PREFIX
 | 
TFW_STR_EQ_CASEI
;

150  
	`tfw_°r_eq_c°r
(
¨g
, 
c°r
, 
Àn
, 
Êags
);

151 
	}
}

153 
	$boﬁ
 (*
	t__tfw_m©ch_‚
)(
	ttfw_m©ch_t
, c⁄° *, 
	tsize_t
, 
	tTfwSå
 *);

155 c⁄° 
__tfw_m©ch_‚
 
__tfw_m©ch_‚_tbl
[] = {

156 [0 ... 
_TFW_HTTP_MATCH_O_COUNT
] = 
NULL
,

157 [
TFW_HTTP_MATCH_O_WILDCARD
] = 
__tfw_m©ch_wûdˇrd
,

158 [
TFW_HTTP_MATCH_O_EQ
] = 
__tfw_m©ch_eq
,

159 [
TFW_HTTP_MATCH_O_PREFIX
] = 
__tfw_m©ch_¥efix
,

160 [
TFW_HTTP_MATCH_O_SUFFIX
] = 
__tfw_m©ch_suffix
,

161 
	}
};

169 
ölöe
 
boﬁ


170 
	$__tfw_nùdef_m©ch_‚
(
TfwNùDef
 *
nùdef
, 
TfwSå
 *
¨g
)

172 
__tfw_m©ch_‚
 
m©ch_‚
 = 
__tfw_m©ch_‚_tbl
[
nùdef
->
›
];

173 
	`BUG_ON
(!
m©ch_‚
);

175  
	`m©ch_‚
(
nùdef
->
›
,Çùdef->
¨g
,Çùdef->
Àn
,árg);

176 
	}
}

178 
TfwNùDef
 *

179 
	$tfw_nùdef_m©ch
(
TfwLoˇti⁄
 *
loc
, 
mëhod
, 
TfwSå
 *
¨g
)

181 
size_t
 
i
;

183 
	`BUG_ON
(!
loc
);

184 
	`BUG_ON
(!
¨g
);

186 
i
 = 0; i < 
loc
->
nùdef_sz
; ++i) {

187 
TfwNùDef
 *
nùdef
 = 
loc
->nùdef[
i
];

188 i‡((
nùdef
->
mëhod
 & (1 << method))

189 && 
	`__tfw_nùdef_m©ch_‚
(
nùdef
, 
¨g
))

190  
nùdef
;

192  
NULL
;

193 
	}
}

201 
ölöe
 
boﬁ


202 
	$__tfw_ˇpﬁicy_m©ch_‚
(
TfwCaPﬁicy
 *
ˇpo
, 
TfwSå
 *
¨g
)

204 
__tfw_m©ch_‚
 
m©ch_‚
 = 
__tfw_m©ch_‚_tbl
[
ˇpo
->
›
];

205 
	`BUG_ON
(!
m©ch_‚
);

207  
	`m©ch_‚
(
ˇpo
->
›
, c≠o->
¨g
, c≠o->
Àn
,árg);

208 
	}
}

210 
TfwCaPﬁicy
 *

211 
	$tfw_ˇpﬁicy_m©ch
(
TfwLoˇti⁄
 *
loc
, 
TfwSå
 *
¨g
)

213 
size_t
 
i
;

215 
	`BUG_ON
(!
loc
);

216 
	`BUG_ON
(!
¨g
);

218 
i
 = 0; i < 
loc
->
ˇpo_sz
; ++i) {

219 
TfwCaPﬁicy
 *
ˇpo
 = 
loc
->ˇpo[
i
];

220 i‡(
	`__tfw_ˇpﬁicy_m©ch_‚
(
ˇpo
, 
¨g
))

221  
ˇpo
;

223  
NULL
;

224 
	}
}

231 
ölöe
 
boﬁ


232 
	$__tfw_loˇti⁄_m©ch
(
TfwLoˇti⁄
 *
loc
, 
TfwSå
 *
¨g
)

234 
__tfw_m©ch_‚
 
m©ch_‚
 = 
__tfw_m©ch_‚_tbl
[
loc
->
›
];

235 
	`BUG_ON
(!
m©ch_‚
);

237  
	`m©ch_‚
(
loc
->
›
,Üoc->
¨g
,Üoc->
Àn
,árg);

238 
	}
}

240 
TfwLoˇti⁄
 *

241 
	$tfw_loˇti⁄_m©ch
(
TfwVho°
 *
vho°
, 
TfwSå
 *
¨g
)

243 
size_t
 
i
;

245 
	`BUG_ON
(!
vho°
);

246 
	`BUG_ON
(!
¨g
);

248 
i
 = 0; i < 
vho°
->
loc_sz
; ++i) {

249 
TfwLoˇti⁄
 *
loc
 = &
vho°
->loc[
i
];

250 i‡(
	`__tfw_loˇti⁄_m©ch
(
loc
, 
¨g
))

251  
loc
;

254  
NULL
;

255 
	}
}

263 
ölöe
 
TfwLoˇti⁄
 *

264 
	$tfw_vho°_a˘_loˇti⁄
(
TfwHâpReq
 *
ªq
)

266 
TfwLoˇti⁄
 *
loc
 = 
ªq
->
loˇti⁄
;

267 
TfwVho°
 *
vho°
 = 
ªq
->vhost;

269 
	`BUG_ON
(!
vho°
);

270 i‡(
loc
 &&Üoc->
maö_sg
)

271  
loc
;

273  
vho°
->
loc_dÊt
;

274 
	}
}

280 
TfwSrvC⁄n
 *

281 
	$tfw_vho°_gë_§v_c⁄n
(
TfwMsg
 *
msg
)

283 
TfwLoˇti⁄
 *
loc
;

284 
TfwSrvGroup
 *
maö_sg
, *
backup_sg
;

285 
TfwHâpReq
 *
ªq
 = (TfwHâpReq *)
msg
;

286 
TfwSrvC⁄n
 *
§v_c⁄n
 = 
NULL
;

288 
loc
 = 
	`tfw_vho°_a˘_loˇti⁄
(
ªq
);

289 
maö_sg
 = 
loc
->main_sg;

290 
backup_sg
 = 
loc
->backup_sg;

292 
	`BUG_ON
(!
maö_sg
);

293 
	`TFW_DBG2
("vho°: u£ sîvî group: '%s'\n", 
maö_sg
->
«me
);

295 i‡(
	`likñy
(
maö_sg
->
sched
))

296 
§v_c⁄n
 = 
maö_sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, main_sg);

298 i‡(
	`u∆ikñy
(!
§v_c⁄n
 && 
backup_sg
 && backup_sg->
sched
)) {

299 
	`TFW_DBG
("vhost:Åhe main group is offline, use backup: '%s'\n",

300 
backup_sg
->
«me
);

301 
§v_c⁄n
 = 
backup_sg
->
sched
->
	`sched_sg_c⁄n
(
msg
, backup_sg);

304 i‡(
	`u∆ikñy
(!
§v_c⁄n
))

305 
	`TFW_DBG2
("vhost: UnableÅo select server from group '%s'\n",

306 
backup_sg
 ? backup_sg->
«me
 : 
maö_sg
->name);

308  
§v_c⁄n
;

309 
	}
}

319 
TfwHdrMods
*

320 
	$tfw_vho°_gë_hdr_mods
(
TfwLoˇti⁄
 *
loc
, 
TfwVho°
 *
vho°
, 
mod_ty≥
)

322 
TfwVho°
 *
vh_dÊt
 = 
vho°
->
vho°_dÊt
;

325 i‡(!
loc
 || !loc->
mod_hdrs
[
mod_ty≥
].
sz
)

326 
loc
 = 
vho°
->
loc_dÊt
;

327 i‡(!
loc
 || !loc->
mod_hdrs
[
mod_ty≥
].
sz
)

328 
loc
 = 
vh_dÊt
 ? vh_dÊt->
loc_dÊt
 : 
NULL
;

329 i‡(!
loc
)

330  
NULL
;

332  &
loc
->
mod_hdrs
[
mod_ty≥
];

333 
	}
}

343 
TfwLoˇti⁄
 *
	gtfwcfg_this_loˇti⁄
;

345 
TfwVho°
 *
	gtfw_vho°_íåy
;

347 
TfwVho°Li°
 *
	gtfw_vho°s
;

349 
TfwVho°Li°
 *
	gtfw_vho°s_ªc⁄fig
;

351 
TfwGlobÆ
 
	gtfw_globÆ
 = {

352 .
hdr_vü
 = 
s_hdr_vü_dÊt
,

353 .
	ghdr_vü_Àn
 = (
s_hdr_vü_dÊt
) - 1,

354 .
	gˇpua˛
 = 
tfw_ˇpua˛_dÊt
,

361 
TfwVho°
 *

362 
	$tfw_vho°_lookup
(c⁄° *
«me
)

364 
TfwVho°
 *
vho°
;

366 
	`li°_f‹_óch_íåy
(
vho°
, &
tfw_vho°s_ªc⁄fig
->
hód
, 
li°
) {

367 i‡(!
	`°rˇ£cmp
(
vho°
->
«me
,Çame)) {

368 
	`tfw_vho°_gë
(
vho°
);

369  
vho°
;

372  
NULL
;

373 
	}
}

375 
TfwGlobÆ
 *

376 
	$tfw_vho°_gë_globÆ
()

378  &
tfw_globÆ
;

379 
	}
}

381 
ölöe
 
boﬁ


382 
	$tfw_vho°_deÁu…
(
TfwVho°
 *
vho°
)

384  
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
 =
vho°
;

385 
	}
}

394 
boﬁ


395 
	$tfw_ˇpua˛_m©ch
(
TfwAddr
 *
addr
)

397 
size_t
 
i
;

398 
ö6_addr
 *
öaddr
 = &
addr
->
v6
.
sö6_addr
;

400 
i
 = 0; i < 
tfw_globÆ
.
ˇpua˛_sz
; ++i) {

401 
TfwAddr
 *
a˛_addr
 = &
tfw_globÆ
.
ˇpua˛
[
i
];

402 i‡(
	`ùv6_¥efix_equÆ
(
öaddr
, &
a˛_addr
->
v6
.
sö6_addr
,

403 
a˛_addr
->
ö6_¥efix
))

404  
åue
;

406  
Ál£
;

407 
	}
}

415 
TfwNùDef
 *

416 
	$tfw_nùdef_lookup
(
TfwLoˇti⁄
 *
loc
, 
›
, c⁄° *
¨g
, 
size_t
 
Àn
)

418 
TfwNùDef
 *
nùdef
;

420 i‡(!
loc
->
nùdef_sz
)

421  
NULL
;

423 
nùdef
 = 
loc
->nùdef[loc->
nùdef_sz
 - 1];

424 i‡((
nùdef
->
›
 =›Ë&& (nùdef->
Àn
 ==Üen)

425 && !
	`°rˇ£cmp
(
nùdef
->
¨g
,árg))

426  
nùdef
;

428  
NULL
;

429 
	}
}

431 
TfwNùDef
 *

432 
	$tfw_nùdef_lookup_dup
(
TfwLoˇti⁄
 *
loc
, 
mëhod
,

433 
›
, c⁄° *
¨g
, 
size_t
 
Àn
)

435 
size_t
 
i
;

436 
TfwNùDef
 *
nùdef
;

438 i‡(!
loc
->
nùdef_sz
)

439  
NULL
;

442 
i
 = 0; i < 
loc
->
nùdef_sz
 - 1; ++i) {

443 
nùdef
 = 
loc
->nùdef[
i
];

444 i‡((
nùdef
->
›
 =›Ë&& (nùdef->
Àn
 ==Üen)

445 && !
	`°rˇ£cmp
(
nùdef
->
¨g
,árg))

446  
nùdef
;

449 
nùdef
 = 
loc
->nùdef[
i
];

450 i‡((
nùdef
->
mëhod
 & mëhodË&& (nùdef->
›
 == op)

451 && (
nùdef
->
Àn
 =ÀnË&& !
	`°rˇ£cmp
“ùdef->
¨g
,árg))

452  
nùdef
;

454  
NULL
;

455 
	}
}

462 
TfwNùDef
 *

463 
	$tfw_nùdef_add√w
(
TfwLoˇti⁄
 *
loc
, 
mëhod
,

464 
›
, c⁄° *
¨g
, 
size_t
 
Àn
)

466 *
d©a
;

467 
TfwNùDef
 *
nùdef
;

469 i‡(
loc
->
nùdef_sz
 =
TFW_NIPDEF_ARRAY_SZ
)

470  
NULL
;

472 i‡((
d©a
 = 
	`kmÆloc
((
TfwNùDef
Ë+ 
Àn
 + 1, 
GFP_KERNEL
)Ë=
NULL
)

473  
NULL
;

475 
nùdef
 = (
TfwNùDef
 *)
d©a
;

476 
nùdef
->
mëhod
 = method;

477 
nùdef
->
›
 = op;

478 
nùdef
->
¨g
 = 
d©a
 + (
TfwNùDef
);

479 
nùdef
->
Àn
 =Üen;

480 
	`mem˝y
((*)
nùdef
->
¨g
, (*Ôrg, 
Àn
 + 1);

482 
loc
->
nùdef
[loc->
nùdef_sz
++] =Çipdef;

484  
nùdef
;

485 
	}
}

488 
	$tfw_cfg›_n⁄idempŸít
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
TfwLoˇti⁄
 *
loc
)

490 
size_t
 
Àn
;

491 
ªt
, 
mëhod
, 
›
;

492 c⁄° *
ö_mëhod
, *
ö_›
, *
¨g
;

493 
TfwNùDef
 *
nùdef
;

494 
TfwVho°
 *
vh_dÊt
;

496 
	`BUILD_BUG_ON
((
tfw_mëhod_íum
[0].
vÆue
Ë* 
BITS_PER_BYTE


497 < 
_TFW_HTTP_METH_COUNT
);

499 i‡(
˚
->
©å_n
) {

500 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

501 
cs
->
«me
);

502  -
EINVAL
;

504 i‡(
˚
->
vÆ_n
 != 3) {

505 
	`TFW_ERR_NL
("%s: InvÆidÇumbî o‡¨gumíts.\n", 
cs
->
«me
);

506  -
EINVAL
;

510 
ö_mëhod
 = 
˚
->
vÆs
[0];

511 
ªt
 = 
	`tfw_cfg_m≠_íum
(
tfw_mëhod_íum
, 
ö_mëhod
, &
mëhod
);

512 i‡(
ªt
) {

513 
	`TFW_ERR_NL
("Unsupported HTTP method: '%s %s'\n",

514 
cs
->
«me
, 
ö_mëhod
);

515  -
EINVAL
;

519 
ö_›
 = 
˚
->
vÆs
[1];

520 
ªt
 = 
	`tfw_cfg_m≠_íum
(
tfw_m©ch_íum
, 
ö_›
, &
›
);

521 i‡(
ªt
) {

522 
	`TFW_ERR_NL
("Unsuµ‹ãd m©ch OP: '%†%s'\n", 
cs
->
«me
, 
ö_›
);

523  -
EINVAL
;

527 
¨g
 = 
˚
->
vÆs
[2];

528 
Àn
 = 
	`°æí
(
¨g
);

534 
vh_dÊt
 = 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
;

535 i‡(
	`tfw_nùdef_lookup_dup
(
loc
, 
mëhod
, 
›
, 
¨g
, 
Àn
))

536 
	`TFW_WARN_NL
("%s: DuplicateÉntry inÜocation '%s': "

537 "'%†%†%†%s'\n", 
cs
->
«me
,

538 
loc
 =
vh_dÊt
->
loc_dÊt
 ? "deÁu…" :Üoc->
¨g
,

539 
cs
->
«me
, 
ö_mëhod
, 
ö_›
, 
¨g
);

546 
nùdef
 = 
	`tfw_nùdef_lookup
(
loc
, 
›
, 
¨g
, 
Àn
);

547 i‡(
nùdef
) {

548 
nùdef
->
mëhod
 |= method;

550 
nùdef
 = 
	`tfw_nùdef_add√w
(
loc
, 
mëhod
, 
›
, 
¨g
, 
Àn
);

551 i‡(
nùdef
 =
NULL
)

552  -
ENOMEM
;

556 
	}
}

559 
	$tfw_cfg›_loc_n⁄idempŸít
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

561 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

562  
	`tfw_cfg›_n⁄idempŸít
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
);

563 
	}
}

566 
	$tfw_cfg›_ö_n⁄idempŸít
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

568 
	`BUG_ON
(!
tfw_vho°_íåy
);

569  
	`tfw_cfg›_n⁄idempŸít
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
);

570 
	}
}

573 
	$tfw_cfg›_out_n⁄idempŸít
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

575 
TfwVho°
 *
vh_dÊt
 = 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
;

576  
	`tfw_cfg›_n⁄idempŸít
(
cs
, 
˚
, 
vh_dÊt
->
loc_dÊt
);

577 
	}
}

580 
	$tfw_cfg›_mod_hdr_add
(
TfwLoˇti⁄
 *
loc
, c⁄° *
«me
, c⁄° *
vÆue
,

581 
mod_ty≥
, 
boﬁ
 
≠≥nd
)

583 
TfwSå
 *
hdr
;

584 
TfwHdrMods
 *
h_mods
 = &
loc
->
mod_hdrs
[
mod_ty≥
];

585 
TfwHdrModsDesc
 *
desc
 = &
h_mods
->
hdrs
[h_mods->
sz
];

587 i‡(
h_mods
->
sz
 =
TFW_USRHDRS_ARRAY_SZ
) {

588 
	`TFW_WARN_NL
("TooÜot of custom headers, %d supported.\n",

589 
TFW_USRHDRS_ARRAY_SZ
);

590  -
EINVAL
;

592 i‡(!(
hdr
 = 
	`tfw_hâp_msg_make_hdr
(
loc
->
hdrs_poﬁ
, 
«me
, 
vÆue
))) {

593 
	`TFW_WARN_NL
("Can't create header.\n");

594  -
ENOMEM
;

596 
desc
->
hdr
 = hdr;

597 
desc
->
≠≥nd
 =áppend;

598 
desc
->
hid
 = (
mod_ty≥
 =
TFW_VHOST_HDRMOD_RESP
)

599 ? 
	`tfw_hâp_msg_ª•_•ec_hid
(
hdr
)

600 : 
	`tfw_hâp_msg_ªq_•ec_hid
(
hdr
);

601 ++
h_mods
->
sz
;

604 
	}
}

613 
	$tfw_cfg›_mod_hdr
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
TfwLoˇti⁄
 *
loc
,

614 
mod_ty≥
, 
boﬁ
 
≠≥nd
)

616 c⁄° *
«me
;

617 c⁄° *
vÆue
 = 
NULL
;

619 i‡(
˚
->
©å_n
) {

620 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

621 
cs
->
«me
);

622  -
EINVAL
;

624 
˚
->
vÆ_n
)

629 i‡(!
≠≥nd
)

633 
	`TFW_ERR_NL
("%s: InvÆidÇumbî o‡vÆues.\n", 
cs
->
«me
);

634  -
EINVAL
;

637 
«me
 = 
˚
->
vÆs
[0];

638 i‡(
˚
->
vÆ_n
 == 2)

639 
vÆue
 = 
˚
->
vÆs
[1];

641  
	`tfw_cfg›_mod_hdr_add
(
loc
, 
«me
, 
vÆue
, 
mod_ty≥
, 
≠≥nd
);

642 
	}
}

645 
	$tfw_cfg›_loc_ªq_hdr_add
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

647 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

648  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
,

649 
TFW_VHOST_HDRMOD_REQ
, 
åue
);

650 
	}
}

653 
	$tfw_cfg›_loc_ªq_hdr_£t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

655 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

656  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
,

657 
TFW_VHOST_HDRMOD_REQ
, 
Ál£
);

658 
	}
}

661 
	$tfw_cfg›_ö_ªq_hdr_add
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

663 
	`BUG_ON
(!
tfw_vho°_íåy
);

664  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
,

665 
TFW_VHOST_HDRMOD_REQ
, 
åue
);

666 
	}
}

669 
	$tfw_cfg›_ö_ªq_hdr_£t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

671 
	`BUG_ON
(!
tfw_vho°_íåy
);

672  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
,

673 
TFW_VHOST_HDRMOD_REQ
, 
Ál£
);

674 
	}
}

677 
	$tfw_cfg›_out_ªq_hdr_add
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

679  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
,

680 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
->
loc_dÊt
,

681 
TFW_VHOST_HDRMOD_REQ
, 
åue
);

682 
	}
}

685 
	$tfw_cfg›_out_ªq_hdr_£t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

687  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
,

688 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
->
loc_dÊt
,

689 
TFW_VHOST_HDRMOD_REQ
, 
Ál£
);

690 
	}
}

693 
	$tfw_cfg›_loc_ª•_hdr_add
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

695 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

696  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
,

697 
TFW_VHOST_HDRMOD_RESP
, 
åue
);

698 
	}
}

701 
	$tfw_cfg›_loc_ª•_hdr_£t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

703 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

704  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
,

705 
TFW_VHOST_HDRMOD_RESP
, 
Ál£
);

706 
	}
}

709 
	$tfw_cfg›_ö_ª•_hdr_add
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

711 
	`BUG_ON
(!
tfw_vho°_íåy
);

712  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
,

713 
TFW_VHOST_HDRMOD_RESP
, 
åue
);

714 
	}
}

717 
	$tfw_cfg›_ö_ª•_hdr_£t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

719 
	`BUG_ON
(!
tfw_vho°_íåy
);

720  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
,

721 
TFW_VHOST_HDRMOD_RESP
, 
Ál£
);

722 
	}
}

725 
	$tfw_cfg›_out_ª•_hdr_add
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

727  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
,

728 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
->
loc_dÊt
,

729 
TFW_VHOST_HDRMOD_RESP
, 
åue
);

730 
	}
}

733 
	$tfw_cfg›_out_ª•_hdr_£t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

735  
	`tfw_cfg›_mod_hdr
(
cs
, 
˚
,

736 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
->
loc_dÊt
,

737 
TFW_VHOST_HDRMOD_RESP
, 
Ál£
);

738 
	}
}

743 
TfwCaPﬁicy
 *

744 
	$tfw_ˇpﬁicy_lookup
(
TfwLoˇti⁄
 *
loc
, 
cmd
, 
›
, c⁄° *
¨g
,

745 
size_t
 
Àn
)

747 
size_t
 
i
, 
ˇpo_sz
 = 
loc
->capo_sz;

749 
i
 = 0; i < 
ˇpo_sz
; ++i) {

750 
TfwCaPﬁicy
 *
ˇpo
 = 
loc
->ˇpo[
i
];

751 i‡((
ˇpo
->
cmd
 =cmdË&& (ˇpo->
›
 =›Ë&& (ˇpo->
Àn
 ==Üen)

752 && !
	`°∫ˇ£cmp
(
ˇpo
->
¨g
,árg, 
Àn
))

753  
ˇpo
;

756  
NULL
;

757 
	}
}

762 
TfwCaPﬁicy
 *

763 
	$tfw_ˇpﬁicy_√w
(
cmd
, 
›
, c⁄° *
¨g
, 
size_t
 
Àn
)

765 
TfwCaPﬁicy
 *
ˇpo
;

767 i‡((
ˇpo
 = 
	`kmÆloc
((
TfwCaPﬁicy
Ë+ 
Àn
 + 1, 
GFP_KERNEL
)Ë=
NULL
)

768  
NULL
;

770 
ˇpo
->
cmd
 = cmd;

771 
ˇpo
->
›
 = op;

772 
ˇpo
->
¨g
 = (*)(capo + 1);

773 
ˇpo
->
Àn
 =Üen;

774 
	`mem˝y
((*)
ˇpo
->
¨g
, (*Ôrg, 
Àn
 + 1);

776  
ˇpo
;

777 
	}
}

787 
	$tfw_cfg›_ˇpﬁicy
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
TfwLoˇti⁄
 *
loc
, 
cmd
)

789 
ªt
;

790 
size_t
 
i
, 
Àn
;

791 
tfw_m©ch_t
 
›
;

792 c⁄° *
ö_›
, *
¨g
;

794 
	`BUG_ON
((
cmd
 !
TFW_D_CACHE_BYPASS
Ë&& (cmd !
TFW_D_CACHE_FULFILL
));

796 i‡(
˚
->
©å_n
) {

797 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

798 
cs
->
«me
);

799  -
EINVAL
;

801 i‡(
˚
->
vÆ_n
 < 2) {

802 
	`TFW_ERR_NL
("%s: InvalidÇumber ofárguments: %d\n",

803 
cs
->
«me
, ()
˚
->
vÆ_n
);

804  -
EINVAL
;

807 
ö_›
 = 
˚
->
vÆs
[0];

810 
ªt
 = 
	`tfw_cfg_m≠_íum
(
tfw_m©ch_íum
, 
ö_›
, &
›
);

811 i‡(
ªt
) {

812 
	`TFW_ERR_NL
("Unknow¿m©ch OP: '%†%s'\n", 
cs
->
«me
, 
ö_›
);

813  -
EINVAL
;

817 
i
 = 1; i < 
˚
->
vÆ_n
; ++i) {

818 
TfwCaPﬁicy
 *
ˇpo
;

820 
¨g
 = 
˚
->
vÆs
[
i
];

821 
Àn
 = 
	`°æí
(
¨g
);

823 i‡(
	`tfw_ˇpﬁicy_lookup
(
loc
, 
cmd
, 
›
, 
¨g
, 
Àn
)) {

824 
	`TFW_WARN_NL
("%s: DuplicateÉntry: '%s %s %s'\n",

825 
cs
->
«me
, cs->«me, 
ö_›
, 
¨g
);

828 i‡(
loc
->
ˇpo_sz
 =
TFW_CAPOLICY_ARRAY_SZ
)

829  -
ENOMEM
;

830 i‡(!(
ˇpo
 = 
	`tfw_ˇpﬁicy_√w
(
cmd
, 
›
, 
¨g
, 
Àn
)))

831  -
ENOMEM
;

832 
loc
->
ˇpo
[loc->
ˇpo_sz
++] = capo;

836 
	}
}

848 
	$tfw_cfg›_loc_ˇche_fulfûl
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

850 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

851  
	`tfw_cfg›_ˇpﬁicy
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
,

852 
TFW_D_CACHE_FULFILL
);

853 
	}
}

856 
	$tfw_cfg›_loc_ˇche_by∑ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

858 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

859  
	`tfw_cfg›_ˇpﬁicy
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
,

860 
TFW_D_CACHE_BYPASS
);

861 
	}
}

864 
	$tfw_cfg›_ö_ˇche_fulfûl
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

866 
	`BUG_ON
(!
tfw_vho°_íåy
);

867  
	`tfw_cfg›_ˇpﬁicy
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
,

868 
TFW_D_CACHE_FULFILL
);

869 
	}
}

872 
	$tfw_cfg›_ö_ˇche_by∑ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

874 
	`BUG_ON
(!
tfw_vho°_íåy
);

875  
	`tfw_cfg›_ˇpﬁicy
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
,

876 
TFW_D_CACHE_BYPASS
);

877 
	}
}

880 
	$tfw_cfg›_out_ˇche_fulfûl
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

882 
TfwVho°
 *
vh_dÊt
 = 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
;

883  
	`tfw_cfg›_ˇpﬁicy
(
cs
, 
˚
, 
vh_dÊt
->
loc_dÊt
,

884 
TFW_D_CACHE_FULFILL
);

885 
	}
}

888 
	$tfw_cfg›_out_ˇche_by∑ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

890 
TfwVho°
 *
vh_dÊt
 = 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
;

891  
	`tfw_cfg›_ˇpﬁicy
(
cs
, 
˚
, 
vh_dÊt
->
loc_dÊt
,

892 
TFW_D_CACHE_BYPASS
);

893 
	}
}

899 
TfwLoˇti⁄
 *

900 
	$tfw_loˇti⁄_lookup
(
TfwVho°
 *
vho°
, 
tfw_m©ch_t
 
›
, c⁄° *
¨g
, 
size_t
 
Àn
)

902 
size_t
 
i
;

904 
i
 = 0; i < 
vho°
->
loc_sz
; ++i) {

905 
TfwLoˇti⁄
 *
loc
 = &
vho°
->loc[
i
];

906 i‡((
loc
->
›
 =›Ë&& (loc->
Àn
 ==Üen)

907 && !
	`°∫ˇ£cmp
(
loc
->
¨g
,árg, 
Àn
))

908  
loc
;

911  
NULL
;

912 
	}
}

915 
	$tfw_loˇti⁄_öô
(
TfwLoˇti⁄
 *
loc
, 
tfw_m©ch_t
 
›
, c⁄° *
¨g
,

916 
size_t
 
Àn
, 
TfwPoﬁ
 *
poﬁ
)

918 *
¨gmem
, *
d©a
;

919 
size_t
 
size
 = (
FøngCfg
)

920 + (
TfwCaPﬁicy
 *Ë* 
TFW_CAPOLICY_ARRAY_SZ


921 + (
TfwNùDef
 *Ë* 
TFW_NIPDEF_ARRAY_SZ


922 + (
TfwHdrModsDesc
Ë* 
TFW_USRHDRS_ARRAY_SZ
 * 2;

924 i‡((
¨gmem
 = 
	`kmÆloc
(
Àn
 + 1, 
GFP_KERNEL
)Ë=
NULL
)

925  -
ENOMEM
;

926 i‡((
d©a
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
)Ë=
NULL
) {

927 
	`k‰ì
(
¨gmem
);

928  -
ENOMEM
;

931 
loc
->
›
 = op;

932 
loc
->
¨g
 = 
¨gmem
;

933 
loc
->
Àn
 =Üen;

934 
loc
->
‰™g_cfg
 = (
FøngCfg
 *)
d©a
;

935 
loc
->
ˇpo
 = (
TfwCaPﬁicy
 **)÷oc->
‰™g_cfg
 + 1);

936 
loc
->
ˇpo_sz
 = 0;

937 
loc
->
nùdef
 = (
TfwNùDef
 **)÷oc->
ˇpo
 + 
TFW_CAPOLICY_ARRAY_SZ
);

938 
loc
->
nùdef_sz
 = 0;

939 
loc
->
hdrs_poﬁ
 = 
poﬁ
;

940 
loc
->
mod_hdrs
[
TFW_VHOST_HDRMOD_REQ
].
hdrs
 =

941 (
TfwHdrModsDesc
 *)(
loc
->
nùdef
 + 
TFW_NIPDEF_ARRAY_SZ
);

942 
loc
->
mod_hdrs
[
TFW_VHOST_HDRMOD_RESP
].
hdrs
 =

943 
loc
->
mod_hdrs
[
TFW_VHOST_HDRMOD_REQ
].
hdrs
 + 
TFW_USRHDRS_ARRAY_SZ
;

944 
	`mem˝y
((*)
loc
->
¨g
, (*Ôrg, 
Àn
 + 1);

947 
	}
}

954 
ölöe
 
TfwLoˇti⁄
 *

955 
	$tfw_loˇti⁄_√w
(
TfwVho°
 *
vho°
, 
tfw_m©ch_t
 
›
, c⁄° *
¨g
, 
size_t
 
Àn
)

957 
TfwLoˇti⁄
 *
loc
;

959 
loc
 = &
vho°
->loc[vho°->
loc_sz
];

960 i‡(
	`tfw_loˇti⁄_öô
(
loc
, 
›
, 
¨g
, 
Àn
, 
vho°
->
hdrs_poﬁ
))

961  
NULL
;

962 
vho°
->
loc_sz
++;

963  
loc
;

964 
	}
}

971 
	$tfw_cfg›_loˇti⁄_begö
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
TfwVho°
 *
vho°
)

973 
ªt
;

974 
size_t
 
Àn
;

975 
tfw_m©ch_t
 
›
;

976 c⁄° *
ö_›
, *
¨g
;

978 i‡(
˚
->
©å_n
) {

979 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

980 
cs
->
«me
);

981  -
EINVAL
;

983 i‡(
˚
->
vÆ_n
 != 2) {

984 
	`TFW_ERR_NL
("%s: InvalidÇumber ofárguments: %d\n",

985 
cs
->
«me
, ()
˚
->
vÆ_n
);

986  -
EINVAL
;

990 
ö_›
 = 
˚
->
vÆs
[0];

991 
¨g
 = 
˚
->
vÆs
[1];

992 
Àn
 = 
	`°æí
(
¨g
);

995 
ªt
 = 
	`tfw_cfg_m≠_íum
(
tfw_m©ch_íum
, 
ö_›
, &
›
);

996 i‡(
ªt
) {

997 
	`TFW_ERR_NL
("%s: Unknown match OP: '%s %s %s'\n",

998 
cs
->
«me
, cs->«me, 
ö_›
, 
¨g
);

999  -
EINVAL
;

1003 i‡(
	`tfw_loˇti⁄_lookup
(
vho°
, 
›
, 
¨g
, 
Àn
)) {

1004 
	`TFW_ERR_NL
("%s: DuplicateÉntry: '%s %s %s'\n",

1005 
cs
->
«me
, cs->«me, 
ö_›
, 
¨g
);

1006  -
EINVAL
;

1010 i‡(
vho°
->
loc_sz
 =
TFW_LOCATION_ARRAY_SZ
) {

1011 
	`TFW_ERR_NL
("%s: There isÇoÉmpty slots in '%s' vhostÅo"

1012 "áddÇewÜoˇti⁄: '%†%†%s'\n", 
cs
->
«me
,

1013 
vho°
->
«me
, 
cs
->«me, 
ö_›
, 
¨g
);

1014  -
EINVAL
;

1018 
tfwcfg_this_loˇti⁄
 = 
	`tfw_loˇti⁄_√w
(
vho°
, 
›
, 
¨g
, 
Àn
);

1019 i‡(!
tfwcfg_this_loˇti⁄
) {

1020 
	`TFW_ERR_NL
("%s: UnableÅo createÇewÜocation: '%s %s %s'\n",

1021 
cs
->
«me
, cs->«me, 
ö_›
, 
¨g
);

1022  -
ENOMEM
;

1026 
	}
}

1029 
	$tfw_cfg›_ö_loˇti⁄_begö
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1031 
	`BUG_ON
(!
tfw_vho°_íåy
);

1032 
	`BUG_ON
(
tfwcfg_this_loˇti⁄
);

1033  
	`tfw_cfg›_loˇti⁄_begö
(
cs
, 
˚
, 
tfw_vho°_íåy
);

1034 
	}
}

1037 
	$tfw_cfg›_out_loˇti⁄_begö
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1039 
	`BUG_ON
(
tfw_vho°_íåy
);

1040 
	`BUG_ON
(
tfwcfg_this_loˇti⁄
);

1041  
	`tfw_cfg›_loˇti⁄_begö
(
cs
, 
˚
,

1042 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
);

1043 
	}
}

1049 
	$tfw_cfg›_ö_loˇti⁄_föish
(
TfwCfgS≥c
 *
cs
)

1051 
	`BUG_ON
(!
tfw_vho°_íåy
);

1052 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1053 i‡(!
	`tfw_vho°_deÁu…
(
tfw_vho°_íåy
)

1054 && !
tfwcfg_this_loˇti⁄
->
maö_sg
)

1056 
	`TFW_ERR_NL
("Directive 'proxy_pass' isÇot specified for"

1058 " vho° '%s'.\n", 
tfwcfg_this_loˇti⁄
->
¨g
,

1059 
tfw_vho°_íåy
->
«me
);

1060  -
EINVAL
;

1062 
tfwcfg_this_loˇti⁄
 = 
NULL
;

1064 
	}
}

1070 
	$tfw_cfg›_out_loˇti⁄_föish
(
TfwCfgS≥c
 *
cs
)

1072 
	`BUG_ON
(
tfw_vho°_íåy
);

1073 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1074 
tfwcfg_this_loˇti⁄
 = 
NULL
;

1076 
	}
}

1083 
	$tfw_loˇti⁄_dñ
(
TfwLoˇti⁄
 *
loc
)

1085 
size_t
 
i
;

1087 i‡(
	`u∆ikñy
(!
loc
))

1090 
i
 = 0; i < 
loc
->
ˇpo_sz
; ++i) {

1091 
	`BUG_ON
(!
loc
->
ˇpo
[
i
]);

1092 
	`k‰ì
(
loc
->
ˇpo
[
i
]);

1094 
i
 = 0; i < 
loc
->
nùdef_sz
; ++i) {

1095 
	`BUG_ON
(!
loc
->
nùdef
[
i
]);

1096 
	`k‰ì
(
loc
->
nùdef
[
i
]);

1099 
	`k‰ì
(
loc
->
‰™g_cfg
->
hâp_˘_vÆs
);

1100 
	`k‰ì
(
loc
->
‰™g_cfg
->
hâp_ª•_code_block
);

1106 
	`k‰ì
(
loc
->
¨g
);

1107 
	`k‰ì
(
loc
->
‰™g_cfg
);

1109 
	`tfw_sg_put
(
loc
->
maö_sg
);

1110 
	`tfw_sg_put
(
loc
->
backup_sg
);

1111 
	}
}

1116 
boﬁ


1117 
	$tfw_ˇpua˛_lookup
(
TfwAddr
 *
addr
)

1119 
size_t
 
i
;

1120 
ö6_addr
 *
öaddr
 = &
addr
->
v6
.
sö6_addr
;

1122 
i
 = 0; i < 
tfw_globÆ
.
ˇpua˛_sz
; ++i) {

1123 
ö6_addr
 *
a˛_öaddr
 = &
tfw_globÆ
.
ˇpua˛
[
i
].
v6
.
sö6_addr
;

1124 i‡(
	`ùv6_¥efix_equÆ
(
öaddr
, 
a˛_öaddr
, 
addr
->
ö6_¥efix
))

1125  
åue
;

1127  
Ál£
;

1128 
	}
}

1134 
	$tfw_cfg›_ˇche_purge_a˛
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1136 
size_t
 
i
;

1137 c⁄° *
vÆ
;

1139 i‡(
˚
->
©å_n
) {

1140 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

1141 
cs
->
«me
);

1142  -
EINVAL
;

1145 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
vÆ
) {

1146 
TfwAddr
 
addr
 = { 0 };

1148 i‡(
	`tfw_addr_±⁄_cidr
(
vÆ
, &
addr
)) {

1149 
	`TFW_ERR_NL
("%s: Invalid ACLÉntry: '%s'\n",

1150 
cs
->
«me
, 
vÆ
);

1151  -
EINVAL
;

1154 i‡(
	`tfw_ˇpua˛_lookup
(&
addr
)) {

1155 
	`TFW_ERR_NL
("%s: Duplicate IPáddress orÖrefix: '%s'\n",

1156 
cs
->
«me
, 
vÆ
);

1157  -
EINVAL
;

1160 i‡(
tfw_globÆ
.
ˇpua˛_sz
 =
TFW_CAPUACL_ARRAY_SZ
) {

1161 
	`TFW_ERR_NL
("%s: UnableÅoáddÇew ACL: '%s'\n",

1162 
cs
->
«me
, 
vÆ
);

1163  -
EINVAL
;

1165 
tfw_globÆ
.
ˇpua˛
[tfw_globÆ.
ˇpua˛_sz
++] = 
addr
;

1167 
tfw_globÆ
.
ˇche_purge_a˛
 = 1;

1170 
	}
}

1176 
	$tfw_cfg›_ˇche_purge
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1178 
size_t
 
i
;

1179 c⁄° *
vÆ
;

1181 i‡(
˚
->
©å_n
) {

1182 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

1183 
cs
->
«me
);

1184  -
EINVAL
;

1186 i‡(!
˚
->
vÆ_n
) {

1188 
tfw_globÆ
.
ˇche_purge_mode
 = 
TFW_D_CACHE_PURGE_INVALIDATE
;

1189 
d⁄e
;

1191 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
vÆ
) {

1192 i‡(!
	`°rˇ£cmp
(
vÆ
, "invalidate")) {

1193 
tfw_globÆ
.
ˇche_purge_mode
 = 
TFW_D_CACHE_PURGE_INVALIDATE
;

1195 
	`TFW_ERR_NL
("%s: unsupportedárgument: '%s'\n",

1196 
cs
->
«me
, 
vÆ
);

1197  -
EINVAL
;

1200 
d⁄e
:

1201 
tfw_globÆ
.
ˇche_purge
 = 1;

1204 
	}
}

1211 
	$tfw_cfg›_hdr_vü
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1213 
size_t
 
Àn
;

1215 i‡(
˚
->
©å_n
) {

1216 
	`TFW_ERR_NL
("%s: Arguments mayÇot haveÅhe \'=\' sign\n",

1217 
cs
->
«me
);

1218  -
EINVAL
;

1220 i‡(
˚
->
vÆ_n
 != 1) {

1221 
	`TFW_ERR_NL
("%s: InvalidÇumber ofárguments: %d\n",

1222 
cs
->
«me
, ()
˚
->
vÆ_n
);

1223  -
EINVAL
;

1231 
Àn
 = 
	`°æí
(
˚
->
vÆs
[0]);

1232 i‡((
tfw_globÆ
.
hdr_vü
 = 
	`kmÆloc
(
Àn
 + 1, 
GFP_KERNEL
)Ë=
NULL
)

1233  -
ENOMEM
;

1234 
	`mem˝y
((*)
tfw_globÆ
.
hdr_vü
, (*)
˚
->
vÆs
[0], 
Àn
 + 1);

1235 
tfw_globÆ
.
hdr_vü_Àn
 = 
Àn
;

1238 
	}
}

1241 
	$tfw_cfg›_vho°_check_Êags
(
TfwSrvGroup
 *
maö_sg
, TfwSrvGrou∞*
backup_sg
)

1243 
r
 = ((
maö_sg
->
Êags
 & 
TFW_SRV_STICKY_FLAGS
) ^

1244 (
backup_sg
->
Êags
 & 
TFW_SRV_STICKY_FLAGS
));

1245 i‡(
r
)

1246 
	`TFW_ERR_NL
("vhost: srv_groups '%s'ánd '%s' must "

1248 
maö_sg
->
«me
, 
backup_sg
->name);

1250  
r
;

1251 
	}
}

1254 
	$__tfw_cfg›_¥oxy_∑ss
(c⁄° *
maö_sg_nm
, c⁄° *
backup_sg_nm
,

1255 
TfwLoˇti⁄
 *
loc
)

1257 
r
;

1258 
TfwSrvGroup
 *
maö_sg
, *
backup_sg
 = 
NULL
;

1260 
maö_sg
 = 
	`tfw_sg_lookup_ªc⁄fig
(
maö_sg_nm
, 
	`°æí
(main_sg_nm));

1261 i‡(!
maö_sg
) {

1262 
	`TFW_ERR_NL
("proxy_pass: srv_group isÇot found: '%s'\n",

1263 
maö_sg_nm
);

1264  -
EINVAL
;

1266 i‡(
backup_sg_nm
) {

1267 
backup_sg
 = 
	`tfw_sg_lookup_ªc⁄fig
(
backup_sg_nm
,

1268 
	`°æí
(
backup_sg_nm
));

1269 i‡(!
backup_sg
) {

1270 
	`TFW_ERR_NL
("proxy_pass: backup srv_group isÇot found:"

1271 " '%s'\n", 
backup_sg_nm
);

1272 
r
 = -
EINVAL
;

1273 
îr
;

1277 i‡(
	`°rˇ£cmp
(
maö_sg_nm
, "default")

1278 && 
	`°rˇ£cmp
(
backup_sg_nm
, "default")

1279 && 
	`tfw_cfg›_vho°_check_Êags
(
maö_sg
, 
backup_sg
))

1281 
r
 = -
EINVAL
;

1282 
îr
;

1286 
loc
->
maö_sg
 = main_sg;

1287 
loc
->
backup_sg
 = backup_sg;

1290 
îr
:

1291 
	`tfw_sg_put
(
maö_sg
);

1292 
	`tfw_sg_put
(
backup_sg
);

1294  
r
;

1295 
	}
}

1297 
ölöe
 

1298 
	$tfw_cfg›_¥oxy_∑ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
TfwLoˇti⁄
 *
loc
)

1300 
r
;

1301 c⁄° *
ö_maö_sg
, *
ö_backup_sg
;

1303 i‡((
r
 = 
	`tfw_cfg_check_vÆ_n
(
˚
, 1)))

1304  
r
;

1306 
ö_maö_sg
 = 
˚
->
vÆs
[0];

1307 
ö_backup_sg
 = 
	`tfw_cfg_gë_©å
(
˚
, "backup", 
NULL
);

1309 i‡(!
tfw_vho°_íåy
 || 
	`tfw_vho°_deÁu…
(tfw_vhost_entry)) {

1310 i‡(!
	`°rˇ£cmp
(
ö_maö_sg
, 
TFW_VH_DFT_NAME
)

1311 && (!
ö_backup_sg


1312 || !
	`°rˇ£cmp
(
ö_backup_sg
, 
TFW_VH_DFT_NAME
)))

1314 
	`TFW_ERR_NL
("Default vhost mustÖointÅo default server"

1318  -
EINVAL
;

1320  
	`__tfw_cfg›_¥oxy_∑ss
(
ö_maö_sg
, 
ö_backup_sg
, 
loc
);

1321 
	}
}

1324 
	$tfw_cfg›_loc_¥oxy_∑ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1326 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1327  
	`tfw_cfg›_¥oxy_∑ss
(
cs
, 
˚
, 
tfwcfg_this_loˇti⁄
);

1328 
	}
}

1331 
	$tfw_cfg›_ö_¥oxy_∑ss
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1333 
	`BUG_ON
(!
tfw_vho°_íåy
);

1334  
	`tfw_cfg›_¥oxy_∑ss
(
cs
, 
˚
, 
tfw_vho°_íåy
->
loc_dÊt
);

1335 
	}
}

1338 
	$tfw_vho°_de°roy
(
TfwVho°
 *
vho°
)

1340 
i
;

1342 
i
 = 0; i < 
vho°
->
loc_sz
; ++i)

1343 
	`tfw_loˇti⁄_dñ
(&
vho°
->
loc
[
i
]);

1344 
	`tfw_loˇti⁄_dñ
(
vho°
->
loc_dÊt
);

1345 
	`tfw_vho°_put
(
vho°
->
vho°_dÊt
);

1346 
	`tfw_poﬁ_de°roy
(
vho°
->
hdrs_poﬁ
);

1347 
	`k‰ì
(
vho°
);

1348 
	}
}

1350 
TfwVho°
 *

1351 
	$tfw_vho°_¸óã
(c⁄° *
«me
)

1353 
TfwPoﬁ
 *
poﬁ
;

1354 
TfwVho°
 *
vho°
;

1355 
«me_sz
 = 
	`°æí
(
«me
) + 1;

1356 
size
 = (
TfwVho°
)

1357 + 
«me_sz


1358 + (
TfwLoˇti⁄
Ë* (
TFW_LOCATION_ARRAY_SZ
 + 1);

1360 i‡(!(
poﬁ
 = 
	`__tfw_poﬁ_√w
(0)))

1361  
NULL
;

1363 i‡(!(
vho°
 = 
	`kzÆloc
(
size
, 
GFP_KERNEL
))) {

1364 
	`tfw_poﬁ_de°roy
(
poﬁ
);

1365 
	`TFW_ERR_NL
("C™nŸáŒoˇã vho°É¡ry '%s'\n", 
«me
);

1366  
NULL
;

1368 
	`INIT_LIST_HEAD
(&
vho°
->
li°
);

1369 
vho°
->
«me
 = (*)(vhost + 1);

1370 
vho°
->
loc_dÊt
 = (
TfwLoˇti⁄
 *)(vho°->
«me
 + 
«me_sz
);

1371 
vho°
->
loc
 = (
TfwLoˇti⁄
 *)(vho°->
loc_dÊt
 + 1);

1372 
	`mem˝y
((*)
vho°
->
«me
, (*Íame, 
«me_sz
);

1373 
vho°
->
hdrs_poﬁ
 = 
poﬁ
;

1374 
	`©omic64_£t
(&
vho°
->
ªf˙t
, 1);

1376  
vho°
;

1377 
	}
}

1379 
TfwVho°
 *

1380 
	$tfw_vho°_√w
(c⁄° *
«me
)

1382 
TfwVho°
 *
vho°
;

1384 i‡(!(
vho°
 = 
	`tfw_vho°_¸óã
(
«me
)))

1385  
NULL
;

1388 i‡(
	`tfw_loˇti⁄_öô
(
vho°
->
loc_dÊt
,

1389 
TFW_HTTP_MATCH_O_WILDCARD
, "*", 1,

1390 
vho°
->
hdrs_poﬁ
))

1392 
	`TFW_ERR_NL
("UnableÅoádd defaultÜocation"

1393 " f‹ vho° '%s'.\n", 
«me
);

1394 
	`tfw_vho°_de°roy
(
vho°
);

1395  
NULL
;

1398  
vho°
;

1399 
	}
}

1401 
ölöe
 

1402 
	$tfw_vho°_add
(
TfwVho°
 *
vho°
)

1404 
	`li°_add
(&
vho°
->
li°
, &
tfw_vho°s_ªc⁄fig
->
hód
);

1405 
	`tfw_vho°_gë
(
vho°
);

1406 i‡(!
	`tfw_vho°_deÁu…
(
vho°
)) {

1407 
vho°
->
vho°_dÊt
 = 
tfw_vho°s_ªc⁄fig
->vhost_dflt;

1408 
	`tfw_vho°_gë
(
vho°
->
vho°_dÊt
);

1410 
	}
}

1418 
FøngCfg
 
‰™g_cfg
 
	g__ªad_mo°ly
;

1420 c⁄° 
TfwCfgEnum
 
	g‰™g_hâp_mëhods_íum
[] = {

1421 { "c›y", 
TFW_HTTP_METH_COPY
 },

1422 { "dñëe", 
TFW_HTTP_METH_DELETE
 },

1423 { "gë", 
TFW_HTTP_METH_GET
 },

1424 { "hód", 
TFW_HTTP_METH_HEAD
 },

1425 { "lock", 
TFW_HTTP_METH_LOCK
 },

1426 { "mkcﬁ", 
TFW_HTTP_METH_MKCOL
 },

1427 { "move", 
TFW_HTTP_METH_MOVE
 },

1428 { "›ti⁄s", 
TFW_HTTP_METH_OPTIONS
 },

1429 { "∑tch", 
TFW_HTTP_METH_PATCH
 },

1430 { "po°", 
TFW_HTTP_METH_POST
 },

1431 { "¥›föd", 
TFW_HTTP_METH_PROPFIND
 },

1432 { "¥›∑tch", 
TFW_HTTP_METH_PROPPATCH
 },

1433 { "put", 
TFW_HTTP_METH_PUT
 },

1434 { "åa˚", 
TFW_HTTP_METH_TRACE
 },

1435 { "u∆ock", 
TFW_HTTP_METH_UNLOCK
 },

1436 { "unknown", 
_TFW_HTTP_METH_UNKNOWN
 },

1441 
FøngCfg
 *

1442 
	$tfw_vho°_globÆ_‰™g_cfg
()

1444  &
‰™g_cfg
;

1445 
	}
}

1448 
	$tfw_cfg›_‰™g_hâp_mëhods
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
,

1449 *
cfg_mëhods_mask
)

1451 
i
, 
r
, 
mëhod_id
;

1452 c⁄° *
mëhod_°r
;

1453 
mëhods_mask
 = 0;

1455 
	`BUILD_BUG_ON
((*
cfg_mëhods_mask
Ë* 
BITS_PER_BYTE


1456 < 
_TFW_HTTP_METH_COUNT
);

1458 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
mëhod_°r
) {

1459 
r
 = 
	`tfw_cfg_m≠_íum
(
‰™g_hâp_mëhods_íum
, 
mëhod_°r
,

1460 &
mëhod_id
);

1461 i‡(
r
) {

1462 
	`TFW_ERR_NL
("‰™g: invÆid mëhod: '%s'\n", 
mëhod_°r
);

1463  -
EINVAL
;

1466 
	`TFW_DBG3
("frang:Öarsed method: %s => %d\n",

1467 
mëhod_°r
, 
mëhod_id
);

1468 
mëhods_mask
 |(1UL << 
mëhod_id
);

1471 
	`TFW_DBG3
("∑r£d mëhods_mask: %#lx\n", 
mëhods_mask
);

1472 *
cfg_mëhods_mask
 = 
mëhods_mask
;

1474 
	}
}

1477 
	$tfw_cfg›_‰™g_hâp_˘_vÆs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
FøngCfg
 *
c⁄f
)

1479 *
mem
;

1480 c⁄° *
ö_°r
;

1481 *
°rs
, *
°rs_pos
;

1482 
FøngCtVÆ
 *
vÆs
, *
vÆs_pos
;

1483 
size_t
 
i
, 
°rs_size
, 
vÆs_n
, 
vÆs_size
;

1498 
vÆs_n
 = 
˚
->
vÆ_n
;

1499 
vÆs_size
 = (
FøngCtVÆ
Ë* (
vÆs_n
 + 1);

1500 
°rs_size
 = 0;

1501 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
ö_°r
) {

1502 
°rs_size
 +
	`°æí
(
ö_°r
) + 1;

1504 
mem
 = 
	`kzÆloc
(
vÆs_size
 + 
°rs_size
, 
GFP_KERNEL
);

1505 i‡(!
mem
)

1506  -
ENOMEM
;

1507 
vÆs
 = 
mem
;

1508 
°rs
 = 
mem
 + 
vÆs_size
;

1512 
vÆs_pos
 = 
vÆs
;

1513 
°rs_pos
 = 
°rs
;

1514 
	`TFW_CFG_ENTRY_FOR_EACH_VAL
(
˚
, 
i
, 
ö_°r
) {

1515 
size_t
 
Àn
 = 
	`°æí
(
ö_°r
) + 1;

1517 
	`mem˝y
(
°rs_pos
, 
ö_°r
, 
Àn
);

1518 
vÆs_pos
->
°r
 = 
°rs_pos
;

1519 
vÆs_pos
->
Àn
 = (len - 1);

1521 
	`TFW_DBG3
("∑r£d C⁄ã¡-Ty≥ vÆue: '%s'\n", 
ö_°r
);

1523 
vÆs_pos
++;

1524 
°rs_pos
 +
Àn
;

1526 
	`BUG_ON
(
vÆs_pos
 !(
vÆs
 + 
vÆs_n
));

1527 
	`BUG_ON
(
°rs_pos
 !(
°rs
 + 
°rs_size
));

1529 
c⁄f
->
hâp_˘_vÆs
 = 
vÆs
;

1531 
	}
}

1534 
	$‰™g_∑r£_ush‹t
(c⁄° *
s
, *
out
)

1536 
n
;

1537 i‡(
	`tfw_cfg_∑r£_öt
(
s
, &
n
)) {

1538 
	`TFW_ERR_NL
("frang: http_resp_code_block: "

1539 "\"%s\" i¢'à®vÆid vÆue\n", 
s
);

1540  -
EINVAL
;

1542 i‡(
	`tfw_cfg_check_ønge
(
n
, 1, 
USHRT_MAX
))

1543  -
EINVAL
;

1544 *
out
 = 
n
;

1546 
	}
}

1552 
	$tfw_cfg›_‰™g_r•_code_block
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
, 
FøngCfg
 *
c⁄f
)

1554 
FøngHâpRe•CodeBlock
 *
cb
;

1555 c⁄° *
îr‹_msg_begö
 = "frang: http_resp_code_block:";

1556 
n
, 
i
;

1558 i‡(
˚
->
©å_n
) {

1559 
	`TFW_ERR_NL
("%sárguments mayÇot haveÅhe \'=\' sign\n",

1560 
îr‹_msg_begö
);

1561  -
EINVAL
;

1564 i‡(
˚
->
vÆ_n
 < 3) {

1565 
	`TFW_ERR_NL
("%†toÿ„wárgumíts\n", 
îr‹_msg_begö
);

1566  -
EINVAL
;

1569 
cb
 = 
	`kzÆloc
((
FøngHâpRe•CodeBlock
), 
GFP_KERNEL
);

1570 i‡(!
cb
)

1571  -
ENOMEM
;

1572 
c⁄f
->
hâp_ª•_code_block
 = 
cb
;

1574 
i
 = 
˚
->
vÆ_n
 - 2;

1575 --
i
 >= 0) {

1576 i‡(
	`tfw_cfg_∑r£_öt
(
˚
->
vÆs
[
i
], &
n
)

1577 || !
	`tfw_hâp_ª•_code_ønge
(
n
)) {

1578 
	`TFW_ERR_NL
("%s invalid HTTP code \"%s\"",

1579 
îr‹_msg_begö
, 
˚
->
vÆs
[
i
]);

1580  -
EINVAL
;

1583 
	`__£t_bô
(
	`HTTP_CODE_BIT_NUM
(
n
), 
cb
->
codes
);

1586 i‡(
	`‰™g_∑r£_ush‹t
(
˚
->
vÆs
[˚->
vÆ_n
 - 2], &
cb
->
limô
)

1587 || 
	`‰™g_∑r£_ush‹t
(
˚
->
vÆs
[˚->
vÆ_n
 - 1], &
cb
->
tf
))

1588  -
EINVAL
;

1591 
	}
}

1594 
	$tfw_cfg›_‰™g_loc_ªq_øã
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1596 
r
;

1598 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1599 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
ªq_øã
;

1600 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1601 
cs
->
de°
 = 
NULL
;

1602  
r
;

1603 
	}
}

1606 
	$tfw_cfg›_‰™g_loc_ªq_bur°
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1608 
r
;

1610 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1611 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
ªq_bur°
;

1612 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1613 
cs
->
de°
 = 
NULL
;

1614  
r
;

1615 
	}
}

1618 
	$tfw_cfg›_‰™g_loc_hdr_timeout
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1620 
r
;

1622 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1623 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
˛¡_hdr_timeout
;

1624 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1625 
cs
->
de°
 = 
NULL
;

1626  
r
;

1627 
	}
}

1630 
	$tfw_cfg›_‰™g_loc_body_timeout
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1632 
r
;

1634 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1635 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
˛¡_body_timeout
;

1636 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1637 
cs
->
de°
 = 
NULL
;

1638  
r
;

1639 
	}
}

1642 
	$tfw_cfg›_‰™g_loc_uri_Àn
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1644 
r
;

1646 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1647 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_uri_Àn
;

1648 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1649 
cs
->
de°
 = 
NULL
;

1650  
r
;

1651 
	}
}

1654 
	$tfw_cfg›_‰™g_loc_fõld_Àn
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1656 
r
;

1658 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1659 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_fõld_Àn
;

1660 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1661 
cs
->
de°
 = 
NULL
;

1662  
r
;

1663 
	}
}

1666 
	$tfw_cfg›_‰™g_loc_body_Àn
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1668 
r
;

1670 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1671 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_body_Àn
;

1672 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1673 
cs
->
de°
 = 
NULL
;

1674  
r
;

1675 
	}
}

1678 
	$tfw_cfg›_‰™g_loc_hdr_˙t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1680 
r
;

1682 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1683 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_hdr_˙t
;

1684 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1685 
cs
->
de°
 = 
NULL
;

1686  
r
;

1687 
	}
}

1690 
	$tfw_cfg›_‰™g_loc_hdr_chunk_˙t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1692 
r
;

1694 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1695 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_hchunk_˙t
;

1696 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1697 
cs
->
de°
 = 
NULL
;

1698  
r
;

1699 
	}
}

1702 
	$tfw_cfg›_‰™g_loc_body_chunk_˙t
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1704 
r
;

1706 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1707 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_bchunk_˙t
;

1708 
r
 = 
	`tfw_cfg_£t_öt
(
cs
, 
˚
);

1709 
cs
->
de°
 = 
NULL
;

1710  
r
;

1711 
	}
}

1714 
	$tfw_cfg›_‰™g_loc_ho°_ªquúed
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1716 
r
;

1718 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1719 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_ho°_ªquúed
;

1720 
r
 = 
	`tfw_cfg_£t_boﬁ
(
cs
, 
˚
);

1721 
cs
->
de°
 = 
NULL
;

1722  
r
;

1723 
	}
}

1726 
	$tfw_cfg›_‰™g_loc_˘_ªquúed
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1728 
r
;

1730 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1731 
cs
->
de°
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_˘_ªquúed
;

1732 
r
 = 
	`tfw_cfg_£t_boﬁ
(
cs
, 
˚
);

1733 
cs
->
de°
 = 
NULL
;

1734  
r
;

1735 
	}
}

1738 
	$tfw_cfg›_‰™g_loc_hâp_mëhods
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1740 *
mëhods_mask
;

1742 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1743 
mëhods_mask
 = &
tfwcfg_this_loˇti⁄
->
‰™g_cfg
->
hâp_mëhods_mask
;

1744  
	`tfw_cfg›_‰™g_hâp_mëhods
(
cs
, 
˚
, 
mëhods_mask
);

1745 
	}
}

1748 
	$tfw_cfg›_‰™g_out_hâp_mëhods
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1750  
	`tfw_cfg›_‰™g_hâp_mëhods
(
cs
, 
˚
,

1751 &
‰™g_cfg
.
hâp_mëhods_mask
);

1752 
	}
}

1755 
	$tfw_cfg›_‰™g_loc_hâp_˘_vÆs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1757 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1758  
	`tfw_cfg›_‰™g_hâp_˘_vÆs
(
cs
, 
˚
,

1759 
tfwcfg_this_loˇti⁄
->
‰™g_cfg
);

1760 
	}
}

1763 
	$tfw_cfg›_‰™g_out_hâp_˘_vÆs
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1765  
	`tfw_cfg›_‰™g_hâp_˘_vÆs
(
cs
, 
˚
, &
‰™g_cfg
);

1766 
	}
}

1769 
	$tfw_cfg›_‰™g_loc_r•_code_block
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1771 
	`BUG_ON
(!
tfwcfg_this_loˇti⁄
);

1772  
	`tfw_cfg›_‰™g_r•_code_block
(
cs
, 
˚
,

1773 
tfwcfg_this_loˇti⁄
->
‰™g_cfg
);

1774 
	}
}

1777 
	$tfw_cfg›_‰™g_out_r•_code_block
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1779  
	`tfw_cfg›_‰™g_r•_code_block
(
cs
, 
˚
, &
‰™g_cfg
);

1780 
	}
}

1783 
	$tfw_vho°_cfg°¨t
()

1785 
TfwVho°
 *
vh_dÊt
;

1787 
	`BUG_ON
(
tfw_vho°s_ªc⁄fig
);

1788 
tfw_vho°s_ªc⁄fig
 = 
	`kmÆloc
((
TfwVho°Li°
), 
GFP_KERNEL
);

1789 i‡(!
tfw_vho°s_ªc⁄fig
) {

1790 
	`TFW_ERR_NL
("UnableÅoállocate vhosts'Üist.\n");

1791  -
ENOMEM
;

1794 
	`INIT_LIST_HEAD
(&
tfw_vho°s_ªc⁄fig
->
hód
);

1795 if(!(
vh_dÊt
 = 
	`tfw_vho°_√w
(
TFW_VH_DFT_NAME
))) {

1796 
	`TFW_ERR_NL
("UnableÅo create default vhost.\n");

1797  -
ENOMEM
;

1800 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
 = 
vh_dÊt
;

1803 
	}
}

1806 
	$tfw_vho°_cfgíd
()

1808 
TfwSrvGroup
 *
sg_def
;

1809 
TfwVho°
 *
vh_dÊt
;

1816 i‡(
tfw_vho°s_ªc⁄fig
->
ex∂_dÊt
)

1819 
sg_def
 = 
	`tfw_sg_lookup_ªc⁄fig
(
TFW_VH_DFT_NAME
, ("default") - 1);

1820 i‡(!
sg_def
)

1823 
vh_dÊt
 = 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
;

1824 
vh_dÊt
->
loc_dÊt
->
maö_sg
 = 
sg_def
;

1825 
	`tfw_vho°_add
(
vh_dÊt
);

1827 i‡(
tfw_globÆ
.
ˇche_purge
 && !tfw_globÆ.
ˇche_purge_a˛
)

1828 
	`TFW_WARN_NL
("Directives mismatching: cache_purge directive"

1832 
	}
}

1835 
	$tfw_cfg›_vho°_begö
(
TfwCfgS≥c
 *
cs
, 
TfwCfgE¡ry
 *
˚
)

1837 
TfwVho°
 *
vho°
;

1839 
	`BUG_ON
(
tfw_vho°_íåy
);

1841 i‡(
	`tfw_cfg_check_vÆ_n
(
˚
, 1))

1842  -
EINVAL
;

1843 i‡(
˚
->
©å_n
) {

1844 
	`TFW_ERR_NL
("Unexpectedáttributes\n");

1845  -
EINVAL
;

1847 
	`li°_f‹_óch_íåy
(
vho°
, &
tfw_vho°s_ªc⁄fig
->
hód
, 
li°
) {

1848 i‡(!
	`°rˇ£cmp
(
vho°
->
«me
, 
˚
->
vÆs
[0])) {

1849 
	`TFW_ERR_NL
("Duplicate vhostÉntry: '%s'\n",

1850 
˚
->
vÆs
[0]);

1851  -
EINVAL
;

1854 i‡(!
	`°rˇ£cmp
(
˚
->
vÆs
[0], 
TFW_VH_DFT_NAME
)) {

1855 
tfw_vho°s_ªc⁄fig
->
ex∂_dÊt
 = 
åue
;

1856 
tfw_vho°_íåy
 = 
tfw_vho°s_ªc⁄fig
->
vho°_dÊt
;

1857 i‡(
	`__tfw_cfg›_¥oxy_∑ss
(
TFW_VH_DFT_NAME
, 
NULL
,

1858 
tfw_vho°_íåy
->
loc_dÊt
))

1859  -
EINVAL
;

1861 i‡(!(
tfw_vho°_íåy
 = 
	`tfw_vho°_√w
(
˚
->
vÆs
[0]))) {

1862 
	`TFW_ERR_NL
("UnableÅo createÇew vhostÉntry: '%s'\n",

1863 
˚
->
vÆs
[0]);

1864  -
ENOMEM
;

1867 
	`tfw_vho°_add
(
tfw_vho°_íåy
);

1868 i‡(!
	`tfw_vho°_deÁu…
(
tfw_vho°_íåy
))

1869 
	`tfw_vho°_put
(
tfw_vho°_íåy
);

1872 
	}
}

1875 
	$tfw_cfg›_vho°_föish
(
TfwCfgS≥c
 *
cs
)

1877 
	`BUG_ON
(!
tfw_vho°_íåy
);

1878 i‡(!
tfw_vho°_íåy
->
loc_dÊt
->
maö_sg
) {

1879 
	`BUG_ON
(
	`tfw_vho°_deÁu…
(
tfw_vho°_íåy
));

1880 
	`TFW_ERR_NL
("Directive 'proxy_pass' isÇot specified"

1882 
tfw_vho°_íåy
->
«me
);

1883  -
EINVAL
;

1885 
tfw_vho°_íåy
 = 
NULL
;

1887 
	}
}

1890 
	$tfw_cfg›_vho°s_li°_‰ì
(
TfwVho°Li°
 *
vho°s
)

1892 
TfwVho°
 *
tmp
, *
vho°
;

1894 i‡(!
vho°s
)

1897 
	`li°_f‹_óch_íåy_ß„
(
vho°
, 
tmp
, &
vho°s
->
hód
, 
li°
) {

1898 
	`li°_dñ
(&
vho°
->
li°
);

1899 
	`tfw_vho°_put
(
vho°
);

1901 
	`tfw_vho°_put
(
vho°s
->
vho°_dÊt
);

1902 
	`k‰ì
(
vho°s
);

1903 
	}
}

1906 
	$tfw_vho°_°¨t
()

1908 i‡(!
	`tfw_run°©e_is_ªc⁄fig
()) {

1910 
‰™g_cfg
.
˛¡_hdr_timeout
 =

1911 *(*)&
‰™g_cfg
.
˛¡_hdr_timeout
 * 
HZ
;

1912 
‰™g_cfg
.
˛¡_body_timeout
 =

1913 *(*)&
‰™g_cfg
.
˛¡_body_timeout
 * 
HZ
;

1916 
	`tfw_cfg›_vho°s_li°_‰ì
(
tfw_vho°s
);

1917 
tfw_vho°s
 = 
tfw_vho°s_ªc⁄fig
;

1918 
tfw_vho°s_ªc⁄fig
 = 
NULL
;

1921 
	}
}

1924 
	$__tfw_cfg›_vho°s_˛ónup
()

1926 
	`tfw_cfg›_vho°s_li°_‰ì
(
tfw_vho°s_ªc⁄fig
);

1927 
tfw_vho°s_ªc⁄fig
 = 
NULL
;

1929 i‡(!
	`tfw_run°©e_is_ªc⁄fig
()) {

1930 
	`tfw_cfg›_vho°s_li°_‰ì
(
tfw_vho°s
);

1931 
tfw_vho°s
 = 
NULL
;

1933 
	}
}

1936 
	$tfw_cfg›_vho°s_˛ónup
(
TfwCfgS≥c
 *
cs
)

1938 
	`__tfw_cfg›_vho°s_˛ónup
();

1939 
	}
}

1942 
	$tfw_vho°_cfg˛ón
()

1944 
	`__tfw_cfg›_vho°s_˛ónup
();

1946 i‡(
	`tfw_run°©e_is_ªc⁄fig
())

1949 
	`k‰ì
(
‰™g_cfg
.
hâp_˘_vÆs
);

1950 
	`k‰ì
(
‰™g_cfg
.
hâp_ª•_code_block
);

1951 
	`mem£t
(&
‰™g_cfg
, 0, (frang_cfg));

1953 
tfw_globÆ
.
ˇpua˛_sz
 =

1954 
tfw_globÆ
.
ˇche_purge
 =

1955 
tfw_globÆ
.
ˇche_purge_mode
 =

1956 
tfw_globÆ
.
ˇche_purge_a˛
 = 0;

1958 i‡(
tfw_globÆ
.
hdr_vü
 && (tfw_globÆ.hdr_vü !
s_hdr_vü_dÊt
))

1959 
	`k‰ì
(
tfw_globÆ
.
hdr_vü
);

1960 
tfw_globÆ
.
hdr_vü
 = 
s_hdr_vü_dÊt
;

1961 
	}
}

1963 
TfwCfgS≥c
 
	gtfw_vho°_loˇti⁄_•ecs
[] = {

1965 .
«me
 = "cache_bypass",

1966 .
	gdeÊt
 = 
NULL
,

1967 .
	gh™dÀr
 = 
tfw_cfg›_loc_ˇche_by∑ss
,

1968 .
	gÆlow_n⁄e
 = 
åue
,

1969 .
	gÆlow_ª≥©
 = 
åue
,

1970 .
	gÆlow_ªc⁄fig
 = 
åue
,

1973 .
	g«me
 = "cache_fulfill",

1974 .
	gdeÊt
 = 
NULL
,

1975 .
	gh™dÀr
 = 
tfw_cfg›_loc_ˇche_fulfûl
,

1976 .
	gÆlow_n⁄e
 = 
åue
,

1977 .
	gÆlow_ª≥©
 = 
åue
,

1978 .
	gÆlow_ªc⁄fig
 = 
åue
,

1981 .
	g«me
 = "nonidempotent",

1982 .
	gdeÊt
 = 
NULL
,

1983 .
	gh™dÀr
 = 
tfw_cfg›_loc_n⁄idempŸít
,

1984 .
	gÆlow_n⁄e
 = 
åue
,

1985 .
	gÆlow_ª≥©
 = 
åue
,

1986 .
	gÆlow_ªc⁄fig
 = 
åue
,

1989 .
	g«me
 = "req_hdr_add",

1990 .
	gdeÊt
 = 
NULL
,

1991 .
	gh™dÀr
 = 
tfw_cfg›_loc_ªq_hdr_add
,

1992 .
	gÆlow_n⁄e
 = 
åue
,

1993 .
	gÆlow_ª≥©
 = 
åue
,

1994 .
	gÆlow_ªc⁄fig
 = 
åue
,

1997 .
	g«me
 = "req_hdr_set",

1998 .
	gdeÊt
 = 
NULL
,

1999 .
	gh™dÀr
 = 
tfw_cfg›_loc_ªq_hdr_£t
,

2000 .
	gÆlow_n⁄e
 = 
åue
,

2001 .
	gÆlow_ª≥©
 = 
åue
,

2002 .
	gÆlow_ªc⁄fig
 = 
åue
,

2005 .
	g«me
 = "resp_hdr_add",

2006 .
	gdeÊt
 = 
NULL
,

2007 .
	gh™dÀr
 = 
tfw_cfg›_loc_ª•_hdr_add
,

2008 .
	gÆlow_n⁄e
 = 
åue
,

2009 .
	gÆlow_ª≥©
 = 
åue
,

2010 .
	gÆlow_ªc⁄fig
 = 
åue
,

2013 .
	g«me
 = "resp_hdr_set",

2014 .
	gdeÊt
 = 
NULL
,

2015 .
	gh™dÀr
 = 
tfw_cfg›_loc_ª•_hdr_£t
,

2016 .
	gÆlow_n⁄e
 = 
åue
,

2017 .
	gÆlow_ª≥©
 = 
åue
,

2018 .
	gÆlow_ªc⁄fig
 = 
åue
,

2021 .
	g«me
 = "request_rate",

2022 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_ªq_øã
,

2023 .
	gÆlow_n⁄e
 = 
åue
,

2024 .
	gÆlow_ª≥©
 = 
Ál£
,

2025 .
	gÆlow_ªc⁄fig
 = 
åue
,

2028 .
	g«me
 = "request_burst",

2029 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_ªq_bur°
,

2030 .
	gÆlow_n⁄e
 = 
åue
,

2031 .
	gÆlow_ª≥©
 = 
Ál£
,

2032 .
	gÆlow_ªc⁄fig
 = 
åue
,

2035 .
	g«me
 = "client_header_timeout",

2036 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_hdr_timeout
,

2037 .
	gÆlow_n⁄e
 = 
åue
,

2038 .
	gÆlow_ª≥©
 = 
Ál£
,

2039 .
	gÆlow_ªc⁄fig
 = 
åue
,

2042 .
	g«me
 = "client_body_timeout",

2043 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_body_timeout
,

2044 .
	gÆlow_n⁄e
 = 
åue
,

2045 .
	gÆlow_ª≥©
 = 
Ál£
,

2046 .
	gÆlow_ªc⁄fig
 = 
åue
,

2049 .
	g«me
 = "http_uri_len",

2050 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_uri_Àn
,

2051 .
	gÆlow_n⁄e
 = 
åue
,

2052 .
	gÆlow_ª≥©
 = 
Ál£
,

2053 .
	gÆlow_ªc⁄fig
 = 
åue
,

2056 .
	g«me
 = "http_field_len",

2057 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_fõld_Àn
,

2058 .
	gÆlow_n⁄e
 = 
åue
,

2059 .
	gÆlow_ª≥©
 = 
Ál£
,

2060 .
	gÆlow_ªc⁄fig
 = 
åue
,

2063 .
	g«me
 = "http_body_len",

2064 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_body_Àn
,

2065 .
	gÆlow_n⁄e
 = 
åue
,

2066 .
	gÆlow_ª≥©
 = 
Ál£
,

2067 .
	gÆlow_ªc⁄fig
 = 
åue
,

2070 .
	g«me
 = "http_header_cnt",

2071 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_hdr_˙t
,

2072 .
	gÆlow_n⁄e
 = 
åue
,

2073 .
	gÆlow_ª≥©
 = 
Ál£
,

2074 .
	gÆlow_ªc⁄fig
 = 
åue
,

2077 .
	g«me
 = "http_header_chunk_cnt",

2078 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_hdr_chunk_˙t
,

2079 .
	gÆlow_n⁄e
 = 
åue
,

2080 .
	gÆlow_ª≥©
 = 
Ál£
,

2081 .
	gÆlow_ªc⁄fig
 = 
åue
,

2084 .
	g«me
 = "http_body_chunk_cnt",

2085 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_body_chunk_˙t
,

2086 .
	gÆlow_n⁄e
 = 
åue
,

2087 .
	gÆlow_ª≥©
 = 
Ál£
,

2088 .
	gÆlow_ªc⁄fig
 = 
åue
,

2091 .
	g«me
 = "http_host_required",

2092 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_ho°_ªquúed
,

2093 .
	gÆlow_n⁄e
 = 
åue
,

2094 .
	gÆlow_ª≥©
 = 
Ál£
,

2095 .
	gÆlow_ªc⁄fig
 = 
åue
,

2098 .
	g«me
 = "http_ct_required",

2099 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_˘_ªquúed
,

2100 .
	gÆlow_n⁄e
 = 
åue
,

2101 .
	gÆlow_ª≥©
 = 
Ál£
,

2102 .
	gÆlow_ªc⁄fig
 = 
åue
,

2105 .
	g«me
 = "http_methods",

2106 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_hâp_mëhods
,

2107 .
	gÆlow_n⁄e
 = 
åue
,

2108 .
	gÆlow_ª≥©
 = 
Ál£
,

2109 .
	gÆlow_ªc⁄fig
 = 
åue
,

2112 .
	g«me
 = "http_ct_vals",

2113 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_hâp_˘_vÆs
,

2114 .
	gÆlow_n⁄e
 = 
åue
,

2115 .
	gÆlow_ª≥©
 = 
Ál£
,

2116 .
	gÆlow_ªc⁄fig
 = 
åue
,

2119 .
	g«me
 = "http_resp_code_block",

2120 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_loc_r•_code_block
,

2121 .
	gÆlow_n⁄e
 = 
åue
,

2122 .
	gÆlow_ª≥©
 = 
Ál£
,

2123 .
	gÆlow_ªc⁄fig
 = 
åue
,

2126 .
	g«me
 = "proxy_pass",

2127 .
	gdeÊt
 = 
NULL
,

2128 .
	gh™dÀr
 = 
tfw_cfg›_loc_¥oxy_∑ss
,

2129 .
	gÆlow_n⁄e
 = 
åue
,

2130 .
	gÆlow_ª≥©
 = 
Ál£
,

2131 .
	gÆlow_ªc⁄fig
 = 
åue
,

2136 
TfwCfgS≥c
 
	gtfw_vho°_öã∫Æ_•ecs
[] = {

2138 .
«me
 = "cache_bypass",

2139 .
	gdeÊt
 = 
NULL
,

2140 .
	gh™dÀr
 = 
tfw_cfg›_ö_ˇche_by∑ss
,

2141 .
	gÆlow_n⁄e
 = 
åue
,

2142 .
	gÆlow_ª≥©
 = 
åue
,

2143 .
	gÆlow_ªc⁄fig
 = 
åue
,

2146 .
	g«me
 = "cache_fulfill",

2147 .
	gdeÊt
 = 
NULL
,

2148 .
	gh™dÀr
 = 
tfw_cfg›_ö_ˇche_fulfûl
,

2149 .
	gÆlow_n⁄e
 = 
åue
,

2150 .
	gÆlow_ª≥©
 = 
åue
,

2151 .
	gÆlow_ªc⁄fig
 = 
åue
,

2154 .
	g«me
 = "nonidempotent",

2155 .
	gdeÊt
 = 
NULL
,

2156 .
	gh™dÀr
 = 
tfw_cfg›_ö_n⁄idempŸít
,

2157 .
	gÆlow_n⁄e
 = 
åue
,

2158 .
	gÆlow_ª≥©
 = 
åue
,

2159 .
	gÆlow_ªc⁄fig
 = 
åue
,

2162 .
	g«me
 = "req_hdr_add",

2163 .
	gdeÊt
 = 
NULL
,

2164 .
	gh™dÀr
 = 
tfw_cfg›_ö_ªq_hdr_add
,

2165 .
	gÆlow_n⁄e
 = 
åue
,

2166 .
	gÆlow_ª≥©
 = 
åue
,

2167 .
	gÆlow_ªc⁄fig
 = 
åue
,

2170 .
	g«me
 = "req_hdr_set",

2171 .
	gdeÊt
 = 
NULL
,

2172 .
	gh™dÀr
 = 
tfw_cfg›_ö_ªq_hdr_£t
,

2173 .
	gÆlow_n⁄e
 = 
åue
,

2174 .
	gÆlow_ª≥©
 = 
åue
,

2175 .
	gÆlow_ªc⁄fig
 = 
åue
,

2178 .
	g«me
 = "resp_hdr_add",

2179 .
	gdeÊt
 = 
NULL
,

2180 .
	gh™dÀr
 = 
tfw_cfg›_ö_ª•_hdr_add
,

2181 .
	gÆlow_n⁄e
 = 
åue
,

2182 .
	gÆlow_ª≥©
 = 
åue
,

2183 .
	gÆlow_ªc⁄fig
 = 
åue
,

2186 .
	g«me
 = "resp_hdr_set",

2187 .
	gdeÊt
 = 
NULL
,

2188 .
	gh™dÀr
 = 
tfw_cfg›_ö_ª•_hdr_£t
,

2189 .
	gÆlow_n⁄e
 = 
åue
,

2190 .
	gÆlow_ª≥©
 = 
åue
,

2191 .
	gÆlow_ªc⁄fig
 = 
åue
,

2194 .
	g«me
 = "proxy_pass",

2195 .
	gdeÊt
 = 
NULL
,

2196 .
	gh™dÀr
 = 
tfw_cfg›_ö_¥oxy_∑ss
,

2197 .
	gÆlow_n⁄e
 = 
åue
,

2198 .
	gÆlow_ª≥©
 = 
Ál£
,

2199 .
	gÆlow_ªc⁄fig
 = 
åue
,

2202 .
	g«me
 = "location",

2203 .
	gdeÊt
 = 
NULL
,

2204 .
	gh™dÀr
 = 
tfw_cfg_h™dÀ_chûdªn
,

2205 .
	g˛ónup
 = 
tfw_cfg_˛ónup_chûdªn
,

2206 .
	gde°
 = 
tfw_vho°_loˇti⁄_•ecs
,

2207 .
	g•ec_ext
 = &(
TfwCfgS≥cChûd
) {

2208 .
begö_hook
 = 
tfw_cfg›_ö_loˇti⁄_begö
,

2209 .
	gföish_hook
 = 
tfw_cfg›_ö_loˇti⁄_föish


2211 .
	gÆlow_n⁄e
 = 
åue
,

2212 .
	gÆlow_ª≥©
 = 
åue
,

2213 .
	gÆlow_ªc⁄fig
 = 
åue
,

2218 
TfwCfgS≥c
 
	gtfw_vho°_‰™g_limôs_•ecs
[] = {

2220 .
«me
 = "ip_block",

2221 .
	gdeÊt
 = "off",

2222 .
	gh™dÀr
 = 
tfw_cfg_£t_boﬁ
,

2223 .
	gde°
 = &
‰™g_cfg
.
ù_block
,

2226 .
	g«me
 = "request_rate",

2227 .
	gdeÊt
 = "0",

2228 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2229 .
	gde°
 = &
‰™g_cfg
.
ªq_øã
,

2232 .
	g«me
 = "request_burst",

2233 .
	gdeÊt
 = "0",

2234 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2235 .
	gde°
 = &
‰™g_cfg
.
ªq_bur°
,

2238 .
	g«me
 = "connection_rate",

2239 .
	gdeÊt
 = "0",

2240 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2241 .
	gde°
 = &
‰™g_cfg
.
c⁄n_øã
,

2244 .
	g«me
 = "connection_burst",

2245 .
	gdeÊt
 = "0",

2246 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2247 .
	gde°
 = &
‰™g_cfg
.
c⁄n_bur°
,

2250 .
	g«me
 = "concurrent_connections",

2251 .
	gdeÊt
 = "0",

2252 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2253 .
	gde°
 = &
‰™g_cfg
.
c⁄n_max
,

2256 .
	g«me
 = "client_header_timeout",

2257 .
	gdeÊt
 = "0",

2258 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2259 .
	gde°
 = (*)&
‰™g_cfg
.
˛¡_hdr_timeout
,

2262 .
	g«me
 = "client_body_timeout",

2263 .
	gdeÊt
 = "0",

2264 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2265 .
	gde°
 = (*)&
‰™g_cfg
.
˛¡_body_timeout
,

2268 .
	g«me
 = "http_uri_len",

2269 .
	gdeÊt
 = "0",

2270 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2271 .
	gde°
 = &
‰™g_cfg
.
hâp_uri_Àn
,

2274 .
	g«me
 = "http_field_len",

2275 .
	gdeÊt
 = "0",

2276 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2277 .
	gde°
 = &
‰™g_cfg
.
hâp_fõld_Àn
,

2280 .
	g«me
 = "http_body_len",

2281 .
	gdeÊt
 = "0",

2282 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2283 .
	gde°
 = &
‰™g_cfg
.
hâp_body_Àn
,

2286 .
	g«me
 = "http_header_cnt",

2287 .
	gdeÊt
 = "0",

2288 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2289 .
	gde°
 = &
‰™g_cfg
.
hâp_hdr_˙t
,

2292 .
	g«me
 = "http_header_chunk_cnt",

2293 .
	gdeÊt
 = "0",

2294 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2295 .
	gde°
 = &
‰™g_cfg
.
hâp_hchunk_˙t
,

2298 .
	g«me
 = "http_body_chunk_cnt",

2299 .
	gdeÊt
 = "0",

2300 .
	gh™dÀr
 = 
tfw_cfg_£t_öt
,

2301 .
	gde°
 = &
‰™g_cfg
.
hâp_bchunk_˙t
,

2304 .
	g«me
 = "http_host_required",

2305 .
	gdeÊt
 = "true",

2306 .
	gh™dÀr
 = 
tfw_cfg_£t_boﬁ
,

2307 .
	gde°
 = &
‰™g_cfg
.
hâp_ho°_ªquúed
,

2310 .
	g«me
 = "http_ct_required",

2311 .
	gdeÊt
 = "false",

2312 .
	gh™dÀr
 = 
tfw_cfg_£t_boﬁ
,

2313 .
	gde°
 = &
‰™g_cfg
.
hâp_˘_ªquúed
,

2316 .
	g«me
 = "http_methods",

2317 .
	gdeÊt
 = "",

2318 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_out_hâp_mëhods
,

2321 .
	g«me
 = "http_ct_vals",

2322 .
	gdeÊt
 = 
NULL
,

2323 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_out_hâp_˘_vÆs
,

2324 .
	gÆlow_n⁄e
 = 
åue
,

2327 .
	g«me
 = "http_resp_code_block",

2328 .
	gdeÊt
 = 
NULL
,

2329 .
	gh™dÀr
 = 
tfw_cfg›_‰™g_out_r•_code_block
,

2330 .
	gÆlow_n⁄e
 = 
åue
,

2335 
TfwCfgS≥c
 
	gtfw_vho°_•ecs
[] = {

2337 .
«me
 = "hdr_via",

2338 .
	gdeÊt
 = 
NULL
,

2339 .
	gh™dÀr
 = 
tfw_cfg›_hdr_vü
,

2340 .
	gÆlow_n⁄e
 = 
åue
,

2341 .
	gÆlow_ª≥©
 = 
Ál£
,

2342 .
	gÆlow_ªc⁄fig
 = 
Ál£
,

2345 .
	g«me
 = "cache_purge",

2346 .
	gdeÊt
 = 
NULL
,

2347 .
	gh™dÀr
 = 
tfw_cfg›_ˇche_purge
,

2348 .
	gÆlow_n⁄e
 = 
åue
,

2349 .
	gÆlow_ª≥©
 = 
Ál£
,

2350 .
	gÆlow_ªc⁄fig
 = 
Ál£
,

2353 .
	g«me
 = "cache_purge_acl",

2354 .
	gdeÊt
 = 
NULL
,

2355 .
	gh™dÀr
 = 
tfw_cfg›_ˇche_purge_a˛
,

2356 .
	gÆlow_n⁄e
 = 
åue
,

2357 .
	gÆlow_ª≥©
 = 
Ál£
,

2358 .
	gÆlow_ªc⁄fig
 = 
Ál£
,

2361 .
	g«me
 = "cache_bypass",

2362 .
	gdeÊt
 = 
NULL
,

2363 .
	gh™dÀr
 = 
tfw_cfg›_out_ˇche_by∑ss
,

2364 .
	gÆlow_n⁄e
 = 
åue
,

2365 .
	gÆlow_ª≥©
 = 
åue
,

2366 .
	gÆlow_ªc⁄fig
 = 
åue
,

2369 .
	g«me
 = "cache_fulfill",

2370 .
	gdeÊt
 = 
NULL
,

2371 .
	gh™dÀr
 = 
tfw_cfg›_out_ˇche_fulfûl
,

2372 .
	gÆlow_n⁄e
 = 
åue
,

2373 .
	gÆlow_ª≥©
 = 
åue
,

2374 .
	gÆlow_ªc⁄fig
 = 
åue
,

2377 .
	g«me
 = "nonidempotent",

2378 .
	gdeÊt
 = 
NULL
,

2379 .
	gh™dÀr
 = 
tfw_cfg›_out_n⁄idempŸít
,

2380 .
	gÆlow_n⁄e
 = 
åue
,

2381 .
	gÆlow_ª≥©
 = 
åue
,

2382 .
	gÆlow_ªc⁄fig
 = 
åue
,

2385 .
	g«me
 = "req_hdr_add",

2386 .
	gdeÊt
 = 
NULL
,

2387 .
	gh™dÀr
 = 
tfw_cfg›_out_ªq_hdr_add
,

2388 .
	gÆlow_n⁄e
 = 
åue
,

2389 .
	gÆlow_ª≥©
 = 
åue
,

2390 .
	gÆlow_ªc⁄fig
 = 
åue
,

2393 .
	g«me
 = "req_hdr_set",

2394 .
	gdeÊt
 = 
NULL
,

2395 .
	gh™dÀr
 = 
tfw_cfg›_out_ªq_hdr_£t
,

2396 .
	gÆlow_n⁄e
 = 
åue
,

2397 .
	gÆlow_ª≥©
 = 
åue
,

2398 .
	gÆlow_ªc⁄fig
 = 
åue
,

2401 .
	g«me
 = "resp_hdr_add",

2402 .
	gdeÊt
 = 
NULL
,

2403 .
	gh™dÀr
 = 
tfw_cfg›_out_ª•_hdr_add
,

2404 .
	gÆlow_n⁄e
 = 
åue
,

2405 .
	gÆlow_ª≥©
 = 
åue
,

2406 .
	gÆlow_ªc⁄fig
 = 
åue
,

2409 .
	g«me
 = "resp_hdr_set",

2410 .
	gdeÊt
 = 
NULL
,

2411 .
	gh™dÀr
 = 
tfw_cfg›_out_ª•_hdr_£t
,

2412 .
	gÆlow_n⁄e
 = 
åue
,

2413 .
	gÆlow_ª≥©
 = 
åue
,

2414 .
	gÆlow_ªc⁄fig
 = 
åue
,

2417 .
	g«me
 = "location",

2418 .
	gdeÊt
 = 
NULL
,

2419 .
	gh™dÀr
 = 
tfw_cfg_h™dÀ_chûdªn
,

2420 .
	g˛ónup
 = 
tfw_cfg_˛ónup_chûdªn
,

2421 .
	gde°
 = 
tfw_vho°_loˇti⁄_•ecs
,

2422 .
	g•ec_ext
 = &(
TfwCfgS≥cChûd
) {

2423 .
begö_hook
 = 
tfw_cfg›_out_loˇti⁄_begö
,

2424 .
	gföish_hook
 = 
tfw_cfg›_out_loˇti⁄_föish


2426 .
	gÆlow_n⁄e
 = 
åue
,

2427 .
	gÆlow_ª≥©
 = 
åue
,

2428 .
	gÆlow_ªc⁄fig
 = 
åue
,

2431 .
	g«me
 = "vhost",

2432 .
	gdeÊt
 = 
NULL
,

2433 .
	gh™dÀr
 = 
tfw_cfg_h™dÀ_chûdªn
,

2434 .
	g˛ónup
 = 
tfw_cfg›_vho°s_˛ónup
,

2435 .
	gde°
 = 
tfw_vho°_öã∫Æ_•ecs
,

2436 .
	g•ec_ext
 = &(
TfwCfgS≥cChûd
) {

2437 .
begö_hook
 = 
tfw_cfg›_vho°_begö
,

2438 .
	gföish_hook
 = 
tfw_cfg›_vho°_föish


2440 .
	gÆlow_n⁄e
 = 
åue
,

2441 .
	gÆlow_ª≥©
 = 
åue
,

2442 .
	gÆlow_ªc⁄fig
 = 
åue
,

2445 .
	g«me
 = "frang_limits",

2446 .
	gh™dÀr
 = 
tfw_cfg_h™dÀ_chûdªn
,

2447 .
	g˛ónup
 = 
tfw_cfg_˛ónup_chûdªn
,

2448 .
	gde°
 = 
tfw_vho°_‰™g_limôs_•ecs
,

2449 .
	gÆlow_n⁄e
 = 
åue
,

2450 .
	gÆlow_ª≥©
 = 
Ál£
,

2451 .
	gÆlow_ªc⁄fig
 = 
Ál£
,

2456 
TfwMod
 
	gtfw_vho°_mod
 = {

2457 .
«me
 = "vhost",

2458 .
	gcfg°¨t
 = 
tfw_vho°_cfg°¨t
,

2459 .
	gcfgíd
 = 
tfw_vho°_cfgíd
,

2460 .
	g°¨t
 = 
tfw_vho°_°¨t
,

2461 .
	g•ecs
 = 
tfw_vho°_•ecs
,

2462 .
	gcfg˛ón
 = 
tfw_vho°_cfg˛ón
,

2466 
	$tfw_vho°_öô
()

2468 
	`tfw_mod_ªgi°î
(&
tfw_vho°_mod
);

2470 
	}
}

2473 
	$tfw_vho°_exô
()

2475 
	`tfw_mod_uƒegi°î
(&
tfw_vho°_mod
);

2476 
	}
}

	@vhost.h

20 #i‚de‡
__TFW_VHOST_H__


21 
	#__TFW_VHOST_H__


	)

23 
	~"°r.h
"

24 
	~"addr.h
"

25 
	~"msg.h
"

26 
	~"£rvî.h
"

37 
	mmëhod
;

38 
	m›
;

39 
size_t
 
	mÀn
;

40 c⁄° *
	m¨g
;

41 } 
	tTfwNùDef
;

45 
	mTFW_D_CACHE_BYPASS
,

46 
	mTFW_D_CACHE_FULFILL
,

47 } 
	ttfw_ˇpo_t
;

58 
	mcmd
;

59 
	m›
;

60 
size_t
 
	mÀn
;

61 c⁄° *
	m¨g
;

62 } 
	tTfwCaPﬁicy
;

71 
TfwSå
 *
	mhdr
;

72 
	mhid
;

73 
boﬁ
 
	m≠≥nd
;

74 } 
	tTfwHdrModsDesc
;

83 
size_t
 
	msz
;

84 
TfwHdrModsDesc
 *
	mhdrs
;

85 } 
	tTfwHdrMods
;

88 
	mTFW_VHOST_HDRMOD_REQ
,

89 
	mTFW_VHOST_HDRMOD_RESP
,

91 
	mTFW_VHOST_HDRMOD_NUM


111 
	m›
;

112 c⁄° *
	m¨g
;

113 
size_t
 
	mÀn
;

114 
size_t
 
	mˇpo_sz
;

115 
size_t
 
	mnùdef_sz
;

116 
TfwCaPﬁicy
 **
	mˇpo
;

117 
TfwNùDef
 **
	mnùdef
;

118 
‰™g_cfg_t
 *
	m‰™g_cfg
;

119 
TfwSrvGroup
 *
	mmaö_sg
;

120 
TfwSrvGroup
 *
	mbackup_sg
;

121 
TfwPoﬁ
 *
	mhdrs_poﬁ
;

122 
TfwHdrMods
 
	mmod_hdrs
[
TFW_VHOST_HDRMOD_NUM
];

123 } 
	tTfwLoˇti⁄
;

127 
	mTFW_D_CACHE_PURGE_INVALIDATE
,

130 
tfw_vho°_t
 
	tTfwVho°
;

144 
	stfw_vho°_t
 {

145 
li°_hód
 
	mli°
;

146 c⁄° *
	m«me
;

147 
TfwLoˇti⁄
 *
	mloc
;

148 
TfwLoˇti⁄
 *
	mloc_dÊt
;

149 
TfwVho°
 *
	mvho°_dÊt
;

150 
TfwPoﬁ
 *
	mhdrs_poﬁ
;

151 
©omic64_t
 
	mªf˙t
;

152 
size_t
 
	mloc_sz
;

155 
	#TFW_VH_DFT_NAME
 "deÁu…"

	)

169 c⁄° *
	mhdr_vü
;

170 
TfwAddr
 *
	mˇpua˛
;

171 
size_t
 
	mhdr_vü_Àn
;

172 
size_t
 
	mˇpua˛_sz
;

173 
u8
 
	mˇche_purge
:1;

174 
u8
 
	mˇche_purge_mode
:2;

175 
u8
 
	mˇche_purge_a˛
:1;

176 } 
	tTfwGlobÆ
;

178 
tfw_vho°_de°roy
(
TfwVho°
 *
vho°
);

180 
ölöe
 

181 
	$tfw_vho°_gë
(
TfwVho°
 *
vho°
)

183 
	`©omic64_öc
(&
vho°
->
ªf˙t
);

184 
	}
}

186 
ölöe
 

187 
	$tfw_vho°_put
(
TfwVho°
 *
vho°
)

189 i‡(
	`u∆ikñy
(!
vho°
))

191 i‡(
	`likñy
(
	`©omic64_dec_ªtu∫
(&
vho°
->
ªf˙t
)))

193 
	`tfw_vho°_de°roy
(
vho°
);

194 
	}
}

196 
TfwNùDef
 *
tfw_nùdef_m©ch
(
TfwLoˇti⁄
 *
loc
, 
mëh
, 
TfwSå
 *
¨g
);

197 
boﬁ
 
tfw_ˇpua˛_m©ch
(
TfwAddr
 *
addr
);

198 
TfwCaPﬁicy
 *
tfw_ˇpﬁicy_m©ch
(
TfwLoˇti⁄
 *
loc
, 
TfwSå
 *
¨g
);

199 
TfwLoˇti⁄
 *
tfw_loˇti⁄_m©ch
(
TfwVho°
 *
vho°
, 
TfwSå
 *
¨g
);

200 
TfwVho°
 *
tfw_vho°_lookup
(c⁄° *
«me
);

201 
TfwSrvC⁄n
 *
tfw_vho°_gë_§v_c⁄n
(
TfwMsg
 *
msg
);

202 
TfwVho°
 *
tfw_vho°_√w
(c⁄° *
«me
);

203 
TfwGlobÆ
 *
tfw_vho°_gë_globÆ
();

204 
TfwHdrMods
 *
tfw_vho°_gë_hdr_mods
(
TfwLoˇti⁄
 *
loc
, 
TfwVho°
 *
vho°
,

205 
mod_ty≥
);

206 
‰™g_cfg_t
 *
tfw_vho°_globÆ_‰™g_cfg
();

	@work_queue.c

24 
	~<löux/≥r˝u.h
>

25 
	~<löux/¶ab.h
>

27 
	~"w‹k_queue.h
"

33 
	#QSZ
 2048

	)

34 
	#QMASK
 (
QSZ
 - 1)

	)

37 
	$tfw_wq_öô
(
TfwRBQueue
 *
q
, 
node
)

39 
˝u
;

41 
q
->
hóds
 = 
	`Æloc_≥r˝u
(
©omic64_t
);

42 i‡(!
q
->
hóds
)

43  -
ENOMEM
;

45 
	`f‹_óch_possibÀ_˝u
(
˝u
) {

46 
©omic64_t
 *
loˇl_hód
 = 
	`≥r_˝u_±r
(
q
->
hóds
, 
˝u
);

47 
	`©omic64_£t
(
loˇl_hód
, 
LLONG_MAX
);

49 
q
->
œ°_hód
 = 0;

50 
	`©omic64_£t
(&
q
->
hód
, 0);

51 
	`©omic64_£t
(&
q
->
èû
, 0);

53 
q
->
¨øy
 = 
	`kmÆloc_node
(
QSZ
 * 
WQ_ITEM_SZ
, 
GFP_KERNEL
, 
node
);

54 i‡(!
q
->
¨øy
) {

55 
	`‰ì_≥r˝u
(
q
->
hóds
);

56  -
ENOMEM
;

60 
	}
}

63 
	$tfw_wq_de°roy
(
TfwRBQueue
 *
q
)

66 
	`WARN_ON_ONCE
(
	`tfw_wq_size
(
q
));

68 
	`k‰ì
(
q
->
¨øy
);

69 
	`‰ì_≥r˝u
(
q
->
hóds
);

70 
	}
}

78 
	$__tfw_wq_push
(
TfwRBQueue
 *
q
, *
±r
)

80 
hód
, 
èû
;

81 
©omic64_t
 *
hód_loˇl
;

88 
	`loˇl_bh_dißbÀ
();

90 
hód_loˇl
 = 
	`this_˝u_±r
(
q
->
hóds
);

97 
hód
 = 
	`©omic64_ªad
(&
q
->head);

98 
	`©omic64_£t
(
hód_loˇl
, 
hód
);

100  ; ; 
hód
 = 
	`©omic64_ªad
(&
q
->head)) {

101 
èû
 = 
	`©omic64_ªad
(&
q
->tail);

102 
	`WARN_ON_ONCE
(
hód
 > 
èû
 + 
QSZ
);

103 i‡(
	`u∆ikñy
(
hód
 =
èû
 + 
QSZ
))

104 
fuŒ_out
;

112 i‡(
	`©omic64_cmpxchg
(&
q
->
hód
, head, head + 1) == head)

114 
	`˝u_ªœx
();

117 
	`mem˝y
(&
q
->
¨øy
[
hód
 & 
QMASK
], 
±r
, 
WQ_ITEM_SZ
);

118 
	`wmb
();

120 
hód
 = 0;

121 
fuŒ_out
:

123 
	`©omic64_£t
(
hód_loˇl
, 
LONG_MAX
);

124 
	`loˇl_bh_íabÀ
();

125  
hód
;

126 
	}
}

134 
	$tfw_wq_p›_tickë
(
TfwRBQueue
 *
q
, *
buf
, *
tickë
)

136 
˝u
, 
r
 = -
EBUSY
;

137 
èû
;

139 
	`loˇl_bh_dißbÀ
();

141 
èû
 = 
	`©omic64_ªad
(&
q
->tail);

147 i‡(
	`u∆ikñy
(
èû
 >
q
->
œ°_hód
)) {

154 
q
->
œ°_hód
 = 
	`©omic64_ªad
(&q->
hód
);

155 
	`f‹_óch_⁄löe_˝u
(
˝u
) {

156 
©omic64_t
 *
hód_loˇl
 = 
	`≥r_˝u_±r
(
q
->
hóds
, 
˝u
);

157 
cuº_h
 = 
	`©omic64_ªad
(
hód_loˇl
);

160 
	`b¨rõr
();

161 i‡(
cuº_h
 < 
q
->
œ°_hód
)

162 
q
->
œ°_hód
 = 
cuº_h
;

166 i‡(
èû
 >
q
->
œ°_hód
)

167 
out
;

170 
	`mem˝y
(
buf
, &
q
->
¨øy
[
èû
 & 
QMASK
], 
WQ_ITEM_SZ
);

171 
	`mb
();

177 
	`©omic64_£t
(&
q
->
èû
,Åail + 1);

178 
r
 = 0;

179 
out
:

180 
	`loˇl_bh_íabÀ
();

181 i‡(
tickë
)

182 *
tickë
 = 
èû
;

183  
r
;

184 
	}
}

	@work_queue.h

20 #i‚de‡
__TFW_WORK_QUEUE_H__


21 
	#__TFW_WORK_QUEUE_H__


	)

23 
	~<löux/öãºu±.h
>

24 
	~<löux/úq_w‹k.h
>

26 
	~"log.h
"

29 
	m_
[4];

30 } 
	t__WqIãm
;

32 
	#WQ_ITEM_SZ
 (
__WqIãm
)

	)

33 
	#TFW_WQ_CHECKSZ
(
t
Ë
	`BUILD_BUG_ON
(—Ë!
WQ_ITEM_SZ
)

	)

36 
©omic64_t
 
__≥r˝u
 *
	mhóds
;

37 
__WqIãm
 *
	m¨øy
;

38 
	mœ°_hód
;

39 
©omic64_t
 
hód
 
	m____ˇchñöe_Æig√d
;

40 
©omic64_t
 
èû
 
	m____ˇchñöe_Æig√d
;

41 } 
	tTfwRBQueue
;

43 
tfw_wq_öô
(
TfwRBQueue
 *
wq
, 
node
);

44 
tfw_wq_de°roy
(
TfwRBQueue
 *
wq
);

45 
__tfw_wq_push
(
TfwRBQueue
 *
wq
, *
±r
);

46 
tfw_wq_p›_tickë
(
TfwRBQueue
 *
wq
, *
buf
, *
tickë
);

48 
ölöe
 

49 
tfw_øi£_so·úq
(
˝u
, 
úq_w‹k
 *
w‹k
,

50 (*
loˇl_˝u_cb
)(
úq_w‹k
 *))

52 i‡(
	`smp_¥o˚ss‹_id
(Ë!
˝u
)

53 
	`úq_w‹k_queue_⁄
(
w‹k
, 
˝u
);

55 
	`loˇl_˝u_cb
(
w‹k
);

56 
	}
}

58 
ölöe
 

59 
tfw_wq_push
(
TfwRBQueue
 *
q
, *
±r
, 
˝u
, 
úq_w‹k
 *
w‹k
,

60 (*
loˇl_˝u_cb
)(
úq_w‹k
 *))

62 
tickë
 = 
	`__tfw_wq_push
(
q
, 
±r
);

63 i‡(
	`u∆ikñy
(
tickë
))

64  
tickë
;

66 
	`tfw_øi£_so·úq
(
˝u
, 
w‹k
, 
loˇl_˝u_cb
);

69 
	}
}

71 
ölöe
 

72 
	$tfw_wq_p›
(
TfwRBQueue
 *
wq
, *
buf
)

74  
	`tfw_wq_p›_tickë
(
wq
, 
buf
, 
NULL
);

75 
	}
}

77 
ölöe
 

78 
	$tfw_wq_size
(
TfwRBQueue
 *
q
)

80 
t
 = 
	`©omic64_ªad
(&
q
->
èû
);

81 
h
 = 
	`©omic64_ªad
(&
q
->
hód
);

83  
t
 > 
h
 ? 0 : h -Å;

84 
	}
}

	@
1
.
0
100
1403
addr.c
addr.h
apm.c
apm.h
cache.c
cache.h
cfg.c
cfg.h
client.c
client.h
connection.c
connection.h
filter.c
filter.h
gfsm.c
gfsm.h
hash.c
http.c
http.h
http_limits.c
http_limits.h
http_match.c
http_match.h
http_msg.c
http_msg.h
http_norm.h
http_parser.c
http_sched_hash.c
http_sched_ratio.c
http_sess.c
http_sess.h
http_tbl.c
http_tbl.h
htype.h
log.h
main.c
msg.c
msg.h
peer.h
pool.c
pool.h
procfs.c
procfs.h
sched.c
server.c
server.h
sock.c
sock_clnt.c
sock_srv.c
ss_skb.c
ss_skb.h
str.c
str.h
str_simd.c
stress.c
stress.h
sync_socket.h
t/bomber.c
t/fuzzer.c
t/fuzzer.h
t/sync_sockets/client.cc
t/sync_sockets/kernel/kserver.c
t/sync_sockets/kernel/sync_kclient.c
t/sync_sockets/kernel/sync_kserver.c
t/sync_sockets/server.cc
t/unit/helpers.c
t/unit/helpers.h
t/unit/kallsyms_helper.c
t/unit/kallsyms_helper.h
t/unit/main.c
t/unit/sched_helper.c
t/unit/sched_helper.h
t/unit/test.c
t/unit/test.h
t/unit/test_addr.c
t/unit/test_cfg.c
t/unit/test_hash.c
t/unit/test_http_match.c
t/unit/test_http_msg.c
t/unit/test_http_parser.c
t/unit/test_http_sticky.c
t/unit/test_http_tbl.c
t/unit/test_mem_fast.c
t/unit/test_sched_hash.c
t/unit/test_sched_ratio.c
t/unit/test_tfw_str.c
t/unit/test_tls.c
t/unit/test_wq.c
t/unit/tfw_str_helper.c
t/unit/tfw_str_helper.h
t/unit/user_space/alb.c
t/unit/user_space/percentiles.c
t/unit/user_space/slr.cc
tempesta_fw.h
tls.c
tls.h
vhost.c
vhost.h
work_queue.c
work_queue.h
